---
title: Свойства пула потоков служб Analysis Services | Документация Майкрософт
ms.date: 06/07/2018
ms.prod: sql
ms.technology: analysis-services
ms.custom: ''
ms.topic: conceptual
ms.author: owend
ms.reviewer: owend
author: minewiskan
manager: kfile
ms.openlocfilehash: d46ff8318543d4e2a4b4dc547c9f19640d463f49
ms.sourcegitcommit: 3026c22b7fba19059a769ea5f367c4f51efaf286
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/15/2019
ms.locfileid: "68207915"
---
# <a name="thread-pool-properties"></a>Свойства пула потоков
[!INCLUDE[ssas-appliesto-sqlas-all-aas](../../includes/ssas-appliesto-sqlas-all-aas.md)]

  [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] использует многопоточность во многих операциях, повышая общую производительность сервера за счет параллельного выполнения нескольких заданий. Чтобы эффективнее управлять потоками, [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] использует пулы потоков для предварительного выделения ресурсов и обеспечения доступности потоков для последующих заданий.  
  
 Каждый экземпляр [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] поддерживает собственный набор пулов потоков. Есть различия в том, как табличные и многомерные экземпляры используют пулы потоков. Например, пул потоков **IOProcess** используют только многомерные экземпляры. Таким образом **PerNumaNode** свойства, описанные в этой статье, не имеет смысла для табличных экземпляров. В подразделе [Справочник по свойствам](#bkmk_propref) ниже требования к режиму вызываются для каждого свойства.
  
> [!NOTE]  
>  Табличное развертывание в системах NUMA в данном разделе не освещается. Табличные решения можно успешно развертывать в системах NUMA, но производительность хранимых в памяти баз данных, используемых в табличных моделях, может быть ограничена на сильно масштабируемых архитектурах. Дополнительные сведения см. в разделе [внедрения служб Analysis Services: Использование табличных моделей в крупномасштабных коммерческих решениях](http://msdn.microsoft.com/library/dn751533.aspx) и [подбор оборудования для табличного решения](http://go.microsoft.com/fwlink/?LinkId=330359).  
  
##  <a name="bkmk_threadarch"></a> Управление потоками в службах Analysis Services  
 [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] применяет многопоточность, используя преимущества доступных ресурсов процессора путем увеличения количества параллельно выполняемых задач. Подсистема хранилища является многопоточной. Примеры многопоточных заданий, выполняемых в подсистеме хранилища: параллельная обработка объектов или обработка отдельных запросов, которые передаются в подсистему хранилища, а также возврат запрошенных данных. Модуль формул из-за особенностей последовательных вычислений выполняется в одном потоке. Каждый запрос в основном выполняется в одном потоке, который запрашивает и ожидает данные от подсистемы хранилища. Потоки выполнения запроса выполняются дольше и завершаются только после выполнения всего запроса.  
  
 По умолчанию в версиях [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] и более поздних [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] будет использовать все доступные логические процессоры, до 640 в тех системах, которые выполняются на выпусках Windows и SQL Server с более широкими возможностями. При запуске процесс msmdsrv.exe будет назначен определенной группе процессоров, но со временем потоки могут быть назначены на любой логический процессор, в любой группе.  
  
 Одним из побочных эффектов использования большого количества процессоров является то, что иногда может возникать снижение производительности из-за распределения нагрузок от запросов и обработки по большому количеству процессоров и увеличения состязания за общие структуры данных. Это, в частности, может произойти не только в высокопроизводительных системах, использующих архитектуру NUMA, но и в системах, отличных от NUMA, в которых выполняется много приложений, обрабатывающих большой объем данных, на том же оборудовании.  
  
 Чтобы устранить эту проблему, можно установить соответствие между типами операций [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] и определенным набором логических процессоров. Свойство **GroupAffinity** позволяет создавать пользовательские маски сходства, указывающие системный ресурс для каждого из типов пулов потоков, управление которыми осуществляют службы [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)].
 
Для установки **GroupAffinity** табличных экземпляров рекомендуется использовать SQL Server 2016 с накопительным обновлением 1 (CU1) или более поздней версии. 
  
 Свойство**GroupAffinity** может быть задано для любого пула потоков, используемых для рабочих нагрузок [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] .  
  
-   **ThreadPool \ Parsing \ Short**  — это пул анализа для коротких запросов. Запросы, которые умещаются в одном сетевом сообщении, считаются короткими. 
  
-   **ThreadPool \ Parsing \ Long**  — это пул анализа для остальных запросов, которые не помещаются в одно сетевое сообщение. 
  
    > [!NOTE]  
    >  Поток из любого пула синтаксического анализа можно использовать для выполнения запроса. Запросы, которые могут быть выполнены быстро, такие как запросы Discover или Cancel, иногда выполняются сразу же, а не ставятся в очередь запросов пула потоков. 
  
-   **ThreadPool \ Query** — это пул потоков, который выполняет все запросы, не обрабатываемые пулом потоков синтаксического анализа. Потоки в этом пуле выполняют операции всех типов, например команды поиска, MDX, DAX, DMX и DDL. Объект
  
-   **ThreadPool \ IOProcess** используется для заданий ввода-вывода, связанных с запросами в многомерном модуле подсистемы хранилища. Ожидается, что задания, выполняемые этими потоками, не имеют зависимостей от других потоков. Эти потоки обычно просматривают один сегмент секции и выполняют фильтрацию и статистическую обработку данных сегмента. Потоки**IOProcess** особенно чувствительны к параметрам конфигурации оборудования NUMA. Этот пул потоков имеет свойство конфигурации **PerNumaNode** , которое при необходимости может использоваться для настройки производительности. 
  
-   **ThreadPool \ Process** предназначен для более продолжительных заданий подсистемы хранилища, включая операции агрегирования, индексирования и фиксации. Режим хранилища ROLAP также использует потоки из пула потоков Processing.  

- **VertiPaq \ ThreadPool** — это пул потоков для сканирования таблиц в табличной модели.
  
 Для выполнения обработки запросов [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] может превысить предел пула потоков, запросив дополнительные потоки, если они необходимы для работы. Однако если поток завершает выполнение своей задачи, притом что текущее количество потоков превышает максимальный предел, то поток просто завершается, а не возвращается в пул потоков.  
  
> [!NOTE]  
>  Превышение максимального числа потоков пула является защитным механизмом, который вызывается только в случае возникновения определенных состояний взаимоблокировки. Для предотвращения выхода количества создаваемых потоков за максимально допустимое значение по достижении максимального предела потоки создаются не сразу, а после короткой задержки. Превышение максимального числа потоков может привести к замедлению выполнения задач. Если счетчики производительности указывают на то, что число потоков регулярно превышает максимальный размер пула потоков, это можно считать признаком того, что размер пула потоков слишком мал для той степени параллелизма, которая требуется системе.  
  
 По умолчанию размер пула потоков определяется [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)]и основывается на числе ядер. Используемые значения по умолчанию можно посмотреть в файле msmdsrv.log после запуска сервера. В ходе настройки производительности можно увеличить размер пула потоков, а также другие свойства, чтобы повысить производительность запросов и обработки.  
  
##  <a name="bkmk_propref"></a> Справочник по свойствам пулов потоков  
 В этом разделе описываются свойства пула потоков из файла msmdsrv.ini каждого экземпляра [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] . Подмножество этих свойств также доступно в SQL Server Management Studio.  
  
 Свойства перечисляются в алфавитном порядке.  
  
|Имя|Тип|Описание|Значение по умолчанию|Руководство|  
|----------|----------|-----------------|-------------|--------------|  
|**IOProcess** \ **Concurrency**|double|Значение с плавающей запятой двойной точности, определяющее алгоритм для установки целевого количества потоков, которые могут быть одновременно поставлены в очередь.|2.0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .<br /><br /> Параллелизм используется для инициализации пулов потоков, которые в Windows реализуются с помощью портов завершения операций ввода-вывода. Дополнительные сведения см. в разделе [Порты завершения ввода-вывода](http://msdn.microsoft.com/library/windows/desktop/aa365198\(v=vs.85\).aspx) .<br /><br /> Применяется только к многомерным моделям.|  
|**IOProcess** \ **GroupAffinity**|строка|Массив шестнадцатеричных значений, который соответствует группам процессоров в системе, используемой для задания сходства потоков в пуле потоков IOProcess логическим процессорам в каждой группе процессоров.|none|С помощью этого свойства можно создавать пользовательские сходства. По умолчанию это свойство пусто.<br /><br /> См. подробности в разделе [Задание параметра GroupAffinity для привязки потоков к процессорам или группе процессоров](#bkmk_groupaffinity) .<br /><br /> Применяется только к многомерным моделям.|  
|**IOProcess** \ **MaxThreads**|ssNoversion|32-разрядное целое число со знаком, определяющее максимальное количество потоков для включения в пул потоков.|0|0 указывает, что сервер сам определяет значения по умолчанию. По умолчанию сервер устанавливает это значение как 64 или как умноженное на 10 число логических процессоров в зависимости от того, какое из чисел выше. Например, в системе с 4 ядрами с технологией Hyper-Threading максимум пула потоков будет равен 80.<br /><br /> Если значение задано как отрицательное, сервер умножит это число на количество логических процессоров. Например, если значение равно -10, на сервере с 32 логическими процессорами максимум будет составлять 320 потоков.<br /><br /> Максимальное значение зависит от числа процессоров, доступных для пользовательских масок сходства, определенных вами ранее. Например, если уже была задана схожесть пула потоков на использование 8 из 32 процессоров, при задании свойству MaxThreads значения -10 верхняя граница пула потоков будет равна 10*8, то есть 80 потокам.<br /><br /> Фактические значения для этого свойства пула потоков заносятся в файл журнала msmdsrv после запуска службы.<br /><br /> Дополнительные сведения о настройке параметров пула потоков можно найти в [руководстве по операциям служб Analysis Services](http://msdn.microsoft.com/library/hh226085.aspx).<br /><br /> Применяется только к многомерным моделям.|  
|**IOProcess** \ **MinThreads**|ssNoversion|32-разрядное целое число со знаком, определяющее минимальное количество потоков, предварительно выделяемых для пула потоков.|0|0 указывает, что сервер сам определяет значения по умолчанию. Минимальное значение по умолчанию равно 1.<br /><br /> Если значение задано как отрицательное, сервер умножит это число на количество логических процессоров.<br /><br /> Фактические значения для этого свойства пула потоков заносятся в файл журнала msmdsrv после запуска службы.<br /><br /> Дополнительные сведения о настройке параметров пула потоков можно найти в [руководстве по операциям служб Analysis Services](http://msdn.microsoft.com/library/hh226085.aspx).<br /><br /> Применяется только к многомерным моделям.|  
|**IOProcess** \ **PerNumaNode**|ssNoversion|32-разрядное целое число со знаком, определяющее количество пулов потоков, создаваемых для процесса msmdsrv.|-1|Допустимые значения: -1, 0, 1, 2.<br /><br /> -1 = сервер выбирает другую стратегию пула потоков ввода-вывода на основе числа узлов NUMA. В системах, где число узлов NUMA меньше 4, поведение сервера такое же, как и для значения 0 (для системы создается один пул потоков IOProcess). В системах, где количество узлов составляет четыре или больше, поведение такое же, как и для значения 1 (для каждого узла создаются пулы потоков IOProcess).<br /><br /> 0 = отключает пулы потоков для каждого узла NUMA, так что присутствует только один пул потоков IOProcess, используемый msmdsrv.exe.<br /><br /> 1 = включает один пул потоков IOProcess на каждый узел NUMA.<br /><br /> 2 = один пул потоков IOProcess на каждый логический процессор. Потоки в каждом пуле привязываются к узлу NUMA логического процессора, при этом идеальный процессор указывает на логический процессор.<br /><br /> См. подробности в разделе [Задайте параметр PerNumaNode, чтобы привязать потоки ввода-вывода к процессорам в узле NUMA.](#bkmk_pernumanode) .<br /><br /> Применяется только к многомерным моделям.|  
|**IOProcess** \ **PriorityRatio**|ssNoversion|32-разрядное целое число со знаком, которое используется в том случае, если требуется, чтобы иногда выполнялись потоки с более низким приоритетом, даже если очередь с более высоким приоритетом не пуста.|2|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .<br /><br /> Применяется только к многомерным моделям.|  
|**IOProcess** \ **StackSizeKB**|ssNoversion|32-разрядное целое число со знаком, которое можно использовать для настройки выделения памяти во время выполнения потоков.|0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .<br /><br /> Применяется только к многомерным моделям.|  
|**Parsing**  \ **Long** \ **Concurrency**|double|Значение с плавающей запятой двойной точности, определяющее алгоритм для установки целевого количества потоков, которые могут быть одновременно поставлены в очередь.|2.0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .<br /><br /> Параллелизм используется для инициализации пулов потоков, которые в Windows реализуются с помощью портов завершения операций ввода-вывода. Дополнительные сведения см. в разделе [Порты завершения ввода-вывода](http://msdn.microsoft.com/library/windows/desktop/aa365198\(v=vs.85\).aspx) .|  
|**Parsing**  \ **Long** \ **GroupAffinity**|строка|Массив шестнадцатеричных значений, который соответствует группам процессоров в системе, используемой для задания сходства потоков анализа логическим процессорам в каждой группе процессоров.|none|С помощью этого свойства можно создавать пользовательские сходства. По умолчанию это свойство пусто.<br /><br /> См. подробности в разделе [Задание параметра GroupAffinity для привязки потоков к процессорам или группе процессоров](#bkmk_groupaffinity) .|  
|**Parsing**  \ **Long** \ **NumThreads**|ssNoversion|Свойство с 32-разрядным целочисленным значением со знаком, определяющее количество потоков, которое можно создать для длинных команд.|0|0 указывает, что сервер сам определяет значения по умолчанию. По умолчанию параметру **NumThreads** задается абсолютное значение 4 или умноженное на 2 число логических процессоров в зависимости от того, какое значение выше.<br /><br /> Если значение задано как отрицательное, сервер умножит это число на количество логических процессоров. Например, если значение равно -10, на сервере с 32 логическими процессорами максимум будет составлять 320 потоков.<br /><br /> Максимальное значение зависит от числа процессоров, доступных для пользовательских масок сходства, определенных вами ранее. Например, если уже была задана схожесть пула потоков на использование 8 из 32 процессоров, при задании свойству NumThreads значения -10 верхняя граница пула потоков будет равна 10*8, то есть 80 потокам.<br /><br /> Фактические значения для этого свойства пула потоков заносятся в файл журнала msmdsrv после запуска службы.|  
|**Parsing**  \ **Long** \ **PriorityRatio**|ssNoversion|32-разрядное целое число со знаком, которое используется в том случае, если требуется, чтобы иногда выполнялись потоки с более низким приоритетом, даже если очередь с более высоким приоритетом не пуста.|0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .|  
|**Parsing**  \ **Long** \ **StackSizeKB**|ssNoversion|32-разрядное целое число со знаком, которое можно использовать для настройки выделения памяти во время выполнения потоков.|0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .|  
|**Parsing**  \ **Short** \ **Concurrency**|double|Значение с плавающей запятой двойной точности, определяющее алгоритм для установки целевого количества потоков, которые могут быть одновременно поставлены в очередь.|2.0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .<br /><br /> Параллелизм используется для инициализации пулов потоков, которые в Windows реализуются с помощью портов завершения операций ввода-вывода. Дополнительные сведения см. в разделе [Порты завершения ввода-вывода](http://msdn.microsoft.com/library/windows/desktop/aa365198\(v=vs.85\).aspx) .|  
|**Parsing**  \ **Short** \ **GroupAffinity**|строка|Массив шестнадцатеричных значений, который соответствует группам процессоров в системе, используемой для задания сходства потоков анализа логическим процессорам в каждой группе процессоров.|none|С помощью этого свойства можно создавать пользовательские сходства. По умолчанию это свойство пусто.<br /><br /> См. подробности в разделе [Задание параметра GroupAffinity для привязки потоков к процессорам или группе процессоров](#bkmk_groupaffinity) .|  
|**Parsing**  \ **Short** \ **NumThreads**|ssNoversion|Свойство с 32-разрядным целочисленным значением со знаком, определяющее количество потоков, которое можно создать для коротких команд.|0|0 указывает, что сервер сам определяет значения по умолчанию. По умолчанию параметру **NumThreads** задается абсолютное значение 4 или умноженное на 2 число логических процессоров в зависимости от того, какое значение выше.<br /><br /> Если значение задано как отрицательное, сервер умножит это число на количество логических процессоров. Например, если значение равно -10, на сервере с 32 логическими процессорами максимум будет составлять 320 потоков.<br /><br /> Максимальное значение зависит от числа процессоров, доступных для пользовательских масок сходства, определенных вами ранее. Например, если уже была задана схожесть пула потоков на использование 8 из 32 процессоров, при задании свойству NumThreads значения -10 верхняя граница пула потоков будет равна 10*8, то есть 80 потокам.<br /><br /> Фактические значения для этого свойства пула потоков заносятся в файл журнала msmdsrv после запуска службы.|  
|**Parsing**  \ **Short** \ **PriorityRatio**|ssNoversion|32-разрядное целое число со знаком, которое используется в том случае, если требуется, чтобы иногда выполнялись потоки с более низким приоритетом, даже если очередь с более высоким приоритетом не пуста.|0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .|  
|**Parsing**  \ **Short** \ **StackSizeKB**|ssNoversion|32-разрядное целое число со знаком, которое можно использовать для настройки выделения памяти во время выполнения потоков.|64 * число логических процессоров|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .|  
|**Process** \ **Concurrency**|double|Значение с плавающей запятой двойной точности, определяющее алгоритм для установки целевого количества потоков, которые могут быть одновременно поставлены в очередь.|2.0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .<br /><br /> Параллелизм используется для инициализации пулов потоков, которые в Windows реализуются с помощью портов завершения операций ввода-вывода. Дополнительные сведения см. в разделе [Порты завершения ввода-вывода](http://msdn.microsoft.com/library/windows/desktop/aa365198\(v=vs.85\).aspx) .|  
|**Process** \ **GroupAffinity**|строка|Массив шестнадцатеричных значений, который соответствует группам процессоров в системе, используемой для задания сходства потоков обработки логическим процессорам в каждой группе процессоров.|none|С помощью этого свойства можно создавать пользовательские сходства. По умолчанию это свойство пусто.<br /><br /> См. подробности в разделе [Задание параметра GroupAffinity для привязки потоков к процессорам или группе процессоров](#bkmk_groupaffinity) .|  
|**Process** \ **MaxThreads**|ssNoversion|32-разрядное целое число со знаком, определяющее максимальное количество потоков для включения в пул потоков.|0|0 указывает, что сервер сам определяет значения по умолчанию. По умолчанию сервер задает этому свойству абсолютное значение 64 или значение, равное числу логических процессоров, в зависимости от того, какое выше. Например, в системе с 64 ядрами и с включенной функцией технологии Hyper-Threading (что в результате дает 128 логических процессора), максимум для пула потоков будет равен 128.<br /><br /> Если значение задано как отрицательное, сервер умножит это число на количество логических процессоров. Например, если значение равно -10, на сервере с 32 логическими процессорами максимум будет составлять 320 потоков.<br /><br /> Максимальное значение зависит от числа процессоров, доступных для пользовательских масок сходства, определенных вами ранее. Например, если уже была задана схожесть пула потоков на использование 8 из 32 процессоров, при задании свойству MaxThreads значения -10 верхняя граница пула потоков будет равна 10*8, то есть 80 потокам.<br /><br /> Фактические значения для этого свойства пула потоков заносятся в файл журнала msmdsrv после запуска службы.<br /><br /> Дополнительные сведения о настройке параметров пула потоков можно найти в [руководстве по операциям служб Analysis Services](http://msdn.microsoft.com/library/hh226085.aspx).|  
|**Process** \ **MinThreads**|ssNoversion|32-разрядное целое число со знаком, определяющее минимальное количество потоков, предварительно выделяемых для пула потоков.|0|0 указывает, что сервер сам определяет значения по умолчанию. Минимальное значение по умолчанию равно 1.<br /><br /> Если значение задано как отрицательное, сервер умножит это число на количество логических процессоров.<br /><br /> Фактические значения для этого свойства пула потоков заносятся в файл журнала msmdsrv после запуска службы.<br /><br /> Дополнительные сведения о настройке параметров пула потоков можно найти в [руководстве по операциям служб Analysis Services](http://msdn.microsoft.com/library/hh226085.aspx).|  
|**Process** \ **PriorityRatio**|ssNoversion|32-разрядное целое число со знаком, которое используется в том случае, если требуется, чтобы иногда выполнялись потоки с более низким приоритетом, даже если очередь с более высоким приоритетом не пуста.|2|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .|  
|**Process** \ **StackSizeKB**|ssNoversion|32-разрядное целое число со знаком, которое можно использовать для настройки выделения памяти во время выполнения потоков.|0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .|  
|**Query**  \ **Concurrency**|double|Значение с плавающей запятой двойной точности, определяющее алгоритм для установки целевого количества потоков, которые могут быть одновременно поставлены в очередь.|2.0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .<br /><br /> Параллелизм используется для инициализации пулов потоков, которые в Windows реализуются с помощью портов завершения операций ввода-вывода. Дополнительные сведения см. в разделе [Порты завершения ввода-вывода](http://msdn.microsoft.com/library/windows/desktop/aa365198\(v=vs.85\).aspx) .|  
|**Query** \ **GroupAffinity**|строка|Массив шестнадцатеричных значений, который соответствует группам процессоров в системе, используемой для задания сходства потоков обработки логическим процессорам в каждой группе процессоров.|none|С помощью этого свойства можно создавать пользовательские сходства. По умолчанию это свойство пусто.<br /><br /> См. подробности в разделе [Задание параметра GroupAffinity для привязки потоков к процессорам или группе процессоров](#bkmk_groupaffinity) .|  
|**Query**  \ **MaxThreads**|ssNoversion|32-разрядное целое число со знаком, определяющее максимальное количество потоков для включения в пул потоков.|0|0 указывает, что сервер сам определяет значения по умолчанию. По умолчанию сервер задает этому свойству абсолютное значение 10 или значение, равное числу логических процессоров умноженное на 2, в зависимости от того, какое из них выше. Например, в системе с 4 ядрами с технологией Hyper-Threading максимальное число потоков равно 16.<br /><br /> Если значение задано как отрицательное, сервер умножит это число на количество логических процессоров. Например, если значение равно -10, на сервере с 32 логическими процессорами максимум будет составлять 320 потоков.<br /><br /> Максимальное значение зависит от числа процессоров, доступных для пользовательских масок сходства, определенных вами ранее. Например, если уже была задана схожесть пула потоков на использование 8 из 32 процессоров, при задании свойству MaxThreads значения -10 верхняя граница пула потоков будет равна 10*8, то есть 80 потокам.<br /><br /> Фактические значения для этого свойства пула потоков заносятся в файл журнала msmdsrv после запуска службы.<br /><br /> Дополнительные сведения о настройке параметров пула потоков можно найти в [руководстве по операциям служб Analysis Services](http://msdn.microsoft.com/library/hh226085.aspx).|  
|**Query** \ **MinThreads**|ssNoversion|32-разрядное целое число со знаком, определяющее минимальное количество потоков, предварительно выделяемых для пула потоков.|0|0 указывает, что сервер сам определяет значения по умолчанию. Минимальное значение по умолчанию равно 1.<br /><br /> Если значение задано как отрицательное, сервер умножит это число на количество логических процессоров.<br /><br /> Фактические значения для этого свойства пула потоков заносятся в файл журнала msmdsrv после запуска службы.<br /><br /> Дополнительные сведения о настройке параметров пула потоков можно найти в [руководстве по операциям служб Analysis Services](http://msdn.microsoft.com/library/hh226085.aspx).|  
|**Query** \ **PriorityRatio**|ssNoversion|32-разрядное целое число со знаком, которое используется в том случае, если требуется, чтобы иногда выполнялись потоки с более низким приоритетом, даже если очередь с более высоким приоритетом не пуста.|2|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .|  
|**Query**  \ **StackSizeKB**|ssNoversion|32-разрядное целое число со знаком, которое можно использовать для настройки выделения памяти во время выполнения потоков.|0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .|  
|**VertiPaq** \ **CPUs**|ssNoversion|32-разрядное целое число со знаком, определяющее максимальное количество процессоров для использования в табличных запросах.|0|0 указывает, что сервер сам определяет значения по умолчанию. По умолчанию сервер задает этому свойству абсолютное значение 10 или значение, равное числу логических процессоров умноженное на 2, в зависимости от того, какое из них выше. Например, в системе с 4 ядрами с технологией Hyper-Threading максимальное число потоков равно 16.<br /><br /> Если значение задано как отрицательное, сервер умножит это число на количество логических процессоров. Например, если значение равно -10, на сервере с 32 логическими процессорами максимум будет составлять 320 потоков.<br /><br /> Максимальное значение зависит от числа процессоров, доступных для пользовательских масок сходства, определенных вами ранее. Например, если уже была задана схожесть пула потоков на использование 8 из 32 процессоров, при задании свойству MaxThreads значения -10 верхняя граница пула потоков будет равна 10*8, то есть 80 потокам.<br /><br /> Фактические значения для этого свойства пула потоков заносятся в файл журнала msmdsrv после запуска службы.|  
  |**VertiPaq** \ **GroupAffinity**|строка|Массив шестнадцатеричных значений, который соответствует группам процессоров в системе, используемой для задания сходства потоков обработки логическим процессорам в каждой группе процессоров.|none|С помощью этого свойства можно создавать пользовательские сходства. По умолчанию это свойство пусто.<br /><br /> См. подробности в разделе [Задание параметра GroupAffinity для привязки потоков к процессорам или группе процессоров](#bkmk_groupaffinity) . Применяется только к табличной модели.| 
    
##  <a name="bkmk_groupaffinity"></a> Задание параметра GroupAffinity для привязки потоков к процессорам или группе процессоров  
 Значение**GroupAffinity** предоставляется для дополнительной настройки. Свойство **GroupAffinity** можно использовать, чтобы установить соответствие между пулами потоков [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] и некоторыми процессорами. Однако для большинства установок [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] работает лучше, если можно использовать все доступные логические процессоры. Таким образом, по умолчанию соответствие группы не задано.  
  
 Если эксплуатационное тестирование показывает необходимость оптимизации использования ЦП, то, возможно, стоит рассмотреть подход более высокого уровня, например использование диспетчера ресурсов Windows Server для указания сходства между логическими процессорами и процессом сервера. Такой подход может оказаться проще в реализации и управлении, чем определение пользовательских соответствий для отдельных пулов потоков.  
  
 Если этого окажется недостаточно для решения задачи, то большей точности можно добиться, определив пользовательские соответствия для пулов потоков. Настройка параметров сходства чаще всего рекомендуется в больших многоядерных системах (как с NUMA, так и без этой технологии), испытывающих снижение производительности из-за распределения пулов потоков по слишком большому числу процессоров. Свойство **GroupAffinity** можно задать и в системах, где число логических процессоров меньше 64, но выигрыш от этого будет незначительным, или даже произойдет падение производительности.  
  
> [!NOTE]  
>  **GroupAffinity** ограничивается выпусками, которые лимитируют количество ядер, используемых [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)]. При запуске [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] использует сведения о выпуске и свойства **GroupAffinity** в целях вычисления масок сходства для каждого пула потоков, управляемого службами [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)]. В стандартном выпуске могут использоваться максимум 24 ядра. Если установить стандартный выпуск [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] в большой многоядерной системе, имеющей больше 24 ядер, то в [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] будет использоваться только 24 из них. Дополнительные сведения о максимальных конфигурациях процессоров см. в данных о пределах масштабирования разных выпусков в разделе [Функции в выпусках SQL Server](https://msdn.microsoft.com/library/cc645993.aspx).  
  
### <a name="syntax"></a>Синтаксис  
 Шестнадцатеричное значение для каждой группы процессоров, представляющее логические процессоры, которые [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] пытается использовать при выделении потоков из определенного пула.  
  
 **Битовая маска для логических процессоров**  
  
 Можно указать до 64 логических процессоров в пределах одной группы. Битовая маска равна 1 (или 0) для каждого логического процессора в группе, используемого (или не используемого) пулом потоков. После вычисления битовой маски вычисляется шестнадцатеричное значение для **GroupAffinity**.  
  
 **Многочисленные группы процессоров**  
  
 Группы процессоров определяются во время запуска системы. **GroupAffinity** содержит шестнадцатеричные значения для каждой группы процессоров в списке, разделенном запятыми. При наличии нескольких групп процессоров (до 10 на мощных системах) можно пропустить отдельные группы, указав 0x0. Например, в системе с четырьмя группами процессоров (0, 1, 2, 3) можно исключить группы 0 и 2, введя 0x0 для первого и третьего значения.  
  
 `<GroupAffinity>0x0, 0xFF, 0x0, 0xFF</GroupAffinity>`  
  
### <a name="steps-for-computing-the-processor-affinity-mask"></a>Действия при вычислении маски соответствия процессоров  
 Можно установить параметр **GroupAffinity** в файле msmdsrv.ini или на странице свойств сервера в SQL Server Management Studio.  
  
1.  **Определение количества процессоров и групп процессоров**  
  
     Можно загрузить [программу Coreinfo из winsysinternals](http://technet.microsoft.com/sysinternals/cc835722.aspx).  
  
     Запустите **coreinfo** для получения этих сведений из раздела «Сопоставление логических процессоров с группой». Формируется отдельная строка для каждого логического процессора.  
  
2.  Последовательность процессоров справа налево: `7654 3210`  
  
     Пример показывает только 8 процессоров (от 0 до 7), но группа процессоров может иметь максимум 64 логических процессора. На сервере Windows уровня предприятия может быть до 10 групп процессоров.  
  
3.  **Вычислите битовую маску для групп процессоров, которые собираетесь использовать**  
  
     `7654 3210`  
  
     Замените цифру на 0 или 1 в зависимости от того, нужно включить или исключить логический процессор. В системе с 8 процессорами выбранное вычисление может выглядеть следующим образом, если для служб Analysis Services решено использовать процессоры 7, 6, 5, 4 и 1:  
  
     `1111 0010`  
  
4.  **Преобразование двоичного значения в шестнадцатеричное**  
  
     Преобразуйте двоичное значение в шестнадцатеричное с помощью калькулятора или средства преобразования. В нашем примере `1111 0010` преобразуется в `0xF2`.  
  
5.  **Укажите это шестнадцатеричное значение в свойстве GroupAffinity**  
  
     В файле msmdsrv.ini или на странице свойств сервера в Management Studio установите параметр **GroupAffinity** в значение, которое было вычислено на шаге 4.  
  
> [!IMPORTANT]  
>  Установка параметра **GroupAffinity** выполняется вручную за несколько действий. При вычислении значения **GroupAffinity**выполняйте вычисления аккуратно, не допуская ошибок. Хотя [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] возвращает ошибку, если некорректна вся маска, сочетание допустимых и недопустимых параметров приводит к тому, что [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] игнорирует это свойство. Например, если битовая маска включает дополнительные значения, то [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] пропустит этот параметр и будут использоваться все ЦП в системе. Нет ошибки или предупреждения, которое сообщило бы об этом. Но вы можете проверить файл msmdsrv.log, чтобы узнать, как на самом деле заданы критерии сходства.  
  
##  <a name="bkmk_pernumanode"></a> Задайте параметр PerNumaNode, чтобы привязать потоки ввода-вывода к процессорам в узле NUMA.  
 Для многомерных экземпляров служб Analysis Services можно установить параметр **PerNumaNode** в пуле потоков **IOProcess** , чтобы еще больше оптимизировать планирование и выполнение потоков. В то время как свойство **GroupAffinity** определяет набор логических процессоров, используемых для определенного пула потоков, **PerNumaNode** делает больше, указывая, нужно ли создавать несколько пулов, более точно привязанных к определенному подмножеству разрешенных логических процессоров.  
  
> [!NOTE]  
>  Чтобы узнать число узлов NUMA в Windows Server 2012, используйте диспетчер задач. В диспетчере задач на вкладке "Производительность" выберите **ЦП** , а затем щелкните правой кнопкой мыши область диаграммы для просмотра узлов NUMA. Или же [загрузите](http://technet.microsoft.com/sysinternals/cc835722.aspx) программу Coreinfo из Windows Sysinternals и запустите `coreinfo -n` , что позволит узнать число узлов NUMA и количество логических процессоров в каждом узле.  
  
 Допустимые значения для **PerNumaNode** : -1, 0, 1, 2, как описано в подразделе [Справочник по свойствам пула потоков](#bkmk_propref) этого раздела.  
  
### <a name="default-recommended"></a>По умолчанию (рекомендуется)  
 В системах, где есть узлы NUMA, рекомендуется использовать PerNumaNode=-1. Это позволяет [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] подстраивать количество пулов потоков и их соответствие на основе количества узлов. Если в системе используется менее 4 узлов, то [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] реализует стратегии для **PerNumaNode**=0, а **PerNumaNode**=1 используется в системах, где имеется 4 и более узлов.  
  
### <a name="choosing-a-value"></a>Выбор значения  
 Можно также переопределить значение по умолчанию и использовать другое допустимое значение.  
  
 **Задание PerNumaNode=0**  
  
 Узлы NUMA не учитываются. Будет присутствовать только один пул потоков IOProcess, и все потоки в этом пуле будут привязаны ко всем логическим процессорам. Это значение будет использоваться по умолчанию (при PerNumaNode=-1), если компьютер имеет менее 4 узлов NUMA.  
  
 ![NUMA, процессора и пула соответствие](../../analysis-services/server-properties/media/ssas-threadpool-numaex0.PNG "Numa, процессора и пула соответствие")  
  
 **Задание PerNumaNode=1**  
  
 Пулы потоков IOProcess создаются для каждого узла NUMA. Наличие отдельных пулов потоков способствует улучшению координируемого доступа к локальным ресурсам, например к локальному кэшу на узле NUMA.  
  
 ![NUMA, процессора и пула соответствие](../../analysis-services/server-properties/media/ssas-threadpool-numaex1.PNG "Numa, процессора и пула соответствие")  
  
 **Задание PerNumaNode=2**  
  
 Это значение для очень мощных систем, где выполняются интенсивные рабочие нагрузки [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] . Это свойство задает привязку пула потоков IOProcess на самом детальном уровне, создавая и привязывая пулы на уровне логических процессоров.  
  
 В следующем примере в системе с 4 узлами NUMA и 32 логическими процессорами задание параметру **PerNumaNode** значения 2 приведет к созданию 32 пулов потоков IOProcess. Потоки в первых 8 пулах будут привязаны ко всем логическим процессорам в узле 0, но идеальный процессор будет назначен для 0, 1, 2... до 7. Следующие 8 пулов потоков будут привязаны ко всем логическим процессорам в узле 1 NUMA, идеальный процессор будет назначен для 8, 9, 10... до 15 и т. д.  
  
 ![NUMA, процессора и пула соответствие](../../analysis-services/server-properties/media/ssas-threadpool-numaex2.PNG "Numa, процессора и пула соответствие")  
  
 На этом уровне соответствия планировщик всегда сначала пытается использовать идеально подходящий логический процессор в предпочитаемом узле NUMA. Если логический процессор недоступен, то планировщик выбирает один процессор в том же узле или в той же группе процессоров, если другие потоки недоступны. Дополнительные сведения и примеры см. в статье [Параметры конфигурации служб Analysis Services 2012 (блог Wordpress)](http://go.microsoft.com/fwlink/?LinkId=330387).  
  
###  <a name="bkmk_workdistrib"></a> Распределение нагрузки между потоками IOProcess  
 При установке значения для свойства **PerNumaNode** следует знать, как используются потоки **IOProcess** , что поможет принять более обоснованное решение.  
  
 Напомним, что **IOProcess** используется для заданий ввода-вывода, связанных с запросами подсистемы хранилища в многомерном модуле.  
  
 При сканировании сегмента модуль определяет секцию, к которой принадлежит сегмент, и пытается поместить задание сегмента в пул потоков, используемый этой секцией. Как правило, все сегменты, принадлежащие секции, ставят свои задачи в один и тот же пул потоков. В системах NUMA это особенно удобно, поскольку все операции сканирования секции используют память в кэше файловой системы, локально выделенном для этого узла NUMA.  
  
 В следующих сценариях предлагаются корректировки, которые иногда могут увеличить производительность запросов в системах NUMA.  
  
-   Для групп мер, которые недостаточно разделены (например, при использовании одной секции), увеличьте число секций. При использовании только одной секции модуль всегда помещает задачи в один пул потоков (нулевой). Добавление нескольких секций позволяет модулю использовать дополнительные пулы потоков.  
  
     Кроме того, если нельзя создать дополнительные секции, попробуйте установить параметр **PerNumaNode**на 0, чтобы увеличить количество потоков, доступных в пуле потоков 0.  
  
-   Для баз данных, в которых операции сканирования сегмента равномерно распределены по нескольким секциям, установка **PerNumaNode** равным 1 или 2 может улучшить производительность запросов, так как это увеличит общее количество используемых системой пулов потоков **IOProcess** .  
  
-   Для решений, которые имеют несколько секций, но только на одну из них приходится значительная нагрузка сканирования, попробуйте задать **PerNumaNode**=0 и проверьте, повысится ли при этом производительность.  
  
 Несмотря на то что в операциях сканирования секций и измерений используется пул потоков **IOProcess** , в сканированиях измерений участвует только пул потоков 0. Это может привести к слегка неравномерной загрузке данного пула потоков, но дисбаланс должен быть временным, так как операции сканирования измерений применяются редко и выполняются очень быстро.  
  
> [!NOTE]  
>  При изменении свойства сервера следует помнить, что параметр конфигурации применяется ко всем базам данных в текущем экземпляре. Выберите параметры, дающие выигрыш для наиболее важных баз данных или большего числа баз данных. Нельзя установить привязку процессоров на уровне базы данных, нельзя также задать соответствия между отдельными секциями и некоторыми процессорами.  
  
 Дополнительные сведения об архитектуре заданий см. в разделе 2.2 [руководства по производительности служб SQL Server Analysis Services](http://www.microsoft.com/download/details.aspx?id=17303).  
  
##  <a name="bkmk_related"></a> Зависимые или связанные свойства  
 Как описано в разделе 2.4 [руководства по использованию служб Analysis Services](http://msdn.microsoft.com/library/hh226085.aspx), при увеличении пула потоков обработки следует убедиться, что параметры **CoordinatorExecutionMode** , а также параметры **CoordinatorQueryMaxThreads** имеют значения, которые в полной мере позволяют использовать увеличенный размер пула потоков.  
  
 Службы Analysis Services используют координирующий поток для сбора данных, необходимых для завершения обработки или выполнения запроса. Координатор сначала ставит в очередь одно задание для каждой секции, которое необходимо обработать. Каждое из этих заданий затем ставит в очередь другие задания в зависимости от общего числа сегментов, которые необходимо просмотреть в секции.  
  
 Значение по умолчанию для **CoordinatorExecutionMode** равно -4, что ставит предел в 4 параллельных заданиях на ядро и ограничивает общее количество заданий координатора, которые могут параллельно выполняться запросом вложенного куба в подсистеме хранилища.  
  
 Значение по умолчанию для **CoordinatorQueryMaxThreads** равно 16, что ограничивает число сегментов заданий, которые могут выполняться параллельно для каждой секции.  
  
##  <a name="bkmk_currentsettings"></a> Определение текущих параметров пула потоков  
 При каждом запуске службы [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] выводит текущие параметры пула потоков в файл msmdsrv.log, включая минимальное и максимальное число потоков, маску соответствия процессоров и степень параллелизма.  
  
 В следующем примере дан отрывок из файла журнала, где показываются параметры по умолчанию для пула потоков Query (MinThread=0, MaxThread=0, Concurrency=2) в 4-ядерной системе с включенной функцией управления потоками. Маска сходства — 0xFF, что означает 8 логических процессоров. Обратите внимание, что к маске добавлены нули в начале. Не обращайте на них внимание.  
  
 `"10/28/2013 9:20:52 AM) Message: The Query thread pool now has 1 minimum threads, 16 maximum threads, and a concurrency of 16.  Its thread pool affinity mask is 0x00000000000000ff. (Source: \\?\C:\Program Files\Microsoft SQL Server\MSAS11.MSSQLSERVER\OLAP\Log\msmdsrv.log, Type: 1, Category: 289, Event ID: 0x4121000A)"`  
  
 Помните, что алгоритм для установки параметра **MinThread** и **MaxThread** опирается на системную конфигурацию, в частности на число процессоров. В следующей статье блога описывается то, как вычисляются данные значения: [Параметры анализа конфигурации Services 2012 (блог Wordpress)](http://go.microsoft.com/fwlink/?LinkId=330387). Обратите внимание, что эти параметры и стратегии могут быть изменены в последующих выпусках.  
  
 В следующем списке показаны примеры других масок сходства для различных сочетаний процессоров:  
  
-   Соответствие для процессоров 3-2-1-0 в 8-ядерной системе приведет к этой битовой маске: 00001111 и шестнадцатеричное значение: 0xF  
  
-   Соответствие для процессоров 7-6-5-4 в 8-ядерной системе приведет к этой битовой маске: 11110000 и шестнадцатеричное значение: 0xF0  
  
-   Соответствие для процессоров 5-4-3-2 в 8-ядерной системе приведет к этой битовой маске: 00111100 и шестнадцатеричное значение: 0x3C  
  
-   Соответствие для процессоров 7-6-1-0 в 8-ядерной системе в этой битовой маске: 11000011 и шестнадцатеричное значение: 0xC3  
  
 Помните, что в системах, имеющих несколько групп процессов, для каждой группы формируется отдельная маска сходства в виде списка с разделением запятыми.  
  
##  <a name="bkmk_msmdrsrvini"></a> О файле MSMDSRV.INI  
 Файл msmdsrv.ini содержит параметры конфигурации для экземпляра [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] , влияющие на все базы данных, запущенные на данном экземпляре. Нельзя использовать свойства конфигурации сервера для оптимизации производительности только одной базы данных за счет других. Однако можно установить несколько экземпляров служб [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] и настроить эти экземпляры на использование свойств, которые дадут выигрыш для баз данных, использующих одинаковые характеристики или рабочие нагрузки.  
  
 Все свойства конфигурации сервера содержатся в файле msmdsrv.ini. Подмножества этих свойств, которые изменяются чаще всего, доступны также в средствах управления, таких как среда SSMS.  
  
 Содержимое файла msmdsrv.ini одинаково как для многомерных, так и для табличных экземпляров [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)]. Однако некоторые параметры применяются только в одном из этих режимов. Различия в поведении, зависящие от режима сервера, указаны в справочной документации свойства.  
  
> [!NOTE]  
>  Инструкции по заданию этих свойств см. в разделе [Свойства сервера в службах Analysis Services](../../analysis-services/server-properties/server-properties-in-analysis-services.md).  
  
## <a name="see-also"></a>См. также  
 [О процессах и потоках](/windows/desktop/ProcThread/about-processes-and-threads)   
 [Несколько процессоров](/windows/desktop/ProcThread/multiple-processors)   
 [Группы процессоров](/windows/desktop/ProcThread/processor-groups)   
 [Изменения пула потоков служб Analysis Services в SQL Server 2012](http://blogs.msdn.com/b/psssql/archive/2012/01/31/analysis-services-thread-pool-changes-in-sql-server-2012.aspx)   
 [Параметры конфигурации служб Analysis Services 2012 (блог Wordpress)](http://go.microsoft.com/fwlink/?LinkId=330387)   
 [Поддержка систем, оснащенных более чем 64 процессорами](http://msdn.microsoft.com/library/windows/hardware/gg463349.aspx)   
 [Руководство по использованию служб SQL Server Analysis Services](http://go.microsoft.com/fwlink/?LinkID=225539)  
  
  
