---
title: Реализация динамической безопасности с помощью фильтров строк | Документация Майкрософт
ms.date: 05/07/2019
ms.prod: sql
ms.technology: analysis-services
ms.custom: tabular-models
ms.topic: tutorial
ms.author: owend
ms.reviewer: owend
author: minewiskan
manager: kfile
ms.openlocfilehash: d84f208fc36c0bb647537aa174b86e06ba70abc3
ms.sourcegitcommit: 54c8420b62269f6a9e648378b15127b5b5f979c1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/07/2019
ms.locfileid: "65403386"
---
# <a name="supplemental-lesson---implement-dynamic-security-by-using-row-filters"></a>Дополнительное занятие. Реализация динамической безопасности с помощью фильтров строк
[!INCLUDE[ssas-appliesto-sql2016-later-aas](../../includes/ssas-appliesto-sql2016-later-aas.md)]

На этом дополнительном занятии будет создана дополнительная роль, реализующая динамическую безопасность. Динамическая безопасность позволяет определять защиту на уровне строк с учетом имени или идентификатор входа пользователя, который находится в системе в данный момент. Дополнительные сведения см. в разделе [Роли](../tabular-models/roles-ssas-tabular.md).  
  
Для реализации динамической безопасности необходимо добавить в модель таблицу, содержащую имена тех пользователей, которые могут создавать соединения с моделью как с источником данных и просматривать объекты и данные модели. Модель, которая будет создана на этом занятии, находится в контексте Adventure Works Corp. Но в целях данного занятия добавим таблицу, содержащую пользователей из собственного домена пользователя. Для добавляемых имен пользователей пароли не потребуются. Чтобы создать таблицу EmployeeSecurity с небольшой выборкой пользователей из собственного домена, будет использовать функцию вставки, вставляя данные из электронной таблицы Excel. В реальном сценарии таблица, содержащая добавляемые в модель имена, будет использовать таблицу из фактической базы данных в качестве источника данных — например, реальную таблицу dimEmployee.  
  
Для реализации динамической безопасности будут использованы две новые функции DAX: [Функция USERNAME (DAX)](http://msdn.microsoft.com/22dddc4b-1648-4c89-8c93-f1151162b93f) и [функция LOOKUPVALUE (DAX)](http://msdn.microsoft.com/73a51c4d-131c-4c33-a139-b1342d10caab). Эти функции, примененные к формуле фильтра строк, определяются в новой роли. При помощи функции LOOKUPVALUE формула указывает значение из таблицы EmployeeSecurity и затем передает значение функции USERNAME, которая указывает имя пользователя, выполнившего вход пользователя принадлежит этой роли. Пользователь может просматривать только данные, указанные в фильтрах строк роли. В этом сценарии нужно будет указать, что сотрудники отдела продаж могут просматривать только те данные интернет-продаж, которые относятся к их региону.  
  
Во время выполнения этого дополнительного занятия нужно будет выполнить ряд заданий. Эти задачи являются уникальными для сценария табличной модели Adventure Works, но они не могут иметь прямого отношения к реальному сценарию. Каждое задание включает дополнительные сведения, описывающие цель задания.  
  
Предполагаемое время для выполнения этого занятия: **30 минут**  
  
## <a name="prerequisites"></a>предварительные требования  
Это дополнительное занятие является частью учебника по табличному моделированию, который необходимо изучать по порядку. Прежде чем выполнять задания в этом дополнительном занятии, необходимо завершить все предыдущие занятия.  
  
## <a name="add-the-dimsalesterritory-table-to-the-aw-internet-sales-tabular-model-project"></a>Добавление таблицы dimSalesTerritory в проект табличной модели интернет-продаж AW  
Чтобы реализовать динамическую безопасность для этого сценария Adventure Works, необходимо добавить в модель две дополнительные таблицы. Первая таблица, которая будет добавлена, называется dimSalesTerritory (т. е. территория продаж) из той же базы данных AdventureWorksDW. Позже будет применен фильтр строк к таблице SalesTerritory, определяющий данные, которые может просматривать вошедший пользователь.  
  
#### <a name="to-add-the-dimsalesterritory-table"></a>Добавление таблицы dimSalesTerritory  
  
1.  В SSDT откройте **модели** меню, а затем щелкните **существующие подключения**.  
  
2.  Убедитесь в том, что в диалоговом окне **Существующие соединения** выбрано соединение с источником данных **База данных Adventure Works из SQL** , и нажмите кнопку **Открыть**.  
  
    Если появится диалоговое окно учетных данных олицетворения, введите учетные данные олицетворения, которая использовалась в занятии 2: Добавление данных.  
  
3.  Убедитесь в том, что на странице **Выбор способа импорта данных** выбран пункт **Выбрать из списка таблиц и представлений, чтобы определить данные для импорта** , и нажмите кнопку **Далее**.  
  
4.  На странице **Выбор таблиц и представлений** выберите таблицу **DimSalesTerritory** .  
  
5.  Нажмите кнопку **Просмотр и применение фильтра**.  
  
6.  Снимите выделение со столбца **SalesTerritoryAlternateKey** и нажмите кнопку **ОК**.  
  
7.  На странице **Выбор таблиц и представлений** нажмите кнопку **Готово**.  
  
    Новая таблица будет добавлена в рабочую область модели. Объекты и данные из исходной таблицы DimSalesTerritory будут импортированы в табличной модели AW Internet Sales.  
  
9. После импорта таблицы нажмите кнопку **Закрыть**.  

## <a name="add-a-table-with-user-name-data"></a>Добавление таблицы с именами пользователей  
Поскольку таблица dimEmployee в образце базы данных AdventureWorksDW содержит пользователей из домена AdventureWorks и эти имена пользователей не существуют в текущей среде, необходимо создать таблицу в модели, содержащей небольшую выборку (дерево) фактических пользователей из организации. После этого нужно добавить этих пользователей как членов в новую роль. Для выборки имен пользователей пароли не требуются, однако нужны имена реальных пользователей Windows из домена.  
  
#### <a name="to-add-an-employeesecurity-table"></a>Добавление таблицы EmployeeSecurity  
  
1.  Откройте Microsoft Excel и создайте новую электронную таблицу.  
  
2.  Скопируйте следующую таблицу, включая строку заголовка, и вставьте ее в электронную таблицу.  

    ```
      |EmployeeId|SalesTerritoryId|FirstName|LastName|LoginId|  
      |---------------|----------------------|--------------|-------------|------------|  
      |1|2|<user first name>|<user last name>|\<domain\username>|  
      |1|3|<user first name>|<user last name>|\<domain\username>|  
      |2|4|<user first name>|<user last name>|\<domain\username>|  
      |3|5|<user first name>|<user last name>|\<domain\username>|  
    ```

3.  Замените имя, фамилию и домен\имя_пользователя имена и идентификаторы входа трех пользователей в вашей организации. Укажите того же пользователя в первые две строки, EmployeeId 1. Это означает, что пользователь относится к более чем одной территории продаж. Оставьте все поля EmployeeId и SalesTerritoryId, так как они являются.  
  
4.  Сохраните лист как **SampleEmployee**.  
  
5.  На листе выберите все ячейки с данными о сотрудниках, включая заголовки, а затем щелкните правой кнопкой мыши выбранные данные и нажмите кнопку **копирования**.  
  
6.  В SSDT откройте **изменить** меню, а затем щелкните **вставить**.  
  
    Если вставки неактивна, щелкните любой столбец в любой таблице в окне конструктора моделей и повторите попытку.  
  
7.  В **Просмотр вставки** отображаемое в диалоговом окне **имя таблицы**, тип **EmployeeSecurity**.  
  
8.  В **вставляемые данные**, проверьте данные включают все сведения о пользователях и заголовки с листа SampleEmployee.  
  
9. Убедитесь в том, что установлен флажок **Использовать первую строку в качестве заголовков столбцов** , и нажмите кнопку **ОК**.  
  
    Будет создана новая таблица с именем EmployeeSecurity с данными о сотрудниках скопировать с листа SampleEmployee.  
  
## <a name="create-relationships-between-factinternetsales-dimgeography-and-dimsalesterritory-table"></a>Создание связей между таблицами FactInternetSales DimGeography и DimSalesTerritory  
Все таблицы FactInternetSales DimGeography и DimSalesTerritory содержат общий столбец SalesTerritoryId. Столбец SalesTerritoryId таблицы DimSalesTerritory содержит значения с другим идентификатором для каждой территории продаж.  
  
#### <a name="to-create-relationships-between-the-factinternetsales-dimgeography-and-the-dimsalesterritory-table"></a>Для создания связей между таблицами FactInternetSales DimGeography и DimSalesTerritory таблицы  
  
1.  В конструкторе моделей в представлении диаграммы в **DimGeography** нажмите и удерживайте нажатым **SalesTerritoryId** столбец, затем перетащите курсор **SalesTerritoryId** столбец в **DimSalesTerritory** таблицы, а затем отпустите.  
  
2.  В **FactInternetSales** нажмите и удерживайте нажатым **SalesTerritoryId** столбец, затем перетащите курсор **SalesTerritoryId** столбец в  **DimSalesTerritory** таблицы, а затем отпустите.  
  
    Обратите внимание, что свойство "Active" для этой связи имеет значение False, то есть оно неактивно. Это потому, что таблица FactInternetSales уже имеет другую активную связь, используемую в мерах.  
  
## <a name="hide-the-employeesecurity-table-from-client-applications"></a>Скрытие таблицы EmployeeSecurity в клиентских приложениях  
В этой задаче предстоит скрыть таблицу EmployeeSecurity, оставив его отображение в списке полей клиентского приложения. Помните, что скрытие таблицы не обеспечивает ее безопасность. Пользователи по-прежнему могут запрашивать данные из таблицы EmployeeSecurity, если они знают, как. Чтобы защитить данные в таблице EmployeeSecurity, запретив пользователям запрашивать любые ее данные, будет применен фильтр в одной из следующих задач.  
  
#### <a name="to-hide-the-employeesecurity-table-from-client-applications"></a>Скрытие таблицы EmployeeSecurity в клиентских приложениях  
  
-   В конструкторе моделей в представлении диаграммы щелкните правой кнопкой мыши заголовок таблицы **Сотрудник** и выберите команду **Скрыть из набора клиентских средств**.  
  
## <a name="create-a-sales-employees-by-territory-user-role"></a>Создание пользовательской роли «Сотрудники отдела продаж по территории»  
На этом занятии будет создана новая пользовательская роль. Эта роль будет включать фильтр строк, определяющий, какие строки таблицы DimSalesTerritory видны пользователям. Фильтр применяется в направлении "один к многим" ко всем остальным таблицам, связанным с DimSalesTerritory. Будет также применен простой фильтр, который защищает всю таблицу EmployeeSecurity, запрещая любым пользователям, являющимся членом этой роли.  
  
> [!NOTE]  
> Роль «Сотрудники отдела продаж по территории», создаваемая на этом занятии, ограничивает возможность членов, просматривающих данные продаж, территорией, к которой они относятся. При добавлении пользователя как члена сотрудники отдела продаж по территориям также существует как члена в роль создана в [занятие 11: Создание ролей](lesson-11-create-roles.md), вы получите сочетание разных разрешений. Когда пользователь является членом нескольких ролей, он обладает всеми разрешениями, определенными для каждой из них. Это означает, что пользователь будет иметь больше разрешений, определяемых сочетанием ролей.  
  
#### <a name="to-create-a-sales-employees-by-territory-user-role"></a>Создание пользовательской роли «Сотрудники отдела продаж по территории»  
  
1.  В SSDT откройте **модели** меню, а затем щелкните **ролей**.  
  
2.  В **диспетчер ролей**, нажмите кнопку **New**.  
  
    В список будет добавлена новая роль с разрешением «Нет».  
  
3.  Щелкните новую роль, а затем столбец **Имя** , после чего переименуйте роль в **Сотрудники отдела продаж по территории**.  
  
4.  В столбце **Разрешения** щелкните раскрывающийся список и выберите разрешение **Чтение**.  
  
5.  Перейдите на вкладку **Члены** и выберите команду **Добавить**.  
  
6.  В **Выбор пользователя или группы** отображаемое в диалоговом окне **введите имя объекта для выбора**, введите имя пользователя первый пример, который использовался при создании таблицы EmployeeSecurity. Щелкните **Проверить имена** , чтобы убедиться в том, что имя является действительным, и нажмите кнопку **ОК**.  
  
    Повторите этот шаг, добавляя другие выборки имен пользователей, использованные при создании таблицы EmployeeSecurity.  
  
7.  Откройте вкладку **Фильтры строк** .  
  
8.  Для **EmployeeSecurity** таблицы, в **DAX-фильтр** столбца, введите следующую формулу.  
  
    ```
      =FALSE()  
    ```
  
    Эта формула указывает, что все столбцы решаются в логическое значение false; Таким образом нет столбцов из таблицы EmployeeSecurity могут запрашиваться членами сотрудники отдела продаж по роли пользователя «Территория».  
  
9. Для таблицы **DimSalesTerritory** введите следующую формулу:  

    ```  
    ='Sales Territory'[Sales Territory Id]=LOOKUPVALUE('Employee Security'[Sales Territory Id], 
      'Employee Security'[Login Id], USERNAME(), 
      'Employee Security'[Sales Territory Id], 
      'Sales Territory'[Sales Territory Id]) 
    ```
  
    В этой формуле функция LOOKUPVALUE возвращает все значения для столбца DimEmployeeSecurity [SalesTerritoryId], где EmployeeSecurity [LoginId] совпадает со значением текущего имени пользователя Windows, а EmployeeSecurity [SalesTerritoryId] — совпадает с DimSalesTerritory [SalesTerritoryId].  
  
    Набор территории продаж, идентификаторы, возвращенные функцией LOOKUPVALUE затем используется для ограничения строк, отображаемых в таблице DimSalesTerritory. Отображаются только строки, где SalesTerritoryID для строки входит в набор идентификаторов, возвращенных функцией LOOKUPVALUE.  
  
10. В диспетчере ролей нажмите кнопку **ОК**.  
  
## <a name="test-the-sales-employees-by-territory-user-role"></a>Тестирование пользовательской роли «Сотрудники отдела продаж по территории»  
В этой задаче будет использовать анализ в Excel функции в SSDT можно протестировать эффективность торговые по роли пользователя «Территория». Необходимо указать одно из имен пользователей, добавленных в таблицу EmployeeSecurity и как член роли. Это имя пользователя будет затем использовано как имя реального пользователя для соединения, установленного между Excel и моделью.  
  
#### <a name="to-test-the-sales-employees-by-territory-user-role"></a>Тестирование пользовательской роли «Сотрудники отдела продаж по территории»  
  
1.  В SSDT откройте **модели** меню, а затем щелкните **анализ в Excel**.  
  
2.  В диалоговом окне **Анализ в Excel** в поле **Укажите имя пользователя или роль для подключения к модели**выберите вариант **Другой пользователь Windows**и нажмите кнопку **Обзор**.  
  
3.  В **Выбор пользователя или группы** отображаемое в диалоговом окне **введите имена выбираемых объектов**, введите одно из имен пользователей, добавленных в таблицу EmployeeSecurity и нажмите кнопку **проверить имена**.  
  
4.  Нажмите кнопку **ОК** , чтобы закрыть диалоговое окно **Выбор пользователя или группы** , а затем кнопку **ОК** , чтобы закрыть диалоговое окно **Анализ в Excel** .  
  
    Excel откроет новую книгу. Сводная таблица создается автоматически. Список полей сводной таблицы включает большинство полей данных, доступных в новой модели.  
  
    Обратите внимание, что таблица EmployeeSecurity не отображается в списке полей сводной таблицы. Это происходит потому, что эта таблица была скрыта от клиентских средств в предыдущем задании.  
  
5.  В **поля** раздела **∑ Интернет-продаж** (меры) выберите **InternetTotalSales** мер. Мера будет указана в полях **Значения** .  
  
6.  Выберите **SalesTerritoryId** столбец из **DimSalesTerritory** таблицы. Столбец будет введен в поля **Метки строк** .  
  
    Обратите внимание, что цифры продаж появятся только для того региона, к которому относится имя пользователя. Если выбрать другой столбец; Например Город, из таблицы DimGeography поле метки строки, только города на территории сбыта, к которой относится действующий пользователь отображаются.  
  
    Этот пользователь не может просматривать или отправлять запросы для получения данных Интернет-продаж для других территорий, к которым он не относится, поскольку фильтр строк, определенный для таблицы «Территория продаж» в пользовательской роли «Сотрудники отдела продаж по территории», надежно защищает все данные, связанные с другими территориями продаж.  
  
## <a name="see-also"></a>См. также  
[функция USERNAME (DAX)](http://msdn.microsoft.com/22dddc4b-1648-4c89-8c93-f1151162b93f)  
[функция LOOKUPVALUE (DAX)](http://msdn.microsoft.com/73a51c4d-131c-4c33-a139-b1342d10caab)  
[CUSTOMDATA, функция (DAX)](http://msdn.microsoft.com/58235ad8-226c-43cc-8a69-5a52ac19dd4e)  
