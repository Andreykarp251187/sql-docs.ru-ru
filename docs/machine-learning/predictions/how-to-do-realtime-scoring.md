---
title: Формирование прогнозов
description: Используйте rxPredict или sp_rxPredict для оценки в реальном времени либо PREDICT T-SQL для собственной оценки, на основе которой можно формировать прогнозы в R и Python в Машинном обучении SQL Server.
ms.prod: sql
ms.technology: machine-learning-services
ms.date: 03/30/2020
ms.topic: how-to
author: dphansen
ms.author: davidph
ms.custom: seo-lt-2019
monikerRange: '>=sql-server-2016||>=sql-server-linux-ver15||=sqlallproducts-allversions'
ms.openlocfilehash: 608ab0f58f640e058fdd57f54ca6b3c90b8a1490
ms.sourcegitcommit: 216f377451e53874718ae1645a2611cdb198808a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/28/2020
ms.locfileid: "87253753"
---
# <a name="how-to-generate-forecasts-and-predictions-using-machine-learning-models-in-sql-server"></a>Принципы формирования прогнозов с помощью моделей машинного обучения в SQL Server
 [!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]

Использование существующей модели для прогнозирования результатов в целях получения новых входных данных — основная задача в машинном обучении. В этой статье перечисляются способы формирования прогнозов в SQL Server. В этих способах используются методы внутренней обработки для быстрых прогнозов, когда скорость зависит от инкрементного сокращения зависимостей времени выполнения. Чем меньше зависимостей, тем быстрее прогнозы.

Использование инфраструктуры внутренней обработки (оценка в реальном времени или собственная оценка) сопровождается требованиями к библиотекам. Применяемые функции должны быть из библиотек Майкрософт. Код R или Python, вызывающий функции с открытым кодом или сторонние функции, в расширениях среды CLR или C++ не поддерживается.

В следующей таблице перечислены платформы оценки для прогнозирования. 

| Методика           | Интерфейс         | Требования к библиотекам | Скорость обработки |
|-----------------------|-------------------|----------------------|----------------------|
| Платформа расширяемости | [rxPredict (R)](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/rxpredict) <br/>[rx_predict (Python)](https://docs.microsoft.com/machine-learning-server/python-reference/revoscalepy/rx-predict) | Нет. Модели могут строиться на основе любой функции R или Python | Сотни миллисекунд. <br/>Загрузка среды выполнения занимает фиксированное время, в среднем от 300 до 600 миллисекунд до начала оценки каких-либо новых данных. |
| [Расширение среды CLR для оценки в реальном времени](real-time-scoring.md) | [sp_rxPredict](https://docs.microsoft.com/sql/relational-databases/system-stored-procedures/sp-rxpredict-transact-sql) в сериализованной модели | R: RevoScaleR, MicrosoftML <br/>Python: revoscalepy, microsoftml | В среднем десятки миллисекунд. |
| [Расширение C++ для собственной оценки](native-scoring-predict-transact-sql.md) | [Функция T-SQL PREDICT](https://docs.microsoft.com/sql/t-sql/queries/predict-transact-sql) в сериализованной модели | R: RevoScaleR <br/>Python: revoscalepy | В среднем менее 20 миллисекунд. | 

Отличительной особенностью является скорость обработки, а не содержание выходных данных. При использовании одних и тех же функций и входных данных результаты оценки не должны меняться в зависимости от применяемого подхода.

Модель должна быть создана с помощью поддерживаемой функции, а затем сериализована в поток необработанных байтов, сохраненный либо на диск, либо в двоичном формате в базе данных. С помощью хранимой процедуры или T-SQL можно загружать и использовать двоичную модель без дополнительной нагрузки времени выполнения языка R или Python, что приводит к ускорению выполнения при формировании прогнозных оценок по новым входным данным.

Значимость расширений среды CLR и C++ заключается в близости к самому ядру СУБД. Собственный язык ядра СУБД — C++, поэтому расширения, написанные на C++, выполняются с меньшим количеством зависимостей. Напротив, расширения среды CLR зависят от .NET Core. 

Как и следовало ожидать, эти среды выполнения оказывают влияние на поддержку платформы. Собственные расширения ядра СУБД работают везде, где поддерживается реляционная база данных — в Windows, Linux, Azure. Расширения среды CLR, которым требуется .NET Core, в настоящее время поддерживаются только в Windows.

## <a name="scoring-overview"></a>Общие сведения об оценке

_Оценка_ представляет собой двухэтапный процесс. Сначала указывается уже обученная модель для загрузки из таблицы. Затем в функцию передаются новые входные данные для формирования прогнозных значений (или _оценок_). Входные данные часто представляют собой запрос T-SQL, возвращающий либо табличные, либо отдельные строки. Можно вывести одно значение столбца, представляющее вероятность, или несколько значений, таких как доверительный интервал, ошибка и другие полезные дополнения к прогнозу.

Сделав шаг назад, можно обобщить весь процесс подготовки модели и последующего формирования оценок следующим образом.

1. Создание модели с помощью поддерживаемого алгоритма. Поддержка зависит от выбранного метода оценки.
2. Обучение модели.
3. Сериализация модели с использованием специального двоичного формата.
3. Сохранение модели в SQL Server. Обычно это означает сохранение сериализованной модели в таблице SQL Server.
4. Вызов функции или хранимой процедуры с указанием модели и входных данных в качестве параметров.

Если входные данные содержат много строк данных, то обычно быстрее вставлять прогнозные значения в таблицу в рамках процесса оценки. Наиболее распространенный сценарий формирования одной оценки: получение входных значений из формы или запроса пользователя и возврат оценки в клиентское приложение. Для улучшения производительности при формировании последовательных оценок SQL Server может кэшировать модель, чтобы ее можно было повторно загружать в память.

## <a name="compare-methods"></a>Методы сравнения

В целях сохранения целостности основных процессов ядра СУБД поддержка R и Python обеспечивается в двойной архитектуре, которая изолирует обработку языка от обработки реляционной СУБД. Начиная с SQL Server 2016, корпорация Майкрософт добавила платформу расширяемости, которая позволяет выполнять скрипты R из T-SQL. В SQL Server 2017 появилась интеграция с Python. 

Эта платформа расширяемости поддерживает любые операции, которые можно выполнять в R или Python, от самых простых функций до обучения сложных моделей машинного обучения. Однако в архитектуре с двумя процессами требуется вызов внешнего процесса R или Python для каждого вызова, независимо от сложности операции. Когда рабочая нагрузка загружает предварительно обученную модель из таблицы и сравнивает ее с данными, уже имеющимися в SQL Server, затраты на вызов внешних процессов добавляют задержку, которая в определенных обстоятельствах может оказаться неприемлемой. Например, быстрая оценка требуется для обнаружения мошенничества.

В целях увеличения скорости оценки для таких сценариев, как обнаружение мошенничества, в SQL Server добавлены встроенные библиотеки оценки в виде расширений C++ и среды CLR, которые позволяют устранить временные затраты на процессы запуска R и Python.

[**Оценка в реальном времени**](real-time-scoring.md) была первым решением для повышения производительности оценки. В ранних версиях SQL Server 2017 и последних обновлениях SQL Server 2016 оценка в реальном времени зависит от библиотек среды CLR, которые дублируют обработку R и Python управляемыми Майкрософт функциями в RevoScaleR, MicrosoftML (R), revoscalepy и microsoftml (Python). Библиотеки среды CLR вызываются с помощью хранимой процедуры **sp_rxPredict** для формирования оценок из модели любого поддерживаемого типа без вызова среды выполнения R или Python.

[**Собственная оценка**](native-scoring-predict-transact-sql.md) — это функция SQL Server 2017, реализованная как собственная библиотека C++, но только для моделей RevoScaleR и revoscalepy. Это самый быстрый и наиболее безопасный подход, но он поддерживает меньший набор функций по сравнению с другими методами.

## <a name="choose-a-scoring-method"></a>Выбор метода оценки

Зачастую выбор используемого метода оценки определяется требованиями платформы.

| Платформа и версия продукта | Методика |
|------------------------------|-------------|
| SQL Server 2017 или более поздней версии в Windows и Linux | **Собственная оценка** с помощью PREDICT T-SQL |
| SQL Server 2017 (только Windows), SQL Server 2016 R Services c пакетом обновления 1 (SP1) или последующих версий | **Оценка в реальном времени** с помощью хранимой процедуры sp\_rxPredict |

Рекомендуется использовать собственную оценку с помощью функции PREDICT. Для использования хранимой процедуры sp\_rxPredict необходимо включить интеграцию SQLCLR. Прежде чем включать этот параметр, обдумайте возможные последствия для безопасности.

## <a name="serialization-and-storage"></a>Сериализация и хранение

Чтобы использовать модель с любыми вариантами быстрой оценки, ее необходимо сохранить с помощью специального сериализованного формата, оптимизированного в контексте размера и эффективности оценки.

+ Вызовите [rxSerializeModel](https://docs.microsoft.com/r-server/r-reference/revoscaler/rxserializemodel), чтобы записать поддерживаемую модель в формате **raw**.
+ Вызовите [rxUnserializeModel](https://docs.microsoft.com/r-server/r-reference/revoscaler/rxserializemodel), чтобы воссоздать модель для использования в другом коде R или для ее просмотра.

**Использование SQL**

В коде SQL можно обучать модель с помощью [sp_execute_external_script](https://docs.microsoft.com/sql/relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql) и напрямую вставлять обученные модели в таблицу, в столбец с типом **varbinary(max)** . Простой пример см. в разделе [Создание модели прогнозирования в R](../tutorials/quickstart-r-train-score-model.md)

**Использование R**

В коде R вызывается функция [rxWriteObject](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/rxwriteobject) из пакета RevoScaleR для записи модели непосредственно в базу данных. Функция **rxWriteObject()** может извлекать объекты R из источника данных ODBC, такого как SQL Server, или записывать объекты в SQL Server. API моделируется после простого хранилища пар "ключ-значение".
  
При использовании этой функции необходимо сначала выполнить сериализацию модели с помощью [rxSerializeModel](https://docs.microsoft.com/r-server/r-reference/revoscaler/rxserializemodel). Затем присвойте аргументу *serialize* в функции **rxWriteObject** значение FALSE, чтобы избежать повторения шага сериализации.

Сериализация модели в двоичный формат полезна, но не обязательна, если оценка прогнозов выполняется с помощью среды выполнения R и Python в инфраструктуре расширяемости. Можно сохранить модель в формате необработанных байтов в файл, а затем считывать ее из этого файла в SQL Server. Это может быть полезно при перемещении или копировании моделей между средами.

## <a name="scoring-in-related-products"></a>Оценка в связанных продуктах

При использовании [отдельного сервера](../r/r-server-standalone.md) или [Microsoft Machine Learning Server](https://docs.microsoft.com/machine-learning-server/what-is-machine-learning-server) для быстрого создания прогнозов помимо хранимых процедур и функций T-SQL существуют и другие возможности. Как отдельный сервер, так и Machine Learning Server поддерживают концепцию *веб-службы* для развертывания кода. Вы можете объединить в пакет предварительно обученную модель R или Python в качестве веб-службы, которая вызывается во время выполнения для оценки новых входных данных. Дополнительные сведения вы найдете в следующих статьях:

+ [Что такое веб-службы в Machine Learning Server?](https://docs.microsoft.com/machine-learning-server/operationalize/concept-what-are-web-services)
+ [Что такое ввод в эксплуатацию?](https://docs.microsoft.com/machine-learning-server/what-is-operationalization)
+ [Развертывание модели Python в качестве веб-службы с помощью azureml-model-management-sdk](https://docs.microsoft.com/machine-learning-server/operationalize/python/quickstart-deploy-python-web-service)
+ [Публикация блока кода R или модели в реальном времени в качестве новой веб-службы](https://docs.microsoft.com/machine-learning-server/r-reference/mrsdeploy/publishservice)
+ [Пакет mrsdeploy для R](https://docs.microsoft.com/machine-learning-server/r-reference/mrsdeploy/mrsdeploy-package)


## <a name="see-also"></a>См. также раздел

+ [rxSerializeModel](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/rxserializemodel)  
+ [rxRealTimeScoring](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/rxrealtimescoring)
+ [sp-rxPredict](https://docs.microsoft.com/sql/relational-databases/system-stored-procedures/sp-rxpredict-transact-sql)
+ [PREDICT T-SQL](https://docs.microsoft.com/sql/t-sql/queries/predict-transact-sql)