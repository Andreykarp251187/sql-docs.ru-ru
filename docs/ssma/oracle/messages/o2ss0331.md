---
title: 'O2SS0331: не удалось преобразовать инструкцию FETCH (Error)'
description: Описывает, почему Помощник по миграции SQL Server (SSMA) для Oracle выдает ошибку при преобразовании инструкции FETCH в процедуре, в которой SYS_REFCURSOR возвращается в качестве параметра.
authors: nahk-ivanov
ms.service: ssma
ms.devlang: sql
ms.topic: article
ms.date: 1/22/2020
ms.author: alexiva
ms.openlocfilehash: f2585e378efa9ebf266b5b66b45a187bafac16a6
ms.sourcegitcommit: b87d36c46b39af8b929ad94ec707dee8800950f5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2020
ms.locfileid: "76762258"
---
# <a name="o2ss0331-unable-to-convert-fetch-statement-error"></a>O2SS0331: не удалось преобразовать инструкцию FETCH (Error)

В этой статье описывается, почему Помощник по миграции SQL Server (SSMA) для Oracle выдает ошибку при `FETCH ... INTO` преобразовании инструкции в процедуре, `SYS_REFCURSOR` в которой возвращается параметр.

## <a name="background"></a>Историческая справка

В Oracle `SYS_REFCURSOR` используется для передачи курсоров из хранимой процедуры и в нее.

Всякий раз, когда SSMA встречает `SYS_REFCURSOR` переменную в качестве возвращаемого типа процедуры и использует ту же переменную с `FETCH ... INTO` инструкцией, она выдает сообщение об ошибке.

## <a name="example"></a>Пример

Рассмотрим следующий пример запроса, в котором мы объявили переменную как `SYS_REFCURSOR`, которая используется в качестве возвращаемого типа процедуры.

```sql
CREATE OR REPLACE PROCEDURE p_close_refcursor
(
    emp_refcur OUT SYS_REFCURSOR
)
IS
    departmentno dept.deptno%TYPE;
BEGIN
    OPEN
        emp_refcur
    FOR
        SELECT deptno
        FROM dept;

    LOOP
        FETCH emp_refcur
        INTO departmentno;

        EXIT WHEN emp_refcur%NOTFOUND;

        DBMS_OUTPUT.PUT_LINE(departmentno);
    END LOOP;

    CLOSE emp_refcur;
END;
```

При попытке преобразовать приведенный выше код в SSMA выдается следующее сообщение об ошибке:

> O2SS0330: не удалось преобразовать инструкцию FETCH

## <a name="possible-remedies"></a>Возможные способы устранения

Устранить эту ошибку можно двумя способами.

### <a name="use-local-cursor-variable"></a>Использовать локальную переменную курсора

Первым методом является создание и использование локального курсора для выполнения всех операций, а затем передача его значения в курсор возврата перед закрытием. Для этого объявите новую переменную `SYS_REFCURSOR` типа, которая будет локальной для этой процедуры. Измените код, чтобы использовать этот локальный курсор для выполнения требуемой операции, `FETCH ... INTO` включая инструкцию. Перед закрытием локального курсора передайте значение этого локального курсора в курсор, определенный в разделе параметра процедуры (`emp_refcur` в нашем примере).

Решение для описанной выше ошибки показано в следующем коде:

```sql
CREATE OR REPLACE PROCEDURE p_close_refcursor
(
    emp_refcur OUT SYS_REFCURSOR
)
AS
    test_cursor SYS_REFCURSOR;
    departmentno dept.deptno%TYPE;
BEGIN
    OPEN
        test_cursor
    FOR
        SELECT deptno
        FROM dept;

    LOOP
        FETCH test_cursor
        INTO departmentno;

        EXIT WHEN test_cursor%NOTFOUND;

        DBMS_OUTPUT.PUT_LINE(departmentno);
    END LOOP;

    emp_refcur := test_cursor;

    CLOSE test_cursor;
END;
```

### <a name="return-result-set"></a>Возврат результирующего набора

Другим способом устранения этой ошибки является использование естественного подхода, за которым следует SQL Server — возврат результирующего набора непосредственно из хранимых процедур. Этот подход описан в статье о сообщении о преобразовании [O2SS0157](o2ss0157.md) .

## <a name="related-conversion-messages"></a>Связанные сообщения о преобразовании

* [O2SS0094: не удалось преобразовать курсор в качестве параметра](o2ss0094.md)
* [Динамическая строка O2SS0157 для открытия... ДЛЯ не преобразовано](o2ss0157.md)
* [O2SS0245: преобразование КУРСОРа в операторах возврата не поддерживается](o2ss0245.md)
* [O2SS0330: не удалось преобразовать оператор CLOSE](o2ss0330.md)
