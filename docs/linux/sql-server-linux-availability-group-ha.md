---
title: SQL Server Always On шаблоны развертывания группы доступности
ms.date: 04/17/2019
ms.prod: sql
ms.technology: linux
ms.topic: conceptual
ms.assetid: edd75f68-dc62-4479-a596-57ce8ad632e5
author: MikeRayMSFT
ms.author: mikeray
ms.reviewer: vanto
manager: jroth
ms.openlocfilehash: 69cc0c84d06c1be4065c7419b3eb35c6c30e0592
ms.sourcegitcommit: 93d1566b9fe0c092c9f0f8c84435b0eede07019f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2019
ms.locfileid: "67834228"
---
# <a name="high-availability-and-data-protection-for-availability-group-configurations"></a>Высокий уровень доступности и защиты данных для конфигураций группы доступности

[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md-linuxonly](../includes/appliesto-ss-xxxx-xxxx-xxx-md-linuxonly.md)]

В этой статье представлены поддерживаемые конфигурации развертывания для SQL Server Always On групп доступности на серверах Linux. Группа доступности поддерживает высокий уровень доступности и защиты данных. אגעמלאעטקוסךטל מעסכוזטגאםטול, автоматическая отработка отказа и прозрачный переподключения после отработки отказа обеспечивают высокий уровень доступности. Синхронизированных реплик обеспечивают защиту данных. 

В Windows Server отказоустойчивого кластера (WSFC), является обычной конфигурацией для высокого уровня доступности использует два синхронных реплик и третий сервера или общего ресурса для предоставления кворума. Файл ресурса-свидетеля проверяет конфигурацию группы доступности — состояние синхронизации и роль реплики доступности, например. Эта конфигурация гарантирует, что вторичная реплика, выбрана, так как цель перехода содержит последние данные и изменения конфигурации группы доступности. 

Кластер WSFC синхронизирует метаданные конфигурации для отработки отказа разрешения конфликтов между реплики группы доступности и общей папке следящего сервера. Если группы доступности не в кластере WSFC, экземпляры SQL Server хранить метаданные конфигурации в базе данных master.

Например, группы доступности в кластере Linux имеет `CLUSTER_TYPE = EXTERNAL`. Нет не WSFC арбитраже отработки отказа. В этом случае метаданные конфигурации управляемых и обслуживается экземпляры SQL Server. Так как в этом кластере нет следящего сервера, для хранения метаданных состояние конфигурации требуется третий экземпляр SQL Server. Все три экземпляра SQL Server обеспечивают распределенные метаданные хранилища для кластера. 

Диспетчер кластеров можно запрашивать экземпляры SQL Server в группе доступности и координации отработки отказа для обеспечения высокой доступности. В кластере Linux Pacemaker — это диспетчер кластера. 

SQL Server 2017 с накопительным пакетом обновления 1 включает высокий уровень доступности для группы доступности с `CLUSTER_TYPE = EXTERNAL` для двух синхронных реплик, а также репликой только для конфигурации. Репликой только для конфигурации могут размещаться в любом выпуске SQL Server 2017 CU1 или более поздней версии — включая SQL Server Express edition. Репликой только для конфигурации поддерживает информацию о группе доступности в базе данных master конфигурации, но не содержит пользовательских баз данных в группе доступности. 

## <a name="how-the-configuration-affects-default-resource-settings"></a>Влияние конфигурации параметров ресурсов по умолчанию

SQL Server 2017 появились `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` параметр ресурса кластера. Данный параметр гарантирует указанное число вторичных реплик записи данных транзакции в журнал, прежде чем первичная реплика фиксирует каждую транзакцию. При использовании Диспетчер внешних кластеров, этот параметр влияет на высокий уровень доступности и защиты данных. Значение по умолчанию для параметра зависит от архитектуры, во время создания ресурса кластера. Когда вы установите агент ресурсов SQL Server - `mssql-server-ha` - и создать ресурс кластера для группы доступности, диспетчер кластерных определяет доступность группе конфигурации и задает `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` соответствующим образом. 

Если это поддерживается в конфигурации, то параметр агента ресурсов `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` присваивается значение, которое обеспечивает высокий уровень доступности и защиты данных. Дополнительные сведения см. в разделе [агент ресурсов понимать SQL Server для pacemaker](#pacemakerNotify).

В следующих разделах объясняется поведение по умолчанию для ресурса кластера. 

Выберите проект группы доступности в соответствии с определенным бизнес-требованиям для высокого уровня доступности, защиты данных и чтения и масштабирования.

Следующие конфигурации описываются шаблоны проектирования для группы доступности и возможности каждого шаблона. Эти конструктивные шаблоны применяются к группам доступности с `CLUSTER_TYPE = EXTERNAL` для решения высокого уровня доступности. 

- **Три синхронных реплик**
- **Два синхронных реплик**
- **Два синхронных реплик и репликой только для конфигурации**

<a name="threeSynch"></a>

## <a name="three-synchronous-replicas"></a>Три синхронные реплики

Эта конфигурация состоит из трех синхронных реплик. По умолчанию он обеспечивает высокий уровень доступности и защиты данных. Он также может предоставить чтения и масштабирования.

![Три реплики][3]

Группы доступности с тремя синхронными репликами может предоставить чтения и масштабирования, высокого уровня доступности и защиты данных. В следующей таблице описывается поведение доступности. 

| |чтения и масштабирования|Высокий уровень доступности & </br> Защита данных | Защита данных|
|:---|---|---|---|
|`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT=`|0 |1<sup>\*</sup>|2|
|Сбой первичной реплики |Автоматический переход на другой ресурс. Новая первичная реплика доступна R / W. |Автоматический переход на другой ресурс. Новая первичная реплика доступна R / W. |Автоматический переход на другой ресурс. Новый сервер-источник не доступен для пользовательских транзакций, пока бывшей первичной восстановлена и не присоединится группу доступности в качестве дополнительного. |
|Сбой одной вторичной реплики  | Основной R / W. Без автоматической отработки отказа при сбое первичной. |Основной R / W. Будет невозможна без автоматической отработки отказа, если первичная. | Основная недоступна для пользовательских транзакций. |

<sup>\*</sup> По умолчанию

<a name="twoSynch"></a>

## <a name="two-synchronous-replicas"></a>Два синхронных реплик

Эта конфигурация обеспечивает защиту данных. Как и другие конфигурации группы доступности его можно включить чтения и масштабирования. Конфигурации двух синхронных реплик не поддерживает автоматическое высокого уровня доступности. Конфигурации с двумя репликами относится только к SQL Server 2017 RTM и больше не поддерживается в более поздней версии (CU1 и более) версии SQL Server 2017...

![Два синхронных реплик][1]

Группы доступности с двумя синхронными репликами предоставляет чтения и масштабирования и защиты данных. В следующей таблице описывается поведение доступности. 

| |чтения и масштабирования |Защита данных|
|:---|---|---|
|`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT=`|0 <sup>\*</sup>|1|
|Сбой первичной реплики | Переход на другой ресурс вручную. Возможна потеря данных. Новая первичная реплика доступна R / W.| Автоматический переход на другой ресурс. Новый сервер-источник не доступен для пользовательских транзакций, пока бывшей первичной восстановлена и не присоединится группу доступности в качестве дополнительного.|
|Сбой одной вторичной реплики  |Основной R/W, работой в незащищенном режиме к потере данных. |Первичной до вторичной было выполнено восстановление не доступен для пользовательских транзакций.|

<sup>\*</sup> По умолчанию

<a name = "configOnly"></a>

## <a name="two-synchronous-replicas-and-a-configuration-only-replica"></a>Два синхронных реплик и репликой только для конфигурации

Группа доступности с двумя (или более) синхронных реплик и репликой только для конфигурации обеспечивает защиту данных и также может обеспечить высокий уровень доступности. Следующая схема представляет этой архитектуры:

![Конфигурации только группы доступности][2]

1. Синхронная репликация данных пользователя на вторичную реплику. Он также содержит метаданные конфигурации группы доступности.
2. Синхронная репликация метаданные конфигурации группы доступности. Он не включает данные пользователя.

На схеме группы доступности первичная реплика помещает данные конфигурации вторичная реплика и репликой только для конфигурации. Вторичная реплика также получает данные пользователя. Репликой только для конфигурации не получает данные пользователя. Вторичная реплика находится в режиме доступности синхронной. Репликой только для конфигурации не содержит баз данных в группе доступности - только метаданные о группе доступности. Данные конфигурации в реплике только конфигурации синхронно фиксируется.

> [!NOTE]
> Для SQL Server 2017 CU1 появился группе availabilility с репликой только для конфигурации. Все экземпляры SQL Server в группе доступности должен быть SQL Server 2017 CU1 или более поздней версии. 

Значение по умолчанию для `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` равно 0. В следующей таблице описывается поведение доступности. 

| |Высокий уровень доступности & </br> Защита данных | Защита данных|
|:---|---|---|
|`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT=`|0 <sup>\*</sup>|1|
|Сбой первичной реплики | Автоматический переход на другой ресурс. Новая первичная реплика доступна R / W. | Автоматический переход на другой ресурс. Новый сервер-источник недоступен для пользовательских транзакций. |
|Сбоя вторичной реплики | Первичный — R/W, работой в незащищенном режиме к потере данных (если основной завершается ошибкой и не может быть восстановлена). Будет невозможна без автоматической отработки отказа, если первичная. | Основная недоступна для пользовательских транзакций. Ни одна реплика для отработки отказа, в случае сбоя основной, а также. |
|Конфигурации только сбоя реплики | Основной R / W. Будет невозможна без автоматической отработки отказа, если первичная. | Основной R / W. Будет невозможна без автоматической отработки отказа, если первичная. |
|В синхронизированном получателе + конфигурации только сбоя реплики| Основная недоступна для пользовательских транзакций. Без автоматической отработки отказа. | Основная недоступна для пользовательских транзакций. Ни одна реплика для отработки отказа, если также основной завершается ошибкой. |

<sup>\*</sup> По умолчанию

> [!NOTE]
> Экземпляр SQL Server, на котором размещена реплика только конфигурации может содержать другие базы данных. Он также может выступать только базу данных конфигурации для более чем одной группе доступности. 

## <a name="requirements"></a>Требования

- Все реплики в группе доступности с репликой только для конфигурации должны быть SQL Server 2017 с накопительным Обновлением 1 или более поздней версии.
- Любой выпуск SQL Server может размещать реплику только конфигурации, включая экспресс-выпуск SQL Server. 
- Группы доступности необходимо по крайней мере одна вторичная реплика - дополнение к первичной реплике.
- Конфигурации реплики не учитываются в подсчете максимального числа реплик для каждого экземпляра SQL Server. SQL Server standard edition поддерживают до трех реплик, SQL Server Enterprise Edition позволяет до 9.

## <a name="considerations"></a>Замечания

- Не более одной репликой только для конфигурации каждой группы доступности. 
- Репликой только для конфигурации не может быть первичной реплики.
- Невозможно изменить режим доступности реплики только конфигурации. Изменении с репликой только для конфигурации синхронной или асинхронной вторичной реплики, удаление реплики только конфигурации и добавить новую вторичную реплику с режимом требуемый уровень доступности. 
- Репликой только для конфигурации происходит синхронно с метаданные группы доступности. Нет данных пользователя. 
- Группы доступности с одну первичную реплику, реплика только одна конфигурация, но ни одна вторичная реплика не является допустимым. 
- Не удается создать группу доступности на экземпляре SQL Server Express edition. 

<a name="pacemakerNotify"></a>

## <a name="understand-sql-server-resource-agent-for-pacemaker"></a>Понять, агент ресурсов SQL Server для pacemaker

SQL Server 2017 CTP 1.4 добавлены `sequence_number` для `sys.availability_groups` разрешающее Pacemaker для идентификации насколько актуальна вторичной реплики находятся с первичной репликой. `sequence_number` — Это монотонно возрастающий BIGINT, представляющий насколько актуальна локальная реплика группы доступности. Обновления pacemaker `sequence_number` при каждом изменении конфигурации группы доступности. Примеры изменения конфигурации включают отработка отказа, реплика добавления и удаления. Номер обновляется на сервере-источнике, а затем реплицировалась на вторичные реплики. Таким образом вторичную реплику, которая имеет актуальную конфигурацию имеет тот же номер последовательности, как основной. 

Когда Pacemaker необходимость в реплику до первичной, отправляет *предварительное* уведомление, чтобы все реплики. Порядковый номер возврата реплик. Затем когда Pacemaker пытается обновить реплику до первичной, реплика обновляется, только если ее порядковый номер выше номеров всех. Если свой собственный порядковый номер не соответствует наибольший порядковый номер, реплика отклоняет операция обновления. Таким образом, до первичной реплики может быть обновлена только реплика с наибольшим значением порядкового номера, что позволяет избежать потери данных. 

Этот процесс требует хотя бы одной реплики, которые доступны для повышения роли с тем же порядковым номером прежней первичной. Наборы агент ресурсов Pacemaker `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` таким образом, что по крайней мере одна синхронизирует вторичную реплику и имеет актуальную версию может быть целевым объектом автоматическую отработку отказа по умолчанию. При каждом действии мониторинга значение `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` вычисляется (и, если нужно, обновляется). `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` Значение — «число синхронных реплик» поделенную на 2. Во время отработки отказа, агент ресурсов требует (`total number of replicas`  -  `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` реплик) реагировать на предварительное уведомление. Реплика с самым высоким `sequence_number` повышен до первичной. 

Например группа доступности с тремя синхронными репликами — одной первичной и двух синхронных вторичных реплик.

- `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` -1; (3 / 2-1, "->").

- Необходимое количество реплик, чтобы отреагировать на предварительное действие — 2; (3 - 1 = 2). 

В этом случае две реплики должно реагировать для отработки отказа будут активироваться. Успешной автоматической отработки отказа после сбоя первичной реплики и вторичной реплики должны быть актуальные и реагировать на них предварительное уведомление. Если они являются, online и синхронными, они имеют один и тот же номер последовательности. Группа доступности обеспечивает один из них. Если только одну из вторичных реплик реагирует на предварительное действие, агент ресурсов не может гарантировать получателя, который ответил имеет наивысший sequence_number, что не запускается отработка отказа.

> [!IMPORTANT]
> Нулевое значение `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` создает риск потери данных. При сбое первичной реплики агент ресурсов автоматически не запустит отработку отказа. Можно ожидать первичного сайта на восстановление, или на другой ресурс с помощью вручную `FORCE_FAILOVER_ALLOW_DATA_LOSS`.

Вы можете переопределить поведение по умолчанию и запрещает ресурс группы доступности параметр `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` автоматически.

Следующий скрипт задает `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` 0 на группу доступности с именем `<**ag1**>`. Прежде чем выполнять переход, замените `<**ag1**>` на имя группы доступности.

```bash
sudo pcs resource update <**ag1**> required_synchronized_secondaries_to_commit=0
```

Чтобы восстановить значение по умолчанию, в зависимости от конфигурации группы доступности выполните:

```bash
sudo pcs resource update <**ag1**> required_synchronized_secondaries_to_commit=
```

> [!NOTE]
> При выполнении предыдущей команды, основной временно переводится в режим вторичной, затем снова повышена. Обновление ресурса приводит все реплики, чтобы остановить и перезапустить. Новое значение для`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` задается только в том случае, после перезапуска реплик, а не мгновенно.

## <a name="see-also"></a>См. также

[Группы доступности в Linux](sql-server-linux-availability-group-overview.md)

<!--Image references-->
[1]: ./media/sql-server-linux-availability-group-ha/1-read-scale-out.png
[2]: ./media/sql-server-linux-availability-group-ha/2-configuration-only.png
[3]: ./media/sql-server-linux-availability-group-ha/3-three-replica.png
[4]: ./media/sql-server-linux-availability-group-ha/configuration-only-example.png
