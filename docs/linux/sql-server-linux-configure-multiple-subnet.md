---
title: Настройка групп доступности и экземпляров отказоустойчивого кластера с несколькими подсетями (Linux)
description: Узнайте, как настроить группы доступности Always On и экземпляры отказоустойчивого кластера в конфигурации с несколькими подсетями для SQL Server на Linux.
ms.custom: seo-lt-2019
author: MikeRayMSFT
ms.author: mikeray
ms.reviewer: vanto
ms.date: 12/01/2017
ms.topic: conceptual
ms.prod: sql
ms.technology: linux
ms.openlocfilehash: f35f1916107e8ede0e7bf7cc3df483a0c33f3355
ms.sourcegitcommit: 035ad9197cb9799852ed705432740ad52e0a256d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/31/2019
ms.locfileid: "75558616"
---
# <a name="configure-multiple-subnet-always-on-availability-groups-and-failover-cluster-instances"></a>Настройка групп доступности Always On и экземпляров отказоустойчивого кластера для конфигураций с несколькими подсетями

[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md-linuxonly](../includes/appliesto-ss-xxxx-xxxx-xxx-md-linuxonly.md)]

Если группа доступности Always On или экземпляр отказоустойчивого кластера охватывают несколько сайтов, каждый сайт обычно использует собственную сеть. Зачастую это означает, что каждый сайт использует собственную систему IP-адресации. Например, адреса сайта А начинаются с 192.168.1.*x*, а сайта Б с 192.168.2.*x*, где часть *x* IP-адреса является уникальной для конкретного сервера. Чтобы обеспечить возможность взаимодействия между серверами, необходимо реализовать определенный механизм маршрутизации на уровне сети. В таком сценарии возможны два подхода: настройка сети, связывающей две разных подсети (виртуальная локальная сеть) или настройка маршрутизации между подсетями.

## <a name="vlan-based-solution"></a>Решение на основе виртуальной локальной сети
 
**Предварительное требование**: Для решения на основе виртуальной локальной сети каждый сервер, участвующий в группе доступности Always On или экземпляре отказоустойчивого кластера, должен быть оснащен двумя сетевыми адаптерами, чтобы обеспечить необходимый уровень доступности (сетевой адаптер с двумя портами будет выступать в качестве единой точки отказа на физическом сервере).Такой подход позволяет назначать IP-адреса в собственной сети сервера, а также в виртуальной локальной сети. Это требование устанавливается в дополнение к любым другим, таким как интерфейс iSCSI, который также использует собственную сеть.

Создание IP-адресов для группы доступности Always On или экземпляра отказоустойчивого кластера осуществляется в виртуальной локальной сети. В следующем примере виртуальная локальная сеть содержит подсеть 192.168.3.*x*, поэтому для группы доступности Always On или экземпляра отказоустойчивого кластера создается IP-адрес 192.168.3.104. Поскольку группе доступности Always On или экземпляру отказоустойчивого кластера назначается один IP-адрес, дополнительная настройка не требуется.

![](./media/sql-server-linux-configure-multiple-subnet/image1.png)

## <a name="configuration-with-pacemaker"></a>Настройка с использованием Pacemaker

В среде Windows отказоустойчивый кластер Windows Server (WSFC) изначально поддерживает несколько подсетей и обрабатывает множественные IP-адреса посредством зависимости OR от IP-адреса. В среде Linux зависимость OR отсутствует, однако можно обеспечить собственную поддержку работы в нескольких подсетях с использованием Pacemaker, как показано ниже. Обратите внимание, что сделать это путем изменения ресурса с помощью обычной командной строки Pacemaker нельзя. Вам необходимо изменить базу информации о кластере. База информации о кластере представляет собой XML-файл с конфигурацией Pacemaker.

![](./media/sql-server-linux-configure-multiple-subnet/image2.png)

### <a name="update-the-cib"></a>Обновление базы информации о кластере

1.  Экспорт базы информации о кластере.

    **Red Hat Enterprise Linux (RHEL) и Ubuntu**

    ```bash
    sudo pcs cluster cib <filename>
    ```

    **SUSE Linux Enterprise Server (SLES)**

    ```bash
    sudo cibadmin -Q > <filename>
    ```

    Здесь *filename* — это имя, присваиваемое базе информации о кластере.

2.  Измените созданный файл. Найдите раздел `<resources>`. Обратите внимание на различные группы ресурсов, которые были созданы для группы доступности Always On или экземпляра отказоустойчивого кластера. Найдите ресурс, связанный с IP-адресом. Добавьте раздел `<instance attributes>` со сведениями о втором IP-адресе непосредственно перед существующим или после него, но до раздела `<operations>`. Синтаксис будет выглядеть примерно так:

    ```xml
    <instance attributes id="<NameForAttribute>" score="<Score>">
        <rule id="<RuleName>" score="INFINITY">
            <expression id="<ExpressionName>" attribute="\#uname" operation="eq" value="<NodeNameInSubnet2>" />
        </rule>
        <nvpair id="<NameForSecondIP>" name="ip" value="<IPAddress>"/>
        <nvpair id="<NameForSecondIPNetmask>" name="cidr\_netmask" value="<Netmask>"/>
    </instance attributes>
    ```
    
    Здесь *NameForAttribute* — это уникальное имя атрибута, *Score* — связанное с атрибутом значение, которое должно быть больше значения основной подсети, *RuleName* — имя правила, *ExpressionName* — имя выражения, *NodeNameInSubnet2* — это имя узла в другой подсети, *NameForSecondIP* — имя, связанное со вторым IP-адресом, *IPAddress* — IP-адрес второй подсети, *NameForSecondIPNetmask* — имя, связанное с маской сети, а *Netmask* — это маска второй подсети.
    
    Ниже приводится пример.
    
    ```xml
    <instance attributes id="Node3-2nd-IP" score="2">
        <rule id="Subnet2-IP" score="INFINITY">
            <expression id="Subnet2-Node" attribute="\#uname" operation="eq" value="Node3" />
        </rule>
        <nvpair id="IP-In-Subnet-2" name="ip" value="192.168.2.102"/>
        <nvpair id="Netmask-For-IP2" name="cidr\_netmask" value="24" />
    </instance attributes>
    ```

3.  Импорт измененной базы информации о кластере и изменение настройки Pacemaker.

    **RHEL/Ubuntu**
    
    ```bash
    sudo pcs cluster cib-push <filename>
    ```

    **SLES**
    
    ```bash
    sudo cibadmin -R -x <filename>
    ```

    Здесь *filename* — это имя файла для базы информации о кластере, содержащей измененные сведения об IP-адресах.

### <a name="check-and-verify-failover"></a>Проверка изменений и отработки отказа

1.  После успешного применения базы информации о кластере с обновленной конфигурацией проверьте связь с DNS-именем, которое связано с ресурсом IP-адреса в Pacemaker. Он должен отражать IP-адрес, связанный с подсетью, в которой в данный момент размещаются группа доступности Always On или экземпляр отказоустойчивого кластера.
2.  Выполните отработку отказа группы доступности Always On или экземпляра отказоустойчивого кластера в другой подсети.
3.  После полного подключения группы доступности Always On или экземпляра отказоустойчивого кластера проверьте связь с DNS-именем, которое связано с IP-адресом. Он должен отражать IP-адрес во второй подсети.
4.  При необходимости выполните отработку отказа группы доступности Always On или экземпляра отказоустойчивого кластера в исходной подсети.
