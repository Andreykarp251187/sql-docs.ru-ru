---
title: Настройка кластера RHEL для группы доступности SQL Server
titleSuffix: SQL Server
description: Дополнительные сведения о кластерах группы доступности при выполнении Red Hat Enterprise Linux (RHEL)
author: MikeRayMSFT
ms.author: mikeray
ms.reviewer: vanto
ms.date: 03/12/2019
ms.topic: conceptual
ms.prod: sql
ms.technology: linux
ms.assetid: b7102919-878b-4c08-a8c3-8500b7b42397
ms.openlocfilehash: 086138fc1df6245de33b348c529e56e606c3ddc9
ms.sourcegitcommit: b2464064c0566590e486a3aafae6d67ce2645cef
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/15/2019
ms.locfileid: "68027322"
---
# <a name="configure-rhel-cluster-for-sql-server-availability-group"></a>Настройка кластера RHEL для группы доступности SQL Server

[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md-linuxonly](../includes/appliesto-ss-xxxx-xxxx-xxx-md-linuxonly.md)]

В этом документе объясняется, как создать кластер группа доступности с тремя узлами для SQL Server в Red Hat Enterprise Linux. Для обеспечения высокой доступности группы доступности в Linux требует трех узлов — см. в разделе [высокий уровень доступности и защиты данных для конфигураций группы доступности](sql-server-linux-availability-group-ha.md). Кластеризации уровень основан на Red Hat Enterprise Linux (RHEL) [дополнение HA](https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/pdf/High_Availability_Add-On_Overview/Red_Hat_Enterprise_Linux-6-High_Availability_Add-On_Overview-en-US.pdf) создаются на основе [Pacemaker](https://clusterlabs.org/). 

> [!NOTE] 
> Доступ к полной документации Red Hat требуется действующая подписка. 

Дополнительные сведения о конфигурации кластера, параметры агентов ресурсов и управления, см. в статье [RHEL справочная документация по](https://access.redhat.com/documentation/Red_Hat_Enterprise_Linux/7/html/High_Availability_Add-On_Reference/index.html).

> [!NOTE] 
> SQL Server не интегрированы настолько, насколько это Pacemaker в Linux как в отказоустойчивой кластеризации Windows Server. Экземпляр SQL Server неизвестно кластера. Pacemaker обеспечивает согласование ресурсов кластера. Кроме того имя виртуальной сети для отказоустойчивого кластера Windows Server — не имеет эквивалента в Pacemaker. Доступность группы динамические административные представления (DMV), к которым запрос сведений о кластере возвращать пустые строки в кластерах Pacemaker. Чтобы создать прослушиватель для прозрачного переподключения после отработки отказа, вручную Зарегистрируйте имя прослушивателя в DNS с помощью IP-адрес, используемый для создания виртуальный IP-адрес. 

Следующие разделы содержат шаги по настройке кластера Pacemaker и добавить группу доступности в качестве ресурса в кластере для обеспечения высокой доступности.

## <a name="roadmap"></a>Стратегия развития

Шаги по созданию группы доступности на серверах Linux для обеспечения высокой доступности, отличаются от действия, указанные на отказоустойчивый кластер Windows Server. Ниже перечислены основные действия. 

1. [Настройка SQL Server на узлах кластера](sql-server-linux-setup.md).

2. [Создание группы доступности](sql-server-linux-availability-group-configure-ha.md). 

3. Настройте диспетчер кластерных ресурсов, таких как Pacemaker. Эти инструкции приведены в этом документе.
   
   Способ настройки диспетчер ресурсов кластера зависит от конкретного дистрибутива Linux. 

   >[!IMPORTANT]
   >Рабочих средах требуется агент ограждения, например STONITH для обеспечения высокой доступности. Демонстрации в данной документации не имеют агентов ограждения. Демонстрации предназначены для тестирования и проверки только. 
   
   >Кластер Linux использует ограждения для возврата кластера в известное состояние. Способ настройки ограждения зависит от распределения и среды. В настоящее время ограждения недоступна в некоторых облачных средах. Дополнительные сведения см. в разделе [политики поддержки для высокой доступности кластеров RHEL - платформ виртуализации](https://access.redhat.com/articles/29440).

5. [Добавить в группу доступности в качестве ресурса кластера](sql-server-linux-availability-group-cluster-rhel.md#create-availability-group-resource).  

## <a name="configure-high-availability-for-rhel"></a>Настройка высокого уровня доступности для RHEL

Чтобы настроить высокий уровень доступности для RHEL, включения подписки высокого уровня доступности, а затем настройте Pacemaker.

### <a name="enable-the-high-availability-subscription-for-rhel"></a>Активация подписки высокого уровня доступности для RHEL

Каждый узел кластера должен иметь соответствующая подписка для RHEL и высокий уровень доступности, добавьте. Ознакомьтесь с требованиями в [Установка высокого уровня доступности кластера пакетов в Red Hat Enterprise Linux](https://access.redhat.com/solutions/45930). Выполните следующие действия для настройки подписки и репозитории.

1. Зарегистрируйте систему.

   ```bash
   sudo subscription-manager register
   ```

   Укажите имя пользователя и пароль.   

1. Получение списка доступных пулов для регистрации.

   ```bash
   sudo subscription-manager list --available
   ```

   Из списка доступных пулов запишите идентификатор пула подписки высокого уровня доступности.

1. Обновите следующий сценарий. Замените `<pool id>` с Идентификатором пула для обеспечения высокой доступности из предыдущего шага. Выполните скрипт, чтобы присоединить подписку.

   ```bash
   sudo subscription-manager attach --pool=<pool id>
   ```

1. Включение репозитория.

   ```bash
   sudo subscription-manager repos --enable=rhel-ha-for-rhel-7-server-rpms
   ```

Дополнительные сведения см. в разделе [высокий уровень доступности кластера Pacemaker - Open Source,](https://clusterlabs.org/pacemaker/). 

После настройки подписки, выполните следующие действия, чтобы настроить Pacemaker.

### <a name="configure-pacemaker"></a>Настройка Pacemaker

После регистрации подписки, выполните следующие действия, чтобы настроить Pacemaker.
   
[!INCLUDE [RHEL-Configure-Pacemaker](../includes/ss-linux-cluster-pacemaker-configure-rhel.md)]

После настройки Pacemaker использовать `pcs` для взаимодействия с кластером. Выполните все команды на один узел из кластера. 

## <a name="configure-fencing-stonith"></a>Настройка ограждения (STONITH)

Поставщики кластера pacemaker требуются STONITH включения и ограждения устройства, настроенные для настройки кластера, поддерживаемых. STONITH расшифровывается как «запустить другой узел в заголовке». Когда диспетчер кластерных ресурсов не может определить состояние узла или ресурса на узле, ограждения снова переводит кластер в известное состояние.

Ресурс уровня ограждения обеспечивается наличие повреждений данных в случае сбоя, настроив ресурса. Например, можно использовать ограждения уровня ресурсов для пометки диска на узле, как устаревшие, когда канал связи выходит из строя. 

Узел уровня ограждения гарантирует, что узел не все ресурсы. Это делается путем сброса параметров узла. Pacemaker поддерживает разнообразные полезные ограждения устройств. Примеры включают в себя источник бесперебойного питания питания или управления интерфейс карты для серверов.

Сведения о STONITH и ограждения см. в разделе со следующими статьями:

* [Pacemaker кластеры с нуля](https://clusterlabs.org/pacemaker/doc/en-US/Pacemaker/1.1/html/Clusters_from_Scratch/index.html)
* [Ограждения и STONITH](https://clusterlabs.org/doc/crm_fencing.html)
* [Red Hat надстройку высокого уровня доступности с Pacemaker: Ограждения](https://access.redhat.com/documentation/Red_Hat_Enterprise_Linux/6/html/Configuring_the_Red_Hat_High_Availability_Add-On_with_Pacemaker/ch-fencing-HAAR.html)

Поскольку уровень узла ограждения конфигурации во многом зависит от среды, отключите его в этом руководстве (его можно настроить позже). Следующий скрипт отключает ограждения уровня узла:

```bash
sudo pcs property set stonith-enabled=false
```
  
>[!IMPORTANT]
>Отключение STONITH — только для целей тестирования. Если вы планируете использовать Pacemaker в рабочей среде, следует планировать реализацию STONITH в зависимости от среды и оставьте флажок. RHEL не поддерживает агентов ограждения для облачных сред (в том числе Azure) или Hyper-V. Следовательно кластера поставщика не обеспечивает поддержку для запуска рабочих кластеров в этих средах. Мы работаем над решением этот пробел, которая будет доступна в будущих выпусках.

## <a name="set-cluster-property-cluster-recheck-interval"></a>Установка свойства кластера кластера перепроверка интервала

`cluster-recheck-interval` Указывает интервал опроса, по которому проверяет кластера, для изменения параметров ресурсов, ограничения или другие параметры кластера. Если реплика выходит из строя, кластер пытается выполнить перезапуск реплики с интервалом, привязанного с `failure-timeout` значение и `cluster-recheck-interval` значение. Например если `failure-timeout` составляет 60 секунд и `cluster-recheck-interval` имеет значение 120 секунд, производится попытка перезагрузки с интервалом, превышает 60 секунд, но менее 120 секунд. Рекомендуется задать время ожидания сбоя 60s и кластера перепроверка-значение интервала больше 60 секунд. Установка кластера перепроверка интервала небольшое значение не рекомендуется.

Чтобы обновить значение свойства для `2 minutes` запуска:

```bash
sudo pcs property set cluster-recheck-interval=2min
```

> [!IMPORTANT] 
> Всех дистрибутивов (включая RHEL 7.3 и 7.4), использующих последние доступные Pacemaker пакет 1.1.18-11.el7 приводит изменение поведения для параметра start сбоя — Неустранимая кластера в случае имеет значение false. Это изменение затрагивает рабочий процесс отработки отказа. Если первичная реплика, произошел сбой, ожидается кластера отработки отказа в одной из доступных вторичных реплик. Вместо этого пользователи заметят, что кластер сисадмин пытается запустить сбой первичной реплики. Если этой основной никогда не подключается к сети (из-за постоянных сбой), никогда не перехода кластера на другой доступную вторичную реплику. Из-за этого изменения рекомендованные конфигурации для задания начала сбоя — Неустранимая больше не является допустимым и должен вернуть значение по умолчанию `true`. Кроме того, ресурс группы Доступности должен быть обновлен для включения `failover-timeout` свойство. 

Чтобы обновить значение свойства для `true` запуска:

```bash
sudo pcs property set start-failure-is-fatal=true
```

Чтобы обновить `ag_cluster` свойство ресурса `failure-timeout` для `60s` запуска:

```bash
pcs resource update ag_cluster meta failure-timeout=60s
```


Сведения о свойствах кластера Pacemaker, см. в разделе [свойства кластеров Pacemaker](https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/High_Availability_Add-On_Reference/ch-clusteropts-HAAR.html).

## <a name="create-a-sql-server-login-for-pacemaker"></a>Создание имени входа SQL Server для Pacemaker

[!INCLUDE [SQL-Create-SQL-Login](../includes/ss-linux-cluster-pacemaker-create-login.md)]

## <a name="create-availability-group-resource"></a>Создайте ресурс группы доступности

Чтобы создать ресурс группы доступности, используйте `pcs resource create` команды и задать свойства ресурса. Следующая команда создает `ocf:mssql:ag` тип ресурса для группы доступности с именем, ведущий/ведомый `ag1`.

```bash
sudo pcs resource create ag_cluster ocf:mssql:ag ag_name=ag1 meta failure-timeout=60s master notify=true
``` 

[!INCLUDE [required-synchronized-secondaries-default](../includes/ss-linux-cluster-required-synchronized-secondaries-default.md)]

<a name="createIP"></a>

## <a name="create-virtual-ip-resource"></a>Создайте виртуальный IP-адрес

Чтобы создать виртуальный ресурс IP-адреса, выполните следующую команду на одном узле. Используйте доступные статические IP-адресом из сети. Замените IP-адреса между `<10.128.16.240>` допустимый IP-адрес.

```bash
sudo pcs resource create virtualip ocf:heartbeat:IPaddr2 ip=<10.128.16.240>
```

Отсутствует имя виртуального сервера, эквивалент в Pacemaker. Чтобы использовать строку подключения, указывающую на имя сервера строку вместо IP-адресом, зарегистрируйте виртуальный IP-адрес ресурса и имя нужного виртуального сервера в DNS. Для конфигураций аварийного восстановления Зарегистрируйте имя нужного виртуального сервера и IP-адрес с DNS-серверов на основном сервере и сайт аварийного восстановления.

## <a name="add-colocation-constraint"></a>Добавить ограничение среды для совместной работы

Практически каждое решение в кластере Pacemaker, такие как выбор, где должны запускаться ресурс, выполняется путем сравнения оценок. Показатели вычисляются для каждого ресурса. Диспетчер кластерных ресурсов выбирает узел с наивысшей оценкой для конкретного ресурса. Если узел имеет отрицательной оценки для ресурса, ресурс нельзя запустить на этом узле.

В кластере pacemaker можно управлять решения кластера с ограничениями. Ограничения имеют оценку. Если ограничение имеет показатель ниже, чем `INFINITY`, Pacemaker считает его в качестве рекомендации. Показатель `INFINITY` является обязательным.

Чтобы убедиться в том, что первичная реплика и ресурсы виртуального IP-адреса запускается на одном узле, определите ограничение совместного размещения с оценкой бесконечность. Чтобы добавить ограничение среды для совместной работы, выполните следующую команду на одном узле.

```bash
sudo pcs constraint colocation add virtualip ag_cluster-master INFINITY with-rsc-role=Master
```

## <a name="add-ordering-constraint"></a>Добавление ограничения упорядочивания

Ограничения совместного размещения имеет неявное ограничение упорядочивания. Он перемещает виртуальный IP-адрес до перемещения ресурса группы доступности. По умолчанию является последовательность событий:

1. Пользователь выполняет `pcs resource move` источник группы доступности с узла 1 на узел node2.
1. Виртуальный IP-адрес останавливается на узле 1.
1. Виртуальный IP-адрес запускается на узле 2.
  
   >[!NOTE]
   >На этом этапе IP-адрес временно точки к узлу 2 а узел 2 — по прежнему до отработки отказа вторичной. 
   
1. Группу доступности основной на узле 1 будет понижен до вторичной.
1. Группы доступности вторичной базы данных на узел 2 повышается до основного. 

Чтобы предотвратить временно, указывающие на узел с дополнительным до отработки отказа IP-адрес, добавьте ограничения упорядочивания. 

Чтобы добавить ограничения упорядочивания, выполните следующую команду на одном узле:

```bash
sudo pcs constraint order promote ag_cluster-master then start virtualip
```

>[!IMPORTANT]
>После настройки кластера и добавлению группы доступности в качестве ресурса кластера, Transact-SQL нельзя использовать для отработки отказа ресурсов этой группы доступности. Ресурсы кластера SQL Server в Linux не связаны тесно как с операционной системой, как они находятся на кластер отработки отказа Windows Server (WSFC). Службы SQL Server не учитывает наличие кластера. Все согласование осуществляется с помощью средства управления кластером. В RHEL или Ubuntu используйте `pcs` и используется SLES `crm` средства. 

Вручную переключить группу доступности с `pcs`. Не инициировать отработку отказа с помощью Transact-SQL. Инструкции см. в разделе [отработки отказа](sql-server-linux-availability-group-failover-ha.md#failover).

## <a name="next-steps"></a>Следующие шаги

[Работать с высоким уровнем ДОСТУПНОСТИ группы доступности](sql-server-linux-availability-group-failover-ha.md)
