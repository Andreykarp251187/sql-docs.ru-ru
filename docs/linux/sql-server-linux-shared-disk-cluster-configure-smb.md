---
title: Настройка отказоустойчивого кластера экземпляра хранилища SMB - SQL Server в Linux
description: ''
author: MikeRayMSFT
ms.author: mikeray
ms.reviewer: vanto
ms.date: 08/28/2017
ms.topic: conceptual
ms.prod: sql
ms.technology: linux
ms.openlocfilehash: e93b7fac2f75758a0a95a4053ee0a989e410c70e
ms.sourcegitcommit: b2464064c0566590e486a3aafae6d67ce2645cef
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/15/2019
ms.locfileid: "68032321"
---
# <a name="configure-failover-cluster-instance---smb---sql-server-on-linux"></a>Настроить экземпляр отказоустойчивого кластера — SMB — SQL Server в Linux

[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md-linuxonly](../includes/appliesto-ss-xxxx-xxxx-xxx-md-linuxonly.md)]

В этой статье объясняется, как настроить хранилище SMB для экземпляра отказоустойчивого кластера (FCI) в Linux. 
 
В мире отличных от Windows часто называют для совместного использования в качестве Common Internet File System (CIFS) и реализуются с помощью Samba SMB. В мире Windows доступ к общей папке SMB выполняется таким образом: \\ИМЯ_СЕРВЕРА\ИМЯ_ОБЩЕГО_РЕСУРСА. Для установки SQL Server под управлением Linux необходимо подключить общий ресурс SMB как папка.

## <a name="important-source-and-server-information"></a>Важные сведения об источнике и сервере

Ниже приведены некоторые советы и заметки о успешно с помощью протокола SMB.
- Общий ресурс SMB может быть на Windows, Linux, а также с устройства как долго, так как он использует протокол SMB 3.0 или более поздней версии. Дополнительные сведения о Samba и SMB 3.0, см. в разделе [SMB 3.0](https://wiki.samba.org/index.php/Samba3/SMB2#SMB_3.0) ли реализация Samba совместимый с SMB 3.0.
- Общий ресурс SMB должна быть высокодоступной.
- Необходимо выполнить настройку безопасности должным образом в общей папке SMB. Ниже приведен пример из /etc/samba/smb.conf, где SQLData1 — имя общего ресурса.

![05-smbsource][1]

## <a name="instructions"></a>Instructions

1. Выберите один из серверов, которые будут участвовать в конфигурации отказоустойчивого Кластера. Неважно, какой из них.
   
1. Получите сведения о пользователе mssql.
   
   ```bash
    sudo id mssql
   ```
   
   Обратите внимание на то, uid, gid и групп. 
   
1. Выполните процедуру `sudo smbclient -L //NameOrIP/ShareName -U User`.
   
   \<NameOrIP > — это DNS-имя или IP-адрес сервера, где размещается общий ресурс SMB.
   
   \<ShareName > — имя общей папки SMB. 
   
1. Для системных баз данных или все данные, хранящиеся в расположении данных по умолчанию выполните следующие действия. В противном случае перейдите к шагу 5. 
   
   1. Убедитесь, что SQL Server остановлена на сервере, которым вы работаете.
      ```bash
      sudo systemctl stop mssql-server
      sudo systemctl status mssql-server
      ```
      
   1. Переключиться в режим полностью стать суперпользователем. Вы не получите любое подтверждение при успешном выполнении.
      
      ```bash
      sudo -i
      ```
      
   1. Ключ пользователя mssql. Вы не получите любое подтверждение при успешном выполнении.
      
      ```bash
      su mssql
      ```
      
   1. Создайте временный каталог для хранения данных SQL Server и файлов журнала. Вы не получите любое подтверждение при успешном выполнении.
      
      ```bash
      mkdir <TempDir>
      ```
      
      \<TempDir > — это имя папки. В следующем примере создается папка с именем /var/opt/mssql/tmp.
      
      ```bash
      mkdir /var/opt/mssql/tmp
      ```
      
   1. Скопируйте файлы данных и журналов SQL Server во временный каталог. Вы не получите любое подтверждение при успешном выполнении.
      
      ```bash
      cp /var/opt/mssql/data/* <TempDir>
      ```
      
      \<TempDir > — это имя папки, из предыдущего шага.
      
   1. Убедитесь, что файлы находятся в каталоге.
      
      ```bash
      ls <TempDir>
      ```
      
      \<TempDir > — это имя папки из шагу d.
      
   1. Удалите файлы из существующего каталога данных SQL Server. Вы не получите любое подтверждение при успешном выполнении.
      
      ```bash
      rm - f /var/opt/mssql/data/*
      ```
      
   1. Убедитесь, что файлы были удалены. 
      
      ```bash
      ls /var/opt/mssql/data
      ```
      
   1. Наберите exit, чтобы вернуться к привилегированного пользователя.
      
   1. Подключите общий ресурс SMB в папке данных SQL Server. Вы не получите любое подтверждение при успешном выполнении. В этом примере показан синтаксис для подключения к общей папке SMB 3.0, под управлением Windows Server.
      
      ```bash
      Mount -t cifs //<ServerName>/<ShareName> /var/opt/mssql/data -o vers=3.0,username=<UserName>,password=<Password>,domain=<domain>,uid=<mssqlUID>,gid=<mssqlGID>,file_mode=0777,dir_mode=0777
      ```
      
      \<Имя_сервера > — имя сервера с общей папкой SMB
      
      \<ShareName > — имя общей папки
      
      \<Имя пользователя > — имя пользователя для доступа к общей папке
      
      \<Пароль > пароль для пользователя
      
      \<домен > — имя Active Directory
      
      \<mssqlUID > — это уникальный идентификатор пользователя mssql 
      
      \<mssqlGID > является GID пользователя mssql
      
   1. Проверьте, что подключение успешно, выполнив подключения без ключей.
      
      ```bash
      mount
      ```
      
   1. Переключитесь на пользователя mssql. Вы не получите любое подтверждение при успешном выполнении.
      
      ```bash
      su mssql
      ```
      
   1. Скопируйте файлы из /var/opt/mssql/data во временный каталог. Вы не получите любое подтверждение при успешном выполнении.
      
      ```bash
      cp /var/opt/mssql/tmp/* /var/opt/mssql/data
      ```
      
   1. Убедитесь, что файлы существуют.
      
      ```bash
      ls /var/opt/mssql/data
      ```
      
   1. Вход и выход, не является mssql 
      
   1. Вход и выход, не является корневой
   
   1. Запустите SQL Server. Если все, что был скопирован правильно, и обеспечения безопасности, SQL Server должна отобразиться как к работе.
      
      ```bash
      sudo systemctl start mssql-server
      sudo systemctl status mssql-server
      ```
      
   1. Для дальнейшего тестирования создайте базу данных убедитесь, что разрешения являются нормально. В следующем примере используется Transact-SQL; можно использовать SSMS.
      
      ![10_testcreatedb][2] 
      
   1. Остановка SQL Server и убедитесь, что завершение работы. Если планируется добавление или тестирование другие диски, не завершить работу SQL Server до тех добавляются и протестированы.
      
      ```bash
      sudo systemctl stop mssql-server
      sudo systemctl status mssql-server
      ```
      
   1. Только в том случае, если завершено, отключите общую папку. В противном случае отключение после завершения тестирования: Добавление дополнительные диски.
      
      ```bash
      sudo umount //<IPAddressorServerName>/<ShareName /<FolderMountedIn>
      ```
      
      \<IPAddressOrServerName > — это IP-адрес или имя узла SMB
      
      \<ShareName > — имя общей папки
      
      \<FolderMountedIn > — это имя папки, где подключен SMB
      
5. Для таких вещей, кроме системных баз данных, таких как пользовательских баз данных или резервных копий выполните следующие действия. Если только с использованием расположения по умолчанию, перейдите к шагу 14.
   
   1. Переключатель, чтобы стать суперпользователем. Вы не получите любое подтверждение при успешном выполнении.
      
      ```bash
      sudo -i
      ```
      
   1. Создайте папку, которая будет использоваться SQL Server. 
      
      ```bash
      mkdir <FolderName>
      ```
      
      \<Имя папки > — это имя папки. Полный путь к папке должен быть указан не в надлежащем расположении if. В следующем примере создается папка с именем /var/opt/mssql/userdata.
      
      ```bash
      mkdir /var/opt/mssql/userdata
      ```
      
   1. Подключите общий ресурс SMB в папке данных SQL Server. Вы не получите любое подтверждение при успешном выполнении. В этом примере показан синтаксис для подключения к общей основе Samba SMB 3.0.
      
      ```bash
      Mount -t cifs //<ServerName>/<ShareName> <FolderName> -o vers=3.0,username=<UserName>,password=<Password>,uid=<mssqlUID>,gid=<mssqlGID>,file_mode=0777,dir_mode=0777
      ```
      
      \<Имя_сервера > — имя сервера с общей папкой SMB
      
      \<ShareName > — имя общей папки
      
      \<Имя папки > — имя папки, созданной на предыдущем шаге  
      
      \<Имя пользователя > — имя пользователя для доступа к общей папке
      
      \<Пароль > пароль для пользователя
      
      \<mssqlUID > — это уникальный идентификатор пользователя mssql
      
      \<mssqlGID > является GID пользователя mssql.
      
   1. Проверьте, что подключение успешно, выполнив подключения без ключей.
   
   1. Наберите exit больше не суперпользователь.
   
   1. Чтобы проверить, создайте базу данных в этой папке. В следующем примере использует sqlcmd для создания базы данных, переключить контекст на него, проверьте файлы существуют на уровне операционной системы, а затем удаляет во временную папку. Можно использовать SSMS.
   
   1. Отключить общую папку 
      
      ```bash
      sudo umount //<IPAddressorServerName>/<ShareName> /<FolderMountedIn>
      ```
      
      \<IPAddressOrServerName > — это IP-адрес или имя узла SMB
      
      \<ShareName > — имя общей папки
      
      \<FolderMountedIn > — это имя папки, где подключения SMB.
   
1. Повторите эти действия на другие узлы.

Теперь вы готовы к настройке экземпляра отказоустойчивого Кластера.

## <a name="next-steps"></a>Следующие шаги

[Настроить экземпляр отказоустойчивого кластера — SQL Server в Linux](sql-server-linux-shared-disk-cluster-configure.md)

<!--Image references-->
[1]: ./media/sql-server-linux-shared-disk-cluster-configure-smb/05-smbsource.png 
[2]: ./media/sql-server-linux-shared-disk-cluster-configure-smb/10-testcreatedb.png 
