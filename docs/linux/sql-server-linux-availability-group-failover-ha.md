---
title: Управление отработка отказа группы доступности — SQL Server в Linux
description: ''
author: MikeRayMSFT
ms.author: mikeray
ms.reviewer: vanto
manager: jroth
ms.date: 03/01/2018
ms.topic: conceptual
ms.prod: sql
ms.technology: linux
ms.assetid: ''
ms.openlocfilehash: f758b70e0b518418a95a79ebb4e9b7322f33f31f
ms.sourcegitcommit: 93d1566b9fe0c092c9f0f8c84435b0eede07019f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2019
ms.locfileid: "67834251"
---
# <a name="always-on-availability-group-failover-on-linux"></a>Отработка отказа группы доступности AlwaysOn в Linux

[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md-linuxonly](../includes/appliesto-ss-xxxx-xxxx-xxx-md-linuxonly.md)]

В контексте группы доступности (AG) роли первичной и вторичной реплик доступности обычно являются взаимозаменяемыми в процессе, при сбое. Существуют три формы перехода на другой ресурс: автоматический переход на другой ресурс (без потери данных), запланированный переход на другой ресурс вручную (без потери данных) и принудительный переход на другой ресурс вручную (с возможной потерей данных), обычно именуемый *принудительным переходом на другой ресурс*. Все данные сохраняются в автоматическом и запланированном Ручная отработка отказа. Группа Доступности выполняет отработку отказа на уровне реплики доступности. То есть группа Доступности выполняет отработку отказа одного из ее вторичных реплик (текущей цели отработки отказа). 

Общие сведения об отработке отказа, см. в разделе [отработки отказа и режимы отработки отказа](../database-engine/availability-groups/windows/failover-and-failover-modes-always-on-availability-groups.md).

## <a name="failover"></a>На другой ресурс вручную

Используйте средства управления кластером для отработки отказа менеджерами внешней кластерной группы Доступности. Например, если решение использует Pacemaker для управления кластером Linux, используйте `pcs` для выполнения таких операций на RHEL или Ubuntu. На SLES с помощью `crm`. 

> [!IMPORTANT]
> В обычных условиях не выполнить отработку отказа с помощью Transact-SQL или SQL Server средств управления, как SSMS или PowerShell. Когда `CLUSTER_TYPE = EXTERNAL`, единственное допустимое значение для `FAILOVER_MODE` является `EXTERNAL`. С этими параметрами все действия отработки отказа вручную или автоматически, выполняются диспетчером внешних кластеров. Инструкции по принудительной отработки отказа с возможной потерей данных, см. в разделе [Принудительная отработка отказа](#forceFailover).

### <a name="a-namemanualfailovermanual-failover-steps"></a><a name="manualFailover">Действия на другой ресурс вручную

Для отработки отказа вторичная реплика, которая станет первичной реплики должны быть синхронными. Если вторичная реплика является асинхронной, [Смена режима доступности](../database-engine/availability-groups/windows/change-the-availability-mode-of-an-availability-replica-sql-server.md).

На другой ресурс вручную в два этапа.

   Во-первых, [вручную выполнить отработку отказа для каждого отдельного Перемещение ресурса группы Доступности](#manualMove) с узла кластера, которому принадлежит ресурсы на новый узел.

   Кластер при сбое ресурс группы Доступности и добавляет ограничение расположения. Это ограничение настраивает ресурс для запуска на новом узле. Удалите это ограничение, чтобы успешно выполнять отработку отказа в будущем.

   Во-вторых, [удаления ограничения расположения](#removeLocConstraint).

#### <a name="a-namemanualmovestep-1-manually-fail-over-by-moving-availability-group-resource"></a><a name="manualMove">Шаг 1. Вручную выполнить отработку отказа для каждого отдельного Перемещение ресурса группы доступности

Ручное переключение ресурс группы Доступности с именем *ag_cluster* к узлу кластера с именем *nodeName2*, выполните соответствующую команду для распространения:

- **Пример RHEL и Ubuntu**

   ```bash
   sudo pcs resource move ag_cluster-master nodeName2 --master
   ```

- **Пример SLES**

   ```bash
   crm resource migrate ag_cluster nodeName2
   ```

>[!IMPORTANT]
>После отработки отказа ресурса вручную, необходимо удалить ограничение расположения, в который добавляется автоматически.

#### <a name="a-nameremovelocconstraint-step-2-remove-the-location-constraint"></a><a name="removeLocConstraint"> Шаг 2. Удаление ограничения расположения

Во время перехода на другой ресурс вручную `pcs` команда `move` или `crm` команда `migrate` добавляется ограничение расположения для ресурсов, которые размещаются на новом целевом узле. Чтобы увидеть новое ограничение, после перемещения ресурса вручную выполните следующую команду:

- **Пример RHEL и Ubuntu**

   ```bash
   sudo pcs constraint list --full
   ```

- **Пример SLES**

   ```bash
   crm config show
   ```

Пример ограничения, которое создается из-за другой ресурс вручную. 
 `Enabled on: Node1 (score:INFINITY) (role: Master) (id:cli-prefer-ag_cluster-master)`

- **Пример RHEL и Ubuntu**

   где `cli-prefer-ag_cluster-master` — это код ограничения, которое необходимо удалить. `sudo pcs constraint list --full` возвращает этот код. 
   
   ```bash
   sudo pcs constraint remove cli-prefer-ag_cluster-master  
   ```
   
- **Пример SLES**

   В следующей команде `cli-prefer-ms-ag_cluster` идентификатор ограничения. `crm config show` возвращает этот код. 
   
   ```bash
   crm configure
   delete cli-prefer-ms-ag_cluster 
   commit
   ```

>[!NOTE]
>При автоматическом переходе на другой ресурс ограничение расположения не добавляется, поэтому очистка не требуется. 

Дополнительные сведения см. в следующих разделах:
- [Chapter 7. Managing Cluster Resources](https://access.redhat.com/documentation/Red_Hat_Enterprise_Linux/6/html/Configuring_the_Red_Hat_High_Availability_Add-On_with_Pacemaker/ch-manageresource-HAAR.html) (Глава 7. Управление ресурсами кластера)
- [Pacemaker — перемещение ресурсов вручную](https://clusterlabs.org/pacemaker/doc/en-US/Pacemaker/1.1/html/Clusters_from_Scratch/_manually_moving_resources_around_the_cluster.html)
 [руководство по администрированию SLES - ресурсы](https://www.suse.com/documentation/sle-ha-12/singlehtml/book_sleha/book_sleha.html#sec.ha.troubleshooting.resource) 
 
## <a name="forceFailover"></a> Принудительная отработка отказа 

Принудительная отработка отказа предназначенная исключительно для аварийного восстановления. В этом случае нельзя отработку отказа можно с помощью средства управления кластером, так как основной ЦОД не работает. Если выполняется принудительный переход на несинхронизированную вторичную реплику, возможна потеря данных. Принудительная отработка отказа только в том случае, если немедленное восстановление доступа к группе Доступности и допускается риск потери данных.

Если нельзя использовать средства управления кластером для взаимодействия с кластером — например, если кластер не отвечает из-за аварии в основном центре обработки данных, возможно, выполнить принудительную отработку отказа для обхода диспетчера внешних кластеров. Эту процедуру для выполнения обычных операций не рекомендуется, поскольку существует риск потери данных. Применяется, если не удается выполнить действие отработки отказа средства управления кластером. С функциональной точки зрения Эта процедура аналогична [выполнение принудительной отработки отказа вручную](../database-engine/availability-groups/windows/perform-a-forced-manual-failover-of-an-availability-group-sql-server.md) на группы Доступности в Windows.
 
Этот процесс для принудительной отработки отказа относится только к SQL Server в Linux.

1. Убедитесь, что ресурс группы Доступности не находится под управлением кластера больше. 

      - Установка ресурса в неуправляемых режим на целевом узле кластера. Эта команда сообщает агент ресурсов для остановки мониторинга ресурсов и управления. Пример: 
      
      ```bash
      sudo pcs resource unmanage <resourceName>
      ```

      - Если не удалось установить режим ресурсов неуправляемых режим, удалите ресурс. Пример:

      ```bash
      sudo pcs resource delete <resourceName>
      ```

      >[!NOTE]
      >При удалении ресурса также удаляет все связанные ограничения. 

1. На экземпляре SQL Server, на котором размещена вторичная реплика, задайте для переменной контекста сеанса `external_cluster`.

   ```Transact-SQL
   EXEC sp_set_session_context @key = N'external_cluster', @value = N'yes';
   ```

1. Отработка отказа группы Доступности с помощью Transact-SQL. В следующем примере замените `<MyAg>` на имя вашей группы Доступности. Подключитесь к экземпляру SQL Server, на котором размещена целевая вторичная реплика и выполните следующую команду:

   ```Transact-SQL
   ALTER AVAILABILITY GROUP <MyAg> FORCE_FAILOVER_ALLOW_DATA_LOSS;
   ```

1.  После принудительной отработки отказа Переведите группу Доступности в работоспособное состояние до перезапуска мониторинг ресурсов кластера и управления или повторного создания ресурс группы Доступности. Просмотрите [основные задачи после принудительной отработки отказа](../database-engine/availability-groups/windows/perform-a-forced-manual-failover-of-an-availability-group-sql-server.md#FollowUp).

1.  Либо перезапустить мониторинг ресурсов кластера и управления:

   Чтобы перезапустить мониторинг ресурсов кластера и управления, выполните следующую команду:

   ```bash
   sudo pcs resource manage <resourceName>
   sudo pcs resource cleanup <resourceName>
   ```

   Если вы удалили ресурс кластера, создайте ее. Чтобы повторно создать ресурс кластера, следуйте инструкциям в [создать ресурс группы доступности](sql-server-linux-availability-group-cluster-rhel.md#create-availability-group-resource).

>[!Important]
>Не используйте описанные выше шаги для аварийного восстановления, так как существует риск потери данных. Вместо этого измените асинхронной реплики на синхронный, а также инструкции для [на другой ресурс вручную обычный](#manualFailover).

## <a name="database-level-monitoring-and-failover-trigger"></a>Триггер мониторинг и отработка отказа уровня базы данных

Для `CLUSTER_TYPE=EXTERNAL`, триггерная семантика отработки отказа отличаются по сравнению с WSFC. Если группы Доступности на экземпляре SQL Server в кластере WSFC, переход из `ONLINE` состояние базы данных приводит работоспособности группы Доступности для сообщения ошибки. В ответ диспетчер кластеров инициирует действие отработки отказа. В Linux экземпляр SQL Server не могут взаимодействовать с кластером. Мониторинг работоспособности базы данных выполняется *подобный*. Если пользователь выбрал в для мониторинга отработки отказа уровня базы данных и отработки отказа (путем установки параметра `DB_FAILOVER=ON` при создании группы Доступности), кластер будет проверять, является ли состояние базы данных `ONLINE` каждый раз при его запуске действие мониторинга. Кластер запрашивает состояние в `sys.databases`. Для любого состояния, отличается от `ONLINE`, он активирует отработку отказа, автоматически (при автоматической отработки отказа условий). Фактическое время отработки отказа зависит от частоты действие мониторинга, а также состояние базы данных, обновляемого в представлении каталога sys.databases.

Автоматическая отработка отказа требуется по крайней мере одна реплика.

## <a name="next-steps"></a>Следующие шаги

[Настройка кластера Red Hat Enterprise Linux, для ресурсов кластера группы доступности SQL Server](sql-server-linux-availability-group-cluster-rhel.md)

[Настройка кластера серверов SUSE Linux Enterprise для ресурсов кластера группы доступности SQL Server](sql-server-linux-availability-group-cluster-sles.md)

[Настройка кластера Ubuntu для ресурсов кластера группы доступности SQL Server](sql-server-linux-availability-group-cluster-ubuntu.md)
