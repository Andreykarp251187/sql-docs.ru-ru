---
title: Прозрачное шифрование данных — Parallel Data Warehouse | Документация Майкрософт
description: Прозрачное шифрование данных (TDE) для Parallel Data Warehouse (PDW) выполняет в реальном времени ввода-вывода шифрование и расшифровку данных и файлы журнала транзакций и специальные файлы журналов PDW.»
author: mzaman1
manager: craigg
ms.prod: sql
ms.technology: data-warehouse
ms.topic: conceptual
ms.date: 04/17/2018
ms.author: murshedz
ms.reviewer: martinle
ms.openlocfilehash: e9067416365e56dccf9c09f2e826c01fb3ecfa3c
ms.sourcegitcommit: 3026c22b7fba19059a769ea5f367c4f51efaf286
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/15/2019
ms.locfileid: "63156941"
---
# <a name="transparent-data-encryption"></a>прозрачное шифрование данных.
Чтобы защитить базу данных, можно принять ряд мер предосторожности, например спроектировать систему безопасности, проводить шифрование конфиденциальных ресурсов и поместить серверы базы данных под защиту брандмауэра. Тем не менее для сценария, в котором украдены физического носителя (например, дисков или лент с резервными копиями), злоумышленник можно просто восстановить или присоединить базу данных и просматривать данные. Одним из решений может стать шифрование конфиденциальных данных в базе данных и защита ключей, используемых при шифровании, с помощью сертификата. Это не позволит использовать данные ни одному человеку, не имеющему ключей, но такой тип защиты следует планировать заранее.  
  
*Прозрачное шифрование данных* (TDE) выполняет в реальном времени ввода-вывода шифрования и расшифровки данных и файлов журнала транзакций и PDW специальные файлы журналов. При шифровании используется ключ шифрования базы данных (DEK), который хранится в загрузочной записи базы данных, где можно получить к нему доступ при восстановлении. Ключ шифрования данных является симметричным ключом, защищенным с помощью сертификата, хранящегося в базе данных master SQL Server PDW. Функция прозрачного шифрования данных защищает "неактивные" данные, то есть файлы данных и журналов. Благодаря ей обеспечивается соответствие требованиям различных законов, постановлений и рекомендаций, действующих в разных отраслях. Эта возможность позволяет разработчикам программного обеспечения для шифрования данных с помощью алгоритмов шифрования AES и 3DES, не меняя существующие приложения.  
  
> [!IMPORTANT]  
> Прозрачное шифрование данных не поддерживает шифрование данных, передаваемых между клиентом и PDW. Дополнительные сведения о том, как для шифрования данных между клиентом и SQL Server PDW см. в разделе [подготовить сертификат](provision-certificate.md).  
>   
> Прозрачное шифрование данных данные не шифруются при перемещении или используется. Внутренний трафик между компонентами PDW внутри SQL Server PDW, не шифруются. Данные временно хранятся в памяти буферы не шифруются. Чтобы уменьшить этот риск, управлять физического доступа и подключений к SQL Server PDW.  
  
После защиты базы данных ее можно восстановить с помощью правильного сертификата.  
  
> [!NOTE]  
> При создании сертификата для прозрачного шифрования данных, следует немедленно создать резервную его, а также связанный закрытый ключ. В случае если сертификат окажется недоступен или понадобится восстановить базу данных на другом сервере либо присоединить ее к другому серверу, необходимо иметь копии сертификата и закрытого ключа. Иначе будет невозможно открыть базу данных. Сертификат шифрования следует сохранить, даже если функция прозрачного шифрования в базе данных будет отключена. Даже если база данных не зашифрована, части журнала транзакций могут по-прежнему оставаться защищенными, а для некоторых операций будет требоваться сертификат до выполнения полного резервного копирования базы данных. Сертификат, который превысил свой срок хранения, все еще может быть использован для шифрования и расшифровки данных с помощью прозрачного шифрования данных.  
  
Шифрование файла базы данных проводится на уровне страниц. Страницы в зашифрованной базе данных шифруются до записи на диск и дешифруются при чтении в память. Прозрачное шифрование данных не увеличивает размер зашифрованной базы данных.  
  
На следующем рисунке показан иерархии ключей для Прозрачного шифрования данных:  
  
![Отображает иерархию](media/tde-architecture.png "TDE_Architecture")  
  
## <a name="using-tde"></a>С помощью прозрачного шифрования данных  
Чтобы использовать прозрачное шифрование данных, выполните следующие действия. Первые три шага осуществляется только один раз, когда Подготовка SQL Server PDW для поддержки прозрачного шифрования данных.  
  
1.  Создайте главный ключ базы данных master.  
  
2.  Используйте **sp_pdw_database_encryption** включения прозрачного шифрования данных в SQL Server PDW. Эта операция изменяет временные базы данных, чтобы обеспечить защиту будущих временных данных и завершится ошибкой при попытке это сделать при наличии любой активных сеансов, имеющих временные таблицы. **sp_pdw_database_encryption** включает маскирование данных пользователя в системных журналах PDW. (Дополнительные сведения о маскирование данных пользователя в PDW системные журналы, см. в разделе [sp_pdw_log_user_data_masking](../relational-databases/system-stored-procedures/sp-pdw-log-user-data-masking-sql-data-warehouse.md).)  
  
3.  Используйте [sp_pdw_add_network_credentials](../relational-databases/system-stored-procedures/sp-pdw-add-network-credentials-sql-data-warehouse.md) создать учетные данные, которые могут проверять подлинность и записи к общей папке, где будет храниться резервная копия сертификата. Если учетные данные уже существует на сервере предполагаемый хранилища, можно использовать существующие учетные данные.  
  
4.  В базе данных master создайте сертификат, защищен главным ключом.  
  
5.  Резервную копию сертификата в общую папку хранилища.  
  
6.  В базе данных пользователя создайте ключ шифрования базы данных и защитить с помощью сертификата, который хранится в базе данных master.  
  
7.  Используйте `ALTER DATABASE` инструкцию, чтобы зашифровать базу данных, с помощью прозрачного шифрования данных.  
  
В следующем примере демонстрируется шифрование `AdventureWorksPDW2012` базы данных с помощью сертификата с именем `MyServerCert`, созданный в SQL Server PDW.  
  
**Первый: Включение прозрачного шифрования данных на сервере SQL Server PDW.** Это действие требуется только в один раз.  
  
```sql  
USE master;  
GO  
  
-- Create a database master key in the master database  
CREATE MASTER KEY ENCRYPTION BY PASSWORD = '<UseStrongPasswordHere>';  
GO  
  
-- Enable encryption for PDW  
EXEC sp_pdw_database_encryption 1;  
GO  
  
-- Add a credential that can write to the share  
-- A credential created for a backup can be used if you wish  
EXEC sp_pdw_add_network_credentials 'SECURE_SERVER', '<domain>\<Windows_user>', '<password>';  
```  
  
**Секунду: Создайте и создать резервную копию сертификата в базе данных master.** Это действие только в том случае требуется один раз. Может иметь отдельный сертификат для каждой базы данных (рекомендуется), или можно защитить несколько баз данных с помощью одного сертификата.  
  
```sql  
-- Create certificate in master  
CREATE CERTIFICATE MyServerCert WITH SUBJECT = 'My DEK Certificate';  
GO  
  
-- Back up the certificate with private key  
BACKUP CERTIFICATE MyServerCert   
    TO FILE = '\\SECURE_SERVER\cert\MyServerCert.cer'  
    WITH PRIVATE KEY   
    (   
        FILE = '\\SECURE_SERVER\cert\MyServerCert.key',  
        ENCRYPTION BY PASSWORD = '<UseStrongPasswordHere>'   
    )   
GO  
```  
  
**Последние: Создайте ключ шифрования данных и шифрования базы данных пользователя с помощью инструкции ALTER DATABASE.** Это действие повторяется для каждой базы данных, который защищен службой прозрачное шифрование данных.  
  
```sql  
USE AdventureWorksPDW2012;  
GO  
  
CREATE DATABASE ENCRYPTION KEY  
WITH ALGORITHM = AES_128  
ENCRYPTION BY SERVER CERTIFICATE MyServerCert;  
GO  
  
ALTER DATABASE AdventureWorksPDW2012 SET ENCRYPTION ON;  
GO  
```  
  
Операции шифрования и дешифрования запланированы в фоновых потоках по SQL Server. Можно просмотреть состояние этих операций, с помощью представления каталога и динамические административные представления в списке, представленном далее в этой статье.  
  
> [!CAUTION]  
> Файлы резервных копий баз данных, в которых включено TDE, также шифруются с помощью ключа шифрования базы данных. Поэтому для восстановления таких резервных копий необходимо иметь сертификат, защищающий ключ шифрования базы данных. Это значит, что помимо резервного копирования базы данных обязательно необходимо сохранять резервные копии сертификатов серверов, чтобы не допустить потери данных. Если сертификат станет недоступным, это приведет к потере данных.  
  
## <a name="commands-and-functions"></a>Команды и функции  
Чтобы в следующих инструкциях можно было использовать сертификаты TDE, они должны быть зашифрованы главным ключом базы данных.  
  
В следующей таблице представлены ссылки и объяснения команд и функций TDE.  
  
|Команда или функция|Цель|  
|-----------------------|-----------|  
|[СОЗДАНИЕ КЛЮЧА ШИФРОВАНИЯ БАЗЫ ДАННЫХ](../t-sql/statements/create-database-encryption-key-transact-sql.md)|Создает ключ, используемый для шифрования базы данных.|  
|[ИЗМЕНИТЬ КЛЮЧ ШИФРОВАНИЯ БАЗЫ ДАННЫХ](../t-sql/statements/alter-database-encryption-key-transact-sql.md)|Изменяет ключ, используемый для шифрования базы данных.|  
|[DROP DATABASE ENCRYPTION KEY](../t-sql/statements/drop-database-encryption-key-transact-sql.md)|Удаляет ключ, использовавшийся для шифрования базы данных.|  
|[ALTER DATABASE](../t-sql/statements/alter-database-transact-sql.md?tabs=sqlpdw)|Объясняет параметр **ALTER DATABASE** , который используется для включения TDE.|  
  
## <a name="catalog-views-and-dynamic-management-views"></a>Представления каталога и динамические административные представления  
В следующей таблице показаны представления каталогов и динамические административные представления TDE.  
  
|Представление каталога или динамическое административное представление|Цель|  
|-------------------------------------------|-----------|  
|[sys.databases](../relational-databases/system-catalog-views/sys-databases-transact-sql.md)|Представление каталога со сведениями о базе данных.|  
|[sys.certificates](../relational-databases/system-catalog-views/sys-certificates-transact-sql.md)|Представление каталога с сертификатами из базы данных.|  
|[sys.dm_pdw_nodes_database_encryption_keys](../relational-databases/system-dynamic-management-views/sys-dm-pdw-nodes-database-encryption-keys-transact-sql.md)|Динамическое административное представление, которое предоставляет сведения о каждом узле, о ключах шифрования, используемых в базе данных и состояние шифрования базы данных.|  
  
## <a name="permissions"></a>Разрешения  
Для каждой функции или команды TDE действуют отдельные требования к разрешениям, описанные в таблицах выше.  
  
Для просмотра метаданных, связанных с прозрачным шифрованием данных требуется `CONTROL SERVER` разрешение.  
  
## <a name="considerations"></a>Замечания  
Во время проверки базы данных на повторное шифрование, выполняемой для операции шифрования, операции обслуживания базы данных отключаются.  
  
Состояние шифрования базы данных с помощью можно определить **sys.dm_pdw_nodes_database_encryption_keys** динамическое административное представление. Дополнительные сведения см. в разделе *представления каталогов и динамические административные представления* разделе этой статьи.  
  
### <a name="restrictions"></a>Ограничения  
Следующие операции запрещены во время `CREATE DATABASE ENCRYPTION KEY`, `ALTER DATABASE ENCRYPTION KEY`, `DROP DATABASE ENCRYPTION KEY`, или `ALTER DATABASE...SET ENCRYPTION` инструкций.  
  
-   Удаление базы данных.  
  
-   С помощью `ALTER DATABASE` команды.  
  
-   Запуск резервной копии базы данных.  
  
-   Запуск восстановления базы данных.  
  
Следующие операции или условия не позволит `CREATE DATABASE ENCRYPTION KEY`, `ALTER DATABASE ENCRYPTION KEY`, `DROP DATABASE ENCRYPTION KEY`, или `ALTER DATABASE...SET ENCRYPTION` инструкций.  
  
-   `ALTER DATABASE` Выполнение команды.  
  
-   выполняется какая-либо операция резервного копирования;  
  
При создании файлов базы данных быстрая инициализация файлов недоступна при включенном TDE.  
  
### <a name="areas-not-protected-by-tde"></a>Области, не защищен с помощью TDE  
Прозрачное шифрование данных не защищает внешних таблиц.  
  
Прозрачное шифрование данных не защищает диагностические сеансы. Пользователям следует соблюдать осторожность не в запросы с конфиденциальные параметры во время использования диагностических сеансов. Диагностические сеансы, которые допускается раскрытие уязвимой информации должны быть удалены, как только они больше не требуются.  
  
При помещении в памяти SQL Server PDW, расшифровываются, защищаемую прозрачным Шифрованием данных. Дампы памяти создаются при возникновении некоторых проблем на устройстве. Создать дамп файлы представляют собой содержимое памяти во время появления проблемы и могут содержать конфиденциальные данные в незашифрованном виде. Прежде чем они являются общими с другими пользователями, необходимо проверить содержимое дампы памяти.  
  
Базы данных master не защищен с помощью TDE. Хотя базы данных master не содержит сведений о пользователях, он содержит сведения, такие как имена входа.  
  
### <a name="transparent-data-encryption-and-transaction-logs"></a>Прозрачное шифрование данных и журналы транзакций  
Включение использовать прозрачное шифрование данных в базе данных приводит к обнулению оставшуюся часть виртуального журнала транзакций для принудительного виртуального журнала транзакций. Это гарантирует, что после включения шифрования базы данных в журналах транзакций не останется простого текста. Чтобы узнать состояние шифрования файла журнала на каждом узле PDW, просмотр `encryption_state` столбца в `sys.dm_pdw_nodes_database_encryption_keys` представление, как в следующем примере:  
  
```sql  
WITH dek_encryption_state AS   
(  
    SELECT ISNULL(db_map.database_id, dek.database_id) AS database_id, encryption_state  
    FROM sys.dm_pdw_nodes_database_encryption_keys AS dek  
        INNER JOIN sys.pdw_nodes_pdw_physical_databases AS node_db_map  
           ON dek.database_id = node_db_map.database_id AND dek.pdw_node_id = node_db_map.pdw_node_id  
        LEFT JOIN sys.pdw_database_mappings AS db_map  
            ON node_db_map .physical_name = db_map.physical_name  
        INNER JOIN sys.dm_pdw_nodes AS nodes  
            ON nodes.pdw_node_id = dek.pdw_node_id  
    WHERE dek.encryptor_thumbprint <> 0x  
)  
SELECT TOP 1 encryption_state  
       FROM dek_encryption_state  
       WHERE dek_encryption_state.database_id = DB_ID('AdventureWorksPDW2012 ')  
       ORDER BY (CASE encryption_state WHEN 3 THEN -1 ELSE encryption_state END) DESC;  
```  
  
Все данные, записанные в журнале транзакций до изменения ключа шифрования базы данных, будут зашифрованы с помощью предыдущего ключа шифрования базы данных.  
  
### <a name="pdw-activity-logs"></a>Журналы действий PDW  
SQL Server PDW поддерживает набор журналов, предназначены для устранения неполадок. (Обратите внимание, это не журнала транзакций в журнале ошибок SQL Server и журнале событий Windows.) Эти журналы действий PDW могут содержать полной инструкции в виде открытого текста, некоторые из которых может содержать данные пользователя. Типичными примерами являются **вставить** и **обновления** инструкций. Маскирование данных пользователя можно явным образом включить или отключить с помощью **sp_pdw_log_user_data_masking**. Чтобы защитить их Включение шифрования для SQL Server PDW автоматически включает маскирования данных пользователя в журналах действий PDW. **sp_pdw_log_user_data_masking** можно также использовать для маскировки инструкции, если не используется прозрачное шифрование данных, но это не рекомендуется, так как он значительно уменьшает вероятность группы поддержки Microsoft для анализа проблем.  
  
### <a name="transparent-data-encryption-and-the-tempdb-system-database"></a>Прозрачное шифрование данных и системная база данных tempdb  
Системная база данных tempdb шифруются в том случае, если шифрование включено с помощью [sp_pdw_database_encryption](../relational-databases/system-stored-procedures/sp-pdw-database-encryption-sql-data-warehouse.md). Это необходимо, прежде чем любой базы данных можно использовать прозрачное шифрование данных. Это может влиять на производительность незашифрованных баз данных на том же экземпляре SQL Server PDW.  
  
## <a name="key-management"></a>Управление ключами  
Ключ шифрования базы данных (DEK) защищен сертификатами, которые хранятся в базе данных master. Эти сертификаты являются защищен главным ключом базы данных (DMK) базы данных master. Главный ключ базы данных должна быть защищена с помощью главного ключа службы (SMK), чтобы использоваться для прозрачного шифрования данных.  
  
Система может доступ к ключам без вмешательства оператора (например, пароля). Если сертификат недоступен, система выдаст сообщение об ошибке, что пока не будет доступен действующий сертификат не удается расшифровать ключ шифрования данных.  
  
При перемещении базы данных с одного устройства на другой, сертификат, используемый для защиты его "необходимо вначале восстановить ключ шифрования базы данных на целевом сервере. Затем базы данных могут быть восстановлены как обычно. Дополнительные сведения см. в разделе Стандартная документации по SQL Server в [перемещение базы данных защищены прозрачное шифрование данных на другой сервер SQL](https://technet.microsoft.com/library/ff773063.aspx).  
  
Сертификаты, используемые для шифрования DEK должна сохраняться до тех пор, пока существуют резервные копии баз данных, которые их используют. Архивация сертификатов необходимо включить закрытый ключ сертификата, так как сертификат без закрытого ключа не может использоваться для восстановления базы данных. Эти сертификата закрытого ключа резервные копии хранятся в отдельном файле, защищен паролем, которые необходимы для восстановления сертификата.  
  
## <a name="restoring-the-master-database"></a>Восстановление базы данных master  
Можно восстановить базу данных master с помощью **DWConfig**, в процессе аварийного восстановления.  
  
-   Если узел элемента управления не изменился, это восстановления базы данных master на устройстве же и не изменяется, из которого создавалась резервная копия базы данных master главный ключ базы данных и все сертификаты будут для чтения без дополнительных действий.  
  
-   При восстановлении базы данных master на разные устройства или если узел элемента управления был изменен с момента резервного копирования базы данных master, чтобы повторно создать главный ключ базы данных будет потребоваться дополнительные действия.  
  
    1.  Откройте главный ключ базы данных:  
  
        ```sql  
        OPEN MASTER KEY DECRYPTION BY PASSWORD = '<password>';  
        ```  
  
    2.  Добавьте шифрование главного ключа базы данных:  
  
        ```sql  
        ALTER MASTER KEY   
            ADD ENCRYPTION BY SERVICE MASTER KEY;  
        ```  
  
    3.  Перезапуск устройства.  
  
## <a name="upgrade-and-replacing-virtual-machines"></a>Обновление и замена виртуальных машин  
Если главный ключ базы данных существует в устройстве, на котором было выполнено обновление или замена виртуальной Машины, необходимо указать пароль главного ключа базы данных как параметр.  
  
Пример действия обновления. Замените `**********` с паролем главного ключа базы данных.  
  
`setup.exe /Action=ProvisionUpgrade ... DMKPassword='**********'`  
  
Пример действия для замены виртуальной машины.  
  
`setup.exe /Action=ReplaceVM ... DMKPassword='**********'`  
  
Во время обновления Если шифрование базы данных пользователя и пароль главного ключа базы данных не указан, действие обновления завершится ошибкой. Во время замены Если пароль не задан, если главный ключ базы данных существует, операция пропускает шаг восстановления главного ключа базы данных. Остальные шаги будут выполняться в конце операция замены виртуальной Машины, однако действие будет завершаться сбоем в конце, чтобы указать, что требуются дополнительные действия. В журналах установки (расположенный в **\ProgramData\Microsoft\Microsoft SQL Server Parallel Data Warehouse\100\Logs\Setup\\\Detail-Setup < метка времени >** ), будет отображаться следующее предупреждение ближе к концу.  
  
`*** WARNING \*\*\* DMK is detected in master database, but could not be recovered automatically! The DMK password was either not provided or is incorrect!`
  
Вручную выполните эти инструкции в PDW и перезапуск устройства после этого для восстановления главного ключа базы данных:  
  
```sql
OPEN MASTER KEY DECRYPTION BY PASSWORD = '<DMK password>';  
ALTER MASTER KEY ADD ENCRYPTION BY SERVICE MASTER KEY;  
```
  
Следуйте инструкциям в **восстановление базы данных master** абзаца, чтобы восстановить базу данных, а затем перезагрузите устройство.  
  
Если главный ключ базы данных существовали до, но не была восстановлена после действия, сообщение об ошибке возникает при запросе к базе данных.  
  
```sql
Msg 110806;  
A distributed query failed: Database '<db_name>' cannot be opened due to inaccessible files or insufficient memory or disk space. See the SQL Server errorlog for details.
```  
  
## <a name="performance-impact"></a>Влияние на производительность  
Влияние на производительность прозрачного шифрования данных, зависит от типа данных, доступные для вас, как они хранятся и тип действия рабочей нагрузки в SQL Server PDW. При, защищаемую прозрачным Шифрованием, ввод-вывод для чтения и затем расшифровки данных или шифрования и последующей записи данных это действие с большим объемом ЦП, которое будет иметь дополнительные влияние, если выполняются другие действия с большим объемом ресурсов ЦП, в то же время. Так как прозрачное шифрование данных шифрует `tempdb`, прозрачное шифрование данных может повлиять на производительность баз данных, которые не шифруются. Чтобы получить точное представление о производительности, необходимо протестировать всей системы с действием данных и запросов.  
  
## <a name="related-content"></a>См. также  
Следующие ссылки содержат общие сведения об управлении шифрования в SQL Server. Эти статьи помогут вам понять шифрование SQL Server, но эти статьи не имеют сведения, относящиеся к SQL Server PDW, а также рассматриваются функции, которые не существуют в SQL Server PDW.  
  
-   [Шифрование SQL Server](../relational-databases/security/encryption/sql-server-encryption.md)  
  
-   [Иерархия средств шифрования](../relational-databases/security/encryption/encryption-hierarchy.md)  
  
-   [Ключи шифрования SQL Server и базы данных](../relational-databases/security/encryption/sql-server-and-database-encryption-keys-database-engine.md)  

  
## <a name="see-also"></a>См. также  
[ALTER DATABASE](../t-sql/statements/alter-database-transact-sql.md?tabs=sqlpdw)  
[CREATE MASTER KEY](../t-sql/statements/create-master-key-transact-sql.md)  
[СОЗДАНИЕ КЛЮЧА ШИФРОВАНИЯ БАЗЫ ДАННЫХ](../t-sql/statements/create-database-encryption-key-transact-sql.md)  
[BACKUP CERTIFICATE](../t-sql/statements/backup-certificate-transact-sql.md)  
[sp_pdw_database_encryption](../relational-databases/system-stored-procedures/sp-pdw-database-encryption-sql-data-warehouse.md)  
[sp_pdw_database_encryption_regenerate_system_keys](../relational-databases/system-stored-procedures/sp-pdw-database-encryption-regenerate-system-keys-sql-data-warehouse.md)  
[sp_pdw_log_user_data_masking](../relational-databases/system-stored-procedures/sp-pdw-log-user-data-masking-sql-data-warehouse.md)  
[sys.certificates](../relational-databases/system-catalog-views/sys-certificates-transact-sql.md)  
[sys.dm_pdw_nodes_database_encryption_keys](../relational-databases/system-dynamic-management-views/sys-dm-pdw-nodes-database-encryption-keys-transact-sql.md)  
  
