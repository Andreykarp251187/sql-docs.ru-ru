---
title: Разработка осведомленности о подключении-пуле в драйвере ODBC (ru) Документы Майкрософт
ms.custom: ''
ms.date: 01/19/2017
ms.prod: sql
ms.prod_service: connectivity
ms.reviewer: ''
ms.technology: connectivity
ms.topic: conceptual
ms.assetid: c63d5cae-24fc-4fee-89a9-ad0367cddc3e
author: David-Engel
ms.author: v-daenge
ms.openlocfilehash: f77fea1d8439ac9ce7374b7dd47db5665686cfbc
ms.sourcegitcommit: ce94c2ad7a50945481172782c270b5b0206e61de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/14/2020
ms.locfileid: "81283434"
---
# <a name="developing-connection-pool-awareness-in-an-odbc-driver"></a>Разработка драйвера ODBC с поддержкой пула подключений
В этой теме обсуждаются детали разработки драйвера ODBC, содержащего информацию о том, как водитель должен предоставлять услуги по объединению соединений.  
  
## <a name="enabling-driver-aware-connection-pooling"></a>Включение пулинга соединения с осознавая водителя  
 Драйвер должен реализовать следующие функции интерфейса поставщика услуг ODBC (SPI):  
  
-   СЗЛСетКоннекаттаттПродбИнФО  
  
-   СЗЛСетКоннекинфо  
  
-   СЗЛСетДрайверКоннинфо  
  
-   СЗЛГетПулИД  
  
-   Соединение СЗЛРатЕ  
  
-   СЗЛПулКоннект  
  
-   СЗЛКCleanupConnectionPoolID  
  
 Для получения дополнительной информации [обратитесь к интерфейсу поставщика услуг ODBC (SPI).](../../../odbc/reference/syntax/odbc-service-provider-interface-spi-reference.md)  
  
 Драйвер должен также реализовать следующие существующие функции, чтобы можно было обеспечить объединение данных о драйверах:  
  
|Компонент|Добавлена функциональность|  
|--------------|-------------------------|  
|[СЗЛАллокХэндл](../../../odbc/reference/syntax/sqlallochandle-function.md)<br /><br /> [SQLFreeHandle](../../../odbc/reference/syntax/sqlfreehandle-function.md)<br /><br /> [SQLGetDiagField](../../../odbc/reference/syntax/sqlgetdiagfield-function.md)<br /><br /> [Функции SQLGetDiagRec](../../../odbc/reference/syntax/sqlgetdiagrec-function.md)|Поддержка нового типа ручки: SQL_HANDLE_DBC_INFO_TOKEN (см. описание ниже).|  
|[SQLSetConnectAttr](../../../odbc/reference/syntax/sqlsetconnectattr-function.md)|Поддержка нового атрибута соединения только для набора: SQL_ATTR_DBC_INFO_TOKEN для сброса соединения (см. описание ниже).|  
  
> [!NOTE]  
>  Депрепроизнанные функции, такие как **S'LError** и **S'LSetConnectOption,** не поддерживаются для объединения подключений к подключению, осведомленного о драйверах.  
  
## <a name="the-pool-id"></a>Идентификатор пула  
 Идентификатор пула — это идентификатор длины водителя, относящееся к указателю, чтобы представлять определенную группу соединений, которые могут быть использованы как взаимозаменяемые. Учитывая набор информации о подключении, водитель должен иметь возможность быстро вывести соответствующий идентификатор пула.  
  
 Например, идентификатор пула должен кодировать имя сервера и информацию о учетных данных. Однако имя базы данных не требуется, поскольку драйвер может повторно использовать соединение, а затем изменить базу данных за меньшее время, чем создание нового соединения.  
  
 Водитель должен определить набор ключевых атрибутов, который будет включать идентификатор пула. Значение этих ключевых атрибутов может исходить от атрибутов соединения, строки соединения и DSN. В случае возникновения конфликтов в этих источниках существующая политика разрешения, специфичная для драйвера, должна использоваться для обратной совместимости.  
  
 Менеджер драйвера будет использовать другой пул для различных идонов пула. Все соединения в одном бассейне можно выслать повторно. Менеджер драйвера никогда не будет повторно использовать соединение с другим идентификатором пула.  
  
 Поэтому драйверы должны назначить уникальный идентификатор пула для каждой группы соединений с одинаковым значением в определенных ключевых атрибутах. Если водитель использует один и тот же идентификатор пула для двух соединений с различными значениями в ключевых атрибутах, менеджер драйвера по-прежнему помещает их в один и тот же пул (менеджер драйвера ничего не знает о атрибутах ключа драйвера). Это означает, что водителю необходимо будет сообщить менеджеру драйвера о том, что соединение с другим набором ключевых атрибутов не является многоразовым внутри [функции SLRateConnection.](../../../odbc/reference/syntax/sqlrateconnection-function.md) Это может снизить производительность, и это не рекомендуется.  
  
 Менеджер драйвера не будет повторно использовать соединение, выделенное из другой среды драйвера, даже если вся информация о подключении совпадает. Менеджер драйвера будет использовать другой пул для другой среды, даже если соединения имеют один и тот же идентификатор пула. Таким образом, идентификатор пула является локальным для его среды драйвера.  
  
 Функция получения идентификатора пула от драйвера — [функция S'LGetPoolID.](../../../odbc/reference/syntax/sqlgetpoolid-function.md)  
  
## <a name="the-connection-rating"></a>Рейтинг подключения  
 По сравнению с созданием нового соединения, вы можете получить лучшую производительность, сбросив некоторую информацию о подключении (например, DATABASE) в объединенном соединении. Таким образом, вы не хотите, чтобы имя базы данных было в наборе ключевых атрибутов. В противном случае, вы можете иметь отдельный пул для каждой базы данных, которые не могут быть хороши в приложениях среднего уровня, где клиенты используют различные строки соединения.  
  
 Всякий раз, когда вы повторно используете соединение, которое имеет несколько атрибутов несоответствия, вы должны сбросить несовпадающие атрибуты на основе нового запроса приложения, так что возвращенное соединение идентично запросу приложения (см. обсуждение атрибута SQL_ATTR_DBC_INFO_TOKEN в [функции S'LSetConnectAttr).](https://go.microsoft.com/fwlink/?LinkId=59368) Однако сброс этих атрибутов может снизить производительность. Например, для сброса базы данных требуется сетевой вызов на сервер. Таким образом, повторноиспользовать соединение, которое идеально соответствует, если он доступен.  
  
 Функция оценки в драйвере может оценить существующее соединение с новым запросом соединения. Например, функция оценки драйвера может определить:  
  
-   Если существующее соединение идеально соответствует запросу.  
  
-   Если есть только некоторые незначительные несоответствия, такие как тайм-аут подключения, которые не требуют связи с сервером для сбросить.  
  
-   Если есть некоторые несовпадающие атрибуты, которые требуют сбросить связь с сервером, но все равно приведут к повышению производительности, чем создание нового соединения.  
  
-   Если несоответствие произошло для атрибута, который занимает очень много времени для сбросить (разработчик драйвера может рассмотреть вопрос о добавлении этого атрибута в набор ключевых атрибутов, который используется для создания идентификатора пула).  
  
 Возможны баллы от 0 до 100, где 0 означает не повторное использование и 100 означает идеально подобранные. [S'LRateConnection](../../../odbc/reference/syntax/sqlrateconnection-function.md) — это функция оценки соединения.  
  
## <a name="new-odbc-handle---sql_handle_dbc_info_token"></a>Новая ручка ODBC - SQL_HANDLE_DBC_INFO_TOKEN  
 Для поддержки объединения соединения, известного водителю, для вычисления идентификатора пула требуется информация о подключении. Драйверу также необходима информация о подключении для сравнения новых запросов на подключение с соединениями в пуле.  Всякий раз, когда соединение в пуле не может быть использовано повторно, водитель должен установить новое соединение, следовательно, требующих информации о подключении.  
  
 Поскольку информация о подключении может поступать из нескольких источников (строка подключения, атрибуты соединения и DSN), водителю может потребоваться разобрать строку соединения и разрешить конфликт между этими источниками в каждом из вышеуказанных вызовов функции.  
  
 Таким образом, вводится новая ручка ODBC: SQL_HANDLE_DBC_INFO_TOKEN. С SQL_HANDLE_DBC_INFO_TOKEN водителю не нужно разбирать строку соединения и разрешать конфликты в связи с информацией более одного раза. Поскольку это определенная для драйвера структура данных, драйвер может хранить такие данные, как информация о подключении или идентификатор пула.  
  
 Эта ручка используется только в качестве интерфейса между менеджером драйвера и драйвером. Приложение не может выделить эту ручку напрямую.  
  
 Родительская ручка этой ручки имеет тип SQL_HANDLE_ENV, что означает, что водитель может получать информацию об окружающей среде от ручки HENV при разрешении информации о подключении.  
  
 Всякий раз, когда он получает новый запрос на подключение, менеджер драйвера выделит ручку типа SQL_HANDLE_DBC_INFO_TOKEN для хранения информации о подключении, после того, как он подтвердит, что водитель поддерживает осведомленность о пуле соединения. После завершения использования ручки (но перед возвратом некоторых кодов возврата, кроме SQL_STILL_EXECUTING из [S'LDriverConnect](../../../odbc/reference/syntax/sqldriverconnect-function.md) или [S'LConnect),](../../../odbc/reference/syntax/sqlconnect-function.md)менеджер-водитель освободит ручку. Таким образом, ручка создается после вызова S'LAllocHandle и уничтожается после вызова S'LFreeHandle. Менеджер драйвера гарантирует, что ручка будет освобождена до освобождения связанного с ней HENV (когда [S'LDriverConnect](../../../odbc/reference/syntax/sqldriverconnect-function.md) или [S'LConnect](../../../odbc/reference/syntax/sqlconnect-function.md) возвращает ошибку).  
  
 Драйвер должен изменить следующие функции, чтобы принять новый тип ручки SQL_HANDLE_DBC_INFO_TOKEN:  
  
1.  [СЗЛАллокХэндл](../../../odbc/reference/syntax/sqlallochandle-function.md)  
  
2.  [SQLFreeHandle](../../../odbc/reference/syntax/sqlfreehandle-function.md)  
  
3.  [SQLGetDiagField](../../../odbc/reference/syntax/sqlgetdiagfield-function.md)  
  
4.  [Функции SQLGetDiagRec](../../../odbc/reference/syntax/sqlgetdiagrec-function.md)  
  
 Менеджер драйвера гарантирует, что несколько потоков не будут использовать одну и ту же SQL_HANDLE_DBC_INFO_TOKEN обрабатывать одновременно. Таким образом, модель синхронизации этой ручки может быть очень простой внутри драйвера. Менеджер драйвера не будет принимать блокировку среды перед выделением и освобождением SQL_HANDLE_DBC_INFO_TOKEN.  
  
 Менеджер драйверов **S'LAllocHandle** и **S'LFreeHandle** не примут этот новый тип ручки.  
  
 SQL_HANDLE_DBC_INFO_TOKEN может содержать конфиденциальную информацию, такую как учетные данные. Таким образом, драйвер должен надежно очистить буфер памяти (с помощью [Secure'eroMemory](https://msdn.microsoft.com/library/windows/desktop/aa366877\(v=vs.85\).aspx)), который содержит конфиденциальную информацию, прежде чем выпускать эту ручку с **помощью S'LFreeHandle.** Всякий раз, когда ручка среды приложения закрывается, все связанные пулы подключений будут закрыты.  
  
## <a name="driver-manager-connection-pool-rating-algorithm"></a>Алгоритм оценки пула драйвер-менеджера-менеджера  
 В этом разделе обсуждается алгоритм оценки объединения соединения драйвер-менеджера. Разработчики драйверов могут реализовать тот же алгоритм обратной совместимости. Этот алгоритм может быть не лучшим. Вы должны уточнить этот алгоритм, основанный на реализации (в противном случае, нет никаких причин для реализации этой функции).  
  
 Менеджер драйвера вернет интегральный рейтинг от 0 до 100 за каждое соединение из пула. 0 означает, что соединение не может быть повторно использовано, а 100 указывает на идеальное соответствие. Предположим, что запрос на подключение называется hRequest, а существующее соединение из пула названо hCandidate. Если одно из следующих условий является ложным, объединенное соединение hCandidate не может быть использовано для hRequest (менеджер драйвера присвоит рейтинг 0).  
  
-   hCandidate и hRequest оба приходят либо из UNICODE API (например, S'LDriverConnectW) или ANSI API (например, S'LDriverConnectA). (Драйверы UNICODE могут вести себя по-разному, учитывая ANSI API и API UNICODE (см. атрибут соединения SQL_ATTR_ANSI_APP).)  
  
-   hCandidate и hRequest создаются одной и той же функцией; либо s'LDriverConnect, либо S'LConnect.  
  
-   Строка подключения, используемая для открытия hCandidate, должна быть такой же, как hRequest, когда используется S'LDriverConnect.  
  
-   Имя пользователя (или DSN), имя пользователя и пароль, используемый для открытия hCandidate, должны быть такими же, чтобы открыть hRequest при использовании S'LConnect.  
  
-   Идентификатор безопасности (SID) текущего потока должен быть таким же, как SID, используемый для открытия hCandidate.  
  
-   Для драйвера, который является дорогостоящим для зачисления и отступления (см. обсуждение SQL_DTC_TRANSITION_COST в [S'LConnect),](../../../odbc/reference/syntax/sqlconnect-function.md)повторное использование *hRequest* не должно требовать дополнительного зачисления или непризыва.  
  
 В следующей таблице отображается назначение оценки для различных сценариев.  
  
|Сравнение атрибутов соединения между объединенным соединением и запросом|Нет вербовки / незачисление|Требуется дополнительный призыв / Непризыв|  
|---------------------------------------------------------------------------------------|-----------------------------------|----------------------------------------------|  
|Каталог (SQL_ATTR_CURRENT_CATALOG) отличается|60|50|  
|Некоторые атрибуты соединения различны, но каталог одинаков|90|70|  
|Все атрибуты соединения идеально соответствуют|100|80|  
  
## <a name="sequence-diagram"></a>Диаграмма последовательностей  
 На этой диаграмме последовательности показан основной механизм объединения, описанный в этой теме. Он показывает только использование [S'LDriverConnect,](../../../odbc/reference/syntax/sqldriverconnect-function.md) но случай [S'LConnect](../../../odbc/reference/syntax/sqlconnect-function.md) похож.  
  
 ![Диаграмма последовательностей](../../../odbc/reference/develop-driver/media/odbc_seq_dia.gif "odbc_seq_dia")  
  
## <a name="state-diagram"></a>Диаграмма состояния  
 На этой диаграмме состояния отображается объект маркера информации о подключении, описанный в этой теме. Диаграмма показывает только [S'LDriverConnect,](../../../odbc/reference/syntax/sqldriverconnect-function.md) но случай [S'LConnect](../../../odbc/reference/syntax/sqlconnect-function.md) похож. Так как менеджеру драйвера может потребоваться обработка ошибок в любое время, менеджер драйвера может вызвать [S'LFreeHandle](../../../odbc/reference/syntax/sqlfreehandle-function.md) для любого состояния.  
  
 ![Диаграмма состояний](../../../odbc/reference/develop-driver/media/odbc_state_diagram.gif "odbc_state_diagram")  
  
## <a name="see-also"></a>См. также:  
 [Пулинг соединения с информацией о драйверах](../../../odbc/reference/develop-app/driver-aware-connection-pooling.md)   
 [Справочник по интерфейсу службы доступа (SPI) ODBC](../../../odbc/reference/syntax/odbc-service-provider-interface-spi-reference.md)
