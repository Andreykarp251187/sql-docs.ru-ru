---
title: Разработка драйвера ODBC с поддержкой пула подключений | Документация Майкрософт
ms.custom: ''
ms.date: 01/19/2017
ms.prod: sql
ms.prod_service: connectivity
ms.reviewer: ''
ms.technology: connectivity
ms.topic: conceptual
ms.assetid: c63d5cae-24fc-4fee-89a9-ad0367cddc3e
author: MightyPen
ms.author: genemi
manager: craigg
ms.openlocfilehash: b82e56dd7998ca19ce9e401369cd8d2f52b58573
ms.sourcegitcommit: f7fced330b64d6616aeb8766747295807c92dd41
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "62636240"
---
# <a name="developing-connection-pool-awareness-in-an-odbc-driver"></a>Разработка драйвера ODBC с поддержкой пула подключений
В этом разделе рассматриваются сведения о разработке драйверу ODBC, содержащий сведения о том, как драйвер должен предоставить службы пула подключений.  
  
## <a name="enabling-driver-aware-connection-pooling"></a>Включение организация пулов соединений с учетом драйвера  
 Драйвер должен реализовывать следующие функции ODBC службы поставщика интерфейса (SPI):  
  
-   SQLSetConnectAttrForDbcInfo  
  
-   SQLSetConnectInfo  
  
-   SQLSetDriverConnectInfo  
  
-   SQLGetPoolID  
  
-   SQLRateConnection  
  
-   SQLPoolConnect  
  
-   SQLCleanupConnectionPoolID  
  
 См. в разделе [Справочник по ODBC службы поставщика интерфейса (SPI)](../../../odbc/reference/syntax/odbc-service-provider-interface-spi-reference.md) Дополнительные сведения.  
  
 Драйвер также должен реализовать следующие существующие функции, включить драйвер с поддержкой пула:  
  
|Компонент|Дополнительные возможности|  
|--------------|-------------------------|  
|[SQLAllocHandle](../../../odbc/reference/syntax/sqlallochandle-function.md)<br /><br /> [SQLFreeHandle](../../../odbc/reference/syntax/sqlfreehandle-function.md)<br /><br /> [SQLGetDiagField](../../../odbc/reference/syntax/sqlgetdiagfield-function.md)<br /><br /> [SQLGetDiagRec](../../../odbc/reference/syntax/sqlgetdiagrec-function.md)|Поддерживает новый тип дескриптора: SQL_HANDLE_DBC_INFO_TOKEN (см. описание ниже).|  
|[SQLSetConnectAttr](../../../odbc/reference/syntax/sqlsetconnectattr-function.md)|Поддержка новый атрибут соединения только для задания: SQL_ATTR_DBC_INFO_TOKEN для сброса соединения (см. описание ниже).|  
  
> [!NOTE]  
>  Устаревшие функции, такие как **SQLError** и **SQLSetConnectOption** не поддерживаются для включения организации пулов соединений с учетом драйвера.  
  
## <a name="the-pool-id"></a>Идентификатор пула  
 Идентификатор пула — идентификатор конкретного драйвера указатель длины для представления определенной группе подключений, которые могут использоваться как взаимозаменяемые. При заданном наборе сведений о соединении, драйвер должен иметь возможность быстро вывести соответствующий идентификатор пула.  
  
 Например идентификатор пула следует кодировать имя сервера и учетные данные сведения. Тем не менее имя базы данных не требуется, так как драйвер может иметь возможность повторно использовать соединение и затем изменить базу данных в меньше времени, чем создание нового подключения.  
  
 Драйвер должен определить набор ключевых атрибутов, включающим идентификатор пула. Значения этих ключей атрибутов могут поступать из атрибуты соединения, строку подключения и имя источника данных. В случае возникновения конфликтов в этих источниках, политика разрешения существующей, определяемой драйвером следует использовать для обеспечения обратной совместимости.  
  
 Диспетчер драйверов будет использовать другой пул для другой пул идентификаторов. Все подключения в одном пуле можно использовать повторно. Диспетчер драйверов никогда не будет повторно использовать соединение с идентификатором другого пула.  
  
 Поэтому драйверы следует назначить идентификатор пула, уникальный для каждой группы подключений с одинаковым значением в их определенных ключевых атрибутов. Если драйвер использует один и тот же идентификатор пула для двух подключений с разными значениями в их ключевых атрибутов, диспетчер драйверов по-прежнему помещает их в один пул (диспетчера драйверов ничего не известно о ключевых атрибутов драйвера). Это означает, что драйвер будет необходимо сообщить в диспетчер драйверов, соединение с другим набором ключевых атрибутов не может использоваться повторно, внутри [функция SQLRateConnection](../../../odbc/reference/syntax/sqlrateconnection-function.md). Это может привести к снижению производительности, и это не рекомендуется.  
  
 Диспетчер драйверов не будет использовать подключение, выделенных из другой среды драйвера, даже если все сведения о подключении совпадает. Диспетчер драйверов будет использовать другой пул для разных сред, даже в том случае, если соединение имеет тот же идентификатор пула. Таким образом идентификатор пула является локальной на окружающую среду драйвера.  
  
 Функция для получения идентификатора пула в драйвере [функция SQLGetPoolID](../../../odbc/reference/syntax/sqlgetpoolid-function.md).  
  
## <a name="the-connection-rating"></a>Оценка подключения  
 По сравнению с создания нового подключения, можно получить более высокую производительность, сбросив некоторые сведения о соединении (например, база данных) в соединение из пула. Таким образом вы не можете имя базы данных в набор ключевых атрибутов. В противном случае может иметь отдельный пул для каждой базы данных, который не может быть хорошим в приложениях среднего уровня, где клиенты используют различные различные строки подключения.  
  
 Каждый раз, когда вы повторно использовать подключение, которое содержит некоторые несоответствия атрибута, необходимо сбросить несоответствие атрибутов на основании нового запроса приложения, чтобы возвращаемое соединение идентична запрос приложения (см. обсуждение атрибута SQL_ATTR _DBC_INFO_TOKEN в [SQLSetConnectAttr, функция](https://go.microsoft.com/fwlink/?LinkId=59368)). Тем не менее Сброс этих атрибутов может привести к снижению производительности. Например сброс базы данных требуется для вызова сервера по сети. Таким образом повторное использование соединения, вполне совпадении, если таковой доступен.  
  
 Функция оценки в драйвере может вычислять существующее соединение с помощью нового запроса на подключение. Например можно определить функции оценки драйвера:  
  
-   Если существующее соединение вполне сопоставляется с запросом.  
  
-   Если присутствуют только некоторые незначительные несоответствия, такие как время ожидания подключения, не требующие обмена данными с сервером для сброса.  
  
-   Если существуют некоторые несоответствия атрибуты, которые требуют взаимодействия с сервером для сброса, но все равно приведет лучшую производительность, чем при установке нового подключения.  
  
-   Несоответствие произошло ли для атрибута, которые очень много времени сбросить (разработчик драйвера рассмотреть при добавлении этого атрибута в набор ключевых атрибутов, который используется для создания идентификатора пула).  
  
 Оценка от 0 до 100 — возможно, где 0 означает, что не используйте повторно и 100 означает, что вполне соответствует. [SQLRateConnection](../../../odbc/reference/syntax/sqlrateconnection-function.md) — это функция для оценки соединения.  
  
## <a name="new-odbc-handle---sqlhandledbcinfotoken"></a>Новый дескриптор ODBC - SQL_HANDLE_DBC_INFO_TOKEN  
 Чтобы обеспечить поддержку драйвер с поддержкой пула подключений, этот драйвер должен сведения о соединении для вычисления идентификатора пула. Этот драйвер должен также сведения о соединении для сравнения новых запросов на подключение с помощью соединения в пуле.  Каждый раз, когда можно использовать повторно без соединения в пуле, драйвер должен установить новое подключение, что требует сведений о соединении.  
  
 Так как сведения о соединении могут поступать из нескольких источников (строка подключения, атрибуты соединения и имени DSN), драйвер может потребоваться проанализировать строку подключения и разрешить конфликт между эти источники в каждом из приведенного выше вызова функции.  
  
 Таким образом вводится новый дескриптор ODBC: SQL_HANDLE_DBC_INFO_TOKEN. С помощью SQL_HANDLE_DBC_INFO_TOKEN драйвер не нужно проанализировать строку подключения и разрешение конфликтов в сведения о подключении более одного раза. Так как это структуры данных, драйвер можно хранить данные, например сведений о соединении или идентификатор пула.  
  
 Этот дескриптор используется только как интерфейс между диспетчера драйверов и драйверов. Приложение не может выделить этот дескриптор напрямую.  
  
 Родительский дескриптор для данного дескриптора относится к типу SQL_HANDLE_ENV, это означает, что драйвер может получить сведения о среде из дескриптора HENV во время разрешения подключения сведения.  
  
 При каждом получении нового запроса на подключение, диспетчер драйверов будет выделить дескриптор типа SQL_HANDLE_DBC_INFO_TOKEN для сохранения сведений о соединении, в том случае, когда подтвердит, что драйвер поддерживает с поддержкой пула подключений. После завершения использования дескриптора (но перед возвратом некоторые возвращают коды отличен от SQL_STILL_EXECUTING из [SQLDriverConnect](../../../odbc/reference/syntax/sqldriverconnect-function.md) или [SQLConnect](../../../odbc/reference/syntax/sqlconnect-function.md)), диспетчер драйверов, чтобы освободить дескриптор. Таким образом дескриптор создается после вызова SQLAllocHandle и уничтожается после вызова SQLFreeHandle. Диспетчер драйверов гарантирует перед тем как переключить его связанные HENV освободится дескриптор (когда [SQLDriverConnect](../../../odbc/reference/syntax/sqldriverconnect-function.md) или [SQLConnect](../../../odbc/reference/syntax/sqlconnect-function.md) возвращает сообщение об ошибке).  
  
 Драйвер следует изменить для приема новый дескриптор типа SQL_HANDLE_DBC_INFO_TOKEN следующие функции:  
  
1.  [SQLAllocHandle](../../../odbc/reference/syntax/sqlallochandle-function.md)  
  
2.  [SQLFreeHandle](../../../odbc/reference/syntax/sqlfreehandle-function.md)  
  
3.  [SQLGetDiagField](../../../odbc/reference/syntax/sqlgetdiagfield-function.md)  
  
4.  [SQLGetDiagRec](../../../odbc/reference/syntax/sqlgetdiagrec-function.md)  
  
 Диспетчер драйверов гарантирует, что несколько потоков не будет использовать том же дескрипторе SQL_HANDLE_DBC_INFO_TOKEN одновременно. Таким образом модель синхронизации этот дескриптор может быть очень простым, в драйвере. Диспетчер драйверов будут получает блокировку среды перед выделение и освобождение SQL_HANDLE_DBC_INFO_TOKEN.  
  
 Диспетчер драйверов **SQLAllocHandle** и **SQLFreeHandle** не будет принимать этот новый тип дескриптора.  
  
 SQL_HANDLE_DBC_INFO_TOKEN могут содержать конфиденциальные сведения, например учетные данные. Таким образом, драйвер должен безопасно очистить буфер памяти (с помощью [SecureZeroMemory](https://msdn.microsoft.com/library/windows/desktop/aa366877\(v=vs.85\).aspx)), содержащий конфиденциальную информацию перед тем как освободить этот дескриптор с **SQLFreeHandle**. При закрытии дескриптора среды приложения, все пулы связанное соединение будет закрыто.  
  
## <a name="driver-manager-connection-pool-rating-algorithm"></a>Оценка алгоритм пула соединений диспетчера драйверов  
 В этом разделе рассматриваются алгоритма оценки для организации пулов соединений диспетчера драйверов. Драйвер разработчики могут реализовывать один и тот же алгоритм для обеспечения обратной совместимости. Этот алгоритм может оказаться наиболее подходящий вариант. Следует уточнить это алгоритм на основе реализации (в противном случае нет причин для реализации этой возможности).  
  
 Диспетчер драйверов вернет целочисленных оценка от 0 до 100 для каждого подключения из пула. 0 означает, что нельзя использовать повторно, подключение и 100 указывает, соответствует прекрасно. Предположим, запрос на соединение называется hRequest и именем hCandidate существующее подключение из пула. Если любое из следующих условий равно false, hCandidate соединение в составе пула не может использоваться повторно для hRequest (диспетчера драйверов назначит оценка от 0).  
  
-   hCandidate, так и с помощью hRequest взяты из API ЮНИКОДА (например, SQLDriverConnectW) или API ANSI (например, SQLDriverConnectA). (Драйверы ЮНИКОДА можно поведение различных ANSI API и UNICODE API (см. в разделе атрибут соединения SQL_ATTR_ANSI_APP)).  
  
-   hCandidate и hRequest создаются по той функции; SQLDriverConnect или SQLConnect.  
  
-   Строка подключения, используемая для открытия hCandidate должен совпадать с hRequest, когда используется SQLDriverConnect.  
  
-   ServerName (или DSN), имя пользователя и пароль, используемый для открытия hCandidate должны быть одинаковыми, используемую для открытия hRequest при использовании SQLConnect.  
  
-   Идентификатор безопасности (SID) текущего потока должен совпадать с SID используется для открытия hCandidate.  
  
-   Для драйвера, требующее много ресурсов прикрепить и прикрепление (см. в обсуждении SQL_DTC_TRANSITION_COST в [SQLConnect](../../../odbc/reference/syntax/sqlconnect-function.md)), повторное использование *hRequest* не должно требовать дополнительной зачисление или unenlistment.  
  
 В следующей таблице показаны назначения оценку для различных сценариев.  
  
|Сравнение по атрибуты соединения между соединения и запроса|Не / unenlistment|Требуется дополнительный присоединение / Unenlistment|  
|---------------------------------------------------------------------------------------|-----------------------------------|----------------------------------------------|  
|Каталог (SQL_ATTR_CURRENT_CATALOG) отличается.|60|50|  
|Некоторые атрибуты соединения отличаются, но каталога совпадает с|90|70|  
|Все атрибуты соединения идеально соответствует|100|80|  
  
## <a name="sequence-diagram"></a>Диаграмма последовательностей  
 Это схема последовательностей показывает базовый механизм регулирования количества запросов, описанных в этом разделе. Он включает только использование [SQLDriverConnect](../../../odbc/reference/syntax/sqldriverconnect-function.md) , но [SQLConnect](../../../odbc/reference/syntax/sqlconnect-function.md) случай аналогичен.  
  
 ![Схема последовательностей](../../../odbc/reference/develop-driver/media/odbc_seq_dia.gif "odbc_seq_dia")  
  
## <a name="state-diagram"></a>Диаграмма состояния  
 Это Схема состояний показывает подключения токена объект сведения, описанные в этом разделе. На схеме показаны только [SQLDriverConnect](../../../odbc/reference/syntax/sqldriverconnect-function.md) , но [SQLConnect](../../../odbc/reference/syntax/sqlconnect-function.md) случай аналогичен. Поскольку диспетчер драйверов может потребоваться для обработки ошибок в любое время, можно вызвать диспетчер драйверов [SQLFreeHandle](../../../odbc/reference/syntax/sqlfreehandle-function.md) для любого штата.  
  
 ![Диаграмма состояния](../../../odbc/reference/develop-driver/media/odbc_state_diagram.gif "odbc_state_diagram")  
  
## <a name="see-also"></a>См. также  
 [Организация пулов соединений с учетом драйвера](../../../odbc/reference/develop-app/driver-aware-connection-pooling.md)   
 [Справочник по интерфейсу службы доступа (SPI) ODBC](../../../odbc/reference/syntax/odbc-service-provider-interface-spi-reference.md)
