---
title: Пулинг подключения менеджера драйверов (ru) Документы Майкрософт
ms.custom: ''
ms.date: 01/19/2017
ms.prod: sql
ms.prod_service: connectivity
ms.reviewer: ''
ms.technology: connectivity
ms.topic: conceptual
helpviewer_keywords:
- connection pooling [ODBC]
- pooled connections [ODBC]
- connecting to driver [ODBC], connection pooling
- connecting to data source [ODBC], connection pooling
ms.assetid: ee95ffdb-5aa1-49a3-beb2-7695b27c3df9
author: David-Engel
ms.author: v-daenge
ms.openlocfilehash: 84ccc0db8f9a54eecc8337ca5efbc7b4c4baa239
ms.sourcegitcommit: ce94c2ad7a50945481172782c270b5b0206e61de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/14/2020
ms.locfileid: "81305825"
---
# <a name="driver-manager-connection-pooling"></a>Организация пулов соединений диспетчера драйверов
Объединение соединения позволяет приложению использовать соединение из пула соединений, которые не нуждаются в восстановлении для каждого использования. После создания и размещения соединения в пуле приложение может повторно использовать это соединение без выполнения полного процесса подключения.  
  
 Использование объединенного соединения может привести к значительному повышению производительности, поскольку приложения могут сэкономить накладные расходы, связанные с подключением. Это может быть особенно важно для приложений среднего уровня, которые соединяются через сеть, или для приложений, которые постоянно подключаются и отключаются, например, для интернет-приложений.  
  
 В дополнение к повышению производительности архитектура объединения соединений позволяет использовать среду и связанные с ней соединения несколькими компонентами в одном процессе. Это означает, что автономные компоненты в одном процессе могут взаимодействовать друг с другом, не зная друг о друге. Соединение в пуле соединения может быть использовано повторно несколькими компонентами.  
  
> [!NOTE]
>  Объединение соединения может быть использовано приложением ODBC, демонстрирующим ODBC 2. *x* поведение, до тех пор, пока приложение может вызвать *S'LSetEnvAttr*. При использовании объединения соединений приложение не должно выполнять инструкции S'L, которые \<меняют базу данных или контекст базы данных, например, изменять *имя базы данных*>, что изменяет каталог, используемый источником данных.  


 Драйвер ODBC должен быть полностью безопасным для потоков, а соединения не должны иметь сродства потока для поддержки объединения соединений. Это означает, что драйвер может обрабатывать вызов на любой поток в любое время и может подключиться на одном потоке, использовать соединение на другом потоке, и отключить на третьем потоке.  
  
 Пул соединения поддерживается менеджером драйверов. Соединения натягиваются из пула, когда приложение вызывает **S'LConnect** или **S'LDriverConnect,** и возвращаются в пул, когда приложение вызывает **S'LDisconnect.** Размер пула динамично растет, в зависимости от запрошенных распределений ресурсов. Он сокращается в зависимости от тайм-аута бездействия: если соединение неактивно в течение определенного периода времени (оно не использовалось в соединении), оно удаляется из пула. Размер пула ограничен только ограничениями памяти и ограничениями на сервере.  
  
 Менеджер драйвера определяет, следует ли использовать конкретное соединение в пуле в соответствии с аргументами, переданными в **S'LConnect** или **S'LDriverConnect,** и в соответствии с атрибутами соединения, установленными после выделения соединения.  
  
 Когда менеджер драйвера объединяет соединения, он должен быть в состоянии определить, если соединение все еще работает, прежде чем раздавать соединение. В противном случае менеджер драйвера продолжает раздавать мертвое соединение с приложением всякий раз, когда происходит переходный сбой сети. Новый атрибут соединения был определен в ODBC 3 *.x*: SQL_ATTR_CONNECTION_DEAD. Это атрибут соединения только для чтения, который возвращает либо SQL_CD_TRUE, либо SQL_CD_FALSE. Значение SQL_CD_TRUE означает, что соединение было потеряно, в то время как значение SQL_CD_FALSE означает, что соединение по-прежнему активен. (Водители, соответствующие более ранним версиям ODBC, также могут поддерживать этот атрибут.)  
  
 Водитель должен эффективно реализовать эту опцию, иначе это ухудшит производительность объединения соединения. В частности, вызов для получения этого атрибута соединения не должен вызывать поездку туда и обратно на сервер. Вместо этого водитель должен просто вернуть последнее известное состояние соединения. Соединение мертво, если последняя поездка на сервер не удалось, и не мертв, если последняя поездка удалось.  
  
## <a name="remarks"></a>Remarks  
 Если соединение было потеряно (сообщается через SQL_ATTR_CONNECTION_DEAD), менеджер драйвера ODBC уничтожит это соединение, позвонив в драйвере. Новые запросы на подключение могут не найти применяемое соединение в пуле. В конце концов менеджер драйвера может сделать новое соединение, предполагая, что бассейн пуст.  
  
 Для использования пула подключений приложение выполняет следующие действия:  
  
1.  Позволяет объединить соединение, позвонив по **s'LSetEnvAttr,** чтобы настроить атрибут среды SQL_ATTR_CONNECTION_POOLING SQL_CP_ONE_PER_DRIVER или SQL_CP_ONE_PER_HENV. Этот вызов должен быть сделан до того, как приложение выделит общую среду, для которой должно быть включено объединение соединения. Ручка среды в вызове к **S'LSetEnvAttr** должна быть сведена к нулю, что делает SQL_ATTR_CONNECTION_POOLING атрибутом уровня процесса. Если атрибут настроен на SQL_CP_ONE_PER_DRIVER, для каждого драйвера поддерживается единый пул соединения. Если приложение работает со многими драйверами и несколькими средами, это может быть более эффективным, поскольку может потребоваться меньшее количество сравнений. Если установлено SQL_CP_ONE_PER_HENV, для каждой среды поддерживается единый пул соединения. Если приложение работает со многими средами и несколькими драйверами, это может быть более эффективным, поскольку может потребоваться меньшее количество сравнений. Объединение соединения отключено при установке SQL_ATTR_CONNECTION_POOLING на SQL_CP_OFF.  
  
2.  Распределяет среду, вызывая **s'LAllocHandle** с аргументом *HandleType,* установленным для SQL_HANDLE_ENV. Среда, выделенная этим вызовом, будет неявной общей средой, поскольку объединение соединений было включено. Среда, которая будет использоваться, не определяется, однако, до тех пор, пока **S'LAllocHandle** с *HandleType* SQL_HANDLE_DBC не будет вызван в эту среду.  
  
3.  Распределяет соединение, вызывая **S'LAllocHandle** с *набором InputHandle* для SQL_HANDLE_DBC, а *набор Вхотемкийк* на ручку среды, выделенную для объединения соединений. Диспетчер драйвера пытается найти существующую среду, которая соответствует атрибутам среды, установленным приложением. Если такой среды не существует, создается один, с отсчетом ссылки (поддерживается менеджером драйвера) 1. При обнаружении соответствующей общей среды среда возвращается в приложение и сравняется количество ссылок. (Фактическое соединение, используемое, не определяется менеджером драйвера до тех пор, пока не будет вызвано **соединение S'LConnect** или **S'LDriverConnect.)**  
  
4.  Для подключения вызывает **соединение sLConnect** или **S'LDriverConnect.** Менеджер драйвера использует параметры подключения в вызове к **S'LConnect** (или ключевые слова соединения в вызове к **S'LDriverConnect)** и атрибуты соединения, установленные после распределения соединения, чтобы определить, какое соединение в пуле должно быть использовано.  
  
    > [!NOTE]  
    >  Способ сопоставления запрашиваемого соединения с объединенным соединением определяется атрибутом среды SQL_ATTR_CP_MATCH. Для получения более [подробной](../../../odbc/reference/syntax/sqlsetenvattr-function.md)информации, см.  
  
     Приложения ODBC, использующие объединение соединений, должны вызывать [CoInitializeEx](https://go.microsoft.com/fwlink/?LinkID=116307) во время инициализации приложения и [coUninitialize](https://go.microsoft.com/fwlink/?LinkId=116310) при закрытии приложения.  
  
5.  Вызовы **S'LDisconnect,** когда сделано с подключением. Соединение возвращается в пул соединения и становится доступным для повторного использования.  
  
 Для углубленного обсуждения [см.](https://go.microsoft.com/fwlink/?LinkId=120776)  
  
## <a name="connection-pooling-considerations"></a>Соображения пулирования соединения  
 Выполнение любого из следующих действий с использованием команды S'L (а не через API ODBC) может повлиять на состояние соединения и вызвать неожиданные проблемы при активном объединении соединения:  
  
-   Открытие соединения и изменение базы данных по умолчанию.  
  
-   Использование оператора SET для изменения любых настраиваемых опций (включая SET ROWCOUNT, ANSI_NULL, IMPLICIT_TRANSACTIONS, SHOWPLAN, STATISTICS, TEXTSize и DATEFORMAT).  
  
-   Создание временных таблиц и сохраненных процедур.  
  
 Если любое из этих действий выполняется за пределами API ODBC, следующий человек, который использует соединение, автоматически унаследует предыдущие настройки, таблицы или процедуры.  
  
> [!NOTE]  
>  Не ожидайте, что определенные параметры будут присутствовать в состоянии соединения. Вы всегда должны установить состояние соединения в приложении и убедиться, что приложение удаляет все неиспользованные настройки объединения соединения.  
  
## <a name="driver-aware-connection-pooling"></a>Организация пулов соединений с учетом драйвера  
 Начиная с Windows 8, драйвер ODBC может использовать соединения в пуле более эффективно. Для получения дополнительной [Driver-Aware Connection Pooling](../../../odbc/reference/develop-app/driver-aware-connection-pooling.md)информации см.  
  
## <a name="see-also"></a>См. также:  
 [Подключение к источнику данных или драйверу](../../../odbc/reference/develop-app/connecting-to-a-data-source-or-driver.md)   
 [Разработка драйвера ODBC](../../../odbc/reference/develop-driver/developing-an-odbc-driver.md)   
 [Объединение компонентов доступа к данным Майкрософт](https://go.microsoft.com/fwlink/?LinkId=120776)
