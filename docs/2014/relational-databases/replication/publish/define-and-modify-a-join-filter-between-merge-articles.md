---
title: Определение и изменение фильтра соединения между статьями публикации слиянием | Документация Майкрософт
ms.custom: ''
ms.date: 06/30/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- filters [SQL Server replication], join
- merge replication join filters [SQL Server replication]
- modifying filters, join
- join filters
ms.assetid: f7f23415-43ff-40f5-b3e0-0be1d148ee5b
author: MashaMSFT
ms.author: mathoma
manager: craigg
ms.openlocfilehash: bf8b3b4f00ad2e8a3b9236292ee20948c852b6ef
ms.sourcegitcommit: b87d36c46b39af8b929ad94ec707dee8800950f5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2020
ms.locfileid: "68199558"
---
# <a name="define-and-modify-a-join-filter-between-merge-articles"></a>Определение и изменение фильтра соединения между статьями публикации слиянием
  В этом разделе описывается определение и изменение фильтра соединения между статьями публикации слиянием в [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] при помощи среды [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)] или [!INCLUDE[tsql](../../../includes/tsql-md.md)]. Репликация слиянием поддерживает фильтры соединения, которые обычно используются совместно с параметризованными фильтрами для распространения секционирования таблиц на все связанные статьи таблиц.  
  
 **В этом разделе**  
  
-   **Перед началом работы**  
  
     [Ограничения](#Restrictions)  
  
     [Рекомендации](#Recommendations)  
  
-   **Для определения и изменения фильтра соединений между статьями публикации слиянием используется:**  
  
     [Среда SQL Server Management Studio](#SSMSProcedure)  
  
     [Transact-SQL](#TsqlProcedure)  
  
##  <a name="BeforeYouBegin"></a> Перед началом  
  
###  <a name="Restrictions"></a> Ограничения  
  
-   Чтобы создать фильтр соединения, публикация должна содержать не менее двух связанных таблиц. Фильтр соединения расширяет фильтр строк, и поэтому следует задать фильтр строк для одной таблицы перед тем, как можно будет расширять фильтр соединением с другой таблицей. После того как будет определен один фильтр соединения, его можно расширить еще одним фильтром соединения, если публикация содержит другие связанные таблицы.  
  
-   Если добавление, изменение или удаление фильтра соединения выполняется после инициализации подписок на публикацию, следует создать новый моментальный снимок и повторно инициализировать все подписки после внесения изменений. Дополнительные сведения о требованиях к изменениям свойств см. в статье [Изменение свойств публикации и статьи](change-publication-and-article-properties.md).  
  
###  <a name="Recommendations"></a> Рекомендации  
  
-   Фильтры соединения можно создать вручную для набора таблиц, или же репликация может создать эти фильтры автоматически, основываясь на связях между внешними ключами и первичными ключами, заданных в таблицах. Дополнительные сведения об автоматическом создании набора фильтров соединения см. в статье [Автоматическое создание фильтров соединения между статьями публикации слиянием](automatically-generate-join-filters-between-merge-articles.md).  
  
##  <a name="SSMSProcedure"></a> Использование среды SQL Server Management Studio  
 Операции определения, изменения и удаления фильтров соединения выполняются на странице **Фильтрация строк таблицы** мастера создания публикаций или странице **Фильтрация строк** диалогового окна **Свойства публикации — \<публикация>**. Дополнительные сведения об использовании мастера и доступе к этому диалоговому окну см. в статьях [Создание публикации](create-a-publication.md) и [Просмотр и изменение свойств публикации](view-and-modify-publication-properties.md).  
  
#### <a name="to-define-a-join-filter"></a>Определение фильтра соединения  
  
1.  На странице **Фильтрация строк таблицы** мастера создания публикаций или странице **Фильтрация строк** диалогового окна **Свойства публикации — \<публикация>** выберите существующий фильтр строк или фильтр соединения в области **Отфильтрованные таблицы**.  
  
2.  Щелкните **Добавить**и выберите **Добавить соединение для расширения выбранного фильтра**.  
  
3.  Создайте инструкцию соединения: выберите либо **Использовать построитель для создания инструкции** , либо **Создать инструкцию соединения вручную**.  
  
    -   Если решено применить конструктор, то для создания инструкции соединения используйте столбцы в сетке (**Сопряжение**, **Фильтруемый столбец таблицы**, **Оператор**и **Столбец соединяемой таблицы**).  
  
         Каждый столбец в сетке содержит раскрывающееся поле со списком, позволяющее выбрать два столбца и оператор (**=**, **<>**, **<=**, **\<**, **>=**, **>** и **Like**). Результаты выводятся в текстовом поле **Предварительный просмотр** . Если в соединении участвует более двух столбцов, выберите логику (AND или OR) из столбца **Сопряжение** , а затем введите еще два столбца и оператор.  
  
    -   Если нужно написать инструкцию вручную, введите ее в текстовом поле **Инструкция соединения** . Используйте списки **Столбцы фильтруемой таблицы** и **Столбцы соединяемой таблицы** , перетягивая из них поля в текстовое поле **Инструкция соединения** .  
  
    -   Полная инструкция соединения будет выглядеть таким образом:  
  
        ```  
        SELECT <published_columns> FROM [Sales].[SalesOrderHeader] INNER JOIN [Sales].[SalesOrderDetail] ON [SalesOrderHeader].[SalesOrderID] = [SalesOrderDetail].[SalesOrderID]  
        ```  
  
         В предложении JOIN необходимо использовать имена, состоящие их двух частей; имена, состоящие из трех и четырех частей не поддерживаются.  
  
4.  Задайте параметры соединения.  
  
    -   Если столбец, по которому производится соединение в отфильтрованной таблице (родительской таблице), уникален, выберите **Уникальный ключ**.  
  
        > [!CAUTION]  
        >  Выбор этого параметра указывает, что связь между дочерней и родительской таблицей в фильтре соединения — «одна к одной» или «одна к нескольким». Устанавливайте этот параметр, лишь если на объединяющий столбец в дочерней таблице наложено ограничение, гарантирующее уникальность. Если параметр задан неправильно, может возникнуть потеря конвергенции данных.  
  
    -   По умолчанию во время синхронизации процесс репликации слиянием обрабатывает изменения построчно. Чтобы связанные изменения в строках обеих фильтруемых таблиц и соединяемой таблицы обрабатывались как единое целое, выберите[!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] пункт **логическая запись** (только в и более поздних версиях). Этот параметр доступен, только если удовлетворяются требования статьи и публикации на использование логических записей. Дополнительные сведения см. в подразделе "вопросы использования логических записей" раздела [изменение групп в связанных строках с логическими записями](../merge/group-changes-to-related-rows-with-logical-records.md).  
  
5.  [!INCLUDE[clickOK](../../../includes/clickok-md.md)]  
  
6.  Если вы находитесь в диалоговом окне **Свойства публикации — \<публикация>** , нажмите кнопку **ОК**, чтобы сохранить изменения и закрыть диалоговое окно.  
  
#### <a name="to-modify-a-join-filter"></a>Изменение фильтра соединения  
  
1.  На странице **Фильтрация строк таблицы** мастера создания публикаций или странице **Фильтрация строк** диалогового окна **Свойства публикации — \<Публикация>** выберите фильтр в области **Отфильтрованные таблицы**, а затем нажмите кнопку **Изменить**.  
  
2.  В окне **Изменить соединение** измените фильтр.  
  
3.  [!INCLUDE[clickOK](../../../includes/clickok-md.md)]  
  
#### <a name="to-delete-a-join-filter"></a>Удаление фильтра соединения  
  
1.  На странице **Фильтрация строк таблицы** мастера создания публикаций или странице **Фильтрация строк** диалогового окна **Свойства публикации — \<публикация>** выберите фильтр в области **Отфильтрованные таблицы**, а затем нажмите кнопку **Удалить**. Если удаляемый фильтр соединения расширен за счет других фильтров, эти фильтры также будут удалены.  
  
##  <a name="TsqlProcedure"></a> Использование Transact-SQL  
 Эти процедуры демонстрируют совместное использование параметризованного фильтра родительской статьи с фильтрами соединения связанных с ней дочерних статей. Фильтры соединения могут создаваться программным путем с помощью хранимых процедур репликации.  
  
#### <a name="to-define-a-join-filter-to-extend-an-article-filter-to-related-articles-in-a-merge-publication"></a>Определение фильтра соединения для распространения фильтра статьи на связанные с ней статьи в публикации слиянием  
  
1.  Определите параметры фильтрации статьи, к которой производится присоединение (она также называется родительской статьей).  
  
    -   Дополнительные сведения о фильтрации статьи при помощи параметризованного фильтра строк см. в разделе [Определение и изменение параметризованного фильтра строк для статьи публикации слиянием](define-and-modify-a-parameterized-row-filter-for-a-merge-article.md).  
  
    -   Дополнительные сведения о фильтрации статьи с помощью статического строкового фильтра см. в разделе [Define and Modify a Static Row Filter](define-and-modify-a-static-row-filter.md).  
  
2.  Чтобы определить связанные с публикацией статьи (которые также называют дочерними), в базе данных публикации на издателе выполните хранимую процедуру [sp_addmergearticle (Transact-SQL)](/sql/relational-databases/system-stored-procedures/sp-addmergearticle-transact-sql). Дополнительные сведения см. в статье [определить статью](define-an-article.md).  
  
3.  На издателе в базе данных публикации выполните хранимую процедуру [sp_addmergefilter (Transact-SQL)](/sql/relational-databases/system-stored-procedures/sp-addmergefilter-transact-sql). Укажите **@publication**уникальное имя для этого фильтра **@filtername**для, имя дочерней статьи, созданной в шаге 2 для **@article**, имя родительской статьи, к которой присоединяется **@join_articlename**, и одно из следующих значений для: **@join_unique_key**  
  
    -   **0** — указывает соединение типа «многие к одному» или «многие ко многим» между родительской и дочерними статьями.  
  
    -   **1** — указывает соединение "один к одному" или "один ко многим" между родительской и дочерней статьями.  
  
     Таким образом определяется используемый фильтр соединения двух статей.  
  
    > [!CAUTION]  
    >  Значение 1 **@join_unique_key** устанавливается **** только в том случае, если имеется ограничение на соединяемый столбец в базовой таблице для родительской статьи, что гарантирует уникальность. Если **@join_unique_key** задано значение **1** неправильно, может произойти неконвергенция данных.  
  
###  <a name="TsqlExample"></a>Примеры (Transact-SQL)  
 В следующем примере производится определение статьи для публикации слиянием, где статья таблицы `SalesOrderDetail` фильтруется по таблице `SalesOrderHeader` , для фильтрации которой, в свою очередь, используется статический строковый фильтр. Дополнительные сведения см. в статье [Define and Modify a Static Row Filter](define-and-modify-a-static-row-filter.md).  
  
 [!code-sql[HowTo#sp_AddMergeArticle](../../../snippets/tsql/SQL15/replication/howto/tsql/createmergepub.sql#sp_addmergearticle)]  
  
 В следующем примере определяется группа статей в публикации слиянием, где производится фильтрация статей с помощью набора фильтров соединения по таблице `Employee` , для фильтрации которой, в свою очередь, используется параметризованный фильтр строк по значению параметра [HOST_NAME](/sql/t-sql/functions/host-name-transact-sql) в столбце **LoginID** . Дополнительные сведения см. в статье [Определение и изменение параметризованного фильтра строк для статьи публикации слиянием](define-and-modify-a-parameterized-row-filter-for-a-merge-article.md).  
  
 [!code-sql[HowTo#sp_MergeDynamicPub1](../../../snippets/tsql/SQL15/replication/howto/tsql/createmergepubdynamic1.sql#sp_mergedynamicpub1)]  
  
## <a name="see-also"></a>См. также:  
 [Фильтры соединений](../merge/join-filters.md)   
 [Параметризованные фильтры строк](../merge/parameterized-filters-parameterized-row-filters.md)   
 [Изменение свойств публикации и статьи](change-publication-and-article-properties.md)   
 [Фильтрация опубликованных данных для репликации слиянием](../merge/filter-published-data-for-merge-replication.md)   
 [Основные понятия системных хранимых процедур репликации](../concepts/replication-system-stored-procedures-concepts.md)   
 [Определение связи логических записей между статьями таблиц слияния](define-a-logical-record-relationship-between-merge-table-articles.md)   
 [Определение и изменение параметризованного фильтра строк для статьи публикации слиянием](define-and-modify-a-parameterized-row-filter-for-a-merge-article.md)  
  
  
