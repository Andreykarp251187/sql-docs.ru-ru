---
title: SQL Server файлы данных в Windows Azure | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: supportability
ms.topic: conceptual
ms.assetid: 38ffd9c2-18a5-43d2-b674-e425addec4e4
author: MikeRayMSFT
ms.author: mikeray
manager: craigg
ms.openlocfilehash: 36d940e71dc6a5816dc08fb79e045f46f783116e
ms.sourcegitcommit: 9348f79efbff8a6e88209bb5720bd016b2806346
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/14/2019
ms.locfileid: "69028623"
---
# <a name="sql-server-data-files-in-windows-azure"></a>Файлы данных SQL Server в Windows Azure
  Файлы данных SQL Server в Windows Azure включают встроенную поддержку файлов баз данных SQL Server, которые хранятся в виде больших двоичных объектов Windows Azure. Компонент позволяет создать базу данных в SQL Server, выполняемом локально или на виртуальной машине в Windows Azure, с назначенным местом хранения для данных в хранилище данных большого двоичного объекта Windows Azure. Это усовершенствование значительно упрощает перемещение баз данных между компьютерами с помощью операций отсоединения и присоединения. Кроме того, этот компонент предоставляет альтернативное расположение для хранения файлов резервных копий баз данных, позволяя выполнять восстановление из хранилища Windows Azure и в него. Поэтому он обеспечивает возможность реализации нескольких гибридных решений, предоставляя ряд преимуществ для виртуализации данных, перемещения данных, безопасности и доступности, а также достижения снижения затрат и обслуживания для высокого уровня доступности и эластичного масштабирования.  
  
 В данном разделе представлены основные понятия и рекомендации, необходимые для хранения файлов данных SQL Server в службе хранилища Windows Azure.  
  
 Практические рекомендации по использованию этой функции см. в статье [Учебник. SQL Server файлы данных в службе](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md)хранилища Windows Azure.  
  
 На следующем рисунке показано, что этот компонент позволяет хранить файлы базы данных SQL Server в виде больших двоичных объектов Windows Azure в хранилище Windows Azure независимо от того, где находится сервер.  
  
 ![Интеграция SQL Server с хранилищем Windows Azure](../../database-engine/media/sql-server-dbfiles-stored-as-blobs.gif "Интеграция SQL Server с хранилищем Windows Azure")  
  
## <a name="benefits-of-using-sql-server-data-files-in-windows-azure"></a>Преимущества использования файлов данных SQL Server в Windows Azure  
  
-   **Преимущества простой и быстрой миграции.** Эта функция упрощает процесс миграции, перемещая одну базу данных за один раз между локальными компьютерами и между локальной и облачной средой без внесения каких-либо изменений в приложения. Поэтому он поддерживает добавочную миграцию, сохраняя при этом без изменений существующую локальную инфраструктуру. Кроме того, наличие доступа к централизованному хранилищу данных позволяет упростить логику приложения, когда приложение необходимо выполнять в нескольких местах в локальной среде. В некоторых случаях может потребоваться быстро настроить вычислительные центры, которые собирают данные из множества различных источников, в географически удаленных друг от друга местах. С помощью этого нового компонента вместо переноса данных из одного места в другое можно сохранять несколько баз данных в виде больших двоичных объектов Windows Azure, а затем выполнять скрипты Transact-SQL для создания баз данных на локальных компьютерах или виртуальных машинах.  
  
-   **Преимущества низких затрат и неограниченного хранилища.** Эта функция позволяет иметь неограниченное хранилище неограниченного объема в Windows Azure при использовании локальных ресурсов вычислений. При использовании Windows Azure в качестве места хранения можно сконцентрироваться на проработке логики приложения, не обращая внимания на издержки, связанные с управлением оборудованием. Если любой локальный вычислительный узел выходит из строя, можно настроить новый без перемещения каких-либо данных.  
  
-   **Преимущества высокого уровня доступности и аварийного восстановления.** Использование SQL Server файлов данных в компоненте Windows Azure может упростить решения для обеспечения высокого уровня доступности и аварийного восстановления. Например, в случае выхода из строя виртуальной машины в Windows Azure или экземпляра SQL Server можно будет повторно создать базы данных на новом компьютере, просто восстановив ссылки на большие двоичные объекты Windows Azure.  
  
-   **Преимущества для безопасности.** Этот новый компонент позволяет вам разделять вычислительный экземпляр от экземпляра хранилища. Кроме того, можно настроить полностью зашифрованную базу данных, расшифровка которой будет происходить только в вычислительном экземпляре, а не в экземпляре хранилища. Другими словами, с помощью этого нового компонента можно шифровать все данные в общедоступном облаке с использованием сертификатов TDE (Transparent Data Encryption), которые физически отделены от данных. Ключи шифрования TDE могут храниться в базе данных master, которая размещена локально на физически безопасном локальном компьютере с локальным резервным копированием. Можно использовать эти локальные ключи для шифрования данных, которые находятся в хранилище Windows Azure. Если учетные данные учетной записи облачного хранилища украдены, данные останутся защищенными, поскольку сертификаты TDE всегда находятся на локальном компьютере.  
  
## <a name="concepts-and-requirements"></a>Основные понятия и требования  
  
### <a name="windows-azure-storage-concepts"></a>Основные понятия хранилища Windows Azure  
 При использовании компонента SQL Server Data Files в Windows Azure необходимо создать учетную запись хранилища и контейнер в Windows Azure. Затем необходимо создать учетные данные SQL Server, которые включают сведения о политике контейнера, а также подпись общего доступа, необходимую для доступа к контейнеру.  
  
 В Windows Azure учетная запись хранилища представляет наивысший уровень пространства имен для доступа к большим двоичным объектам. Учетная запись хранилища может содержать неограниченное количество контейнеров при условии, что их общий размер не превышает 500 ТБ. Последнюю информацию относительно ограничений хранилища смотрите в [Подписка и Ограничения Хранилища Azure, Квоты и Ограничения](https://azure.microsoft.com/documentation/articles/azure-subscription-service-limits/). Контейнер группирует набор больших двоичных объектов. Все большие двоичные объекты должны находиться в контейнере. Учетная запись может содержать неограниченное количество контейнеров. В контейнере также может храниться неограниченное количество больших двоичных объектов. Существует два типа больших двоичных объектов, которые можно хранить в хранилище Windows Azure: блочные и страничные. Этот новый компонент использует страничные большие двоичные объекты, размер которых может быть до 1 ТБ и которые являются более эффективными в тех случаях, когда диапазоны байтов в файле часто изменяются. К большим двоичным объектам можно обращаться по URL-адресам в следующем формате: `http://storageaccount.blob.core.windows.net/<container>/<blob>`.  
  
### <a name="windows-azure-billing-considerations"></a>Вопросы оплаты использования Windows Azure  
 Оценка затрат на использование служб Windows Azure — это важный вопрос, который необходимо учитывать в процессе принятия решения и планирования. При хранении файлов данных SQL Server в хранилище Windows Azure оплачивается стоимость использования хранилища и выполнения транзакций. Кроме того, реализация компонента SQL Server Data Files в службе хранилища Windows Azure требует неявного возобновления аренды большого двоичного объекта каждые 45–60 секунд. При этом также возникают затраты на транзакции для каждого файла базы данных, например, MDF или LDF. По нашим оценкам в соответствии с текущей моделью расценок стоимость продления аренды для двух файлов базы данных (MDF и LDF) составит около двух центов в месяц. Рекомендуется использовать информацию на странице [Тарифы Azure](https://azure.microsoft.com/pricing/) для оценки ежемесячных затрат, связанных с использованием хранилища Microsoft Azure и виртуальных машин Microsoft Azure.  
  
### <a name="sql-server-concepts"></a>Основные понятия SQL Server  
 При использовании этого нового компонента необходимо выполнить следующие действия.  
  
-   Необходимо создать политику для контейнера, а также сформировать ключ подписи общего доступа.  
  
-   Для каждого контейнера, используемого файлом данных или журнала, необходимо создать учетные данные SQL Server, имя которых соответствует пути контейнера.  
  
-   Необходимо хранить сведения о контейнере хранилища Windows Azure, связанную с ним политику и ключ SAS в хранилище учетных данных SQL Server.  
  
 В следующем примере предполагается, что контейнер хранилища Windows Azure создан, а политика имеет права на запись, чтение и перечисление. При создании политики для контейнера формируется ключ SAS, который безопасно размещать в памяти в незашифрованном виде. SQL Server использует этот ключ для доступа к файлам больших двоичных объектов в контейнере. В следующем фрагменте кода замените `'your SAS key'` на запись следующего вида: `'sr=c&si=<MYPOLICYNAME>&sig=<THESHAREDACCESSSIGNATURE>'`. Дополнительные сведения см. [в разделе Создание и использование подписанного URL-доступа](https://msdn.microsoft.com/library/azure/jj721951.aspx) .  
  
```  
  
-- Create a credential  
CREATE CREDENTIAL [https://testdb.blob.core.windows.net/data]  
WITH IDENTITY='SHARED ACCESS SIGNATURE',  
SECRET = 'your SAS key'  
  
-- Create database with data and log files in Windows Azure container.  
CREATE DATABASE testdb   
ON  
( NAME = testdb_dat,  
    FILENAME = 'https://testdb.blob.core.windows.net/data/TestData.mdf' )  
 LOG ON  
( NAME = testdb_log,  
    FILENAME =  'https://testdb.blob.core.windows.net/data/TestLog.ldf')  
  
```  
  
 **Важное примечание.** Если в контейнере имеются любые активные ссылки на файлы данных, попытки удаления соответствующих учетных данных SQL Server заканчиваются сбоем.  
  
### <a name="security"></a>Безопасность  
 При хранении файлов данных SQL Server в хранилище Windows Azure необходимо учитывать следующие требования и вопросы безопасности.  
  
-   При создании контейнера для службы хранилища больших двоичных объектов Windows Azure рекомендуется установить для него закрытые права доступа. При выборе частного типа доступа данные контейнера и больших двоичных объектов могут быть прочитаны только владельцем учетной записи Windows Azure.  
  
-   При хранении файлов базы данных SQL Server в хранилище Windows Azure необходимо использовать подпись общего доступа (URI, который предоставляет ограниченные права доступа к контейнерам, большим двоичным объектам, очередям и таблицам). С помощью подписи общего доступа можно обеспечить SQL Server возможность доступа к ресурсам из учетной записи без предоставления доступа к ключу учетной записи хранилища Windows Azure.  
  
-   Кроме того, рекомендуется продолжать использовать стандартные методы обеспечения безопасности локальных баз данных.  
  
### <a name="installation-prerequisites"></a>Компоненты, необходимые для установки  
 Далее приведены обязательные компоненты, которые необходимы при хранении файлов данных SQL Server в Windows Azure.  
  
-   **Локальный SQL Server.** Версия SQL Server 2014 включает эту функцию. Чтобы узнать, как загрузить SQL Server 2014, см. раздел [SQL Server 2014](https://www.microsoft.com/sqlserver/sql-server-2014.aspx).  
  
-   SQL Server, выполняющихся на виртуальной машине Windows Azure: Если вы устанавливаете SQL Server на виртуальную машину Windows Azure, установите SQL Server 2014 или обновите существующий экземпляр. Также можно создать новую виртуальную машину в Windows Azure с помощью образа платформы SQL Server 2014. Чтобы узнать, как загрузить SQL Server 2014, см. раздел [SQL Server 2014](https://www.microsoft.com/sqlserver/sql-server-2014.aspx).  
  
###  <a name="bkmk_Limitations"></a> Ограничения  
  
-   В текущем выпуске этого компонента хранение данных `FileStream` в хранилище Windows Azure не поддерживается. Данные `Filestream` можно хранить в локальной базе данных, интегрированной в хранилище Windows Azure, но нельзя перемещать данные Filestream между компьютерами с помощью хранилища Windows Azure. Для данных типа `FileStream` рекомендуется продолжать использовать стандартные методы переноса файлов MDF и LDF, связанных с Filestream, между разными компьютерами.  
  
-   В настоящее время этот новый модуль не поддерживает одновременный доступ нескольких экземпляров SQL Server к одним и тем же файлам базы данных в хранилище Windows Azure. Если ServerA находится в сети с активным файлом базы данных, а ServerB будет случайно запущен и при этом на нем тоже есть база данных, указывающая на тот же файл данных, второй сервер не сможет запустить базу данных и вернет код ошибки **5120. Не удается открыть физический файл "%.\*ls". Ошибка операционной системы %d: "%ls"** .  
  
-   Только MDF-, LDF и NDF-файлы могут храниться в хранилище Windows Azure с использованием компонента SQL Server Data Files в Windows Azure.  
  
-   При использовании компонента SQL Server Data Files в Windows Azure георепликация для учетной записи не поддерживается. Если в учетной записи работает георепликация и была выполнена географическая отработка отказа, может произойти повреждение базы данных.  
  
-   Размер каждого большого двоичного объекта может быть вплоть до 1 ТБ. Это значение формирует верхний предел для отдельных файлов данных и файлов журнала базы данных, которые могут храниться в хранилище Windows Azure.  
  
-   Невозможно сохранить данные In-Memory OLTP в большом двоичном объекте Windows Azure с помощью компонента SQL Server Data Files в Windows Azure. Это происходит потому, что In-Memory OLTP зависит от `FileStream` и в текущем выпуске этого компонента, хранение данных `FileStream` в хранилище Windows Azure не поддерживается.  
  
-   При использовании компонента SQL Server Data Files в Windows Azure SQL Server выполняет все сравнения URL-адресов или путей к файлам с помощью параметров сортировки в базе данных `master`.  
  
-   `AlwaysOn Availability Groups` поддерживается до тех пор, пока в основную базу данных не будут добавлены новые файлы базы данных. Если для выполнения операции базы данных требуется создание нового файла в базе данных-источнике, сначала отключите группы доступности AlwaysOn на вторичном узле. Затем выполните операцию базы данных в базе данных-источнике и создайте резервную копию базы данных на основном узле. Затем восстановите базу данных на вторичный узел и включите группы доступности AlwaysOn на вторичном узле. Обратите внимание, что экземпляры отказоустойчивого кластера AlwaysOn при использовании компонента SQL Server Data Files в Windows Azure не поддерживаются.  
  
-   При обычной работе SQL Server использует временные аренды, чтобы зарезервировать большие двоичные объекты для хранения с возобновлением аренды каждого большого двоичного объекта каждые 45–60 секунд. Если происходит сбой сервера и запускается другой экземпляр SQL Server, который настроен для использования тех же больших двоичных объектов, новый экземпляр будет ждать окончания аренды для большого двоичного объекта вплоть до 60 секунд. Если необходимо присоединить базу данных к другому экземпляру и ждать окончания срока аренды в течение 60 секунд невозможно, то можно явно прервать аренду большого двоичного объекта, чтобы избежать сбоев операций присоединения.  
  
## <a name="tools-and-programming-reference-support"></a>Средства и справочник по программированию  
 В этом разделе описаны средства и библиотеки справочных материалов по программированию, которые можно использовать при хранении файлов данных SQL Server в службе хранилища Windows Azure.  
  
### <a name="powershell-support"></a>Поддержка PowerShell  
 В выпуске SQL Server 2014 можно использовать командлеты PowerShell для хранения файлов данных SQL Server в службе хранилища больших двоичных объектов Windows Azure, указывая URL-адрес хранилища вместо пути к файлу. К большим двоичным объектам можно обращаться по URL-адресам в следующем формате`: http://storageaccount.blob.core.windows.net/<container>/<blob>` .  
  
### <a name="sql-server-object-and-performance-counters-support"></a>Объект SQL Server и поддержка счетчиков производительности  
 Начиная с SQL Server 2014, добавлен новый объект SQL Server для использования с компонентом SQL Server Data Files в службе хранилища Windows Azure. Новый объект SQL Server вызывается как [SQL Server, HTTP_STORAGE_OBJECT](../performance-monitor/sql-server-http-storage-object.md) и может использоваться системным монитором для отслеживания действий, выполняемых при работе SQL Server со службой хранилища Microsoft Azure.  
  
### <a name="sql-server-management-studio-support"></a>Поддержка среды SQL Server Management Studio  
 Среда SQL Server Management Studio позволяет использовать этот компонент с помощью нескольких диалоговых окон. Например, можно ввести URL-адрес контейнера хранилища, скажем, `https://teststorageaccnt.blob.core.windows.net/testcontainer/` в поле **Путь** в нескольких разных диалоговых окнах ( **Создание базы данных**, **Присоединение базы данных**и **Восстановление базы данных**). Дополнительные сведения см. в статье [Руководство SQL Server файлы данных в службе](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md)хранилища Windows Azure.  
  
### <a name="sql-server-management-objects-support"></a>Поддержка управляющих объектов SQL Server  
 При использовании компонента SQL Server Data Files в Microsoft Azure поддерживаются все управляющие объекты SQL Server (SMO). Если объект SMO требует пути к файлам, вместо локального пути используйте формат URL-адреса большого двоичного объекта, например `https://teststorageaccnt.blob.core.windows.net/testcontainer/`. Дополнительные сведения об управляющих объектах SQL Server (SMO) см. в разделе [Учебник по программированию управляющих объектов SQL Server (SMO)](../server-management-objects-smo/sql-server-management-objects-smo-programming-guide.md) электронной документации по SQL Server.  
  
### <a name="transact-sql-support"></a>Поддержка Transact-SQL  
 Этот новый компонент внес следующие изменения в контактную зону Transact-SQL:  
  
-   Новый столбец **int** , **credential_id**, в системном представлении **sys.master_files** . Столбец **credential_id** используется для обеспечения указания перекрестных ссылок на файлы данных из хранилища Azure назад в представление sys.credentials для учетных данных, созданных для них. Это можно использовать для устранения неполадок, например, когда невозможно удалить учетные данные при наличии файла базы данных, который использует их.  
  
##  <a name="bkmk_Troubleshooting"></a>Устранение неполадок в файлах данных SQL Server в Windows Azure  
 Для избежания ошибок в связи с не поддерживаемыми функциями или ограничениями, обратитесь сначала к [Limitations](sql-server-data-files-in-microsoft-azure.md#bkmk_Limitations).  
  
 Далее приведен список ошибок, которые могут быть получены при использовании SQL Server Data Files в службе хранилища Windows Azure.  
  
 **Ошибки проверки подлинности**  
  
-   *Невозможно удалить учетные данные "%.\*ls", так как они используются активным файлом базы данных.*    
    Решение. Эта ошибка может возникать при попытке удалить учетные данные, которые по-прежнему используются активным файлом базы данных в хранилище Windows Azure. Чтобы удалить учетные данные, необходимо сначала удалить сопоставленный большой двоичный объект, которому принадлежит этот файл базы данных. Чтобы удалить большой двоичный объект с активной арендой, сначала необходимо прервать аренду.  
  
-   *Подписанный URL-адрес был создан в контейнере неправильно.*    
     Решение. Убедитесь, что вы создали подпись общего доступа для контейнера правильно. Ознакомьтесь с инструкциями, приведенными в занятии 2 в [руководстве по SQL Server файлы данных в службе](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md)хранилища Windows Azure.  
  
-   *Учетные данные SQL Server созданы неправильно.*    
    Решение. Убедитесь, что в поле **Идентификатор** указано значение "Подписанный URL-адрес" и секрет сформирован правильно. Ознакомьтесь с инструкциями, приведенными в занятии 3 в [руководстве по SQL Server файлы данных в службе](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md)хранилища Windows Azure.  
  
 **Ошибки аренды больших двоичных объектов**  
  
-   Ошибка при попытке запустить SQL Server после сбоя другого экземпляра, использующего те же файлы больших двоичных объектов. Решение. При обычной работе SQL Server использует временные аренды, чтобы зарезервировать большие двоичные объекты для хранения с возобновлением аренды каждого большого двоичного объекта каждые 45–60 секунд. Если происходит сбой сервера и запускается другой экземпляр SQL Server, который настроен для использования тех же больших двоичных объектов, новый экземпляр будет ждать окончания аренды для большого двоичного объекта вплоть до 60 секунд. Если необходимо присоединить базу данных к другому экземпляру и ждать окончания срока аренды в течение 60 секунд невозможно, то можно явно прервать аренду большого двоичного объекта, чтобы избежать сбоев операций присоединения.  
  
 **Ошибки базы данных**  
  
1.  *Ошибка создания базы данных*   
    Решение. Ознакомьтесь с инструкциями, приведенными в занятии 4 в [руководстве по SQL Server файлы данных в службе](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md)хранилища Windows Azure.  
  
2.  *Ошибки при выполнении инструкции Alter*   
    Решение. Инструкцию Alter необходимо выполнять, когда база данных находится в режиме "в сети". При копировании файлов данных в хранилище Windows Azure всегда создавайте страничный большой двоичный объект. В противном случае инструкция ALTER для базы данных завершится ошибкой. Ознакомьтесь с инструкциями, приведенными в занятии 7 в [руководстве по SQL Server файлы данных в службе](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md)хранилища Windows Azure.  
  
3.  \*Код ошибки 5120. Не удалось открыть физический файл "%.*ls". Ошибка операционной системы %d: "%ls"*    
    Решение. В настоящее время этот новый модуль не поддерживает одновременный доступ нескольких экземпляров SQL Server к одним и тем же файлам базы данных в хранилище Windows Azure. Если ServerA находится в сети с активным файлом базы данных, а ServerB будет случайно запущен и при этом на нем тоже есть база данных, указывающая на тот же файл данных, второй сервер не сможет запустить базу данных и вернет код ошибки *5120. Не удается открыть физический файл "%.\*ls". Ошибка операционной системы %d: "%ls"* .  
  
     Чтобы устранить эту проблему, необходимо сначала определить, есть ли у ServerA доступ к файлу базы данных, который находится в хранилище Windows Azure. Если нет, просто удалите все связи между ServerA и файлами базы данных из хранилища Windows Azure. Для этого выполните следующие шаги.  
  
    1.  С помощью инструкции ALTER установите для ServerA пути к файлам из локальных папок.  
  
    2.  Переведите базу данных на ServerA в режим «вне сети».  
  
    3.  Затем скопируйте файлы базы данных из хранилища Windows Azure в локальную папку на ServerA. Это гарантирует, что ServerA по-прежнему будет иметь локальную копию базы данных.  
  
    4.  Переведите базу данных в режим «в сети».  
  
## <a name="see-also"></a>См. также  
 [Учебник. SQL Server файлы данных в службе хранилища Windows Azure](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md)  
  
  
