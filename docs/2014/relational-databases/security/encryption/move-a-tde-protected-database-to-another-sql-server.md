---
title: Перемещение базы данных, защищаемой прозрачным шифрованием, в другой экземпляр SQL Server | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: security
ms.topic: conceptual
helpviewer_keywords:
- Transparent Data Encryption, moving
- TDE, moving a database
ms.assetid: fb420903-df54-4016-bab6-49e6dfbdedc7
author: jaszymas
ms.author: jaszymas
manager: craigg
ms.openlocfilehash: 748ad4cfe0e399062fd1b13bcf3a05169ef94b1c
ms.sourcegitcommit: 39ea690996a7390e3d13d6fb8f39d8641cd5f710
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/10/2019
ms.locfileid: "74957173"
---
# <a name="move-a-tde-protected-database-to-another-sql-server"></a>Переместить базу данных, защищаемую прозрачным шифрованием, в другой экземпляр SQL Server
  В этом разделе описано, как защитить базу данных с применением прозрачного шифрования данных и переместить базу данных в другой экземпляр [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] с помощью [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)] или [!INCLUDE[tsql](../../../includes/tsql-md.md)]. TDE выполняет шифрование операций ввода-вывода в режиме реального времени, а также расшифровку файлов данных и журналов. Шифрование использует ключ шифрования базы данных (DEK), который хранится в загрузочной записи базы данных для обеспечения доступности во время восстановления. Ключ шифрования базы данных является симметричным ключом, защищенным сертификатом, который хранится в базе данных `master` на сервере, или асимметричным ключом, защищенным модулем расширенного управления ключами.  
  
 **В этом разделе**  
  
-   **Перед началом работы**  
  
     [Ограничения](#Restrictions)  
  
     [Бюллетеня](#Security)  
  
-   **Для создания базы данных, защищенной с помощью прозрачного шифрования данных, используется:**  
  
     [SQL Server Management Studio](#SSMSCreate)  
  
     [Язык Transact-SQL](#TsqlCreate)  
  
-   **Перемещение базы данных с помощью:**  
  
     [SQL Server Management Studio](#SSMSMove)  
  
     [Язык Transact-SQL](#TsqlMove)  
  
##  <a name="BeforeYouBegin"></a>Перед началом  
  
###  <a name="Restrictions"></a>Ограничения  
  
-   В случае перемещения базы данных, защищаемой прозрачным шифрованием, также необходимо переместить сертификат или асимметричный ключ, который служит для открытия ключа шифрования базы данных. Сертификат или асимметричный ключ должен быть установлен в `master` базе данных целевого сервера, чтобы [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] иметь доступ к файлам базы данных. Дополнительные сведения см. в статье [Прозрачное шифрование данных (TDE)](transparent-data-encryption.md).  
  
-   Для восстановления сертификата необходимо хранить копии файла сертификата и файла закрытого ключа. Пароль для закрытого ключа не обязательно должен совпадать с паролем главного ключа базы данных.  
  
-   [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]хранит файлы, созданные здесь, в папке **C:\Program FILES\MICROSOFT SQL Server\MSSQL12. МССКЛСЕРВЕР\МССКЛ\ДАТА** по умолчанию. В других системах имена и расположения файлов могут быть иными.  
  
###  <a name="Security"></a>Бюллетеня  
  
####  <a name="Permissions"></a>Чтение  
  
-   Для `CONTROL DATABASE` создания главного ключа `master` базы данных требуется разрешение в базе данных.  
  
-   Для `CREATE CERTIFICATE` создания сертификата, `master` защищающего DEK, требуется разрешение в базе данных.  
  
-   Требуется разрешение `CONTROL DATABASE` в зашифрованной базе данных и разрешение `VIEW DEFINITION` на сертификат или асимметричный ключ, используемый для шифрования ключа шифрования базы данных.  
  
##  <a name="SSMSProcedure"></a>Создание базы данных, защищенной с помощью прозрачного шифрования данных  
  
###  <a name="SSMSCreate"></a>Использование SQL Server Management Studio  
  
1.  Создайте главный ключ базы данных и сертификат в `master` базе данных. Дополнительные сведения см. в статье **Использование Transact-SQL** ниже.  
  
2.  Создайте резервную копию сертификата сервера в `master` базе данных. Дополнительные сведения см. в статье **Использование Transact-SQL** ниже.  
  
3.  В обозревателе объектов щелкните правой кнопкой мыши папку **Базы данных** и выберите **Создать базу данных**.  
  
4.  В диалоговом окне **Создание базы данных** в поле **Имя базы данных** введите имя новой базы данных.  
  
5.  В поле **Владелец** введите имя владельца новой базы данных. Также можно нажать кнопку с многоточием **(...)**, чтобы открыть диалоговое окно **Выбор владельца базы данных**. Дополнительные сведения о создании новой базы данных см. в разделе [Create a Database](../../databases/create-a-database.md).  
  
6.  В обозревателе объектов щелкните значок «плюс», чтобы развернуть папку **Базы данных** .  
  
7.  Щелкните правой кнопкой мыши созданную базу данных, выберите **Задачи**, затем **Управление шифрованием базы данных**.  
  
     В диалоговом окне **Управление шифрованием базы данных** доступны следующие параметры.  
  
     **"Encryption Algorithm" (Алгоритм шифрования)**  
     Отображает или устанавливает алгоритм для шифрования базы данных. Алгоритм шифрования по умолчанию — `AES128`. Это поле не может быть пустым. Дополнительные сведения об алгоритмах шифрования см. в разделе [Choose an Encryption Algorithm](choose-an-encryption-algorithm.md).  
  
     **Использовать сертификат сервера**  
     Задает шифрование с защитой сертификатом. Выберите его из списка. Если разрешение `VIEW DEFINITION` для сертификатов сервера отсутствует, этот список будет пустым. Если выбран метод шифрования с сертификатом, это значение не может быть пустым. Дополнительные сведения о сертификатах см. в разделе [SQL Server Certificates and Asymmetric Keys](../sql-server-certificates-and-asymmetric-keys.md).  
  
     **Использовать асимметричный ключ сервера**  
     Задает шифрование с защитой асимметричным ключом. Отображаются только доступные асимметричные ключи. Только асимметричный ключ, защищенный модулем расширенного управления ключами, позволяет шифровать базу данных с помощью прозрачного шифрования данных.  
  
     **Задать шифрование базы данных в**  
     Переключает базу данных между включенным (флажок установлен) или выключенным (флажок снят) режимом прозрачного шифрования данных.  
  
8.  По окончании нажмите кнопку **ОК**.  
  
###  <a name="TsqlCreate"></a>Использование Transact-SQL  
  
1.  В **обозревателе объектов**подключитесь к экземпляру компонента [!INCLUDE[ssDE](../../../includes/ssde-md.md)].  
  
2.  На стандартной панели выберите пункт **Создать запрос**.  
  
3.  Скопируйте следующий пример в окно запроса и нажмите кнопку **Выполнить**.  
  
    ```  
    -- Create a database master key and a certificate in the master database.  
    USE master ;  
    GO  
    CREATE MASTER KEY ENCRYPTION BY PASSWORD = '*rt@40(FL&dasl1';  
    GO  
    CREATE CERTIFICATE TestSQLServerCert   
    WITH SUBJECT = 'Certificate to protect TDE key'  
    GO  
    -- Create a backup of the server certificate in the master database.  
    -- The following code stores the backup of the certificate and the private key file in the default data location for this instance of SQL Server   
    -- (C:\Program Files\Microsoft SQL Server\MSSQL12.MSSQLSERVER\MSSQL\DATA).  
  
    BACKUP CERTIFICATE TestSQLServerCert   
    TO FILE = 'TestSQLServerCert'  
    WITH PRIVATE KEY   
    (  
        FILE = 'SQLPrivateKeyFile',  
        ENCRYPTION BY PASSWORD = '*rt@40(FL&dasl1'  
    );  
    GO  
    -- Create a database to be protected by TDE.  
    CREATE DATABASE CustRecords ;  
    GO  
    -- Switch to the new database.  
    -- Create a database encryption key, that is protected by the server certificate in the master database.   
    -- Alter the new database to encrypt the database using TDE.  
    USE CustRecords;  
    GO  
    CREATE DATABASE ENCRYPTION KEY  
    WITH ALGORITHM = AES_128  
    ENCRYPTION BY SERVER CERTIFICATE TestSQLServerCert;  
    GO  
    ALTER DATABASE CustRecords  
    SET ENCRYPTION ON;  
    GO  
    ```  
  
 Дополнительная информация:  
  
-   [Создание главного ключа &#40;&#41;Transact-SQL](/sql/t-sql/statements/create-master-key-transact-sql)  
  
-   [Создание сертификата &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-certificate-transact-sql)  
  
-   [Резервное копирование сертификата &#40;&#41;Transact-SQL](/sql/t-sql/statements/backup-certificate-transact-sql)  
  
-   [Создание &#40;базы данных SQL Server&#41;Transact-SQL](/sql/t-sql/statements/create-database-sql-server-transact-sql)  
  
-   [Создание ключа шифрования базы данных &#40;&#41;Transact-SQL](/sql/t-sql/statements/create-database-encryption-key-transact-sql)  
  
-   [&#41;Transact-SQL ALTER DATABASE &#40;](/sql/t-sql/statements/alter-database-transact-sql)  
  
##  <a name="TsqlProcedure"></a>Перемещение базы данных  
  
###  <a name="SSMSMove"></a>Использование SQL Server Management Studio  
  
1.  В обозревателе объектов щелкните правой кнопкой мыши зашифрованную ранее базу данных, выберите **Задачи**, затем **Отсоединить…**.  
  
     В диалоговом окне **Отсоединение базы данных** доступны следующие параметры.  
  
     **Базы данных для отсоединения**  
     Перечисляет базы данных для отсоединения.  
  
     **Имя базы данных**  
     Отображает имя базы данных для отсоединения.  
  
     **Удалить соединения**  
     Завершить соединения с указанной базой данных.  
  
    > [!NOTE]  
    >  Невозможно отсоединить базу данных с активными соединениями.  
  
     **Обновить статистику**  
     По умолчанию операция отсоединения сохраняет устаревшую статистику оптимизации. Для ее обновления установите этот флажок.  
  
     **Обеспечение полнотекстового каталога**  
     По умолчанию операция отсоединения сохраняет связанные с базой данных полнотекстовые каталоги. Для удаления этих каталогов сбросьте флажок **Сохранять полнотекстовые каталоги** . Этот параметр доступен только при обновлении базы данных с версии [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)].  
  
     **Состояние**  
     Отображает одно из следующих состояний: **Готов** или **Не готов**.  
  
     **Сообщение**  
     Столбец **Сообщение** может отображать сведения о базе данных следующим образом:  
  
    -   Если база данных участвует в репликации, то ее **Состояние** имеет значение **Не готово** , а в столбце **Сообщение** отображается строка **База данных реплицирована**.  
  
    -   Если база данных имеет одно или несколько активных подключений, **состояние** **не готово** , а в столбце **сообщение** отображается _<number_of_active_connections>_ **активных соединений** , например: **1 активных подключений**. Прежде чем можно будет отсоединить базу данных, необходимо отключить активные соединений, выбрав команду **Удалить соединения**.  
  
     Чтобы получить сведения о сообщении, откройте монитор активности, щелкнув текст с гиперссылкой.  
  
2.  Нажмите кнопку **ОК**.  
  
3.  В проводнике Windows переместите или скопируйте файлы базы данных с исходного сервера в то же расположение на целевом сервере.  
  
4.  В проводнике Windows переместите или скопируйте резервную копию сертификата сервера и файла закрытого ключа с исходного сервера в то же расположение на целевом сервере.  
  
5.  Создайте главный ключ базы данных на целевом экземпляре [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]. Дополнительные сведения см. в статье **Использование Transact-SQL** ниже.  
  
6.  Повторно создайте сертификат сервера с помощью файла резервной копии исходного сертификата сервера. Дополнительные сведения см. в статье **Использование Transact-SQL** ниже.  
  
7.  В обозревателе объектов среды [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)]щелкните правой кнопкой мыши папку **Базы данных** и выберите команду **Присоединить...**.  
  
8.  В диалоговом окне **Присоединение баз данных** в области **Базы данных для присоединения**нажмите кнопку **Добавить**.  
  
9. В диалоговом окне " **Размещение файлов базы данных —**_server_name_ " выберите файл базы данных, который нужно присоединить к новому серверу, и нажмите кнопку " **ОК**".  
  
     В диалоговом окне **Присоединение базы данных** доступны следующие параметры.  
  
     **Базы данных для присоединения**  
     Отобразятся сведения о выбранных базах данных.  
  
     
     \<нет заголовка столбца>  
  Отображается значок, указывающий на состояние операции присоединения. Возможные значки описываются в приводимом ниже описании **Состояние** .  
  
     **Расположение файла MDF**  
     Отображается путь и имя выбранного MDF-файла.  
  
     **Имя базы данных**  
     Отображается имя базы данных.  
  
     **Присоединить как**  
     Необязательный параметр, указывает другое имя, под которым присоединяется база данных.  
  
     **Владельцев**  
     Содержит раскрывающийся список возможных владельцев базы данных, из которого при необходимости можно выбрать другого владельца.  
  
     **Состояние**  
     Отображается состояние базы данных в соответствии со следующей таблицей.  
  
    |Значок|Текст состояния|Описание|  
    |----------|-----------------|-----------------|  
    |(Нет значка)|(Нет текста)|Операция присоединения не была запущена или находится в режиме ожидания для этого объекта. Это состояние по умолчанию при открытии диалогового окна.|  
    |Зеленый, указывающий направо треугольник|выполняется;|Операция присоединения была запущена, но не завершена.|  
    |Зеленый флажок|Успех|Объект успешно присоединен.|  
    |Красный кружок с белым крестом внутри|Ошибка|При выполнении операции присоединения возникла ошибка, и операция не была успешно завершена.|  
    |Кружок с двумя черными квадратами (слева и справа) и двумя белыми квадратами (сверху и снизу)|Остановлена|Операция присоединения не была успешно завершена, т.к. пользователь остановил операцию.|  
    |Кружок, содержащий изогнутую стрелку, указывающую в направлении против часовой стрелки|Выполнен откат|Операция присоединения была успешной, но был выполнен ее откат из-за ошибки, возникшей при вложении другого объекта.|  
  
     **Сообщение**  
     Отображается пустое сообщение или гиперссылка «Файл не найден».  
  
     **Включить**  
     Найдите необходимые основные файлы базы данных. Если пользователь выбирает mdf-файл, необходимые сведения автоматически вводятся в соответствующие поля сетки **Базы данных для присоединения** .  
  
     **Отменит**  
     Удаляет выбранный файл из сетки **Базы данных для присоединения** .  
  
     **** _<database_name>_ **"сведения о базе данных**  
     Отображаются имена файлов, которые необходимо присоединить. Чтобы проверить или изменить путь к файлу, нажмите кнопку **Обзор** (**...**).  
  
    > [!NOTE]  
    >  Если файл не существует, в столбце **Сообщение** отображается сообщение «Не найден». Если файл журнала не найден, то он существует в другом каталоге или был удален. Необходимо или обновить путь файла в сетке **Сведения о базе данных** таким образом, чтобы этот путь указывал на правильное расположение, или удалить файл журнала из сетки. Если MDF-файл не найден, необходимо обновить путь этого файла в сетке таким образом, чтобы этот путь указывал на правильное расположение.  
  
     **Исходное имя файла**  
     Отображается имя присоединенного файла, принадлежащего базе данных.  
  
     **Тип файла**  
     Указывается тип файла: **Данные** или **Журнал**.  
  
     **Текущий путь к файлу**  
     Отображается путь к выбранному файлу базы данных. Путь может быть изменен вручную.  
  
     **Сообщение**  
     Отображает пустое сообщение или гиперссылку "**файл не найден**".  
  
###  <a name="TsqlMove"></a>Использование Transact-SQL  
  
1.  В **обозревателе объектов**подключитесь к экземпляру компонента [!INCLUDE[ssDE](../../../includes/ssde-md.md)].  
  
2.  На стандартной панели выберите пункт **Создать запрос**.  
  
3.  Скопируйте следующий пример в окно запроса и нажмите кнопку **Выполнить**.  
  
    ```  
    -- Detach the TDE protected database from the source server.   
    USE master ;  
    GO  
    EXEC master.dbo.sp_detach_db @dbname = N'CustRecords';  
    GO  
    -- Move or copy the database files from the source server to the same location on the destination server.   
    -- Move or copy the backup of the server certificate and the private key file from the source server to the same location on the destination server.   
    -- Create a database master key on the destination instance of SQL Server.   
    USE master;  
    GO  
    CREATE MASTER KEY ENCRYPTION BY PASSWORD = '*rt@40(FL&dasl1';  
    GO  
    -- Recreate the server certificate by using the original server certificate backup file.   
    -- The password must be the same as the password that was used when the backup was created.  
  
    CREATE CERTIFICATE TestSQLServerCert   
    FROM FILE = 'TestSQLServerCert'  
    WITH PRIVATE KEY   
    (  
        FILE = 'SQLPrivateKeyFile',  
        DECRYPTION BY PASSWORD = '*rt@40(FL&dasl1'  
    );  
    GO  
    -- Attach the database that is being moved.   
    -- The path of the database files must be the location where you have stored the database files.  
    CREATE DATABASE [CustRecords] ON   
    ( FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL12.MSSQLSERVER\MSSQL\DATA\CustRecords.mdf' ),  
    ( FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL12.MSSQLSERVER\MSSQL\DATA\CustRecords_log.LDF' )  
    FOR ATTACH ;  
    GO  
    ```  
  
 Дополнительная информация:  
  
-   [sp_detach_db &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-detach-db-transact-sql)  
  
-   [Создание главного ключа &#40;&#41;Transact-SQL](/sql/t-sql/statements/create-master-key-transact-sql)  
  
-   [Создание сертификата &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-certificate-transact-sql)  
  
-   [Создание &#40;базы данных SQL Server&#41;Transact-SQL](/sql/t-sql/statements/create-database-sql-server-transact-sql)  
  
## <a name="see-also"></a>См. также  
 [Отсоединение и присоединение базы данных &#40;SQL Server&#41;](../../databases/database-detach-and-attach-sql-server.md)  
  
  
