---
title: Создание или настройка прослушивателя группы доступности (SQL Server) | Документы Майкрософт
ms.custom: ''
ms.date: 06/14/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
f1_keywords:
- sql12.swb.availabilitygroup.newaglistener.general.f1
helpviewer_keywords:
- Availability Groups [SQL Server], listeners
- Availability Groups [SQL Server], client connectivity
ms.assetid: 2bc294f6-2312-4b6b-9478-2fb8a656e645
author: MashaMSFT
ms.author: mathoma
manager: craigg
ms.openlocfilehash: bddf15e6469e2fd347c716e98e750c077bcc29e7
ms.sourcegitcommit: f912c101d2939084c4ea2e9881eb98e1afa29dad
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/23/2019
ms.locfileid: "72797686"
---
# <a name="create-or-configure-an-availability-group-listener-sql-server"></a>Create or Configure an Availability Group Listener (SQL Server)
  В этом разделе описывается создание или настройка одного *прослушивателя группы доступности* для группы доступности AlwaysOn с помощью среды [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)], [!INCLUDE[tsql](../../../includes/tsql-md.md)]или PowerShell в [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)].  
  
> [!IMPORTANT]  
>  Для создания прослушивателя первой группы доступности настоятельно рекомендуется использовать [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)], [!INCLUDE[tsql](../../../includes/tsql-md.md)]или Powershell [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] . Старайтесь не создавать прослушиватель непосредственно в кластере WSFC, кроме случаев, когда необходимо, например, создать дополнительный прослушиватель.  
  
  
##  <a name="BeforeYouBegin"></a> Перед началом  
  
###  <a name="DoesListenerExist"></a> Существует ли прослушиватель для этой группы доступности?  
 **Определение наличия прослушивателя для группы доступности**  
  
-   [Просмотр свойств прослушивателя группы доступности (SQL Server)](view-availability-group-listener-properties-sql-server.md)  
  
> [!NOTE]  
>  Если прослушиватель уже существует и нужно создать дополнительный прослушиватель, см. подраздел [Создание дополнительного прослушивателя группы доступности (необязательно)](#CreateAdditionalListener) далее в этом разделе.  
  
###  <a name="Restrictions"></a> Ограничения  
  
-   С помощью [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]вы можете создать только один прослушиватель для каждой группы доступности. Обычно для каждой группы доступности требуется только один прослушиватель. Однако в некоторых сценариях клиента требуется несколько прослушивателей на одну группу доступности.   После создания прослушивателя посредством SQL Server для создания дополнительных прослушивателей можно использовать Windows PowerShell для отказоустойчивых кластеров или диспетчер кластера WSFC. Дополнительные сведения см. в подразделе [Создание дополнительного прослушивателя для группы доступности (необязательно)](#CreateAdditionalListener)далее в этом разделе.  
  
###  <a name="Recommendations"></a> рекомендации  
 Для конфигураций с несколькими подсетями рекомендуется статический IP-адрес (но это не обязательно).  
  
###  <a name="Prerequisites"></a> Предварительные требования  
  
-   Необходимо подключиться к экземпляру сервера, на котором размещена первичная реплика.  
  
-   Если при настройке прослушивателя группы доступности для нескольких подсетей планируется использование статических IP-адресов, то необходимо получить статический IP-адрес каждой подсети, где размещена реплика доступности для группы доступности, для которой создается прослушиватель. Обычно статические IP-адреса можно запросить у сетевого администратора.  
  
> [!IMPORTANT]  
>  Перед созданием первого прослушивателя настоятельно рекомендуется прочитать раздел [Подключение клиента AlwaysOn (SQL Server)](always-on-client-connectivity-sql-server.md).  
  
###  <a name="DNSnameReqs"></a> Требования к имени DNS прослушивателя группы доступности  
 Для каждого прослушивателя группы доступности необходимо имя DNS-узла, уникальное в домене и в NetBIOS. Имя DNS является значением типа string. Это имя может содержать только буквы, цифры, дефисы (-) и знаки подчеркивания (_) в любом порядке. В именах узлов DNS учитывается регистр. Максимальная длина составляет 63 символа, однако в среде [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)]можно указать длину не более 15 символов.  
  
 Мы рекомендуем указывать строку, которая поддается толкованию. Например, для группы доступности с именем `AG1`понятным именем узла DNS будет `ag1-listener`.  
  
> [!IMPORTANT]  
>  NetBIOS распознает только первые 15 символов в dns_name. При наличии двух кластеров WSFC, которые управляются одной службой Active Directory, и попытке создать в обоих кластерах прослушивателей группы доступности с именами, содержащими более 15 символов, и одинаковым префиксом из 15 символов возникнет ошибка, указывающая, что не удалось подключиться к ресурсу с именем виртуальной сети. Дополнительные сведения о правилах именования префиксов для имен DNS см. в разделе [Присвоение имен доменов](https://technet.microsoft.com/library/cc731265\(WS.10\).aspx).  
  
###  <a name="WinPermissions"></a> Разрешения Windows  
  
|Разрешения|Ссылка|  
|-----------------|----------|  
|Объект имени кластера WSFC (CNO), на котором размещается группа доступности, должен иметь разрешение **Создание объектов компьютера** .<br /><br /> В Active Directory объект CNO по умолчанию не имеет явного разрешения **Создание объектов компьютера** и может создать 10 виртуальных объектов-компьютеров (VCO). После того как сформированы 10 виртуальных объектов-компьютеров, создание дополнительных объектов VCO завершится ошибкой. Этого можно избежать, явно предоставив разрешение объекту CNO кластера WSFC. Обратите внимание, что виртуальные объекты-компьютеры для удаленных групп доступности не удаляются автоматически в Active Directory и засчитываются в счет ограничения в 10 объектов VCO, если они не удалены вручную.<br /><br /> Примечание. В некоторых организациях политика безопасности запрещает предоставлять разрешение **Создание объектов компьютера** отдельным учетным записям пользователей.|*Действия по настройке учетной записи для лица, которое устанавливает кластер* в учебнике [Пошаговое руководство по отказоустойчивому кластеру. Настройка учетных записей в Active Directory](https://technet.microsoft.com/library/cc731002\(WS.10\).aspx#BKMK_steps_installer)<br /><br /> *Действия по предварительной настройке учетной записи имени кластера* в учебнике [Пошаговое руководство по отказоустойчивому кластеру. Настройка учетных записей в Active Directory](https://technet.microsoft.com/library/cc731002\(WS.10\).aspx#BKMK_steps_precreating)|  
|Если политика организации требует предварительно настроить учетную запись компьютера для виртуального сетевого имени прослушивателя, потребуется членство в группе **Account Operator** или помощь администратора домена.<br /><br /> Совет. Как правило, проще всего не выполнять предварительную настройку учетной записи для виртуального сетевого имени прослушивателя. Если это возможно, пусть учетная запись будет создана и настроена автоматически при запуске мастера высокого уровня доступности WSFC.|*Шаги по предварительной настройке учетной записи для кластеризованной службы или приложения* в учебнике [Пошаговое руководство по отказоустойчивому кластеру. Настройка учетных записей в Active Directory](https://technet.microsoft.com/library/cc731002\(WS.10\).aspx#BKMK_steps_precreating2)|  
  
###  <a name="SqlPermissions"></a> Разрешения SQL Server  
  
|Задача|Разрешения|  
|----------|-----------------|  
|Создание прослушивателя группы доступности|Требуется членство в фиксированной роли сервера **sysadmin** и одно из разрешений: CREATE AVAILABILITY GROUP, ALTER ANY AVAILABILITY GROUP или CONTROL SERVER.|  
|Изменение существующего прослушивателя группы доступности|Необходимо разрешение ALTER AVAILABILITY GROUP для группы доступности, разрешение CONTROL AVAILABILITY GROUP, разрешение ALTER ANY AVAILABILITY GROUP или разрешение CONTROL SERVER.|  
  
##  <a name="SSMSProcedure"></a> Использование среды SQL Server Management Studio  
  
> [!TIP]  
>  [Мастер создания группы доступности](use-the-new-availability-group-dialog-box-sql-server-management-studio.md) поддерживает создание прослушивателя для новой группы доступности.  
  
 **Создание или настройка прослушивателя группы доступности**  
  
1.  В обозревателе объектов подключитесь к экземпляру сервера, на котором размещена первичная реплика группы доступности, и щелкните имя сервера, чтобы развернуть дерево сервера.  
  
2.  Разверните узел **Высокий уровень доступности AlwaysOn** и узел **Группы доступности** .  
  
3.  Щелкните группу доступности, для которой нужно настроить прослушиватель, и выберите одну из следующих альтернатив.  
  
    -   Чтобы создать прослушиватель, щелкните правой кнопкой мыши узел **Прослушиватели группы доступности** и выберите команду **Создать прослушиватель** . Откроется диалоговое окно **Создать прослушиватель группы доступности** . Дополнительные сведения см. в подразделе [Добавление прослушивателя группы доступности (диалоговое окно)](#AddAgListenerDialog)далее в этом разделе.  
  
    -   Чтобы изменить номер порта существующего прослушивателя, разверните узел **Прослушиватели группы доступности** , щелкните правой кнопкой мыши прослушиватель и выберите пункт **Свойства** . Введите новый номер порта в поле **Порт** и нажмите кнопку **ОК**.  
  
###  <a name="AddAgListenerDialog"></a> Создание прослушивателя группы доступности (диалоговое окно)  
 **DNS-имя прослушивателя**  
 Указывает имя узла DNS для прослушивателя группы доступности. Имя DNS является строкой и должно быть уникальным в домене и в NetBIOS. Это имя может содержать только буквы, цифры, дефисы (-) и знаки подчеркивания (_) в любом порядке. В именах узлов DNS учитывается регистр. Максимальная длина составляет 15 символов.  
  
 Дополнительные сведения см. в подразделе [Требования к имени DNS прослушивателя группы доступности](#DNSnameReqs)выше в этом разделе.  
  
 **Порт**  
 TPC-порт, используемый этим прослушивателем.  
  
 **Сетевой режим**  
 Указывает TCP-протокол, используемый прослушивателем, один из:  
  
 **DHCP**  
 Прослушиватель будет использовать динамический IP-адрес, назначенный сервером, на котором запущен DHCP-протокол. Протокол DHCP ограничен одной подсетью.  
  
> [!IMPORTANT]  
>  Использовать протокол DHCP в производственной среде не рекомендуется. Если во время простоя аренда IP-адреса протокола DHCP истечет, то на регистрацию нового сетевого IP-адреса протокола DHCP, связанного с именем DNS-прослушивателя, уйдет дополнительное время, что скажется на производительности клиента. Однако протокол DHCP полезен при настройке среды разработки и проверки и позволяет проверить базовые функции групп доступности и их интеграцию с приложениями.  
  
 **Статический IP-адрес**  
 Прослушиватель будет использовать один или несколько статических IP-адресов. Дополнительные IP-адреса являются необязательными. Чтобы создать прослушиватель группы доступности для нескольких подсетей, в конфигурации прослушивателя необходимо задать по одному статическому IP-адресу для каждой подсети. Чтобы получить эти IP-адреса, свяжитесь с сетевым администратором.  
  
 Если выбрать **Статический IP-адрес** , под полем **Сетевой режим** появится сетка подсети. В этой сетке отображаются сведения о каждой подсети, к которой может получить доступ прослушиватель этой группы доступности. Эта сетка остается пустой до тех пор, пока не будет добавлен статический IP-адрес путем нажатия кнопки **Добавить**.  
  
 Существуют следующие столбцы.  
  
 **Подсеть**  
 Отображает идентификатор каждой подсети, добавляемой в прослушиватель группы доступности.  
  
 **IP-адрес**  
 Отображает IP-адрес данной подсети.  Для данной подсети статический IP-адрес может быть указан как IPv4 или IPv6.  
  
 **Добавить**  
 Нажмите, чтобы добавить статический IP-адрес в выбранную подсеть или другую подсеть для этого прослушивателя. Откроется диалоговое окно **Добавление IP-адреса** . Дополнительные сведения см. в разделе справки [Диалоговое окно "Добавление IP-адреса" (SQL Server Management Studio)](add-ip-address-dialog-box-sql-server-management-studio.md).  
  
 **Удалить**  
 Нажмите, чтобы удалить выбранную подсеть из этого прослушивателя.  
  
 **ОК**  
 Нажмите, чтобы создать указанный прослушиватель группы доступности.  
  
##  <a name="TsqlProcedure"></a> Использование Transact-SQL  

### <a name="to-create-or-configure-an-availability-group-listener"></a>Создание или настройка прослушивателя группы доступности
  
1.  Подключитесь к экземпляру сервера, на котором находится первичная реплика.  
  
2.  Используйте параметр LISTENER в инструкции [CREATE AVAILABILITY GROUP](/sql/t-sql/statements/create-availability-group-transact-sql) или параметр ADD ISTENER для инструкции [ALTER AVAILABILITY GROUP](/sql/t-sql/statements/alter-availability-group-transact-sql) .  
  
     В следующем примере прослушиватель группы доступности добавляется в существующую группу доступности с именем `MyAg2`. Для этого прослушивателя задается уникальное имя DNS — `MyAg2ListenerIvP6`. Две реплики находятся в разных подсетях, поэтому согласно рекомендации прослушиватель использует статические IP-адреса. Для каждой из двух реплик доступности предложение WITH IP указывает статический IP-адрес `2001:4898:f0:f00f::cf3c and 2001:4898:e0:f213::4ce2`, использующий формат IPv6. В этом примере также указывается и используется необязательный параметр PORT, указывающий порт `60173` в качестве порта прослушивателя.  
  
    ```sql
    ALTER AVAILABILITY GROUP MyAg2   
          ADD LISTENER 'MyAg2ListenerIvP6' ( WITH IP ( ('2001:db88:f0:f00f::cf3c'),('2001:4898:e0:f213::4ce2') ) , PORT = 60173 );   
    GO  
    ```  
  
##  <a name="PowerShellProcedure"></a> Использование PowerShell  

### <a name="to-create-or-configure-an-availability-group-listener"></a>Создание или настройка прослушивателя группы доступности 
  
1.  Перейдите в каталог (`cd`) экземпляра сервера, на котором находится первичная реплика.  
  
2.  Чтобы создать или изменить прослушиватель группы доступности, используйте один из следующих командлетов:  
  
     `New-SqlAvailabilityGroupListener`  
     Создает прослушиватель группы доступности и привязывает его к существующей группе доступности.  
  
     Например, следующая команда `New-SqlAvailabilityGroupListener` создает прослушиватель с именем `MyListener` для группы доступности `MyAg`. Этот прослушиватель в качестве виртуального IP-адреса будет использовать адрес IPv4, переданный в параметре `-StaticIp`.  
  
    ```powershell
    New-SqlAvailabilityGroupListener -Name MyListener `
    -StaticIp '192.168.3.1/255.255.252.0' `
    -Path SQLSERVER:\Sql\Computer\Instance\AvailabilityGroups\MyAg
    ```  
  
     `Set-SqlAvailabilityGroupListener`  
     Изменяет порт существующего прослушивателя группы доступности.  
  
     Например, следующая команда `Set-SqlAvailabilityGroupListener` устанавливает для прослушивателя группы доступности с именем `MyListener` номер порта `1535`. Этот порт будет использоваться прослушивателем для прослушивания соединения.  
  
    ```powershell
    Set-SqlAvailabilityGroupListener -Port 1535 `
    -Path SQLSERVER:\Sql\PrimaryServer\InstanceName\AvailabilityGroups\MyAg\AGListeners\MyListener  
    ```  
  
     `Add-SqlAGListenerstaticIp`  
     Добавляет статический IP-адрес в конфигурацию существующего прослушивателя группы доступности. IP-адрес может быть адресом IPv4 с подсетью или адресом IPv6.  
  
     Например, следующая команда `Add-SqlAGListenerstaticIp` добавляет статический адрес IPv4 в прослушиватель `MyListener` в группе доступности `MyAg`. Этот адрес IPv6 выступает в роли виртуального IP-адреса прослушивателя в подсети `255.255.252.0`. Если группа доступности распространяется на несколько подсетей, нужно добавить статический IP-адрес для каждой подсети в прослушивателе.  
  
    ```powershell
    $path = "SQLSERVER:\SQL\PrimaryServer\InstanceName\AvailabilityGroups\MyAg\AGListeners\ MyListener" `
    Add-SqlAGListenerstaticIp -Path $path `
    -StaticIp "2001:0db8:85a3:0000:0000:8a2e:0370:7334"  
    ```  
  
    > [!NOTE]  
    >  Чтобы просмотреть синтаксис командлета, воспользуйтесь командлетом **Get-Help**  в среде [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] PowerShell. Дополнительные сведения см. в статье [Get Help SQL Server PowerShell](../../../powershell/sql-server-powershell.md).  
  
Сведения о настройке и использовании поставщика SQL Server PowerShell см. в разделе [поставщик SQL Server PowerShell](../../../powershell/sql-server-powershell-provider.md).
  
## <a name="troubleshooting"></a>Устранение неполадок  
  
###  <a name="ADQuotas"></a> Ошибка создания нового прослушивателя группы доступности из-за квот Active Directory  
 Создание нового прослушивателя группы доступности может завершиться неудачей в случае превышения квоты Active Directory для учетной записи участвующего узла кластера.  Дополнительные сведения см. в следующих статьях:  
  
-   [HYPERLINK "https://support.microsoft.com/kb/307532" Устранение неполадок с учетной записью службы кластеров при изменении объектов компьютеров](https://support.microsoft.com/kb/307532)  
  
-   [Active Directory квоты для ГИПЕРССЫЛКи "https://technet.microsoft.com/library/cc904295(WS.10).aspx"](https://technet.microsoft.com/library/cc904295\(WS.10\).aspx)  
  
##  <a name="FollowUp"></a> Дальнейшие действия. Действия после создания прослушивателя группы доступности  
  
###  <a name="MultiSubnetFailover"></a> Ключевое слово и связанные функции MultiSubnetFailover  
 `MultiSubnetFailover` — это новое ключевое слово строки подключения, которое обеспечивает ускоренную отработку отказа для групп доступности AlwaysOn и экземпляров отказоустойчивых кластеров AlwaysOn в SQL Server 2012. Если в строке подключения задано условие `MultiSubnetFailover=True`, то включаются следующие три дополнительные функции.  
  
-   Ускоренная отработка отказа для нескольких подсетей с прослушивателем для группы доступности AlwaysOn или экземпляров отказоустойчивых кластеров.  
  
-   Ускоренная отработка отказа для одной подсети с прослушивателем для группы доступности AlwaysOn или экземпляров отказоустойчивых кластеров.  
  
    -   Эта функция используется при подключении к прослушивателю с одним IP-адресом в одной подсети. В результате этого выполняется большее число попыток подключения по протоколу TCP, что дает возможность ускорить отработку отказа в одной подсети.  
  
-   Разрешение именованного экземпляра в экземпляр отказоустойчивого кластера группы доступности AlwaysOn в нескольких подсетях.  
  
    -   Эта функция необходима для добавления поддержки разрешения именованного экземпляра для экземпляров отказоустойчивых кластеров группы доступности AlwaysOn с конечными точками в нескольких подсетях.  
  
 **MultiSubnetFailover=True не поддерживается платформой NET Framework 3.5 или OLEDB**  
  
 **Проблема** . Если у группы доступности или экземпляра отказоустойчивого кластера есть имя прослушивателя (в диспетчере кластеров WSFC оно называется сетевым именем или точкой доступа клиента) с зависимостью от нескольких IP-адресов из разных подсетей и при этом используется ADO.NET с платформой .NET Framework 3.5 с пакетом обновления 1 (SP1) или SQL Native Client 11.0 OLEDB, то потенциально 50 % запросов на подключение клиентов к прослушивателю группы доступности исчерпают время ожидания подключения.  
  
 **Обходные решения.** Рекомендуется выполнить одну из следующих задач.  
  
-   При отсутствии разрешения на работу с ресурсами кластера измените время ожидания соединения на 30 секунд (это означает 20 секунд ожидания TCP плюс 10-секундный буфер).  
  
     **Преимущества**. В случае перехода на другой ресурс по нескольким подсетям обеспечивается быстрое восстановление клиента.  
  
     **Недостатки.** Установление 50 % соединений клиентов потребует более 20 секунд.  
  
-   При наличии разрешений на работу с ресурсами кластера рекомендуется задать `RegisterAllProvidersIP=0`в качестве сетевого имени прослушивателя группы доступности. Дополнительные сведения см. в подразделе "Установка значения RegisterAllProvidersIP" далее в этом разделе.  
  
     **Преимущества** . Не потребуется увеличивать значение времени ожидания подключения клиента.  
  
     **Против:** Если происходит отработка отказа между подсетями, время восстановления клиента может составлять не более 15 минут, в зависимости от настроек `HostRecordTTL` и расписания репликации межсайтовых DNS/AD.  
  
###  <a name="RegisterAllProvidersIP"></a> Параметр RegisterAllProvidersIP  
 При создании прослушивателя группы доступности с помощью [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)], [!INCLUDE[tsql](../../../includes/tsql-md.md)] или Powershell точка доступа клиента в кластере WSFC создается со свойством `RegisterAllProvidersIP`, установленным в значение 1 (true). Действие этого значения свойства зависит от строки подключения клиента следующим образом.  
  
-   Строки подключения, устанавливающие свойство `MultiSubnetFailover` в значение true.  
  
     [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] устанавливает свойство `RegisterAllProvidersIP` в значение 1, чтобы сократить время соединения после отработки отказа для клиентов, у которых в строке подключения указано, согласно рекомендациям, `MultiSubnetFailover = True`. Обратите внимание, что для использования функции нескольких подсетей в прослушивателе поставщик данных клиентов должен поддерживать ключевое слово `MultiSubnetFailover`. Сведения о поддержке драйверов для отказоустойчивых кластеров с несколькими подсетями см. в разделе [Подключение клиента AlwaysOn (SQL Server)](always-on-client-connectivity-sql-server.md).  
  
     Сведения о кластеризации с несколькими подсетями см. в разделе [Кластеры SQL Server с несколькими подсетями (SQL Server)](../../../sql-server/failover-clusters/windows/sql-server-multi-subnet-clustering-sql-server.md).  
  
    > [!TIP]  
    >  Если `RegisterAllProvidersIP = 1`, то при запуске мастера WSFC по проверке конфигурации в кластере WSFC мастер выдаст следующее сообщение об ошибке:  
    >   
    >  "Свойство RegisterAllProviderIP для сетевого имени "Name:<имя_сети>" имеет значение 1, для текущей конфигурации кластера данное свойство должно иметь значение 0".  
    >   
    >  Не обращайте внимания на это сообщение.  
  
-   Строки подключения, не задающие свойство `MultiSubnetFailover` в значение true.  
  
     Если выполняется условие `RegisterAllProvidersIP = 1`, то у любых клиентов, у которых строка подключения не содержит `MultiSubnetFailover = True`, будет возникать большая задержка в соединениях. Это происходит потому, что эти клиенты пытаются соединиться со всеми IP-адресами последовательно. Наоборот, если свойство `RegisterAllProvidersIP` изменено на 0, то IP-адрес включается в список клиентской точки доступа в кластере WSFC и уменьшает задержку для клиентов устаревших версий. Поэтому при наличии устаревших клиентов, которым необходимо подключиться к прослушивателю группы доступности и не может использовать свойство `MultiSubnetFailover`, рекомендуется изменить `RegisterAllProvidersIP` на 0.  
  
    > [!IMPORTANT]  
    >  При создании прослушивателя группы доступности через кластер WSFC (графический интерфейс диспетчера отказоустойчивого кластера) свойство `RegisterAllProvidersIP` будет иметь значение 0 (false) по умолчанию.  
  
###  <a name="HostRecordTTL"></a> Установка значения HostRecordTTL  
 По умолчанию клиенты кэшируют DNS-записи кластера на 20 минут.  Путем уменьшения `HostRecordTTL` (срок существования (TTL) для кэшированной записи) старые клиенты могут подключиться быстрее.  Однако уменьшение параметра `HostRecordTTL` также может привести к увеличению трафика к серверам DN.  
  
###  <a name="SampleScript"></a> Образец скрипта PowerShell для отключения RegisterAllProvidersIP и сокращения TTL  
 В следующем примере показано, как настроить PowerShell и параметры кластера `RegisterAllProvidersIP` и `HostRecordTTL` для ресурса прослушивателя.  Запись DNS будет кэшироваться каждые 5 минут, а не 20 минут (по умолчанию).  Если изменить оба параметра кластера, можно сократить время подключения к нужному IP-адресу после перехода на старых клиентов, которые не могут использовать параметр `MultiSubnetFailover`.  Замените `yourListenerName` на имя изменяемого прослушивателя.  
  
```powershell
Import-Module FailoverClusters  
Get-ClusterResource yourListenerName | Set-ClusterParameter RegisterAllProvidersIP 0
Get-ClusterResource yourListenerName|Set-ClusterParameter HostRecordTTL 300  
Stop-ClusterResource yourListenerName  
Start-ClusterResource yourAGResource  
```  
  
 Дополнительные сведения о времени восстановления при отработке отказа см. в разделе [Client Recovery Latency During Failover](../../../sql-server/failover-clusters/windows/sql-server-multi-subnet-clustering-sql-server.md#DNS).  
  
###  <a name="FollowUpRecommendations"></a> Рекомендуемые действия  
 Действия после создания прослушивателя группы доступности  
  
-   Попросите сетевого администратора зарезервировать IP-адрес, который будет использоваться только этим прослушивателем.  
  
-   Передайте имя узла DNS прослушивателя разработчикам приложения для использования в строке подключения при запросе клиентских соединений к данной группе доступности.  
  
-   Рекомендуйте разработчикам добавить в строки подключения `MultiSubnetFailover = True`, если это возможно. Сведения о поддержке драйверов для отказоустойчивых кластеров с несколькими подсетями см. в разделе [Подключение клиента AlwaysOn (SQL Server)](always-on-client-connectivity-sql-server.md).  
  
###  <a name="CreateAdditionalListener"></a> Создание дополнительного прослушивателя для группы доступности (необязательно)  
 После создания одного прослушивателя посредством SQL Server можно создать дополнительный прослушиватель следующим образом.  
  
1.  Создайте прослушиватель, используя одно из следующих средств:  
  
    -   **Использование диспетчера отказоустойчивого кластера WSFC.**  
  
        1.  Добавление точки доступа клиента и настройка IP-адреса.  
  
        2.  Перевод прослушивателя в режим «в сети».  
  
        3.  Добавление зависимости в ресурс группы доступности WSFC.  
  
         Дополнительные сведения о диалоговых окнах и вкладках диспетчера отказоустойчивости кластеров см. в разделе [Пользовательский интерфейс: оснастка "Диспетчер отказоустойчивости кластеров"](https://technet.microsoft.com/library/cc772502.aspx).  
  
    -   **С помощью Windows PowerShell для отказоустойчивых кластеров.**  
  
        1.  Используйте командлет [Add-ClusterResource](https://technet.microsoft.com/library/ee460983.aspx) , чтобы создать ресурсы сетевого имени и IP-адреса.  
  
        2.  Используйте командлет [Start-ClusterResource](https://technet.microsoft.com/library/ee461056.aspx) , чтобы запустить ресурс сетевого имени.  
  
        3.  Используйте командлет [Add-ClusterResourceDependency](https://technet.microsoft.com/library/ee461014.aspx) , чтобы задать зависимость между сетевым именем и существующим ресурсом группы доступности SQL Server.  
  
         Сведения об использовании Windows PowerShell для отказоустойчивых кластеров см. в разделе [Общие сведения о командах диспетчера сервера](https://technet.microsoft.com/library/cc732757.aspx#BKMK_wps).  
  
2.  Запустите прослушивание [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] в новом прослушивателе. После создания дополнительного прослушивателя подключитесь к экземпляру [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] , на котором размещается первичная реплика группы доступности, и измените порт прослушивателя с помощью среды [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)], [!INCLUDE[tsql](../../../includes/tsql-md.md)]или PowerShell.  
  
 Дополнительные сведения см. в разделе [Способ создания нескольких прослушивателей для одной группы доступности](https://blogs.msdn.com/b/sqlalwayson/archive/2012/02/03/how-to-create-multiple-listeners-for-same-availability-group-goden-yao.aspx) (блог группы разработчиков SQL Server AlwaysOn).  
  
##  <a name="RelatedTasks"></a> Связанные задачи  
  
-   [Просмотр свойств прослушивателя группы доступности (SQL Server)](view-availability-group-listener-properties-sql-server.md)  
  
-   [Удаление прослушивателя группы доступности (SQL Server)](remove-an-availability-group-listener-sql-server.md)  
  
##  <a name="RelatedContent"></a> См. также  
  
-   [Способ создания нескольких прослушивателей для одной группы доступности](https://blogs.msdn.com/b/sqlalwayson/archive/2012/02/03/how-to-create-multiple-listeners-for-same-availability-group-goden-yao.aspx)  
  
-   [Блог группы SQL Server AlwaysOn: Официальный блог группы SQL Server AlwaysOn](https://blogs.msdn.com/b/sqlalwayson/)  
  
## <a name="see-also"></a>См. также статью  
 [Общие сведения о &#40;группы доступности AlwaysOn&#41; SQL Server](overview-of-always-on-availability-groups-sql-server.md)   
 [Прослушиватели групп доступности, возможность подключения клиентов и отработка отказа приложений (SQL Server)](../../listeners-client-connectivity-application-failover.md)   
 [Кластеры SQL Server с несколькими подсетями (SQL Server)](../../../sql-server/failover-clusters/windows/sql-server-multi-subnet-clustering-sql-server.md)  
