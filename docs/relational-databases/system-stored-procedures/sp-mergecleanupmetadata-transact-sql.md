---
title: sp_mergecleanupmetadata (Transact-SQL) | Документация Майкрософт
ms.custom: ''
ms.date: 03/14/2017
ms.prod: sql
ms.prod_service: database-engine
ms.reviewer: ''
ms.technology: replication
ms.topic: language-reference
f1_keywords:
- sp_mergecleanupmetadata_TSQL
- sp_mergecleanupmetadata
helpviewer_keywords:
- sp_mergecleanupmetadata
ms.assetid: 892f8628-4cbe-4cc3-b959-ed45ffc24064
author: stevestein
ms.author: sstein
manager: craigg
ms.openlocfilehash: 6924ef36c57036cf6cad6e25a6dc5cebfa5fa5f2
ms.sourcegitcommit: f7fced330b64d6616aeb8766747295807c92dd41
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "63017842"
---
# <a name="spmergecleanupmetadata-transact-sql"></a>sp_mergecleanupmetadata (Transact-SQL)
[!INCLUDE[tsql-appliesto-ss2008-xxxx-xxxx-xxx-md](../../includes/tsql-appliesto-ss2008-xxxx-xxxx-xxx-md.md)]

  Следует использовать только в топологиях репликации, включающих под управлением версий [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] до [!INCLUDE[ssVersion2000](../../includes/ssversion2000-md.md)] с пакетом обновления 1. **sp_mergecleanupmetadata** позволяет администраторам очищать метаданные в **MSmerge_genhistory**, **MSmerge_contents** и **MSmerge_tombstone** системных таблиц. Эта хранимая процедура выполняется на издателе в базе данных публикации.  
  
 ![Значок ссылки на раздел](../../database-engine/configure-windows/media/topic-link.gif "Значок ссылки на раздел") [Синтаксические обозначения в Transact-SQL](../../t-sql/language-elements/transact-sql-syntax-conventions-transact-sql.md)  
  
## <a name="syntax"></a>Синтаксис  
  
```  
  
sp_mergecleanupmetadata [ [ @publication = ] 'publication' ]  
    [ , [ @reinitialize_subscriber = ] 'reinitialize_subscriber' ]  
```  
  
## <a name="arguments"></a>Аргументы  
`[ @publication = ] 'publication'` — Имя публикации. *Публикация* — **sysname**, значение по умолчанию **%**, которого очищаются метаданные для всех публикаций. При явном указании публикации она должна существовать.  
  
`[ @reinitialize_subscriber = ] 'subscriber'` Указывает, следует ли повторно инициализировать подписчик. *подписчик* — **nvarchar(5)**, может быть **TRUE** или **FALSE**, значение по умолчанию **TRUE**. Если **TRUE**, подписки помечаются для повторной инициализации. Если **FALSE**, подписки не помечаются для повторной инициализации.  
  
## <a name="return-code-values"></a>Значения кода возврата  
 **0** (успешное завершение) или **1** (неуспешное завершение)  
  
## <a name="remarks"></a>Примечания  
 **sp_mergecleanupmetadata** следует использовать только в топологиях репликации, включающих под управлением версий [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] до [!INCLUDE[ssVersion2000](../../includes/ssversion2000-md.md)] с пакетом обновления 1. Топологии, включающие только [!INCLUDE[ssVersion2000](../../includes/ssversion2000-md.md)] с пакетом обновления 1 (SP1) или более поздние версии, должны использовать очистку метаданных, основанную на сроке хранения. При выполнении этой хранимой процедуры следует помнить о необходимом и, возможно, значительном увеличении файла журнала на компьютере, на котором выполняется хранимая процедура.  
  
> [!CAUTION]
>  После **sp_mergecleanupmetadata** выполняется по умолчанию, все подписки на подписчиках публикаций, имеющих метаданные, хранящиеся в **MSmerge_genhistory**, **MSmerge_contents**  и **MSmerge_tombstone** помечаются для повторной инициализации, теряются все ожидающие изменения на подписчике, а текущий моментальный снимок помечен как устаревший.  
> 
> [!NOTE]
>  Если имеется несколько публикаций в базе данных, и любого из этих публикаций использует бесконечный срок хранения публикации (**@retention**=**0**), выполняется  **sp_mergecleanupmetadata** не очищает метаданные для базы данных отслеживания изменений репликации слиянием. По этой причине, при использовании неограниченного срока хранения публикации необходимо помнить об осторожности.  
  
 При выполнении этой хранимой процедуры, можно выбрать повторную инициализацию подписчиков, установив **@reinitialize_subscriber** параметр **TRUE** (по умолчанию) или **FALSE**. Если **sp_mergecleanupmetadata** выполняется с **@reinitialize_subscriber** параметру присвоить **TRUE**, моментальный снимок применяется на подписчике, даже если подписка была создана без исходного моментального снимка (например, если данные моментального снимка и схема были вручную применены или уже существовали на подписчике). Параметр в **FALSE** следует использовать с осторожностью, так как при публикации повторно не инициализируется, необходимо убедиться, что синхронизации данных на издателе и подписчике.  
  
 Независимо от значения **@reinitialize_subscriber**, **sp_mergecleanupmetadata** завершится неудачей, если выполняются процессы слияния, пытающиеся передать изменения на издатель или переиздающий подписчик в время вызова хранимой процедуры.  
  
 **Выполнение процедуры sp_mergecleanupmetadata с @reinitialize_subscriber = TRUE:**  
  
1.  Рекомендуется (но не является обязательным) остановить все обновления баз данных публикации и подписки. Если обновления будут продолжаться, выполненные обновления на подписчике с момента последнего слияния теряются при повторной инициализации публикации; при этом конвергенция данных сохраняется.  
  
2.  Выполните слияние с помощью агента слияния. Мы рекомендуем использовать **-проверить** параметр командной строки агента на каждом подписчике при запуске агента слияния. Если вы используете непрерывном режиме слияния, см. в разделе *особые рекомендации о непрерывном режиме слияния* далее в этом разделе.  
  
3.  После завершения всех слияний, выполните **sp_mergecleanupmetadata**.  
  
4.  Выполнение **sp_reinitmergepullsubscription** на всех подписчиках при помощи подписки по запросу именованного или анонимного для обеспечения конвергенции данных.  
  
5.  Если вы используете непрерывном режиме слияния, см. в разделе *особые рекомендации о непрерывном режиме слияния* далее в этом разделе.  
  
6.  Восстановите файлы моментального снимка для всех публикаций слиянием, используемым на всех уровнях. При попытке слияния без предварительного повторного формирования моментального снимка будет предложено повторно сформировать моментальный снимок.  
  
7.  Выполните резервное копирование базы данных публикации. Невыполнение этого требования может вызвать сбой слияния после восстановления базы данных публикации.  
  
 **Выполнение процедуры sp_mergecleanupmetadata с @reinitialize_subscriber = FALSE:**  
  
1.  Остановить **все** обновления баз данных публикации и подписки.  
  
2.  Выполните слияние с помощью агента слияния. Мы рекомендуем использовать **-проверить** параметр командной строки агента на каждом подписчике при запуске агента слияния. Если вы используете непрерывном режиме слияния, см. в разделе *особые рекомендации о непрерывном режиме слияния* далее в этом разделе.  
  
3.  После завершения всех слияний, выполните **sp_mergecleanupmetadata**.  
  
4.  Если вы используете непрерывном режиме слияния, см. в разделе *особые рекомендации о непрерывном режиме слияния* далее в этом разделе.  
  
5.  Восстановите файлы моментального снимка для всех публикаций слиянием, используемым на всех уровнях. При попытке слияния без предварительного повторного формирования моментального снимка будет предложено повторно сформировать моментальный снимок.  
  
6.  Выполните резервное копирование базы данных публикации. Невыполнение этого требования может вызвать сбой слияния после восстановления базы данных публикации.  
  
 **Специальные рассуждения о непрерывном режиме слияния**  
  
 При выполнении слияния в непрерывном режиме необходимо:  
  
-   Остановить агент слияния и выполнить другое слияние без **-непрерывной** указан параметр.  
  
-   Деактивируйте публикацию при помощи **sp_changemergepublication** чтобы гарантировать, что любой слияний в непрерывном режиме, которые выполняют опрос о состоянии публикаций завершатся ошибкой.  
  
    ```  
    EXEC central..sp_changemergepublication @publication = 'dynpart_pubn', @property = 'status', @value = 'inactive'  
    ```  
  
 Когда Вы завершили шаг 3 выполнения **sp_mergecleanupmetadata**, возобновите непрерывный режим слияния был остановлен. Или:  
  
-   Добавить **-непрерывной** обратно для агента слияния.  
  
-   Заново активируйте публикацию с **sp_changemergepublication.**  
  
    ```  
    EXEC central..sp_changemergepublication @publication = 'dynpart_pubn', @property = 'status', @value = 'active'  
    ```  
  
## <a name="permissions"></a>Разрешения  
 Только члены **sysadmin** предопределенной роли сервера или **db_owner** предопределенной роли базы данных могут выполнять процедуру **sp_mergecleanupmetadata**.  
  
 Для использования данной хранимой процедуры на издателе должен использоваться [!INCLUDE[ssVersion2000](../../includes/ssversion2000-md.md)]. Подписчиках должен работать под управлением [!INCLUDE[ssVersion2000](../../includes/ssversion2000-md.md)] или [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 7.0 с пакетом обновления 2.  
  
## <a name="see-also"></a>См. также  
 [MSmerge_genhistory &#40;Transact-SQL&#41;](../../relational-databases/system-tables/msmerge-genhistory-transact-sql.md)   
 [MSmerge_contents &#40;Transact-SQL&#41;](../../relational-databases/system-tables/msmerge-contents-transact-sql.md)   
 [MSmerge_tombstone &#40;Transact-SQL&#41;](../../relational-databases/system-tables/msmerge-tombstone-transact-sql.md)  
  
  
