---
title: Хранимая процедура sp_trace_create (Transact-SQL) | Документация Майкрософт
ms.custom: ''
ms.date: 03/14/2017
ms.prod: sql
ms.prod_service: database-engine
ms.reviewer: ''
ms.technology: system-objects
ms.topic: language-reference
f1_keywords:
- sp_trace_create_TSQL
- sp_trace_create
dev_langs:
- TSQL
helpviewer_keywords:
- sp_trace_create
ms.assetid: f3a43597-4c5a-4520-bcab-becdbbf81d2e
author: stevestein
ms.author: sstein
ms.openlocfilehash: 7d698932bb7ef7e0fd37a0ced8ab536eeb0d5d68
ms.sourcegitcommit: b2464064c0566590e486a3aafae6d67ce2645cef
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/15/2019
ms.locfileid: "68096033"
---
# <a name="sptracecreate-transact-sql"></a>Хранимая процедура sp_trace_create (Transact-SQL)
[!INCLUDE[tsql-appliesto-ss2008-xxxx-xxxx-xxx-md](../../includes/tsql-appliesto-ss2008-xxxx-xxxx-xxx-md.md)]

  Создает определение трассировки. Новая трассировка будет находиться в остановленном состоянии.  
  
> [!IMPORTANT]  
>  [!INCLUDE[ssNoteDepFutureAvoid](../../includes/ssnotedepfutureavoid-md.md)] Вместо этого используйте расширенные события.  
  
 ![Значок ссылки на раздел](../../database-engine/configure-windows/media/topic-link.gif "Значок ссылки на раздел") [Синтаксические обозначения в Transact-SQL](../../t-sql/language-elements/transact-sql-syntax-conventions-transact-sql.md)  
  
## <a name="syntax"></a>Синтаксис  
  
```  
  
sp_trace_create [ @traceid = ] trace_id OUTPUT   
          , [ @options = ] option_value   
          , [ @tracefile = ] 'trace_file'   
     [ , [ @maxfilesize = ] max_file_size ]  
     [ , [ @stoptime = ] 'stop_time' ]  
     [ , [ @filecount = ] 'max_rollover_files' ]  
```  
  
## <a name="arguments"></a>Аргументы  
`[ @traceid = ] trace_id` — Номер, назначенный [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] для нового объекта trace. Любое значение, предложенное пользователем, не будет учитываться. *trace_id* — **int**, значение по умолчанию NULL. Пользователь применяет *trace_id* значение для определения, изменения и управлять трассировкой, определенной данной хранимой процедурой.  
  
`[ @options = ] option_value` Указывает набор параметров для трассировки. *option_value* — **int**, не имеет значения по умолчанию. Пользователи могут выбирать сочетания этих параметров путем указания их суммарного значения. Например, чтобы включить оба варианта TRACE_FILE_ROLLOVER и SHUTDOWN_ON_ERROR, указать **6** для *option_value*.  
  
 В следующей таблице содержится список параметров, их значений и описаний.  
  
|Имя параметра|Значение параметра|Описание|  
|-----------------|------------------|-----------------|  
|TRACE_FILE_ROLLOVER|**2**|Указывает, что при *max_file_size* достигнут текущий трассировочный файл закрывается и создается новый файл. Все новые записи будут сохраняться в новый файл. Новый файл будет иметь то же имя, что и предыдущий, но в конец имени будет добавлено число, показывающее его порядковый номер. Например, если изначально трассировочный файл назывался filename.trc, то следующий трассировочный файл будет называться filename_1.trc, имя следующего трассировочного файла будет filename_2.trc и т. д.<br /><br /> По мере увеличения количества трассировочных файлов число, добавляемое в конец имени файла, будет также последовательно увеличиваться.<br /><br /> SQL Server использует значение по умолчанию *max_file_size* (5 МБ) Если этот параметр указан без указания значения для *max_file_size*.|  
|SHUTDOWN_ON_ERROR|**4**|Указывает, что если трассировка не может быть записана в файл по какой-либо причине, SQL Server останавливается. Этот параметр полезен в случае проведения трассировок по проверке безопасности.|  
|TRACE_PRODUCE_BLACKBOX|**8**|Указывает, что запись последних 5 МБ трассировочных сведений, формируемых сервером, будет сохранена на сервере. Значение параметра TRACE_PRODUCE_BLACKBOX несовместимо со всеми другими.|  
  
`[ @tracefile = ] 'trace_file'` Указывает расположение и имя файла, к которому будет сохраняться трассировка. *trace_file* — **nvarchar(245)** не имеет значения по умолчанию. *trace_file* может быть именем локального каталога (например, N 'C:\MSSQL\Trace\trace.trc') или UNC-путь к общему (N'\\\\*Servername*\\*Sharename* \\ *Directory*\trace.trc').  
  
 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] добавит **.trc** расширение для всех имен файлов трассировки. Если параметр TRACE_FILE_ROLLOVER и *max_file_size* указаны, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] создает новый файл трассировки, если первоначальный файл трассировки увеличивается до максимального размера. Новый файл имеет имя, совпадающее с именем исходного файла, но _*n* добавляется для указания последовательности, начиная с **1**. Например, если первый файл трассировки назывался **filename.trc**, второй файл трассировки назывался **filename_1.trc**.  
  
 Если используется параметр TRACE_FILE_ROLLOVER, рекомендуется не использовать в имени исходного файла трассировки символы подчеркивания. Если используются символы подчеркивания, выполняются следующие действия.  
  
-   [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] не выполняет автоматическую нагрузки или предлагает загрузить файлы продолжения (если любой из этих параметров смены файла настроены).  
  
-   Функция fn_trace_gettable не загружает файлы продолжения (Если этот параметр указан *number_files* аргумент) которых имя исходного файла завершается подчеркиванием и числовое значение. (Это не относится к подчеркиваниям и числам, которые автоматически добавляются, когда выполняется переключение на файл продолжения.)  
  
> [!NOTE]  
>  В качестве временного решения в обоих случаях можно переименовать файлы трассировки, исключив подчеркивания из имени исходного файла. Например, если исходный файл имеет имя **my_trace.trc**, и файл продолжения имеет имя **my_trace_1.trc**, можно переименовать файлы **mytrace.trc** и **mytrace_1.trc** перед открытием файла в [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)].  
  
 *trace_file* не может быть указан при использовании параметра TRACE_PRODUCE_BLACKBOX.  
  
`[ @maxfilesize = ] max_file_size` Указывает, что максимальный размер в мегабайтах (МБ) файла трассировки. *max_file_size* — **bigint**, со значением по умолчанию **5**.  
  
 Если этот параметр указан без параметра TRACE_FILE_ROLLOVER, трассировка остановит запись в файл, когда используемое место на диске превышает сумму, указанную *max_file_size*.  
  
`[ @stoptime = ] 'stop_time'` Указывает дату и время остановки трассировки. *stop_time* — **datetime**, значение по умолчанию NULL. Если указано значение NULL, трассировка будет работать до тех пор, пока не будет остановлена вручную или пока не остановится сервер.  
  
 Если оба *stop_time* и *max_file_size* указаны, а параметр TRACE_FILE_ROLLOVER не указан, трассировка верхнему краю, по достижении максимального размера файла либо указанное время. Если *stop_time*, *max_file_size*и параметр TRACE_FILE_ROLLOVER, трассировка остановится в указанное время, при условии, что трассировка не заполняет на диске.  
  
`[ @filecount = ] 'max_rollover_files'` Указывает максимальное количество трассировочных файлов, образованных с одним базовым именем. *max_rollover_files* — **int**, превышающим единицу. Этот аргумент имеет смысл только в случае, если указан параметр TRACE_FILE_ROLLOVER. Когда *max_rollover_files* указано, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] пытается поддерживать не более чем *max_rollover_files* файлы трассировки, удаляя самые старые файлы перед открытием файла трассировки. [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] отслеживает возраст файлов трассировки, добавляя число в конец базового имени файла.  
  
 Например, если *trace_file* параметр указывается как «c:\mytrace», файл с именем «c:\mytrace_123.trc» старше, чем файл с именем «c:\mytrace_124.trc». Если *max_rollover_files* установлен в значение 2, то SQL Server удаляет трассировочный файл «c:\mytrace_123.trc» перед созданием трассировочного файла «c:\mytrace_125.trc»».  
  
 Обратите внимание, что [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] пытается удалить файл только один раз и не может удалить файл, используемый другим процессом. Поэтому, если другое приложение работает с файлами трассировки во время трассировки, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] может оставить эти файлы в файловой системе.  
  
## <a name="return-code-values"></a>Значения кода возврата  
 В следующей таблице описаны значения кодов, которые могут быть возвращены пользователю при завершении хранимой процедуры.  
  
|Код возврата|Описание|  
|-----------------|-----------------|  
|0|Нет ошибки.|  
|1|Неизвестная ошибка.|  
|10|Недопустимые параметры. Возвращается, если указанные параметры несовместимы.|  
|12|Файл не создан.|  
|13|Нехватка памяти. Возвращается, когда для выполнения указанного действия недостаточно памяти.|  
|14|Недопустимое время останова. Возвращается, если указанное время останова уже прошло.|  
|15|Недопустимые аргументы. Возвращается, если пользователь ввел несовместимые аргументы.|  
  
## <a name="remarks"></a>Примечания  
 **Хранимая процедура sp_trace_create** — [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] хранимую процедуру, которая выполняет многие действия, ранее выполнявшиеся **xp_trace_\***  расширенных хранимых процедур, доступных в более ранних версиях SQL Server. Используйте **sp_trace_create** вместо:  
  
-   **xp_trace_addnewqueue**  
  
-   **xp_trace_setqueuecreateinfo**  
  
-   **xp_trace_setqueuedestination**  
  
 **Хранимая процедура sp_trace_create** только создает определение трассировки. Эта хранимая процедура не может быть использована для запуска или изменения трассировки.  
  
 Аргументы всех SQL-трассировки хранимых процедур (**sp_trace_xx**) жестко типизированы. Если эти аргументы указываются с неправильными типами данных входных параметров, как указано в описании их аргументов, хранимая процедура возвратит ошибку.  
  
 Для **sp_trace_create**, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] учетная запись службы должна иметь разрешение на запись в папку с файлами трассировки. Если [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] учетная запись службы не является администратором на компьютере, где находится файл трассировки, необходимо явно предоставить разрешение на запись [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] учетной записи службы.  
  
> [!NOTE]  
>  Можно автоматически загружать файл трассировки, созданные с помощью **sp_trace_create** в таблицу с помощью **fn_trace_gettable** системной функции. Сведения об использовании этой системной функции см. в разделе [sys.fn_trace_gettable &#40;Transact-SQL&#41;](../../relational-databases/system-functions/sys-fn-trace-gettable-transact-sql.md).  
  
 Пример использования хранимых процедур трассировки см. в разделе [Создание трассировки (Transact-SQL)](../../relational-databases/sql-trace/create-a-trace-transact-sql.md).  
  
 **TRACE_PRODUCE_BLACKBOX** имеет следующие характеристики:  
  
-   Это продолжение трассировки. Значение по умолчанию *file_count* равно 2, но может быть переопределен пользователем в диалоговом окне *filecount* параметр.  
  
-   Значение по умолчанию *file_size* как для других трассировок составляет 5 МБ и может быть изменено.  
  
-   Не удалось задать имя файла. Файл будет сохранен как: **N'%SQLDIR%\MSSQL\DATA\blackbox.trc "**  
  
-   В трассировке будут содержаться только следующие события и их столбцы.  
  
    -   **Запуск RPC**  
  
    -   **Запуск пакета**  
  
    -   **исключение**  
  
    -   **Внимание**  
  
-   События или столбцы нельзя добавить или удалить из данной трассировки.  
  
-   Для данной трассировки нельзя указать фильтры.  
  
## <a name="permissions"></a>Разрешения  
 Пользователь должен иметь разрешение ALTER TRACE.  
  
## <a name="see-also"></a>См. также  
 [Хранимая процедура sp_trace_generateevent &#40;Transact-SQL&#41;](../../relational-databases/system-stored-procedures/sp-trace-generateevent-transact-sql.md)   
 [Хранимая процедура sp_trace_setevent (Transact-SQL)](../../relational-databases/system-stored-procedures/sp-trace-setevent-transact-sql.md)   
 [sp_trace_setfilter (Transact-SQL)](../../relational-databases/system-stored-procedures/sp-trace-setfilter-transact-sql.md)   
 [Хранимая процедура sp_trace_setstatus (Transact-SQL)](../../relational-databases/system-stored-procedures/sp-trace-setstatus-transact-sql.md)   
 [Трассировка SQL](../../relational-databases/sql-trace/sql-trace.md)  
  
  
