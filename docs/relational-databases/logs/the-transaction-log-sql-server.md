---
title: Журнал транзакций (SQL Server) | Документация Майкрософт
ms.custom: ''
ms.date: 01/04/2018
ms.prod: sql
ms.prod_service: database-engine
ms.reviewer: ''
ms.technology: supportability
ms.topic: conceptual
helpviewer_keywords:
- transaction logs [SQL Server], about
- databases [SQL Server], transaction logs
- logs [SQL Server], transaction logs
ms.assetid: d7be5ac5-4c8e-4d0a-b114-939eb97dac4d
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: fb0aef082375ebc3c278e982232b7a69fe41d187
ms.sourcegitcommit: b2464064c0566590e486a3aafae6d67ce2645cef
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/15/2019
ms.locfileid: "68083939"
---
# <a name="the-transaction-log-sql-server"></a>Журнал транзакций (SQL Server)
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md](../../includes/appliesto-ss-xxxx-xxxx-xxx-md.md)]
Каждая база данных [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] имеет журнал транзакций, в котором фиксируются все транзакции и производимые ими в базе изменения.
  
Журнал транзакций — это важная составляющая базы данных. Если система даст сбой, этот журнал поможет вам вернуть базу данных в согласованное состояние. 

Сведения об архитектуре и внутренних компонентах журнала транзакций см. в разделе [Руководство по архитектуре журнала транзакций SQL Server и управлению им](../../relational-databases/sql-server-transaction-log-architecture-and-management-guide.md).

> [!WARNING] 
> Удаляя или перемещая этот журнал, вы должны понимать все последствия этого действия. 

> [!TIP]
> Известные рабочие точки, от которых следует начинать применение журналов транзакций при восстановлении базы данных, создаются контрольными точками. Дополнительные сведения см. в статье [Контрольные точки базы данных (SQL Server)](../../relational-databases/logs/database-checkpoints-sql-server.md).  
  
## <a name="operations-supported-by-the-transaction-log"></a>Операции, поддерживаемые журналом транзакций  
 Журнал транзакций поддерживает следующие операции:  
  
-   восстановление отдельных транзакций;  
-   восстановление всех незавершенных транзакций при запуске [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ;  
-   накат восстановленной базы данных, файла, файловой группы или страницы до момента сбоя;  
-   поддержка репликации транзакций;  
-   Поддержка решений высокой уровня доступности и аварийного восстановления: [!INCLUDE[ssHADR](../../includes/sshadr-md.md)], зеркальное отображение базы данных и доставка журналов.

### <a name="individual-transaction-recovery"></a>Восстановление отдельных транзакций
Если приложение выполняет инструкцию `ROLLBACK` или ядро СУБД обнаруживает ошибку, например потерю связи с клиентом, записи журнала используются для отката изменений, сделанных незавершенной транзакцией. 

### <a name="recovery-of-all-incomplete-transactions-when-includessnoversionincludesssnoversion-mdmd-is-started"></a>Восстановление всех незавершенных транзакций при запуске [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]
Если на сервере происходит сбой, базы данных могут остаться в состоянии, когда часть изменений не переписана из буферного кэша в файлы данных, но в них имеются изменения, совершенные незаконченными транзакциями. Когда экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] будет запущен, он выполнит восстановление каждой базы данных. Будет выполнен накат каждого записанного в журнал изменения, которое, возможно, не было переписано в файл данных. Чтобы сохранить целостность базы данных, будет также произведен откат каждой незавершенной транзакции, найденной в журнале транзакций. 

### <a name="rolling-a-restored-database-file-filegroup-or-page-forward-to-the-point-of-failure"></a>Накат восстановленной базы данных, файла, файловой группы или страницы до момента сбоя
После потери оборудования или сбоя диска, затрагивающего файлы базы данных, можно восстановить базу данных на момент, предшествующий сбою. Сначала восстановите последнюю полную резервную копию и последнюю дифференциальную резервную копию базы данных, затем восстановите последующую серию резервных копий журнала транзакций до момента возникновения сбоя. 

Поскольку восстанавливается каждая резервная копия журнала, ядро СУБД повторно применяет все модификации, записанные в журнале, для наката всех транзакций. Когда последняя резервная копия журнала будет восстановлена, ядро СУБД начнет использовать данные журнала для отката всех транзакций, которые не были завершены на момент сбоя. 

### <a name="supporting-transactional-replication"></a>Поддержка репликации транзакций
Агент чтения журнала следит за журналами транзакций всех баз данных, которые настроены для репликации транзакций, и копирует отмеченные для репликации транзакции из журнала транзакций в базу данных распространителя. Дополнительные сведения о репликации транзакций см. в разделе [Как работает репликация транзакций](https://msdn.microsoft.com/library/ms151706.aspx).

### <a name="supporting-high-availability-and-disaster-recovery-solutions"></a>Поддержка решений высокого уровня доступности и аварийного восстановления
Решения резервного сервера, [!INCLUDE[ssHADR](../../includes/sshadr-md.md)], зеркальное отображение базы данных и доставка журналов в значительной степени опираются на журнал транзакций. 

В **сценарии "[!INCLUDE[ssHADR](../../includes/sshadr-md.md)]"** каждое изменение в базе данных (первичной реплике) немедленно воспроизводится в ее полных автономных копиях (вторичных репликах). Первичная реплика немедленно отсылает каждую запись журнала на вторичные реплики, которые применяют поступающие записи к базам данных групп доступности, производя непрерывный накат. Дополнительные сведения см. в разделе [Экземпляры отказоустойчивого кластера AlwaysOn](../../sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server.md).

В **сценарии доставки журналов** основной сервер отправляет активный журнал транзакций основной базы данных в определенное назначение или множество назначений. Каждый сервер-получатель восстанавливает журнал в свою локальную базу данных-получатель. Дополнительные сведения см. в разделе [Сведения о доставке журналов](../../database-engine/log-shipping/about-log-shipping-sql-server.md). 

В **сценарии зеркального отражения базы данных** каждое изменение в базе данных (основной базе данных) немедленно воспроизводится в ее полной автономной копии (зеркальной базе данных). Экземпляр основного сервера немедленно отсылает каждую запись журнала на экземпляр зеркального сервера, который применяет поступающие записи журнала к зеркальной базе данных, путем ее непрерывного наката. Дополнительные сведения см. в разделе [Зеркальное отображение базы данных](../../database-engine/database-mirroring/database-mirroring-sql-server.md).

##  <a name="Characteristics"></a>Transaction Log characteristics

Ниже приведены характеристики журнала транзакций [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)]. 
-  Журнал транзакций выполнен как отдельный файл или набор файлов в базе данных. Кэш журнала управляется отдельно от буферного кэша для страниц данных, что приводит к простому, быстрому и устойчивому коду в пределах компонента [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)]. Дополнительные сведения см. в разделе [Физическая архитектура журнала транзакций](../../relational-databases/sql-server-transaction-log-architecture-and-management-guide.md#physical_arch).
-  Формат записей журнала и страниц не обязан следовать формату страниц данных.
-  Журнал транзакций может располагаться в нескольких файлах. Вы можете задать для этих файлов автоматическое расширение, установив для журнала значение `FILEGROWTH`. Это снижает вероятность исчерпания пространства журнала транзакций, в то же самое время уменьшая административные издержки. Дополнительные сведения см. в разделе [Параметры инструкции ALTER DATABASE (Transact-SQL) для файлов и файловых групп](../../t-sql/statements/alter-database-transact-sql-file-and-filegroup-options.md).
-  Механизм многократного использования пространства в файлах журналов действует быстро и оказывает минимальное влияние на пропускную способность транзакций.

Сведения об архитектуре и внутренних компонентах журнала транзакций см. в разделе [Руководство по архитектуре журнала транзакций SQL Server и управлению им](../../relational-databases/sql-server-transaction-log-architecture-and-management-guide.md).

##  <a name="Truncation"></a> Усечение журнала транзакций  
Процесс усечения журнала освобождает место в файле журнала для повторного использования журналом транзакций. Необходимо регулярно усекать журнал транзакций, чтобы предотвратить переполнение выделенного пространства. По ряду причин его усечение может быть отложено, поэтому очень важно следить за размером журнала. Некоторые операции можно выполнять с минимальным протоколированием, чтобы сократить их вклад в размер журнала транзакций.  
 
Усечение журнала удаляет неактивные [виртуальные файлы журнала (VLF)](../../relational-databases/sql-server-transaction-log-architecture-and-management-guide.md#physical_arch) из логического журнала транзакций базы данных [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], освобождая в нем место для повторного использования физическим журналом транзакций. Если усечение журнала транзакций не выполняется, со временем он заполняет все доступное место на диске, отведенное для файлов физического журнала.  
  
В целях предотвращения этой проблемы усечение журнала выполняется автоматически после следующих событий, за исключением тех случаев, когда оно по каким-то причинам задерживается:  
  
- В простой модели восстановления — после достижения контрольной точки.  
- Для моделей полного восстановления и моделей восстановления с неполным протоколированием, если контрольная точка была создана после предыдущего резервного копирования, усечение происходит после резервного копирования журнала (если только это не резервная копия журнала только для копирования).  
  
 Дополнительные сведения см. в разделе [Факторы, которые могут вызвать задержку усечения журнала](#FactorsThatDelayTruncation) далее в этой статье.  
  
> [!NOTE]
> Усечение журнала не приводит к уменьшению размера физического файла журнала. Для уменьшения реального размера физического файла журнала необходимо выполнить его сжатие. Сведения о сжатии физического файла журнала см. в разделе [Управление размером файла журнала транзакций](../../relational-databases/logs/manage-the-size-of-the-transaction-log-file.md).  
> Следует учитывать [факторы, которые могут повлиять на задержку усечения журнала](#FactorsThatDelayTruncation). Если после сжатия журнала снова потребуется дисковое пространство, размер журнала транзакций снова будет увеличиваться, что повлияет на производительность во время операций увеличения.
  
##  <a name="FactorsThatDelayTruncation"></a> Factors that can delay log truncation  
 Когда записи журнала остаются активными длительное время, усечение журнала транзакций откладывается и возникает вероятность переполнения журнала транзакций, как описано ранее.  
  
> [!IMPORTANT]
> Дополнительные сведения о том, что нужно делать при переполнении журнала транзакций, см. в разделе [Troubleshoot a Full Transaction Log &#40;SQL Server Error 9002&#41;](../../relational-databases/logs/troubleshoot-a-full-transaction-log-sql-server-error-9002.md).  
  
 На самом деле усечение журнала может быть задержано из-за множества причин. Чтобы узнать причину, препятствующую усечению журнала транзакций в конкретном случае, выполните запрос по столбцам **log_reuse_wait** и **log_reuse_wait_desc** представления каталога [sys.database](../../relational-databases/system-catalog-views/sys-databases-transact-sql.md). В следующей таблице описаны значения этих столбцов.  
  
|Значение столбца log_reuse_wait|Значение столбца log_reuse_wait_desc|Описание|  
|----------------------------|----------------------------------|-----------------|  
|0|NOTHING;|Сейчас есть как минимум один [виртуальный файл журнала (VLF)](../../relational-databases/sql-server-transaction-log-architecture-and-management-guide.md#physical_arch), доступный для повторного использования.|  
|1|CHECKPOINT|С момента последнего усечения журнала новых контрольных точек не было, либо заголовок журнала пока не вышел за пределы [виртуального файла журнала (VLF)](../../relational-databases/sql-server-transaction-log-architecture-and-management-guide.md#physical_arch). (Все модели восстановления)<br /><br /> Это широко распространенная причина задержки усечения журнала. Дополнительные сведения см. в разделе [Database Checkpoints &#40;SQL Server&#41;](../../relational-databases/logs/database-checkpoints-sql-server.md).|  
|2|LOG_BACKUP|Требуется выполнить резервное копирование журналов, поскольку лишь после этого журнал транзакций может быть усечен. (Только для моделей полного восстановления и моделей восстановления с неполным протоколированием)<br /><br /> После завершения создания следующей резервной копии журнала некоторое пространство журнала может освободиться для повторного использования.|  
|3|ACTIVE_BACKUP_OR_RESTORE|Выполняется резервное копирование или восстановление данных (для всех моделей восстановления).<br /><br /> Если усечению журнала препятствует резервное копирование данных, то проблему может решить отмена операции резервного копирования.|  
|4|ACTIVE_TRANSACTION|Активна одна из транзакций (для всех моделей восстановления).<br /><br /> Во время начала создания резервной копии журнала может существовать длительная транзакция. В этом случае, чтобы освободить пространство, может потребоваться создание другой резервной копии журнала. Помните, что длительные транзакции препятствуют усечению журнала во всех моделях восстановления, включая простую модель восстановления, в которой журнал транзакций обычно усекается на каждой автоматической контрольной точке.<br /><br /> Транзакция отложена. *Отложенная транзакция* — это активная транзакция, откат которой был заблокирован по причине недоступности какого-либо ресурса. Дополнительные сведения о причинах, вызывающих появление отложенных транзакций, и о том, как их можно вывести из такого состояния, см. в статье [Отложенные транзакции (SQL Server)](../../relational-databases/backup-restore/deferred-transactions-sql-server.md).<br /> <br /> Длительные транзакции также могут переполнить журнал транзакций базы данных tempdb. Пользовательские транзакции неявно используют базу данных tempdb для внутренних объектов, например для сортировки рабочих таблиц, хэширования рабочих файлов, перемещения рабочих таблиц и управления версиями строк. Даже если пользовательская транзакция только считывает данные (запросы `SELECT`), внутренние объекты могут быть созданы и использованы в пользовательских транзакциях. В результате журнал транзакций базы данных tempdb может быть заполнен.|  
|5|DATABASE_MIRRORING|Зеркальное отображение базы данных приостановлено или в режиме высокой производительности зеркальная база данных намного отстает от основной. (Только для модели полного восстановления)<br /><br /> Дополнительные сведения см. в статье [Зеркальное отображение базы данных (SQL Server)](../../database-engine/database-mirroring/database-mirroring-sql-server.md).|  
|6|REPLICATION|Во время репликации транзакций в базу данных распространителя не доставляются транзакции, имеющие отношение к публикациям. (Только для модели полного восстановления)<br /><br /> Дополнительные сведения о репликации транзакций см. в разделе [SQL Server Replication](../../relational-databases/replication/sql-server-replication.md).|  
|7|DATABASE_SNAPSHOT_CREATION|Создается моментальный снимок базы данных. (Все модели восстановления)<br /><br /> Это очень распространенная (и обычно кратковременная) причина задержки усечения журнала транзакций.|  
|8|LOG_SCAN|Производится просмотр журнала. (Все модели восстановления)<br /><br /> Это очень распространенная (и обычно кратковременная) причина задержки усечения журнала транзакций.|  
|9|AVAILABILITY_REPLICA|Вторичная реплика группы доступности применяет записи журнала транзакций этой базы данных к соответствующей базе данных-получателю. (Модель полного восстановления)<br /><br /> Дополнительные сведения см. в статье [Обзор групп доступности AlwaysOn (SQL Server)](../../database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server.md).|  
|10|-|Только для внутреннего применения|  
|11|-|Только для внутреннего применения|  
|12|-|Только для внутреннего применения|  
|13|OLDEST_PAGE|Если в базе данных настроено использование косвенных контрольных точек, самая старая страница в базе может быть старше [регистрационного номера транзакции в журнале (LSN)](../../relational-databases/sql-server-transaction-log-architecture-and-management-guide.md#Logical_Arch) для контрольной точки. В этом случае самая старая страница может задержать усечение журнала. (Все модели восстановления)<br /><br /> Сведения о косвенных контрольных точках см. в статье [Database Checkpoints &#40;SQL Server&#41;](../../relational-databases/logs/database-checkpoints-sql-server.md).|  
|14|OTHER_TRANSIENT|Эта значение сейчас не используется.|  
  
##  <a name="MinimallyLogged"></a> Операции, допускающие минимальное протоколирование  
*Минимальное протоколирование* — это протоколирование только информации, необходимой для восстановления транзакции без поддержки восстановления на момент времени. В этом разделе определяются операции, которые подлежат минимальному протоколированию в [модели восстановления](../backup-restore/recovery-models-sql-server.md) с неполным протоколированием (как и в простой модели восстановления, кроме случаев, когда выполняется резервное копирование).  
  
> [!NOTE]
> Минимальное протоколирование не поддерживается для оптимизированных для памяти таблиц.  
  
> [!NOTE]
> В [модели полного восстановления](../backup-restore/recovery-models-sql-server.md)все массовые операции полностью протоколируются. Однако для набора массовых операций можно использовать минимальное протоколирование, временно переключив базу данных на модель восстановления с неполным протоколированием во время массовых операций. Минимальное протоколирование более эффективно, чем полное, и снижает вероятность того, что во время массовой операции большого объема будет заполнено все доступное пространство журнала транзакций. Однако, если при включенном минимальном протоколировании база данных будет повреждена или потеряна, ее нельзя будет восстановить до точки сбоя.  
  
 Следующие операции, выполняемые с полным протоколированием в модели полного восстановления, осуществляются с минимальным протоколированием в простой модели восстановления и модели восстановления с неполным протоколированием:  
  
-   Операции массового импорта ([bcp](../../tools/bcp-utility.md), [BULK INSERT](../../t-sql/statements/bulk-insert-transact-sql.md) и [INSERT... SELECT](../../t-sql/statements/insert-transact-sql.md)). Дополнительные сведения о том, когда массовый импорт в таблицу подлежит минимальному протоколированию, см. в разделе [Prerequisites for Minimal Logging in Bulk Import](../../relational-databases/import-export/prerequisites-for-minimal-logging-in-bulk-import.md).  
  
Если включена репликация транзакций, операции `BULK INSERT` протоколируются полностью даже в модели восстановления с неполным протоколированием.  
  
-   Операции [SELECT INTO](../../t-sql/queries/select-into-clause-transact-sql.md).  
  
Если включена репликация транзакций, операции SELECT INTO полностью протоколируются даже в модели восстановления с неполным протоколированием.  
  
-   Частичные изменения типов данных с большими значениями с помощью предложения `.WRITE` инструкции [UPDATE](../../t-sql/queries/update-transact-sql.md) при вставке или добавлении новых данных. Обратите внимание, что минимальное протоколирование не используется при обновлении существующих значений. Дополнительные сведения о больших типах-значениях см. в статье [Типы данных (Transact-SQL)](../../t-sql/data-types/data-types-transact-sql.md).  
  
-   Инструкции[WRITETEXT](../../t-sql/queries/writetext-transact-sql.md) и [UPDATETEXT](../../t-sql/queries/updatetext-transact-sql.md) при вставке или добавлении новых данных в столбцы с типом данных **text**, **ntext**, и **image** . Обратите внимание, что минимальное протоколирование не используется при обновлении существующих значений.  
  
    > [!WARNING]
    > Инструкции `WRITETEXT` и `UPDATETEXT` являются **устаревшими**, поэтому старайтесь не использовать их в новых приложениях.  
  
-   Если в базе данных используется простая модель восстановления или модель восстановления с неполным протоколированием, некоторые DDL-операции с индексом протоколируются в минимальном объеме при их выполнении как режиме «вне сети», так и в режиме «в сети». Минимально протоколируются следующие операции с индексами.  
  
    -   Операции[CREATE INDEX](../../t-sql/statements/create-index-transact-sql.md) (включая индексированные представления).  
  
    -   Операции[ALTER INDEX](../../t-sql/statements/alter-index-transact-sql.md) REBUILD или DBCC DBREINDEX.  
  
        > [!WARNING]
        > Инструкция `DBCC DBREINDEX` является **устаревшей**. Не используйте ее в новых приложениях.  
  
    -   Перестроение новой кучи [DROP INDEX](../../t-sql/statements/drop-index-transact-sql.md) (если применимо). Освобождение страниц индексов при выполнении операции `DROP INDEX` **всегда** протоколируется полностью.
  
##  <a name="RelatedTasks"></a> Related tasks  
**Управление журналом транзакций**  
  
-   [Управление размером файла журнала транзакций](../../relational-databases/logs/manage-the-size-of-the-transaction-log-file.md)  
  
-   [Устранение неполадок при переполнении журнала транзакций (ошибка SQL Server 9002)](../../relational-databases/logs/troubleshoot-a-full-transaction-log-sql-server-error-9002.md)  
  
**Резервное копирование журнала транзакций (модель полного восстановления)**  
  
-   [Создание резервной копии журнала транзакций &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-a-transaction-log-sql-server.md)  
  
**Восстановление журнала транзакций (модель полного восстановления)**  
  
-   [Восстановление резервной копии журнала транзакций (SQL Server)](../../relational-databases/backup-restore/restore-a-transaction-log-backup-sql-server.md)  
  
## <a name="see-also"></a>См. также раздел  
[Руководство по архитектуре журнала транзакций SQL Server и управлению им](../../relational-databases/sql-server-transaction-log-architecture-and-management-guide.md)   
[Управление устойчивостью транзакций](../../relational-databases/logs/control-transaction-durability.md)   
[Предварительные условия для минимального протоколирования массового импорта данных](../../relational-databases/import-export/prerequisites-for-minimal-logging-in-bulk-import.md)   
[Резервное копирование и восстановление баз данных SQL Server](../../relational-databases/backup-restore/back-up-and-restore-of-sql-server-databases.md)   
[Контрольные точки базы данных &#40;SQL Server&#41;](../../relational-databases/logs/database-checkpoints-sql-server.md)   
[Просмотр или изменение свойств базы данных](../../relational-databases/databases/view-or-change-the-properties-of-a-database.md)   
[Модели восстановления (SQL Server)](../../relational-databases/backup-restore/recovery-models-sql-server.md)  
[Резервные копии журналов транзакций (SQL Server)](../../relational-databases/backup-restore/transaction-log-backups-sql-server.md)    
[sys.dm_db_log_info (Transact-SQL)](../../relational-databases/system-dynamic-management-views/sys-dm-db-log-info-transact-sql.md)  
[sys.dm_db_log_space_usage (Transact-SQL)](../../relational-databases/system-dynamic-management-views/sys-dm-db-log-space-usage-transact-sql.md)    
  
  
