---
title: Использование параметров ODBC Table-Valued (ru) Документы Майкрософт
ms.custom: ''
ms.date: 03/14/2017
ms.prod: sql
ms.prod_service: database-engine, sql-database, sql-data-warehouse, pdw
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- table-valued parameters (ODBC), scenarios
- ODBC, table-valued parameters
ms.assetid: f1b73932-4570-4a8a-baa0-0f229d9c32ee
author: markingmyname
ms.author: maghan
monikerRange: '>=aps-pdw-2016||=azuresqldb-current||=azure-sqldw-latest||>=sql-server-2016||=sqlallproducts-allversions||>=sql-server-linux-2017||=azuresqldb-mi-current'
ms.openlocfilehash: e88092c6566d9e5838f8a2cb59cd7c23564af9b9
ms.sourcegitcommit: ce94c2ad7a50945481172782c270b5b0206e61de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/14/2020
ms.locfileid: "81297752"
---
# <a name="uses-of-odbc-table-valued-parameters"></a>Сценарии использования возвращающих табличное значение параметров ODBC
[!INCLUDE[appliesto-ss-asdb-asdw-pdw-md](../../includes/appliesto-ss-asdb-asdw-pdw-md.md)]

  В данном разделе обсуждаются основные пользовательские сценарии для использования возвращающих табличное значение параметров ODBC.  
  
-   Возвращающий табличное значение параметр с многострочными буферами с полной привязкой (отправка данных в виде возвращающего табличное значение параметра со всеми значениями в памяти)  
  
-   Возвращающий табличное значение параметр с поддержкой потоковой работы со строками (отправка данных в виде возвращающего табличное значение параметра с использованием данных времени выполнения).  
  
-   Получение метаданных возвращающих табличное значение параметров из системного каталога  
  
-   Получение метаданных возвращающих табличное значение параметров для подготовленной инструкции  
  
## <a name="table-valued-parameter-with-fully-bound-multirow-buffers-send-data-as-a-tvp-with-all-values-in-memory"></a>Возвращающий табличное значение параметр с многострочными буферами с полной привязкой (отправка данных в виде возвращающего табличное значение параметра со всеми значениями в памяти)  
 При использовании с многострочными буферами с полной привязкой все значения параметров доступны в памяти. Например, это характерно для транзакции OLTP, в которой возвращающие табличное значение параметры могут быть упакованы в одну хранимую процедуру. Без возвращающих табличное значение параметров для этого потребовалось бы динамическое создание сложного пакета с несколькими инструкциями или несколько обращений к серверу.  
  
 Сам параметр, оцениваемый таблицей, связан с использованием [S'LBindParameter](https://go.microsoft.com/fwlink/?LinkId=59328) наряду с другими параметрами. После того, как все параметры были связаны, приложение устанавливает атрибут фокусировки параметра, SQL_SOPT_SS_PARAM_FOCUS, на каждом параметре, ценном на таблицу, и вызывает S'LBindParameter для столбцов параметра, оцениваемого таблицей.  
  
 Тип сервера для возвращающего табличное значение параметра является новым типом [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], SQL_SS_TABLE. Типом привязки C для типа SQL_SS_TABLE должен быть всегда SQL_C_DEFAULT. Никакие данные для параметра, привязанного к возвращающему табличное значение параметру, не передаются; они используются, чтобы передавать метаданные таблицы и управлять передачей данных в столбцах, составляющих возвращающий табличное значение параметр.  
  
 Длина возвращающего табличное значение параметра устанавливается в значение количества строк, отправленных серверу. Параметр *ColumnSize* S'LBindParameter для параметра, оцениваемого таблицей, определяет максимальное количество строк, которые могут быть отправлены; это размер массива буферов столбца. *ParameterValuePtr* является параметром, для параметра, оцениваемого таблицей, в S'LBindParameter. *ParameterValuePtr* и связанный с ним *BufferLength* используются для передачи типа параметра, оцениваемого в таблице, при необходимости. Имя типа не требуется для вызова хранимой процедуры, но требуется для инструкций SQL.  
  
 Когда имя типа параметра, оцениваемого таблицей, указывается на вызове к S'LBindParameter, оно всегда должно быть указано как значение Unicode, даже в приложениях, которые построены как приложения ANSI. При указании имени типа параметров, оцениваемого в таблице, с помощью S'LSetDescfield можно использовать букву, соответствующую способу построения приложения. Диспетчер драйвера ODBC выполнит все необходимые преобразования данных в Юникод.  
  
 Метаданные для параметров, оцениваемых таблицей, и столовых столбцов параметра можно манипулировать индивидуально и явно с помощью S'LGetDesccRec, S'LSetDescRec, S'LGetDescField и S'LSetDescField. Тем не менее, перегрузка S'LBindParameter, как правило, более удобна и не требует явного доступа к дескриптору в большинстве случаев. Этот подход согласуется с определением S'LBindParameter для других типов данных, за исключением того, что для параметра, оцениваемого таблицей, пораженные поля дескриптора немного отличаются.  
  
 Иногда приложение использует возвращающий табличное значение параметр с динамическими инструкциями SQL, при этом имя типа возвращающего табличное значение параметра должно быть указано. Если это так, и параметр, оцениваемый в таблице таблицы, не определен в текущей схеме по умолчанию для соединения, SQL_CA_SS_TYPE_CATALOG_NAME и SQL_CA_SS_TYPE_SCHEMA_NAME должны быть установлены с помощью S'LSetDescField. Так как определения табличного типа и возвращающие табличное значение параметры должны находиться в одной базе данных, значение SQL_CA_SS_TYPE_CATALOG_NAME не должно быть установлено, если приложение использует возвращающие табличное значение параметры. В противном случае, S'LSetDescField сообщит об ошибке.  
  
 Пример кода для этого сценария `demo_fixed_TVP_binding` находится в процедуре в [параметрах использования таблицы &#40;odBC&#41;. ](../../relational-databases/native-client-odbc-how-to/use-table-valued-parameters-odbc.md)  
  
## <a name="table-valued-parameter-with-row-streaming-send-data-as-a-tvp-using-data-at-execution"></a>Возвращающий табличное значение параметр с поддержкой потоковой работы со строками (отправка данных в виде возвращающего табличное значение параметра с использованием данных времени выполнения).  
 В данном сценарии приложение передает строки драйверу, когда он их запрашивает, и они передаются потоком на сервер. Это помогает избежать буферизации всех строк в памяти. Это типично для массовой вставки или обновления сценариев. Возвращающие табличное значение параметры обеспечивают показатель производительности где-то между массивами параметров и массовым копированием. То есть возвращающие табличное значение параметры почти так же легко программировать, как и массивы параметров, но они дают большую гибкость на сервере.  
  
 Возвращающий табличное значение параметр и его столбцы привязаны, как описано в предыдущем разделе «Возвращающий табличное значение параметр с многострочными буферами с полной привязкой», но признак длины возвращающего табличное значение параметра установлен в значение SQL_DATA_AT_EXEC. Драйвер отвечает на S'LExecute или S'LExecuteDirect обычным способом для параметров data-at-execution, то есть, возвращая SQL_NEED_DATA. Когда драйвер готов принимать данные по параметру, оцениваемому таблицей, S'LParamData возвращает значение *ParameterValuePtr* в S'LBindParameter.  
  
 Приложение использует параметр, оцениваемый таблицей, для обозначения наличия данных для столбцов параметров, оцениваемых таблицей. При вызове параметра, ценящемся на таблицу, *DataPtr* всегда должен быть нулевым, а *StrLen_or_Ind* должно быть либо 0, либо число меньше или равно размеру массива, указанному для буферов параметров, оцениваемых таблицей (параметр *ColumnSize* S'LBindParameter). 0 обозначает, что в возвращающем табличное значение параметре больше нет строк и драйвер продолжит обработку со следующего фактического параметра процедуры. Когда *StrLen_or_Ind* не 0, драйвер обрабатывает составные столбцы параметров, оцениваемых таблицей, так же, как и нестоловые параметры, связанные параметра: каждый столбец параметра, оцениваемый таблицей, может указать свою фактическую длину данных, SQL_NULL_DATA, или он может указать данные при выполнении через буфер длины/индикатора. Значения столбца параметра, оцениваемого таблицей, могут передаваться путем повторных вызовов в S'LPutData, как обычно, когда символ или двоичное значение должны быть переданы по частям.  
  
 После того как все столбцы возвращающего табличное значение параметра были обработаны, драйвер снова обращается к возвращающему табличное значение параметру для обработки следующих строк данных возвращающего табличное значение параметра. Поэтому для возвращающих табличное значение параметров с данными времени выполнения драйвер не выполняет обычный последовательный просмотр привязанных параметров. Связанный параметр, оцениваемый таблицей, будет опрошен до тех пор, пока не будет вызванs S'LPutData с *StrLen_Or_IndPtr* равным 0, в это время водитель пропускает столбцы параметров, оцениваемых таблицей, и переходит к следующему фактическому параметру сохраненной процедуры.  Когда значение индикатора превышает или равно 1, драйвер обрабатывает столбцы параметров и строки, оцениваемые таблицей, пока не будет значения для всех связанных строк и столбцов. Затем драйвер возвращается к возвращающему табличное значение параметру. Между получением токена для параметра, оцениваемого таблицей, от S'LParamData и вызовом S'LPutData (hstmt, NULL, n) для параметра, ценного на стол, приложение должно настроить данные о компонентном столбце параметров и содержимое буфера индикатора для следующего ряда или строк, которые будут переданы серверу.  
  
 Пример кода для этого сценария `demo_variable_TVP_binding` находится в обычной режиме в [таблице использования таблицы ценных параметров &#40;ODBC&#41;. ](../../relational-databases/native-client-odbc-how-to/use-table-valued-parameters-odbc.md)  
  
## <a name="retrieving-table-valued-parameter-metadata-from-the-system-catalog"></a>Получение метаданных возвращающих табличное значение параметров из системного каталога  
 Когда приложение вызывает S'LProcedureColumns для процедуры, которая имеет параметры параметров, оцениваемых таблицей, DATA_TYPE возвращается как SQL_SS_TABLE и TYPE_NAME — это название типа таблицы для параметра, оцениваемого таблицей. К набору результатов, возвращенному S'LProcedureColumns, добавляются два дополнительных столбца: SS_TYPE_CATALOG_NAME возвращает имя каталога, где определяется тип таблицы параметра столовой значения, и SS_TYPE_SCHEMA_NAME возвращает имя схемы, где определяется тип таблицы параметра столовой значения. В соответствии со спецификацией ODBC SS_TYPE_CATALOG_NAME и SS_TYPE_SCHEMA_NAME применяются до всех столбцов драйвера, которые были добавлены в предыдущих версиях [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], и после всех столбцов, применяемых ODBC.  
  
 Новые столбцы будут заполнены не только для возвращающих табличное значение параметров, но и для параметров определенного пользователем типа данных CLR. Существующие схема и столбцы каталога параметров определяемого пользователем типа будут все равно заполнены, но наличие общих схемы и столбцов каталога для типов данных, для которых они требуются, упростит разработку приложения в будущем. (Следует отметить, что коллекции схем XML несколько отличаются и не включаются в это изменение).  
  
 Приложение использует S'LTables для определения имен типов таблиц так же, как и для постоянных таблиц, системных таблиц и представлений. Новый табличный тип TABLE TYPE вводится, чтобы приложение могло определить табличный тип, связанный с возвращающими табличное значение параметрами. Табличные типы и обычные таблицы используют различные пространства имен. Это значит, что можно использовать одно и то же имя как для табличного типа, так и для существующей таблицы. Для обработки этой ситуации был введен новый атрибут инструкции SQL_SOPT_SS_NAME_SCOPE. Этот атрибут определяет, должны ли S'LTables и другие функции каталога, которые берут имя таблицы в качестве параметра, интерпретировать имя таблицы как имя фактической таблицы или имя типа таблицы.  
  
 Приложение использует S'LColumns для определения столбцов для типа таблицы так же, как и для постоянных таблиц, но сначала должно установить SQL_SOPT_SS_NAME_SCOPE, чтобы указать, что оно работает с типами таблиц, а не с фактическими таблицами. Кроме того, с помощью SQL_SOPT_SS_NAME_SCOPE можно использовать s'LPrimaryKeys с типами таблиц.  
  
 Пример кода для этого сценария `demo_metadata_from_catalog_APIs` находится в обычной режиме в [таблице использования таблицы ценных параметров &#40;ODBC&#41;. ](../../relational-databases/native-client-odbc-how-to/use-table-valued-parameters-odbc.md)  
  
## <a name="retrieving-table-valued-parameter-metadata-for-a-prepared-statement"></a>Получение метаданных возвращающих табличное значение параметров для подготовленной инструкции  
 В этом случае приложение использует параметры S'LNum Parameters и S'LDescribeParam для извлечения метаданных для параметров, ценных на стол.  
  
 IPD-поле атрибута SQL_CA_SS_TYPE_NAME используется для получения имени типа для возвращающего табличное значение параметра. IPD-поля атрибутов SQL_CA_SS_TYPE_SCHEMA_NAME и SQL_CA_SS_TYPE_CATALOG_NAME используются соответственно для получения каталога и схемы этого параметра.  
  
 Определения табличных типов и возвращающие табличное значение параметры должны находиться в одной базе данных. СЗЛСетДескФилд сообщит об ошибке, если приложение устанавливает SQL_CA_SS_TYPE_CATALOG_NAME при использовании параметров, ценных на стол.  
  
 Атрибуты SQL_CA_SS_TYPE_CATALOG_NAME и SQL_CA_SS_TYPE_SCHEMA_NAME могут также использоваться для получения каталога и схемы, связанных с параметрами определяемых пользователем типов данных CLR. Атрибуты SQL_CA_SS_TYPE_CATALOG_NAME и SQL_CA_SS_TYPE_SCHEMA_NAME представляют собой альтернативу существующим атрибутам типов в схеме каталогов для определяемых пользователем типов данных CLR.  
  
 Приложение использует метаданные столбцов для получения метаданных столбца для параметра, оцениваемого таблицей, в этом сценарии, так как S'LDescribeParam не возвращает метаданные для столбцов столбца параметров, оцениваемых таблицей.  
  
 Пример кода для этого случая `demo_metadata_from_prepared_statement` использования находится в обычном режиме в [Параметрах с ценой таблицы использования &#40;&#41;ODBC. ](../../relational-databases/native-client-odbc-how-to/use-table-valued-parameters-odbc.md)  
  
## <a name="see-also"></a>См. также:  
 [Параметры, оцененные таблицей, &#40;&#41;ODBC](../../relational-databases/native-client-odbc-table-valued-parameters/table-valued-parameters-odbc.md)  
  
  
