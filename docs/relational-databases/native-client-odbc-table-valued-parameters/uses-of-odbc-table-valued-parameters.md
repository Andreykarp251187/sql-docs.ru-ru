---
title: Варианты использования возвращающих табличное значение параметров ODBC | Документация Майкрософт
ms.custom: ''
ms.date: 03/14/2017
ms.prod: sql
ms.prod_service: database-engine, sql-database, sql-data-warehouse, pdw
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- table-valued parameters (ODBC), scenarios
- ODBC, table-valued parameters
ms.assetid: f1b73932-4570-4a8a-baa0-0f229d9c32ee
author: MightyPen
ms.author: genemi
manager: craigg
monikerRange: '>=aps-pdw-2016||=azuresqldb-current||=azure-sqldw-latest||>=sql-server-2016||=sqlallproducts-allversions||>=sql-server-linux-2017||=azuresqldb-mi-current'
ms.openlocfilehash: 5421467aaf516ca3f1f153979916be01f9160d05
ms.sourcegitcommit: 3026c22b7fba19059a769ea5f367c4f51efaf286
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/15/2019
ms.locfileid: "62738225"
---
# <a name="uses-of-odbc-table-valued-parameters"></a>Сценарии использования возвращающих табличное значение параметров ODBC
[!INCLUDE[appliesto-ss-asdb-asdw-pdw-md](../../includes/appliesto-ss-asdb-asdw-pdw-md.md)]
[!INCLUDE[SNAC_Deprecated](../../includes/snac-deprecated.md)]

  В данном разделе обсуждаются основные пользовательские сценарии для использования возвращающих табличное значение параметров ODBC.  
  
-   Возвращающий табличное значение параметр с многострочными буферами с полной привязкой (отправка данных в виде возвращающего табличное значение параметра со всеми значениями в памяти)  
  
-   Возвращающий табличное значение параметр с поддержкой потоковой работы со строками (отправка данных в виде возвращающего табличное значение параметра с использованием данных времени выполнения).  
  
-   Получение метаданных возвращающих табличное значение параметров из системного каталога  
  
-   Получение метаданных возвращающих табличное значение параметров для подготовленной инструкции  
  
## <a name="table-valued-parameter-with-fully-bound-multirow-buffers-send-data-as-a-tvp-with-all-values-in-memory"></a>Возвращающий табличное значение параметр с многострочными буферами с полной привязкой (отправка данных в виде возвращающего табличное значение параметра со всеми значениями в памяти)  
 При использовании с многострочными буферами с полной привязкой все значения параметров доступны в памяти. Например, это характерно для транзакции OLTP, в которой возвращающие табличное значение параметры могут быть упакованы в одну хранимую процедуру. Без возвращающих табличное значение параметров для этого потребовалось бы динамическое создание сложного пакета с несколькими инструкциями или несколько обращений к серверу.  
  
 Возвращающие табличные значения параметра, привязанного с помощью [SQLBindParameter](https://go.microsoft.com/fwlink/?LinkId=59328) вместе с другими параметрами. После привязки всех параметров приложение устанавливает атрибут фокуса параметра, SQL_SOPT_SS_PARAM_FOCUS, для каждого возвращающего табличное значение параметра и вызывает SQLBindParameter для столбцов возвращающих табличные значения параметра.  
  
 Тип сервера для возвращающего табличное значение параметра является новым типом [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], SQL_SS_TABLE. Типом привязки C для типа SQL_SS_TABLE должен быть всегда SQL_C_DEFAULT. Никакие данные для параметра, привязанного к возвращающему табличное значение параметру, не передаются; они используются, чтобы передавать метаданные таблицы и управлять передачей данных в столбцах, составляющих возвращающий табличное значение параметр.  
  
 Длина возвращающего табличное значение параметра устанавливается в значение количества строк, отправленных серверу. *ColumnSize* параметр SQLBindParameter для возвращающих табличные значения параметра указывает максимальное количество строк, которые можно отправить; это размер массива буфера столбцов. *ParameterValuePtr* является буфером параметров, возвращающих табличные значения параметра в SQLBindParameter. *ParameterValuePtr* и связанный с ним *BufferLength* используются для передачи имени типа, возвращающих табличные значения параметра при необходимости. Имя типа не требуется для вызова хранимой процедуры, но требуется для инструкций SQL.  
  
 При указании имени типа возвращающего табличное значение параметра во время вызова SQLBindParameter его всегда необходимо указать как значение Юникода, даже в тех приложениях, построенных с кодировкой ANSI. При указании имени типа возвращающего табличное значение параметра с помощью SQLSetDescField, можно использовать литерал, который соответствует способу построения приложения. Диспетчер драйвера ODBC выполнит все необходимые преобразования данных в Юникод.  
  
 Метаданные для возвращающих табличные значения параметров и столбцов возвращающих табличные значения параметров можно управлять отдельно и явно с помощью SQLGetDescRec, SQLSetDescRec, SQLGetDescField и SQLSetDescField. Однако перегрузка SQLBindParameter обычно более удобно и не требует явного доступа к дескриптору в большинстве случаев. Этот подход согласован с определением функции SQLBindParameter для других типов данных, за исключением того, что для возвращающих табличные значения параметра затронутые поля дескриптора, немного отличаются.  
  
 Иногда приложение использует возвращающий табличное значение параметр с динамическими инструкциями SQL, при этом имя типа возвращающего табличное значение параметра должно быть указано. Если это так, а табличное значение параметра не определен в текущей схеме по умолчанию для подключения, SQL_CA_SS_TYPE_CATALOG_NAME и SQL_CA_SS_TYPE_SCHEMA_NAME должно иметь значение с помощью SQLSetDescField. Так как определения табличного типа и возвращающие табличное значение параметры должны находиться в одной базе данных, значение SQL_CA_SS_TYPE_CATALOG_NAME не должно быть установлено, если приложение использует возвращающие табличное значение параметры. В противном случае SQLSetDescField сообщит об ошибке.  
  
 Пример кода для этого сценария находится в процедуре `demo_fixed_TVP_binding` в [параметров, возвращающих &#40;ODBC&#41;](../../relational-databases/native-client-odbc-how-to/use-table-valued-parameters-odbc.md).  
  
## <a name="table-valued-parameter-with-row-streaming-send-data-as-a-tvp-using-data-at-execution"></a>Возвращающий табличное значение параметр с поддержкой потоковой работы со строками (отправка данных в виде возвращающего табличное значение параметра с использованием данных времени выполнения).  
 В данном сценарии приложение передает строки драйверу, когда он их запрашивает, и они передаются потоком на сервер. Это помогает избежать буферизации всех строк в памяти. Это типично для массовой вставки или обновления сценариев. Возвращающие табличное значение параметры обеспечивают показатель производительности где-то между массивами параметров и массовым копированием. То есть возвращающие табличное значение параметры почти так же легко программировать, как и массивы параметров, но они дают большую гибкость на сервере.  
  
 Возвращающий табличное значение параметр и его столбцы привязаны, как описано в предыдущем разделе «Возвращающий табличное значение параметр с многострочными буферами с полной привязкой», но признак длины возвращающего табличное значение параметра установлен в значение SQL_DATA_AT_EXEC. Драйвер реагирует на SQLExecute или SQLExecuteDirect обычным образом для параметров данных времени выполнения — то есть, возвращая значение SQL_NEED_DATA. Когда драйвер готов принять данные для возвращающих табличные значения параметра, SQLParamData возвращает значение *ParameterValuePtr* в SQLBindParameter.  
  
 Приложение использует SQLPutData для возвращающих табличные значения параметра, чтобы показать доступность данных для столбцов, содержащих возвращающие табличные значения параметры. При вызове функции SQLPutData для возвращающих табличные значения параметра, *DataPtr* всегда должен иметь значение null и *StrLen_or_Ind* должен иметь значение 0 или число меньше или равно размеру массива, указанного для возвращающих табличные значения параметр буферов ( *ColumnSize* функции SQLBindParameter). 0 обозначает, что в возвращающем табличное значение параметре больше нет строк и драйвер продолжит обработку со следующего фактического параметра процедуры. Когда *StrLen_or_Ind* является не равен 0, драйвер будет обрабатывать столбцах, составляющих возвращающий табличное значение параметра так же как не табличное значение параметра привязкой параметра: Каждый столбец табличное значение параметра можно указать свою фактическую длину данных, SQL_NULL_DATA, или может определять данные при выполнении посредством своего буфера длины и индикатора. Табличное значение параметра столбца, который можно передавать значения, повторные вызовы SQLPutData как обычно, когда символьное или двоичное значение должно быть передано по частям.  
  
 После того как все столбцы возвращающего табличное значение параметра были обработаны, драйвер снова обращается к возвращающему табличное значение параметру для обработки следующих строк данных возвращающего табличное значение параметра. Поэтому для возвращающих табличное значение параметров с данными времени выполнения драйвер не выполняет обычный последовательный просмотр привязанных параметров. Будет опрашиваться связанных параметров, возвращающих табличные значения, пока не будет вызван SQLPutData с *StrLen_Or_IndPtr* равно 0, в этот момент драйвер пропускает столбцы возвращающего табличное значение параметра и переходит к следующей фактическому параметру хранимой процедуры.  Когда SQLPutData передает значение индикатора, больше или равно 1, драйвер строк и столбцов возвращающих табличные значения параметра последовательно обрабатывает нее нет значения для всех привязанных строк и столбцов. Затем драйвер возвращается к возвращающему табличное значение параметру. Между получением токена для возвращающих табличные значения параметра из SQLParamData и вызов SQLPutData (hstmt, NULL, n) для возвращающих табличные значения параметра, приложение должно установить данные столбцов, содержащихся в табличное значение параметра и индикатор содержимое буфера для следующей строки или строк для передачи на сервер.  
  
 Пример кода для этого сценария находится в процедуре `demo_variable_TVP_binding` в [параметров, возвращающих &#40;ODBC&#41;](../../relational-databases/native-client-odbc-how-to/use-table-valued-parameters-odbc.md).  
  
## <a name="retrieving-table-valued-parameter-metadata-from-the-system-catalog"></a>Получение метаданных возвращающих табличное значение параметров из системного каталога  
 Когда приложение вызывает SQLProcedureColumns для процедуры с параметрами табличное значение параметра, DATA_TYPE возвращается как тип SQL_SS_TABLE, а TYPE_NAME является именем табличного типа для возвращающих табличные значения параметра. Два дополнительных столбца добавляются в результирующий набор, возвращаемый функцией SQLProcedureColumns: SS_TYPE_CATALOG_NAME возвращает имя каталога, где определен тип таблицы, возвращающие табличное значение параметра, а SS_TYPE_SCHEMA_NAME возвращает имя схемы, где where определен тип таблицы, возвращающие табличное значение параметра. В соответствии со спецификацией ODBC SS_TYPE_CATALOG_NAME и SS_TYPE_SCHEMA_NAME применяются до всех столбцов драйвера, которые были добавлены в предыдущих версиях [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], и после всех столбцов, применяемых ODBC.  
  
 Новые столбцы будут заполнены не только для возвращающих табличное значение параметров, но и для параметров определенного пользователем типа данных CLR. Существующие схема и столбцы каталога параметров определяемого пользователем типа будут все равно заполнены, но наличие общих схемы и столбцов каталога для типов данных, для которых они требуются, упростит разработку приложения в будущем. (Следует отметить, что коллекции схем XML несколько отличаются и не включаются в это изменение).  
  
 Приложение использует SQLTables, чтобы определить имена табличных типов, так же, как и для хранимых таблиц, системных таблиц и представлений. Новый табличный тип TABLE TYPE вводится, чтобы приложение могло определить табличный тип, связанный с возвращающими табличное значение параметрами. Табличные типы и обычные таблицы используют различные пространства имен. Это значит, что можно использовать одно и то же имя как для табличного типа, так и для существующей таблицы. Для обработки этой ситуации был введен новый атрибут инструкции SQL_SOPT_SS_NAME_SCOPE. Этот атрибут указывает ли SQLTables и других функций каталога, которые принимают имя таблицы в качестве параметра, рассматривать имя таблицы, как имя существующей таблицы или имя типа таблицы.  
  
 Приложение использует SQLColumns, чтобы определить столбцы для табличного типа таким же образом, как он для хранимых таблиц, но сначала необходимо задать SQL_SOPT_SS_NAME_SCOPE, чтобы указать, что он работает с табличных типов, а не собственно таблицы запрашиваются. SQLPrimaryKeys можно также использовать с табличными типами, использования SQL_SOPT_SS_NAME_SCOPE.  
  
 Пример кода для этого сценария находится в процедуре `demo_metadata_from_catalog_APIs` в [параметров, возвращающих &#40;ODBC&#41;](../../relational-databases/native-client-odbc-how-to/use-table-valued-parameters-odbc.md).  
  
## <a name="retrieving-table-valued-parameter-metadata-for-a-prepared-statement"></a>Получение метаданных возвращающих табличное значение параметров для подготовленной инструкции  
 В этом сценарии приложение использует SQLNumParameters и SQLDescribeParam для получения метаданных для возвращающих табличные значения параметров.  
  
 IPD-поле атрибута SQL_CA_SS_TYPE_NAME используется для получения имени типа для возвращающего табличное значение параметра. IPD-поля атрибутов SQL_CA_SS_TYPE_SCHEMA_NAME и SQL_CA_SS_TYPE_CATALOG_NAME используются соответственно для получения каталога и схемы этого параметра.  
  
 Определения табличных типов и возвращающие табличное значение параметры должны находиться в одной базе данных. SQLSetDescField сообщит об ошибке, если атрибут sql_ca_ss_type_catalog_name при использовании возвращающих табличное значение параметров.  
  
 Атрибуты SQL_CA_SS_TYPE_CATALOG_NAME и SQL_CA_SS_TYPE_SCHEMA_NAME могут также использоваться для получения каталога и схемы, связанных с параметрами определяемых пользователем типов данных CLR. Атрибуты SQL_CA_SS_TYPE_CATALOG_NAME и SQL_CA_SS_TYPE_SCHEMA_NAME представляют собой альтернативу существующим атрибутам типов в схеме каталогов для определяемых пользователем типов данных CLR.  
  
 Приложение использует SQLColumns для получения метаданных для возвращающих табличные значения параметра в этом случае, поскольку SQLDescribeParam не возвращает метаданные для столбцов возвращающих табличные значения параметров столбца.  
  
 Пример кода для данного случая находится в процедуре `demo_metadata_from_prepared_statement` в [параметров, возвращающих &#40;ODBC&#41;](../../relational-databases/native-client-odbc-how-to/use-table-valued-parameters-odbc.md).  
  
## <a name="see-also"></a>См. также  
 [Возвращающие табличные значения параметров &#40;ODBC&#41;](../../relational-databases/native-client-odbc-table-valued-parameters/table-valued-parameters-odbc.md)  
  
  
