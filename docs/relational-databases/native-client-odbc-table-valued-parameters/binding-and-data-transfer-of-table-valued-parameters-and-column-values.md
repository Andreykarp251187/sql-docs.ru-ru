---
title: Передача параметров, оцениваемых таблицей
ms.custom: ''
ms.date: 04/04/2017
ms.prod: sql
ms.prod_service: database-engine, sql-database, sql-data-warehouse, pdw
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- table-valued parameters (ODBC), binding and data transfer
ms.assetid: 0a2ea462-d613-42b6-870f-c7fa086a6b42
author: markingmyname
ms.author: maghan
monikerRange: '>=aps-pdw-2016||=azuresqldb-current||=azure-sqldw-latest||>=sql-server-2016||=sqlallproducts-allversions||>=sql-server-linux-2017||=azuresqldb-mi-current'
ms.openlocfilehash: 3b7eecfdac3d42b7a3d8d66ffe1f8ac68652230f
ms.sourcegitcommit: ce94c2ad7a50945481172782c270b5b0206e61de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/14/2020
ms.locfileid: "81304505"
---
# <a name="binding-and-data-transfer-of-table-valued-parameters-and-column-values"></a>Привязка и передача данных возвращающих табличное значение параметров и значений столбцов
[!INCLUDE[appliesto-ss-asdb-asdw-pdw-md](../../includes/appliesto-ss-asdb-asdw-pdw-md.md)]

  Возвращающие табличное значение параметры, как и другие параметры, нуждаются в привязке до их передачи на сервер. Приложение связывает параметры, оцениваемые таблицей, так же, как и привязывает другие параметры: с помощью S'LBindParameter или эквивалентных вызовов в S'LSetDescField или S'LSetDescRec. Типом данных на сервере для параметра, возвращающего табличное значение, является SQL_SS_TABLE. Тип C может иметь значение SQL_C_DEFAULT или SQL_C_BINARY.  
  
 В [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] и более поздних версиях возвращающие табличное значение параметры поддерживаются только как входные. Поэтому любая попытка установить для SQL_DESC_PARAMETER_TYPE значение, отличное от SQL_PARAM_INPUT, приведет к возникновению ошибки SQL_ERROR с SQLSTATE = HY105 и появлению сообщения «Недопустимый тип параметра».  
  
 Можно назначать значение по умолчанию для целых столбцов возвращающих табличное значение параметров с помощью атрибута SQL_CA_SS_COL_HAS_DEFAULT_VALUE. Однако отдельные значения столбца параметров, оцениваемых таблицей, не могут быть назначены значениями по умолчанию, используя SQL_DEFAULT_PARAM в *StrLen_or_IndPtr* с S'LBindParameter. Параметры, оцениваемые таблицей в целом, не могут быть установлены на значение по умолчанию, используя SQL_DEFAULT_PARAM *в StrLen_or_IndPtr* с s'LBindParameter. Если эти правила не соблюдаются, s'LExecute или S'LExecDirect вернутся SQL_ERROR. Диагностическая запись будет сгенерирована с помощью S'LSTATE-07S01 \<и сообщения "Недействительное использование параметра по умолчанию для параметра p>", где \<p> является ординатом TVP в заявлении запроса.  
  
 После привязки возвращающего табличное значение параметра приложение должно выполнить привязку каждого столбца параметров, возвращающих табличное значение. Для этого приложение сначала вызывает S'LSetStmtAttr, чтобы установить SQL_SOPT_SS_PARAM_FOCUS к обычному параметру, ценившему таблицу. Затем приложение связывает столбцы параметра, оцениваемого таблицей, по вызовам к следующим процедурам: S'LBindParameter, S'LSetDesccRec и S'LSetDescField. Установка SQL_SOPT_SS_PARAM_FOCUS до 0 восстанавливает привычный эффект S'LBindParameter, S'LSetDesccRec и S'LSetDescfield при работе по обычным параметрам верхнего уровня.
 
 Примечание: для драйверов Linux и Mac ODBC с unixODBC 2.3.1 до 2.3.4, при установке имени TVP через S'LSetDesccField с полем SQL_CA_SS_TYPE_NAME дескриптора, unixODBC не преобразует автоматически между строками ANSI и Unicode в зависимости от точной функции, называемой (S'LSetDescFieldA / S'LSetDescField). Для установки имени TVP необходимо либо всегда использовать строку «S'LBindParameter» или «S'LSetDescfieldW» со строкой Unicode (UTF-16).
  
 Для самого возвращающего табличное значение параметра никакие данные не передаются и не принимаются. Передаются и принимаются данные для каждого из столбцов, составляющих этот параметр. Поскольку параметр, оцениваемый таблицей, является псевдоколонкой, параметры для S'LBindParameter используются для обозначения различных атрибутов, чем другие типы данных, следующим образом:  
  
|Параметр|Связанный атрибут для типов параметров, не ценных таблицей, включая столбцы|Связанные атрибуты для возвращающих табличное значение параметров|  
|---------------|--------------------------------------------------------------------------------|----------------------------------------------------|  
|*InputOutputType*|SQL_DESC_PARAMETER_TYPE в IPD.<br /><br /> Для столбцов, возвращающих табличное значение параметров, этот атрибут должен совпадать с настройкой для самого возвращающего табличное значение параметра.|SQL_DESC_PARAMETER_TYPE в IPD.<br /><br /> Это должен быть атрибут SQL_PARAM_INPUT.|  
|*Valuetype*|SQL_DESC_TYPE, SQL_DESC_CONCISE_TYPE в APD.|SQL_DESC_TYPE, SQL_DESC_CONCISE_TYPE в APD.<br /><br /> Это должен быть атрибут SQL_C_DEFAULT или SQL_C_BINARY.|  
|*ParameterType*|SQL_DESC_TYPE, SQL_DESC_CONCISE_TYPE в IPD.|SQL_DESC_TYPE, SQL_DESC_CONCISE_TYPE в IPD.<br /><br /> Это должен быть атрибут SQL_SS_TABLE.|  
|*ColumnSize*|SQL_DESC_LENGTH или SQL_DESC_PRECISION в IPD.<br /><br /> Это зависит от значения *ParameterType*.|SQL_DESC_ARRAY_SIZE<br /><br /> Значение этого атрибута можно задать также с помощью атрибута SQL_ATTR_PARAM_SET_SIZE, когда фокус параметра установлен на возвращающий табличное значение параметр.<br /><br /> Для возвращающего табличное значение параметра эта величина равна количеству строк в буферах столбцов данного параметра.|  
|*DecimalDigits*|SQL_DESC_PRECISION или SQL_DESC_SCALE в IPD.|Не используется. Атрибут должен иметь значение 0.<br /><br /> Если этот параметр не 0, S'LBindParameter вернется SQL_ERROR, и диагностическая запись будет сгенерирована с помощью S'LSTATE's HY104 и сообщения "Недействительная точность или масштаб".|  
|*ParameterValuePtr*|SQL_DESC_DATA_PTR в APD.|SQL_CA_SS_TYPE_NAME.<br /><br /> Необязательный атрибут для вызова хранимых процедур. Если значение не нужно, можно задать NULL. Для инструкций SQL, не являющихся вызовами процедур, атрибут должен быть задан.<br /><br /> Этот параметр также служит уникальным значением, по которому приложение может узнать конкретный возвращающий табличное значение параметр при использовании переменной строковой привязки. Дополнительные сведения см. в подразделе «Переменная строковая привязка возвращающих табличное значение параметров» далее в этом разделе.<br /><br /> Когда имя типа параметра, оцениваемого таблицей, указывается на вызове к S'LBindParameter, оно должно быть указано как значение Unicode, даже в приложениях, которые построены как приложения ANSI. Значение, используемое для параметра *StrLen_or_IndPtr* должно быть либо SQL_NTS, либо длиной строки имени, умноженной на sizeof (WCHAR).|  
|*BufferLength*|SQL_DESC_OCTET_LENGTH в APD.|Длина имени типа возвращающего табличное значение параметра в байтах.<br /><br /> Значение может быть равно SQL_NTS, если имя типа представляет собой строку, завершающуюся нулем, или 0, если имя типа возвращающего табличное значение параметра не требуется.|  
|*StrLen_or_IndPtr*|SQL_DESC_OCTET_LENGTH_PTR в APD.|SQL_DESC_OCTET_LENGTH_PTR в APD.<br /><br /> Для возвращающих табличное значение параметров этот атрибут хранит не длину данных, а количество строк.|  
||||

 Для возвращающих табличное значение параметров поддерживаются два режима передачи данных: фиксированная и переменная привязка строк.  
  
## <a name="fixed-table-valued-parameter-row-binding"></a>Фиксированная привязка строк возвращающего табличное значение параметра  
 Для фиксированной привязки строк приложение выделяет буферы (или буферные массивы), достаточно большие для всех возможных значений входных столбцов. Приложение выполняет следующие действия.  
  
1.  Связывает все параметры, используя вызовы S'LBindParameter, S'LSetDescRec или S'LSetDescField.  
  
    1.  Присваивает атрибуту SQL_DESC_ARRAY_SIZE значение максимально возможного числа рядов, которые можно передать для каждого возвращающего табличное значение параметра. Это можно сделать в вызове S'LBindParameter.  
  
2.  Вызывает S'LSetStmtAttr, чтобы установить SQL_SOPT_SS_PARAM_FOCUS к облачному параметру, ценившему таблицу.  
  
    1.  Для каждого параметра, оцениваемого таблицей, связывается столбцов параметров, оцениваемых таблицей, с помощью вызовов S'LBindParameter, S'LSetDescRec или S'LSetDescField.  
  
    2.  Для каждой столбца параметров, оцениваемых в таблице, которая должна иметь значения по умолчанию, вызывает s'LSetDescField, чтобы установить SQL_CA_SS_COL_HAS_DEFAULT_VALUE до 1.  
  
3.  Вызывает S'LSetStmtAttr, чтобы установить SQL_SOPT_SS_PARAM_FOCUS до 0. Это должно быть сделано до того, как будет вызвано s'L'LExecute или S'LExecDirect. В противном случае функция вернет значение SQL_ERROR и будет создана диагностическая запись с параметром SQLSTATE=HY024 и сообщением «Недопустимое значение атрибута SQL_SOPT_SS_PARAM_FOCUS (атрибут должен быть равен нулю во время выполнения)».  
  
4.  Устанавливает *StrLen_or_IndPtr* или SQL_DESC_OCTET_LENGTH_PTR для SQL_DEFAULT_PARAM для параметра, оцениваемого таблицей, без строк, или количества строк, которые будут переданы при следующем вызове S'LExecute или S'LExecDirect, если параметр, оцениваемый таблицей, имеет ряды. *StrLen_or_IndPtr* или SQL_DESC_OCTET_LENGTH_PTR не могут быть установлены для SQL_NULL_DATA для параметра, оцениваемого таблицей, поскольку параметры, оцениваемые таблицей, не являются недействительными (хотя составные столбы параметров, оцениваемые таблицей, могут быть аннулированы). Если это установлено на недействительное значение, S'LExecute или S'LExecDirect возвращается SQL_ERROR, и диагностическая запись генерируется с s'LSTATE-HY090 и сообщение "Недействий строки или длины буфера для параметра \<p>", где p является номером параметра.  
  
5.  Вызывает вызовы s'LExecute или S'LExecDirect.  
  
 Значения столбца параметров, ценных таблицей ввода, могут передаваться по частям, если *StrLen_or_IndPtr* установлен на SQL_LEN_DATA_AT_EXEC *(длина)* или SQL_DATA_AT_EXEC для столбца. Это похоже на передачу значений по частям при использовании массивов параметров. Как и во всех параметрах выполнения данных, S'LParamData не указывает, для какой строки массива драйвер запрашивает данные; заявление должно позаботиться об этом. Приложение не может делать никаких предположений о порядке, в котором драйвер будет запрашивать данные.  
  
## <a name="variable-table-valued-parameter-row-binding"></a>Переменная привязка строк возвращающего табличное значение параметра  
 Строки при использовании переменной привязки передаются пакетами во время выполнения, и приложение передает их драйверу по требованию. Это похоже на данные времени выполнения для отдельных значений параметров. Для переменной привязки строк приложение выполняет следующие действия.  
  
1.  Привязывает параметры и столбцы возвращающих табличное значение параметров, как описано в шагах с 1 по 3 предыдущего раздела «Фиксированная привязка строк возвращающего табличное значение параметра».  
  
2.  Устанавливает *StrLen_or_IndPtr* или SQL_DESC_OCTET_LENGTH_PTR для любых параметров, ценных на стол, которые должны быть переданы во время выполнения SQL_DATA_AT_EXEC. Если ни один из указанных атрибутов не установлен, параметр будет обрабатываться, как описано в предыдущем разделе.  
  
3.  Вызывает вызовы s'LExecute или S'LExecDirect. При наличии любых параметров типа SQL_PARAM_INPUT или SQL_PARAM_INPUT_OUTPUT, которые должны быть обработаны как параметры с данными времени выполнения, этот вызов функции вернет значение SQL_NEED_DATA. В этом случае приложение выполняет следующие действия.  
  
    -   Вызывает s'LParamData. Это возвращает значение *ParameterValuePtr* для параметра данных по исполнению и код возврата SQL_NEED_DATA. Когда все данные параметра передаются водителю, sLParamData возвращает SQL_SUCCESS, SQL_SUCCESS_WITH_INFO или SQL_ERROR. По параметрам Data-at-execution *Параметр,* который является таким же, как поле дескриптора SQL_DESC_DATA_PTR, может рассматриваться как маркер для однозначного определения параметра, для которого требуется значение. Этот токен передается приложением драйверу во время привязки, а затем передается обратно приложению во время выполнения.  
  
4.  Для отправки данных строки параметров, оцениваемых таблицей, для параметров нулевой таблицы, если параметр, оцениваемый таблицей, не имеет строк, приложение вызывает S'LPutData с *StrLen_or_Ind,* установленным на SQL_DEFAULT_PARAM.  
  
     Для возвращающих табличное значение параметров, отличных от NULL, приложение выполняет следующие действия.  
  
    -   Устанавливает *Str_Len_or_Ind* для всех столбцов параметров, оцениваемых таблицей, до соответствующих значений и заполняет буферы данных для столбцов параметров, ценных таблицей, которые не должны быть параметрами данных по исполнению. Данные времени выполнения можно использовать для столбцов возвращающих табличное значение параметров, подобно тому, как обычные параметры могут передаваться драйверу по частям.  
  
    -   Вызывает s'LPutData с *Str_Len_or_Ind* установленна к числу строк, которые будут отправлены на сервер. Любое значение, меньше 0 или больше SQL_DESC_ARRAY_SIZE или SQL_DEFAULT_PARAM, является ошибкой, и в этом случае вызов вернет состояние SQLSTATE HY090 с сообщением «Недопустимая длина строки или буфера». 0 означает, что все строки уже были переданы и в данном возвращающем табличное значение параметре данных больше нет (как указано во втором пункте данного списка). SQL_DEFAULT_PARAM можно использовать только в случае, если драйвер запрашивает данные возвращающего табличное значение параметра впервые (как описано в первом пункте данного списка).  
  
5.  Когда все строки были отправлены, вызовы S'LPutData для параметра, оцениваемого таблицей с *значением Str_Len_or_Ind* 0, а затем переходит к шагу 3a выше.  
  
6.  Снова вызывает S'LParamData. При наличии каких-либо параметров данных по исполнению среди столбцов параметров, оцениваемых таблицей, они будут определены значением *ValuePtrPtr,* возвращенным S'LParamData. Когда все значения столбца доступны, S'LParamData снова вернет значение *ParameterValuePtr* для параметра, оцениваемого таблицей, и приложение снова начинается.  
  
## <a name="see-also"></a>См. также:  
 [Параметры, оцененные таблицей, &#40;&#41;ODBC](../../relational-databases/native-client-odbc-table-valued-parameters/table-valued-parameters-odbc.md)  
  
  
