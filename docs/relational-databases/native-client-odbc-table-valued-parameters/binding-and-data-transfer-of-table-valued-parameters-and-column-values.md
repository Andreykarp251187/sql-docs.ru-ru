---
title: Привязка и передача данных возвращающих табличные значения параметров и значений столбцов | Документация Майкрософт
ms.custom: ''
ms.date: 04/04/2017
ms.prod: sql
ms.prod_service: database-engine, sql-database, sql-data-warehouse, pdw
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- table-valued parameters (ODBC), binding and data transfer
ms.assetid: 0a2ea462-d613-42b6-870f-c7fa086a6b42
author: MightyPen
ms.author: genemi
manager: craigg
monikerRange: '>=aps-pdw-2016||=azuresqldb-current||=azure-sqldw-latest||>=sql-server-2016||=sqlallproducts-allversions||>=sql-server-linux-2017||=azuresqldb-mi-current'
ms.openlocfilehash: 8f8b291344939bcbafa7f91080837d2302efb1d0
ms.sourcegitcommit: f7fced330b64d6616aeb8766747295807c92dd41
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "62738560"
---
# <a name="binding-and-data-transfer-of-table-valued-parameters-and-column-values"></a>Привязка и передача данных возвращающих табличное значение параметров и значений столбцов
[!INCLUDE[appliesto-ss-asdb-asdw-pdw-md](../../includes/appliesto-ss-asdb-asdw-pdw-md.md)]
[!INCLUDE[SNAC_Deprecated](../../includes/snac-deprecated.md)]

  Возвращающие табличное значение параметры, как и другие параметры, нуждаются в привязке до их передачи на сервер. Приложение привязывает возвращающие табличные значения параметры так же, оно привязывает другие параметры: с помощью SQLBindParameter или эквивалентные вызовы для SQLSetDescField и SQLSetDescRec. Типом данных на сервере для параметра, возвращающего табличное значение, является SQL_SS_TABLE. Тип C может иметь значение SQL_C_DEFAULT или SQL_C_BINARY.  
  
 В [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] и более поздних версиях возвращающие табличное значение параметры поддерживаются только как входные. Поэтому любая попытка установить для SQL_DESC_PARAMETER_TYPE значение, отличное от SQL_PARAM_INPUT, приведет к возникновению ошибки SQL_ERROR с SQLSTATE = HY105 и появлению сообщения «Недопустимый тип параметра».  
  
 Можно назначать значение по умолчанию для целых столбцов возвращающих табличное значение параметров с помощью атрибута SQL_CA_SS_COL_HAS_DEFAULT_VALUE. Значения столбцов отдельных параметров, возвращающих табличные значения, тем не менее, нельзя назначить значения по умолчанию с помощью значения SQL_DEFAULT_PARAM параметра *StrLen_or_IndPtr* с SQLBindParameter. Возвращающие табличные значения параметров в целом не может быть присвоено значение по умолчанию с помощью значения SQL_DEFAULT_PARAM параметра *StrLen_or_IndPtr* с SQLBindParameter. Если эти правила не соблюдаются, SQLExecute или SQLExecDirect вернет значение SQL_ERROR. Будет создана диагностическая запись с SQLSTATE = 07S01 и сообщением «недопустимое использование параметра по умолчанию для параметра \<p >», где \<p > — порядковый номер возвращающего табличное значение Параметра в инструкции запроса.  
  
 После привязки возвращающего табличное значение параметра приложение должно выполнить привязку каждого столбца параметров, возвращающих табличное значение. Чтобы сделать это, приложение сначала вызывает SQLSetStmtAttr для присвоения параметру SQL_SOPT_SS_PARAM_FOCUS порядковый номер возвращающего табличное значение параметра. Затем приложение выполняет привязку столбцов возвращающих табличные значения параметра, вызовы следующих процедур: SQLBindParameter, SQLSetDescRec и SQLSetDescField. Присвоение атрибуту sql_sopt_ss_param_focus значения 0 восстанавливает обычное воздействие функций SQLBindParameter, SQLSetDescField и SQLSetDescRec при работе с параметры верхнего уровня.
 
 Примечание: для драйверов ODBC для Mac и Linux с unixODBC 2.3.1 для 2.3.4, при задании имени возвращающего табличное значение Параметра через SQLSetDescField по полю дескриптора SQL_CA_SS_TYPE_NAME, unixODBC не преобразуется автоматически ANSI в Юникод строк, в зависимости от точного функция, вызываемая (SQLSetDescFieldA / SQLSetDescFieldW). Это необходимо, чтобы всегда использовать SQLBindParameter или SQLSetDescFieldW строкой в Юникоде (UTF-16) присвойте имя возвращающего табличное значение Параметра.
  
 Для самого возвращающего табличное значение параметра никакие данные не передаются и не принимаются. Передаются и принимаются данные для каждого из столбцов, составляющих этот параметр. Поскольку табличное значение параметра представляет собой Псевдостолбец, параметры для SQLBindParameter используются для ссылки на другие атрибуты, чем другие типы данных, следующим образом:  
  
|Параметр|Связанные атрибуты для не табличное значение параметра, включая столбцы|Связанные атрибуты для возвращающих табличное значение параметров|  
|---------------|--------------------------------------------------------------------------------|----------------------------------------------------|  
|*InputOutputType*|SQL_DESC_PARAMETER_TYPE в IPD.<br /><br /> Для столбцов, возвращающих табличное значение параметров, этот атрибут должен совпадать с настройкой для самого возвращающего табличное значение параметра.|SQL_DESC_PARAMETER_TYPE в IPD.<br /><br /> Это должен быть атрибут SQL_PARAM_INPUT.|  
|*ValueType*|SQL_DESC_TYPE, SQL_DESC_CONCISE_TYPE в APD.|SQL_DESC_TYPE, SQL_DESC_CONCISE_TYPE в APD.<br /><br /> Это должен быть атрибут SQL_C_DEFAULT или SQL_C_BINARY.|  
|*ParameterType*|SQL_DESC_TYPE, SQL_DESC_CONCISE_TYPE в IPD.|SQL_DESC_TYPE, SQL_DESC_CONCISE_TYPE в IPD.<br /><br /> Это должен быть атрибут SQL_SS_TABLE.|  
|*ColumnSize*|SQL_DESC_LENGTH или SQL_DESC_PRECISION в IPD.<br /><br /> Это зависит от значения *ParameterType*.|SQL_DESC_ARRAY_SIZE<br /><br /> Значение этого атрибута можно задать также с помощью атрибута SQL_ATTR_PARAM_SET_SIZE, когда фокус параметра установлен на возвращающий табличное значение параметр.<br /><br /> Для возвращающего табличное значение параметра эта величина равна количеству строк в буферах столбцов данного параметра.|  
|*DecimalDigits*|SQL_DESC_PRECISION или SQL_DESC_SCALE в IPD.|Не используется. Атрибут должен иметь значение 0.<br /><br /> Если этот параметр не 0, будет SQLBindParameter будут формироваться возвращаемое значение SQL_ERROR и создается диагностическая запись с кодом SQLSTATE = HY104 и сообщением «Недопустимая точность или масштаб».|  
|*ParameterValuePtr*|SQL_DESC_DATA_PTR в APD.|SQL_CA_SS_TYPE_NAME.<br /><br /> Необязательный атрибут для вызова хранимых процедур. Если значение не нужно, можно задать NULL. Для инструкций SQL, не являющихся вызовами процедур, атрибут должен быть задан.<br /><br /> Этот параметр также служит уникальным значением, по которому приложение может узнать конкретный возвращающий табличное значение параметр при использовании переменной строковой привязки. Дополнительные сведения см. в подразделе «Переменная строковая привязка возвращающих табличное значение параметров» далее в этом разделе.<br /><br /> При указании имени типа возвращающего табличное значение параметра во время вызова SQLBindParameter указывается как значение Юникода, даже в тех приложениях, построенных с кодировкой ANSI. Значение, используемое для параметра *StrLen_or_IndPtr* должен быть SQL_NTS или длина строки имени, умноженное на sizeof(WCHAR).|  
|*BufferLength*|SQL_DESC_OCTET_LENGTH в APD.|Длина имени типа возвращающего табличное значение параметра в байтах.<br /><br /> Значение может быть равно SQL_NTS, если имя типа представляет собой строку, завершающуюся нулем, или 0, если имя типа возвращающего табличное значение параметра не требуется.|  
|*StrLen_or_IndPtr*|SQL_DESC_OCTET_LENGTH_PTR в APD.|SQL_DESC_OCTET_LENGTH_PTR в APD.<br /><br /> Для возвращающих табличное значение параметров этот атрибут хранит не длину данных, а количество строк.|  
  
 Для возвращающих табличное значение параметров поддерживаются два режима передачи данных: фиксированная и переменная привязка строк.  
  
## <a name="fixed-table-valued-parameter-row-binding"></a>Фиксированная привязка строк возвращающего табличное значение параметра  
 Для фиксированной привязки строк приложение выделяет буферы (или буферные массивы), достаточно большие для всех возможных значений входных столбцов. Приложение выполняет следующие действия.  
  
1.  Выполняет привязку всех параметров, используя SQLBindParameter, SQLSetDescField и SQLSetDescRec вызовов.  
  
    1.  Присваивает атрибуту SQL_DESC_ARRAY_SIZE значение максимально возможного числа рядов, которые можно передать для каждого возвращающего табличное значение параметра. Это можно сделать в вызове функции SQLBindParameter.  
  
2.  Вызывает SQLSetStmtAttr для присвоения параметру SQL_SOPT_SS_PARAM_FOCUS порядковый номер каждого возвращающего табличное значение параметра.  
  
    1.  Для каждого параметра, возвращающие табличные значения привязывает столбцы возвращающего табличное значение параметра, используя SQLBindParameter, SQLSetDescField и SQLSetDescRec вызовов.  
  
    2.  Для каждого столбца табличное значение параметра, которые будут иметь значения по умолчанию вызывает SQLSetDescField, чтобы присвоить атрибуту SQL_CA_SS_COL_HAS_DEFAULT_VALUE значение 1.  
  
3.  Вызывает SQLSetStmtAttr, присваивающий параметру SQL_SOPT_SS_PARAM_FOCUS значение 0. Это необходимо сделать перед SQLExecute или SQLExecDirect вызывается. В противном случае функция вернет значение SQL_ERROR и будет создана диагностическая запись с параметром SQLSTATE=HY024 и сообщением «Недопустимое значение атрибута SQL_SOPT_SS_PARAM_FOCUS (атрибут должен быть равен нулю во время выполнения)».  
  
4.  Наборы *StrLen_or_IndPtr* или SQL_DESC_OCTET_LENGTH_PTR процедуры SQL_DEFAULT_PARAM для возвращающих табличные значения параметра ни одной строки, или количество строк, переданным при следующем вызове SQLExecute или SQLExecDirect, если возвращающие табличные значения параметр имеет строк. *StrLen_or_IndPtr* или SQL_DESC_OCTET_LENGTH_PTR нельзя присвоить значение SQL_NULL_DATA для возвращающих табличные значения параметра, возвращающих табличные значения параметры не допускают значения NULL (хотя столбцы, составляющие табличное значение параметра могут быть обнуляемыми). Если это задано недопустимое значение SQLExecute или SQLExecDirect возвращает значение SQL_ERROR и диагностическая запись с кодом SQLSTATE = HY090 и сообщением «Недопустимая длина строки или буфера для параметра \<p >», где p — порядковый номер параметра.  
  
5.  Вызывает SQLExecute или SQLExecDirect.  
  
 Входные значения столбцов возвращающих табличные значения параметров могут передаваться по частям, если *StrLen_or_IndPtr* задано значение SQL_LEN_DATA_AT_EXEC (*длина*) или SQL_DATA_AT_EXEC для столбца. Это похоже на передачу значений по частям при использовании массивов параметров. Со всеми параметрами данных во время выполнения, SQLParamData сказано о какой строки массива драйвер запрашивает данные Это должно заботиться приложение. Приложение не может делать никаких предположений о порядке, в котором драйвер будет запрашивать данные.  
  
## <a name="variable-table-valued-parameter-row-binding"></a>Переменная привязка строк возвращающего табличное значение параметра  
 Строки при использовании переменной привязки передаются пакетами во время выполнения, и приложение передает их драйверу по требованию. Это похоже на данные времени выполнения для отдельных значений параметров. Для переменной привязки строк приложение выполняет следующие действия.  
  
1.  Привязывает параметры и столбцы возвращающих табличное значение параметров, как описано в шагах с 1 по 3 предыдущего раздела «Фиксированная привязка строк возвращающего табличное значение параметра».  
  
2.  Наборы *StrLen_or_IndPtr* или SQL_DESC_OCTET_LENGTH_PTR для всех параметров, возвращающих табличные значения, которые должны передаваться во время выполнения в значение SQL_DATA_AT_EXEC. Если ни один из указанных атрибутов не установлен, параметр будет обрабатываться, как описано в предыдущем разделе.  
  
3.  Вызывает SQLExecute или SQLExecDirect. При наличии любых параметров типа SQL_PARAM_INPUT или SQL_PARAM_INPUT_OUTPUT, которые должны быть обработаны как параметры с данными времени выполнения, этот вызов функции вернет значение SQL_NEED_DATA. В этом случае приложение выполняет следующие действия.  
  
    -   Вызывает SQLParamData. Эта команда возвращает *ParameterValuePtr* значение для параметра данных во время выполнения и код возврата SQL_NEED_DATA. Когда все данные параметров будут переданы драйверу, SQLParamData возвращает значение SQL_SUCCESS, SQL_SUCCESS_WITH_INFO или SQL_ERROR. Для параметров данных времени выполнения *ParameterValuePtr*, который является таким же, как дескриптор поле SQL_DESC_DATA_PTR, можно рассматривать как уникальный токен параметра, для которого требуется значение. Этот токен передается приложением драйверу во время привязки, а затем передается обратно приложению во время выполнения.  
  
4.  Для отправки данных строк табличное значение параметра для возвращающих табличные значения параметры null, если табличное значение параметра не имеет строк, приложение вызывает SQLPutData с *StrLen_or_Ind* в значение SQL_DEFAULT_PARAM.  
  
     Для возвращающих табличное значение параметров, отличных от NULL, приложение выполняет следующие действия.  
  
    -   Наборы *Str_Len_or_Ind* для всех столбцов возвращающих табличные значения параметра соответствующие значения и заполняет буферы данных тех столбцов возвращающих табличные значения параметров, которые не должны быть параметров данных времени выполнения. Данные времени выполнения можно использовать для столбцов возвращающих табличное значение параметров, подобно тому, как обычные параметры могут передаваться драйверу по частям.  
  
    -   Вызывает SQLPutData с *Str_Len_or_Ind* присвоено число строк, отправляемых на сервер. Любое значение, меньше 0 или больше SQL_DESC_ARRAY_SIZE или SQL_DEFAULT_PARAM, является ошибкой, и в этом случае вызов вернет состояние SQLSTATE HY090 с сообщением «Недопустимая длина строки или буфера». 0 означает, что все строки уже были переданы и в данном возвращающем табличное значение параметре данных больше нет (как указано во втором пункте данного списка). SQL_DEFAULT_PARAM можно использовать только в случае, если драйвер запрашивает данные возвращающего табличное значение параметра впервые (как описано в первом пункте данного списка).  
  
5.  Когда все строки уже переданы, вызывает SQLPutData для возвращающих табличные значения параметра с *Str_Len_or_Ind* значение 0, после чего переходит к шагу 3а, описанному выше.  
  
6.  Вызывает SQLParamData снова. При наличии параметров данных времени выполнения между столбцами табличное значение параметра, они будут опознаны по значению *ValuePtrPtr* возвращаемый SQLParamData. Если все значения столбцов недоступны, опять вернет SQLParamData *ParameterValuePtr* значение для возвращающих табличные значения параметра и приложение будет запущено снова.  
  
## <a name="see-also"></a>См. также  
 [Возвращающие табличные значения параметров &#40;ODBC&#41;](../../relational-databases/native-client-odbc-table-valued-parameters/table-valued-parameters-odbc.md)  
  
  
