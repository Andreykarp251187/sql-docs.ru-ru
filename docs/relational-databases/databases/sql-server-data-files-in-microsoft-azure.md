---
title: Файлы данных SQL Server в Microsoft Azure | Microsoft Docs
ms.custom: ''
ms.date: 10/02/2017
ms.prod: sql
ms.prod_service: database-engine
ms.reviewer: ''
ms.technology: supportability
ms.topic: conceptual
ms.assetid: 38ffd9c2-18a5-43d2-b674-e425addec4e4
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: bf2d5d29d080064f5958ec467b55b90ded8afff8
ms.sourcegitcommit: ffb87aa292fc9b545c4258749c28df1bd88d7342
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/02/2019
ms.locfileid: "71816699"
---
# <a name="sql-server-data-files-in-microsoft-azure"></a>Файлы данных SQL Server в Microsoft Azure
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md](../../includes/appliesto-ss-xxxx-xxxx-xxx-md.md)]
  ![Файлы данных в Azure](../../relational-databases/databases/media/data-files-on-azure.png "Файлы данных в Azure")  
  
 Файлы данных SQL Server в Microsoft Azure включают встроенную поддержку файлов баз данных SQL Server, которые хранятся в виде больших двоичных объектов Microsoft Azure. Этот компонент позволяет создать базу данных на сервере SQL Server, работающем локально или на виртуальной машине в Microsoft Azure, с назначенным местом хранения для данных в хранилище BLOB-объектов Microsoft Azure. Это усовершенствование значительно упрощает перемещение баз данных между компьютерами с помощью операций отсоединения и присоединения. Кроме того, данный компонент предоставляет альтернативное расположение для хранения файлов резервных копий баз данных, позволяя выполнять восстановление из службы хранилища Microsoft Azure и в нее. Поэтому он обеспечивает возможность реализации нескольких гибридных решений, предоставляя ряд преимуществ для виртуализации данных, перемещения данных, безопасности и доступности, а также достижения снижения затрат и обслуживания для высокого уровня доступности и эластичного масштабирования.
 
> [!IMPORTANT]  
>  Хранение системных баз данных в хранилище больших двоичных объектов Azure не рекомендуется и не поддерживается. 

  
 В этом разделе представлены основные понятия и рекомендации, необходимые для хранения файлов данных SQL Server в службе хранилища Microsoft Azure.  
  
 Практические рекомендации по использованию этой функции см. в статье [Учебник. использованию службы хранилища больших двоичных объектов Microsoft Azure с базами данных SQL Server 2016](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md).  
  
## <a name="why-use-sql-server-data-files-in-microsoft-azure"></a>Зачем использовать файлы данных SQL Server в Microsoft Azure? 
  
-   **Преимущества простой и быстрой миграции.** Эта функция упрощает процесс миграции, перемещая одну базу данных за один раз между локальными компьютерами и между локальной и облачной средой без внесения каких-либо изменений в приложения. Поэтому он поддерживает добавочную миграцию, сохраняя при этом без изменений существующую локальную инфраструктуру. Кроме того, наличие доступа к централизованному хранилищу данных позволяет упростить логику приложения, когда приложение необходимо выполнять в нескольких местах в локальной среде. В некоторых случаях может потребоваться быстро настроить вычислительные центры, которые собирают данные из множества различных источников, в географически удаленных друг от друга местах. С помощью этого нового компонента вместо переноса данных из одного места в другое можно сохранять несколько баз данных в виде больших двоичных объектов Microsoft Azure, а затем с помощью скриптов Transact-SQL создавать базы данных на локальных компьютерах или виртуальных машинах.  
  
-   **Преимущества низких затрат и неограниченного хранилища.** Эта функция позволяет иметь неограниченное внешнее хранилище в Microsoft Azure при использовании ресурсов локального компьютера. При использовании Microsoft Azure в качестве места хранения можно сконцентрироваться на проработке логики приложения, не обращая внимания на издержки, связанные с управлением оборудованием. Если любой локальный вычислительный узел выходит из строя, можно настроить новый без перемещения каких-либо данных.  
  
-   **Преимущества высокого уровня доступности и аварийного восстановления.** Использование компонента файлов данных SQL Server в Microsoft Azure может упростить решения высокого уровня доступности и аварийного восстановления. Например, в случае сбоя виртуальной машины в Microsoft Azure или экземпляра SQL Server можно будет повторно создать базы данных в новом экземпляре SQL Server, просто восстановив ссылки на большие двоичные объекты Microsoft Azure.  
  
-   **Преимущества для безопасности.** Этот новый компонент позволяет вам разделять вычислительный экземпляр от экземпляра хранилища. Кроме того, можно настроить полностью зашифрованную базу данных, расшифровка которой будет происходить только в вычислительном экземпляре, а не в экземпляре хранилища. Другими словами, с помощью этого нового компонента можно шифровать все данные в общедоступном облаке с использованием сертификатов TDE (Transparent Data Encryption), которые физически отделены от данных. Ключи шифрования TDE могут храниться в базе данных master, которая размещена локально на физически безопасном локальном компьютере с локальным резервным копированием. Эти локальные ключи можно использовать для шифрования данных, которые находятся в службе хранилища Microsoft Azure. Если учетные данные учетной записи облачного хранилища украдены, данные останутся защищенными, поскольку сертификаты TDE всегда находятся на локальном компьютере.  
  
-   **Резервное копирование моментальных снимков.**  Эта функция позволяет применять моментальные снимки Azure для практически мгновенного создания резервных копий и более быстрого восстановления файлов баз данных, сохраненных с помощью службы хранилища BLOB-объектов Azure. Это дает возможность упростить политики резервного копирования и восстановления. Дополнительные сведения см. в разделе [Резервные копии моментальных снимков файлов для файлов базы данных в Azure](../../relational-databases/backup-restore/file-snapshot-backups-for-database-files-in-azure.md).  
  
## <a name="concepts-and-requirements"></a>Основные понятия и требования  
  
### <a name="azure-storage-concepts"></a>Основные понятия хранения  
 При использовании компонента SQL Server Data Files в Azure необходимо создать учетную запись хранения и контейнер в Azure. Затем необходимо создать учетные данные SQL Server, которые включают сведения о политике контейнера, а также подпись общего доступа, необходимую для доступа к контейнеру.  
  
 В [Microsoft Azure](https://azure.microsoft.com)учетная запись [хранилища Azure](https://azure.microsoft.com/services/storage/) представляет наивысший уровень пространства имен для доступа к большим двоичным объектам. Учетная запись хранения может содержать сколько угодно контейнеров при условии, что их общий размер не превышает размер хранилища. Последнюю информацию относительно ограничений хранилища смотрите в [Подписка и Ограничения Хранилища Azure, Квоты и Ограничения](https://docs.microsoft.com/azure/azure-subscription-service-limits). Контейнер группирует набор [больших двоичных объектов](https://docs.microsoft.com/azure/storage/common/storage-introduction#blob-storage). Все большие двоичные объекты должны находиться в контейнере. Учетная запись может содержать неограниченное количество контейнеров. В контейнере также может храниться неограниченное количество больших двоичных объектов. Существует два типа больших двоичных объектов, которые можно хранить в хранилище Azure: блочные и страничные. Страничные BLOB-объекты более эффективны, когда в файле часто изменяются диапазоны байтов. К большим двоичным объектам можно обращаться по URL-адресам в следующем формате: `https://storageaccount.blob.core.windows.net/<container>/<blob>`.  
  
### <a name="azure-billing-considerations"></a>Вопросы оплаты Azure  
 Оценка затрат на использование служб Azure — это важный вопрос, который необходимо учитывать в процессе принятия решения и планирования. При хранении файлов данных SQL Server в хранилище Azure оплачивается стоимость использования хранилища и выполнения транзакций. Кроме того, реализация компонента SQL Server Data Files в службе хранилища Azure требует неявного возобновления аренды большого двоичного объекта каждые 45–60 секунд. При этом также возникают затраты на транзакции для каждого файла базы данных, например, MDF или LDF. Для оценки ежемесячных затрат на использование службы хранилища Azure и виртуальных машин Azure воспользуйтесь информацией на странице [Цены Azure](https://azure.microsoft.com/pricing/).  
  
### <a name="sql-server-concepts"></a>Основные понятия SQL Server  
 При использовании этого нового компонента необходимо выполнить следующие действия.  
  
-   Необходимо создать политику для контейнера, а также сформировать ключ подписи общего доступа.  
  
-   Для каждого контейнера, используемого файлом данных или журнала, необходимо создать учетные данные SQL Server, имя которых соответствует пути контейнера.  
  
-   Необходимо хранить сведения о контейнере службы хранилища Azure, связанную с ним политику и ключ SAS в хранилище учетных данных SQL Server.  
  
 В следующем примере предполагается, что контейнер службы хранилища Azure создан, а политика предусматривает права на чтение, запись и создание списков. При создании политики для контейнера формируется ключ SAS, который безопасно размещать в памяти в незашифрованном виде. SQL Server использует этот ключ для доступа к файлам больших двоичных объектов в контейнере. В следующем фрагменте кода замените `'<your SAS key>'` на запись следующего вида: `'sr=c&si=<MYPOLICYNAME>&sig=<THESHAREDACCESSSIGNATURE>'`. Дополнительные сведения см. в статье [Управление анонимным доступом на чтение к контейнерам и большим двоичным объектам](https://docs.microsoft.com/azure/storage/blobs/storage-manage-access-to-resources)  
  
```sql
CREATE CREDENTIAL [https://testdb.blob.core.windows.net/data]  
WITH IDENTITY='SHARED ACCESS SIGNATURE',  
SECRET = '<your SAS key>'  
  
CREATE DATABASE testdb   
ON  
( NAME = testdb_dat,  
    FILENAME = 'https://testdb.blob.core.windows.net/data/TestData.mdf' )  
 LOG ON  
( NAME = testdb_log,  
    FILENAME =  'https://testdb.blob.core.windows.net/data/TestLog.ldf')  
```  
  
 **Важное примечание.** Если в контейнере имеются любые активные ссылки на файлы данных, попытки удаления соответствующих учетных данных SQL Server заканчиваются сбоем.  
  
### <a name="security"></a>безопасность  
 При хранении файлов данных SQL Server в службе хранилища Azure необходимо учитывать следующие требования и вопросы безопасности.  
  
-   При создании контейнера для службы хранилища больших двоичных объектов Azure рекомендуется установить для него закрытые права доступа. При выборе частного типа доступа данные контейнера и больших двоичных объектов могут быть прочитаны только владельцем учетной записи Azure.  
  
-   При хранении файлов базы данных SQL Server в службе хранилища Azure необходимо использовать подписанный URL-адрес (URI, который предоставляет ограниченные права доступа к контейнерам, большим двоичным объектам, очередям и таблицам). С помощью подписанного URL-адреса можно обеспечить SQL Server возможность доступа к ресурсам из учетной записи без предоставления доступа к ключу учетной записи службы хранилища Azure.  
  
-   Кроме того, рекомендуется продолжать использовать стандартные методы обеспечения безопасности локальных баз данных.  
  
### <a name="installation-prerequisites"></a>Компоненты, необходимые для установки  
 Далее приведены обязательные компоненты, которые необходимы при хранении файлов данных SQL Server в Azure.  
  
-   **Локальный SQL Server.** Этот компонент входит в SQL Server 2016 и более поздние версии. Чтобы узнать, как скачать последнюю версию SQL Server, см. раздел [SQL Server](https://www.microsoft.com/sql-server/sql-server-downloads).  
  
-   SQL Server на виртуальной машине Azure. Если вы устанавливаете [SQL Server на виртуальной машине Azure](https://azuremarketplace.microsoft.com/marketplace/apps?search=sql%20server&page=1), установите SQL Server 2016 или обновите установленный ранее экземпляр. Также можно создать новую виртуальную машину в Azure с помощью образа платформы SQL Server 2016.

  
###  <a name="bkmk_Limitations"></a> Ограничения  
  
-   В текущем выпуске этого компонента хранение данных **FileStream** в службе хранилища Azure не поддерживается. Вы можете хранить данные **FileStream** в базе данных, которая также содержит файлы данных, хранящихся в службе хранилища Azure, но все файлы данных FileStream должны храниться в локальном хранилище.  Так как данные FileStream должны находиться в локальном хранилище, их нельзя перемещать между компьютерами с помощью службы хранилища Azure. Поэтому рекомендуется продолжать использовать [традиционные методы](../../relational-databases/blob/move-a-filestream-enabled-database.md) для перемещения данных, связанных с FileStream, между разными компьютерами.  
  
-   Сейчас этот новый модуль не поддерживает одновременный доступ нескольких экземпляров SQL Server к одним и тем же файлам базы данных в службе хранилища Azure. Если ServerA находится в сети с активным файлом базы данных, а ServerB будет случайно запущен и при этом на нем тоже есть база данных, указывающая на тот же файл данных, второй сервер не сможет запустить базу данных и вернет код ошибки **5120. Не удается открыть физический файл "%.\*ls". Ошибка операционной системы %d: "%ls"** .  
  
-   Только MDF-, LDF- и NDF-файлы могут храниться в службе хранилища Azure с использованием компонента SQL Server Data Files в Azure.  
  
-   При использовании компонента SQL Server Data Files в Azure георепликация для учетной записи не поддерживается. Если в учетной записи работает георепликация и была выполнена географическая отработка отказа, может произойти повреждение базы данных.  
  
-   Ограничения емкости см. в разделе [Общие сведения о хранилище BLOB-объектов](https://docs.microsoft.com/azure/storage/blobs/storage-blobs-introduction).  
  
-   Невозможно сохранить данные выполняющейся в памяти OLTP в большом двоичном объекте Azure с помощью компонента SQL Server Data Files в Azure. Это происходит потому, что выполняющаяся в памяти OLTP зависит от **FileStream** , и в текущем выпуске этого компонента хранение данных **FileStream** в службе хранилища Azure не поддерживается.  
  
-   При использовании компонента SQL Server Data Files в Azure SQL Server выполняет все сравнения URL-адресов или путей к файлам с помощью параметров сортировки в базе данных **master** .  
  
-   Использовать **группы доступности AlwaysOn** можно в том случае, если вы не добавляете новые файлы в базу данных-источник. Если для выполнения какой-то операции требуется создать в базе данных-источнике новый файл, сначала отключите группы доступности AlwaysOn на вторичном узле. Затем выполните операцию базы данных в базе данных-источнике и создайте резервную копию базы данных на основном узле. После этого восстановите базу данных на вторичном узле и включите на нем группы доступности AlwaysOn. Обратите внимание, что при использовании компонента "Файлы данных SQL Server в Azure" экземпляры отказоустойчивого кластера Always On не поддерживаются.  
  
-   При обычной работе SQL Server использует временные аренды, чтобы зарезервировать большие двоичные объекты для хранения с возобновлением аренды каждого большого двоичного объекта каждые 45–60 секунд. Если происходит сбой сервера и запускается другой экземпляр SQL Server, который настроен для использования тех же больших двоичных объектов, новый экземпляр будет ждать окончания аренды для большого двоичного объекта вплоть до 60 секунд. Если необходимо присоединить базу данных к другому экземпляру и ждать окончания срока аренды в течение 60 секунд невозможно, то можно явно прервать аренду большого двоичного объекта, чтобы избежать сбоев операций присоединения.  
  
## <a name="tools-and-programming-reference-support"></a>Средства и справочник по программированию  
 В этом разделе описаны средства и библиотеки справочных материалов по программированию, которые можно использовать при хранении файлов данных SQL Server в службе хранилища Azure.  
  
### <a name="powershell-support"></a>Поддержка PowerShell  
 Используйте командлеты PowerShell для хранения файлов данных SQL Server в службе хранилища больших двоичных объектов Azure, указывая URL-адрес хранилища вместо пути к файлу. Обращайтесь к большим двоичным объектам по URL-адресам в следующем формате: `https://storageaccount.blob.core.windows.net/<container>/<blob>`.  
  
### <a name="sql-server-object-and-performance-counters-support"></a>Поддержка объектов SQL Server и счетчиков производительности  
 Начиная с SQL Server 2014, добавлен новый объект SQL Server для использования с компонентом SQL Server Data Files в службе хранилища Azure. Новый объект SQL Server вызывается как [SQL Server, HTTP_STORAGE_OBJECT](../../relational-databases/performance-monitor/sql-server-http-storage-object.md) и может использоваться системным монитором для отслеживания действий, выполняемых при работе SQL Server со службой хранилища Azure.  
  
### <a name="sql-server-management-studio-support"></a>Поддержка среды SQL Server Management Studio  
 Среда SQL Server Management Studio позволяет использовать этот компонент с помощью нескольких диалоговых окон. Можно ввести URL-адрес контейнера хранилища, например https://teststorageaccnt.blob.core.windows.net/testcontainer/:
 
 в поле **Путь** в нескольких разных диалоговых окнах ( **Создание базы данных**, **Присоединение базы данных**и **Восстановление базы данных**). Дополнительные сведения см. в статье [Учебник. использованию службы хранилища больших двоичных объектов Microsoft Azure с базами данных SQL Server 2016](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md).  
  
### <a name="sql-server-management-objects-smo-support"></a>Поддержка управляющих объектов SQL Server (SMO)  
 При использовании компонента SQL Server Data Files в Azure поддерживаются все управляющие объекты SQL Server (SMO). Если объект SMO требует пути к файлам, вместо локального пути используйте формат URL-адреса большого двоичного объекта, например `https://teststorageaccnt.blob.core.windows.net/testcontainer/`. Дополнительные сведения об управляющих объектах SQL Server (SMO) см. в разделе [Учебник по программированию управляющих объектов SQL Server (SMO)](../../relational-databases/server-management-objects-smo/sql-server-management-objects-smo-programming-guide.md) электронной документации по SQL Server.  
  
### <a name="transact-sql-support"></a>Поддержка Transact-SQL  
 Этот новый компонент внес следующие изменения в контактную зону Transact-SQL:  
  
-   Новый столбец **int** , **credential_id**, в системном представлении **sys.master_files** . Столбец **credential_id** используется для обеспечения указания перекрестных ссылок на файлы данных из хранилища Azure назад в представление sys.credentials для учетных данных, созданных для них. Это можно использовать для устранения неполадок, например, когда невозможно удалить учетные данные при наличии файла базы данных, который использует их.  
  
##  <a name="bkmk_Troubleshooting"></a> Устранение неполадок для SQL Server Data Files в Microsoft Azure  
 Для избежания ошибок в связи с не поддерживаемыми функциями или ограничениями, обратитесь сначала к [Limitations](../../relational-databases/databases/sql-server-data-files-in-microsoft-azure.md#bkmk_Limitations).  
  
 Далее приведен список ошибок, которые могут быть получены при использовании SQL Server Data Files в службе хранилища Azure.  
  
 **Ошибки проверки подлинности**  
  
-   *Невозможно удалить учетные данные "%.\*ls", так как они используются активным файлом базы данных.*    
    Решение. Эта ошибка отображается при попытке удалить учетные данные, которые используются активным файлом базы данных в службе хранилища Azure. Чтобы удалить учетные данные, необходимо сначала удалить сопоставленный большой двоичный объект, которому принадлежит этот файл базы данных. Чтобы удалить большой двоичный объект с активной арендой, сначала необходимо прервать аренду.  
  
-   *Подписанный URL-адрес был создан в контейнере неправильно.*    
     Решение. Убедитесь, что вы создали подпись общего доступа для контейнера правильно. Ознакомьтесь с инструкциями, приведенными в занятии 2 в [руководстве по использованию службы хранилища больших двоичных объектов Microsoft Azure с базами данных SQL Server 2016](../lesson-2-create-a-sql-server-credential-using-a-shared-access-signature.md).  
  
-   *Учетные данные SQL Server созданы неправильно.*    
    Решение. Убедитесь, что в поле **Идентификатор** указано значение "Подписанный URL-адрес" и секрет сформирован правильно. Ознакомьтесь с инструкциями, приведенными в занятии 3 в [руководстве по использованию службы хранилища больших двоичных объектов Microsoft Azure с базами данных SQL Server 2016](../lesson-3-database-backup-to-url.md).  
  
 **Ошибки аренды больших двоичных объектов**  
  
-   Ошибка при попытке запустить SQL Server после сбоя другого экземпляра, использующего те же файлы больших двоичных объектов. Решение. При обычной работе SQL Server использует временные аренды, чтобы зарезервировать большие двоичные объекты для хранения с возобновлением аренды каждого большого двоичного объекта каждые 45–60 секунд. Если происходит сбой сервера и запускается другой экземпляр SQL Server, который настроен для использования тех же больших двоичных объектов, новый экземпляр будет ждать окончания аренды для большого двоичного объекта вплоть до 60 секунд. Если необходимо присоединить базу данных к другому экземпляру и ждать окончания срока аренды в течение 60 секунд невозможно, то можно явно прервать аренду большого двоичного объекта, чтобы избежать сбоев операций присоединения.  
  
 **Ошибки базы данных**  
  
1.  *Ошибка создания базы данных*   
    Решение. Ознакомьтесь с инструкциями, приведенными в занятии 4 в [руководстве по использованию службы хранилища больших двоичных объектов Microsoft Azure с базами данных SQL Server 2016](../lesson-4-restore-database-to-virtual-machine-from-url.md).  
  
2.  *Ошибки при выполнении инструкции Alter*   
    Решение. Инструкцию Alter необходимо выполнять, когда база данных находится в режиме "в сети". При копировании файлов данных в службу хранилища Azure всегда создавайте страничный, а не блочный большой двоичный объект. В противном случае инструкция ALTER для базы данных завершится ошибкой. Ознакомьтесь с инструкциями, приведенными в занятии 7 в [руководстве по использованию службы хранилища больших двоичных объектов Microsoft Azure с базами данных SQL Server 2016](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md).  
  
3.  \*Код ошибки 5120. Не удалось открыть физический файл "%.*ls". Ошибка операционной системы %d: "%ls"*   

    Решение. Сейчас этот новый модуль не поддерживает одновременный доступ нескольких экземпляров SQL Server к одним и тем же файлам базы данных в службе хранилища Azure. Если ServerA находится в сети с активным файлом базы данных, а ServerB будет случайно запущен и при этом на нем тоже есть база данных, указывающая на тот же файл данных, второй сервер не сможет запустить базу данных и вернет код ошибки *5120. Не удается открыть физический файл "%.\*ls". Ошибка операционной системы %d: "%ls"* .  
  
     Чтобы устранить эту проблему, необходимо сначала определить, есть ли у ServerA доступ к файлу базы данных, который находится в службе хранилища Azure. Если нет, просто удалите все связи между ServerA и файлами базы данных из службы хранилища Azure. Для этого выполните следующие шаги.  
  
    1.  С помощью инструкции ALTER установите для ServerA пути к файлам из локальных папок.  
  
    2.  Переведите базу данных на ServerA в режим «вне сети».  
  
    3.  Затем скопируйте файлы базы данных из службы хранилища Azure в локальную папку на ServerA. Это гарантирует, что ServerA по-прежнему будет иметь локальную копию базы данных.  
  
    4.  Переведите базу данных в режим «в сети».  

## <a name="next-steps"></a>Следующие шаги  
  
[Создание базы данных](create-a-database.md)
