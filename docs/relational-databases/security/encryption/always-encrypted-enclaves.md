---
title: Always Encrypted с безопасными анклавами (ядро СУБД) | Документация Майкрософт
ms.custom: ''
ms.date: 09/24/2018
ms.prod: sql
ms.prod_service: database-engine, sql-database
ms.reviewer: ''
ms.technology: security
ms.topic: conceptual
author: jaszymas
ms.author: jaszymas
manager: craigg
monikerRange: '>= sql-server-ver15 || = sqlallproducts-allversions'
ms.openlocfilehash: 377c2d95564e7348bdfb5de9480c7c7f5004c7f7
ms.sourcegitcommit: 3026c22b7fba19059a769ea5f367c4f51efaf286
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/15/2019
ms.locfileid: "65938157"
---
# <a name="always-encrypted-with-secure-enclaves"></a>Always Encrypted с безопасными анклавами
[!INCLUDE[tsql-appliesto-ssver15-xxxx-xxxx-xxx](../../../includes/tsql-appliesto-ssver15-xxxx-xxxx-xxx.md)]


Always Encrypted с безопасными анклавами предоставляет дополнительные функциональные возможности для компонента [Always Encrypted](always-encrypted-database-engine.md).

Представленный в SQL Server 2016 компонент Always Encrypted защищает конфиденциальные данные от вредоносных программ и *неавторизованных* пользователей SQL Server, обладающих очень высокими правами доступа. Неавторизованные пользователи с очень высокими правами доступа — это администраторы баз данных, администраторы компьютеров, администраторы облака или другие пользователи, у которых есть санкционированный доступ к экземплярам сервера, оборудованию и т. д., но эти пользователи не должны иметь доступ к некоторым или всем фактическим данным. 

До настоящего момента Always Encrypted защищает данные, шифруя их на стороне клиента и никогда не допуская отображение данных или соответствующих криптографических ключей в обычном тексте в ядре SQL Server. Таким образом, функциональные возможности для зашифрованных столбцов в базе данных были строго ограничены. Единственные операции, которые SQL Server мог выполнять с зашифрованными данными, — это сравнения на равенство (и сравнения на равенство были доступны только при использовании детерминированного шифрования). Все остальные операции, включая криптографические операции (начальное шифрование данных или смена ключа) или полнофункциональные вычисления (например, сопоставления шаблонов), в базе данных не поддерживаются. Пользователям приходилось перемещать данные за пределы базы данных, чтобы выполнять эти операции на стороне клиента.

Always Encrypted *с безопасными анклавами* устраняет эти ограничения, позволяя выполнять вычисления с данными в виде обычного текста внутри безопасного анклава на стороне сервера. Безопасный анклав — это защищенная область памяти в процессе SQL Server. Он также выступает в качестве доверенной среды выполнения для обработки конфиденциальных данных в ядре SQL Server. Безопасный анклав представляет собой "черный ящик" на фоне остальной части SQL Server и других процессов на главном компьютере. Просмотреть данные или код внутри анклава извне невозможно, даже с помощью отладчика.  


Always Encrypted использует безопасные анклавы, как показано на следующей схеме:

![поток данных](./media/always-encrypted-enclaves/ae-data-flow.png)



При синтаксическом анализе запроса приложения ядро SQL Server определяет, содержит ли запрос любые операции с зашифрованными данными, для которых требуется использовать безопасный анклав. Для запросов, где требуется доступ к безопасному анклаву:

- Драйвер клиента отправляет ключи шифрования столбцов, необходимые для выполнения операций, в безопасный анклав (через защищенный канал). 
- Затем драйвер клиента отправляет запрос для выполнения, а также зашифрованные параметры запроса.

При обработке запроса данные или ключи шифрования столбцов не отображаются в виде обычного текста в ядре SQL Server за пределами безопасного анклава. Ядро SQL Server делегирует криптографические операции и вычисления в зашифрованных столбцах безопасному анклаву. При необходимости безопасный анклав расшифровывает параметры запроса и/или данные, хранящиеся в зашифрованных столбцах, и выполняет запрошенные операции.

## <a name="why-use-always-encrypted-with-secure-enclaves"></a>Почему следует использовать Always Encrypted с безопасными анклавами?

С помощью безопасных анклавов Always Encrypted защищает конфиденциальные данные, предоставляя следующие преимущества:

- **Шифрование на месте** — криптографические операции с конфиденциальными данными, например начальное шифрование данных или смена ключа шифрования столбца, выполняются внутри безопасного анклава и не требуют перемещения данных за пределы базы данных. Шифрование на месте можно выполнять с помощью инструкции Transact-SQL ALTER TABLE, и для этого не нужно использовать средства, такие как мастер Always Encrypted в SSMS или командлет PowerShell Set-SqlColumnEncryption.

- **Полнофункциональные вычисления (предварительная версия)**  — операции в зашифрованных столбцах, включая сопоставление шаблонов (предикат LIKE) и сравнения диапазонов, поддерживаются в безопасном анклаве, благодаря чему Always Encrypted можно использовать в широком диапазоне приложений и сценариев, в которых требуется, чтобы такие вычисления выполнялись в системе базы данных.

> [!IMPORTANT]
> В [!INCLUDE[sql-server-2019](../../../includes/sssqlv15-md.md)] для полнофункциональных вычислений будут выпущены несколько оптимизаций производительности, включая ограниченную функциональность (отсутствие индексирования и т. д.). Сейчас они отключены по умолчанию. Сведения о включении полнофункциональных вычислений см. в разделе [Настройка безопасного анклава](configure-always-encrypted-enclaves.md#configure-a-secure-enclave).

В [!INCLUDE[sql-server-2019](../../../includes/sssqlv15-md.md)] Always Encrypted с безопасными анклавами использует безопасные анклавы памяти [безопасности на основе виртуализации (VBS)](https://www.microsoft.com/security/blog/2018/06/05/virtualization-based-security-vbs-memory-enclaves-data-protection-through-isolation/) (это также называется виртуальным безопасным режимом или анклавами VSM) в Windows.

## <a name="secure-enclave-attestation"></a>Аттестация безопасного анклава

Безопасный анклав в ядре SQL Server может получать доступ к конфиденциальным данным, хранящимся в зашифрованных столбцах базы данных, и соответствующим ключам шифрования столбцов в виде обычного текста. Прежде чем отправить запрос, который включает в себя вычисления анклава, в SQL Server, драйвер клиента в приложении должен проверить, является ли безопасный анклав подлинным анклавом на основе заданной технологии (например, VBS), а также зарегистрирован ли выполняемый в анклаве код для выполнения внутри анклава. 

Процесс проверки анклава называется **аттестацией анклава**. Как правило, в нем задействован драйвер клиента в приложении (и иногда также SQL Server), обращающийся к внешней службе аттестации. Особенности процесса аттестации зависят от технологии анклава и службы аттестации.

Процесс аттестации, который SQL Server поддерживает для безопасных анклавов VBS в [!INCLUDE[sql-server-2019](../../../includes/sssqlv15-md.md)], — это аттестация среды выполнения System Guard в Защитнике Windows, которая использует службу защиты узла (HGS) в качестве службы аттестации. Необходимо настроить HGS в вашей среде и зарегистрировать компьютер, на котором размещен экземпляр SQL Server, в HGS. Кроме того, необходимо настроить клиентские приложения и средства (например, SQL Server Management Studio) с применением аттестации HGS.

## <a name="secure-enclave-providers"></a>Поставщики безопасных анклавов

Чтобы использовать Always Encrypted с безопасными анклавами, приложению необходимо использовать драйвер клиента, который поддерживает эту функцию. В [!INCLUDE[sql-server-2019](../../../includes/sssqlv15-md.md)] приложения должны использовать .NET Framework 4.7.2 и поставщик данных .NET Framework для SQL Server. Кроме того, приложения .NET должны быть настроены с применением **поставщика безопасных анклавов**, относящегося к определенному типу анклава (например, VBS), и используемой службы аттестации (например, HGS). Поддерживаемые поставщики анклавов поставляются отдельно в виде пакета NuGet, который необходимо интегрировать с приложением. Поставщик анклавов реализует логику на стороне клиента для протокола аттестации, а также для установки безопасного канала с безопасным анклавом заданного типа.

## <a name="enclave-enabled-keys"></a>Ключи с поддержкой анклава

В Always Encrypted с безопасными анклавами реализованы ключи с поддержкой анклава:

- **Главный ключ столбца с поддержкой анклава** — главный ключ столбца со свойством ENCLAVE_COMPUTATIONS, указанным в объекте метаданных главного ключа столбца в базе данных. Объект метаданных главного ключа столбца также должен содержать допустимую подпись свойств метаданных.
- **Ключ шифрования столбца с поддержкой анклава** — ключ шифрования столбца, зашифрованный с помощью главного ключа столбца с поддержкой анклава.

Если ядро SQL Server определяет операции, которые указаны в запросе и которые необходимо выполнить внутри безопасного анклава, ядро SQL Server запрашивает, чтобы драйвер клиента отправил ключи шифрования столбцов, необходимые для вычислений, в безопасный анклав. Драйвер клиента отправляет ключи шифрования столбцов только в том случае, если ключи поддерживают анклав (то есть зашифрованы с помощью главных ключей столбцов с поддержкой анклава) и подписаны должным образом. В противном случае запрос завершится ошибкой.

## <a name="enclave-enabled-columns"></a>Столбцы с поддержкой анклава

Столбец с поддержкой анклава — это столбец базы данных, зашифрованный с помощью ключа шифрования столбца с поддержкой анклава. Функциональные возможности, доступные для столбца с поддержкой анклава, зависят от типа шифрования, используемого в столбце.

- **Детерминированное шифрование.** Столбцы с поддержкой анклава, использующие детерминированное шифрование, поддерживают шифрование на месте, но не поддерживают остальные операции внутри безопасного анклава. Сравнение на равенство поддерживается, но выполняется за пределами анклава путем сравнения зашифрованных данных (за пределами анклава).  
- **Случайное шифрование.** Столбцы с поддержкой анклава, использующие случайное шифрование, поддерживают шифрование на месте, а также полнофункциональные вычисления внутри безопасного анклава. Поддерживаемые полнофункциональные вычисления — это сопоставления шаблонов и [операторы сравнения](https://docs.microsoft.com/sql/t-sql/language-elements/comparison-operators-transact-sql), включая сравнение на равенство.

Дополнительные сведения о типах шифрования см. в статье [Системы шифрования c технологиями постоянного шифрования](always-encrypted-cryptography.md).

В следующей таблице перечислены функциональные возможности, доступные для зашифрованных столбцов в зависимости от того, используются ли в столбцах ключи шифрования столбцов с поддержкой анклава, и от типа шифрования.

| **Операция**| **Столбец НЕ поддерживает анклав** |**Столбец НЕ поддерживает анклав**| **Столбец поддерживает анклав**  |**Столбец поддерживает анклав** |
|:---|:---|:---|:---|:---|
| | **Случайное шифрование**  | **Детерминированное шифрование**     | **Случайное шифрование**      | **Детерминированное шифрование**     |
| **Шифрование на месте** | Не поддерживается  | Не поддерживается   | Поддерживается         | Поддерживается    |
| **Сравнение на равенство**   | Не поддерживается | Поддерживается вне анклава | Поддерживается (внутри анклава) | Поддерживается вне анклава |
| **Операторы сравнения помимо проверки на равенство** | Не поддерживается  | Не поддерживается   | Поддерживается      | Не поддерживается     |
| **LIKE**    | Не поддерживается      | Не поддерживается    | Поддерживается     | Не поддерживается    |

Шифрование на месте поддерживает следующие операции внутри анклава:

- Первоначальное шифрование данных, хранящихся в имеющемся столбце.
- Повторное шифрование имеющихся данных в столбце, например:
  
  - смена ключа шифрования столбца (повторное шифрование столбца с использованием нового ключа);
  - изменение типа шифрования.  

- Расшифровка данных, хранящихся в зашифрованном столбце (преобразование столбца в столбец с обычным текстом).

Для шифрования на месте ключ (или ключи) шифрования столбца, участвующий в криптографических операциях, должен поддерживать анклав:

- первоначальное шифрование — ключ шифрования столбца для шифрования столбца должен поддерживать анклав;
- повторное шифрование — текущий и целевой ключи шифрования столбца (если отличается от текущего ключа) должны поддерживать анклав;
- расшифровка — текущий ключ шифрования столбца должен поддерживать анклав.

## <a name="known-limitations"></a>Известные ограничения

Общие ограничения: 

- Все ограничения, перечисленные для текущей версии Always Encrypted в разделе [Сведения о возможностях](https://docs.microsoft.com/sql/relational-databases/security/encryption/always-encrypted-database-engine#feature-details), применимы и к Always Encrypted с безопасными анклавами (для столбцов, зашифрованных с использованием ключей с поддержкой анклава), за исключением ограничений, которые устраняются за счет добавления поддержки шифрования на месте и полнофункциональных вычислений.

- Сравнение на равенство остается единственным оператором Transact-SQL, поддерживаемым с детерминированным шифрованием, и сравнения на равенство выполняются путем сравнения значений зашифрованных данных за пределами анклава независимо от того, поддерживает ли ключ шифрования столбцов анклав. Единственные новые функциональные возможности, которые становятся доступными благодаря ключам шифрования столбцов с поддержкой анклава для детерминированного шифрования, — это криптографические операции на месте. Если у вас есть столбец, зашифрованный с помощью детерминированного шифрования (и ключ, который не поддерживает анклав), чтобы сделать возможными полнофункциональные вычисления (сопоставление шаблонов, операции сравнения), вам потребуется повторно зашифровать столбец с помощью случайного шифрования.

- Имеющееся ограничение на использование параметров сортировки применяется к столбцам, зашифрованным с помощью ключей шифрования столбцов с поддержкой анклава. Столбцы символьной строки (char, nchar, varchar, nvarchar), зашифрованные с помощью детерминированного шифрования, должны использовать параметры сортировки с порядком сортировки binary2 (параметры сортировки BIN2). Столбцы символьной строки, использующие параметры сортировки, отличные от BIN2, могут быть зашифрованы с помощью случайного шифрования. Но единственная новая функциональная возможность, доступная для таких столбцов (если они зашифрованы с использованием ключей шифрования столбцов с поддержкой анклава), — это шифрование на месте. **Для поддержки полнофункциональных вычислений (сопоставление шаблонов, операции сравнения) столбец должен использовать параметры сортировки BIN2** (и столбец должен быть зашифрован с помощью случайного шифрования и ключа шифрования столбца с поддержкой анклава).

- Использование ключей с поддержкой анклава для столбцов в таблицах в памяти не поддерживается.

- Криптографические операции на месте нельзя объединять с другими изменениями метаданных столбцов, за исключением изменений параметров сортировки и допустимости значений NULL. К примеру, нельзя зашифровать, повторно зашифровать или расшифровать столбец и изменить тип данных столбца в одной инструкции Transact-SQL ALTER TABLE или ALTER COLUMN. Необходимо использовать две отдельных инструкции.

Следующие ограничения применяются к текущей предварительной версии, но в будущем планируется их устранение:

- Столбцы с поддержкой анклава, использующие случайное шифрование данных, нельзя индексировать, а это означает, что для операций сравнения или операций LIKE требуется сканирования таблиц.

- Единственный драйвер клиента, поддерживающий Always Encrypted с безопасными анклавами, — поставщик данных .NET Framework для SQL Server (ADO.NET) в .NET Framework 4.7.2. ODBC и JDBC не поддерживаются.

- Единственные поддерживаемые хранилища ключей для хранения главных ключей столбцов с поддержкой анклава — хранилище сертификатов Windows и Azure Key Vault.

- Поддержка инструментов для Always Encrypted с безопасными анклавами еще неполная. Для запуска криптографической операции на месте с помощью инструкции Transact-SQL ALTER TABLE необходимо запустить инструкцию в окне запроса в среде SSMS или написать собственную программу, которая выполняет инструкцию. Командлет Set-SqlColumnEncryption в модуле SqlServer PowerShell и мастер Always Encrypted в SQL Server Management Studio еще не поддерживают шифрование на месте. Обе эти программы сейчас перемещают данные из базы данных для криптографических операций, даже если ключи шифрования столбцов, используемые для операций, поддерживают анклав. 

## <a name="known-issues"></a>Известные проблемы

- Для полнофункциональных вычислений в строковых столбцах не в Юникоде (char, varchar) требуется, чтобы параметры сортировки BIN2 были заданы на уровне базы данных. Особые замечания относительно строковых столбцов не в Юникоде см. в разделе [Управление параметрами сортировки](configure-always-encrypted-enclaves.md#manage-collations).

## <a name="next-steps"></a>Next Steps

- Вы можете настроить тестовую среду и протестировать функциональные возможности Always Encrypted с безопасными анклавами в SSMS, см. статью [Руководство. Начало работы с Always Encrypted с безопасными анклавами с использованием SSMS](../tutorial-getting-started-with-always-encrypted-enclaves.md).
