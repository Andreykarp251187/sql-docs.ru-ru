---
title: Перенос конфиденциальных данных с помощью функции постоянного шифрования | Документация Майкрософт
ms.custom: ''
ms.date: 11/04/2015
ms.prod: sql
ms.prod_service: database-engine, sql-database
ms.reviewer: vanto
ms.technology: security
ms.topic: conceptual
helpviewer_keywords:
- Always Encrypted, bulk import
ms.assetid: b2ca08ed-a927-40fb-9059-09496752595e
author: aliceku
ms.author: aliceku
monikerRange: =azuresqldb-current||>=sql-server-2016||=sqlallproducts-allversions||>=sql-server-linux-2017||=azuresqldb-mi-current
ms.openlocfilehash: ff72a94df79c6f8fe7b8bb37caeb57587e44b034
ms.sourcegitcommit: b2464064c0566590e486a3aafae6d67ce2645cef
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/15/2019
ms.locfileid: "68111676"
---
# <a name="migrate-sensitive-data-protected-by-always-encrypted"></a>Перенос конфиденциальных данных с помощью функции постоянного шифрования
[!INCLUDE[appliesto-ss-asdb-xxxx-xxx-md](../../../includes/appliesto-ss-asdb-xxxx-xxx-md.md)]

Чтобы во время операций массового копирования загрузить зашифрованные данные, не проверяя метаданные на сервере, создайте пользователя с параметром **ALLOW_ENCRYPTED_VALUE_MODIFICATIONS** . Этот параметр предназначен для средств устаревших версий сервера [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], выпущенных до выпуска [!INCLUDE[ssSQL15](../../../includes/sssql15-md.md)] (например, bcp.exe), или для сторонних рабочих процессов извлечения, преобразования и загрузки (ETL), которые не могут использовать функцию Always Encrypted. Таким образом пользователи могут безопасно перемещать зашифрованные данные из одного набора таблиц, содержащего зашифрованные столбцы, в другой набор таблиц с зашифрованными столбцами (в той же или другой базе данных).  

 ## <a name="the-allowencryptedvaluemodifications-option"></a>Параметр ALLOW_ENCRYPTED_VALUE_MODIFICATIONS  
 Команды [CREATE USER](../../../t-sql/statements/create-user-transact-sql.md) и [ALTER USER](../../../t-sql/statements/alter-user-transact-sql.md) имеют параметр ALLOW_ENCRYPTED_VALUE_MODIFICATIONS. Если задано значение ON (значение по умолчанию — OFF), этот параметр отключает проверки шифрованных метаданных на сервере в операциях массового копирования, что позволяет пользователю массово копировать зашифрованные данные из одной таблицы или базы данных в другую и при этом не расшифровывать данные.  
  
## <a name="data-migration-scenarios"></a>Сценарии переноса данных  
В таблице ниже показаны рекомендуемые параметры, подходящие для нескольких сценариев переноса.  
 
![Миграция постоянного шифрования](../../../relational-databases/security/encryption/media/always-encrypted-migration.PNG "Миграция постоянного шифрования")  

## <a name="bulk-loading-of-encrypted-data"></a>Массовая загрузка зашифрованных данных  
Загружайте зашифрованные данные с помощью такого процесса:  

1.  Присвойте параметру значение ON для пользователя в базе данных, в которую массово копируются данные. Пример:  
 
   ```  
    ALTER USER Bob WITH ALLOW_ENCRYPTED_VALUE_MODIFICATIONS = ON;  
   ```  

2.  Подключившись, как этот пользователь, запустите приложение или средство массового копирования. (Если приложение использует драйвер клиента с включенным постоянным шифрованием, убедитесь, что строка подключения для источника данных не содержит параметр **column encryption setting=enabled** , который оставляет зашифрованными данные, извлеченные из зашифрованных столбцов. Дополнительные сведения см. в разделе [Постоянное шифрование (разработка клиентских приложений)](../../../relational-databases/security/encryption/always-encrypted-client-development.md)(Постоянное шифрование (разработка клиентских приложений)).  
  
3.  Снова задайте для параметра ALLOW_ENCRYPTED_VALUE_MODIFICATIONS значение OFF. Пример:  

    ```  
    ALTER USER Bob WITH ALLOW_ENCRYPTED_VALUE_MODIFICATIONS = OFF;  
    ```  

## <a name="potential-for-data-corruption"></a>Возможное повреждение данных  
Неправильное использование этого параметра может привести к повреждению данных. Параметр **ALLOW_ENCRYPTED_VALUE_MODIFICATIONS** позволяет пользователю вставлять данные в зашифрованные столбцы в базе данных, в том числе данные, зашифрованные с помощью разных ключей, неверно зашифрованные данные и данные, которые вообще не зашифрованы. Если пользователь случайно копирует данные, которые неправильно зашифрованы с помощью схемы шифрования (ключ шифрования столбца, алгоритм, тип шифрования), настроенной для целевого столбца, вы не сможете расшифровать эти данные (они будут повреждены). Этот параметр следует использовать осторожно, так как он может повредить данные в базе данных.  

Приведенный ниже сценарий демонстрирует, как неправильный импорт данных может привести к их повреждению:  

1.  Для пользователя задано значение ON для этого параметра.  
 
2.  Пользователь запускает приложение, которое подключается к базе данных. Приложение с помощью массовых API-интерфейсов вставляет обычные текстовые значения в зашифрованные столбцы. Приложение ожидает, что драйвер клиента с включенным постоянным шифрованием зашифрует данные при вставке. Но приложение настроено неправильно, поэтому или оно использует драйвер, не поддерживающий постоянное шифрование, или строка подключения не содержит параметр **column encryption setting=enabled**.  

3.  Приложение отправляет обычные текстовые значения на сервер. Так как проверки зашифрованных метаданных на сервере отключены для пользователя, сервер позволяет вставлять в зашифрованный столбец недопустимые данные (открытый текст вместо зашифрованных данных).  
 
4.  То же или другое приложение подключается к базе данных с помощью драйвера с включенным постоянным шифрованием и параметром **column encryption setting=enabled** в строке подключения, а затем извлекает данные. Приложение ожидает, что драйвер расшифрует данные. Но драйверу это не удается, так как данные зашифрованы неверно.  

## <a name="best-practice"></a>Рекомендации  
 
Используйте назначенные учетные записи пользователя для долговременных рабочих нагрузок, использующих этот параметр.  
 
Работая с кратковременно работающими приложениями или средствами массового копирования, которым нужно переместить зашифрованные данные, но не нужно их расшифровывать, задавайте для параметра значение ON непосредственно перед запуском приложения, возвращая значение OFF сразу после запуска операции.  
 
Не разрабатывайте новые приложения с помощью этого параметра. Лучше используйте драйвер клиента (например, ADO 4.6.1), в котором есть API, отключающий проверки зашифрованных метаданных на время одного сеанса.  

## <a name="see-also"></a>См. также:  
[CREATE USER (Transact-SQL)](../../../t-sql/statements/create-user-transact-sql.md)   
[ALTER USER (Transact-SQL)](../../../t-sql/statements/alter-user-transact-sql.md)   
[Постоянное шифрование (компонент Database Engine)](../../../relational-databases/security/encryption/always-encrypted-database-engine.md)   
[Мастер постоянного шифрования](../../../relational-databases/security/encryption/always-encrypted-wizard.md)   
[Постоянное шифрование (разработка клиентских приложений)](../../../relational-databases/security/encryption/always-encrypted-client-development.md)  
