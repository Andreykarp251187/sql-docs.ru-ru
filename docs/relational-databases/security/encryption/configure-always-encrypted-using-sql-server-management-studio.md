---
title: Настройка функции постоянного шифрования с помощью SQL Server Management Studio | Документация Майкрософт
ms.custom: ''
ms.date: 06/26/2019
ms.prod: sql
ms.reviewer: vanto
ms.technology: security
ms.topic: conceptual
f1_keywords:
- SQL13.SWB.COLUMNMASTERKEY.PAGE.F1
- SQL13.SWB.COLUMNENCRYPTIONKEY.PAGE.F1
- SQL13.SWB.COLUMNMASTERKEY.ROTATION.F1
helpviewer_keywords:
- Always Encrypted, configure with SSMS
ms.assetid: 29816a41-f105-4414-8be1-070675d62e84
author: VanMSFT
ms.author: vanto
manager: craigg
monikerRange: =azuresqldb-current||>=sql-server-2016||=sqlallproducts-allversions||>=sql-server-linux-2017||=azuresqldb-mi-current
ms.openlocfilehash: 38daa58fdb9fec3b84b8b082cde399b46a91c390
ms.sourcegitcommit: ce5770d8b91c18ba5ad031e1a96a657bde4cae55
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/25/2019
ms.locfileid: "67388022"
---
# <a name="configure-always-encrypted-using-sql-server-management-studio"></a>Configure Always Encrypted using SQL Server Management Studio (Настройка постоянного шифрования с помощью среды SQL Server Management Studio)
[!INCLUDE[appliesto-ss-asdb-xxxx-xxx-md](../../../includes/appliesto-ss-asdb-xxxx-xxx-md.md)]

В этой статье описываются задачи по использованию [среды SQL Server Management Studio (SSMS)](../../../ssms/download-sql-server-management-studio-ssms.md) для настройки постоянного шифрования и управления базами данных, использующих постоянное шифрование.

Среда SSMS, используемая для настройки постоянного шифрования, обрабатывает как ключи постоянного шифрования, так и конфиденциальные данные, поэтому ключи и данные отображаются внутри процесса SSMS в виде обычного текста. Таким образом, среду SSMS следует запускать на защищенном компьютере. Если база данных размещена на сервере SQL Server, убедитесь, что среда SSMS запущена на компьютере, отличном от компьютера с экземпляром SQL Server. Поскольку основной задачей функции постоянного шифрования является обеспечение целостности зашифрованных конфиденциальных данных даже в случае нарушения безопасности системы базы данных, выполнение скрипта PowerShell, обрабатывающего ключи или конфиденциальные данные на сервере SQL Server, может снизить или вообще отменить эффект действия функции. Дополнительные рекомендации по безопасности см. в разделе [Security Considerations for Key Management](overview-of-key-management-for-always-encrypted.md#security-considerations-for-key-management)(Вопросы безопасности для управления ключами).

Среда SSMS не поддерживает разделение ролей между теми, кто управляет базами данных (DBA), и теми, кто управляет криптографическими секретами и имеет доступ к данным с открытым текстом (администраторы безопасности и (или) администраторы приложений). Если в организации действует разделение ролей, для настройки постоянного шифрования следует использовать PowerShell. Дополнительные сведения см. в разделах [Overview of Key Management for Always Encrypted](../../../relational-databases/security/encryption/overview-of-key-management-for-always-encrypted.md) (Общие сведения об управлении ключами для Always Encrypted) и [Configure Always Encrypted using PowerShell](../../../relational-databases/security/encryption/configure-always-encrypted-using-powershell.md)(Настройка Always Encrypted с помощью PowerShell).

## <a name="configuring-always-encrypted-using-the-always-encrypted-wizard"></a>Настройка постоянного шифрования с помощью мастера постоянного шифрования

[Мастер постоянного шифрования](../../../relational-databases/security/encryption/always-encrypted-wizard.md) представляет собой мощное средство, позволяющее задать нужную конфигурацию шифрования для выбранных столбцов базы данных. В зависимости от текущей конфигурации постоянного шифрования и необходимой целевой конфигурации мастер может зашифровать столбец, расшифровать его (снять шифрование) или зашифровать его повторно (например, с помощью нового ключа шифрования столбца или типа шифрования, который отличается от текущего типа, настроенного для столбца). В рамках одного запуска мастера можно настроить несколько столбцов.

Если ключи для Always Encrypted не подготовлены, мастер создаст их автоматически. Нужно лишь выбрать хранилище ключей для главного ключа столбца: хранилище сертификатов Windows или Azure Key Vault. Мастер автоматически создаст имена для ключей и их объекты метаданных в базе данных. Если вам требуется больший контроль над процессом подготовки ключей (и дополнительные варианты хранилищ ключей, содержащих главный ключ столбца), можно воспользоваться диалоговыми окнами **Новый главный ключ столбца** и **Новый ключ шифрования столбца** (описываются далее) и подготовить ключи до запуска мастера. Затем вы сможете выбрать существующий ключ шифрования столбца в мастере постоянного шифрования.

Подробные сведения об использовании мастера см. в разделе  [Мастер постоянного шифрования](../../../relational-databases/security/encryption/always-encrypted-wizard.md).

## <a name="querying-encrypted-columns"></a>Отправка запросов в зашифрованные столбцы

В этом разделе описаны следующие процессы:   
-   извлечение значений зашифрованных данных, хранящихся в зашифрованных столбцах;   
-   извлечение значений открытого текста, хранящихся в зашифрованных столбцах;   
-   отправка значений открытого текста, предназначенных для зашифрованных столбцов (например, в инструкциях `INSERT` или `UPDATE` и в инструкциях `SELECT` в виде параметра поиска в предложениях `WHERE`).

### <a name="retrieving-ciphertext-values-stored-in-encrypted-columns"></a>Извлечение зашифрованных данных, хранящихся в зашифрованных столбцах    

Чтобы извлечь значения зашифрованных данных из зашифрованного столбца, не расшифровывая их, сделайте следующее:
1.  Отключите функцию Always Encrypted, применяемую для подключения к базе данных, в окне редактора запросов, где выполняется запрос `SELECT`. См. раздел [Включение и отключение функции Always Encrypted, применяемой для подключения к базе данных](#en-dis) ниже.      
2.  Выполните запрос `SELECT` . Любые данные, полученные из зашифрованных столбцов, возвращаются в виде двоичных (зашифрованных) значений.   

*Пример*   
Предположим, что `SSN` — это зашифрованный столбец в таблице `Patients` . В этом случае если функция Always Encrypted, применяемая для подключения к базе данных, отключена, то выполнив приведенный ниже запрос, вы получите двоичные значения зашифрованных данных.   

![always-encrypted-ciphertext](../../../relational-databases/security/encryption/media/always-encrypted-ciphertext.png)
 
### <a name="retrieving-plaintext-values-stored-in-encrypted-columns"></a>Извлечение значений открытого текста, хранящихся в зашифрованных столбцах    

Чтобы извлечь значения открытого текста из зашифрованного столбца (а затем расшифровать их), сделайте следующее:   
1.  Включите функцию Always Encrypted, применяемую для подключения к базе данных, в окне редактора запросов, где выполняется запрос `SELECT`. Это позволит поставщику данных .NET Framework для SQL Server (используемому в среде SSMS) расшифровывать данные, полученные из зашифрованных столбцов. См. раздел [Включение и отключение функции Always Encrypted, применяемой для подключения к базе данных](#en-dis) ниже.
2.  Убедитесь в наличии доступа ко всем главным ключам, настроенным для зашифрованных столбцов. Например, если в качестве главного ключа столбца используется сертификат, он должен быть развернут на компьютере, где запущена среда SSMS. Но если же это ключ из хранилища ключей Azure, вам потребуются разрешения на доступ к нему. (Возможно, вам нужно будет войти в Azure.)
3.  Выполните запрос `SELECT` . Любые данные, полученные из зашифрованных столбцов, возвращаются в виде значений открытого текста в формате исходных данных.   

*Пример*   
Предположим, что SSN — это зашифрованный столбец `char(11)` в таблице `Patients` . В этом случае, если функция Always Encrypted, применяемая для подключения к базе данных, включена, и при этом у вас есть доступ к главному ключу, настроенному для столбца `SSN` , приведенный ниже запрос вернет значения открытого текста.   

![always-encrypted-plaintext](../../../relational-databases/security/encryption/media/always-encrypted-plaintext.png)
 
### <a name="sending-plaintext-values-targeting-encrypted-columns"></a>Отправка значений открытого текста, предназначенных для зашифрованных столбцов       

Чтобы выполнить запрос на отправку значения в зашифрованный столбец, например запрос на вставку, обновление или фильтрацию значений, хранящихся в зашифрованном столбце, сделайте следующее:

1. Включите функцию Always Encrypted, применяемую для подключения к базе данных, в окне редактора запросов, где выполняется запрос `SELECT`. Это позволит поставщику данных .NET Framework для SQL Server (используемому в среде SSMS) зашифровать параметризованные переменные Transact-SQL (см. ниже), предназначенные для зашифрованных столбцов. См. раздел [Включение и отключение функции Always Encrypted, применяемой для подключения к базе данных](#en-dis) ниже.
2. Убедитесь в наличии доступа ко всем главным ключам, настроенным для зашифрованных столбцов. Например, если в качестве главного ключа столбца используется сертификат, он должен быть развернут на компьютере, где запущена среда SSMS. Но если же это ключ из хранилища ключей Azure, вам потребуются разрешения на доступ к нему. (Возможно, вам нужно будет войти в Azure.)
3. Включите параметризацию для Always Encrypted в окне редактора запросов. (Требуются службы SSMS версии не ниже 17.0.) Объявите переменную Transact-SQL и инициализируйте ее, используя значение, которое нужно отправить (вставить, обновить или использовать для фильтрации) в базу данных. Дополнительные сведения см. в разделе [Параметризация для Always Encrypted](#param) ниже.

   > [!NOTE]
   > Функция Always Encrypted поддерживает ограниченное подмножество преобразований типов, поэтому во многих случаях необходимо, чтобы тип данных в переменной Transact-SQL совпадал с типом целевого столбца базы данных, для которого она применяется.

4. Выполните запрос, чтобы отправить значение переменной Transact-SQL в базу данных. SQL Server Management Studio преобразует эту переменную в параметр запроса, значение которого шифруется перед отправкой в базу данных.   

*Пример* Предположим, что `SSN` — это зашифрованный столбец `char(11)` в таблице `Patients`. Тогда если функция Always Encrypted, применяемая для подключения к базе данных, включена, в окне редактора запросов включена параметризация для Always Encrypted и при этом у вас есть доступ к главному ключу, настроенному для столбца `'795-73-9838'`, то приведенный ниже скрипт выполнит попытку найти строку, содержащую значение `LastName` в столбце SSN, и вернет значение столбца `SSN`.   

![always-encrypted-patients](../../../relational-databases/security/encryption/media/always-encrypted-patients.png)

### <a name="en-dis"></a> Включение и отключение функции Always Encrypted, применяемой для подключения к базе данных   

После включения функции Always Encrypted, применяемой для подключения к базе данных, поставщик данных .NET Framework для SQL Server, используемый в SQL Server Management Studio, получает установку на прозрачное выполнение следующих действий:   
-   расшифровка любых значений, полученных из зашифрованных столбцов и возращенных в результатах запроса;   
-   шифрование значений параметризованных переменных Transact-SQL, предназначенных для зашифрованных столбцов базы данных.   
Чтобы включить функцию Always Encrypted, применяемую для подключения к базе данных, в диалоговом окне `Column Encryption Setting=Enabled` Соединение с сервером **на вкладке** Дополнительные свойства **укажите параметр** .    
Для отключения этой функции в диалоговом окне **Соединение с сервером** на вкладке **Дополнительные свойства** укажите параметр `Column Encryption Setting=Disabled` или же удалите значение **параметра шифрования столбца** (по умолчанию используется значение **Отключено**).   

> [!TIP]
> Чтобы включить или отключить функцию Always Encrypted в текущем окне редактора запросов, сделайте следующее:   
> 1.    Щелкните правой кнопкой мыши в любом месте окна редактора запросов.
> 2.    Выберите **Подключение** > **Изменить подключение**. 
> 3.    Щелкните **Параметры**.
> 4.    Откройте вкладку **Дополнительные свойства** и добавьте параметр `Column Encryption Setting=Enabled`, чтобы включить функцию Always Encrypted, или удалите параметр, чтобы отключить ее.   
> 5.    Нажмите кнопку **Соединить**.   
   
### <a name="param"></a>Параметризация для Always Encrypted   
 
Параметризация для Always Encrypted — это функция в SQL Server Management Studio, которая автоматически преобразует переменные Transact-SQL в параметры запросов (экземпляры [класса SqlParameter](https://msdn.microsoft.com/library/system.data.sqlclient.sqlparameter.aspx)). (Требуются службы SSMS версии не ниже 17.0.) Это позволяет основному поставщику данных .NET Framework для SQL Server определять данные, предназначенные для зашифрованных столбцов, и шифровать эти данные перед отправкой в базу данных. 
  
Без параметризации поставщик данных .NET Framework передает все инструкции, созданные в редакторе запросов, в виде непараметризованных запросов. Если запрос содержит литералы или переменные Transact-SQL, предназначенные для зашифрованных столбцов, поставщик данных .NET Framework для SQL Server не сможет определить и зашифровать их перед отправкой запроса в базу данных. В результате этого из-за несоответствия типов (между переменной Transact-SQ литерала открытого текста и зашифрованным столбцом) запрос завершится сбоем. Например, если столбец `SSN` зашифрован, без параметризации следующий запрос завершится сбоем.   

```sql
DECLARE @SSN NCHAR(11) = '795-73-9838'
SELECT * FROM [dbo].[Patients]
WHERE [SSN] = @SSN
```

#### <a name="enablingdisabling-parameterization-for-always-encrypted"></a>Включение и отключение параметризации для Always Encrypted

По умолчанию параметризация для Always Encrypted отключена.

Чтобы включить или отключить параметризацию для Always Encrypted в текущем окне редактора запросов, выполните следующие действия:

1. В главном меню выберите **Запрос** .
2. Щелкните **Параметры запроса**.
3. Выберите **Выполнение** > **Дополнительно**.
4. Установите или снимите флажок **Включить определение параметров для Always Encrypted**.
5. Нажмите кнопку **ОК**.

Чтобы включить или отключить параметризацию для Always Encrypted в будущих окнах редактора запросов, выполните следующие действия:

1. В главном меню выберите **Средства** .
2. Выберите **Параметры**.
3. Выберите **Выполнение запроса** > **SQL Server** > **Дополнительно**.
4. Установите или снимите флажок **Включить определение параметров для Always Encrypted**.
5. Нажмите кнопку **ОК**.

При выполнении запроса в окне редактора запросов с включенной функцией Always Encrypted, применяемой для подключения к базе данных, но с отключенной параметризацией появится запрос на включение этой возможности.

> [!NOTE]
> Параметризацию для Always Encrypted можно включить только в окнах редактора запросов с включенной функцией Always Encrypted (см. раздел [Включение и отключение функции Always Encrypted, применяемой для подключения к базе данных](#en-dis)). Если эта функция отключена в окне редактора запросов, параметризация переменных Transact-SQL не выполняется.

#### <a name="how-parameterization-for-always-encrypted-works"></a>Принципы работы параметризации для Always Encrypted

Если в окне редактора запросов включена и функция Always Encrypted, применяемая для подключения к базе данных, и параметризация для Always Encrypted, SQL Server Management Studio произведет попытку параметризовать переменные Transact-SQL, соответствующие следующим требованиям.

- Эти переменные объявлены и инициализированы в одной инструкции (встроенная инициализация). Параметризация переменных, объявленных с использованием разных инструкций `SET`, не выполняется.
- Эти переменные инициализированы с использованием одного литерала. Параметризация переменных, инициализированных с использованием выражений, в том числе любых операторов и функций, не выполняется.

Ниже приведены примеры переменных, параметризация которых выполняется в SQL Server Management Studio.

```sql
DECLARE @SSN char(11) = '795-73-9838';
   
DECLARE @BirthDate date = '19990104';
DECLARE @Salary money = $30000;
```

Вот некоторые примеры переменных, параметризация которых не выполняется в SQL Server Management Studio.

```sql
DECLARE @Name nvarchar(50); --Initialization seperate from declaration
SET @Name = 'Abel';

DECLARE @StartDate date = GETDATE(); -- a function used instead of a literal

DECLARE @NewSalary money = @Salary * 1.1; -- an expression used instead of a literal
```
 
Параметризация происходит успешно в следующих случаях:   
- тип литерала, используемый для инициализации переменной, параметризация которой выполняется, должен совпадать с типом в объявлении переменной;   
- если в качестве объявленного типа переменной используется тип даты или тип времени, переменную нужно инициализировать, используя строку в одном из совместимых с ISO 8601 форматов.   

Ниже приведены примеры объявлений переменных Transact-SQL, которые приводят к ошибкам параметризации переменных.   
```sql
DECLARE @BirthDate date = '01/04/1999' -- unsupported date format   
   
DECLARE @Number int = 1.1 -- the type of the literal does not match the type of the variable   
```
SQL Server Management Studio использует технологию Intellisense, чтобы предоставлять сведения о том, для каких переменных можно определить параметры, а для каких эта операция завершится сбоем (с указанием причины).   

Объявление переменной, для которой можно определить параметры, подчеркивается линией в редакторе запросов. Если навести указатель мыши на подчеркнутую инструкцию объявления, отобразится результат параметризации, в том числе значения основных свойств результирующего объекта [SqlParameter](https://msdn.microsoft.com/library/system.data.sqlclient.sqlparameter.aspx) (с которым сопоставляется переменная): [SqlDbType](https://msdn.microsoft.com/library/system.data.sqlclient.sqlparameter.sqldbtype.aspx), [Size](https://msdn.microsoft.com/library/system.data.sqlclient.sqlparameter.size.aspx), [Precision](https://msdn.microsoft.com/library/system.data.sqlclient.sqlparameter.precision.aspx), [Scale](https://msdn.microsoft.com/library/system.data.sqlclient.sqlparameter.scale.aspx), [SqlValue](https://msdn.microsoft.com/library/system.data.sqlclient.sqlparameter.sqlvalue.aspx). Кроме того, в представлении **Список ошибок** на вкладке **Предупреждение** можно просмотреть полный список всех параметризованных переменных. Чтобы открыть представление **Список ошибок** , выберите в главном меню **Представление** , а затем щелкните **Список ошибок**.    

Если попытка определить параметры переменной в SQL Server Management Studio завершилась сбоем, объявление переменной будет помечено знаком ошибки. Если навести указатель мыши на помеченную инструкцию выражения, отобразятся результаты ошибки. Полный список ошибок параметризации для всех переменных можно просмотреть в представлении **Список ошибок** на вкладке **Ошибка** . Чтобы открыть представление **Список ошибок** , выберите в главном меню **Представление** , а затем щелкните **Список ошибок**.   

На снимке экрана ниже приведены примеры шести объявлений переменных. Параметризация первых трех переменных в SQL Server Management Studio выполнена успешно. Три последние переменные не соответствуют необходимым требованиям. Поэтому они не были параметризованы в SQL Server Management Studio (их объявления не отмечены).

![always-encrypted-parameter-warnings](../../../relational-databases/security/encryption/media/always-encrypted-parameter-warnings.png)
 
В приведенном ниже примере две переменные соответствуют требованиям, необходимым для параметризации, но этот процесс завершился сбоем, так как их инициализация выполнена неправильно.    
 
![always-encrypted-error](../../../relational-databases/security/encryption/media/always-encrypted-error.png)
 
> [!NOTE]
> Функция Always Encrypted поддерживает ограниченное подмножество преобразований типов, поэтому во многих случаях необходимо, чтобы тип данных в переменной Transact-SQL совпадал с типом целевого столбца базы данных, для которого она применяется. Например, предположим, что столбец `SSN` в таблице `Patients` — это столбец `char(11)`. В этом случае приведенный ниже запрос завершится сбоем, так как тип переменной `@SSN` ( `nchar(11)`) не совпадает с типом столбца.   

```sql
DECLARE @SSN nchar(11) = '795-73-9838'
SELECT * FROM [dbo].[Patients]
WHERE [SSN] = @SSN;
```

    Msg 402, Level 16, State 2, Line 5   
    The data types char(11) encrypted with (encryption_type = 'DETERMINISTIC', 
    encryption_algorithm_name = 'AEAD_AES_256_CBC_HMAC_SHA_256', column_encryption_key_name = 'CEK_Auto1', 
    column_encryption_key_database_name = 'Clinic') collation_name = 'Latin1_General_BIN2' 
    and nchar(11) encrypted with (encryption_type = 'DETERMINISTIC', 
    encryption_algorithm_name = 'AEAD_AES_256_CBC_HMAC_SHA_256', column_encryption_key_name = 'CEK_Auto1', 
    column_encryption_key_database_name = 'Clinic') are incompatible in the equal to operator.

> [!NOTE]
> Если параметризация отключена, весь запрос, в том числе преобразования типов, обрабатывается в SQL Server или Базе данных SQL Azure, а если эта функция включена, часть преобразований типов выполняется на платформе .NET Framework в SQL Server Management Studio. Из-за различия между типами систем .NET Framework и SQL Server (например, разная точность некоторых типов, таких как float) результаты, полученные после выполнения запроса с включенной и отключенной функцией параметризации, могут отличаться. 

#### <a name="permissions-for-querying-against-encrypted-columns"></a>Разрешения на запросы к зашифрованным столбцам

Чтобы выполнять любые запросы к зашифрованным столбцам, в том числе запросы на извлечение зашифрованных данных, в базе данных необходимо иметь разрешения `VIEW ANY COLUMN MASTER KEY DEFINITION` и `VIEW ANY COLUMN ENCRYPTION KEY DEFINITION` .

Помимо указанных выше разрешений, чтобы расшифровать любые результаты и зашифровать параметры запроса (созданные в процессе параметризации переменных Transact-SQL), также требуется доступ к главному ключу столбца, который используется для защиты целевых столбцов.

- **Хранилище сертификатов — локальный компьютер**: требуется доступ на чтение (`Read`) к сертификату, который используется в качестве главного ключа столбца, либо необходимо быть администратором компьютера.   
- **Хранилище ключей Azure** : требуются разрешения `get`, `unwrapKey`и verify к хранилищу, содержащему главный ключ столбца.
- **Поставщик хранилища ключей (KSP)**  — необходимые разрешения и учетные данные, которые могут быть запрошены при использовании хранилища ключей или ключа, зависят от конфигурации хранилища и KSP.   
- **Поставщик служб шифрования (CSP)**  — необходимые разрешения и учетные данные, которые могут быть запрошены при использовании хранилища ключей или ключа, зависят от конфигурации хранилища и CSP.

Дополнительные сведения см. в разделе [Create and Store Column Master Keys (Always Encrypted)](../../../relational-databases/security/encryption/create-and-store-column-master-keys-always-encrypted.md)(Создание и хранение главных ключей столбцов (постоянное шифрование)).

<a name="provisioncmk"></a>
## <a name="provisioning-column-master-keys-new-column-master-key"></a>Подготовка главных ключей столбцов (окно "Новый главный ключ столбца")

В диалоговом окне **Новый главный ключ столбца** можно создать главный ключ столбца или выбрать существующий ключ в хранилище ключей, а также создать метаданные главного ключа столбца для сгенерированного или выбранного ключа в базе данных.

1.  С помощью **обозревателя объектов** перейдите к папке **Безопасность > Ключи постоянного шифрования** в базе данных.
2.  Щелкните правой кнопкой мыши папку **Главные ключи столбцов** и выберите **Создать главный ключ столбца…** . 
3.  В диалоговом окне **Новый главный ключ столбца** введите имя объекта метаданных главного ключа столбца.
4.  Выберите хранилище ключей.
    - **Хранилище сертификатов — текущий пользователь** — указывает расположение хранилища сертификатов текущего пользователя в хранилище сертификатов Windows, которое является личным хранилищем. 
    - **Хранилище сертификатов — локальный компьютер** — указывает расположение хранилища сертификатов локального компьютера в хранилище сертификатов Windows. 
    - **Хранилище ключей Azure** — потребуется войти в Azure (щелкните **Вход**). Выполнив вход, можно выбрать одну из подписок Azure и хранилище ключей.
    - **Поставщик хранилища ключей (KSP)**  — указывает хранилище ключей, которое доступно через поставщик хранилища ключей (KSP), реализующий API криптографии следующего поколения (CNG). Как правило, этот тип хранилища является аппаратным модулем безопасности (HSM). После выбора этого параметра необходимо выбрать поставщик KSP. По умолчанию выбран**поставщик хранилища ключей Microsoft Software Key Store Provider** . Чтобы использовать главный ключ столбца, хранящийся в HSM, выберите KSP для устройства (он должен быть установлен и настроен на компьютере до открытия диалогового окна).
    -   **Поставщик служб шифрования (CSP)**  — хранилище ключей, доступное через поставщик служб шифрования (CSP), который реализует Cryptography API (CAPI). Как правило, это хранилище является аппаратным модулем безопасности (HSM). После выбора этого параметра необходимо выбрать поставщик CSP.  Чтобы использовать главный ключ столбца, хранящийся в HSM, выберите CSP для устройства (он должен быть установлен и настроен на компьютере до открытия диалогового окна).
    
    > [!NOTE]
    > Так как CAPI — это устаревший API, параметр "Поставщик служб шифрования" отключен по умолчанию. Его можно включить, создав значение CAPI Provider Enabled DWORD в разделе **[HKEY_CURRENT_USER\Software\Microsoft\Microsoft SQL Server\sql13\Tools\Client\Always Encrypted]** реестра Windows и установив для него 1. Если хранилище ключей не поддерживает CNG, вместо CAPI следует использовать CNG.
   
    Дополнительные сведения о хранилищах ключей см. в разделе [Create and Store Column Master Keys (Always Encrypted)](../../../relational-databases/security/encryption/create-and-store-column-master-keys-always-encrypted.md)(Создание и хранение главных ключей столбцов (постоянное шифрование)).

5.  Выберите существующий ключ в хранилище ключей либо нажмите кнопку **Создать ключ** или **Создать сертификат** , чтобы создать ключ в хранилище ключей. 
6.  Нажмите кнопку **ОК** , и новый ключ появится в списке. 

Среда SQL Server Management Studio создаст метаданные для главного ключа столбца в базе данных. Для выполнения этой задачи в диалоговом окне создается и запускается инструкция [CREATE COLUMN MASTER KEY (Transact-SQL)](../../../t-sql/statements/create-column-master-key-transact-sql.md) .


<a name="provisioncek"></a> 
## <a name="provisioning-column-encryption-keys-new-column-encryption-key"></a>Подготовка ключей шифрования столбцов (окно "Новый ключ шифрования столбца")

В диалоговом окне **Ключ шифрования нового столбца** можно создать ключ шифрования столбца, зашифровать его с помощью главного ключа столбца, а также создать метаданные ключа шифрования столбца в базе данных.

1.  С помощью **обозревателя объектов**перейдите к папке **Безопасность &gt; Ключи постоянного шифрования** в базе данных.
2.  Щелкните правой кнопкой мыши папку **Ключи шифрования столбцов** и выберите **Создать ключ шифрования столбца...** 
3.  В диалоговом окне **Новый ключ шифрования столбца** введите имя объекта метаданных ключа шифрования столбца.
4.  Выберите объект метаданных, который представляет ваш главный ключ столбца в базе данных.
5.  Нажмите кнопку **ОК**. 


Среда SQL Server Management Studio создаст ключ шифрования столбца, а затем извлечет метаданные для главного ключа столбца, выбранного в базе данных. После этого среда SQL Server Management Studio с помощью метаданных главного ключа столбца получит доступ в хранилище ключей, содержащее ваш главный ключ столбца, и зашифрует ключ шифрования столбца. И, наконец, в базе данных будут созданы метаданные для нового ключа шифрования столбца. Для выполнения этой задачи в диалоговом окне создается и запускается инструкция [CREATE COLUMN ENCRYPTION KEY (Transact-SQL)](../../../t-sql/statements/create-column-encryption-key-transact-sql.md) .

### <a name="permissions-for-provisioning-a-column-encryption-key"></a>Разрешения на подготовку ключа шифрования столбца

Для создания метаданных ключа шифрования столбца и для доступа к метаданным главного ключа столбца необходимы разрешения *ALTER ANY ENCRYPTION MASTER KEY* и *VIEW ANY COLUMN MASTER KEY DEFINITION* для базы данных.
Чтобы получить доступ к хранилищу ключей и использовать главный ключ столбца, вам могут потребоваться указанные далее разрешения для хранилища ключей и (или) ключа.
- **Хранилище сертификатов — локальный компьютер** — требуется доступ на чтение к сертификату, который используется в качестве главного ключа столбца, либо необходимо быть администратором компьютера.
- **Хранилище ключей Azure** — требуются разрешения *get*, *unwrapKey*, *wrapKey*, *sign* и *verify* к хранилищу, содержащему главный ключ столбца.
- **Поставщик хранилища ключей (CNG)** — необходимые разрешения и учетные данные, которые могут быть запрошены при использовании хранилища ключей или ключа, зависят от конфигурации хранилища и KSP.
- **Поставщик служб шифрования (CAPI)** — необходимые разрешения и учетные данные, которые могут быть запрошены при использовании хранилища ключей или ключа, зависят от конфигурации хранилища и CSP.

Дополнительные сведения см. в разделе [Create and Store Column Master Keys (Always Encrypted)](../../../relational-databases/security/encryption/create-and-store-column-master-keys-always-encrypted.md)(Создание и хранение главных ключей столбцов (постоянное шифрование)).

<a name="rotatecmk"></a>
## <a name="rotating-column-master-keys"></a>Смена главных ключей столбцов

Смена главного ключа столбца — это процесс замены существующего главного ключа столбца новым главным ключом столбца. Смена ключа может потребоваться в случае его компрометации или для обеспечения соответствия политикам или нормам организации, предусматривающим регулярную смену ключей шифрования. Процедура смены главного ключа столбца включает в себя действия по расшифровке ключей шифрования столбцов, которые защищены с помощью текущего главного ключа столбца, их повторному шифрованию с помощью нового главного ключа столбца и обновлению метаданных ключа. Дополнительные сведения см. в разделе [Overview of Key Management for Always Encrypted](../../../relational-databases/security/encryption/overview-of-key-management-for-always-encrypted.md)(Общие сведения об управлении ключами для постоянного шифрования).

**Шаг 1. Подготовка нового главного ключа столбца**

Подготовьте новый главный ключ столбца, выполнив действия, описанные в подразделе "Подготовка главных ключей столбцов" выше.

**Шаг 2. Шифрование ключей шифрования столбцов с помощью нового главного ключа столбца**

Как правило, главный ключ столбца защищает один или несколько ключей шифрования столбцов. Каждый ключ шифрования столбца имеет зашифрованное значение, хранящееся в базе данных, которое является результатом шифрования ключа шифрования столбца с помощью главного ключа столбца.
На этом шаге необходимо зашифровать все ключи шифрования столбцов, защищенные заменяемым главным ключом столбца, с помощью нового главного ключа столбца и сохранить новое зашифрованное значение в базе данных. В результате каждый ключ шифрования столбца, затрагиваемый сменой, будет иметь два зашифрованных значения: одно значение, зашифрованное существующим главным ключом столбца, и новое значение, зашифрованное новым главным ключом столбца.

1.  В **обозревателе объектов** перейдите к папке **Безопасность > Ключи Always Encrypted > Главные ключи столбцов** и найдите главный ключ столбца, который нужно сменить.
2.  Щелкните правой кнопкой мыши этот главный ключ столбца и выберите **Сменить**.
3.  В диалоговом окне **Смена главного ключа столбца** выберите имя нового главного ключа столбца, созданного на шаге 1, в поле **Целевой объект** .
4.  Просмотрите список ключей шифрования столбца, защищенных существующими главными ключами столбца. Эти ключи будут затронуты сменой.
5.  Нажмите кнопку **ОК**.

Среда SQL Server Management Studio получит метаданные ключей шифрования столбцов, защищенных с помощью старого главного ключа столбца, и метаданные старого и нового главных ключей столбцов. Затем среда SSMS с помощью метаданных главного ключа столбца получит доступ к хранилищу ключей, содержащему старый главный ключа столбца, и расшифрует ключи шифрования столбцов. После этого среда SSMS обратится в хранилище ключей, содержащее новый главный ключ столбца, чтобы создать набор зашифрованных значений ключей шифрования столбцов. Затем среда добавит новые значения в метаданные (создав и выполнив инструкции [ALTER COLUMN ENCRYPTION KEY (Transact-SQL)](../../../t-sql/statements/alter-column-encryption-key-transact-sql.md) ).

> [!NOTE]
> Убедитесь, что каждый ключ шифрования столбца, зашифрованный старым главным ключом столбца, не зашифрован с помощью какого-либо другого главного ключа столбца. Другими словами, каждый ключ шифрования столбца, затрагиваемый сменой, должен иметь ровно одно зашифрованное значение в базе данных. Если какой-либо из затрагиваемых ключей шифрования столбца имеет несколько зашифрованных значений, необходимо удалить лишние значения, прежде чем продолжать смену (см. *шаг 4* по удалению зашифрованного значения ключа шифрования столбца).

**Шаг 3. Настройка приложений с помощью нового главного ключа столбца**

На этом шаге необходимо убедиться, что все клиентские приложения, запрашивающие столбцы базы данных и защищенные с помощью главного ключа столбца, который планируется сменить (то есть столбцы базы данных зашифрованы с помощью ключа шифрования столбца, который зашифрован заменяемым главным ключом столбца), имеют доступ к новому главному ключу столбца. Этот шаг зависит от типа хранилища ключей, используемого для хранения нового главного ключа столбца. Пример:

- Если новый главный ключ столбца является сертификатом из хранилища сертификатов Windows, необходимо развернуть этот сертификат в том же расположении хранилища сертификатов (*текущего пользователя* или *локального компьютера*), которое указано в пути к главному ключу столбца в базе данных. Приложение должно иметь доступ к этому сертификату:
  - Если сертификат хранится в расположении хранилища сертификатов *текущего пользователя*, сертификат необходимо импортировать в хранилище текущего пользователя удостоверения Windows приложения.
  - Если сертификат хранится в расположении хранилища сертификатов *локального компьютера*, удостоверение Windows приложения должно иметь разрешение на доступ к этому сертификату.
- Если новый главный ключ столбца хранится в хранилище ключей Microsoft Azure, приложение должно быть реализовано так, чтобы оно могло пройти проверку подлинности в Azure и имело разрешение на доступ к ключу.

Дополнительные сведения см. в разделе [Create and Store Column Master Keys (Always Encrypted)](../../../relational-databases/security/encryption/create-and-store-column-master-keys-always-encrypted.md)(Создание и хранение главных ключей столбцов (постоянное шифрование)).

> [!NOTE]
> На этом этапе процедуры смены и старый, и новый главные ключи столбца являются действительными и могут использоваться для доступа к данным.

**Шаг 4. Очистка значений ключа шифрования столбца, зашифрованных с помощью старого главного ключа столбца**

После настройки использования нового главного ключа столбца во всех приложениях удалите из базы данных значения ключей шифрования столбца, зашифрованные с помощью *старого* главного ключа столбца. После удаления старых значений все будет готово к новой смене (учитывайте, что для смены главного ключа столбца каждый ключ шифрования столбца, защищенный с помощью главного ключа столбца, должен иметь ровно одно зашифрованное значение).

Еще одна причина для очистки старого значения до архивации или удаления старого главного ключа связана с производительностью: при запросе зашифрованного столбца драйвер клиента с поддержкой постоянного шифрования может попытаться расшифровать два значения — старое и новое. У драйвера нет сведения о том, какой из двух главных ключей столбца является действительным в среде приложения. Поэтому драйвер будет извлекать оба зашифрованных значения с сервера. Если одно из значений не удается расшифровать, так как оно защищено недоступным главным ключом столбца (например, это старый главный ключ столбца, который был удален из хранилища), драйвер будет пытаться расшифровать другое значение с помощью нового главного ключа столбца.

> [!WARNING]
> Если удалить значение ключа шифрования столбца до того, как его соответствующий главный ключ столбца станет доступным для приложения, это приложение больше не сможет расшифровывать столбец базы данных.

1.  В **обозревателе объектов** перейдите в папку **Безопасность>Ключи постоянного шифрования** и найдите главный ключ столбца, который требуется сменить.
2.  Щелкните правой кнопкой мыши существующий главный ключ столбца и выберите **Очистить**.
3.  Просмотрите список значений ключей шифрования столбцов для удаления.
4.  Нажмите кнопку **ОК**.

Среда SQL Server Management Studio выполнит инструкции [ALTER COLUMN ENCRYPTION KEY (Transact-SQL)](../../../t-sql/statements/alter-column-encryption-key-transact-sql.md) для удаления зашифрованных значений ключей шифрования столбцов, которые зашифрованы с помощью старого главного ключа столбца.

**Шаг 5. Удаление метаданных для старого главного ключа столбца**

Если вы решили удалить определение старого главного ключа столбца из базы данных, выполните действия, описанные ниже.

1. В **обозревателе объектов** перейдите в папку **Безопасность>Ключи постоянного шифрования>Главные ключи столбцов** и найдите старый главный ключ столбца, который требуется удалить из базы данных.
2. Щелкните правой кнопкой мыши старый главный ключ столбца и выберите **Удалить**. (Будет создана и выполнена инструкция [DROP COLUMN MASTER KEY (Transact-SQL)](../../../t-sql/statements/drop-column-master-key-transact-sql.md) для удаления метаданных главного ключа столбца.)
3. Нажмите кнопку **ОК**.

> [!NOTE]
> Настоятельно рекомендуется не удалять старый главный ключ столбца после смены без возможности восстановления. Старый главный ключ столбца следует сохранить в его текущем хранилище ключей или скопировать в другое надежное место. Старый ключ потребуется при восстановлении базы данных из файла резервной копии на момент времени, предшествующий настройке нового главного ключа столбца.

### <a name="permissions-for-rotating-column-master-key"></a>Разрешения на смену главных ключей столбцов

Для смены главного ключа столбца необходимы указанные далее разрешения базы данных.

- **ALTER ANY COLUMN MASTER KEY** — требуется для создания метаданных для нового главного ключа столбца и удаления метаданных для старого главного ключа столбца.
- **ALTER ANY COLUMN ENCRYPTION KEY** — требуется для изменения метаданных ключа шифрования столбца (для добавления новых зашифрованных значений).
- **VIEW ANY COLUMN MASTER KEY DEFINITION** — требуется для доступа к метаданным главных ключей столбцов и их чтения.
- **VIEW ANY COLUMN ENCRYPTION KEY DEFINITION** — требуется для доступа к метаданным ключей шифрования столбцов и их чтения. 

Необходимо также иметь доступ к старому и новому главным ключам столбцов в их хранилищах. Чтобы получить доступ к хранилищу ключей и использовать главный ключ столбца, вам могут потребоваться указанные далее разрешения для хранилища ключей и (или) ключа.
- **Хранилище сертификатов — локальный компьютер** — требуется доступ на чтение к сертификату, который используется в качестве главного ключа столбца, либо необходимо быть администратором компьютера.
- **Хранилище ключей Azure** — требуются разрешения *create*, *get*, *unwrapKey*, *wrapKey*, *sign*и *verify* к хранилищу, содержащему главный ключ столбца.
- **Поставщик хранилища ключей (CNG)** — необходимые разрешения и учетные данные, которые могут быть запрошены при использовании хранилища ключей или ключа, зависят от конфигурации хранилища и KSP.
- **Поставщик служб шифрования (CAPI)** — необходимые разрешения и учетные данные, которые могут быть запрошены при использовании хранилища ключей или ключа, зависят от конфигурации хранилища и CSP.

Дополнительные сведения см. в разделе [Create and Store Column Master Keys (Always Encrypted)](../../../relational-databases/security/encryption/create-and-store-column-master-keys-always-encrypted.md)(Создание и хранение главных ключей столбцов (постоянное шифрование)).

<a name="rotatecek"></a> 
## <a name="rotating-column-encryption-keys"></a>Смена ключей шифрования столбцов

Процедура смены ключа шифрования столбца включает в себя действия по расшифровке данных во всех столбцах, которые зашифрованы с помощью подлежащего смене ключа, и повторному шифрованию данных с помощью нового ключа шифрования столбца.

>[!NOTE]
> Смена ключа шифрования столбца может занимать очень много времени, если размер таблиц, содержащих столбцы, зашифрованные с помощью заменяемого ключа, слишком велик. Во время повторного шифрования данных приложения не смогут выполнять запись в затрагиваемые таблицы. Поэтому организации необходимо очень тщательно спланировать процесс смены ключа шифрования столбца.
Для смены ключа шифрования столбца используется мастер постоянного шифрования.

1.  Откройте мастер в базе данных. Для этого щелкните правой кнопкой мыши базу данных, наведите курсор на пункт **Задачи**, а затем щелкните **Зашифровать столбцы**.
2.  Прочитайте страницу **Введение** , а затем нажмите кнопку **Далее**.
3.  На странице **Выбор столбцов** разверните таблицы и найдите все подлежащие замене столбцы, которые зашифрованы с помощью старого ключа шифрования столбца.
4.  Для каждого такого столбца задайте в качестве значения **ключа шифрования** новый автоматически созданный ключ. **Примечание.** Можно создать ключ шифрования столбца перед запуском мастера — см. подраздел *Подготовка ключей шифрования столбцов* выше.
5.  На странице **Конфигурация главного ключа** выберите расположение для сохранения нового ключа и источник главного ключа, а затем нажмите кнопку **Далее**. **Примечание.** При использовании существующего ключа шифрования столбца (не созданного автоматически) на этой странице ничего делать не нужно.
6.  На странице **Проверка**выберите, требуется ли немедленно запустить сценарий, или создайте сценарий PowerShell и нажмите кнопку **Далее**.
7.  На странице **Сводка** просмотрите выбранные параметры и нажмите кнопку **Готово**, чтобы закрыть мастер.
8.  В **обозревателе объектов**перейдите в папку **Безопасность/Ключи постоянного шифрования/Ключи шифрования столбцов** и найдите старый ключ шифрования столбца, который требуется удалить из базы данных. Щелкните ключ правой кнопкой мыши и выберите команду **Удалить**.

### <a name="permissions-for-rotating-column-encryption-keys"></a>Разрешения на смену ключей шифрования столбцов

Для смены ключа шифрования столбца необходимы указанные далее разрешения базы данных. **ALTER ANY COLUMN MASTER KEY** — требуется при использовании нового автоматически созданного ключа шифрования столбца (также будут созданы главный ключ столбца и его новые метаданные).
**ALTER ANY COLUMN ENCRYPTION KEY** — требуется для добавления метаданных для нового ключа шифрования столбца.
**VIEW ANY COLUMN MASTER KEY DEFINITION** — требуется для доступа к метаданным главных ключей столбцов и их чтения.
**VIEW ANY COLUMN ENCRYPTION KEY DEFINITION** — требуется для доступа к метаданным ключей шифрования столбцов и их чтения.

Необходимо также иметь доступ к главным ключам столбцов для старого и нового ключей шифрования столбцов. Чтобы получить доступ к хранилищу ключей и использовать главный ключ столбца, вам могут потребоваться указанные далее разрешения для хранилища ключей и (или) ключа.
- **Хранилище сертификатов — локальный компьютер** — требуется доступ на чтение к сертификату, который используется в качестве главного ключа столбца, либо необходимо быть администратором компьютера.
- **Хранилище ключей Azure** — требуются разрешения get, unwrapKey и verify к хранилищу, содержащему главный ключ столбца.
- **Поставщик хранилища ключей (CNG)** — необходимые разрешения и учетные данные, которые могут быть запрошены при использовании хранилища ключей или ключа, зависят от конфигурации хранилища и KSP.
- **Поставщик служб шифрования (CAPI)** — необходимые разрешения и учетные данные, которые могут быть запрошены при использовании хранилища ключей или ключа, зависят от конфигурации хранилища и CSP.

Дополнительные сведения см. в разделе [Create and Store Column Master Keys (Always Encrypted)](../../../relational-databases/security/encryption/create-and-store-column-master-keys-always-encrypted.md)(Создание и хранение главных ключей столбцов (постоянное шифрование)).

## <a name="performing-dac-upgrade-operations-when-database-or-dacpac-uses-always-encrypted"></a>Выполнение операций обновления DAC, когда база данных или пакет DAC использует постоянное шифрование

[Операции DAC](../../data-tier-applications/data-tier-applications.md) поддерживаются в базах данных и DACPAC-файлах со схемами, содержащими зашифрованные столбцы. К операции обновления DAC применяются особые требования — сведения о выполнении операции обновления приложения уровня данных в различных средствах, включая среду SSMS, см. в разделе [Обновление приложения уровня данных](../../../relational-databases/data-tier-applications/upgrade-a-data-tier-application.md). 

Если при обновлении базы данных с помощью DACPAC в этом файле или целевой базе данных имеются зашифрованные столбцы, операция обновления запустит операцию шифрования данных в случае выполнения всех указанных ниже условий.
- База данных содержит столбец с данными.
- Такой же столбец существует в DACPAC.
- Конфигурация шифрования столбца в базе данных отличается от конфигурации соответствующего столбца в DACPAC. Подробные сведения приведены в представленной ниже таблице.

| Условие|Действие|
|:---|:---|
|Столбец зашифрован в DACPAC и не зашифрован в базе данных.| Данные в столбце не будут зашифрованы.|
|Столбец зашифрован в DACPAC и не зашифрован в базе данных.| Данные в столбце будут расшифрованы (для столбца будет отменено шифрование).|
| Столбец зашифрован в DACPAC и базе данных, но столбец в DACPAC использует другой тип шифрования и (или) другой ключ шифрования столбца, чем соответствующий столбец в базе данных.|Данные в столбце будет расшифрованы и повторно зашифрованы в соответствии с конфигурацией шифрования в DACPAC.|

> [!NOTE]
> Если главный ключ столбца, настроенный для столбца в базе данных или DACPAC, хранится в хранилище ключей Azure, вам будет предложено войти в Azure (если это еще не сделано).

### <a name="permissions-for-dac-upgrade-if-always-encrypted-is-set-up"></a>Разрешения на обновление DAC, если настроена функция Always Encrypted

Для выполнения операции обновления DAC в случае, если функция Always Encrypted настроена в DACPAC или целевой базе данных, могут потребоваться некоторые или все перечисленные ниже разрешения, которые зависят от различий между схемой в DACPAC и схемой целевой базы данных.

*ALTER ANY COLUMN MASTER KEY*, *ALTER ANY COLUMN ENCRYPTION KEY*, *VIEW ANY COLUMN MASTER KEY DEFINITION*, *VIEW ANY COLUMN ENCRYPTION KEY DEFINITION*

Если операция обновления запускает операцию шифрования данных, также необходим доступ к главным ключам столбцов, настроенным для затрагиваемых столбцов.

- **Хранилище сертификатов — локальный компьютер** — требуется доступ на чтение к сертификату, который используется в качестве главного ключа столбца, либо необходимо быть администратором компьютера.
- **Хранилище ключей Azure** — требуются разрешения *create*, *get*, *unwrapKey*, *wrapKey*, *sign*и *verify* к хранилищу, содержащему главный ключ столбца.
- **Поставщик хранилища ключей (CNG)** — необходимые разрешения и учетные данные, которые могут быть запрошены при использовании хранилища ключей или ключа, зависят от конфигурации хранилища и KSP.
- **Поставщик служб шифрования (CAPI)** — необходимые разрешения и учетные данные, которые могут быть запрошены при использовании хранилища ключей или ключа, зависят от конфигурации хранилища и CSP.

Дополнительные сведения см. в разделе [Create and Store Column Master Keys (Always Encrypted)](../../../relational-databases/security/encryption/create-and-store-column-master-keys-always-encrypted.md)(Создание и хранение главных ключей столбцов (постоянное шифрование)).

## <a name="migrating-databases-with-encrypted-columns-using-bacpac"></a>Перенос баз данных с зашифрованными столбцами с помощью BACPAC

При экспорте базы данных все данные, хранящиеся в зашифрованных столбцах, извлекаются и помещаются в итоговый файл [BACPAC](../../data-tier-applications/data-tier-applications.md) (в зашифрованном виде). Итоговый BACPAC также содержит метаданные для ключей постоянного шифрования.

При импорте BACPAC в базу данных зашифрованные данные из BACPAC загружаются в базу данных и происходит повторное создание метаданных ключа постоянного шифрования.

Если ваше приложение настроено для изменения или получения зашифрованных данных, хранящихся в исходной базе данных (экспортированной), не требуется выполнять никаких особых действий, чтобы позволить приложению запрашивать зашифрованные данные в целевой базе данных, так как ключи в обеих базах данных идентичны.

### <a name="permissions-for-migrating-databases-with-encrypted-columns"></a>Разрешения на перенос баз данных с зашифрованными столбцами

Требуются разрешения *ALTER ANY COLUMN MASTER KEY* и *ALTER ANY COLUMN ENCRYPTION KEY* для базы данных-источника. Требуются разрешения *ALTER ANY COLUMN MASTER KEY*, *ALTER ANY COLUMN ENCRYPTION KEY*, *VIEW ANY COLUMN MASTER KEY DEFINITION*и *VIEW ANY COLUMN ENCRYPTION KEY DEFINITION* для целевой базы данных.

## <a name="migrating-databases-with-encrypted-columns-using-sql-server-import-and-export-wizard"></a>Перенос баз данных с зашифрованными столбцами с помощью мастера экспорта и импорта SQL Server

По сравнению с использованием BACPAC-файлов [мастер импорта и экспорта SQL Server](~/integration-services/import-export-data/import-and-export-data-with-the-sql-server-import-and-export-wizard.md) позволяет более полно контролировать способ обработки данных, хранящихся в зашифрованных столбцах, во время переноса данных.

- Если источником данных является база данных с постоянным шифрованием, подключение к источнику данных можно настроить так, чтобы данные, хранящиеся в зашифрованных столбцах, расшифровывались во время операции экспорта или оставались зашифрованными.
- Если целевым объектом данных является база данных с постоянным шифрованием, подключение к целевому объекту можно настроить так, чтобы предназначенные для зашифрованных столбцов данные шифровались.

Чтобы включить шифрование (для целевого объекта данных) или расшифровку (для источника данных), необходимо настроить подключение целевого объекта данных или источника данных для использования [поставщика данных .Net Framework для SQL Server](https://msdn.microsoft.com/library/system.data.sqlclient.aspx) и задать для ключевых слов строки подключения "Параметр шифрования столбца" значение *Включено*.

В следующей таблице приведены возможные варианты миграции и их связь с постоянным шифрованием, а также конфигурация исходных и целевых данных для каждого подключения.

| Сценарий|Конфигурация исходного подключения| Конфигурация целевого подключения
|:---|:---|:---
|Шифрование данных для миграции (данные хранятся в виде открытого текста в источнике данных и переносятся в зашифрованные столбцы в целевой базе данных).| Драйвер или поставщик данных: *любой*<br><br>Параметр шифрования столбца — отключено<br><br>(если используется поставщик данных .NET Framework для SQL Server и .NET Framework 4.6 более поздней версии). | Драйвер или поставщик данных: *поставщик данных .NET Framework для SQL Server* (требуется .NET Framework 4.6 или более поздняя версия).<br><br>Параметр шифрования столбца — включено
| Расшифровка данных для миграции (данные хранятся в зашифрованных столбцах в источнике данных и переносятся в виде обычного текста в целевой объект данных; если таким объектом является база данных, целевые столбцы не шифруются).<br><br>**Примечание.** Целевые таблицы с зашифрованными столбцами должны существовать до миграции.|Драйвер или поставщик данных: *поставщик данных .NET Framework для SQL Server* (требуется .NET Framework 4.6 или более поздняя версия).<br><br>Параметр шифрования столбца — Включено|Драйвер или поставщик данных: *любой*<br><br>Параметр шифрования столбца — отключено<br><br>(если используется поставщик данных .NET Framework для SQL Server и .NET Framework 4.6 более поздней версии).
|Повторное шифрование данных для миграции (данные хранятся в зашифрованных столбцах в источнике данных и переносятся в виде обычного текста в целевой объект данных в столбцы, использующие другие типы шифрования ключей шифрования столбцов).<br><br>**Примечание.** Целевые таблицы с зашифрованными столбцами должны существовать до миграции.| Драйвер или поставщик данных: *поставщик данных .NET Framework для SQL Server* (требуется .NET Framework 4.6 или более поздняя версия).<br><br>Параметр шифрования столбца — Включено|Драйвер или поставщик данных: *поставщик данных .NET Framework для SQL Server* (требуется .NET Framework 4.6 или более поздняя версия).<br><br>Параметр шифрования столбца — Включено
|Перемещение зашифрованных данных без расшифровки.<br><br>**Примечание.** Целевые таблицы с зашифрованными столбцами должны существовать до миграции.| Драйвер или поставщик данных: *любой*<br>Параметр шифрования столбца — отключено<br><br>(если используется поставщик данных .NET Framework для SQL Server и .NET Framework 4.6 более поздней версии).| Драйвер или поставщик данных: *любой*<br>Параметр шифрования столбца — отключено<br><br>(если используется поставщик данных .NET Framework для SQL Server и .NET Framework 4.6 более поздней версии).<br><br>Параметру пользователя ALLOW_ENCRYPTED_VALUE_MODIFICATIONS должно быть задано значение ON.<br><br>Дополнительные сведения см. в разделе [Перенос конфиденциальных данных с помощью функции постоянного шифрования](../../../relational-databases/security/encryption/migrate-sensitive-data-protected-by-always-encrypted.md).

### <a name="permissions-for-database-migration-using-sql-server-import-and-export-wizard"></a>Разрешения на перенос баз данных с помощью мастера импорта и экспорта SQL Server

Чтобы **зашифровать** или **расшифровать** данные, хранящиеся в источнике данных, требуются разрешения *VIEW ANY COLUMN MASTER KEY DEFINITION* и *VIEW ANY COLUMN ENCRYPTION KEY DEFINITION* в базе данных-источнике.

Также требуется доступ к главным ключам столбцов, настроенным для столбцов, в которых хранятся предназначенные для шифрования или расшифровки данные.

- **Хранилище сертификатов — локальный компьютер** — требуется доступ на чтение к сертификату, который используется в качестве главного ключа столбца, либо необходимо быть администратором компьютера.
- **Хранилище ключей Azure** — требуются разрешения get, unwrapKey, wrapKey, sign и verify к хранилищу, содержащему главный ключ столбца.
- **Поставщик хранилища ключей (CNG)** — необходимые разрешения и учетные данные, которые могут быть запрошены при использовании хранилища ключей или ключа, зависят от конфигурации хранилища и KSP.
- **Поставщик служб шифрования (CAPI)** — необходимые разрешения и учетные данные, которые могут быть запрошены при использовании хранилища ключей или ключа, зависят от конфигурации хранилища и CSP.
Дополнительные сведения см. в разделе [Create and Store Column Master Keys (Always Encrypted)](../../../relational-databases/security/encryption/create-and-store-column-master-keys-always-encrypted.md)(Создание и хранение главных ключей столбцов (постоянное шифрование)).

## <a name="see-also"></a>См. также:
- [Always Encrypted (ядро СУБД)](../../../relational-databases/security/encryption/always-encrypted-database-engine.md)
- [Мастер постоянного шифрования](../../../relational-databases/security/encryption/always-encrypted-wizard.md)
- [Общие сведения об управлении ключами для постоянного шифрования](../../../relational-databases/security/encryption/overview-of-key-management-for-always-encrypted.md)
- [Создание и хранение главных ключей столбцов (постоянное шифрование)](../../../relational-databases/security/encryption/create-and-store-column-master-keys-always-encrypted.md)
- [Постоянное шифрование (разработка клиентских приложений)](../../../relational-databases/security/encryption/always-encrypted-client-development.md)
- [CREATE COLUMN MASTER KEY (Transact-SQL)](../../../t-sql/statements/create-column-master-key-transact-sql.md)
- [DROP COLUMN MASTER KEY (Transact-SQL)](../../../t-sql/statements/drop-column-master-key-transact-sql.md)
- [CREATE COLUMN ENCRYPTION KEY (Transact-SQL)](../../../t-sql/statements/create-column-encryption-key-transact-sql.md)
- [ALTER COLUMN ENCRYPTION KEY (Transact-SQL)](../../../t-sql/statements/alter-column-encryption-key-transact-sql.md)
- [DROP COLUMN ENCRYPTION KEY (Transact-SQL)](../../../t-sql/statements/drop-column-encryption-key-transact-sql.md) 
- [sys.column_master_keys (Transact-SQL)](../../../relational-databases/system-catalog-views/sys-column-master-keys-transact-sql.md)
- [sys.column_encryption_keys (Transact-SQL)](../../../relational-databases/system-catalog-views/sys-column-encryption-keys-transact-sql.md)
- [Настройка постоянного шифрования с помощью PowerShell](../../../relational-databases/security/encryption/configure-always-encrypted-using-powershell.md)