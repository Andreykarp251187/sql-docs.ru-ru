---
title: Руководство по архитектуре потоков и задач | Документация Майкрософт
ms.custom: ''
ms.date: 11/13/2018
ms.prod: sql
ms.prod_service: database-engine, sql-database
ms.reviewer: ''
ms.technology: supportability
ms.topic: conceptual
helpviewer_keywords:
- guide, thread and task architecture
- thread and task architecture guide
ms.assetid: 925b42e0-c5ea-4829-8ece-a53c6cddad3b
author: rothja
ms.author: jroth
monikerRange: =azuresqldb-current||>=sql-server-2016||=sqlallproducts-allversions||>=sql-server-linux-2017||=azuresqldb-mi-current
ms.openlocfilehash: 5dd4aa4c3beb769509884c6ebb75fd8c82c1c8ae
ms.sourcegitcommit: b2464064c0566590e486a3aafae6d67ce2645cef
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/15/2019
ms.locfileid: "68058128"
---
# <a name="thread-and-task-architecture-guide"></a>руководство по архитектуре потоков и задач
[!INCLUDE[appliesto-ss-asdb-xxxx-xxx-md](../includes/appliesto-ss-asdb-xxxx-xxx-md.md)]

Потоки — это возможность операционной системы, позволяющая разделить логику приложений на несколько одновременных путей выполнения. Эта особенность полезна, когда сложные приложения имеют много задач, которые могут выполняться одновременно. 

Когда операционная система выполняет экземпляр приложения, она создает модуль, называемый процессом, для управления экземпляром. Процесс имеет поток выполнения. Это ряд программных команд, выполненных кодом приложения. Например, если простое приложение имеет один набор команд, которые могут быть выполнены последовательно, есть только один путь выполнения или поток приложения. Более сложные приложения могут иметь несколько задач, которые могут выполняться одновременно, а не последовательно. Приложение может сделать это, запуская отдельные процессы для каждой задачи. Однако запуск процесса — это ресурсоемкая операция. Вместо этого приложение может запустить отдельные потоки. Они относительно менее ресурсоемки. Кроме этого, каждый поток можно запланировать для выполнения независимо от других потоков, связанных с процессом.

Потоки позволяют сложным приложениям более эффективно использовать ЦП, даже на компьютерах с одним ЦП. С одним ЦП только один поток может выполняться одновременно. Если один поток выполняет длительную операцию, которая не использует ЦП, например считывание с диска или запись на диск, другой поток может выполняться, пока первая операция не завершится. Возможность выполнять потоки, в то время как другие потоки ожидают завершения операции, позволяет приложению увеличить использование ЦП. Это особенно касается многопользовательских приложений, интенсивно использующих операции дискового ввода-вывода, например сервера базы данных. Компьютеры, имеющие несколько микропроцессоров или ЦП, могут выполнять одновременно по одному потоку на каждом ЦП. Например, если компьютер имеет восемь ЦП, он может выполнять одновременно восемь потоков.

## <a name="sql-server-batch-or-task-scheduling"></a>Работа с расписаниями задач и пакетов SQL Server

### <a name="allocating-threads-to-a-cpu"></a>Распределение потоков ЦП
По умолчанию каждый экземпляр [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] запускает один поток. Операционная система распределяет потоки экземпляров [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] поровну между ЦП компьютера в зависимости от загрузки. Если сходство процессов включено на уровне операционной системы, операционная система назначает каждый поток конкретному ЦП. Компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)], в свою очередь, назначает рабочие потоки [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] планировщикам, которые распределяют потоки в равной мере между процессорами (ЦП).
    
Для обеспечения многозадачности, например, когда несколько приложений используют один и тот же набор процессоров, операционная система иногда распределяет потоки процессов между разными процессорами. Безусловно, такая организация работы эффективна с точки зрения операционной системы, но может привести к снижению производительности [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] при больших нагрузках системы, поскольку в кэше каждого процессора неоднократно перезагружаются данные. В этих условиях назначение процессорам определенных потоков может повысить производительность, устраняя повторную загрузку процессоров и уменьшая количество переносов потоков между процессорами (а значит, уменьшая число переключений контекста). Такая связь между потоком и процессором называется соответствием процессоров. Если функция подобия была включена, операционная система назначает поток конкретному ЦП. 

[Параметр affinity mask](../database-engine/configure-windows/affinity-mask-server-configuration-option.md) задается с помощью инструкции [ALTER SERVER CONFIGURATION](../t-sql/statements/alter-server-configuration-transact-sql.md). Если параметр affinity mask не задан, экземпляр [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] распределяет рабочие потоки равномерно между планировщиками, которые не были исключены.

> [!CAUTION]
> Не используйте маску сходства процессоров в операционной системе и маску сходства в [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]одновременно. Эти настройки предназначены для достижения одного результата, и если их значения будут несогласованными, результат может быть непредсказуем. Дополнительные сведения см. в разделе [Параметр affinity mask](../database-engine/configure-windows/affinity-mask-server-configuration-option.md).

Пул потоков помогает оптимизировать производительность при подключении к серверу большого числа пользователей. Обычно для каждого запроса в операционной системе создается отдельный поток. Однако в случае сотен соединений с сервером, использование одного потока на каждый запрос приводит к потреблению большого числа системных ресурсов. [Параметр max worker threads](..//database-engine/configure-windows/configure-the-max-worker-threads-server-configuration-option.md) позволяет [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] создавать пул рабочих потоков, чтобы обслужить большое число запросов, что улучшает производительность. 

### <a name="using-the-lightweight-pooling-option"></a>параметр «использование упрощенных пулов»
Нагрузка, возникающая при контекстном переключении потоков, может быть не очень высока. Для большинства экземпляров [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] установка параметра "использование упрощенных пулов" в значение 0 или 1 не вызовет заметного изменения производительности. Выиграть от установки параметра [использование упрощенных пулов](../database-engine/configure-windows/lightweight-pooling-server-configuration-option.md) могут только те экземпляры [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], которые выполняются там, где:    
* установлен производительный многопроцессорный сервер;
* все процессоры работают почти на пределе производительности;
* высок уровень переключения контекста.

В таких системах может наблюдаться небольшое повышение эффективности, если для параметра "Использование упрощенных пулов" установлено значение 1.

> [!IMPORTANT]
> Не используйте планирование в режиме волокон для выполнения распространенных операций. Это может привести к снижению производительности, мешая нормальной работе переключения контекста. Кроме того, некоторые компоненты [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] не могут работать правильно в режиме волокон. Дополнительные сведения см. в разделе об [использовании упрощенных пулов](../database-engine/configure-windows/lightweight-pooling-server-configuration-option.md).

## <a name="thread-and-fiber-execution"></a>Выполнение потоков и волокон
В Microsoft Windows используется числовая система приоритетов, распределяющая выполняемые потоки по уровням от 1 до 31. Значение 0 зарезервировано для использования операционной системой. При наличии в очереди на выполнение нескольких потоков Windows сначала обслуживает поток с наивысшим приоритетом.

Каждый экземпляр [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] по умолчанию имеет уровень приоритета 7, что соответствует стандартному уровню. Это значение по умолчанию задает потокам [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] достаточно высокий уровень приоритета, позволяющий им получать достаточно ресурсов ЦП, не снижая производительности других приложений. 

Параметр конфигурации [priority boost](../database-engine/configure-windows/configure-the-priority-boost-server-configuration-option.md) используется для повышения приоритета потоков экземпляра [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] до уровня 13. Это наивысший приоритет. Этот параметр назначает потокам [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] более высокий приоритет по отношению к другим приложениям. При этом потоки [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] всегда будут обслуживаться в первую очередь, а потоки других приложений не смогут занимать ресурсы системы ранее потоков с более высоким приоритетом. Представленные выше меры могут повысить производительность сервера, на котором выполняются только экземпляры [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]. Однако если в приложении [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] выполняется ресурсоемкая операция, то не рекомендуется присваивать высокий приоритет другим приложениям, так как это может привести к загрузке ресурсов, необходимых для обслуживания потока [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]. 

Если на компьютере выполняется несколько экземпляров [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], то повышение приоритетов одних может привести к снижению производительности других. Кроме того, включение параметра priority boost может привести к простою других приложений и компонентов, выполняемых на компьютере. Таким образом, данный параметр рекомендуется использовать только в строго определенных условиях.

## <a name="hot-add-cpu"></a>ЦП с поддержкой горячей замены
ЦП с поддержкой горячей замены — это возможность динамически добавлять центральные процессоры в запущенную систему. Добавление центральных процессоров может осуществляться физически — путем добавления нового оборудования, логически — путем аппаратного секционирования в сети, виртуально — через уровень виртуализации. Начиная с [!INCLUDE[ssKatmai](../includes/ssKatmai-md.md)], [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] поддерживает ЦП с поддержкой горячей замены.

Требования для ЦП с поддержкой горячей замены:  
* оборудование с поддержкой ЦП с поддержкой горячей замены;
* 64-разрядный выпуск Windows Server 2008 Datacenter или Windows Server 2008 Enterprise Edition для операционных систем на платформе Itanium;
* [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] Enterprise.
* [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] не может быть настроен на использование программной архитектуры NUMA. Дополнительные сведения о программной архитектуре NUMA см. в разделе [Архитектура Soft-NUMA (SQL Server)](../database-engine/configure-windows/soft-numa-sql-server.md).

После добавления центральных процессоров [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] не начинает автоматически использовать их. Это предотвращает использование [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] центральных процессоров, добавленных для каких-либо других целей. После добавления ЦП выполните инструкцию [RECONFIGURE](../t-sql/language-elements/reconfigure-transact-sql.md), что позволит [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] распознать новые ЦП в качестве доступных ресурсов.

> [!NOTE]
> Для использования новых ЦП необходимо изменить настройки параметра [affinity64 mask](../database-engine/configure-windows/affinity64-mask-server-configuration-option.md) .
 
## <a name="best-practices-for-running-sql-server-on-computers-that-have-more-than-64-cpus"></a>Рекомендации по использованию SQL Server на компьютерах, которые имеют более 64 процессоров

### <a name="assigning-hardware-threads-with-cpus"></a>Назначение аппаратных потоков процессорам
Не используйте параметры конфигурации сервера affinity mask и affinity64 mask для привязки процессоров к определенным потокам. Эти параметры ограничены 64 процессорами. Вместо этого следует использовать параметр SET PROCESS AFFINITY инструкции [ALTER SERVER CONFIGURATION](../t-sql/statements/alter-server-configuration-transact-sql.md) .

### <a name="managing-the-transaction-log-file-size"></a>Управление размером файла журнала транзакций
Не следует полагаться на функцию автоувеличения для увеличения размера файла журнала транзакций. Увеличение журнала транзакций должно происходить последовательно. Увеличение журнала может помешать выполнению операций записи транзакций до тех пор, пока увеличение журнала не будет завершено. Вместо этого заранее выделите место для файлов журнала, установив размер файла в значение, достаточное для поддержки обычной рабочей нагрузки в среде.

### <a name="setting-max-degree-of-parallelism-for-index-operations"></a>Задание максимальной степени параллелизма для операций с индексами
На компьютерах, имеющих несколько процессоров, с помощью временного изменения модели восстановления базы данных на модель восстановления с неполным протоколированием или простую модель восстановления можно улучшить производительность операций с индексами, таких как создание или перестроение индексов. Операции с индексами могут создавать значительную нагрузку на журнал, и конфликт журнала может повлиять на выбранную [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] наилучшую степень параллелизма.

Кроме того, рассмотрите возможность настройки параметра **максимальной степени параллелизма (MAXDOP)** в конфигурации сервера для выполнения этих операций. Следующие рекомендации основаны на результатах внутренних тестов и носят общий характер. Попробуйте несколько различных параметров MAXDOP, чтобы определить оптимальное значение для вашей среды.

* Для модели полного восстановления укажите для максимальной степени параллелизма значение не больше 8.   
* Для модели с неполным протоколированием или простой модели восстановления можно указать для максимальной степени параллелизма значение больше 8.   
* Для серверов с настроенным компонентом NUMA максимальная степень параллелизма не должна превышать количество процессоров, назначенное каждому узлу NUMA. Это обусловлено тем, что запрос чаще всего использует локальную память первого узла NUMA, что может позволить улучшить время доступа к памяти.  
* Для серверов с включенным параметром гиперпоточности, произведенных до 2009 года включительно (до того как функция гиперпоточности была доработана), значение параметра MAXDOP не должно превышать число физических, а не логических процессоров.

Дополнительные сведения о параметре max degree of parallelism см. в статье [Настройка параметра конфигурации сервера max degree of parallelism](../database-engine/configure-windows/configure-the-max-degree-of-parallelism-server-configuration-option.md).

### <a name="setting-the-maximum-number-of-worker-threads"></a>Задание максимального числа рабочих потоков
Всегда задавайте максимальное число рабочих потоков таким образом, чтобы оно было больше параметра максимальной степени параллелизма. Количество рабочих потоков всегда должно быть по крайней мере в семь раз больше количества процессоров, имеющихся на сервере. Дополнительные сведения см. в статье [Настройка параметра конфигурации сервера max worker threads](../database-engine/configure-windows/configure-the-max-worker-threads-server-configuration-option.md).

### <a name="using-sql-trace-and-sql-server-profiler"></a>Использование приложения SQL Trace и SQL Server Profiler
В рабочей среде использовать трассировку SQL и SQL Profiler не рекомендуется. Издержки использования этих средств также увеличиваются по мере увеличения числа ЦП. Если в рабочей среде необходимо использовать приложение трассировки SQL, следует ограничить до минимума число отслеживаемых событий. Следует внимательно тестировать каждое событие трассировки под нагрузкой и избегать сочетания событий, которые могут значительно повлиять на производительность.

### <a name="setting-the-number-of-tempdb-data-files"></a>Задание количества файлов данных базы данных tempdb
Обычно число файлов данных tempdb должно соответствовать числу ЦП. Однако можно уменьшить ресурсы, используемые для управления базой данных, внимательно изучив параллельное использование базы данных tenpdb. Например, если в системе используется 64 ЦП, при этом только 32 запроса используют tempdb, увеличение числа файлов tempdb до 64 не приведет к улучшению производительности.

### <a name="sql-server-components-that-can-use-more-than-64-cpus"></a>Компоненты SQL Server, которые поддерживают более 64 процессоров
В приведенной ниже таблице перечисляются компоненты [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] и указывается, поддерживают ли они более 64 процессоров.

|Имя процесса   |Исполняемая программа |Использование более 64 процессоров |  
|----------|----------|----------|  
|Компонент SQL Server Database Engine |Sqlserver.exe  |Да |  
|Службы Reporting Services |Rs.exe |нет |  
|Службы Analysis Services  |As.exe |нет |  
|Службы Integration Services   |Is.exe |нет |  
|Компонент Service Broker |Sb.exe |нет |  
|Компонент Full-text Search   |Fts.exe    |нет |  
|Агент SQL Server   |Sqlagent.exe   |нет |  
|SQL Server Management Studio   |Ssms.exe   |нет |  
|программа установки SQL Server   |Setup.exe  |нет |  
