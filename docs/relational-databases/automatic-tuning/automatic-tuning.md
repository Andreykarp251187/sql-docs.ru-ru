---
title: Автоматическая настройка | Документация Майкрософт
description: Дополнительные сведения об автоматической настройке в SQL Server и базы данных SQL Azure
ms.custom: ''
ms.date: 08/16/2017
ms.prod: sql
ms.prod_service: database-engine, sql-database
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- performance tuning [SQL Server]
ms.assetid: ''
author: jovanpop-msft
ms.author: jovanpop
monikerRange: =azuresqldb-current||>=sql-server-2017||=sqlallproducts-allversions||>=sql-server-linux-2017||=azuresqldb-mi-current
ms.openlocfilehash: 4ad185085c19d8286fa6a09e46742860a948849a
ms.sourcegitcommit: b2464064c0566590e486a3aafae6d67ce2645cef
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/15/2019
ms.locfileid: "67934559"
---
# <a name="automatic-tuning"></a>Автоматическая настройка
[!INCLUDE[tsql-appliesto-ss2017-asdb-xxxx-xxx-md](../../includes/tsql-appliesto-ss2017-asdb-xxxx-xxx-md.md)]

Функция автоматической настройки базы данных предоставляет сведения о возможных проблемах с обработкой запросов и рекомендуемые решения. Она также может автоматически исправлять выявленные проблемы.

Автоматическая настройка в [!INCLUDE[sssqlv14-md](../../includes/sssqlv14-md.md)] уведомляет об обнаружении потенциальных проблем производительности и позволяет применять корректирующие действия или позволяет [!INCLUDE[ssde_md](../../includes/ssde_md.md)] автоматически устранять проблемы с производительностью.
Автоматическая настройка в [!INCLUDE[sssqlv14-md](../../includes/sssqlv14-md.md)] позволяет выявлять и устранять проблемы с производительностью из-за **регрессией в выборе плана выполнения запроса**. Автоматическая настройка в [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] также создает необходимые индексы и удаляет неиспользуемые индексы. Дополнительные сведения о плане выполнения запроса, см. в разделе [планы выполнения](../../relational-databases/performance/execution-plans.md).

[!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] Мониторы запросы, которые выполняются в базе данных и автоматически повышает производительность рабочей нагрузки. [!INCLUDE[ssde_md](../../includes/ssde_md.md)] Имеет встроенный аналитический механизм, который может автоматически настраивать и повышать производительность запросов путем динамической адаптации базы данных к рабочей нагрузке. Существует два функций автонастройки, которые доступны.

 -  **Автоматическое исправление плана** идентифицирует проблемных запросов, планы выполнения и устраняет проблемы с производительностью плана выполнения запроса. **Область применения**: [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] (начиная с [!INCLUDE[sssqlv14-md](../../includes/sssqlv14-md.md)]) и [!INCLUDE[ssSDSfull](../../includes/sssdsfull-md.md)].
 -  **Автоматическое управление индексами** определяет индексы, которые должны быть добавлены в базу данных или, которые должны быть удалены. **Область применения**: [!INCLUDE[ssSDSfull](../../includes/sssdsfull-md.md)]

## <a name="why-automatic-tuning"></a>Почему Автоматическая настройка?

Три из главных задач при администрировании классической базы данных мониторинга рабочей нагрузки, определение важных [!INCLUDE[tsql_md](../../includes/tsql-md.md)] запросы, индексы, которые должны быть добавлены для повышения производительности и идентифицирующий редко используется. [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] Обеспечивает точное представление о запросах и индексах, которые необходимо отслеживать. Тем не менее постоянно отслеживает базу данных — это сложная и трудоемкая задача, особенно при работе с несколькими базами данных. Управление огромным числом баз данных может быть невозможно эффективно. Вместо того чтобы выполнять мониторинг и настройку базы данных вручную, вы рекомендуем делегировать некоторые мониторинг и действия по настройке [!INCLUDE[ssde_md](../../includes/ssde_md.md)] с помощью функции автоматической настройки.

### <a name="how-does-automatic-tuning-work"></a>Как работает автоматическая настройка?

Автоматическая настройка — это непрерывный мониторинг и анализ процесс, который постоянно отслеживают характеристики рабочей нагрузки и выявить потенциальные проблемы и усовершенствования.

![Процесс автоматической настройки](./media/tuning-process.png)

Этот процесс позволяет базе данных динамически адаптироваться к рабочей нагрузке поиска индексы и планы могут способствовать повышению производительности рабочих нагрузок и какие индексы, влияющие на рабочую нагрузку. На основании этих данных, автоматическая настройка применяет действия по настройке, которые повышают производительность рабочей нагрузки. Кроме того база данных постоянно отслеживает производительность после любого изменения, сделанные автоматической настройкой, чтобы убедиться, что они повышают производительность рабочей нагрузки. Любое действие, которое не повысило производительность, автоматически отменяется. Процесс проверки является ключевой возможностью, которая гарантирует, что любые изменения, сделанные автоматической настройкой падать производительность рабочей нагрузки.

## <a name="automatic-plan-correction"></a>Автоматическое исправление плана

Автоматическое исправление плана — автоматической функции настройки, определяющий **плана выполнения, выбор регрессии** и автоматически устранить проблему, можно применить последний известный удачный план. Дополнительные сведения о плане выполнения запроса и оптимизатор запросов, см. в разделе [руководство по архитектуре обработки запросов](../../relational-databases/query-processing-architecture-guide.md).

### <a name="what-is-execution-plan-choice-regression"></a>Что такое Регрессия выбора плана выполнения

[!INCLUDE[ssdenoversion_md](../../includes/ssdenoversion_md.md)] Может использовать различные планы выполнения для выполнения [!INCLUDE[tsql_md](../../includes/tsql-md.md)] запросов. Планы запросов зависят от статистики, индексы и других факторов. Оптимальный план, который должен использоваться для выполнения некоторых [!INCLUDE[tsql_md](../../includes/tsql-md.md)] запрос может изменяться с течением времени. В некоторых случаях новый план не может быть лучше, чем предыдущий, и новый план может вызвать снижение производительности.

 ![Регрессия выбора плана выполнения запроса](media/plan-choice-regression.png "регрессии выбора плана выполнения запроса") 

Каждый раз, когда вы заметили планом, вы должны найти хорошие предыдущих планирования и заставить его вместо текущего один с использованием `sp_query_store_force_plan` процедуры.
[!INCLUDE[ssde_md](../../includes/ssde_md.md)] в [!INCLUDE[sssqlv14-md](../../includes/sssqlv14-md.md)] предоставляет сведения о бюллетене планы и рекомендуемые действия по исправлению.
Кроме того [!INCLUDE[ssde_md](../../includes/ssde_md.md)] позволяет полностью автоматизировать этот процесс и позволить [!INCLUDE[ssde_md](../../includes/ssde_md.md)] устранить проблему, найти связанные с изменением плана.

### <a name="automatic-plan-choice-correction"></a>Автоматическое исправление выбранного плана

[!INCLUDE[ssde_md](../../includes/ssde_md.md)] может автоматически переключиться на последний известный удачный план при обнаружении планом.

![Исправление выбранного плана выполнения запроса](media/force-last-good-plan.png "исправление выбранного плана выполнения запроса") 

[!INCLUDE[ssde_md](../../includes/ssde_md.md)] автоматически обнаруживает любые потенциальные регрессии выбором плана, включая план, который должен использоваться вместо неправильный план.
Когда [!INCLUDE[ssde_md](../../includes/ssde_md.md)] применяет последний известный эффективный план, автоматически отслеживается также производительность принудительного плана. Если план не лучше плана с ухудшением, новый план будет ухудшением и [!INCLUDE[ssde_md](../../includes/ssde_md.md)] будет компилироваться новый план. Если [!INCLUDE[ssde_md](../../includes/ssde_md.md)] проверяет, что план лучше плана с ухудшением, принудительного плана будет сохранена при переводе лучше плана с ухудшением, пока не произойдет рекомпиляции событий (например, на следующем статистики обновления или изменения схемы).

> [!NOTE]
> Принудительно планы автоматически любое выполнение система не сохраняются между перезапусками из [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] экземпляра.

### <a name="enabling-automatic-plan-choice-correction"></a>Включение автоматического исправления выбранного плана

Вы можете отдельно для каждой базы данных включить автоматическую настройку и указать, что при ухудшении производительности после изменения плана следует принудительно использовать последний известный эффективный план. Автоматическая настройка включается с помощью следующей команды.

```sql   
ALTER DATABASE current
SET AUTOMATIC_TUNING ( FORCE_LAST_GOOD_PLAN = ON ); 
```

После включения этого параметра [!INCLUDE[ssde_md](../../includes/ssde_md.md)] автоматически принудительно где предполагаемое Процессора замедлится более чем на 10 секунд, или количество ошибок в новом плане больше, чем количество ошибок в рекомендуемом и убедитесь, что Принудительный план лучше текущего.

### <a name="alternative---manual-plan-choice-correction"></a>Альтернатива — исправление выбранного плана вручную

Без автоматической настройки пользователи должны периодически проверять состояние системы и искать запросы, в которых были потери производительности. Если производительность была снижена любого плана, пользователь должен найти хорошие предыдущих планирования и заставить его вместо текущего один с использованием `sp_query_store_force_plan` процедуры. Рекомендуемым способом будет принудительно использовать последний известный удачный план, поскольку старые планы могут быть недоступными из-за изменения статистики или индекса. Пользователь, который заставляет последний известный удачный план необходимо отслеживать производительность запроса, который выполняется с помощью принудительного плана и убедиться, этой форсированном плане работает должным образом. В зависимости от результатов, мониторинга и анализа плана следует принудительно использовать, или пользователь должен найти другим способом для оптимизации запроса.
Вручную принудительными планами должен не используют неограниченно долго, так как [!INCLUDE[ssde_md](../../includes/ssde_md.md)] должны иметь возможность применить оптимальные планы. Пользователь или администратор базы данных должен в конечном итоге отменить принудительное использование плана с помощью `sp_query_store_unforce_plan` процедуры и позволяют [!INCLUDE[ssde_md](../../includes/ssde_md.md)] найти оптимальный план. 

> [!TIP]
> Alternativelly, используйте **запросы с принудительно планы** представление Store запрос для поиска и отменить принудительное использование планов.

[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] предоставляет все необходимые представления и процедуры, необходимые для наблюдения за производительностью и устранения проблем в Store запроса.

В [!INCLUDE[sssql15-md](../../includes/sssql15-md.md)], можно найти с помощью системных представлений запросов Store регрессией в выборе плана. В [!INCLUDE[sssqlv14-md](../../includes/sssqlv14-md.md)], [!INCLUDE[ssde_md](../../includes/ssde_md.md)] и показывает потенциальных регрессией в выборе плана и рекомендуемые действия, которые должны быть применены в [sys.dm_db_tuning_recommendations &#40;Transact-SQL&#41; ](../../relational-databases/system-dynamic-management-views/sys-dm-db-tuning-recommendations-transact-sql.md) представления. В представлении отображаются сведения о проблеме, важность проблемы и сведения, такие как выявленных запросов, идентификатор плана с ухудшением, идентификатор плана, который был использован в качестве базовых показателей для сравнения и [!INCLUDE[tsql_md](../../includes/tsql-md.md)] инструкцию, которая может выполняться для исправления проблема.

| type | description | datetime | score | details | ... |
| --- | --- | --- | --- | --- | --- |
| `FORCE_LAST_GOOD_PLAN` | Изменено с 4 мс до 14 мс времени ЦП | 3/17/2017 | 83 | `queryId` `recommendedPlanId` `regressedPlanId` `T-SQL` |   |
| `FORCE_LAST_GOOD_PLAN` | Изменено с 37 мс до 84 мс времени ЦП | 3/16/2017 | 26 | `queryId` `recommendedPlanId` `regressedPlanId` `T-SQL` |   |

В следующем списке описываются некоторые столбцы из данного представления:
 - Рекомендуемое действие - тип `FORCE_LAST_GOOD_PLAN`
 - Описание, которое содержит сведения, почему [!INCLUDE[ssde_md](../../includes/ssde_md.md)] считает, что это изменение плана потенциальных снижения производительности
 - Дата и время обнаружения потенциальных регрессии
 - Оценка этой рекомендации
 - Сведения о неполадках, таких как идентификатор обнаруженных плана, идентификатор плана с ухудшением, идентификатор плана, которое должно обязательно устраните ее причину, [!INCLUDE[tsql_md](../../includes/tsql-md.md)] скрипт, который может применяться для устранения проблемы и т. д. Сведения хранятся в [формате JSON](../../relational-databases/json/index.md)

Используйте следующий запрос, чтобы получить сценарий, который устраняет проблемы и Дополнительные сведения о предполагаемым получить:

```sql   
SELECT reason, score,
      script = JSON_VALUE(details, '$.implementationDetails.script'),
      planForceDetails.*,
      estimated_gain = (regressedPlanExecutionCount + recommendedPlanExecutionCount)
                  * (regressedPlanCpuTimeAverage - recommendedPlanCpuTimeAverage)/1000000,
      error_prone = IIF(regressedPlanErrorCount > recommendedPlanErrorCount, 'YES','NO')
FROM sys.dm_db_tuning_recommendations
CROSS APPLY OPENJSON (Details, '$.planForceDetails')
    WITH (  [query_id] int '$.queryId',
            regressedPlanId int '$.regressedPlanId',
            recommendedPlanId int '$.recommendedPlanId',
            regressedPlanErrorCount int,
            recommendedPlanErrorCount int,
            regressedPlanExecutionCount int,
            regressedPlanCpuTimeAverage float,
            recommendedPlanExecutionCount int,
            recommendedPlanCpuTimeAverage float
          ) AS planForceDetails;
```

[!INCLUDE[ssresult-md](../../includes/ssresult-md.md)]     

| reason | score | скрипт | запрос\_идентификатор | текущий план\_идентификатор | Рекомендуется использовать план\_идентификатор | предполагаемый\_получить | Ошибка\_ошибкам
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| Изменено с 3 мс на 46 мс времени ЦП | 36 | EXEC sp\_запроса\_хранения\_принудительно\_плана 12, 17; | 12 | 28 | 17 | 11.59 | 0

`estimated_gain` Представляет предполагаемое количество секунд, которые будут сохранены, если Рекомендуемый план будет выполняться вместо текущего плана. Рекомендуемый план должен принудительно вместо текущего плана, если выигрыш больше 10 секунд. Если дополнительные ошибки (например, значения времени ожидания или прерванных выполнений) в текущем плане, чем в Рекомендуемый план, столбец `error_prone` может быть присвоено значение `YES`. Ошибка ошибкам план — еще одна причина, почему рекомендуется плана следует принудительно использовать вместо текущей.

Несмотря на то что [!INCLUDE[ssde_md](../../includes/ssde_md.md)] предоставляет все данные, необходимые для идентификации регрессией в выборе плана; непрерывный мониторинг и устранение проблем с производительностью может быть утомительным процессом. Автоматическая настройка упрощает этот процесс.

> [!NOTE]
> Данные в sys.dm_db_tuning_recommendations динамического административного Представления не сохраняются между перезапусками из [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] экземпляра.

## <a name="automatic-index-management"></a>Автоматическое управление индексами

В [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)], Управление индексами легко поскольку [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] узнает о рабочей нагрузке и гарантирует, что ваши данные всегда оптимально индексируется. Правильное Проектирование индекса имеет решающее значение для достижения оптимальной производительности рабочей нагрузки и автоматическое управление индексами может помочь оптимизировать индексы. Автоматическое управление индексами можно устранять проблемы с производительностью в неправильно индексированных базах данных, или поддерживать и оптимизировать индексы в существующую схему базы данных. Автоматическая настройка в [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] выполняет следующие действия:

 - Определяет индексы, которые могут повысить производительность вашей [!INCLUDE[tsql_md](../../includes/tsql-md.md)] запросы на чтение данных из таблиц.
 - Определяет избыточные индексы или индексы, которые не использовались в более длительного периода времени, который может быть удален. Удаление ненужных индексов улучшает производительность запросов, которые обновляют данные в таблицах.

### <a name="why-do-you-need-index-management"></a>Зачем нужно Управление индексами?

Индексы ускоряют некоторые запросы на чтение данных из таблиц; Тем не менее они могут снизить производительность запросов для обновления данных. Необходимо тщательно проанализировать необходимость создания индекса и столбцы, которые необходимо включить в индекс. Некоторые индексы могут оказаться ненужными через некоторое время. Таким образом необходимо периодически определить и удалить индексы, которые не приносят никаких преимуществ. Если вы игнорировать неиспользуемые индексы, производительность запросов, которые обновляют данные может уменьшиться без каких-либо преимуществ для запросов, которые считывают данные. Неиспользуемые индексы также влияют на общую производительность системы, так как дополнительные обновления требуют ненужного ведения журнала.

Поиск оптимального набора индексов, которые повышают производительность запросов, чтение данных из таблиц и оказывают минимальное влияние на обновления может потребовать непрерывного и сложного анализа.

[!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] использует встроенную аналитику и расширенные фильтры, которые анализируют запросы, определяют индексы, которые оптимально подходили бы для все существующие рабочие нагрузки и индексы могут быть удалены. База данных SQL Azure гарантирует, что имеется минимально необходимый набор индексов, оптимизирующих запросы, которые считывают данные, с минимальным воздействием на другие запросы.

### <a name="automatic-index-management"></a>Автоматическое управление индексами

Помимо обнаружения [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] можно автоматически применять выявленных рекомендации. Если обнаружится, что встроенные правила повышают производительность базы данных, можно разрешить [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] автоматически управлять индексами.

Чтобы включить автоматическую настройку [!INCLUDE[ssSDSfull](../../includes/sssdsfull-md.md)] и разрешить автоматической функции настройки, чтобы полностью управлять рабочей нагрузкой, см. в разделе [включить автоматическую настройку в базе данных SQL Azure с помощью портала Azure](/azure/sql-database/sql-database-automatic-tuning-enable).

Когда [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] применяет рекомендацию CREATE INDEX или DROP INDEX, он автоматически отслеживает производительность запросов, которые были затронуты индекс. Создание индекса будут храниться только в том случае, если улучшить производительность соответствующих запросов. Удаленный индекс будет автоматически создан повторно, если существуют некоторые запросы, которые работать медленнее из-за отсутствия индекса.

### <a name="automatic-index-management-considerations"></a>Рекомендации по управлению автоматической индексации

Действия, необходимые для создания необходимых индексов в [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] может потреблять ресурсы и временно повлиять на производительность рабочей нагрузки. Чтобы свести к минимуму влияние процесса создания индекса на производительность рабочей нагрузки, [!INCLUDE[ssSDSfull](../../includes/sssdsfull-md.md)] находит соответствующее временное окно для любой операции управления индексом. Действия по настройке отложены, если в базе данных необходимы ресурсы для выполнения рабочей нагрузки и запускается, когда база данных имеет достаточно неиспользуемых ресурсов, которые можно использовать для задач обслуживания. Одна из важных функций автоматического управления индексами — это проверка действий. Когда [!INCLUDE[ssSDSfull](../../includes/sssdsfull-md.md)] создает или удаляет индекс, процесс мониторинга анализирует производительность рабочей нагрузки, чтобы убедиться, что действие повышена производительность. Если значительное улучшение -, действие немедленно отменяется. Таким образом, [!INCLUDE[ssSDSfull](../../includes/sssdsfull-md.md)] гарантирует, что автоматические действия не оказывают негативного влияния на производительность рабочей нагрузки. Индексы, созданные автоматической настройкой, прозрачны для операции обслуживания в базовой схеме. Изменения схемы, например удаление или переименование столбцов не блокируются при наличии автоматически созданных индексов. Индексы, которые создаются автоматически по [!INCLUDE[ssSDSfull](../../includes/sssdsfull-md.md)] , немедленно удаляются при связанных удалении таблицы или столбцы.

### <a name="alternative---manual-index-management"></a>Альтернатива — Управление индексами вручную

Без автоматического управления индексами, пользователю необходимо будет вручную запросить [sys.dm_db_missing_index_details &#40;Transact-SQL&#41; ](../../relational-databases/system-dynamic-management-views/sys-dm-db-missing-index-details-transact-sql.md) просматривать или использовать панель мониторинга производительности отчет в [!INCLUDE[ssManStudio](../../includes/ssManStudio-md.md)] для индексов поиска, которые могут повысить производительность, создать индексы, используя сведения, представленные в этом представлении и мониторинг производительности запроса вручную. Чтобы найти индексы, которые должны быть удалены, пользователям необходимо отслеживать статистику операционного использования индексов для поиска редко используемые индексы.

[!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] упрощает этот процесс. [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] анализирует рабочую нагрузку, определяет запросы, которые могут выполняться быстрее с новым индексом и перечислены неиспользуемые или повторяющиеся индексы. Дополнительные сведения об идентификации индексов, которые должны быть изменены в [найти рекомендации по индексам на портале Azure](https://docs.microsoft.com/azure/sql-database/sql-database-advisor-portal).

## <a name="see-also"></a>См. также  
 [ALTER DATABASE SET AUTOMATIC_TUNING &#40;Transact-SQL&#41;](../../t-sql/statements/alter-database-transact-sql-set-options.md)   
 [sys.database_automatic_tuning_options &#40;Transact-SQL&#41;](../../relational-databases/system-catalog-views/sys-database-automatic-tuning-options-transact-sql.md)  
 [sys.dm_db_tuning_recommendations &#40;Transact-SQL&#41;](../../relational-databases/system-dynamic-management-views/sys-dm-db-tuning-recommendations-transact-sql.md)   
 [sys.dm_db_missing_index_details &#40;Transact-SQL&#41;](../../relational-databases/system-dynamic-management-views/sys-dm-db-missing-index-details-transact-sql.md)   
 [sp_query_store_force_plan &#40;Transact-SQL&#41;](../../relational-databases/system-stored-procedures/sp-query-store-force-plan-transact-sql.md)     
 [sp_query_store_unforce_plan &#40;Transact-SQL&#41;](../../relational-databases/system-stored-procedures/sp-query-store-unforce-plan-transact-sql.md)           
 [sys.database_query_store_options &#40;Transact-SQL&#41;](../../relational-databases/system-catalog-views/sys-database-query-store-options-transact-sql.md)   
 [Функции JSON](../../relational-databases/json/index.md)    
 [Планы выполнения](../../relational-databases/performance/execution-plans.md)    
 [Наблюдение и настройка производительности](../../relational-databases/performance/monitor-and-tune-for-performance.md)     
 [Средства контроля и настройки производительности](../../relational-databases/performance/performance-monitoring-and-tuning-tools.md)     
 [Мониторинг производительности с использованием хранилища запросов](../../relational-databases/performance/monitoring-performance-by-using-the-query-store.md)  
 [Помощник по настройке запросов](../../relational-databases/performance/upgrade-dbcompat-using-qta.md)
