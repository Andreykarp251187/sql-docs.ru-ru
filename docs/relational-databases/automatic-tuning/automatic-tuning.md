---
title: Автоматическая настройка | Документация Майкрософт
description: Сведения об автоматической настройке в SQL Server и базе данных SQL Azure
ms.custom: ''
ms.date: 08/16/2017
ms.prod: sql
ms.prod_service: database-engine, sql-database
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- performance tuning [SQL Server]
ms.assetid: ''
author: jovanpop-msft
ms.author: jovanpop
monikerRange: =azuresqldb-current||>=sql-server-2017||=sqlallproducts-allversions||>=sql-server-linux-2017||=azuresqldb-mi-current
ms.openlocfilehash: 365834e3c1cd239a245c1523947a359b7c2dcc57
ms.sourcegitcommit: 4baa8d3c13dd290068885aea914845ede58aa840
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/13/2020
ms.locfileid: "79289122"
---
# <a name="automatic-tuning"></a>Автоматическая настройка
[!INCLUDE[tsql-appliesto-ss2017-asdb-xxxx-xxx-md](../../includes/tsql-appliesto-ss2017-asdb-xxxx-xxx-md.md)]

Функция автоматической настройки базы данных предоставляет сведения о возможных проблемах с обработкой запросов и рекомендуемые решения. Она также может автоматически исправлять выявленные проблемы.

Автоматическая настройка автоматически [!INCLUDE[sssqlv14-md](../../includes/sssqlv14-md.md)] уведомляет вас при обнаружении потенциальных проблем с производительностью и позволяет применять корректирующие действия, а также позволяет автоматически [!INCLUDE[ssde_md](../../includes/ssde_md.md)] устранять проблемы с производительностью.
Автоматическая настройка в [!INCLUDE[sssqlv14-md](../../includes/sssqlv14-md.md)] позволяет выявление и устранение проблем с производительностью, вызванных **регрессией выбора плана выполнения запроса**. Автоматическая настройка [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] также создает необходимые индексы и удаляет неиспользуемые индексы. Дополнительные сведения о планах выполнения запросов см. в разделе [планы выполнения](../../relational-databases/performance/execution-plans.md).

Выполняет [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] мониторинг запросов, выполняемых в базе данных, и автоматически повышает производительность рабочей нагрузки. [!INCLUDE[ssde_md](../../includes/ssde_md.md)] Содержит встроенный механизм аналитики, который может автоматически настраивать и улучшать производительность запросов, динамически адаптируя базу данных к рабочей нагрузке. Доступны две функции автоматической настройки:

 -  **Автоматическое исправление плана** определяет проблемные планы выполнения запросов и устраняет проблемы производительности плана выполнения запросов. **Область применения**: [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] (начиная с [!INCLUDE[sssqlv14-md](../../includes/sssqlv14-md.md)]) и [!INCLUDE[ssSDSfull](../../includes/sssdsfull-md.md)].
 -  **Автоматическое управление индексами** определяет индексы, которые должны быть добавлены в базу данных, и индексы, которые следует удалить. **Применимо к**:[!INCLUDE[ssSDSfull](../../includes/sssdsfull-md.md)]

## <a name="why-automatic-tuning"></a>Почему автоматическая настройка

Три основные задачи в классическом администрировании базы данных — мониторинг рабочей нагрузки, определение критических [!INCLUDE[tsql_md](../../includes/tsql-md.md)] запросов, индексы, которые следует добавить для повышения производительности, и определение редко используемых. [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] Предоставляет подробные сведения о запросах и индексах, которые необходимо отслеживать. Однако постоянное наблюдение за базой данных является сложной и утомительной задачей, особенно при работе с множеством баз данных. Управление огромным числом баз данных может быть невозможно эффективно. Вместо того, чтобы выполнять мониторинг и настройку базы данных вручную, можно рассмотреть возможность делегирования некоторых действий по мониторингу и [!INCLUDE[ssde_md](../../includes/ssde_md.md)] настройке с помощью функции автоматической настройки.

### <a name="how-does-automatic-tuning-work"></a>Как работает автоматическая настройка

Автоматическая настройка — это непрерывный процесс мониторинга и анализа, который постоянно узнает о характеристиках рабочей нагрузки и выявляет потенциальные проблемы и улучшения.

![Процесс автоматической настройки](./media/tuning-process.png)

Этот процесс позволяет базе данных динамически адаптироваться к рабочей нагрузке с помощью поиска индексов и планов, которые могут повысить производительность рабочих нагрузок и индексов, влияющих на рабочие нагрузки. На основании этих данных автоматическая настройка применяет действия по настройке производительности при рабочей нагрузке. Кроме того, база данных постоянно отслеживает производительность после внесения любых изменений с помощью автоматической настройки, чтобы обеспечить повышение производительности рабочей нагрузки. Все действия, которые не улучшают производительность, будут автоматически отменены. Процесс проверки является ключевой возможностью, которая гарантирует, что любые изменения, сделанные автоматической настройкой, не приведут к снижению производительности рабочей нагрузки.

## <a name="automatic-plan-correction"></a>Автоматическое исправление плана

Автоматическое исправление плана — это функция автоматической настройки, которая определяет **регрессию выбора планов выполнения** и автоматически решает проблему, вызывая Последний известный хороший план. Дополнительные сведения о планах выполнения запросов и оптимизаторе запросов см. в разделе [руководств по архитектуре обработки запросов](../../relational-databases/query-processing-architecture-guide.md).

### <a name="what-is-execution-plan-choice-regression"></a>Что такое регрессия выбора плана выполнения?

Для [!INCLUDE[ssdenoversion_md](../../includes/ssdenoversion_md.md)] выполнения [!INCLUDE[tsql_md](../../includes/tsql-md.md)] запросов в могут использоваться разные планы выполнения. Планы запросов зависят от статистики, индексов и других факторов. Оптимальный план, который должен использоваться для выполнения некоторых [!INCLUDE[tsql_md](../../includes/tsql-md.md)] запросов, может изменяться с течением времени. В некоторых случаях новый план может быть не выше, чем предыдущий, а новый план может вызвать снижение производительности.

 ![Регрессия выбора плана выполнения запроса](media/plan-choice-regression.png "Регрессия выбора плана выполнения запроса") 

Когда вы заметите регрессию выбора плана, вы должны найти предыдущий хороший план и принудительно использовать `sp_query_store_force_plan` его вместо текущего.
[!INCLUDE[ssde_md](../../includes/ssde_md.md)]в [!INCLUDE[sssqlv14-md](../../includes/sssqlv14-md.md)] предоставляет сведения о регрессионных планах и рекомендованных корректирующих действиях.
Кроме того [!INCLUDE[ssde_md](../../includes/ssde_md.md)] , позволяет полностью автоматизировать этот процесс и позволить [!INCLUDE[ssde_md](../../includes/ssde_md.md)] устранить все проблемы, связанные с изменениями плана.

### <a name="automatic-plan-choice-correction"></a>Автоматическое исправление выбора плана

[!INCLUDE[ssde_md](../../includes/ssde_md.md)]может автоматически переключиться на последний известный хороший план при обнаружении регрессии "Выбор плана".

![Исправление выбора плана выполнения запроса](media/force-last-good-plan.png "Исправление выбора плана выполнения запроса") 

[!INCLUDE[ssde_md](../../includes/ssde_md.md)]автоматически обнаруживает любую потенциальную регрессию выбора плана, включая план, который следует использовать вместо неверного плана.
Когда [!INCLUDE[ssde_md](../../includes/ssde_md.md)] применяет последний известный хороший план, он автоматически отслеживает производительность принудительного плана. Если принудительный план не выше, чем регрессивный план, новый план будет непринудительным, а [!INCLUDE[ssde_md](../../includes/ssde_md.md)] будет компилировать новый план. Если приложение [!INCLUDE[ssde_md](../../includes/ssde_md.md)] проверяет, что принудительный план лучше, чем регрессионный, то принудительный план будет храниться, если он лучше, чем регрессивный, до тех пор, пока не произойдет перекомпиляция (например, при следующем обновлении статистики или изменении схемы).

> [!NOTE]
> Любые планы выполнения с автоматической принудительной фиксацией не сохраняются между перезапусками [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] экземпляра.

### <a name="enabling-automatic-plan-choice-correction"></a>Включение автоматического исправления выбранного плана

Вы можете отдельно для каждой базы данных включить автоматическую настройку и указать, что при ухудшении производительности после изменения плана следует принудительно использовать последний известный эффективный план. Автоматическая настройка включается с помощью следующей команды.

```sql   
ALTER DATABASE current
SET AUTOMATIC_TUNING ( FORCE_LAST_GOOD_PLAN = ON ); 
```

После включения этого параметра [!INCLUDE[ssde_md](../../includes/ssde_md.md)] будет автоматически принудительно использовать любые рекомендации, в которых предполагаемое увеличение ЦП превышает 10 секунд, или число ошибок в новом плане выше, чем количество ошибок в рекомендуемом плане, и убедиться, что принудительный план лучше, чем текущий.

### <a name="alternative---manual-plan-choice-correction"></a>Альтернатива — исправление выбранного плана вручную

Без автоматической настройки пользователи должны периодически проверять состояние системы и искать запросы, в которых были потери производительности. Если какой бы то ни было план, пользователь должен найти предыдущий хороший план и принудительно использовать `sp_query_store_force_plan` его вместо текущего. Рекомендуется принудительно применить последний известный хороший план, так как старые планы могут быть недопустимы из-за изменения статистики или индекса. Пользователь, который вызывает последний известный хороший план, должен отслеживать производительность запроса, выполняемого с помощью принудительного плана, и проверять, что принудительный план работает должным образом. В зависимости от результатов мониторинга и анализа план должен быть принудительным или пользователь должен найти другой способ оптимизации запроса.
Принудительные планы вручную не должны быть принудительно бесконечно [!INCLUDE[ssde_md](../../includes/ssde_md.md)] , так как должны иметь возможность применять оптимальные планы. Пользователь или администратор баз данных должен в конечном итоге отменить принудительное `sp_query_store_unforce_plan` применение плана с помощью процедуры [!INCLUDE[ssde_md](../../includes/ssde_md.md)] и позволить найти оптимальный план. 

> [!TIP]
> Кроме того, можно использовать запросы с представлением хранилища запросов **с принудительными планами** для поиска и принудительного применения планов.

[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]предоставляет все необходимые представления и процедуры, необходимые для отслеживания производительности и устранения проблем в хранилище запросов.

В [!INCLUDE[sssql15-md](../../includes/sssql15-md.md)]среде можно найти регрессию выбора плана с помощью системных представлений хранилища запросов. В [!INCLUDE[sssqlv14-md](../../includes/sssqlv14-md.md)] [!INCLUDE[ssde_md](../../includes/ssde_md.md)] обнаруживает и отображает возможные регрессии выбора планов и рекомендуемые действия, которые следует применить в представлении [sys. dm_db_tuning_recommendations &#40;Transact-SQL&#41;](../../relational-databases/system-dynamic-management-views/sys-dm-db-tuning-recommendations-transact-sql.md) . В представлении отображаются сведения о проблеме, важности проблемы и такие сведения, как идентифицированный запрос, идентификатор регрессионного плана, идентификатор плана, который использовался в качестве базового для сравнения, и [!INCLUDE[tsql_md](../../includes/tsql-md.md)] инструкция, которая может быть выполнена для устранения проблемы.

| type | description | DATETIME | приложения | подробности | ... |
| --- | --- | --- | --- | --- | --- |
| `FORCE_LAST_GOOD_PLAN` | Время ЦП изменено с 4 мс до 14 мс | 3/17/2017 | 83 | `queryId` `recommendedPlanId` `regressedPlanId` `T-SQL` |   |
| `FORCE_LAST_GOOD_PLAN` | Время ЦП изменено с 37 МС на 84 МС | 3/16/2017 | 26 | `queryId` `recommendedPlanId` `regressedPlanId` `T-SQL` |   |

Некоторые столбцы из этого представления описаны в следующем списке:
 - Тип рекомендуемого действия —`FORCE_LAST_GOOD_PLAN`
 - Описание, содержащее сведения о [!INCLUDE[ssde_md](../../includes/ssde_md.md)] том, что это изменение плана является потенциальной регрессией производительности
 - Дата и время, когда обнаружена потенциальная регрессия
 - Оценка этой рекомендации
 - Сведения о проблемах, например идентификатор обнаруженного плана, идентификатор регрессионного плана, идентификатор плана, который должен быть вынужден устранить проблему, [!INCLUDE[tsql_md](../../includes/tsql-md.md)] сценарий, который можно применить для устранения проблемы и т. д. Сведения хранятся в [формате JSON](../../relational-databases/json/index.md)

Используйте следующий запрос для получения сценария, который устраняет проблему, и дополнительные сведения о предполагаемом выигрыше:

```sql   
SELECT reason, score,
      script = JSON_VALUE(details, '$.implementationDetails.script'),
      planForceDetails.*,
      estimated_gain = (regressedPlanExecutionCount + recommendedPlanExecutionCount)
                  * (regressedPlanCpuTimeAverage - recommendedPlanCpuTimeAverage)/1000000,
      error_prone = IIF(regressedPlanErrorCount > recommendedPlanErrorCount, 'YES','NO')
FROM sys.dm_db_tuning_recommendations
CROSS APPLY OPENJSON (Details, '$.planForceDetails')
    WITH (  [query_id] int '$.queryId',
            regressedPlanId int '$.regressedPlanId',
            recommendedPlanId int '$.recommendedPlanId',
            regressedPlanErrorCount int,
            recommendedPlanErrorCount int,
            regressedPlanExecutionCount int,
            regressedPlanCpuTimeAverage float,
            recommendedPlanExecutionCount int,
            recommendedPlanCpuTimeAverage float
          ) AS planForceDetails;
```

[!INCLUDE[ssresult-md](../../includes/ssresult-md.md)]     

| reason | приложения | script | Идентификатор\_запроса | Идентификатор текущего\_плана | Рекомендуемый\_идентификатор плана | предполагаемое\_увеличение | подвержена ошибкам\_
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| Время ЦП изменено с 3 по МС на 46 МС | 36 | Пакет EXEC\_SP\_хранилище\_запросов\_Force план 12, 17; | 12 | 28 | 17 | 11,59 | 0

`estimated_gain`представляет предполагаемое количество секунд, которое будет сохранено, если вместо текущего плана будет выполнен Рекомендуемый план. Рекомендуемый план следует принудительно применять вместо текущего плана, если рост превышает 10 секунд. Если в текущем плане имеется больше ошибок (например, времени ожидания или прерываний выполнения), чем в рекомендуемом плане, столбцу `error_prone` будет присвоено значение. `YES` План, подверженный ошибкам, является еще одной причиной, по которой Рекомендуемый план следует принудительно применять вместо текущего.

Несмотря [!INCLUDE[ssde_md](../../includes/ssde_md.md)] на то, что предоставляет все сведения, необходимые для задания регрессии выбора плана; непрерывный мониторинг и устранение проблем с производительностью может быть утомительным процессом. Автоматическая настройка значительно упрощает этот процесс.

> [!NOTE]
> Данные в динамическом административном представлении sys. dm_db_tuning_recommendations не сохраняются между перезапусками [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] экземпляра.

## <a name="automatic-index-management"></a>Автоматическое управление индексами

В [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)]Управление индексами выполняется легко, [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] так как вы узнаете о рабочей нагрузке и гарантируете, что данные всегда индексируются оптимально. Правильное проектирование индекса имеет решающее значение для обеспечения оптимальной производительности при рабочей нагрузке. Автоматическое управление индексами поможет оптимизировать их. Автоматическое управление индексами может как устранять проблемы с производительностью в неправильно индексированных базах данных, так и поддерживать и оптимизировать индексы в существующей схеме базы данных. Автоматическая настройка в [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] выполняет следующие действия.

 - Определяет индексы, которые могут повысить производительность [!INCLUDE[tsql_md](../../includes/tsql-md.md)] запросов, считывающих данные из таблиц.
 - Определяет избыточные индексы или индексы, которые не использовались в течение более длительного периода времени, которые можно удалить. Удаление ненужных индексов повышает производительность запросов, которые обновляют данные в таблицах.

### <a name="why-do-you-need-index-management"></a>Для чего необходимо управление индексами

Индексы ускоряют некоторые запросы на чтение данных из таблиц. Тем не менее, они могут снизить производительность запросов, используемых для обновления данных. Необходимо тщательно проанализировать необходимость создания индекса и какие столбцы нужно включать в него. Некоторые индексы могут оказаться ненужными через некоторое время. Таким образом, необходимо периодически определять индексы, которые не приносят никаких преимуществ, и удалять их. Если вы будете игнорировать неиспользуемые индексы, производительность запросов, которые обновляют данные может уменьшиться без каких-либо преимуществ для запросов, которые считывают данные. Неиспользуемые индексы также влияют на общую производительность системы, так как дополнительные обновления требуют ненужного ведения журнала.

Поиск оптимального набора индексов, повышающего производительность запросов, которые считывают данные из таблиц и оказывают минимальное влияние на обновления, может потребовать непрерывного и сложного анализа.

[!INCLUDE[ssazure_md](../../includes/ssazure_md.md)]использует встроенные аналитические средства и Расширенные правила, которые анализируют запросы, выдают индексы, оптимальные для текущих рабочих нагрузок, и индексы могут быть удалены. База данных Azure SQL гарантирует, что у вас есть минимально необходимый набор индексов, оптимизирующих запросы, которые считывают данные, с минимальным воздействием на другие запросы.

### <a name="automatic-index-management"></a>Автоматическое управление индексами

Помимо обнаружения, [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] может автоматически применять определенные рекомендации. Если вы обнаружите, что встроенные правила повышают производительность базы данных, вы можете [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] автоматически управлять индексами.

Сведения о включении автоматической [!INCLUDE[ssSDSfull](../../includes/sssdsfull-md.md)] настройки в и разрешении функции автоматической настройки для полного управления рабочей нагрузкой см. [в статье Включение автоматической настройки в базе данных SQL Azure с помощью портал Azure](/azure/sql-database/sql-database-automatic-tuning-enable).

Когда объект [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] применяет РЕКОМЕНДАЦИЮ CREATE INDEX или DROP INDEX, он автоматически отслеживает производительность запросов, затрагиваемых индексом. Новый индекс будет храниться только в том случае, если производительность затронутые запросы улучшены. Удаленный индекс будет автоматически создан повторно, если имеются некоторые запросы, которые выполняются медленнее из-за отсутствия индекса.

### <a name="automatic-index-management-considerations"></a>Рекомендации по автоматическому управлению индексами

Действия, необходимые для создания необходимых индексов в [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] , могут потреблять ресурсы и временно влиять на производительность рабочей нагрузки. Чтобы уменьшить влияние создания индекса на производительность рабочей нагрузки, [!INCLUDE[ssSDSfull](../../includes/sssdsfull-md.md)] находит соответствующее временное окно для любой операции управления индексами. Действия по настройке будут отложены, если базе данных необходимы ресурсы для выполнения рабочей нагрузки, и запустятся, когда у базы данных будет достаточно неиспользуемых ресурсов, которые могут использоваться для задач обслуживания. Одна из важных функций автоматического управления индексами — это проверка действий. При [!INCLUDE[ssSDSfull](../../includes/sssdsfull-md.md)] создании или удалении индекса процесс мониторинга анализирует производительность рабочей нагрузки, чтобы убедиться, что действие повысило производительность. Если это не привело к значительному улучшению, действие будет немедленно отменено. Таким образом, [!INCLUDE[ssSDSfull](../../includes/sssdsfull-md.md)] это гарантирует, что автоматические действия не негативно влияют на производительность рабочей нагрузки. Индексы, созданные автоматической настройкой, прозрачны для операции обслуживания в базовой схеме. Изменения схемы, например удаление или переименование столбцов, не блокируются при наличии автоматически созданных индексов. Индексы, созданные [!INCLUDE[ssSDSfull](../../includes/sssdsfull-md.md)] автоматически, немедленно удаляются при удалении связанных таблиц или столбцов.

### <a name="alternative---manual-index-management"></a>Альтернативное управление индексами вручную

Без автоматического управления индексами пользователю потребуется вручную выполнить запрос к [sys. dm_db_missing_index_details &#40;Transact-SQL&#41;](../../relational-databases/system-dynamic-management-views/sys-dm-db-missing-index-details-transact-sql.md) представлении или использовать отчет панели мониторинга производительности в [!INCLUDE[ssManStudio](../../includes/ssManStudio-md.md)] для поиска индексов, которые могут повысить производительность, создавать индексы с использованием сведений, представленных в этом представлении, и вручную отслеживать производительность запроса. Чтобы найти индексы, которые следует удалить, пользователям следует отслеживать статистику использования операций индексов для поиска редко используемых индексов.

[!INCLUDE[ssazure_md](../../includes/ssazure_md.md)]упрощает этот процесс. [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)]анализирует рабочую нагрузку, определяет запросы, которые могут выполняться быстрее с новым индексом, и определяет неиспользуемые или дублирующиеся индексы. Дополнительные сведения об идентификации индексов, которые необходимо изменить, см. в статье [Использование помощника по базам данных SQL на портале Azure](https://docs.microsoft.com/azure/sql-database/sql-database-advisor-portal).

## <a name="see-also"></a>См. также:  
 [ALTER DATABASE SET AUTOMATIC_TUNING &#40;&#41;Transact-SQL](../../t-sql/statements/alter-database-transact-sql-set-options.md)   
 [sys. database_automatic_tuning_options &#40;Transact-SQL&#41;](../../relational-databases/system-catalog-views/sys-database-automatic-tuning-options-transact-sql.md)  
 [sys. dm_db_tuning_recommendations &#40;Transact-SQL&#41;](../../relational-databases/system-dynamic-management-views/sys-dm-db-tuning-recommendations-transact-sql.md)   
 [sys. dm_db_missing_index_details &#40;Transact-SQL&#41;](../../relational-databases/system-dynamic-management-views/sys-dm-db-missing-index-details-transact-sql.md)   
 [sp_query_store_force_plan &#40;Transact-SQL&#41;](../../relational-databases/system-stored-procedures/sp-query-store-force-plan-transact-sql.md)     
 [sp_query_store_unforce_plan &#40;Transact-SQL&#41;](../../relational-databases/system-stored-procedures/sp-query-store-unforce-plan-transact-sql.md)           
 [sys. database_query_store_options &#40;Transact-SQL&#41;](../../relational-databases/system-catalog-views/sys-database-query-store-options-transact-sql.md)   
 [Функции JSON](../../relational-databases/json/index.md)    
 [Планы выполнения](../../relational-databases/performance/execution-plans.md)    
 [Наблюдение и настройка производительности](../../relational-databases/performance/monitor-and-tune-for-performance.md)     
 [Средства контроля и настройки производительности](../../relational-databases/performance/performance-monitoring-and-tuning-tools.md)     
 [Мониторинг производительности с использованием хранилища запросов](../../relational-databases/performance/monitoring-performance-by-using-the-query-store.md)  
 [Помощник по настройке запросов](../../relational-databases/performance/upgrade-dbcompat-using-qta.md)
