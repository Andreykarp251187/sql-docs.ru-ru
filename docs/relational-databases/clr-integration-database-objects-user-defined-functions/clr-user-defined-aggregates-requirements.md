---
title: Требования к определенным агрегатам CLR (определяемые пользователями) Документы Майкрософт
description: Интеграция S'L Server CLR позволяет создавать пользовательские агрегированные функции в управляемом коде. Они должны выполнить необходимый договор агрегации.
ms.custom: ''
ms.date: 03/17/2017
ms.prod: sql
ms.reviewer: ''
ms.technology: clr
ms.topic: reference
helpviewer_keywords:
- aggregate functions [CLR integration]
- user-defined types [CLR integration], user-defined aggregates
- CREATE AGGREGATE statement
- SqlUserDefinedAggregate attribute
- aggregate methods [CLR integration]
- assemblies [CLR integration], user-defined aggregate functions
- custom aggregates [CLR integration]
- user-defined functions [CLR integration]
- UDTs [CLR integration], user-defined aggregates
ms.assetid: dbf9eb5a-bd99-42f7-b275-556d0def045d
author: rothja
ms.author: jroth
ms.openlocfilehash: 9dd27cf3751400d3902ddd4199daee8aeef78b80
ms.sourcegitcommit: b2cc3f213042813af803ced37901c5c9d8016c24
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81487971"
---
# <a name="clr-user-defined-aggregates---requirements"></a>Требования для определяемых пользователем агрегатных функций среды CLR
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md](../../includes/appliesto-ss-xxxx-xxxx-xxx-md.md)]
  Тип в сборке CLR можно зарегистрировать как определяемую пользователем агрегатную функцию, если он реализует необходимую статистическую обработку. Этот контракт состоит из атрибута **SqlUserDefinedAggregate** и методов агрегирования контракта. Договор агрегации включает в себя механизм сохранения промежуточного состояния агрегатации, а также механизм накопления новых значений, который состоит из четырех методов: **Init,** **Накопить,** **Слияние,** и **Прекратить**. Когда вы выполнили эти требования, вы сможете в полной [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]мере воспользоваться пользовательскими агрегатами в . В следующих подразделах этого раздела содержатся подробные сведения о создании определяемых пользователем статистических функций и работе с ними. Например, [см. Наводя функции агрегата, определяемые пользователями CLR.](../../relational-databases/clr-integration-database-objects-user-defined-functions/clr-user-defined-aggregate-invoking-functions.md)  
  
## <a name="sqluserdefinedaggregate"></a>SqlUserDefinedAggregate  
 Для получения дополнительной информации [см.](https://go.microsoft.com/fwlink/?LinkId=124626)  
  
## <a name="aggregation-methods"></a>Методы статистической обработки  
 Класс, зарегистрированный как определяемая пользователем статистическая функция, должен поддерживать следующие методы экземпляра. Это методы, которые использует обработчик запросов для выполнения статистической обработки.  
  
|Метод|Синтаксис|Описание|  
|------------|------------|-----------------|  
|**Init**|`public void Init();`|Обработчик запросов использует данный метод для инициализации вычисления статистической обработки. Этот метод вызывается один раз для каждой группы, которую обработчик запросов подвергает статистической обработке. Обработчик запросов может выбрать повторное использование одного экземпляра класса статистической функции для выполнения статистической обработки нескольких групп. Метод **Init** должен выполнять любую очистку по мере необходимости из предыдущих видов использования данного экземпляра и позволить ему перезапустить новый агрегированный вычисление.|  
|**Накапливать**|`public void Accumulate ( input-type value[, input-type value, ...]);`|Один или несколько параметров, представляющих аргументы функции. *input_type* должен быть [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] управляемый тип [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] данных, эквивалентный типу данных, указанному *input_sqltype* в выписке **CREATE AGGREGATE.** Для получения дополнительной [Mapping CLR Parameter Data](../../relational-databases/clr-integration-database-objects-types-net-framework/mapping-clr-parameter-data.md)информации см.<br /><br /> Для определяемых пользователем типов входной тип аналогичен определяемому пользователем типу. Обработчик запросов использует этот метод для накопления статистических значений. Метод вызывается один раз для каждого значения группы, в которой выполняется статистическая обработка. Процессор запросов всегда вызывает это только после вызова метода **Init** в данном экземпляре агрегатного класса. Реализация данного метода должна обновить состояние экземпляра, чтобы отразить накопление передаваемого значения аргумента.|  
|**Объединить**|`public void Merge( udagg_class value);`|Метод используется для слияния еще одного экземпляра этого статистического класса с текущим экземпляром. Обработчик запросов использует этот метод для слияния нескольких частичных вычислений статистической обработки.|  
|**Завершить**|`public return_type Terminate();`|Этот метод завершает статистическое вычисление и возвращает результат статистической обработки. *Return_type* должен быть [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] управляемым типом данных, который является управляемым эквивалентом *return_sqltype,* указанным в заявлении **CREATE AGGREGATE.** *Тип return_type* также может быть определенным для пользователя.|  
  
### <a name="table-valued-parameters"></a>Параметры, возвращающие табличные значения  
 Возвращающие табличное значение параметры — это определяемые пользователем табличные типы, которые передаются в процедуру или функцию, предоставляя эффективный способ передачи на сервер нескольких строк данных. Возвращающие табличное значение параметры выполняют функции, аналогичные массивам параметров, но обладают большей гибкостью и лучше интегрируются с [!INCLUDE[tsql](../../includes/tsql-md.md)]. Они также обеспечивают возможность повышения производительности. Кроме того, возвращающие табличное значение параметры способствуют сокращению циклов приема-передачи данных с сервера и на сервер. Вместо того чтобы отправлять на сервер несколько запросов (как в случае списка скалярных параметров), данные можно отправить в виде возвращающего табличное значение параметра. Определяемый пользователем табличный тип нельзя передавать в виде возвращающего табличное значение параметра в управляемую хранимую процедуру или функцию, которая выполняется в процессе [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] . Кроме того, такие процедуры и функции не могут возвращать определяемые пользователем табличные типы. Возвращающие табличное значение параметры также нельзя использовать внутри области контекстного соединения. Однако возвращающий табличное значение параметр можно использовать с SqlClient в управляемых хранимых процедурах или функциях, выполняемых в процессе [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], если он используется в соединении, отличном от контекстного соединения. Соединение может быть установлено с тем же сервером, который выполняет управляемую процедуру или функцию. Для получения дополнительной информации о TVPs см [&#41;&#40;. ](../../relational-databases/tables/use-table-valued-parameters-database-engine.md)  
  
## <a name="change-history"></a>Журнал изменений  
  
|Обновленное содержимое|  
|---------------------|  
|Обновлено описание метода **аккумулировать;** теперь он принимает более одного параметра.|  
  
## <a name="see-also"></a>См. также:  
 [Типы, определяемые пользователями CLR](../../relational-databases/clr-integration-database-objects-user-defined-types/clr-user-defined-types.md)   
 [Вызов определяемых пользователем агрегатных функций CLR](../../relational-databases/clr-integration-database-objects-user-defined-functions/clr-user-defined-aggregate-invoking-functions.md)  
  
  
