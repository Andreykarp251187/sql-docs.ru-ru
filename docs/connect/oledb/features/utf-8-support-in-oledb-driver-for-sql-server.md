---
title: Поддержка UTF-8 в драйвере OLE DB для SQL Server | Документация Майкрософт
description: Поддержка UTF-8 в драйвере OLE DB для SQL Server
ms.custom: ''
ms.date: 04/23/2019
ms.prod: sql
ms.prod_service: connectivity
ms.reviewer: ''
ms.technology: connectivity
ms.topic: reference
author: v-kaywon
ms.author: v-kaywon
ms.openlocfilehash: fb596365f284a141b5e57bfc8601427fe603d73d
ms.sourcegitcommit: 49f3d12c0a46d98b82513697a77a461340f345e1
ms.translationtype: MTE75
ms.contentlocale: ru-RU
ms.lasthandoff: 09/06/2019
ms.locfileid: "70392019"
---
# <a name="utf-8-support-in-ole-db-driver-for-sql-server"></a>Поддержка UTF-8 в драйвере OLE DB для SQL Server
[!INCLUDE[appliesto-ss-asdb-asdw-pdw-md](../../../includes/appliesto-ss-asdb-asdw-pdw-md.md)]

[!INCLUDE[Driver_OLEDB_Download](../../../includes/driver_oledb_download.md)]

Microsoft OLE DB Driver для SQL Server (версия 18.2.1) обеспечивает поддержку серверного кодирования UTF-8. Сведения о поддержке UTF-8 в SQL Server см. в следующих статьях.
- [Поддержка параметров сортировки и Юникода](../../../relational-databases/collations/collation-and-unicode-support.md)
- [Поддержка UTF-8](#ctp23)

> [!IMPORTANT]
> Драйвер Microsoft OLE DB для SQL Server использует функцию [жетакп](https://docs.microsoft.com/windows/win32/api/winnls/nf-winnls-getacp) для определения кодировки входного буфера DBTYPE_STR. Сценарии, в которых Жетакп возвращает кодировку UTF-8, не поддерживаются. Если буфер должен хранить данные в Юникоде, для типа данных buffer следует задать значение DBTYPE_WSTR (в кодировке UTF-16).

## <a name="data-insertion-into-a-utf-8-encoded-char-or-varchar-column"></a>Вставка данных в столбец CHAR или VARCHAR в кодировке UTF-8
При создании буфера входного параметра для вставки буфер описан с помощью массива [структур DBBINDING](https://go.microsoft.com/fwlink/?linkid=2071182). Каждая структура DBBINDING связывает отдельный параметр с буфером потребителя и содержит такие сведения, как длина и тип значения данных. Для буфера входного параметра типа CHAR параметру *wType* структуры DBBINDING должно быть присвоено значение DBTYPE_STR. Для буфера входного параметра типа WCHAR параметру *wType* структуры DBBINDING должно быть присвоено значение DBTYPE_WSTR.

При выполнении команды с параметрами драйвер создает сведения о типе данных параметра. Если тип буфера входных данных и тип данных параметра совпадают, преобразование в драйвере не выполняется. В противном случае драйвер преобразует буфер входного параметра в тип данных параметра. Пользователь может явно указать тип данных параметра, вызвав [ICommandWithParameters:SetParameterInfo](https://go.microsoft.com/fwlink/?linkid=2071577). Если данные не указаны, драйвер извлекает сведения о типе данных параметра путем (a) получения метаданных столбца с сервера при подготовке инструкции или (б) попытки преобразования по умолчанию из типа данных входного параметра.

Буфер входного параметра может быть преобразован в сервер c параметрами сортировки столбцов драйвером или сервером в зависимости от типа данных входного буфера и типа данных параметра. Во время преобразования возможна потеря данных, если кодовой страницей клиента или кодовой страницей параметров сортировки базы данных не могут быть представлены все символы из буфера входных данных. В следующей таблице описан процесс преобразования при вставке данных в столбец с поддержкой UTF-8.

|Тип данных буфера|Тип данных параметра|Преобразование|Меры предосторожности пользователя|
|---             |---                |---       |---            |
|DBTYPE_STR|DBTYPE_STR|Преобразование сервера из кодовой страницы клиента в кодовую страницу параметров сортировки базы данных; преобразование сервера из кодовой страницы параметров сортировки базы данных в кодовую страницу с параметрами сортировки столбцов.|Убедитесь, что кодовая страница клиента и кодовая страница параметров сортировки базы данных могут представлять все символы во входных данных. Например, для вставки польского символа кодовой странице клиента можно присвоить значение 1250 (ANSI центральноевропейские), а параметры сортировки базы данных могут использовать польский язык в качестве обозначения параметров сортировки (например, Polish_100_CI_AS_SC) или же включить UTF-8.|
|DBTYPE_STR|DBTYPE_WSTR|Преобразование драйвера из кодировки страницы клиента в кодировку UTF-16; преобразование сервера из кодировки UTF-16 в кодовую страницу с параметрами сортировки столбцов.|Убедитесь, что кодовая страница клиента может представлять все символы во входных данных. Например, чтобы вставить польский символ, можно присвоить кодовой странице клиента значение 1250 (ANSI центральноевропейские).|
|DBTYPE_WSTR|DBTYPE_STR|Преобразование драйвера из кодировки UTF-16 в кодовую страницу параметров сортировки базы данных; преобразование сервера из кодовой страницы параметров сортировки базы данных в кодовую страницу с параметрами сортировки столбцов.|Убедитесь, что кодовая страница параметров сортировки базы данных может представлять все символы во входных данных. Например, для вставки польского символа в кодовой странице параметров сортировки базы данных можно использовать польский в качестве обозначения параметров сортировки (например, Polish_100_CI_AS_SC) или же включить UTF-8.|
|DBTYPE_WSTR|DBTYPE_WSTR|Преобразование сервера из UTF-16 в кодовую страницу с параметрами сортировки столбцов.|Нет.|

## <a name="data-retrieval-from-a-utf-8-encoded-char-or-varchar-column"></a>Получение данных из столбца CHAR или VARCHAR в кодировке UTF-8
При создании буфера для извлеченных данных буфер описан с помощью массива [структур DBBINDING](https://go.microsoft.com/fwlink/?linkid=2071182). Каждая структура DBBINDING связывает один столбец в извлеченной строке. Для получения данных столбцов типа CHAR в параметре *wType* структуры DBBINDING установите значение DBTYPE_STR. Для получения данных столбцов типа WCHAR в параметре *wType* структуры DBBINDING установите значение DBTYPE_WSTR.

Для получения результирующего индикатора типа буфера DBTYPE_STR драйвер преобразует данные из кодировки UTF-8 в кодировку клиента. Пользователю необходимо убедится, что кодировка клиента может представить данные из столбца UTF-8. В противном случае может произойти потеря данных.

Для получения результирующего индикатора типа буфера DBTYPE_WSTR драйвер преобразует данные из кодировки UTF-8 в кодировку UTF-16.

<a name="ctp23"></a>

### <a name="utf-8-support-sql-server-2019-ctp-23"></a>Поддержка UTF-8 (SQL Server 2019 CTP 2.3)

[!INCLUDE[ss2019](../../../includes/sssqlv15-md.md)] обеспечивает полную поддержку широко используемой кодировки символов UTF-8 как кодировки импорта или экспорта или как параметров сортировки на уровне столбцов и базы данных для текстовых данных. Кодировка символов UTF-8 допускается в типах данных `CHAR` и `VARCHAR`. Она активируется при создании параметров сортировки с суффиксом `UTF8` или изменении существующих параметров на такие.

Например, `LATIN1_GENERAL_100_CI_AS_SC` меняется на `LATIN1_GENERAL_100_CI_AS_SC_UTF8`. UTF-8 доступна только для параметров сортировки Windows, которые поддерживают дополнительные символы, представленные в [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)]. `NCHAR` и `NVARCHAR` допускают только кодирование UTF-16 и остаются неизменными.

Эта функция может обеспечить значительную экономию места в хранилище в зависимости от используемой кодировки. Например, изменение имеющегося типа данных столбца со строками в кодировке ASCII (латинская) с `NCHAR(10)` на `CHAR(10)` с использованием параметров сортировки для UTF-8 на 50 % снижает требования к хранению. Это снижение связано с тем, что `NCHAR(10)` требует для хранения 20 байт, тогда как `CHAR(10)` требует 10 байт для той же строки Юникод.

Дополнительные сведения см. в статье [Collation and Unicode Support](../../../relational-databases/collations/collation-and-unicode-support.md).

В **CTP 2.1** добавлена возможность выбора параметров сортировки UTF-8 по умолчанию во время настройки [!INCLUDE[sql-server-2019](../../../includes/sssqlv15-md.md)].

В **CTP 2.2** добавлена поддержка использования кодировки UTF-8 с репликацией SQL Server.

В **CTP 2.3** добавлена поддержка использования кодировки UTF-8 с параметрами сортировки BIN2 (UTF8_BIN2).

## <a name="see-also"></a>См. также:  
[Возможности драйвера OLE DB для SQL Server](../../oledb/features/oledb-driver-for-sql-server-features.md) 

[Поддержка UTF-16 в драйвере OLE DB для SQL Server](../../oledb/features/utf-16-support-in-oledb-driver-for-sql-server.md)    
  
  
