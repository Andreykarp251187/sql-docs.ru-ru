---
title: Работа с уведомлениями о запросах | Документация Майкрософт
description: Работа с уведомлениями о запросах в драйвере OLE DB для SQL Server
ms.custom: ''
ms.date: 06/12/2018
ms.prod: sql
ms.prod_service: database-engine, sql-database, sql-data-warehouse, pdw
ms.reviewer: ''
ms.technology: connectivity
ms.topic: reference
helpviewer_keywords:
- data access [OLE DB Driver for SQL Server], query notifications
- rowsets [SQL Server], notifications
- OLE DB Driver for SQL Server, query notifications
- notifications [OLE DB Driver for SQL Server]
- query notifications [SQL Server], OLE DB Driver for SQL Server
- canceling rowset changes
- IRowsetNotify interface
- MSOLEDBSQL, query notifications
- OLE DB Driver for SQL Server, query notifications
- consumer notification for rowset changes [OLE DB Driver for SQL Server]
author: pmasl
ms.author: pelopes
ms.openlocfilehash: 5b563099b161fa9b55a72820edd3411a4c72b4fe
ms.sourcegitcommit: b2464064c0566590e486a3aafae6d67ce2645cef
ms.translationtype: MTE75
ms.contentlocale: ru-RU
ms.lasthandoff: 07/15/2019
ms.locfileid: "67988727"
---
# <a name="working-with-query-notifications"></a>Работа с уведомлениями запросов

[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md](../../../includes/appliesto-ss-xxxx-xxxx-xxx-md.md)]

[!INCLUDE[Driver_OLEDB_Download](../../../includes/driver_oledb_download.md)]

Уведомления о запросах появились [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] в и OLE DB драйвер для SQL Server. С помощью уведомлений о запросах, построенных на основе инфраструктуры компонента Service Broker, представленной в [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)], приложения могут получать извещения об изменениях данных. Эта функция особенно полезна для приложений, которые предоставляют кэш данных из базы данных (например, для веб-приложений), и которым требуются уведомления об изменении исходных данных.

С помощью уведомлений о запросах можно запрашивать уведомления в течение указанного времени ожидания при изменении базовых данных запроса. В запросе на уведомление указываются параметры уведомления, среди которых имя службы, текст сообщения и значение времени ожидания для сервера. Доставка уведомлений осуществляется через очередь компонента SQL Service Broker, которую приложения могут опрашивать на предмет имеющихся уведомлений.

Строка параметров уведомлений запросов имеет следующий синтаксис.

`service=<service-name>[;(local database=<database> | broker instance=<broker instance>)]`

 Пример:

`service=mySSBService;local database=mydb`

Подписки на уведомления переживают процесс, который их инициирует, поскольку приложение может создать подписку на уведомление, а затем завершиться. Подписка остается действительной, а уведомление будет отправлено в случае изменения данных в течение времени ожидания, указанного при создании подписки. Уведомление определяется выполненным запросом, параметрами уведомления, а также текстом сообщения. Его можно отменить, установив нуль в качестве значения времени ожидания.

Уведомления отправляются только один раз. Чтобы получать постоянные уведомления об изменении данных, необходимо создавать новую подписку после обработки каждого уведомления путем повторного выполнения запроса.

Приложения драйвера OLE DB для SQL Server обычно получают уведомления при помощи команды [RECEIVE](../../../t-sql/statements/receive-transact-sql.md) [!INCLUDE[tsql](../../../includes/tsql-md.md)], которая используется для чтения уведомлений из очереди, ассоциированной со службой (указанной в параметрах уведомления).

> [!NOTE]
> В запросах необходимо указывать имена таблиц, для которых требуется отправлять уведомления, например `dbo.myTable`. Имена таблиц должны состоять из двух частей. Подписка будет недействительной в случае использования трех- или четырехкомпонентных имен.

Инфраструктура уведомлений построена поверх функции запросов, которая появилась в [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)]. Как правило, уведомления, формируемые на сервере, отправляются через эти запросы для последующей обработки.

Чтобы использовать уведомления о запросах, очередь и служба должны существовать на сервере. Их можно создать при помощи [!INCLUDE[tsql](../../../includes/tsql-md.md)] следующим образом:

```sql
CREATE QUEUE myQueue
CREATE SERVICE myService ON QUEUE myQueue
([https://schemas.microsoft.com/SQL/Notifications/PostQueryNotification])
```

> [!NOTE]
> Служба должна использовать стандартный контракт, показанный выше.

## <a name="ole-db-driver-for-sql-server"></a>Драйвер OLE DB для SQL Server

Драйвер OLE DB для SQL Server поддерживает уведомление потребителя об изменении набора строк. Потребитель получает уведомление на каждой стадии изменения набора строк, а также при каждой попытке внести изменение.

> [!NOTE]
> Передача серверу запроса на уведомления с помощью **ICommand::Execute** является единственным допустимым способом подписки на уведомления о запросах с помощью драйвера OLE DB для SQL Server.

### <a name="the-dbpropsetsqlserverrowset-property-set"></a>Набор свойств DBPROPSET_SQLSERVERROWSET

Чтобы обеспечить поддержку отправки уведомлений о запросах через OLE DB, драйвер OLE DB добавляет в набор свойств DBPROPSET_SQLSERVERROWSET следующие новые свойства.

|Имя|Тип|Описание|
|----------|----------|-----------------|
|SSPROP_QP_NOTIFICATION_TIMEOUT|VT_UI4|время в секундах, в течение которого уведомление запроса должно оставаться активным.<br /><br /> Значение по умолчанию — 432 000 секунд (5 дней). Минимальное значение — 1 секунда, а максимальное значение — 2^31-1 секунд.|
|SSPROP_QP_NOTIFICATION_MSGTEXT|VT_BSTR|Текст сообщения уведомления. Определяется пользователем и не имеет стандартного формата.<br /><br /> По умолчанию эта строка пуста. В сообщении можно использовать от 1 до 2000 символов.|
|SSPROP_QP_NOTIFICATION_OPTIONS|VT_BSTR|параметры уведомлений о запросах. Эти параметры указываются в строке с использованием синтаксиса *имя*=*значение*. За создание службы и считывание уведомлений из очереди отвечает пользователь.<br /><br /> Значением по умолчанию является пустая строка.|

Подписка на уведомления всегда фиксируется независимо от того, выполнялась ли инструкция в рамках пользовательской транзакции или в режиме AUTO COMMIT, а также была ли транзакция, в рамках которой выполнялась инструкция, зафиксирована либо был выполнен ее откат. Уведомление сервера срабатывает при возникновении любого из следующих недопустимых условий: изменение базовых данных или схемы либо по истечении времени ожидания, в зависимости от того, что произойдет первым. Регистрации уведомлений удаляются сразу же после их срабатывания. Поэтому, если приложению требуется получение уведомлений в дальнейшем, оно должно подписаться на них снова сразу после получения уведомления.

Другое соединение или поток может проверять целевую очередь на наличие уведомлений. Пример:

```sql
WAITFOR (RECEIVE * FROM MyQueue); -- Where MyQueue is the queue name.
```

> [!NOTE]
> Инструкция SELECT * не удаляет какие-либо записи из очереди, а инструкция RECEIVE \* FROM удаляет. Если очередь пуста, поток сервера будет остановлен. При наличии в очереди записей в момент вызова они возвращаются мгновенно; в противном случае вызов ожидает появления записи в очереди.

```sql
RECEIVE * FROM MyQueue
```

Если очередь пуста, то эта инструкция немедленно возвращает пустой результирующий набор; в противном случае она возвращает все уведомления в очереди.

Если значение свойств SSPROP_QP_NOTIFICATION_MSGTEXT и SSPROP_QP_NOTIFICATION_OPTIONS не равно NULL и не является пустым, то при каждом выполнении этой команды на сервер отправляется заголовок потока табличных данных уведомлений о запросах, содержащий три свойства, указанные выше. Если значение любого из них равно NULL (или пустое), заголовок не отправляется, а формируется DB_E_ERRORSOCCURRED (или DB_S_ERRORSOCCURRED, если оба свойства обозначены, как необязательные), а значение состояния устанавливается в DBPROPSTATUS_BADVALUE. Поверка выполняется в случае команды Execute/Prepare. Точно так же DB_S_ERRORSOCCURED формируется при задании свойств уведомлений о запросах для установления соединений с [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] версий младше [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)]. В этом случае значение состояния — DBPROPSTATUS_NOTSUPPORTED.

Запуск подписки не гарантирует успешной доставки последующих сообщений. Кроме того, допустимость указанного имени службы также не проверяется.

> [!NOTE]
> При подготовке инструкций подписка никогда не запускается. Запуск подписки происходит только при выполнении инструкций, а использование базовых служб OLE DB не оказывает влияния на уведомления о запросах.

Дополнительные сведения о наборе свойств DBPROPSET_SQLSERVERROWSET см. в разделе [Свойства и поведение набора строк](../../oledb/ole-db-rowsets/rowset-properties-and-behaviors.md).

## <a name="see-also"></a>См. также:

[Возможности драйвера OLE DB для SQL Server](../../oledb/features/oledb-driver-for-sql-server-features.md)
