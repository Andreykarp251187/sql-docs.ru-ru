---
title: Работа с уведомлениями о запросах | Документация Майкрософт
description: Работа с уведомлениями о запросах в драйвере OLE DB для SQL Server
ms.custom: ''
ms.date: 06/12/2018
ms.prod: sql
ms.prod_service: database-engine, sql-database, sql-data-warehouse, pdw
ms.reviewer: ''
ms.technology: connectivity
ms.topic: reference
helpviewer_keywords:
- data access [OLE DB Driver for SQL Server], query notifications
- rowsets [SQL Server], notifications
- OLE DB Driver for SQL Server, query notifications
- notifications [OLE DB Driver for SQL Server]
- query notifications [SQL Server], OLE DB Driver for SQL Server
- canceling rowset changes
- IRowsetNotify interface
- MSOLEDBSQL, query notifications
- OLE DB Driver for SQL Server, query notifications
- consumer notification for rowset changes [OLE DB Driver for SQL Server]
author: pmasl
ms.author: pelopes
ms.openlocfilehash: 29aaab523b3a754c65b1b7a0312ceb5ea122f2d3
ms.sourcegitcommit: 1f222ef903e6aa0bd1b14d3df031eb04ce775154
ms.translationtype: MTE75
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2019
ms.locfileid: "68419315"
---
# <a name="working-with-query-notifications"></a>Работа с уведомлениями о запросах

[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md](../../../includes/appliesto-ss-xxxx-xxxx-xxx-md.md)]

[!INCLUDE[Driver_OLEDB_Download](../../../includes/driver_oledb_download.md)]

Уведомления о запросах появились [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] в и OLE DB драйвер для SQL Server. Они опираются на инфраструктуру SQL Service Broker, появившуюся в SQL Server 2005 (9.x), и позволяют приложениям узнавать об изменении данных. Данная возможность особенно полезна для приложений, которые кэшируют информацию из базы (например, веб-приложения), и которым требуются уведомления об изменении исходных данных.

С помощью уведомлений о запросах можно запрашивать уведомления в течение заданного времени ожидания при изменении базовых данных запроса. В запросе указываются параметры уведомления, включающие имя службы, текст сообщения и значение времени ожидания для сервера. Доставка уведомлений осуществляется через очередь Service Broker, которую приложения могут опрашивать на наличие уведомлений.

Строка параметров уведомлений запросов имеет следующий синтаксис.

`service=<service-name>[;(local database=<database> | broker instance=<broker instance>)]`

 Пример:

`service=mySSBService;local database=mydb`

Подписки на уведомления проживают процесс, который их инициирует. Это связано с тем, что приложение может создать подписку на уведомления, а затем завершить работу. Подписка остается действительной, и уведомление отправляется в случае изменения данных в течение времени ожидания, указанного при создании подписки. Уведомление идентифицируется выполненным запросом, параметрами уведомления и текстом сообщения. Вы можете отменить его, установив значение времени ожидания равным нулю.

Уведомления отправляются только один раз. Чтобы постоянно получать уведомления об изменениях данных, создайте новую подписку, повторно выполнив запрос после обработки каждого уведомления.

Драйвер OLE DB для SQL Server приложений обычно получает уведомления с помощью [!INCLUDE[tsql](../../../includes/tsql-md.md)] команды [Receive](../../../t-sql/statements/receive-transact-sql.md) . Эта команда используется для чтения уведомлений из очереди, связанной со службой, указанной в параметрах уведомления.

> [!NOTE]
> В запросах нужно указывать имена таблиц, для которых необходимы уведомления. Например, `dbo.myTable`. Имена таблиц должны состоять из двух частей. Подписка будет недействительной в случае использования трех- или четырехкомпонентных имен.

Инфраструктура уведомлений построена поверх функции запросов, которая появилась в [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)]. Как правило, формируемые на сервере уведомления отправляются через эти очереди для последующей обработки.

Для использования уведомлений о запросах на сервере должны существовать очередь и служба. Их можно создать с помощью [!INCLUDE[tsql](../../../includes/tsql-md.md)] команды следующим образом:

```sql
CREATE QUEUE myQueue
CREATE SERVICE myService ON QUEUE myQueue
([https://schemas.microsoft.com/SQL/Notifications/PostQueryNotification])
```

> [!NOTE]
> Служба должна использовать стандартный контракт, как показано выше.

## <a name="ole-db-driver-for-sql-server"></a>Драйвер OLE DB для SQL Server

Драйвер OLE DB для SQL Server поддерживает уведомления потребителей при изменении набора строк. Объекту-получателю приходит уведомление на каждом этапе изменения набора строк и при каждой попытке внести изменение.

> [!NOTE]
> Передача серверу запроса на уведомления с помощью **ICommand::Execute** является единственным допустимым способом подписки на уведомления о запросах с помощью драйвера OLE DB для SQL Server.

### <a name="dbpropsetsqlserverrowset-property-set"></a>Набор свойств DBPROPSET_SQLSERVERROWSET

Чтобы обеспечить поддержку уведомлений о запросах через OLE DB, драйвер OLE DB Driver for SQL Server добавляет в набор свойств `DBPROPSET_SQLSERVERROWSET` следующие новые свойства.

|Имя|Тип|Описание|
|----------|----------|-----------------|
|SSPROP_QP_NOTIFICATION_TIMEOUT|VT_UI4|время в секундах, в течение которого уведомление запроса должно оставаться активным.<br /><br /> Значение по умолчанию — 432 000 секунд (5 дней). Минимальное значение — 1 секунда, а максимальное значение — 2^31-1 секунд.|
|SSPROP_QP_NOTIFICATION_MSGTEXT|VT_BSTR|Текст сообщения уведомления. Этот текст определяется пользователем и не имеет стандартного формата.<br /><br /> По умолчанию эта строка пуста. Укажите сообщение с символами от 1 до 2000.|
|SSPROP_QP_NOTIFICATION_OPTIONS|VT_BSTR|параметры уведомлений о запросах. Эти параметры указываются в строке с использованием синтаксиса *имя*=*значение*. За создание службы и считывание уведомлений из очереди отвечает пользователь.<br /><br /> Значением по умолчанию является пустая строка.|

Подписка на уведомления всегда фиксируется. Это происходит независимо от того, выполнялась ли инструкция в пользовательской транзакции или в процессе автоматической фиксации или транзакция, в которой инструкция зафиксирована или выполнила откат. Уведомление сервера срабатывает при возникновении любого из следующих недопустимых условий: изменение базовых данных или схемы либо по истечении времени ожидания, в зависимости от того, что произойдет первым. 

Регистрации уведомлений удаляются сразу же после их срабатывания. Поэтому при получении уведомления приложение должно вновь подписаться, чтобы получать дальнейшие сведения.

Другое соединение или поток может проверять целевую очередь на наличие уведомлений. Пример:

```sql
WAITFOR (RECEIVE * FROM MyQueue); -- Where MyQueue is the queue name.
```

> [!NOTE]
> `SELECT *`не удаляет запись из очереди. `RECEIVE * FROM` Однако. Если очередь пуста, поток сервера будет остановлен. Если во время вызова есть записи очереди, они возвращаются немедленно. В противном случае вызов ожидает до тех пор, пока не будет выполнена запись в очередь.

```sql
RECEIVE * FROM MyQueue
```

Эта инструкция немедленно возвращает пустой результирующий набор, если очередь пуста. В противном случае он возвращает все уведомления очереди.

Если `SSPROP_QP_NOTIFICATION_MSGTEXT` и`SSPROP_QP_NOTIFICATION_OPTIONS` не равны NULL и не являются пустыми, Заголовок TDS уведомлений о запросах, содержащий три указанных выше свойства, отправляются на сервер. Это происходит при каждом выполнении команды. Если один из них имеет значение null (или пустое), заголовок не отправляется и `DB_E_ERRORSOCCURRED` вызывается (или `DB_S_ERRORSOCCURRED` вызывается, если свойства помечены как необязательные). Затем в качестве значения состояния задается `DBPROPSTATUS_BADVALUE`значение. Проверка выполняется после выполнения и подготовки. Аналогичным образом выдается `DB_S_ERRORSOCCURED`, если свойства уведомлений о запросах заданы для подключений к [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] версий до [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)]. Значение состояния в данном случае — `DBPROPSTATUS_NOTSUPPORTED`.

Активация подписки не гарантирует доставки последующих сообщений. Кроме того, допустимость указанного имени службы не проверяется.

> [!NOTE]
> Подготовка инструкций никогда не приведет к инициации подписки. Инициация выполняется только при выполнении инструкций. Уведомления о запросах не затрагиваются использованием служб OLE DB Core.

Дополнительные сведения о наборе `DBPROPSET_SQLSERVERROWSET` свойств см. в разделе [Свойства и поведение набора строк](../../oledb/ole-db-rowsets/rowset-properties-and-behaviors.md).

## <a name="see-also"></a>См. также раздел

[Возможности драйвера OLE DB для SQL Server](../../oledb/features/oledb-driver-for-sql-server-features.md)
