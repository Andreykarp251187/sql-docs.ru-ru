---
title: Поддержка высокого уровня доступности и аварийное восстановление для драйверов Майкрософт для PHP для SQL Server | Документация Майкрософт
ms.custom: ''
ms.date: 07/31/2018
ms.prod: sql
ms.prod_service: connectivity
ms.reviewer: ''
ms.technology: connectivity
ms.topic: conceptual
ms.assetid: 73a80821-d345-4fea-b076-f4aabeb4af3e
author: MightyPen
ms.author: genemi
manager: jroth
ms.openlocfilehash: 5e0ad826c8846330c7207b14ac2344687563bbfa
ms.sourcegitcommit: ad2e98972a0e739c0fd2038ef4a030265f0ee788
ms.translationtype: MTE75
ms.contentlocale: ru-RU
ms.lasthandoff: 06/07/2019
ms.locfileid: "66797106"
---
# <a name="support-for-high-availability-disaster-recovery"></a>Поддержка высокого уровня доступности и аварийного восстановления
[!INCLUDE[Driver_PHP_Download](../../includes/driver_php_download.md)]

В этом разделе приведены сведения о поддержке в [!INCLUDE[ssDriverPHP](../../includes/ssdriverphp_md.md)] (начиная с версии 3.0) аварийного восстановления и высокой доступности — [!INCLUDE[ssHADR](../../includes/sshadr_md.md)].  Поддержка [!INCLUDE[ssHADR](../../includes/sshadr_md.md)] была добавлена в [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)]. Дополнительные сведения о среде [!INCLUDE[ssHADR](../../includes/sshadr_md.md)]см. в электронной документации по [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .  
  
[!INCLUDE[ssDriverPHP](../../includes/ssdriverphp_md.md)] версии 3.0 позволяет указать в строке подключения прослушиватель группы доступности (аварийного восстановления, высокой доступности). Если приложение [!INCLUDE[ssDriverPHP](../../includes/ssdriverphp_md.md)] подключается к базе данных AlwaysOn, которая выполняет отработку отказа, то первоначальное подключение разрывается и приложение должно открыть новое подключение, чтобы продолжить работу после обработки отказа.  
  
Если вы не подключаетесь к прослушивателю группы доступности, а с именем узла связано множество IP-адресов, то [!INCLUDE[ssDriverPHP](../../includes/ssdriverphp_md.md)] последовательно переберет все IP-адреса, связанные с записью DNS. Это может занять много времени, если первый IP-адрес, возвращенный DNS-сервером, не привязан ни к одной из сетевых интерфейсных плат. При подключении к прослушивателю группы доступности [!INCLUDE[ssDriverPHP](../../includes/ssdriverphp_md.md)] пытается установить подключение ко всем IP-адресам параллельно, и если одна из попыток окажется успешной, драйвер отменит остальные ожидающие попытки подключения.  
  
> [!NOTE]  
> Увеличение времени ожидания соединения и реализация логики повторного соединения позволяют повысить вероятность соединения приложения с группой доступности. Кроме того, в связи с возможностью неудачного подключения при отработке отказа группы доступности следует реализовать логику повторного соединения, обеспечивающую неограниченное число попыток соединения до достижения успеха.  
  
## <a name="connecting-with-multisubnetfailover"></a>Соединение с помощью MultiSubnetFailover  
Свойство подключения **MultiSubnetFailover** указывает, что приложение развертывается в группе доступности или экземпляре отказоустойчивого кластера, а также что [!INCLUDE[ssDriverPHP](../../includes/ssdriverphp_md.md)] попытается подключиться ко всем IP-адресам базы данных в первичном экземпляре [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Когда для подключения установлено свойство **MultiSubnetFailover=true**, клиент будет пытаться повторно установить TCP-подключение с более частым интервалом, чем заданные в операционной системе интервалы повторной отправки TCP-пакетов по умолчанию. Это позволяет ускорить восстановление соединения после отработки отказа в группе доступности AlwaysOn или в экземпляре отказоустойчивого кластера AlwaysOn; метод может применяться к группам доступности и экземплярам отказоустойчивых кластеров как с одной, так и с несколькими подсетями.  
  
Всегда задавайте **MultiSubnetFailover=True** при подключении к прослушивателю группы доступности или экземпляру отказоустойчивого кластера SQL Server 2012. **MultiSubnetFailover** позволяет всем группам доступности и экземпляру отказоустойчивого кластера в SQL Server 2012 быстрее выполнить отработку отказа, а также значительно сократить время ее выполнения в топологиях AlwaysOn с одной или множеством подсетей. При отработке отказа с в нескольких подсетях клиент будет выполнять попытки соединения параллельно. При отработке отказа подсети [!INCLUDE[ssDriverPHP](../../includes/ssdriverphp_md.md)] будет активно повторять попытки установить TCP-подключение.  
  
Дополнительные сведения о ключевых словах строки подключения в [!INCLUDE[ssDriverPHP](../../includes/ssdriverphp_md.md)], см. в разделе [параметры соединения](../../connect/php/connection-options.md).  
  
Задание **MultiSubnetFailover=true** при подключении к объекту, отличному от прослушивателя группы доступности или экземпляра отказоустойчивого кластера, может привести к снижению производительности и не поддерживается.  
  
Следуйте приведенным ниже рекомендациям для соединения с сервером в группе доступности.  
  
-   Пользуйтесь свойством соединения **MultiSubnetFailover** при установлении соединения с одной или несколькими подсетями, это благоприятно скажется на производительности в любом случае.  
  
-   Чтобы установить соединение с группой доступности, указывайте ее прослушиватель в строке подключения вместо сервера.  
  
-   При установлении соединения с экземпляром [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], настроенным на работу с более чем 64 IP-адресами, будет возникать ошибка соединения.  
  
-   Режим работы приложения, использующего свойство соединения **MultiSubnetFailover**, не зависит от типа проверки подлинности — [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], Kerberos или Windows.  
  
-   Значение **loginTimeout** можно увеличить с учетом времени отработки отказа и для уменьшения количества попыток приложения повторно установить подключение.  
  
-   Распределенные транзакции не поддерживаются.  
  
Если маршрутизация только для чтения неактивна, то подключение к местоположению вторичной реплики в группе доступности завершится ошибкой в следующих случаях:  
  
- Если местоположение вторичных реплик не настроено для приема подключений.  
  
- Если приложение использует **ApplicationIntent=ReadWrite** (описано ниже) и расположение вторичных реплик настроено для доступа только для чтения.  
  
При соединении произойдет ошибка, если первичная реплика настроена для отклонения рабочих нагрузок только для чтения, а строка подключения содержит **ApplicationIntent=ReadOnly**.  

## <a name="transparent-network-ip-resolution-tnir"></a>Прозрачное разрешение IP-адресов сети (TNIR)

Прозрачного разрешения IP-адрес в сети (TNIR) — это версии функции существующего MultiSubnetFailover. Это влияет на время подключения драйвера, устраняется первый IP-адрес имени узла не отвечает, и существует несколько IP-адресов, связанный с именем узла. Вместе с MultiSubnetFailover они предоставляют следующие четыре подключения последовательности: 

- Включить TNIR & MultiSubnetFailover отключено: выполняется попытка одного IP-адреса, следуют все IP-адреса в параллельном режиме
- Включить TNIR & MultiSubnetFailover включено: все IP-адреса попытки подключения выполняются в параллельном режиме
- Отключенные TNIR & MultiSubnetFailover отключено: применяются все IP-адреса друг за другом
- Отключенные TNIR & MultiSubnetFailover включено: все IP-адреса попытки подключения выполняются в параллельном режиме

TNIR включена по умолчанию, и MultiSubnetFailover отключена по умолчанию.

Это пример включения TNIR и MultiSubnetFailover, с помощью драйвера PDO_SQLSRV:

```
<?php
$serverName = "yourservername";
$username = "yourusername";
$password = "yourpassword";
$connectionString = "sqlsrv:Server=$serverName; TransparentNetworkIPResolution=Enabled; MultiSubnetFailover=yes";
try {
    $conn = new PDO($connectionString, $username, $password, array(PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION));
    // your code 
    // more of your code
    // when done, close the connection
    unset($conn);
} catch(PDOException $e) {
    print_r($e->errorInfo);
}
?>
```

## <a name="upgrading-to-use-multi-subnet-clusters-from-database-mirroring"></a>Переход с зеркального отображения базы данных на использование кластеров с несколькими подсетями  
Если в строке подключения содержатся ключевые слова **MultiSubnetFailover** и **Failover_Partner**, то при соединении произойдет ошибка. Ошибка возникает также в том случае, если используется **MultiSubnetFailover** и [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] возвращает ответ партнера по обеспечению отработки отказа, указывающий на то, что он является частью пары зеркальных баз данных.  
  
При переводе приложения [!INCLUDE[ssDriverPHP](../../includes/ssdriverphp_md.md)], которое сейчас использует зеркальное отображение базы данных, на сценарий с использованием множества подсетей необходимо удалить свойство подключения **Failover_Partner**, заменив его свойством **MultiSubnetFailover** со значением **Yes**, а имя сервера в строке подключения — прослушивателем группы доступности. Если в строке подключения используются **Failover_Partner** и **MultiSubnetFailover=true**, то драйвер выдаст ошибку. Но если в строке подключения используются параметры **Failover_Partner** и **MultiSubnetFailover=false** (или **ApplicationIntent=ReadWrite**), то приложение будет использовать зеркальное отображение базы данных.  
  
Если зеркальное отображение базы данных применяется к базе данных-источнику группы доступности, то драйвер вернет ошибку. Это также произойдет при использовании параметра **MultiSubnetFailover=true** в строке подключения, относящейся к базе данных-источнику, а не к прослушивателю группы доступности.  


[!INCLUDE[specify-application-intent_read-only-routing](~/includes/paragraph-content/specify-application-intent-read-only-routing.md)]


## <a name="see-also"></a>См. также:  
[Подключение к серверу](../../connect/php/connecting-to-the-server.md)  
  
