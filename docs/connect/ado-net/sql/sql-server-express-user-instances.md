---
title: Пользовательские экземпляры SQL Server Express
description: Описание поддержки SQL Server Express пользовательских экземпляров.
ms.date: 08/15/2019
dev_langs:
- csharp
ms.assetid: 00c12376-cb26-4317-86ad-e6e9c089be57
ms.prod: sql
ms.prod_service: connectivity
ms.technology: connectivity
ms.topic: conceptual
author: v-kaywon
ms.author: v-kaywon
ms.reviewer: rothja
ms.openlocfilehash: 3b3ac1e395cc1240693ca0dc27324766964e0cfa
ms.sourcegitcommit: 9c993112842dfffe7176decd79a885dbb192a927
ms.translationtype: MTE75
ms.contentlocale: ru-RU
ms.lasthandoff: 10/16/2019
ms.locfileid: "72452012"
---
# <a name="sql-server-express-user-instances"></a>Пользовательские экземпляры SQL Server Express

![Download-DownArrow-Circled](../../../ssdt/media/download.png)[Скачать ADO.NET](../../sql-connection-libraries.md#anchor-20-drivers-relational-access)

Microsoft SQL Server Express Edition (SQL Server Express) поддерживает функцию пользовательского экземпляра, которая доступна только при использовании поставщика данных Microsoft SqlClient для SQL Server. Пользовательский экземпляр — это отдельный экземпляр SQL Server Express ядро СУБД, созданный родительским экземпляром. Пользовательские экземпляры позволяют пользователям, не являющимся администраторами на локальных компьютерах, присоединяться к базам данных SQL Server Express и подключаться к ним. Каждый экземпляр выполняется в контексте безопасности отдельного пользователя на основе одного экземпляра на уровне пользователя.  
  
## <a name="user-instance-capabilities"></a>Возможности пользовательских экземпляров  
Пользовательские экземпляры полезны для пользователей, работающих под управлением Windows с учетной записью с минимальными правами доступа (LUA), так как каждый пользователь имеет SQL Server привилегии системного администратора (`sysadmin`) для экземпляра, работающего на компьютере, без необходимости запуска в качестве Windows. также администратор. Программное обеспечение, выполняемое в пользовательском экземпляре с ограниченными разрешениями, не может вносить изменения на уровне системы, так как экземпляр SQL Server Express работает под учетной записью пользователя без прав администратора Windows, а не как служба. Каждый пользовательский экземпляр изолирован от родительского и любых других пользовательских экземпляров, выполняющихся на том же компьютере. Базы данных, запущенные в пользовательском экземпляре, открываются только в однопользовательском режиме, и несколько пользователей не могут подключаться к базам данных, запущенным в пользовательском экземпляре. Репликация и распределенные запросы также отключаются для пользовательских экземпляров.  
  
Дополнительные сведения см. в разделе "Пользовательские экземпляры" электронной документации на SQL Server.  
  
> [!NOTE]
>  Пользовательские экземпляры не требуются для пользователей, которые уже являются администраторами на своих компьютерах, или для сценариев, включающих несколько пользователей базы данных.  
  
## <a name="enabling-user-instances"></a>Включение пользовательских экземпляров  
Для создания пользовательских экземпляров должен выполняться родительский экземпляр SQL Server Express. Пользовательские экземпляры по умолчанию включаются, если установлен SQL Server Express, и они могут быть явно включаться или отключаться системным администратором, выполняющим системную хранимую процедуру **sp_configure** в родительском экземпляре.  
  
```sql
-- Enable user instances.  
sp_configure 'user instances enabled','1'   
  
-- Disable user instances.  
sp_configure 'user instances enabled','0'  
```  
  
Сетевой протокол для пользовательских экземпляров должен быть локальным именованным каналом. Пользовательский экземпляр не может быть запущен на удаленном экземпляре SQL Server, а SQL Server имена входа не допускаются.  
  
## <a name="connecting-to-a-user-instance"></a>Подключение к пользовательскому экземпляру  
Ключевые слова `User Instance` и `AttachDBFilename`<xref:Microsoft.Data.SqlClient.SqlConnection.ConnectionString%2A> разрешают подключение <xref:Microsoft.Data.SqlClient.SqlConnection> к пользовательскому экземпляру. Пользовательские экземпляры также поддерживаются <xref:Microsoft.Data.SqlClient.SqlConnectionStringBuilder> свойствами `UserInstance` и `AttachDBFilename`.  
  
Обратите внимание на следующие сведения о образце строки подключения, показанной ниже.  
  
- Ключевое слово `Data Source` относится к родительскому экземпляру SQL Server Express, создающему пользовательский экземпляр. Экземпляр по умолчанию — .\склекспресс.  
  
- `Integrated Security` задан как `true`. Для подключения к пользовательскому экземпляру требуется проверка подлинности Windows. SQL Server имена входа не поддерживаются.  
  
- `User Instance` имеет значение `true`, которое вызывает пользовательский экземпляр. (Значение по умолчанию — `false`.)  
  
- Ключевое слово строки подключения `AttachDbFileName` используется для присоединения файла базы данных-источника (MDF), который должен включать полный путь. `AttachDbFileName` также соответствует ключам "Расширенные свойства" и "Initial File Name" в строке подключения <xref:Microsoft.Data.SqlClient.SqlConnection>.  
  
- Строка подстановки `|DataDirectory|`, заключенная в символы канала, ссылается на каталог данных приложения, открывающего соединение, и предоставляет относительный путь, указывающий расположение базы данных mdf и LDF и файлы журналов. Если вы хотите разместить эти файлы в других местах, необходимо указать полный путь к файлам.  
  
```console
Data Source=.\\SQLExpress;Integrated Security=true;  
User Instance=true;AttachDBFilename=|DataDirectory|\InstanceDB.mdf;  
Initial Catalog=InstanceDB;  
```  
  
> [!NOTE]
>  Для создания строки подключения во время выполнения можно также использовать свойства <xref:Microsoft.Data.SqlClient.SqlConnectionStringBuilder> <xref:Microsoft.Data.SqlClient.SqlConnectionStringBuilder.UserInstance%2A> и <xref:Microsoft.Data.SqlClient.SqlConnectionStringBuilder.AttachDBFilename%2A>.  
  
### <a name="using-the-124datadirectory124-substitution-string"></a>&#124;Использование строки&#124; подстановки DataDirectory  
Строка подстановки `DataDirectory` в сочетании со свойством `AttachDbFileName` позволяет указать относительный путь к файлу данных, тем самым позволяя разработчикам создавать строки соединения относительно пути к источнику данных.  
  
Физическое расположение, на которое `DataDirectory` указывает, зависит от типа приложения. В этом примере вложенный файл Northwind. mdf находится в папке \app_data приложения.  
  
```console
Data Source=.\\SQLExpress;Integrated Security=true;  
User Instance=true;  
AttachDBFilename=|DataDirectory|\app_data\Northwind.mdf;  
Initial Catalog=Northwind;  
```  
  
При использовании `DataDirectory` результирующий путь к файлу не может быть выше в структуре каталога, чем каталог, на который указывает строка подстановки. Например, если полностью развернутая `DataDirectory` — C:\AppDirectory\app_data, то показанная выше пример строки подключения работает так, как показано ниже К:\аппдиректори. Но попытка задать `DataDirectory` как `|DataDirectory|\..\data` завершится ошибкой, потому что \data не является подкаталогом \AppDirectory.  
  
Если строка подключения имеет неверно отформатированную строку подстановки, будет выдано исключение <xref:System.ArgumentException>.  
  
> [!NOTE]
>  <xref:Microsoft.Data.SqlClient> разрешает строки подстановки в полные пути к файловой системе локального компьютера. Таким образом, имена путей удаленного сервера, HTTP и UNC не поддерживаются. Исключение возникает при открытии соединения, если сервер не находится на локальном компьютере.  
  
При открытии <xref:Microsoft.Data.SqlClient.SqlConnection> он перенаправляется с экземпляра SQL Server Express по умолчанию на экземпляр, запущенный во время выполнения, который выполняется под учетной записью вызывающего объекта.  
  
> [!NOTE]
>  Может потребоваться увеличить значение <xref:Microsoft.Data.SqlClient.SqlConnection.ConnectionTimeout%2A>, так как для загрузки пользовательских экземпляров может потребоваться больше времени, чем для обычных экземпляров.  
  
Следующий фрагмент кода открывает новый `SqlConnection`, отображает строку подключения в окне консоли, а затем закрывает соединение при выходе из блока кода `using`.  
  
```csharp  
private static void OpenSqlConnection()  
{  
    // Retrieve the connection string.  
    string connectionString = GetConnectionString();  
  
    using (SqlConnection connection =   
        new SqlConnection(connectionString))  
    {  
        connection.Open();  
        Console.WriteLine("ConnectionString: {0}",   
             connection.ConnectionString);  
    }  
}  
```  
  
> [!NOTE]
>  Пользовательские экземпляры не поддерживаются в коде среды CLR, который выполняется в SQL Server. Если для <xref:Microsoft.Data.SqlClient.SqlConnection>, в котором `User Instance=true` в строке подключения, вызывается `Open`, выдается <xref:System.InvalidOperationException>.  
  
## <a name="lifetime-of-a-user-instance-connection"></a>Время существования соединения с пользовательским экземпляром  
В отличие от версий SQL Server, которые запускаются как службы, SQL Server Express экземпляры не нужно запускать и останавливать вручную. Каждый раз, когда пользователь входит в систему и подключается к пользовательскому экземпляру, Пользовательский экземпляр запускается, если он еще не запущен. Для баз данных пользовательских экземпляров задан параметр `AutoClose`, что позволяет автоматически завершать работу базы данных по истечении определенного периода бездействия. Запущенный процесс Sqlservr. exe выполняется в течение ограниченного времени ожидания после закрытия последнего соединения с экземпляром, поэтому его не нужно перезапускать при открытии другого соединения до истечения времени ожидания. Пользовательский экземпляр автоматически завершает работу, если не открыто новое подключение до истечения времени ожидания. Администратор системы на родительском экземпляре может устанавливать длительность времени ожидания для пользовательского экземпляра при помощи процедуры **sp_configure**, которая изменяет параметр **user instance timeout**. Значение по умолчанию — 60 минут.  
  
> [!NOTE]
>  Если в строке подключения используется `Min Pool Size` со значением больше нуля, то пул подключений всегда будет поддерживать несколько открытых подключений, и пользовательский экземпляр не завершит работу автоматически.  
  
## <a name="how-user-instances-work"></a>Как работают пользовательские экземпляры  
При первом создании пользовательского экземпляра для любого пользователя системные базы данных **master** и **msdb** копируются из папки Template Data в локальный пользовательский каталог-репозиторий для монопольного использования пользовательским экземпляром. Обычно этот путь `C:\Documents and Settings\<UserName>\Local Settings\Application Data\Microsoft\Microsoft SQL Server Data\SQLEXPRESS`. При запуске пользовательского экземпляра база данных **tempdb** журнал и файлы трассировки также записываются в этот каталог. Для экземпляра создается имя, которое гарантированно уникально для каждого пользователя.  
  
По умолчанию всем членам группы Builtin \ пользователи Windows предоставляются разрешения на подключение к локальному экземпляру, а также разрешения на чтение и выполнение для двоичных файлов SQL Server. После проверки учетных данных вызывающего пользователя, размещающего пользовательский экземпляр, этот пользователь станет `sysadmin` на этом экземпляре. Для пользовательских экземпляров включена только общая память. Это означает, что возможны только операции на локальном компьютере.  
  
Пользователям должны быть предоставлены разрешения на чтение и запись для файлов MDF и LDF, указанных в строке подключения.  
  
> [!NOTE]
>  MDF и LDF представляют файлы базы данных и журнала соответственно. Эти два файла соответствуют набору, поэтому во время операций резервного копирования и восстановления следует соблюдать осторожность. Файл базы данных содержит сведения о точной версии файла журнала, и база данных не будет открываться, если она связана с неверным файлом журнала.  
  
Чтобы избежать повреждения данных, база данных в пользовательском экземпляре открывается с монопольным доступом. Если два разных экземпляра пользователя совместно используют одну и ту же базу данных на одном компьютере, пользователь первого экземпляра должен закрыть базу данных, прежде чем ее можно будет открыть во втором экземпляре.  
  
## <a name="user-instance-scenarios"></a>Сценарии пользовательских экземпляров  
Пользовательские экземпляры предоставляют разработчикам приложений баз данных SQL Server хранилище данных, которое не зависит от разработчиков, имеющих административные учетные записи на компьютерах разработки. Пользовательские экземпляры основаны на модели Access/Jet, где приложение базы данных просто подключается к файлу, и пользователь автоматически получает полный набор разрешений на все объекты базы данных, не требуя от администратора предоставлять чтение. Она предназначена для работы в ситуациях, когда пользователь работает с учетной записью пользователя с минимальными правами доступа (LUA) и не имеет прав администратора на сервере или на локальном компьютере, но требует создания объектов базы данных и приложений. Пользовательские экземпляры позволяют пользователям создавать экземпляры во время выполнения, которые выполняются под собственным контекстом безопасности пользователя, а не в контексте безопасности более привилегированной системной службы.  
  
> [!IMPORTANT]
>  Пользовательские экземпляры следует использовать только в сценариях, где все приложения, использующие его, являются полностью доверенными.  
  
Сценарии пользовательских экземпляров включают:  
  
- Любое приложение с одним пользователем, в котором совместное использование данных не требуется.  
  
- Развертывание ClickOnce. Если .NET Framework 2.0 (или более поздняя версия) либо .NET Core 1.0 (или более поздняя версия), а также SQL Server Express уже установлены на целевом компьютере, пакет установки, загруженный как результат действия ClickOnce, может быть установлен и использован пользователями, не имеющими административных привилегий. Обратите внимание, что администратор должен установить SQL Server Express, если он является частью программы установки. Дополнительные сведения см. в статье [Развертывание ClickOnce для Windows Forms](https://docs.microsoft.com/dotnet/framework/winforms/clickonce-deployment-for-windows-forms).
  
- Выделенное размещение ASP.NET с использованием проверки подлинности Windows. Один экземпляр SQL Server Express может размещаться в интрасети. Приложение подключается с помощью учетной записи ASPNET Windows, а не олицетворения. Пользовательские экземпляры не следует использовать для сценариев сторонних разработчиков или совместного размещения, где все приложения совместно используют один и тот же пользовательский экземпляр и больше не будут оставаться изолированными друг от друга.  
  
## <a name="next-steps"></a>Дальнейшие действия
- [SQL Server и ADO.NET](index.md)
