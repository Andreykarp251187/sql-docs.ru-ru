---
title: Транзакции и операции массового копирования
description: Сведения о том, как выполнить операцию массового копирования в рамках транзакции, в том числе как зафиксировать или откатить эту транзакцию.
ms.date: 08/15/2019
dev_langs:
- csharp
ms.assetid: f6f0cbc9-f7bf-4d6e-875f-ad1ba0b4aa62
ms.prod: sql
ms.prod_service: connectivity
ms.technology: connectivity
ms.topic: conceptual
author: David-Engel
ms.author: v-daenge
ms.reviewer: v-kaywon
ms.openlocfilehash: 82e7e9b5dcae2f3878104757823112022064d7e6
ms.sourcegitcommit: fe5c45a492e19a320a1a36b037704bf132dffd51
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80918521"
---
# <a name="transaction-and-bulk-copy-operations"></a>Транзакции и операции массового копирования

[!INCLUDE[Driver_ADONET_Download](../../../includes/driver_adonet_download.md)]

Операции массового копирования могут выполняться как изолированные операции или как часть многошаговой транзакции. В последнем случае вы можете выполнить более одной операции массового копирования в одной транзакции, а также выполнять другие операции с базами данных (такие как вставка, обновление и удаление) с возможностью фиксации или отката всей транзакции.  
  
По умолчанию операция массового копирования выполняется как изолированная. Операция массового копирования выполняется не как транзакция и без возможности отката. Если необходимо выполнить откат всей или части операции массового копирования при возникновении ошибки, можно использовать управляемую <xref:Microsoft.Data.SqlClient.SqlBulkCopy> транзакцию, выполнить операцию массового копирования в существующей транзакции или прикрепиться к **System.Transactions**<xref:System.Transactions.Transaction>.  
  
## <a name="performing-a-non-transacted-bulk-copy-operation"></a>Выполнение операции массового копирования без транзакции  
Следующее консольное приложение показывает, что происходит, когда во время операции массового копирования без транзакции возникает ошибка.  
  
В этом примере и таблица источника, и целевая таблица включают столбец `Identity`, именуемый **ProductID**. Сначала код подготавливает целевую таблицу, удаляя все строки и вставляя одну строку, у которой **ProductID** точно существует в исходной таблице. По умолчанию в целевой таблице для каждой добавляемой строки создается новое значение столбца `Identity`. В этом примере при открытии соединения задается параметр, заставляющий процесс массовой загрузки использовать значения `Identity` из исходной таблицы.  
  
Операция массового копирования выполняется со свойством <xref:Microsoft.Data.SqlClient.SqlBulkCopy.BatchSize%2A>, равным 10. Когда операция встречает недопустимую строку, вызывается исключение. В первом примере операция массового копирования выполняется без транзакции. Фиксируются все пакеты, скопированные до появления ошибки. Пакет, содержащий повторяющийся ключ, откатывается, а операция массового копирования прерывается до обработки любых других пакетов.  
  
> [!NOTE]
>  Этот пример не будет работать, если вы не создали рабочие таблицы, как описано в разделе [Пример настройки массового копирования](bulk-copy-example-setup.md). Этот код предназначен только для демонстрации синтаксиса использования **SqlBulkCopy**. Если исходная и целевая таблицы расположены в одном экземпляре SQL Server, будет проще и быстрее использовать инструкцию Transact-SQL `INSERT … SELECT` для копирования данных.  
  
[!code-csharp[DataWorks SqlBulkCopyOpeions_Default#1](~/../sqlclient/doc/samples/SqlBulkCopyOptions_Default.cs#1)]
  
## <a name="performing-a-dedicated-bulk-copy-operation-in-a-transaction"></a>Выполнение выделенной операции массового копирования в транзакции  
По умолчанию операция массового копирования является своей собственной транзакцией. Если вы хотите выполнить выделенную операцию массового копирования, создайте новый экземпляр <xref:Microsoft.Data.SqlClient.SqlBulkCopy> с помощью строки подключения или примените существующий объект <xref:Microsoft.Data.SqlClient.SqlConnection>, в котором нет активных транзакций. В каждом случае операция массового копирования создает и затем фиксирует или откатывает транзакцию.  
  
Вы можете явно указать параметр <xref:Microsoft.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> в <xref:Microsoft.Data.SqlClient.SqlBulkCopy>, чтобы в явном виде заставить операцию массового копирования выполняться в своей собственной транзакции, вследствие чего каждый пакет операции будет выполняться в отдельной транзакции.  
  
> [!NOTE]
>  Поскольку разные пакеты выполняются в разных транзакциях, если во время операции массового копирования возникает ошибка, для всех строк в текущем пакете будет выполнен откат, но строки из предыдущих пакетов останутся в базе данных.  
  
Следующее консольное приложение похоже на предыдущий пример с одним исключением: в этом примере операция массового копирования обрабатывает собственные транзакции. Фиксируются все пакеты, скопированные до появления ошибки. Пакет, содержащий повторяющийся ключ, откатывается, а операция массового копирования прерывается до обработки любых других пакетов.  
  
> [!IMPORTANT]
>  Этот пример не будет работать, если вы не создали рабочие таблицы, как описано в разделе [Пример настройки массового копирования](bulk-copy-example-setup.md). Этот код предназначен только для демонстрации синтаксиса использования **SqlBulkCopy**. Если исходная и целевая таблицы расположены в одном экземпляре SQL Server, будет проще и быстрее использовать инструкцию Transact-SQL `INSERT … SELECT` для копирования данных.  
  
[!code-csharp[DataWorks SqlBulkCopyOptions_UseInternalTransaction#1](~/../sqlclient/doc/samples/SqlBulkCopyOptions_UseInternalTransaction.cs#1)]
  
## <a name="using-existing-transactions"></a>Использование существующих транзакций  
Вы можете указать существующий объект <xref:Microsoft.Data.SqlClient.SqlTransaction> в качестве параметра в конструкторе <xref:Microsoft.Data.SqlClient.SqlBulkCopy>. В этом случае операция массового копирования выполняется в существующей транзакции, а состояние транзакции не изменяется (то есть она не фиксируется и не прерывается). Это позволяет приложению включить операцию массового копирования в транзакцию с другими операциями базы данных. Но если вы не укажете объект <xref:Microsoft.Data.SqlClient.SqlTransaction> и передадите пустую ссылку, а соединение содержит активную транзакцию, создается исключение.  
  
Если вам нужно откатить всю операцию массового копирования из-за возникшей ошибки, или это массовое копирование является частью более масштабного отменяемого процесса, вы можете передать объект <xref:Microsoft.Data.SqlClient.SqlTransaction> в конструктор <xref:Microsoft.Data.SqlClient.SqlBulkCopy>.  
  
Следующее консольное приложение похоже на первый пример (без транзакции) с одним исключением: в этом примере операция массового копирования включена в большую, внешнюю транзакцию. Если возникает ошибка нарушения первичного ключа, производится откат всей транзакции и никакие строки не добавляются в целевую таблицу.  
  
> [!IMPORTANT]
>  Этот пример не будет работать, если вы не создали рабочие таблицы, как описано в разделе [Пример настройки массового копирования](bulk-copy-example-setup.md). Этот код предназначен только для демонстрации синтаксиса использования **SqlBulkCopy**. Если исходная и целевая таблицы расположены в одном экземпляре SQL Server, будет проще и быстрее использовать инструкцию Transact-SQL `INSERT … SELECT` для копирования данных.  
  
[!code-csharp[DataWorks SqlBulkCopy_ExternalTransaction#1](~/../sqlclient/doc/samples/SqlBulkCopy_ExternalTransaction.cs#1)]
  
## <a name="next-steps"></a>Дальнейшие действия
- [Операции массового копирования в SQL Server](bulk-copy-operations-sql-server.md)
