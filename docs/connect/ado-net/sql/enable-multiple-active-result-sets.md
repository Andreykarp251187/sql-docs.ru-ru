---
title: Включение нескольких активных результирующих наборов
description: Приведено описание того, как использовать MARS в SQL Server.
ms.date: 09/30/2019
dev_langs:
- csharp
ms.assetid: 576079e4-debe-4ab5-9204-fcbe2ca7a5e2
ms.prod: sql
ms.prod_service: connectivity
ms.technology: connectivity
ms.topic: conceptual
author: v-kaywon
ms.author: v-kaywon
ms.reviewer: rothja
ms.openlocfilehash: d0c40df5ec7648b7073f9efa369428b8d88f6d11
ms.sourcegitcommit: 9c993112842dfffe7176decd79a885dbb192a927
ms.translationtype: MTE75
ms.contentlocale: ru-RU
ms.lasthandoff: 10/16/2019
ms.locfileid: "72452225"
---
# <a name="enabling-multiple-active-result-sets"></a>Включение нескольких активных результирующих наборов

![Download-DownArrow-Circled](../../../ssdt/media/download.png)[Скачать ADO.NET](../../sql-connection-libraries.md#anchor-20-drivers-relational-access)

Режим MARS — это новая функция, которая в SQL Server используется для выполнения нескольких пакетов по одному соединению. Когда для работы с SQL Server включен режим MARS, каждый используемый объект команды добавляет сеанс к соединению.  
  
> [!NOTE]
>  В одном сеансе MARS открывается одно логическое соединение для MARS, которое используется, а затем одно логическое подключение для каждой активной команды.  
  
## <a name="enabling-and-disabling-mars-in-the-connection-string"></a>Включение и отключение режима MARS в строке подключения  
  
> [!NOTE]
>  В следующей строке подключения используется образец базы данных **AdventureWorks**, входящий в состав SQL Server. В указанных строках подключения предполагается, что база данных установлена на сервере с именем MSSQL1. При необходимости измените строку подключения для вашей среды.  
  
Эта функция по умолчанию отключена. Его можно включить, добавив пару ключевых слов "MultipleActiveResultSets = true" в строку подключения. "True" — единственное допустимое значение для включения режима MARS. В следующем примере показано, как подключиться к экземпляру SQL Server и указать, что режим MARS должен быть включен. 
  
```csharp  
string connectionString = "Data Source=MSSQL1;" +   
    "Initial Catalog=AdventureWorks;Integrated Security=SSPI;" +  
    "MultipleActiveResultSets=True";  
```  
  
Отключить режим MARS можно, добавив пару ключевых слов «MultipleActiveResultSets = false» в строку подключения. "False" — единственное допустимое значение для отключения режима MARS. В следующей строке соединения показано, как отключить режим MARS.  
  
```csharp  
string connectionString = "Data Source=MSSQL1;" +   
    "Initial Catalog=AdventureWorks;Integrated Security=SSPI;" +  
    "MultipleActiveResultSets=False";  
```  
  
## <a name="special-considerations-when-using-mars"></a>Особые рекомендации при использовании режима MARS  
Как правило, для использования подключения с включенным режимом MARS не требуется изменять существующие приложения. Однако, если вы хотите использовать функции MARS в приложениях, следует учитывать следующие особенности.  
  
### <a name="statement-interleaving"></a>Чередование инструкций  
Операции режима MARS выполняются синхронно на сервере. Допускается вывод инструкций SELECT и BULK INSERT. Однако инструкции языка обработки данных DML и языка описания данных DDL выполняются атомарно. Все инструкции, которые пытаются выполнить во время выполнения атомарного пакета, блокируются. Параллельное выполнение на сервере не является функцией режима MARS.  
  
Если два пакета передаются по соединению MARS, одна из них содержит инструкцию SELECT, а другая содержит инструкцию DML, то DML может начать выполнение в рамках выполнения инструкции SELECT. Однако инструкция DML должна быть выполнена до завершения до выполнения инструкции SELECT. Если обе инструкции выполняются в одной транзакции, любые изменения, внесенные инструкцией DML после начала выполнения инструкции SELECT, не видны операции чтения.  
  
Инструкция WAITFOR в инструкции SELECT не возвращает транзакцию, пока она находится в состоянии ожидания, то есть пока не будет создана первая строка. Это означает, что никакие другие пакеты не могут выполняться в одном и том же соединении во время ожидания инструкции WAITFOR.  
  
### <a name="mars-session-cache"></a>Кэш сеансов MARS  
При открытии подключения с включенным режимом MARS создается логический сеанс, который добавляет дополнительные издержки. Чтобы свести к минимуму затраты и повысить производительность, **SqlClient** кэширует сеанс режима MARS в рамках соединения. Кэш содержит не более 10 сеансов режима MARS. Это значение не регулируется пользователем. При достижении ограничения сеанса создается новый сеанс — ошибка не создается. Кэш и сеансы, содержащиеся в нем, относятся к каждому подключению. они не являются общими для подключений. При освобождении сеанса он возвращается в пул, если не достигнут верхний предел пула. Если пул кэша полон, сеанс закрывается. Сеансы режима MARS не имеют истечения срока действия. Они очищаются только при удалении объекта соединения. Кэш сеансов MARS не предварительно загружен. Он загружается, так как приложению требуется больше сеансов.  
  
### <a name="thread-safety"></a>Потокобезопасность  
Операции режима MARS не являются потокобезопасными.  
  
### <a name="connection-pooling"></a>Организация пулов соединений  
Подключения с поддержкой MARS включаются в пул как любое другое подключение. Если приложение открывает два подключения, одно с включенным режимом MARS и отключенным режимом MARS, два подключения находятся в разных пулах.
  
### <a name="sql-server-batch-execution-environment"></a>Среда пакетного выполнения SQL Server  
При открытии соединения определяется среда по умолчанию. Затем эта среда копируется в логический сеанс MARS.  
  
Среда выполнения пакетов включает в себя следующие компоненты:  
  
- Параметры SET (например, ANSI_NULLS, DATE_FORMAT, LANGUAGE, TEXTSIZE)  
  
- Контекст безопасности (роль пользователя или приложения)  
  
- Контекст базы данных (Текущая база данных)  
  
- Переменные состояния выполнения (например, @ @ERROR, @ @ROWCOUNT, @ @FETCH_STATUS @ @IDENTITY)  
  
- Временные таблицы верхнего уровня  
  
При использовании режима MARS среда выполнения по умолчанию связывается с соединением. Каждый новый пакет, выполняемый для конкретного соединения, получает копию среды по умолчанию. Каждый раз, когда код выполняется в заданном пакете, все изменения, вносимые в среду, зависят от конкретного пакета. Как только выполнение завершается, настройки выполнения копируются в среду по умолчанию. В случае, когда один пакет выдает несколько команд для последовательного выполнения в той же транзакции, семантика совпадает с той, которая предоставляется соединениями, включающими более ранние клиенты или серверы.  
  
### <a name="parallel-execution"></a>Параллельное выполнение  
Режим MARS не предназначен для удаления всех требований к нескольким подключениям в приложении. Если приложению требуется истинное параллельное выполнение команд на сервере, следует использовать несколько соединений.  
  
Рассмотрим, например, следующий сценарий. Создаются два объекта Command, один для обработки результирующего набора, а другой для обновления данных; они используют общее подключение через MARS. В этом сценарии `Transaction`.`Commit` не сможет выполнить обновление, пока не будут прочитаны все результаты для первого объекта команды, при этом выдается следующее исключение.  
  
Сообщение: контекст транзакции используется другим сеансом.  
  
Источник: поставщик данных SqlClient (Майкрософт)  
  
Ожидалось: (null)  
  
Получено: Microsoft. Data. SqlClient. SqlException  
  
Существует три варианта обработки этого сценария:  
  
- Запустите транзакцию после создания модуля чтения, чтобы он не был частью транзакции. После этого каждое обновление станет собственной транзакцией.  
  
- Зафиксировать всю работу после закрытия модуля чтения. Это может привести к существенному пакету обновлений.  
  
- Не используйте режим MARS; Вместо этого используйте отдельное соединение для каждого объекта Command, как и перед режимом MARS.  
  
### <a name="detecting-mars-support"></a>Обнаружение поддержки MARS  
Приложение может проверить поддержку режима MARS, читая значение `SqlConnection.ServerVersion`. Основной номер должен быть равен 9 для SQL Server 2005 и 10 для SQL Server 2008.  
  
## <a name="next-steps"></a>Дальнейшие действия
- [Режим MARS](multiple-active-result-sets-mars.md)
