---
title: Зеркалирование баз данных в SQL Server
description: Здесь описываются функции зеркального отображения базы данных.
ms.date: 09/30/2019
dev_langs:
- csharp
ms.assetid: 89befaff-bb46-4290-8382-e67cdb0e3de9
ms.prod: sql
ms.prod_service: connectivity
ms.technology: connectivity
ms.topic: conceptual
author: rothja
ms.author: jroth
ms.reviewer: v-kaywon
ms.openlocfilehash: 354b3ef1f0db45c64363d508d4bb055ee32d6416
ms.sourcegitcommit: b78f7ab9281f570b87f96991ebd9a095812cc546
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/31/2020
ms.locfileid: "75247834"
---
# <a name="database-mirroring-in-sql-server"></a>Зеркалирование баз данных в SQL Server

![Download-DownArrow-Circled](../../../ssdt/media/download.png)[Скачать ADO.NET](../../sql-connection-libraries.md#anchor-20-drivers-relational-access)

Зеркальное отображение базы данных в SQL Server позволяет сохранять копию или зеркальную копию базы данных SQL Server на резервном сервере. Зеркальное отображение гарантирует, что две отдельные копии данных постоянно существуют, обеспечивая высокий уровень доступности и избыточности данных. Поставщик Microsoft SqlClient для SQL Server предоставляет неявную поддержку зеркального отображения базы данных, поэтому разработчику не надо предпринимать никаких действий или писать код, если он настроен для работы с базой данных SQL Server. Кроме того, объект <xref:Microsoft.Data.SqlClient.SqlConnection> поддерживает явный режим подключения, который позволяет указать имя сервера-партнера по обеспечению отработки отказа в <xref:Microsoft.Data.SqlClient.SqlConnection.ConnectionString%2A>.  
  
Следующая упрощенная последовательность событий возникает для объекта <xref:Microsoft.Data.SqlClient.SqlConnection>, предназначенного для базы данных, которая настроена для зеркального отображения:  
  
1. Клиентское приложение успешно подключается к основной базе данных, а сервер отправляет обратно имя сервера-партнера, который затем кэшируется на клиенте.  
  
2. Если на сервере с основной базой данных происходит сбой или подключение прерывается, состояние подключения и транзакции будет утеряно. Клиентское приложение пытается восстановить подключение к основной базе данных, и происходит сбой.  
  
3. Затем клиентское приложение прозрачно пытается установить подключение к зеркальной базе данных на сервере-партнере. В случае успешной установки подключение перенаправляется в зеркальную базу данных, которая затем становится новой основной базой данных.  
  
## <a name="specifying-the-failover-partner-in-the-connection-string"></a>Указание партнера по обеспечению отработки отказа в строке подключения  
Если в строке подключения указать имя сервера-партнера по обеспечению отработки отказа, клиент будет прозрачно пытаться подключиться к партнеру по обеспечению отработки отказа в случае, если основная база данных недоступна при первом подключении клиентского приложения.  
  
```csharp
";Failover Partner=PartnerServerName"  
```  
  
Если не указано имя сервера-партнера по обеспечению отработки отказа, а основная база данных недоступна при первом подключении клиентского приложения, возникает <xref:Microsoft.Data.SqlClient.SqlException>.  
  
При успешном открытии <xref:Microsoft.Data.SqlClient.SqlConnection> имя партнера по обеспечению отработки отказа возвращается сервером и заменяет все значения, указанные в строке подключения.  
  
> [!NOTE]
>  Необходимо явно указать имя исходного каталога или базы данных в строке подключения для сценариев зеркального отображения базы данных. Если клиент получает сведения о переходе на другой ресурс во время соединения, которое не содержит явно указанного исходного каталога или базы данных, эти сведения не кэшируются и приложение не делает попытку перехода на другой ресурс в случае выхода основного сервера из строя. Если строка подключения имеет значение для партнера по обеспечению отработки отказа, но не имеет значения для исходного каталога или базы данных, возникает `InvalidArgumentException`.  
  
## <a name="retrieving-the-current-server-name"></a>Получение текущего имени сервера  
В случае отработки отказа можно получить имя сервера, к которому на самом деле подключено текущее подключение, с помощью свойства <xref:Microsoft.Data.SqlClient.SqlConnection.DataSource%2A> объекта <xref:Microsoft.Data.SqlClient.SqlConnection>. Следующий фрагмент кода извлекает имя активного сервера, предполагая, что переменная подключения ссылается на открытый элемент <xref:Microsoft.Data.SqlClient.SqlConnection>.  
  
При возникновении события отработки отказа и переключении подключения на зеркальный сервер свойство **DataSource** обновляется для отображения имени этого сервера.  
  
```csharp  
string activeServer = connection.DataSource;  
```  
  
## <a name="sqlclient-mirroring-behavior"></a>Поведение SqlClient при зеркальном отображении  
Клиент всегда пытается подключиться к текущему основному серверу. В случае сбоя он пытается обратиться к партнеру по обеспечению отработки отказа. Если зеркальная база данных уже переключена на основную роль на сервере-партнере, подключение будет установлено успешно, а новое сопоставление зеркального отображения-субъекта отправляется клиенту и кэшируется на время существования вызова <xref:System.AppDomain>. Оно не сохраняется в постоянном хранилище и недоступно для последующих соединений в другом домене приложения **AppDomain** или процессе. Однако оно доступно для последующих соединений внутри того же домена приложения **AppDomain**. Обратите внимание, что другой домен приложения **AppDomain** или процесс, выполняемый на том же или другом компьютере, всегда имеет свой пул соединений и эти соединения не сбрасываются. В этом случае, если база данных-источник выходит из строя, каждый процесс или домен приложения **AppDomain** заканчивается ошибкой и пул автоматически очищается.  
  
> [!NOTE]
>  Поддержка зеркального отображения на сервере настраивается отдельно для каждой базы данных. Если операции обработки данных выполняются для других баз данных, не входящих в основной или зеркальный набор, с помощью составных имен либо путем изменения текущей базы данных, изменения в этих базах данных не распространяются в случае сбоя. При изменении данных в незеркальной базе данных ошибка не возникает. Разработчик должен оценить возможное воздействие таких операций.  
  
## <a name="next-steps"></a>Дальнейшие действия
### <a name="database-mirroring-resources"></a>Ресурсы по зеркальному отображению баз данных  
Документацию и сведения о настройке, развертывании и администрировании зеркального подключения см. в приведенных ниже ресурсах документации на SQL Server.  
  
|Ресурс|Описание|  
|--------------|-----------------|  
|[Зеркальное отображение базы данных](../../../database-engine/database-mirroring/database-mirroring-sql-server.md)|Описывается установка и настройка зеркального отображения в SQL Server.|  
