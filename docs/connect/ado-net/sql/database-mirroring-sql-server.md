---
title: Зеркалирование баз данных в SQL Server
description: Описывает функциональность зеркального отображения базы данных.
ms.date: 09/30/2019
dev_langs:
- csharp
ms.assetid: 89befaff-bb46-4290-8382-e67cdb0e3de9
ms.prod: sql
ms.prod_service: connectivity
ms.technology: connectivity
ms.topic: conceptual
author: v-kaywon
ms.author: v-kaywon
ms.reviewer: rothja
ms.openlocfilehash: 1c78f52f376ff6c333b952b8d013e17eefce45ea
ms.sourcegitcommit: 9c993112842dfffe7176decd79a885dbb192a927
ms.translationtype: MTE75
ms.contentlocale: ru-RU
ms.lasthandoff: 10/16/2019
ms.locfileid: "72452275"
---
# <a name="database-mirroring-in-sql-server"></a>Зеркалирование баз данных в SQL Server

![Download-DownArrow-Circled](../../../ssdt/media/download.png)[Скачать ADO.NET](../../sql-connection-libraries.md#anchor-20-drivers-relational-access)

Зеркальное отображение базы данных в SQL Server позволяет сохранять копию или зеркальную копию базы данных SQL Server на резервном сервере. Зеркальное отображение гарантирует, что две отдельные копии данных постоянно существуют, обеспечивая высокий уровень доступности и полноту избыточности данных. Поставщик Microsoft SqlClient для SQL Server предоставляет неявную поддержку зеркального отображения базы данных, поэтому разработчику не надо предпринимать никаких действий или писать код, если он настроен для работы с базой данных SQL Server. Кроме того, объект <xref:Microsoft.Data.SqlClient.SqlConnection> поддерживает явный режим подключения, который позволяет указать имя сервера-партнера по обеспечению отработки отказа в <xref:Microsoft.Data.SqlClient.SqlConnection.ConnectionString%2A>.  
  
Следующая Упрощенная последовательность событий возникает для объекта <xref:Microsoft.Data.SqlClient.SqlConnection>, предназначенного для базы данных, настроенной для зеркального отображения.  
  
1. Клиентское приложение успешно подключается к основной базе данных, а сервер отправляет обратно имя сервера-участника, который затем кэшируется на клиенте.  
  
2. Если сервер, на котором находится основная база данных, завершается сбоем или подключение прервано, состояние соединения и транзакции будет утеряно. Клиентское приложение пытается восстановить соединение с основной базой данных и завершается с ошибкой.  
  
3. Затем клиентское приложение прозрачно пытается установить соединение с зеркальной базой данных на сервере-участнике. В случае успешности соединение перенаправляется в зеркальную базу данных, которая затем становится новой основной базой данных.  
  
## <a name="specifying-the-failover-partner-in-the-connection-string"></a>Указание партнера по обеспечению отработки отказа в строке подключения  
Если в строке подключения указать имя сервера-партнера по обеспечению отработки отказа, клиент будет прозрачно пытаться подключиться к партнеру по обеспечению отработки отказа, если основная база данных недоступна при первом подключении клиентского приложения.  
  
```csharp
";Failover Partner=PartnerServerName"  
```  
  
Если не указано имя сервера-партнера по обеспечению отработки отказа, а основная база данных недоступна при первом подключении клиентского приложения, возникает <xref:Microsoft.Data.SqlClient.SqlException>.  
  
При успешном открытии <xref:Microsoft.Data.SqlClient.SqlConnection> имя партнера по обеспечению отработки отказа возвращается сервером и заменяет все значения, указанные в строке подключения.  
  
> [!NOTE]
>  Необходимо явно указать имя исходного каталога или базы данных в строке подключения для сценариев зеркального отображения базы данных. Если клиент получает сведения о переходе на другой ресурс во время соединения, которое не содержит явно указанного исходного каталога или базы данных, эти сведения не кэшируются и приложение не делает попытку перехода на другой ресурс в случае выхода основного сервера из строя. Если строка подключения имеет значение для партнера по обеспечению отработки отказа, но не имеет значения для исходного каталога или базы данных, создается `InvalidArgumentException`.  
  
## <a name="retrieving-the-current-server-name"></a>Получение имени текущего сервера  
В случае отработки отказа можно получить имя сервера, к которому на самом деле подключено текущее соединение, с помощью свойства <xref:Microsoft.Data.SqlClient.SqlConnection.DataSource%2A> объекта <xref:Microsoft.Data.SqlClient.SqlConnection>. Следующий фрагмент кода извлекает имя активного сервера, предполагая, что переменная соединения ссылается на открытую <xref:Microsoft.Data.SqlClient.SqlConnection>.  
  
При возникновении события отработки отказа и переключении соединения на зеркальный сервер свойство **DataSource** обновляется в соответствии с именем зеркала.  
  
```csharp  
string activeServer = connection.DataSource;  
```  
  
## <a name="sqlclient-mirroring-behavior"></a>Поведение SqlClient при зеркальном отображении  
Клиент всегда пытается подключиться к текущему основному серверу. В случае сбоя он пытается обратиться к партнеру по обеспечению отработки отказа. Если зеркальная база данных уже переключена на основную роль на сервере-участнике, соединение будет выполнено успешно, а новое сопоставление зеркального отображения основного сервера отправляется клиенту и кэшируется на время существования вызывающего <xref:System.AppDomain>. Оно не сохраняется в постоянном хранилище и недоступно для последующих соединений в другом домене приложения **AppDomain** или процессе. Однако оно доступно для последующих соединений внутри того же домена приложения **AppDomain**. Обратите внимание, что другой домен приложения **AppDomain** или процесс, выполняемый на том же или другом компьютере, всегда имеет свой пул соединений и эти соединения не сбрасываются. В этом случае, если база данных-источник выходит из строя, каждый процесс или домен приложения **AppDomain** заканчивается ошибкой и пул автоматически очищается.  
  
> [!NOTE]
>  Поддержка зеркального отображения на сервере настраивается отдельно для каждой базы данных. Если операции обработки данных выполняются для других баз данных, не входящих в основной или зеркальный набор, либо с помощью составных имен, либо путем изменения текущей базы данных, изменения в этих базах данных не распространяются в случае сбоя. При изменении данных в незеркальной базе данных ошибка не возникает. Разработчик должен оценить возможное воздействие таких операций.  
  
## <a name="next-steps"></a>Следующие шаги
### <a name="database-mirroring-resources"></a>Ресурсы по зеркальному отображению баз данных  
Документацию и сведения о настройке, развертывании и администрировании зеркального подключения см. в приведенных ниже ресурсах документации на SQL Server.  
  
|Ресурс|Описание|  
|--------------|-----------------|  
|[Зеркальное отображение базы данных](../../../database-engine/database-mirroring/database-mirroring-sql-server.md)|Описывается установка и настройка зеркального отображения в SQL Server.|  
