---
title: Кэширование метаданных подготовленной инструкции для JDBC Driver | Документация Майкрософт
ms.custom: ''
ms.date: 08/12/2019
ms.prod: sql
ms.prod_service: connectivity
ms.reviewer: ''
ms.technology: connectivity
ms.topic: conceptual
ms.assetid: ''
author: MightyPen
ms.author: genemi
ms.openlocfilehash: 97224f53bb716abe3b79dd00df12d0eed4a63cec
ms.sourcegitcommit: 9348f79efbff8a6e88209bb5720bd016b2806346
ms.translationtype: MTE75
ms.contentlocale: ru-RU
ms.lasthandoff: 08/14/2019
ms.locfileid: "69027844"
---
# <a name="prepared-statement-metadata-caching-for-the-jdbc-driver"></a>Кэширование метаданных подготовленной инструкции для JDBC Driver
[!INCLUDE[Driver_JDBC_Download](../../includes/driver_jdbc_download.md)]

Эта статья содержит сведения об этих двух изменениях, реализованных для повышения производительности драйвера.

## <a name="batching-of-unprepare-for-prepared-statements"></a>Пакетная обработка для подготовки подготовленных инструкций
Начиная с версии 6.1.6-Preview, повышение производительности было реализовано за счет минимизации круговых путей к серверу до SQL Server. Ранее для каждого запроса prepareStatement был также отправлен вызов unprepare. Теперь драйвер выполняет пакетную обработку запросов, вплоть до порогового значения "Серверпрепаредстатементдискардсрешолд", которое по умолчанию равно 10.

> [!NOTE]  
>  Пользователи могут изменить значение по умолчанию с помощью следующего метода: setServerPreparedStatementDiscardThreshold (значение int).

Еще одно изменение, представленное в 6.1.6-Preview, заключается в том, что драйвер всегда будет вызывать sp_prepexec. Теперь при первом выполнении подготовленной инструкции драйвер вызывает процедуру sp_executesql, а для остальных он выполняет sp_prepexec и назначает ему маркер. Дополнительные сведения можно найти [здесь](https://github.com/Microsoft/mssql-jdbc/wiki/PreparedStatement-metadata-caching).

> [!NOTE]  
>  Пользователи могут изменить поведение по умолчанию до предыдущих версий всегда вызывать sp_prepexec, задав для Енаблепрепареонфирстпрепаредстатементкалл значение **true** , используя следующий метод: setEnablePrepareOnFirstPreparedStatementCall (логическое значение )

### <a name="list-of-the-new-apis-introduced-with-this-change-for-batching-of-unprepare-for-prepared-statements"></a>Список новых API-интерфейсов, появившихся с этим изменением, для пакетной обработки инструкции unprepare для подготовленных инструкций

 **SQLServerConnection**
 
|Новый метод|Описание|  
|-----------|-----------------|  
|int getDiscardedServerPreparedStatementCount()|Возвращает количество невыполненных в настоящее время незавершенных действий подготовки инструкции.|
|void Клосеунреференцедпрепаредстатеменсандлес ()|Принудительное выполнение запросов отмены подготовки для всех необработанных отброшенных подготовленных инструкций.|
|Логическое getEnablePrepareOnFirstPreparedStatementCall ()|Возвращает поведение для конкретного экземпляра соединения. Если значение равно false, первое выполнение вызывает процедуру sp_executesql и не готовит инструкцию, после второго выполнения он вызывает sp_prepexec и фактически настраивает подготовленный обработчик инструкции. Следующие выполнения вызывают sp_execute. Это освобождает необходимость sp_unprepare при выполнении подготовленной инструкции Close, если инструкция выполняется только один раз. Значение по умолчанию для этого параметра можно изменить, вызвав Сетдефаултенаблепрепареонфирстпрепаредстатементкалл ().|
|void setEnablePrepareOnFirstPreparedStatementCall (логическое значение)|Задает поведение для конкретного экземпляра соединения. Если значение равно false, первое выполнение вызывает процедуру sp_executesql и не подготавливает инструкцию, после второго выполнения он вызывает sp_prepexec и фактически настраивает подготовленный обработчик инструкции. Следующие выполнения вызывают sp_execute. Это освобождает необходимость sp_unprepare при выполнении подготовленной инструкции Close, если инструкция выполняется только один раз.|
|int getServerPreparedStatementDiscardThreshold()|Возвращает поведение для конкретного экземпляра соединения. Этот параметр определяет, сколько невыполненных операций отмены подготовленной инструкции (sp_unprepare) может быть недоступно для каждого соединения, прежде чем будет выполнен вызов очистки необработанных дескрипторов на сервере. Если параметр имеет значение < = 1, то при закрытии подготовленных инструкций немедленно выполняются неподготовительные действия. Если задано значение {@literal >} 1, эти вызовы объединяются в пакет, чтобы избежать издержек при слишком частом вызове sp_unprepare. Значение по умолчанию для этого параметра можно изменить, вызвав Жетдефаултсерверпрепаредстатементдискардсрешолд ().|
|void setServerPreparedStatementDiscardThreshold (значение int)|Задает поведение для конкретного экземпляра соединения. Этот параметр определяет, сколько невыполненных операций отмены подготовленной инструкции (sp_unprepare) может быть недоступно для каждого соединения, прежде чем будет выполнен вызов очистки необработанных дескрипторов на сервере. Если параметр имеет значение < = 1, действия, выполняемые при закрытии инструкции, выполняются немедленно. Если для него задано значение > 1, эти вызовы объединяются в пакеты, чтобы избежать издержек при слишком частом вызове sp_unprepare.|

 **SQLServerDataSource**
 
|Новый метод|Описание|  
|-----------|-----------------|  
|void setEnablePrepareOnFirstPreparedStatementCall (Boolean Енаблепрепареонфирстпрепаредстатементкалл)|Если эта конфигурация имеет значение false, первое выполнение подготовленной инструкции вызывает процедуру sp_executesql и не подготавливает инструкцию, после второго выполнения он вызывает sp_prepexec и фактически настраивает подготовленный обработчик инструкции. Следующие выполнения вызывают sp_execute. Это освобождает необходимость sp_unprepare при выполнении подготовленной инструкции Close, если инструкция выполняется только один раз.|
|Логическое getEnablePrepareOnFirstPreparedStatementCall ()|Если эта конфигурация возвращает значение false, то первое выполнение подготовленной инструкции вызывает процедуру sp_executesql и не подготавливает инструкцию. После второго выполнения он вызывает sp_prepexec и, в действительности, настраивает подготовленный обработчик инструкции. Следующие выполнения вызывают sp_execute. Это освобождает необходимость sp_unprepare при выполнении подготовленной инструкции Close, если инструкция выполняется только один раз.|
|void setServerPreparedStatementDiscardThreshold(int serverPreparedStatementDiscardThreshold)|Этот параметр определяет, сколько невыполненных операций отмены подготовленной инструкции (sp_unprepare) может быть недоступно для каждого соединения, прежде чем будет выполнен вызов очистки необработанных дескрипторов на сервере. Если параметр имеет значение < = 1, действия, выполняемые при закрытии инструкции, выполняются немедленно. Если задано значение {@literal >} 1, эти вызовы объединяются в пакеты, чтобы избежать чрезмерных затрат на вызов sp_unprepare слишком часто|
|int getServerPreparedStatementDiscardThreshold()|Этот параметр определяет, сколько невыполненных операций отмены подготовленной инструкции (sp_unprepare) может быть недоступно для каждого соединения, прежде чем будет выполнен вызов очистки необработанных дескрипторов на сервере. Если параметр имеет значение < = 1, действия, выполняемые при закрытии инструкции, выполняются немедленно. Если задано значение {@literal >} 1, эти вызовы объединяются в пакеты, чтобы избежать чрезмерных затрат на вызов sp_unprepare слишком часто.|

## <a name="prepared-statement-metatada-caching"></a>Подготовленная инструкция метатада Caching
Начиная с версии 6.3.0-Preview драйвер Microsoft JDBC для SQL Server поддерживает подготовленное кэширование инструкций. До версии 6.3.0-Preview, если один из них выполняет запрос, который уже подготовлен и сохранен в кэше, повторный вызов этого же запроса не приведет к его подготовке. Теперь драйвер ищет запрос в кэше и находит его и выполняет с помощью sp_execute.
Кэширование метаданных подготовленной инструкции **отключено** по умолчанию. Чтобы включить его, необходимо вызвать следующий метод для объекта Connection:

`setStatementPoolingCacheSize(int value)   //value is the desired cache size (any value bigger than 0)`
`setDisableStatementPooling(boolean value) //false allows the caching to take place`

Например: `connection.setStatementPoolingCacheSize(10)`
`connection.setDisableStatementPooling(false)`

### <a name="list-of-the-new-apis-introduced-with-this-change-for-prepared-statement-metadata-caching"></a>Список новых API, появившихся с этим изменением, для кэширования метаданных подготовленной инструкции

 **SQLServerConnection**
 
|Новый метод|Описание|  
|-----------|-----------------|  
|void setDisableStatementPooling (логическое значение)|Задает для группирования инструкций значение true или false.|
|boolean getDisableStatementPooling()|Возвращает значение true, если объединение инструкций отключено.|
|void setStatementPoolingCacheSize (значение int)|Указывает размер кэша подготовленной инструкции для этого соединения. Значение меньше 1 означает отсутствие кэша.|
|int getStatementPoolingCacheSize()|Возвращает размер подготовленного кэша инструкций для этого соединения. Значение меньше 1 означает отсутствие кэша.|
|int getStatementHandleCacheEntryCount()|Возвращает текущее число готовых дескрипторов инструкций в составе пула.|
|boolean isPreparedStatementCachingEnabled()|Включено ли объединение инструкций в пул для этого соединения.|

 **SQLServerDataSource**
 
|Новый метод|Описание|  
|-----------|-----------------|  
|void setDisableStatementPooling (Boolean disableStatementPooling)|Задает для группирования инструкций значение true или false.|
|boolean getDisableStatementPooling()|Возвращает значение true, если объединение инструкций отключено.|
|void setStatementPoolingCacheSize (int Статементпулингкачесизе)|Указывает размер кэша подготовленной инструкции для этого соединения. Значение меньше 1 означает отсутствие кэша.|
|int getStatementPoolingCacheSize()|Возвращает размер подготовленного кэша инструкций для этого соединения. Значение меньше 1 означает отсутствие кэша.|

## <a name="see-also"></a>См. также раздел  
 [Повышение производительности и надежности с помощью JDBC Driver](../../connect/jdbc/improving-performance-and-reliability-with-the-jdbc-driver.md)  
  
  
