---
title: Kubernetes RBAC
titleSuffix: SQL Server big data clusters
description: Эта статья описывает, как платформа кластеров больших данных SQL Server использует RBAC с Kubernetes.
author: mihaelablendea
ms.author: mihaelab
ms.reviewer: mikeray
ms.date: 06/22/2020
ms.topic: conceptual
ms.prod: sql
ms.technology: big-data-cluster
ms.openlocfilehash: 5d2e3f379402f16f32020f9cd34103919f13a30c
ms.sourcegitcommit: b57d98e9b2444348f95c83a24b8eea0e6c9da58d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/21/2020
ms.locfileid: "86552979"
---
# <a name="kubernetes-rbac-model--impact-on-users-managing-bdc"></a>Модель RBAC Kubernetes и влияние на пользователей, управляющих кластером больших данных

Следующий раздел описывает разрешения, которые необходимы пользователям, управляющим кластерами больших данных.

> [!NOTE]
> Дополнительные материалы по модели RBAC Kubernetes см. в разделах [Использование авторизации RBAC — Kubernetes](https://kubernetes.io/docs/reference/access-authn-authz/rbac/) и [Использование RBAC для определения и применения разрешений — OpenShift](https://docs.openshift.com/container-platform/4.4/authentication/using-rbac.html).

## <a name="role-required-for-deployment"></a>Роль, необходимая для развертывания

Кластер больших данных использует учетные записи служб (например, `sa-mssql-controller` или `master`) для оркестрации подготовки объектов pod кластера, служб, высокого уровня доступности, мониторинга и т. п. При запуске развертывания кластера больших данных (например, `azdata bdc create`) `azdata` выполняет следующие действия:

1. Проверяет, существует ли указанное пространство имен.
2. Если оно не существует, создает его и применяет метку `MSSQL_CLUSTER`.
3. Создает учетную запись службы `sa-mssql-controller`.
4. Создает роль `<namespaced>-admin` с полными разрешениями на пространство имен или проект, но не разрешениями уровня кластера.
5. Создает назначение роли этой учетной записи службы для роли.

После выполнения этих шагов подготавливаются объекты pod уровня управления, а учетная запись службы развертывает оставшуюся часть кластера больших данных.  

В конечном итоге осуществляющий развертывание пользователь должен иметь разрешения на выполнение следующих задач:

- Вывод списка пространств имен в кластере (1).
- Исправление нового или существующего пространства имен с меткой (2).
- Создание учетной записи службы `sa-mssql-controller`, роли `<namespaced>-admin` и привязки роли (3–5).

Роль по умолчанию `admin` не имеет таких разрешений, поэтому пользователь, развертывающий кластер больших данных, должен иметь по меньшей мере разрешения администратора на уровне пространства имен.

## <a name="cluster-role-required-for-pods-and-nodes-metrics-collection"></a>Роль кластера, необходимая для сбора метрик объектов pod и узлов

Начиная с накопительного пакета обновления 5 для SQL Server 2019 для сбора метрик объектов pod и узлов Telegraf требует учетную запись службы с разрешениями роли в масштабе кластера. Во время развертывания (или обновления существующих развертываний) мы пытаемся создать необходимую учетную запись службы и роль кластера, но если пользователь, развертывающий кластер или осуществляющий обновление, не обладает достаточными разрешениями, развертывание или обновление продолжится с предупреждением и завершится успешно. В этом случае метрики объектов pod и узлов собираться не будут. Пользователь, развертывающий кластер, должен попросить администратора кластера создать роль и учетную запись службы (до или после развертывания или обновления). После создания их использует кластер больших данных. 

Ниже приведен скрипт, демонстрирующий создание необходимых артефактов:

```console
export CLUSTER_NAME=mssql-cluster
kubectl create -f - <<EOF
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: ${CLUSTER_NAME}:cr-mssql-metricsdc-reader
rules:
- apiGroups:
  - '*'
  resources:
  - pods
  - nodes/stats
  verbs:
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: ${CLUSTER_NAME}:crb-mssql-metricsdc-reader
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ${CLUSTER_NAME}:cr-mssql-metricsdc-reader
subjects:
- kind: ServiceAccount
  name: sa-mssql-metricsdc-reader
  namespace: ${CLUSTER_NAME}
EOF
```

Учетную запись службы, роль кластера и привязку роли кластера можно создать либо до, либо после развертывания кластера больших данных. Kubernetes автоматически обновляет разрешение для учетной записи службы Telegraf. Если эти данные создаются в качестве развертывания объекта pod, то в собираемых метриках объектов pod и узлов будет наблюдаться задержка в несколько минут.

> [!NOTE]
> Накопительный пакет обновления 5 для SQL Server 2019 представляет два параметра для управления сбором метрик объектов pod и узлов. По умолчанию для этих параметров задано значение true во всех целевых объектах среды, кроме OpenShift, где значение по умолчанию переопределено. 

Эти параметры можно настроить в разделе безопасности в файле конфигурации развертывания `control.json`:

```json
  "security": {
    …
    "allowNodeMetricsCollection": false,
    "allowPodMetricsCollection": false
  }
```

Если для этих параметров задано значение `false`, рабочий процесс развертывания кластера больших данных не будет пытаться создать учетную запись службы, роль кластера и привязку для Telegraf.
