---
title: Сохраняемость данных в Kubernetes
titleSuffix: SQL Server big data clusters
description: Узнайте, как реализуется сохраняемость данных в кластере больших данных SQL Server 2019.
author: mihaelablendea
ms.author: mihaelab
ms.reviewer: mikeray
ms.date: 11/04/2019
ms.topic: conceptual
ms.prod: sql
ms.technology: big-data-cluster
ms.openlocfilehash: 4671bc07dd21a769746257339ea7903e3dda4701
ms.sourcegitcommit: 385a907ed1de8fa7ada76260ea3f92583eb09238
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/14/2019
ms.locfileid: "74063976"
---
# <a name="data-persistence-with-sql-server-big-data-cluster-on-kubernetes"></a>Сохраняемость данных при использовании кластера больших данных SQL Server в Kubernetes

[!INCLUDE[tsql-appliesto-ssver15-xxxx-xxxx-xxx](../includes/tsql-appliesto-ssver15-xxxx-xxxx-xxx.md)]

[Постоянные тома](https://kubernetes.io/docs/concepts/storage/persistent-volumes/) предоставляют модель подключения для хранилища в Kubernetes. Предоставление хранилища абстрагируется от его использования. Поэтому вы можете подключить собственное хранилище высокого уровня доступности к кластеру больших данных SQL Server. Это позволяет получить полный контроль над типом хранилища, доступностью и производительностью. Kubernetes поддерживает различные типы решений для хранения данных, включая диски и файлы Azure, NFS, локальное хранилище и многое другое.

## <a name="configure-persistent-volumes"></a>Настройка постоянных томов

Постоянные тома используются в кластере больших данных SQL Server посредством [классов хранения](https://kubernetes.io/docs/concepts/storage/storage-classes/). Вы можете создать различные классы хранения для хранилищ разных типов и указать их во время развертывания кластера больших данных. Вы также можете указать, какие класс хранения и размер постоянного тома должны использоваться в тех или иных целях, на уровне пула. Кластер больших данных SQL Server создает [утверждения постоянных томов](https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims) с указанным именем класса хранения для каждого компонента, которому требуются постоянные тома. Затем он подключает соответствующие постоянные тома в объекте pod. 

Ниже приведены некоторые важные аспекты, которые следует учитывать при планировании конфигурации хранилища для кластера больших данных.

- Для успешного развертывания кластера больших данных необходимо убедиться, что доступно необходимое количество постоянных томов. Если вы выполняете развертывание в кластере AKS и используете один из встроенных классов хранилища (`default` или `managed-premium`), эти компоненты поддерживают динамическую подготовку постоянных томов. Это означает, что вам не нужно предварительно создавать постоянные тома, но необходимо убедиться, что к рабочим узлам, доступным в кластере AKS, можно подключить столько дисков, сколько необходимо для развертывания. В зависимости от [размера виртуальной машины](/azure/virtual-machines/linux/sizes/), заданной для рабочих узлов, к каждому узлу можно подключить определенное количество дисков. Для кластера размером по умолчанию (без высокой доступности) требуется не менее 24 дисков. Если вы включаете для пула высокий уровень доступности или масштабируете его, необходимо обеспечить как минимум два сохраняемых тома на каждую дополнительную реплику независимо от ресурса, для которого выполняется масштабирование.

- Если средство подготовки хранилища для класса хранения, который вы задаете в конфигурации, не поддерживает динамическую подготовку, необходимо создать постоянные тома заранее. Так, средство подготовки `local-storage` не поддерживает динамическую подготовку. В этом [примере скрипта](https://github.com/microsoft/sql-server-samples/tree/cu1-bdc/samples/features/sql-big-data-cluster/deployment/kubeadm/ubuntu) вы найдете пример выполнения этого действия в кластере Kubernetes, развертываемом с помощью `kubeadm`.

- При развертывании кластера больших данных можно настроить один класс хранения для использования всеми компонентами в кластере. Однако для развертывания в производственной среде рекомендуется назначать разным компонентам разные конфигурации хранения, чтобы удовлетворить потребности разных рабочих нагрузок с точки зрения размера или пропускной способности. Можно перезаписать конфигурацию хранилища по умолчанию, заданную в контроллере для каждого основного экземпляра SQL Server, данных и пулов носителей. В этой статье приводятся примеры того, как это сделать.

- Начиная с выпуска SQL Server 2019 CU1 изменить параметры конфигурации хранилища после развертывания невозможно. Это включает не только невозможность изменить заявленный размер постоянного тома для каждого экземпляра, но и невозможность масштабировать систему после развертывания. Поэтому так важно спланировать структуру хранилища до развертывания кластера больших данных.

- С учетом особенностей развертывания в Kubernetes в качестве контейнерных приложений и использования таких функций, как наборы с отслеживанием состояния и постоянное хранилище, Kubernetes гарантирует, что группы pod перезапускаются в случае проблем с работоспособностью и подключаются к тому же постоянному хранилищу. Однако в случае сбоя узла и необходимости перезапустить pod на другом узле возрастает риск недоступности системы, если использовалось локальное по отношению к вышедшему из строя узлу хранилище. Во избежание такого риска необходимо либо настроить дополнительное резервирование и включить [компоненты обеспечения высокой доступности](deployment-high-availability.md), либо использовать удаленное хранилище с резервированием. Ниже приведен обзор вариантов хранилищ для различных компонентов в кластерах больших данных.

| Ресурсы | Тип хранилища для данных | Тип хранилища для журнала |  Примечания |
|---|---|---|--|
| Главный экземпляр SQL Server | Локальное (не менее 3 реплик) или удаленное хранилище с резервированием (1 реплика) | Локальное хранилище | Реализация на основе набора с отслеживанием состояния, в которой группы pod связаны с узлами, защитит от потери данных при перезапусках и в случае временных сбоев. |
| Вычислительный пул | Локальное хранилище* | Локальное хранилище | Данные пользователей не хранятся. |
| Пул данных | Локальное или удаленное хранилище с резервированием | Локальное хранилище | Используйте удаленное хранилище с резервированием, если не удается перестроить пул данных из других источников.  |
| Пул носителей (HDFS) | Локальное или удаленное хранилище с резервированием | Локальное хранилище | Убедитесь, что репликация включена. |
| Пул Spark | Локальное хранилище* | Локальное хранилище | Данные пользователей не хранятся. |
| Управление (controldb, metricsdb, logsdb)| Удаленное хранилище с резервированием | Локальное хранилище | Очень важно использовать резервирование на уровне хранилища для метаданных кластера больших данных. |

> [!IMPORTANT]
> Необходимо убедиться, что связанные с управлением компоненты находятся в удаленном хранилище с резервированием. Группа pod `controldb-0` содержит экземпляр SQL Server с базами данных, где хранятся все метаданные о состояниях службы кластеров, различных настройках и т. д. Недоступность этого экземпляра приведет к проблемам с работоспособностью других зависимых служб в кластере.

## <a name="configure-big-data-cluster-storage-settings"></a>Настройка параметров хранилища для кластера больших данных

Так же как и другие настройки, параметры хранилища можно указать в файлах конфигурации кластера во время развертывания для каждого пула в файле конфигурации `bdc.json` и для служб управления в файле `control.json`. Если в спецификациях пула нет параметров конфигурации хранилища, то параметры хранилища управления будут использоваться для всех других компонентов, включая основной экземпляр SQL Server (ресурс `master`), HDFS (ресурс `storage-0`) или пул данных. Вот пример раздела конфигурации хранилища, который можно включить в спецификацию:

```json
    "storage": 
    {
      "data": {
        "className": "default",
        "accessMode": "ReadWriteOnce",
        "size": "15Gi"
      },
      "logs": {
        "className": "default",
        "accessMode": "ReadWriteOnce",
        "size": "10Gi"
    }
```

Развернутый кластер больших данных будет использовать постоянное хранилище для хранения данных, метаданных и журналов различных компонентов. Вы можете настроить размер утверждений постоянных томов, создаваемых в ходе развертывания. Рекомендуется использовать классы хранения с [политикой освобождения](https://kubernetes.io/docs/concepts/storage/storage-classes/#reclaim-policy) *Сохранение*.

> [!WARNING]
> Запуск без постоянного хранилища возможен в тестовой среде, но может привести к утрате работоспособности кластера. При перезапуске pod метаданные кластера и пользовательские данные будут утеряны без возможности восстановления. Использовать эту конфигурацию не рекомендуется. 

В разделе [Настройка хранилища](#config-samples) приведены дополнительные примеры настройки параметров хранилища для развертывания кластера больших данных SQL Server.

## <a name="aks-storage-classes"></a>Классы хранения AKS

В AKS есть [два встроенных класса хранения](/azure/aks/azure-disks-dynamic-pv/): `default` и `managed-premium`, а также средство динамической подготовки для них. Вы можете выбрать любой из них или создать собственный класс хранения для развертывания кластера больших данных с включенным постоянным хранилищем. По умолчанию встроенный файл конфигурации кластера для AKS `aks-dev-test` содержит конфигурации постоянного хранилища, предусматривающие использование класса хранения `default`.

> [!WARNING]
> Постоянные тома, созданные с помощью встроенных классов хранения `default` и `managed-premium`, имеют политику освобождения *Удаление*. Поэтому при удалении кластера больших данных SQL Server утверждения постоянных томов удаляются, а затем удаляются и сами тома. Вы можете создавать пользовательские классы хранения с помощью средства подготовки `azure-disk` с политикой освобождения `Retain`, как показано в [этой](/azure/aks/concepts-storage/#storage-classes) статье.

## <a name="storage-classes-for-kubeadm-clusters"></a>Классы хранения для кластеров `kubeadm` 

Кластеры Kubernetes, развернутые с помощью `kubeadm`, не имеют встроенного класса хранения. Необходимо создать собственные классы хранения и постоянные тома с помощью локального хранилища или предпочтительного средства подготовки, например [Rook](https://github.com/rook/rook). В этом случае необходимо присвоить свойство `className` настроенному классу хранения. 

> [!IMPORTANT]
>  Во встроенных файлах конфигурации развертывания для kubeadm (`kubeadm-dev-test` или `kubeadm-prod`) не указано имя класса хранения для хранилища данных и журналов. Перед развертыванием необходимо настроить файл конфигурации и задать значение для `className`, иначе проверки перед развертыванием завершатся ошибкой. Во время развертывания также проверяется наличие класса хранения, но наличие требуемых постоянных томов не проверяется. Необходимо создать достаточно томов в зависимости от размера кластера. Для минимального размера кластера по умолчанию (масштаб по умолчанию, без высокой доступности) необходимо создать не менее 24 постоянных томов.
>
>[Создание кластера Kubernetes](https://github.com/Microsoft/sql-server-samples/tree/master/samples/features/sql-big-data-cluster/deployment/kubeadm/ubuntu) представляет пример того, как можно создавать постоянные тома с помощью локального средства подготовки. В этом примере представлено хранилище Kubernetes.


## <a name="customize-storage-configurations-for-each-pool"></a>Настройка конфигураций хранилища для каждого пула

Для любой настройки необходимо сначала создать копию встроенного файла конфигурации, который требуется использовать. Например, следующая команда создает копию файлов конфигурации развертывания `aks-dev-test` в подкаталоге `custom`:

```bash
azdata bdc config init --source aks-dev-test --target custom
```

При этом создаются два файла: `bdc.json` и `control.json`, которые можно настроить путем изменения вручную или с помощью команды `azdata bdc config`. Для изменения файлов конфигурации можно использовать сочетание библиотек jsonpath и jsonpatch.


### <a id="config-samples"></a> Настройка имени класса хранения и размера утверждений

По умолчанию размер утверждений постоянных томов, подготавливаемых для каждого модуля pod в кластере, составляет 10 ГБ. Это значение можно изменить в соответствии с выполняемыми рабочими нагрузками в пользовательском файле конфигурации перед развертыванием кластера.

В приведенном ниже примере изменяется размер утверждений постоянных томов на 32 ГБ в файле `control.json`. Если этот параметр не переопределен на уровне пула, он применяется ко всем пулам.

```bash
azdata bdc config replace --config-file custom/control.json --json-values "$.spec.storage.data.size=100Gi"
```

В следующем примере показано, как изменить класс хранения для файла `control.json`:

```bash
azdata bdc config replace --config-file custom/control.json --json-values "$.spec.storage.data.className=<yourStorageClassName>"
```

Другой способ — вручную изменить пользовательский файл конфигурации или использовать исправление JSON, как в приведенном ниже примере, в котором изменяется класс хранения для пула носителей. Создайте файл `patch.json` с таким содержимым:

```json
{
  "patch": [
    {
      "op": "replace",
      "path": "$.spec.resources.storage-0.spec",
      "value": {
        "type":"Storage",
        "replicas":2,
        "storage":{
            "data":{
                    "size": "100Gi",
                    "className": "myStorageClass",
                    "accessMode":"ReadWriteOnce"
                    },
            "logs":{
                    "size":"32Gi",
                    "className":"myStorageClass",
                    "accessMode":"ReadWriteOnce"
                    }
                }
            }
        }
    ]
}
```

Примените файл исправления. Используйте команду `azdata bdc config patch`, чтобы применить эти изменения в файле исправления JSON. В следующем примере файл `patch.json` применяется к целевому файлу конфигурации развертывания `custom.json`.

```bash
azdata bdc config patch --config-file custom/bdc.json --patch-file ./patch.json
```

## <a name="next-steps"></a>Следующие шаги

Полные сведения о томах в Kubernetes см. в [документации Kubernetes по томам](https://kubernetes.io/docs/concepts/storage/volumes/).

Дополнительные сведения о развертывании кластера больших данных SQL Server см. в статье [Развертывание кластера больших данных SQL Server в Kubernetes](deployment-guidance.md).
