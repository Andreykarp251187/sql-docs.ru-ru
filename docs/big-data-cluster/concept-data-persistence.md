---
title: Сохранение данных в Kubernetes
titleSuffix: SQL Server big data clusters
description: Дополнительные сведения о работе в кластере SQL Server 2019 больших данных постоянного хранения.
author: rothja
ms.author: jroth
manager: jroth
ms.date: 05/22/2019
ms.topic: conceptual
ms.prod: sql
ms.technology: big-data-cluster
ms.custom: seodec18
ms.openlocfilehash: 24c90bfb8c99178e8ffa7822fba4bea709c536e1
ms.sourcegitcommit: 3026c22b7fba19059a769ea5f367c4f51efaf286
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/15/2019
ms.locfileid: "66800715"
---
# <a name="data-persistence-with-sql-server-big-data-cluster-on-kubernetes"></a>Сохранение данных с кластером больших данных SQL Server в Kubernetes

[!INCLUDE[tsql-appliesto-ssver15-xxxx-xxxx-xxx](../includes/tsql-appliesto-ssver15-xxxx-xxxx-xxx.md)]

[Постоянные тома](https://kubernetes.io/docs/concepts/storage/persistent-volumes/) предоставляют модель подключаемого модуля для хранения в Kubernetes. Предоставляется как хранилище абстрагируется от его потребления. Таким образом можно использовать собственное хранилище высокой доступности и подключить его к кластеру больших данных SQL Server. Это дает полный контроль над тип хранилища, доступности и производительности, которые нужны. Kubernetes поддерживает различные типы решений хранения, включая Azure диски и файлы, NFS, локальное хранилище и многое другое.

## <a name="configure-persistent-volumes"></a>Настройка постоянные тома

— Способ работы с большими данными кластера SQL Server использует эти постоянные тома с помощью [классы хранения](https://kubernetes.io/docs/concepts/storage/storage-classes/). Можно создать классы хранения для разных видов хранилища и указать их во время развертывания кластера больших данных. Можно настроить какой класс хранилища и размер утверждение постоянного тома, для какой цели на уровне пула. Создает кластер SQL Server больших данных [утверждения постоянного тома](https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims) с именем класса указанное хранилище для каждого компонента, который требует постоянные тома. Затем он подключает соответствующие постоянные тома в pod. 

## <a name="configure-big-data-cluster-storage-settings"></a>Настройка параметров хранения больших данных кластера

Как и другие настройки, можно указать настройки хранилища в файлах конфигурации кластера во время развертывания для каждого пула и плоскостью управления. Если есть никакой дополнительной настройки хранилища в спецификациях пула, то будут использоваться параметры хранения плоскости управления. Ниже приведен пример раздела конфигурации хранилища, которую можно включить в спецификации:

```json
    "storage": 
    {
      "data": {
        "className": "default",
        "accessMode": "ReadWriteOnce",
        "size": "15Gi"
      },
      "logs": {
        "className": "default",
        "accessMode": "ReadWriteOnce",
        "size": "10Gi"
    }
```

Развертывание кластера больших данных будет использовать постоянное хранилище для хранения данных, метаданных и журналов для различных компонентов. Вы можете настроить размер утверждения постоянного тома, созданные как часть развертывания. Рекомендуется, мы рекомендуем использовать классы хранения с *Сохранить* [освободить политики](https://kubernetes.io/docs/concepts/storage/storage-classes/#reclaim-policy).

> [!NOTE]
> В версии CTP 3.0 нельзя изменять после параметра развертывания для хранения конфигурации. Кроме того только `ReadWriteOnce` поддерживается режим доступа для всего кластера.

> [!WARNING]
> Работа без постоянного хранения может работать в тестовой среде, но может произойти в кластере не работает. После перезапуска pod кластера метаданных и/или пользователя данные будут утеряны окончательно. Не рекомендуется выполнять в этой конфигурации. 

[Настройка хранилища](#config-samples) раздел содержит дополнительные примеры по настройке параметров хранилища для развертывания кластера больших данных SQL Server.

## <a name="aks-storage-classes"></a>Классы хранения в AKS

AKS поставляется с [два класса встроенного хранилища](https://docs.microsoft.com/azure/aks/azure-disks-dynamic-pv) **по умолчанию** и **управляемых premium** вместе с динамическое средство подготовки для их. Можно указать одним из них или создать свой собственный класс хранения для развертывания кластера больших данных с помощью включено постоянное хранилище. По умолчанию, встроенный в файле конфигурации кластера для aks *aks-dev-test.json* поставляется с постоянное хранилище конфигураций для использования **по умолчанию** класс хранения.

> [!WARNING]
> Постоянные тома, созданные с помощью встроенного хранилища классы **по умолчанию** и **управляемых premium** действует политика reclaim *удалить*. Поэтому во время удаления SQL Server больших данных кластера, утверждения постоянного тома получить также удаляется и затем постоянные тома. Можно создавать классы пользовательского хранилища с помощью **диска azure** privioner с *Сохранить* освободить политики, как показано в [это](https://docs.microsoft.com/en-us/azure/aks/concepts-storage#storage-classes) статьи.


## <a name="minikube-storage-class"></a>Класс хранения Minikube

Minikube поставляется с встроенного хранилища класс с именем **стандартный** вместе с динамической подготовки для него. Файл конфигурации, встроенный в для minikube *minikube-dev-test.json* имеет параметры конфигурации хранилища в спецификации плоскости управления. Те же параметры будут применяться к все технические пулов. Можно также настроить копию этого файла и использовать его для развертывания кластера больших данных на minikube. Кроме того, можно вручную изменять пользовательский файл и изменить размер утверждения постоянные тома для определенных пулов для размещения рабочих нагрузок, что вы хотите запустить. См. в разделе [настройки хранилища](#config-samples) редактирует примеры о том, как это сделать с помощью *mssqlctl* команды.

## <a name="kubeadm-storage-classes"></a>Классы хранения Kubeadm

Kubeadm не поставляется с классом встроенного хранилища. Необходимо создать собственные классы хранения и постоянные тома с помощью локального хранилища или Ваш предпочитаемый средство подготовки, например [ладья](https://github.com/rook/rook). В этом случае можно установить **className** для класса хранения, вы настроили. 

> [!NOTE]
>  Встроенные в в файле конфигурации развертывания для *kubeadm kubeadm-dev-test.json* отсутствует имя класса хранения для хранения данных и журналов. Перед развертыванием необходимо настроить файл конфигурации и задать значение для имени класса в противном случае произойдет сбой проверки перед развертыванием. Развертывание также имеет шаг проверки, которое проверяет наличие класса хранения, но не для необходимых постоянные тома. Необходимо убедиться, что создание достаточное количество томов в зависимости от масштаба кластера. В версии CTP 3.0 для размер кластера по умолчанию необходимо создать по крайней мере 23 тома. [Здесь](https://github.com/Microsoft/sql-server-samples/tree/master/samples/features/sql-big-data-cluster/deployment/kubeadm/ubuntu) приведен пример по созданию постоянные тома с помощью локального средства подготовки.


## <a name="customize-storage-configurations-for-each-pool"></a>Настройка конфигурации хранилища для каждого пула

Для всех настроек, необходимо сначала создать копию встроенные в файле конфигурации, которые вы хотите использовать. Например, следующая команда создает копию *aks-dev-test.json* файл конфигурации развертывания в текущем каталоге:

```bash
mssqlctl cluster config init --src aks-dev-test.json --target custom.json
```

Затем можно настроить файл конфигурации, отредактировав его вручную, или можно использовать *набор раздел конфигурации кластера mssqlctl* команды. Этот набор используется сочетание jsonpath и jsonpatch библиотеки для указания способов изменить файл конфигурации.

### <a name="configure-size"></a>Настройка размера

По умолчанию размер утверждения постоянного тома, выделенные для каждого из модулей, подготовленных в кластере составляет 10 ГБ. Это значение для обработки рабочих нагрузок, запущенных в пользовательский файл конфигурации перед развертыванием кластера, можно обновить.

В следующем примере обновляется только размер утверждения постоянного тома для данных, хранящихся в пуле носителей для 100Gi. Обратите внимание на то, что раздел хранилища должны существовать в файле конфигурации для пула носителей, перед выполнением этой команды:

```bash
mssqlctl cluster config section set -c custom.json -j "$.spec.pools[?(@.spec.type == ""Storage"")].spec.storage.data.size=100Gi"
```

В следующем примере обновляется размер утверждения постоянного тома для всех пулов в 32Gi:

```bash
mssqlctl cluster config section set -c custom.json -j "$.spec.controlPlane.spec.storage.data.size=32Gi"
```

### <a id="config-samples"></a> Настроить класс хранения

В примере показано, как изменить класс хранения для плоскости управления:

```bash
mssqlctl cluster config section set -c custom.json -j "$.spec.controlPlane.spec.storage.data.className=<yourStorageClassName>"
```

Другой вариант — Изменить настраиваемый файл конфигурации вручную или использовать jsonpatch как в следующем примере, который изменяет класс хранилища для пула носителей. Создание *patch.json* файл с таким содержимым:

```json
{
  "patch": [
    {
      "op": "add",
      "path": "$.spec.pools[?(@.spec.type == 'Storage')].spec.storage",
      "value": {
          "data": {
            "className": "default",
            "accessMode": "ReadWriteOnce",
            "size": "100Gi"
          },
          "logs": {
            "className": "default",
            "accessMode": "ReadWriteOnce",
            "size": "32Gi"
          }
        }
      }
  ]
}
```

Примените файл исправления. Используйте *набор раздел конфигурации кластера mssqlctl* команду, чтобы применить изменения в файл исправления JSON. В следующем примере применяется файл patch.json для custom.json файл целевой конфигурации развертывания.

```bash
mssqlctl cluster config section set -c custom.json -p ./patch.json
```

## <a name="next-steps"></a>Следующие шаги

Полную документацию о томах в Kubernetes см. в разделе [документации по Kubernetes на томах](https://kubernetes.io/docs/concepts/storage/volumes/).

Дополнительные сведения о развертывании кластера больших данных SQL Server, см. в разделе [развертывание сервера SQL, большие данные кластера в Kubernetes](deployment-guidance.md).

