---
title: Сохраняемость данных в Kubernetes
titleSuffix: SQL Server big data clusters
description: Узнайте, как реализуется сохраняемость данных в кластере больших данных SQL Server 2019.
author: mihaelablendea
ms.author: mihaelab
ms.reviewer: mikeray
ms.date: 08/28/2019
ms.topic: conceptual
ms.prod: sql
ms.technology: big-data-cluster
ms.openlocfilehash: bb6d87803c0a3839afd8dbd1333b52c3abcc4518
ms.sourcegitcommit: dacf6c57f6a2e3cf2005f3268116f3c609639905
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/11/2019
ms.locfileid: "70878735"
---
# <a name="data-persistence-with-sql-server-big-data-cluster-on-kubernetes"></a>Сохраняемость данных при использовании кластера больших данных SQL Server в Kubernetes

[!INCLUDE[tsql-appliesto-ssver15-xxxx-xxxx-xxx](../includes/tsql-appliesto-ssver15-xxxx-xxxx-xxx.md)]

[Постоянные тома](https://kubernetes.io/docs/concepts/storage/persistent-volumes/) предоставляют модель подключения для хранилища в Kubernetes. Предоставление хранилища абстрагируется от его использования. Поэтому вы можете подключить собственное хранилище высокого уровня доступности к кластеру больших данных SQL Server. Это позволяет получить полный контроль над типом хранилища, доступностью и производительностью. Kubernetes поддерживает различные типы решений для хранения данных, включая диски и файлы Azure, NFS, локальное хранилище и многое другое.

## <a name="configure-persistent-volumes"></a>Настройка постоянных томов

Постоянные тома используются в кластере больших данных SQL Server посредством [классов хранения](https://kubernetes.io/docs/concepts/storage/storage-classes/). Вы можете создать различные классы хранения для хранилищ разных типов и указать их во время развертывания кластера больших данных. Вы также можете указать, какие класс хранения и размер постоянного тома должны использоваться в тех или иных целях, на уровне пула. Кластер больших данных SQL Server создает [утверждения постоянных томов](https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims) с указанным именем класса хранения для каждого компонента, которому требуются постоянные тома. Затем он подключает соответствующие постоянные тома в объекте pod. 

## <a name="configure-big-data-cluster-storage-settings"></a>Настройка параметров хранилища для кластера больших данных

Аналогично другим настройкам можно указать параметры хранилища в файлах конфигурации кластера во время развертывания для каждого пула в файле конфигурации **BDC. JSON** и для служб управления в файле **Control. JSON** . Если в спецификациях пула нет параметров конфигурации хранилища, параметры хранилища элементов управления будут использоваться **для всех остальных компонентов**, включая SQL Server master (**главный** ресурс), HDFS (ресурс**хранения-0** ) или данные. подключений. Вот пример раздела конфигурации хранилища, который можно включить в спецификацию:

```json
    "storage": 
    {
      "data": {
        "className": "default",
        "accessMode": "ReadWriteOnce",
        "size": "15Gi"
      },
      "logs": {
        "className": "default",
        "accessMode": "ReadWriteOnce",
        "size": "10Gi"
    }
```

Развернутый кластер больших данных будет использовать постоянное хранилище для хранения данных, метаданных и журналов различных компонентов. Вы можете настроить размер утверждений постоянных томов, создаваемых в ходе развертывания. Рекомендуется использовать классы хранения с [политикой освобождения](https://kubernetes.io/docs/concepts/storage/storage-classes/#reclaim-policy) *Сохранение*.

> [!NOTE]
> В версии CTP 3.2 нельзя изменить параметр конфигурации хранилища после развертывания. Кроме того, для всего кластера поддерживается только режим доступа `ReadWriteOnce`.

> [!WARNING]
> Запуск без постоянного хранилища возможен в тестовой среде, но может привести к утрате работоспособности кластера. При перезапуске pod метаданные кластера и пользовательские данные будут утеряны без возможности восстановления. Использовать эту конфигурацию не рекомендуется. 

В разделе [Настройка хранилища](#config-samples) приведены дополнительные примеры настройки параметров хранилища для развертывания кластера больших данных SQL Server.

## <a name="aks-storage-classes"></a>Классы хранения AKS

В AKS есть [два встроенных класса хранения](https://docs.microsoft.com/azure/aks/azure-disks-dynamic-pv): **по умолчанию** и **управляемый категории "Премиум"** , а также средство их динамической подготовки. Вы можете выбрать любой из них или создать собственный класс хранения для развертывания кластера больших данных с включенным постоянным хранилищем. По умолчанию встроенный файл конфигурации кластера для AKS *aks-dev-test* содержит конфигурации постоянного хранилища, предусматривающие использование класса хранения **по умолчанию**.

> [!WARNING]
> Постоянные тома, созданные с помощью встроенных классов хранения **по умолчанию** и **managed -premium**, имеют политику освобождения *Удаление*. Поэтому при удалении кластера больших данных SQL Server утверждения постоянных томов удаляются, а затем удаляются и сами тома. Вы можете создавать пользовательские классы хранения с помощью средства подготовки **azure-disk** с политикой освобождения *Сохранение*, как показано в [этой статье](https://docs.microsoft.com/azure/aks/concepts-storage#storage-classes).


## <a name="minikube-storage-class"></a>Класс хранения Minikube

В Minikube есть встроенный класс хранения **стандартный**, а также средство его динамической подготовки. Встроенный файл конфигурации для minikube *minikube-dev-test* содержит параметры конфигурации хранилища в спецификации уровня управления. Одинаковые параметры применяются ко всем спецификациям пулов. Кроме того, можно настроить копию этого файла и использовать ее для развертывания кластера больших данных в minikube. Вы можете вручную отредактировать пользовательский файл и изменить размер утверждений постоянных томов для конкретных пулов, чтобы они соответствовали выполняемым рабочим нагрузкам. Примеры внесения изменений с помощью команд *azdata* см. в разделе [Настройка хранилища](#config-samples).

## <a name="kubeadm-storage-classes"></a>Классы хранения Kubeadm

В Kubeadm нет встроенного класса хранения. Необходимо создать собственные классы хранения и постоянные тома с помощью локального хранилища или предпочтительного средства подготовки, например [Rook](https://github.com/rook/rook). В этом случае необходимо присвоить свойству **className** настроенный класс хранения. 

> [!NOTE]
>  Во встроенном файле конфигурации развертывания для *kubeadm kubeadm-dev-test* не указано имя класса хранения для хранилища данных и журналов. Перед развертыванием необходимо настроить файл конфигурации и задать значение для className, иначе проверки перед развертыванием завершатся ошибкой. Во время развертывания также проверяется наличие класса хранения, но наличие требуемых постоянных томов не проверяется. Необходимо создать достаточно томов в зависимости от размера кластера. В версии CTP 3.1 для размера кластера по умолчанию нужно создать не менее 23 томов. [Здесь](https://github.com/Microsoft/sql-server-samples/tree/master/samples/features/sql-big-data-cluster/deployment/kubeadm/ubuntu) можно найти пример создания постоянных томов с помощью локального средства подготовки.


## <a name="customize-storage-configurations-for-each-pool"></a>Настройка конфигураций хранилища для каждого пула

Для любой настройки необходимо сначала создать копию встроенного файла конфигурации, который требуется использовать. Например, следующая команда создает копию файлов конфигурации развертывания *aks-dev-test* в подкаталоге `custom`:

```bash
azdata bdc config init --source aks-dev-test --target custom
```

При этом создаются два файла: **BDC. JSON** и **Control. JSON** , которые могут быть настроены вручную, либо можно использовать команду **аздата BDC config** . Для изменения файлов конфигурации можно использовать сочетание библиотек jsonpath и jsonpatch.


### <a id="config-samples"></a> Настройка имени класса хранения и размера утверждений

По умолчанию размер утверждений постоянных томов, подготавливаемых для каждого модуля pod в кластере, составляет 10 ГБ. Это значение можно изменить в соответствии с выполняемыми рабочими нагрузками в пользовательском файле конфигурации перед развертыванием кластера.

В приведенном ниже примере изменяется размер утверждений постоянных томов на 32 ГБ в файле **control.jsaon**. Если этот параметр не переопределен на уровне пула, он применяется ко всем пулам.

```bash
azdata bdc config replace --config-file custom/control.json --json-values "$.spec.storage.data.size=100Gi"
```

В следующем примере показано, как изменить класс хранения для файла **control.json**:

```bash
azdata bdc config replace --config-file custom/control.json --json-values "$.spec.storage.data.className=<yourStorageClassName>"
```

Другой способ — вручную изменить пользовательский файл конфигурации или использовать исправление JSON, как в приведенном ниже примере, в котором изменяется класс хранения для пула носителей. Создайте файл *patch.json* с таким содержимым:

```json
{
  "patch": [
    {
      "op": "replace",
      "path": "$.spec.resources.storage-0.spec",
      "value": {
        "type":"Storage",
        "replicas":2,
        "storage":{
            "data":{
                    "size": "100Gi",
                    "className": "myStorageClass",
                    "accessMode":"ReadWriteOnce"
                    },
            "logs":{
                    "size":"32Gi",
                    "className":"myStorageClass",
                    "accessMode":"ReadWriteOnce"
                    }
                }
            }
        }
    ]
}
```

Примените файл исправления. Используйте команду **azdata bdc config patch**, чтобы применить изменения в файле исправления JSON. В приведенном ниже примере файл patch.json применяется к целевому файлу конфигурации развертывания custom.json.

```bash
azdata bdc config patch --config-file custom/bdc.json --patch-file ./patch.json
```

## <a name="next-steps"></a>Следующие шаги

Полные сведения о томах в Kubernetes см. в [документации Kubernetes по томам](https://kubernetes.io/docs/concepts/storage/volumes/).

Дополнительные сведения о развертывании кластера больших данных SQL Server см. в статье [Развертывание кластера больших данных SQL Server в Kubernetes](deployment-guidance.md).

