---
title: Развертывание SQL Server кластера больших данных с высокой доступностью
titleSuffix: Deploy SQL Server Big Data Cluster with high availability
description: Узнайте, как развернуть [!INCLUDE[big-data-clusters-2019](../includes/ssbigdataclusters-ver15.md)] (Предварительная версия) в с высоким уровнем доступности.
author: mihaelablendea
ms.author: mihaelab
ms.reviewer: mikeray
ms.date: 08/28/2019
ms.topic: conceptual
ms.prod: sql
ms.technology: big-data-cluster
ms.openlocfilehash: 4053ac15309b821a9cf50cf067ad459256369418
ms.sourcegitcommit: af5e1f74a8c1171afe759a4a8ff2fccb5295270a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/02/2019
ms.locfileid: "71823578"
---
# <a name="deploy-sql-server-big-data-cluster-with-high-availability"></a>Развертывание SQL Server кластера больших данных с высокой доступностью

[!INCLUDE[tsql-appliesto-ssver15-xxxx-xxxx-xxx](../includes/tsql-appliesto-ssver15-xxxx-xxxx-xxx.md)]

Во время развертывания кластера больших данных (BDC) можно настроить SQL Server master для развертывания в конфигурации группы доступности. Эта конфигурация повышает надежность SQL Server хозяина, поверх того, какая инфраструктура Kubernetes обеспечивается встроенным мониторингом работоспособности, обнаружением сбоев и механизмами отработки отказа. Группы доступности (AG) добавляют избыточность к экземпляру SQL Server. В этой конфигурации задачи мониторинга, обнаружения сбоев и отработки отказа управляются службой управления кластерами больших данных, а именно службой управления.

Кроме того, другие задачи администрирования, такие как Настройка конечных точек зеркального отображения базы данных, создание группы доступности и Добавление баз данных в группу доступности, предоставляются платформой кластера больших данных.

Ниже приведены некоторые возможности, которые включаются группами доступности.

1. Если в файле конфигурации развертывания указаны параметры высокой доступности, создается одна группа доступности с именем `containedag` . По умолчанию `containedag` имеет три реплики, включая первичный. Все операции CRUD для группы доступности управляются внутренним образом.
1. Все базы данных автоматически добавляются в группу доступности, включая `master` и `msdb`. Базы данных конфигурации polybase не включаются в группу доступности, так как они включают в себя метаданные уровня экземпляра, относящиеся к каждой реплике.
1. Внешняя конечная точка автоматически подготавливается для подключения к базам данных группы доступности. Эта конечная точка `master-svc-external` играет роль прослушивателя группы доступности.
1. Вторая внешняя конечная точка подготавливается для подключений только для чтения к вторичным репликам. 


# <a name="deploy"></a>Развертывание

Чтобы развернуть SQL Server master в группе доступности, выполните следующие действия.

1. `hadr` Включение функции
1. Укажите число реплик для группы доступности (минимальное значение — 3).
1. Настройка сведений о второй внешней конечной точке, созданной для подключений к вторичным репликам, которые доступны только для чтения

Ниже показано, как создать файл исправления, включающий эти параметры, а также как применить его к `aks-dev-test` профилям конфигурации или. `kubeadm-dev-test` Эти шаги покажут пример обновления `aks-dev-test` профиля для добавления атрибутов высокой доступности. Для развертывания в кластере кубеадм будет применено аналогичное исправление, но убедитесь, что вы используете *нодепорт* для **serviceType** в разделе **конечные точки** .

1. `patch.json` Создание файла

    ```json
    {
      "patch": [
        {
          "op": "replace",
          "path": "spec.resources.master.spec",
          "value": {
            "type": "Master",
            "replicas": 3,
            "endpoints": [
              {
                "name": "Master",
                "serviceType": "LoadBalancer",
                "port": 31433
              },
              {
                "name": "MasterSecondary",
                "serviceType": "LoadBalancer",
                "port": 31436
              }
            ],
            "settings": {
              "sql": {
                "hadr.enabled": "true"
              }
            }
          }
        }
      ]
    }
    ```

1. Клонирование целевого профиля

    ```bash
    azdata bdc config init --source aks-dev-test --target custom-aks
    ```

1. Применение файла исправления в настраиваемом профиле

    ```bash
    azdata bdc config patch -c custom-aks/bdc.json --patch-file patch.json
    ```
1. Запуск развертывания кластера с помощью созданного выше профиля конфигурации кластера

    ```bash
    azdata bdc create --config-profile custom-aks --accept-eula yes
    ```

## <a name="connect-to-sql-server-databases"></a>Подключение к базам данных SQL Server

В зависимости от типа рабочей нагрузки, которую необходимо выполнить для SQL Server master, можно подключиться к первичной рабочей нагрузке для чтения и записи или к базам данных вторичных реплик для типа рабочих нагрузок только для чтения. Ниже приведена структура для каждого типа подключения.

### <a name="connect-to-databases-on-the-primary-replica"></a>Подключение к базам данных в первичной реплике

Для соединений с первичной репликой используйте `sql-server-master` конечную точку. Эта конечная точка также является прослушивателем для группы доступности. Все соединения находятся в контексте группы доступности. Например, соединение по умолчанию, использующее эту конечную точку, приведет `master` к подключению к базе данных в группе доступности `master` , а не к базе данных экземпляра SQL Server.

```bash
azdata bdc endpoint list -e sql-server-master -o table
```

`Description                           Endpoint             Name               Protocol`
`------------------------------------  -------------------  -----------------  ----------`
`SQL Server Master Instance Front-End  13.64.235.192,31433  sql-server-master  tds`

> [!NOTE]
> События отработки отказа могут происходить во время выполнения распределенного запроса, осуществляющего доступ к данным из удаленных источников данных, таких как HDFS или пул данных. Рекомендуется, чтобы приложения создавали логику повторного подключения в случае отключения, вызванного отработкой отказа.  
>

### <a name="connect-to-databases-on-the-secondary-replicas"></a>Подключение к базам данных на вторичных репликах

Для подключений только для чтения к базам данных во вторичных репликах используйте `sql-server-master-readonly` конечную точку. Эта конечная точка действует как балансировщик нагрузки во всех вторичных репликах. Укажите контекст пользовательской базы данных в строке подключения.

```bash
azdata bdc endpoint list -e sql-server-master-readonly -o table
```

`Description                                    Endpoint            Name                        Protocol`
`---------------------------------------------  ------------------  --------------------------  ----------`
`SQL Server Master Readable Secondary Replicas  13.64.238.24,31436  sql-server-master-readonly  tds`

### <a id="instance-connect"></a>Подключение к SQL Server экземпляру

Для некоторых операций, таких как установка конфигураций на уровне сервера или Добавление базы данных в группу доступности вручную (в случае, если база данных была создана с помощью рабочего процесса восстановления), необходимо соединение с экземпляром. Чтобы обеспечить это подключение, предоставьте внешнюю конечную точку. Ниже приведен пример того, как предоставить эту конечную точку, а затем добавить базу данных, созданную с помощью рабочего процесса восстановления, в группу доступности.

- Определите модуль Pod, на котором размещена первичная реплика `sql-server-master` , подключившись к конечной точке и выполнив команду:

    ```sql
    SELECT @@SERVERNAME
   ```

- Предоставление внешней конечной точки путем создания новой службы Kubernetes

    Для кластера кубеадм выполните команду ниже. Замените `podName` на имя сервера, возвращенного на предыдущем шаге, с `serviceName` предпочтительным именем для службы Kubernetes, созданным и `namespaceName`* с именем кластера BDC.

    ```bash
    kubectl -n <namespaceName> expose pod <podName> --port=1533  --name=<serviceName> --type=NodePort
    ```

    Для запуска кластера AKS выполните ту же команду, за исключением того, что созданная служба будет иметь `LoadBalancer`тип. Пример: 

    ```bash
    kubectl -n <namespaceName> expose pod <podName> --port=1533  --name=<serviceName> --type=LoadBalancer
    ```

    Ниже приведен пример выполнения этой команды для AKS, где Pod, где размещается первичная `master-0`база данных:

    ```bash
    kubectl -n mssql-cluster expose pod master-0 --port=1533  --name=master-sql-0 --type=LoadBalancer
    ```

    Получите IP-адрес созданной службы Kubernetes:

    ```bash
    kubectl get services -n <namespaceName>
    ```

> [!IMPORTANT]
> Рекомендуется очистить, удалив созданную выше службу Kubernetes, выполнив следующую команду:
>
>```bash
>kubectl delete svc master-sql-0 -n mssql-cluster
>```

- Добавьте базу данных в группу доступности.

    Чтобы база данных была добавлена в группу доступности, ее необходимо запустить в режиме полного восстановления и создать резервную копию журнала. Используйте IP-адрес из службы Kubernetes, созданной выше, и подключитесь к экземпляру SQL Server, а затем выполните инструкции TSQL, как показано ниже.

    ```sql
    ALTER DATABASE <databaseName> SET RECOVERY FULL;
    BACKUP DATABASE <databaseName> TO DISK='<filePath>'
    ALTER AVAILABILITY GROUP containedag ADD DATABASE <databaseName>
    ```

    В следующем примере добавляется база данных `sales` с именем, которая была восстановлена в экземпляре.

    ```sql
    ALTER DATABASE sales SET RECOVERY FULL;
    BACKUP DATABASE sales TO DISK='/var/opt/mssql/data/sales.bak'
    ALTER AVAILABILITY GROUP containedag ADD DATABASE sales
    ```

## <a name="known-limitations"></a>Известные ограничения

Ниже приведены известные проблемы и ограничения, связанные с группами доступности для SQL Server master в кластере больших данных.

- Базы данных, созданные как результат `CREATE DATABASE` , отличные от Like `CREATE DATABASE FROM SNAPSHOT` `RESTORE`, не добавляются автоматически в группу доступности. [Подключитесь к экземпляру](#instance-connect) и добавьте базу данных в группу доступности вручную.
- Для определенных операций, таких как запуск параметров `sp_configure` конфигурации сервера с требованием соединения с главным экземпляром. Нельзя использовать соответствующую основную конечную точку. Следуйте [инструкциям](#instance-connect) , чтобы подключиться к экземпляру SQL Server и запустить `sp_configure`.
- Конфигурация высокой доступности должна быть создана при развертывании BDC. Вы не можете включить конфигурацию высокой доступности с группами доступности после развертывания.

## <a name="next-steps"></a>Следующие шаги

- Дополнительные сведения об использовании файлов конфигурации в развертываниях кластера больших данных см. в разделе [развертывание [!INCLUDE[big-data-clusters-2019](../includes/ssbigdataclusters-ss-nover.md)] в Kubernetes](deployment-guidance.md#configfile).
- Дополнительные сведения о функциях групп доступности для SQL Server см. в разделе [Обзор групп доступности Always On (SQL Server)](https://docs.microsoft.com/en-us/sql/database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server?view=sql-server-2017).
