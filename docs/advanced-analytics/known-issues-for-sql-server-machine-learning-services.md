---
title: Известные проблемы с интеграцией языка R и Python
ms.prod: sql
ms.technology: machine-learning
ms.date: 06/13/2019
ms.topic: conceptual
author: dphansen
ms.author: davidph
monikerRange: '>=sql-server-2016||>=sql-server-linux-ver15||=sqlallproducts-allversions'
ms.openlocfilehash: 93b2871fa60d6a7c7a41fae202e960440b53c11e
ms.sourcegitcommit: 321497065ecd7ecde9bff378464db8da426e9e14
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/01/2019
ms.locfileid: "68715196"
---
# <a name="known-issues-in-machine-learning-services"></a>Известные проблемы в Службы машинного обучения
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md](../includes/appliesto-ss-xxxx-xxxx-xxx-md.md)]

В этой статье описываются известные проблемы или ограничения, связанные с компонентами машинного обучения, которые предоставляются в качестве варианта в [SQL Server 2016 служб r](r/sql-server-r-services.md) и [SQL Server службы машинного обучения с R и Python](what-is-sql-server-machine-learning.md).

## <a name="setup-and-configuration-issues"></a>Проблемы при установке и настройке

Описание процессов и часто задаваемых вопросов, связанных с начальной настройкой и настройкой, см. в разделе [часто задаваемые вопросы об обновлении и установке](r/upgrade-and-installation-faq-sql-server-r-services.md). Он содержит сведения об обновлениях, параллельной установке и установке новых компонентов R или Python.

### <a name="1-inconsistent-results-in-mkl-computations-due-to-missing-environment-variable"></a>1. Непоследовательные результаты в вычислениях MKL из-за отсутствия переменной среды

**Применимо к:** R_SERVER двоичные файлы 9,0, 9,1, 9,2 или 9,3.

R_SERVER использует библиотеку Intel Math Kernel Library (MKL). Для вычислений, включающих MKL, непротиворечивые результаты могут возникать, если в системе отсутствует переменная среды. 

Задайте переменную `'MKL_CBWR'=AUTO` среды, чтобы обеспечить условное числовое воспроизводимость в R_SERVER. Дополнительные сведения см. [в статье Введение в условное числовое воспроизводимость (CNR)](https://software.intel.com/articles/introduction-to-the-conditional-numerical-reproducibility-cnr).

**Обходное решение**

1. На панели управления щелкните **система и система безопасности** >  > **Дополнительные** > **переменные среды**системы.

2. Создайте новую пользовательскую или системную переменную. 

  + Задайте для переменной имя "MKL_CBWR".
  + Присвойте параметру "переменная value" значение "AUTO".

3. Перезапустите R_SERVER. На SQL Server можно перезапустить службу панель запуска SQL Server.

> [!NOTE]
> Если вы используете предварительную версию SQL Server 2019 в Linux, измените или создайте *bash_profile* в домашнем каталоге пользователя, добавив строку `export MKL_CBWR="AUTO"`. Выполните этот файл, введя `source .bash_profile` команду в командной строке Bash. Перезапустите R_SERVER, `Sys.getenv()` введя в командной строке R.

### <a name="2-r-script-runtime-error-sql-server-2017-cu5-cu7-regression"></a>2. Ошибка времени выполнения скрипта R (SQL Server 2017 CU5-И НАКОПИТЕЛЬНЫМ регрессия)

Для SQL Server 2017 в накопительных обновлениях от 5 до 7 существует регрессия в файле **rlauncher. config** , где путь к файлу временной папки содержит пробел. Эта регрессия исправлена в CU8.

Ошибка, которую вы увидите при выполнении скрипта R, включает следующие сообщения:

> *Не удалось связаться со средой выполнения для скрипта "R". Проверьте требования среды выполнения "R".*
>
> Сообщения STDERR из внешнего скрипта: 
>
> *Неустранимая ошибка: не удается создать "R_TempDir"*

**Обходное решение**

Примените CU8, когда она станет доступной. Кроме того, можно повторно создать **файл rlauncher. config** , запустив **registerrext** с помощью команды Удалить или установить в командной строке с повышенными привилегиями. 

```cmd
<SQLInstancePath>\R_SERVICES\library\RevoScaleR\rxLibs\x64\RegisterRExt.exe /uninstall /sqlbinnpath:<SQLInstanceBinnPath> /userpoolsize:0 /instance:<SQLInstanceName>

<SQLInstancePath>\R_SERVICES\library\RevoScaleR\rxLibs\x64\RegisterRExt.exe /install /sqlbinnpath:<SQLInstanceBinnPath> /userpoolsize:0 /instance:<SQLInstanceName>
```

В следующем примере показаны команды с экземпляром по умолчанию «MSSQL14». MSSQLSERVER "установлено в" C:\Program Files\Microsoft SQL Server\":

```cmd
"C:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\R_SERVICES\library\RevoScaleR\rxLibs\x64\RegisterRext.exe" /uninstall /sqlbinnpath:"C:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\Binn" /userpoolsize:0 /instance:MSSQLSERVER

"C:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\R_SERVICES\library\RevoScaleR\rxLibs\x64\RegisterRext.exe" /install /sqlbinnpath:"C:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\Binn" /userpoolsize:0 /instance:MSSQLSERVER
```

### <a name="3-unable-to-install-sql-server-machine-learning-features-on-a-domain-controller"></a>3. Не удается установить компоненты машинного обучения SQL Server на контроллере домена

При попытке установить службы R SQL Server 2016 или SQL Server Службы машинного обучения на контроллере домена происходит сбой программы установки со следующими ошибками:

> *Произошла ошибка в процессе установки компонента*
> 
> *Не удается найти группу с удостоверением*
> 
> *Код ошибки компонента: 0x80131509*

Сбой происходит из-за того, что на контроллере домена служба не может создать 20 локальных учетных записей, необходимых для запуска машинного обучения. В общем случае не рекомендуется устанавливать SQL Server на контроллере домена. Дополнительные сведения см. в [бюллетене по поддержке 2032911](https://support.microsoft.com/help/2032911/you-may-encounter-problems-when-installing-sql-server-on-a-domain-cont).

### <a name="4-install-the-latest-service-release-to-ensure-compatibility-with-microsoft-r-client"></a>4. Установите последнюю версию службы, чтобы обеспечить совместимость с Microsoft R Client

Если вы устанавливаете последнюю версию Microsoft R Client и используете ее для запуска R на SQL Server в удаленном контексте вычислений, может появиться сообщение об ошибке следующего вида:

> *Вы используете версию 9. x. x Microsoft R Client на компьютере, которая несовместима с Microsoft R Server версии 8. x.x. Скачайте и установите совместимую версию*.

SQL Server 2016 требует, чтобы библиотеки R на клиенте точно совпадали с библиотеками R на сервере. Ограничение было удалено для выпусков более поздней версии, чем R Server 9.0.1. Однако при возникновении этой ошибки проверьте версию библиотек R, используемых клиентом и сервером, и при необходимости обновите клиент в соответствии с версией сервера.

Версия R, установленная с SQL Server R Services, обновляется при установке выпуска службы SQL Server. Чтобы гарантировать, что вы всегда имеете самые последние версии компонентов R, обязательно установите все пакеты обновления.

Чтобы обеспечить совместимость с Microsoft R Client 9.0.0, установите обновления, описанные в этой [статье о поддержке](https://support.microsoft.com/kb/3210262).

Чтобы избежать проблем с пакетами R, можно также обновить версии библиотек R, установленных на сервере, изменив соглашение об обслуживании на использование современной политики поддержки жизненного цикла, как описано в [следующем разделе](#bkmk_sqlbindr). При этом версия R, установленная с SQL Server, обновляется по тому же расписанию, которое использовалось для обновления сервера машинного обучения (ранее Microsoft R Server).

**Применимо к:** SQL Server 2016 служб R с R Server версии 9.0.0 или более ранней

### <a name="5-r-components-missing-from-cu3-setup"></a>5. Компоненты R, отсутствующие в программе установки CU3

Было подготовлено ограниченное количество виртуальных машин Azure без файлов установки R, которые должны быть добавлены в SQL Server. Эта ошибка относится к виртуальным машинам, подготовленным за период с 2018-01-05 по 2018-01-23. Эта проблема также может повлиять на локальные установки, если вы применили обновление CU3 для SQL Server 2017 в течение периода с 2018-01-05 до 2018-01-23.

Предоставлена версия службы, которая включает в себя правильную версию файлов установки R.

+ [Накопительный пакет обновления 3 для SQL Server 2017 KB4052987](https://www.microsoft.com/download/details.aspx?id=56128).

Чтобы установить компоненты и восстановить SQL Server 2017 CU3, необходимо удалить CU3 и переустановить обновленную версию:

1. Скачайте обновленный файл установки CU3, содержащий установщики R.
2. Удалите CU3. В панели управления найдите параметр **удалить обновление**, а затем выберите исправление 3015 для SQL Server 2017 (KB4052987) (64-bit). Выполните действия по удалению.
3. Переустановите обновление CU3, дважды щелкнув обновление для KB4052987, которое вы только что скачали `SQLServer2017-KB4052987-x64.exe`. Следуйте инструкциям по установке.

### <a name="6-unable-to-install-python-components-in-offline-installations-of-sql-server-2017-ctp-20-or-later"></a>6. Не удается установить компоненты Python в автономных установках SQL Server 2017 CTP 2,0 или более поздней версии

Если установить предварительную версию SQL Server 2017 на компьютере без доступа к Интернету, установщик может не отобразить страницу с запросом расположения скачанных компонентов Python. В таком случае можно установить компонент Службы машинного обучения, но не компоненты Python.

Эта проблема исправлена в версии выпуска. Кроме того, это ограничение не распространяется на компоненты R.

**Применимо к:** SQL Server 2017 с Python

### <a name="bkmk_sqlbindr"></a>Предупреждение о несовместимой версии при подключении к более старой версии SQL Server R Services с клиента с помощью[!INCLUDE[ssSQLv14_md](../includes/sssqlv14-md.md)]

При выполнении кода R в контексте вычислений SQL Server 2016 может появиться следующее сообщение об ошибке:

> *На компьютере используется версия 9.0.0 клиента Microsoft R, которая несовместима с Microsoft R Server версии 8.0.3. Скачайте и установите совместимую версию*.

Это сообщение отображается, если одно из следующих двух выражений имеет значение true,

+ Сервер R Server (изолированный) установлен на клиентском компьютере с помощью мастера [!INCLUDE[ssSQLv14_md](../includes/sssqlv14-md.md)]установки.
+ Вы установили Microsoft R Server с помощью [отдельного установщика Windows](https://docs.microsoft.com/machine-learning-server/install/r-server-install-windows).

Чтобы убедиться, что сервер и клиент используют одну и ту же версию, может потребоватьсяиспользовать привязку, поддерживаемую для Microsoft R Server 9,0 и более поздних версий, чтобы обновить компоненты R в экземплярах SQL Server 2016. Чтобы определить, доступна ли поддержка обновлений для вашей версии служб R, см. статью [Обновление экземпляра служб r с помощью SqlBindR. exe](install/upgrade-r-and-python.md).

**Применимо к:** SQL Server 2016 служб R с R Server версии 9.0.0 или более ранней

### <a name="7-setup-for-sql-server-2016-service-releases-might-fail-to-install-newer-versions-of-r-components"></a>7. При установке выпусков служб SQL Server 2016 могут не установиться более новые версии компонентов R.

При установке накопительного обновления или установке пакета обновления для SQL Server 2016 на компьютере, который не подключен к Интернету, мастер установки может не отображать запрос, позволяющий обновить компоненты R с помощью скачанных CAB-файлов. Эта ошибка обычно возникает, когда несколько компонентов были установлены вместе с ядром СУБД.

В качестве обходного решения можно установить выпуск службы с помощью командной строки и указать `MRCACHEDIRECTORY` аргумент, как показано в этом примере, который устанавливает обновления CU1:

`C:\<path to installation media>\SQLServer2016-KB3164674-x64.exe /Action=Patch /IACCEPTROPENLICENSETERMS /MRCACHEDIRECTORY=<path to CU1 CAB files>`

Чтобы получить последние установщики, ознакомьтесь со статьей [Установка компонентов машинного обучения без доступа к Интернету](install/sql-ml-component-install-without-internet-access.md).

**Применимо к:** SQL Server 2016 служб R с R Server версии 9.0.0 или более ранней

### <a name="8-launchpad-services-fails-to-start-if-the-version-is-different-from-the-r-version"></a>8. Не удается запустить службы панели запуска, если версия отличается от версии R

Если SQL Server R Services устанавливается отдельно от ядра СУБД, а версии сборки отличаются, в журнале системных событий может появиться следующее сообщение об ошибке:

> *Не удалось запустить службу панель запуска SQL Server из-за следующей ошибки: Служба не ответила на запрос запуска или управления в течение отведенного времени.*

Например, эта ошибка может возникать, если установить ядро СУБД с помощью версии выпуска, применить исправление для обновления ядра СУБД, а затем добавить компонент служб R с помощью версии выпуска.

Чтобы избежать этой проблемы, используйте служебную программу, например диспетчер файлов, для сравнения версий файла rskeymgmt. exe с версией двоичных файлов SQL, например склдк. dll. Все компоненты должны иметь одинаковый номер версии. Если вы обновляете один компонент, обязательно примените это же обновление ко всем остальным установленным компонентам.

Найдите панель запуска в `Binn` папке для экземпляра. Например, при установке по умолчанию SQL Server 2016, путь может быть `C:\Program Files\Microsoft SQL Server\MSSQL.13.InstanceNameMSSQL\Binn`таким:. 

### <a name="9-remote-compute-contexts-are-blocked-by-a-firewall-in-sql-server-instances-that-are-running-on-azure-virtual-machines"></a>9. Удаленные контексты вычислений блокируются брандмауэром в SQL Server экземплярах, работающих на виртуальных машинах Azure.

Если вы установили [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)] на виртуальной машине Windows Azure, возможно, вы не сможете использовать контексты вычислений, требующие использования рабочей области виртуальной машины. Причина заключается в том, что по умолчанию брандмауэр на виртуальных машинах Azure включает правило, которое блокирует сетевой доступ для локальных учетных записей пользователей R.

В качестве обходного решения на виртуальной машине Azure откройте **Брандмауэр Windows в области повышенная безопасность**, выберите правила для исходящих **подключений**и отключите следующее правило. **Блокировать сетевой доступ для учетных записей локальных пользователей R в SQL Server экземпляре MSSQLSERVER**. Можно также оставить правило включенным, но изменить значение свойства безопасность на **Разрешить, если**оно защищено.

### <a name="10-implied-authentication-in-sqlexpress"></a>10. Неявная проверка подлинности в SQLEXPRESS

При выполнении заданий R с удаленной рабочей станции обработки данных с использованием встроенной проверки подлинности Windows SQL Server использует *неявную проверку* подлинности для создания любых ЛОКАЛЬНЫХ вызовов ODBC, которые могут потребоваться для скрипта. Но эта функция не работала в сборке RTM экспресс-выпуска SQL Server.

Чтобы устранить эту проблему, рекомендуем произвести обновление до более позднего выпуска службы.

Если обновление не является выполнимым, в качестве обходного пути используйте имя входа SQL для выполнения удаленных заданий R, которые могут потребовать внедренных вызовов ODBC.

**Применимо к:** SQL Server 2016 R Services Express Edition

### <a name="11-performance-limits-when-libraries-used-by-sql-server-are-called-from-other-tools"></a>11. Ограничения производительности при вызове библиотек, используемых SQL Server, из других средств

Можно вызвать библиотеки машинного обучения, установленные для SQL Server из внешнего приложения, например RGui. Это может быть наиболее удобным способом выполнения определенных задач, таких как установка новых пакетов или выполнение нерегламентированных тестов на очень коротких примерах кода. Однако за пределами SQL Server производительность может быть ограничена. 

Например, даже если вы используете выпуск Enterprise SQL Server, R работает в однопотоковом режиме при выполнении кода R с помощью внешних средств. Чтобы получить преимущества производительности в SQL Server, инициируйте SQL Server подключение и используйте [sp_execute_external_script](../relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql.md) для вызова внешней среды выполнения скрипта.

Как правило, избегайте вызова библиотек машинного обучения, используемых SQL Server из внешних средств. Если вам нужно выполнить отладку кода R или Python, это проще всего сделать за пределами SQL Server. Чтобы получить те же библиотеки, которые находятся в SQL Server, можно установить Microsoft R Client, [SQL Server 2017 Machine Learning Server (автономный)](install/sql-machine-learning-standalone-windows-install.md)или [SQL Server 2016 R Server (изолированный)](install/sql-r-standalone-windows-install.md).

### <a name="12-sql-server-data-tools-does-not-support-permissions-required-by-external-scripts"></a>12. SQL Server Data Tools не поддерживает разрешения, необходимые для внешних скриптов

При использовании Visual Studio или SQL Server Data Tools для публикации проекта базы данных, если какой-либо участник имеет разрешения, относящиеся к выполнению внешнего скрипта, может появиться сообщение об ошибке следующего вида:

> *Модель TSQL: Обнаружена ошибка при реконструировании базы данных. Разрешение не было распознано и не было импортировано.*

В настоящее время модель DACPAC не поддерживает разрешения, используемые службами R или Службы машинного обучения, например предоставление любого внешнего СКРИПТа или выполнение любого внешнего СКРИПТа. Эта проблема будет исправлена в будущем выпуске.

В качестве обходного решения выполните дополнительные инструкции GRANT в скрипте, выполняемом после развертывания.

### <a name="13-external-script-execution-is-throttled-due-to-resource-governance-default-values"></a>13. Выполнение внешнего скрипта регулируется из-за значений по умолчанию для управления ресурсами

В выпуске Enterprise Edition можно использовать пулы ресурсов для управления внешними процессами скриптов. В некоторых сборках раннего выпуска максимальный объем памяти, который может быть выделен для процессов R, составляет 20 процентов. Таким образом, если на сервере 32 ГБ ОЗУ, исполняемые файлы R (RTerm. exe и BxlServer. exe) могут использовать максимум 6,4 ГБ в одном запросе.

При возникновении ограничений ресурсов Проверьте текущее значение по умолчанию. Если 20 процентов недостаточно, см. документацию [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] по изменению этого значения.

**Применимо к:** Службы SQL Server 2016 R Services, Enterprise Edition

## <a name="r-script-execution-issues"></a>Проблемы с выполнением скрипта R

В этом разделе содержатся известные проблемы, характерные для запуска R на SQL Server, а также некоторые проблемы, связанные с библиотеками R и инструментами, опубликованными корпорацией Майкрософт, включая RevoScaleR.

Дополнительные известные проблемы, которые могут повлиять на решения R, см. на сайте [Machine Learning Server](https://docs.microsoft.com/machine-learning-server/resources-known-issues) .

### <a name="1-access-denied-warning-when-executing-r-scripts-on-sql-server-in-a-non-default-location"></a>1. Предупреждение о запрете доступа при выполнении скриптов R для SQL Server в расположении, отличном от расположения по умолчанию

Если экземпляр SQL Server был установлен в расположение, отличное от расположения по умолчанию, например за пределами `Program Files` папки, предупреждение ACCESS_DENIED возникает при попытке запустить скрипты, устанавливающие пакет. Пример:

> *В `normalizePath(path.expand(path), winslash, mustWork)` : путь [2] = "~ екстерналлибрариес/R/8/1": Отказано в доступе*

Причина заключается в том, что функция R пытается прочитать путь и завершается ошибкой, если встроенная группа пользователей **SQLRUserGroup**не имеет доступа на чтение. Вызываемое предупреждение не блокирует выполнение текущего скрипта R, но предупреждение может повторяться каждый раз, когда пользователь запускает любой другой скрипт R.

Если вы установили SQL Server в расположение по умолчанию, эта ошибка не возникает, так как все пользователи Windows имеют разрешения на `Program Files` чтение папки.

Эта проблема была решена в предстоящем выпуске службы. В качестве обходного решения укажите группу **SQLRUserGroup**с доступом на чтение для всех родительских папок `ExternalLibraries`.

### <a name="2-serialization-error-between-old-and-new-versions-of-revoscaler"></a>2. Ошибка сериализации между старыми и новыми версиями RevoScaleR

При передаче модели с использованием сериализованного формата в удаленный экземпляр SQL Server может возникнуть ошибка: 

> *Ошибка в Мемдекомпресс (Data, Type = распаковка) Внутренняя ошибка-3 в Мемдекомпресс (2).*

Эта ошибка возникает, если модель была сохранена с помощью последней версии функции сериализации, [ркссериализемодел](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/rxserializemodel), но экземпляр SQL Server, в котором выполняется десериализация модели, имеет более раннюю версию API RevoScaleR, начиная с SQL Server 2017 Cu2 или более ранней версии.

В качестве обходного решения можно обновить экземпляр SQL Server 2017 до CU3 или более поздней версии.

Ошибка не отображается, если версия API совпадает или если вы перемещаете модель, сохраненную с помощью более старой функции сериализации, на сервер, использующий более новую версию API сериализации.

Иными словами, используйте одну и ту же версию RevoScaleR для операций сериализации и десериализации.

### <a name="3-real-time-scoring-does-not-correctly-handle-the-_learningrate_-parameter-in-tree-and-forest-models"></a>3. Оценка в режиме реального времени неправильно обрабатывает параметр _леарнинграте_ в моделях дерева и леса

Если модель создается с помощью дерева принятия решений или метода леса принятия решений и задана скорость обучения, то при использовании `sp_rxpredict` или функции SQL `PREDICT` могут возникнуть непротиворечивые результаты в сравнении с использованием `rxPredict`.

Причиной является ошибка в API-интерфейсе, который обрабатывает сериализованные модели и ограничен `learningRate` параметром: например, в [рксбтрис](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/rxbtrees)или

Эта проблема решена в предстоящем выпуске службы.

### <a name="4-limitations-on-processor-affinity-for-r-jobs"></a>4. Ограничения на соответствие процессоров для заданий R

В первоначальной сборке выпуска SQL Server 2016 можно было задать сходство процессоров только для ЦП в первой k-территориальной группе. Например, если сервер является 2-процессорным компьютером с двумя k-группами, для процессов R используются только процессоры из первой k-группы. Это же ограничение применяется при настройке управления ресурсами для заданий скриптов R.

Проблема исправлена в SQL Server 2016 с пакетом обновления 1 (SP1). Рекомендуется выполнить обновление до последней версии службы.

**Применимо к:** Версия RTM служб SQL Server 2016 R

### <a name="5-changes-to-column-types-cannot-be-performed-when-reading-data-in-a-sql-server-compute-context"></a>5. Изменение типов столбцов невозможно при считывании данных в контексте вычисления SQL Server.

Если в качестве контекста вычисления задан экземпляр SQL Server, вы не можете использовать аргумент _colClasses_ (или иные подобные аргументы) для изменения типа данных столбцов в коде R.

Например, следующая инструкция приведет к ошибке, если столбец CRSDepTimeStr уже не является целочисленным:

```R
data <- RxSqlServerData(
  sqlQuery = "SELECT CRSDepTimeStr, ArrDelay  FROM AirlineDemoSmall", 
  connectionString = connectionString, 
  colClasses = c(CRSDepTimeStr = "integer"))
```

В качестве обходного решения можно переписать SQL-запрос для использования приведения или преобразования и представления данных в R с помощью правильного типа данных. Как правило, производительность лучше при работе с данными с помощью SQL, а не путем изменения данных в коде R.

**Применимо к:** Службы SQL Server 2016 R

### <a name="6-limits-on-size-of-serialized-models"></a>6. Ограничения на размер сериализованных моделей

При сохранении модели в SQL Serverной таблице необходимо сериализовать модель и сохранить ее в двоичном формате. Теоретически максимальный размер модели, который может храниться с помощью этого метода, составляет 2 ГБ, что является максимальным размером столбцов varbinary в SQL Server.

Если необходимо использовать более крупные модели, доступны следующие обходные пути.

+ Выполните шаги, чтобы уменьшить размер модели. Некоторые пакеты R с открытым исходным кодом содержат большой объем информации в объекте Model, и большая часть этой информации может быть удалена для развертывания. 
+ Используйте выбор компонентов для удаления ненужных столбцов.
+ При использовании алгоритма с открытым исходным кодом рассмотрите аналогичную реализацию, используя соответствующий алгоритм в MicrosoftML или RevoScaleR. Эти пакеты были оптимизированы для сценариев развертывания.
+ После того как модель будет рациональна и размер, уменьшенный с помощью предыдущих шагов, можно будет использовать [memCompress](https://www.rdocumentation.org/packages/base/versions/3.4.1/topics/memCompress) для уменьшения размера модели перед его передачей в SQL Server. Этот вариант лучше, если модель близка к пределу в 2 ГБ.
+ Для больших моделей можно использовать функцию SQL Server [FileTable](../relational-databases/blob/filetables-sql-server.md) для хранения моделей вместо использования столбца типа varbinary.

    Чтобы использовать таблицы FileTable, необходимо добавить исключение брандмауэра, так как данные, хранящиеся в таблицах FileTable, управляются драйвером файловой системы FILESTREAM в SQL Server, а правила брандмауэра по умолчанию блокируют доступ к сетевым файлам. Дополнительные сведения см. в разделе [Включение необходимых компонентов для таблицы FileTable](../relational-databases/blob/enable-the-prerequisites-for-filetable.md).

    После включения таблицы FileTable для записи модели вы получаете путь из SQL с помощью API FileTable, а затем записываете модель в это расположение из кода. При необходимости чтения модели вы получаете путь из SQL, а затем вызываете модель, используя путь из скрипта. Дополнительные сведения см. в разделе [доступ к таблицам FileTable с помощью API файлового ввода-вывода](../relational-databases/blob/access-filetables-with-file-input-output-apis.md).

### <a name="7-avoid-clearing-workspaces-when-you-execute-r-code-in-a-includessnoversionincludesssnoversion-mdmd-compute-context"></a>7. Избегайте очистки рабочих областей при выполнении кода R в [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] контексте вычислений

Если вы используете команду R для очистки рабочей области объектов при выполнении кода r в [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] контексте вычислений или если вы очистите рабочую область как часть скрипта r, вызываемого с помощью [sp_execute_external_script](../relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql.md), может возникнуть Эта ошибка: *Workspace. Объект Ревоскриптконнектион не найден*

`revoScriptConnection` — это объект в рабочей области R, который содержит информацию о сеансе R, вызываемом из [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]. Но если код R содержит команду для очистки рабочей области (например, `rm(list=ls()))`), вся информация о сеансе и других объектах в рабочей области R также очищается.

В качестве обходного решения Избегайте удаления переменных и других объектов во время работы R в [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]. Хотя очистка рабочей области часто выполняется при работе в консоли R, она может иметь непредвиденные последствия.

* Чтобы удалить определенные переменные, используйте функцию R `remove` : например,`remove('name1', 'name2', ...)`
* Если нужно удалить несколько переменных, сохраните имена временных переменных в списке и периодически выполняйте сборку мусора.

### <a name="8-restrictions-on-data-that-can-be-provided-as-input-to-an-r-script"></a>8. Ограничения для данных, которые могут быть предоставлены как входные данные в сценарии R

Следующие типы результатов запросов невозможно использовать в сценарии R:

- данные из запроса [!INCLUDE[tsql](../includes/tsql-md.md)] , который ссылается на столбцы AlwaysEncrypted;
  
- данные из запроса [!INCLUDE[tsql](../includes/tsql-md.md)] , который ссылается на маскированные столбцы.
  
     Если вам необходимо использовать скрытые данные в сценарии R, при необходимости можно создать копию данных во временной таблице и использовать эти данные.

### <a name="9-use-of-strings-as-factors-can-lead-to-performance-degradation"></a>9. Использование строк в качестве факторов может привести к снижению производительности

Использование переменных типа String в качестве факторов может значительно увеличить объем памяти, используемый для операций R. Это известная проблема с R в целом, и в этой теме есть множество статей. Например, см. раздел [факторы, которые не являются привилегированными гражданами в r, по подключению Джон в r-блоггерах)](https://www.r-bloggers.com/factors-are-not-first-class-citizens-in-r/) или [стрингсасфакторс: Неавторизованная Биография, Роджер Пенг](https://simplystatistics.org/2015/07/24/stringsasfactors-an-unauthorized-biography/). 

Хотя эта ошибка не связана с SQL Server, она может значительно повлиять на производительность выполнения кода R в SQl Server. Строки обычно хранятся в виде varchar или nvarchar, а если столбец строковых данных имеет много уникальных значений, процесс внутреннего преобразования их в целые числа и обратно в строки с помощью R может даже привести к ошибкам выделения памяти.

Если для других операций не требуется абсолютное значение типа данных String, сопоставление строковых значений с числовым (целочисленным) типом данных в рамках подготовки данных будет выгодно с точки зрения производительности и масштаба.

Обсуждение этой проблемы и другие советы см. в статье [производительность служб R — Оптимизация данных](r/r-and-data-optimization-r-services.md).

### <a name="10-arguments-varstokeep-and-varstodrop-are-not-supported-for-sql-server-data-sources"></a>10. Аргументы *varsToKeep* и *varsToDrop* не поддерживаются для SQL Server источников данных

При использовании функции rxDataStep для записи результатов в таблицу использование *varsToKeep* и *varsToDrop* является удобным способом указания столбцов для включения или исключения в рамках операции. Однако эти аргументы не поддерживаются для SQL Server источников данных.

### <a name="11-limited-support-for-sql-data-types-in-sp_execute_external_script"></a>11. Ограниченная поддержка типов данных SQL в SP\_выполнение\_внешнего\_скрипта

Не все типы данных, поддерживаемые в SQL, можно использовать в R. В качестве обходного решения рассмотрите возможность приведения неподдерживаемого типа данных к поддерживаемому типу данных перед передачей\_данных\_в\_внешний сценарий SP Execute.

Дополнительные сведения см. в разделе [библиотеки R и типы данных](r/r-libraries-and-data-types.md).

### <a name="12-possible-string-corruption-using-unicode-strings-in-varchar-columns"></a>12. Возможное повреждение строки с помощью строк Юникода в столбцах varchar

Передача данных в Юникоде в столбцах [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] varchar из в R/Python может привести к повреждению строки. Это связано с тем, что кодировка этих строк Юникода [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] в параметрах сортировки может не совпадать с кодировкой UTF-8 по умолчанию, используемой в R/Python. 

Для отправки любых строковых данных, не использующих ASCII, из [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] в R/Python, используйте кодировку UTF-8 (доступно в [!INCLUDE[sql-server-2019](../includes/sssqlv15-md.md)]) или используйте тип nvarchar для одного и того же.

### <a name="13-only-one-value-of-type-raw-can-be-returned-from-sp_execute_external_script"></a>13. Только одно значение типа `raw` может быть возвращено из`sp_execute_external_script`

При возврате из R двоичного типа данных (тип данных R **RAW** ) значение должно быть отправлено в кадр выходных данных.

При использовании типов данных, отличных от **RAW**, можно вернуть значения параметров вместе с результатами хранимой процедуры, добавив ключевое слово OUTPUT. Дополнительные сведения см. в разделе [Parameters](https://docs.microsoft.com/sql/relational-databases/stored-procedures/parameters).

Если вы хотите использовать несколько наборов выходных данных, включающих значения типа **RAW**, одно из возможных решений заключается в выполнении нескольких вызовов хранимой процедуры или [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] при передаче результирующих наборов с помощью ODBC.

### <a name="14-loss-of-precision"></a>14. Потеря точности

Так [!INCLUDE[tsql](../includes/tsql-md.md)] как и R поддерживают различные типы данных, числовые типы данных могут негативно пострадать от точности во время преобразования.

Дополнительные сведения о неявном преобразовании типов данных см. в разделе [библиотеки R и типы данных](r/r-libraries-and-data-types.md).

### <a name="15-variable-scoping-error-when-you-use-the-transformfunc-parameter"></a>15. Ошибка определения области переменной при использовании параметра transformFunc

Для преобразования данных во время моделирования можно передать аргумент *transformFunc* в функцию, например `rxLinmod` или. `rxLogit` Однако вложенные вызовы функций могут привести к ошибкам области в SQL Server контексте вычислений, даже если вызовы работают правильно в локальном контексте вычислений.

> *Образец набора данных для анализа не имеет переменных*

Например, предположим, что вы определили две функции, `f` и `g`, в локальной глобальной среде и `g` вызываете `f`. В распределенных или удаленных вызовах `g`, включающих в `g` себя `f` , вызов может завершиться ошибкой `f` , так как не удается найти, даже если вы передали и `g` на удаленный вызов.

При возникновении этой проблемы можно внедрить определение `f` в ваше определение `g`в любом месте перед тем, где `g` обычно вызывает `f`.

Пример:

```R
f <- function(x) { 2*x * 3 }
g <- function(y) {
              a <- 10 * y
               f(a)
}
```

Чтобы избежать этой ошибки, Перепишите определение следующим образом:

```R
g <- function(y){
              f <- function(x) { 2*x +3}
              a <- 10 * y
              f(a)
}
```

### <a name="16-data-import-and-manipulation-using-revoscaler"></a>16. Импорт и обработка данных с помощью RevoScaleR

При считывании столбцов типа **varchar** из базы данных пробелы усекаются. Чтобы избежать этого, добавьте перед и после строк символы, отличные от пробелов.

Если для создания таблиц `rxDataStep` базы данных со столбцами типа **varchar** используются такие функции, ширина столбца оценивается на основе образца данных. Если ширина может быть различной, может потребоваться заполнить все строки на общую длину.

Использование преобразования для изменения типа данных переменной не поддерживается при повторном вызове `rxImport` или `rxTextToXdf` для импорта и дополнения строк с объединением нескольких входных файлов в один XDF-файл.

### <a name="17-limited-support-for-rxexec"></a>17. Ограниченная поддержка rxExec

В SQL Server 2016 `rxExec` функция, предоставляемая пакетом RevoScaleR, может использоваться только в однопотоковом режиме.

### <a name="18-increase-the-maximum-parameter-size-to-support-rxgetvarinfo"></a>18. Увеличение максимального размера параметра для поддержки функцию rxgetvarinfo

Если вы используете наборы данных с очень большим количеством переменных (например, более 40 000), установите `max-ppsize` флаг при запуске R, чтобы использовать такие функции, как. `rxGetVarInfo` Флаг `max-ppsize` указывает максимальный размер стека защиты указателей.

При использовании консоли R (например, RGui. exe или RTerm. exe) можно установить значение _Max-ппсизе_ в 500000, введя следующее:

```R
R --max-ppsize=500000
```

### <a name="19-issues-with-the-rxdtree-function"></a>19. Проблемы с функцией rxDTree

Функция `rxDTree` в настоящее время не поддерживает преобразование в формулах. В частности, использование синтаксиса `F()` для создания факторов в режиме реального времени не поддерживается. Однако числовые данные автоматически binned.

Упорядоченные факторы обрабатываются так же, как факторы, во всех функциях анализа RevoScaleR, за исключением `rxDTree`.

### <a name="20-datatable-as-an-outputdataset-in-r"></a>20. Data. Table как OutputDataSet в R

Использование `data.table` в`OutputDataSet` качестве в R не поддерживается в SQL Server 2017 накопительного обновления 13 (CU13) и более ранних версий. Может появиться следующее сообщение:

```
Msg 39004, Level 16, State 20, Line 2
A 'R' script error occurred during execution of 
'sp_execute_external_script' with HRESULT 0x80004004.
Msg 39019, Level 16, State 2, Line 2
An external script error occurred: 
Error in alloc.col(newx) : 
  Internal error: length of names (0) is not length of dt (11)
Calls: data.frame ... as.data.frame -> as.data.frame.data.table -> copy -> alloc.col

Error in execution.  Check the output for more information.
Error in eval(expr, envir, enclos) : 
  Error in execution.  Check the output for more information.
Calls: source -> withVisible -> eval -> eval -> .Call
Execution halted
```

`data.table``OutputDataSet` как в R поддерживается в SQL Server 2017 с накопительным обновлением 14 (CU14) и более поздних версий.

## <a name="python-script-execution-issues"></a>Проблемы с выполнением сценария Python

В этом разделе содержатся известные проблемы, характерные для запуска Python на SQL Server, а также проблемы, связанные с пакетами Python, опубликованными корпорацией Майкрософт, включая [revoscalepy](https://docs.microsoft.com/r-server/python-reference/revoscalepy/revoscalepy-package) и [microsoftml](https://docs.microsoft.com/r-server/python-reference/microsoftml/microsoftml-package).

### <a name="1-call-to-pretrained-model-fails-if-path-to-model-is-too-long"></a>1. Вызов предварительно обученной модели завершается ошибкой, если путь к модели слишком длинный

Если предварительно обученные модели установлены в раннем выпуске SQL Server 2017, полный путь к файлу обученной модели может оказаться слишком длинным для чтения Python. Это ограничение исправлено в более поздней версии службы.

Существует несколько возможных обходных путей. 

+ При установке предварительно обученных моделей выберите пользовательское расположение.
+ Если это возможно, установите SQL Server экземпляр в пользовательском пути установки с более коротким путем, например C:\SQL\MSSQL14. MSSQLSERVER.
+ Используйте служебную программу Windows [fsutil](https://technet.microsoft.com/library/cc788097(v=ws.11).aspx) , чтобы создать жесткую связь, которая сопоставляет файл модели с более коротким путем.
+ Обновление до последней версии службы.

### <a name="2-error-when-saving-serialized-model-to-sql-server"></a>2. Ошибка при сохранении сериализованной модели в SQL Server

При передаче модели в удаленный экземпляр SQL Server и попытке чтения двоичной модели с помощью `rx_unserialize` функции в [revoscalepy](https://docs.microsoft.com/machine-learning-server/python-reference/revoscalepy/revoscalepy-package)может возникнуть ошибка: 

> *Намиррор: имя "rx_unserialize_model" не определено*

Эта ошибка возникает, если модель была сохранена с помощью последней версии функции сериализации, но экземпляр SQL Server, в котором выполняется десериализация модели, не распознает API сериализации.

Чтобы устранить эту проблему, обновите экземпляр SQL Server 2017 до CU3 или более поздней версии.

### <a name="3-failure-to-initialize-a-varbinary-variable-causes-an-error-in-bxlserver"></a>3. Сбой инициализации переменной типа varbinary приводит к ошибке в BxlServer

При выполнении кода Python в SQL Server с помощью `sp_execute_external_script`, а код содержит переменные OUTPUT типа varbinary (max), varchar (max) или аналогичные типы, переменная должна быть инициализирована или задана в составе скрипта. В противном случае компонент обмена данными BxlServer, вызывает ошибку и прекращает работу.

Это ограничение будет исправлено в предстоящем выпуске службы. В качестве обходного решения убедитесь, что переменная инициализируется в скрипте Python. Можно использовать любое допустимое значение, как показано в следующих примерах:

```sql
declare @b varbinary(max);
exec sp_execute_external_script
  @language = N'Python'
  , @script = N'b = 0x0'
  , @params = N'@b varbinary(max) OUTPUT'
  , @b = @b OUTPUT;
go
```

```sql
declare @b varchar(30);
exec sp_execute_external_script
  @language = N'Python'
  , @script = N' b = ""  '
  , @params = N'@b varchar(30) OUTPUT'
  , @b = @b OUTPUT;
go
```

### <a name="4-telemetry-warning-on-successful-execution-of-python-code"></a>4. Предупреждение телеметрии об успешном выполнении кода Python

Начиная с SQL Server 2017 CU2, может появиться следующее сообщение, даже если код Python в противном случае будет выполняться успешно:

> *Сообщения stderr из внешнего скрипта:* 
>  *~ PYTHON_SERVICES\lib\site-packages\revoscalepy\utils\RxTelemetryLogger*
> *синтаксварнинг: telemetry_state используется до глобального объявления*

Эта проблема исправлена в SQL Server 2017 накопительного пакета обновления 3 (CU3). 

### <a name="5-numeric-decimal-and-money-data-types-not-supported"></a>5. Числовые, десятичные и денежные типы данных не поддерживаются

Начиная с SQL Server 2017 накопительного обновления 12 (CU12), числовые, десятичные и денежные типы данных в РЕЗУЛЬТИРУЮЩих НАБОРах не поддерживаются `sp_execute_external_script`при использовании Python с. Могут появиться следующие сообщения:

> *Приведен 39004, состояние SQL: S1000] произошла ошибка сценария Python во время выполнения of'sp_execute_external_script "с HRESULT 0x80004004.*

> *Приведен 39019, состояние SQL: S1000] произошла ошибка внешнего скрипта:*
> 
> *Ошибка Склсателлитекалл: Неподдерживаемый тип в выходной схеме. Поддерживаемые типы: bit, smallint, int, DateTime, smallmoney, Real и float. char, varchar поддерживаются частично.*

Это исправлено в SQL Server 2017 накопительного обновления 14 (CU14).

## <a name="revolution-r-enterprise-and-microsoft-r-open"></a>Revolution R Enterprise и Microsoft R Open

В этом разделе перечислены проблемы, связанные с подключением, разработкой и инструментами производительности R, предоставляемыми функцией анализа революции. Эти средства были предоставлены в более ранних предварительных [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)]версиях.

Как правило, рекомендуется удалить эти предыдущие версии и установить последнюю версию SQL Server или Microsoft R Server.

### <a name="1-revolution-r-enterprise-is-not-supported"></a>1. Революция R Enterprise не поддерживается

Установка революции R Enterprise параллельно с любой версией [!INCLUDE[rsql_productname_md](../includes/rsql-productname-md.md)] не поддерживается.

Если у вас есть лицензия для революции R Enterprise, ее необходимо поместить на отдельный компьютер как с [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] экземпляра, так и с любой рабочей станции, которую вы хотите использовать для подключения [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] к экземпляру.

Некоторые предварительные версии [!INCLUDE[rsql_productname](../includes/rsql-productname-md.md)] включали среду разработки R для Windows, созданную функцией анализа революции. Это средство больше не предоставляется и не поддерживается.

Для совместимости с [!INCLUDE[rsql_productname](../includes/rsql-productname-md.md)]рекомендуется установить Microsoft R Client. [Инструменты R для Visual Studio](https://www.visualstudio.com/vs/rtvs/) и [Visual Studio Code](https://code.visualstudio.com/) также поддерживают решения Microsoft R.

### <a name="2-compatibility-issues-with-sqlite-odbc-driver-and-revoscaler"></a>2. Проблемы совместимости с драйвером SQLite ODBC и RevoScaleR

Редакция 0,92 драйвера SQLite ODBC несовместима с RevoScaleR. Версии 0.88 –-0.91 и 0,93 и более поздних версий известны как совместимые.

## <a name="see-also"></a>См. также

[Что нового в SQL Server 2016](../sql-server/what-s-new-in-sql-server-2016.md)

[Устранение неполадок машинного обучения в SQL Server](machine-learning-troubleshooting-faq.md)
