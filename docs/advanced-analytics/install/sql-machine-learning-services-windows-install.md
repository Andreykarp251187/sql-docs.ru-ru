---
title: Установка Службы машинного обучения SQL Server (в базе данных) в Windows
description: R в SQL Server или Python на шагах установки SQL Server для SQL Server Службы машинного обучения в Windows.
ms.prod: sql
ms.technology: machine-learning
ms.date: 07/30/2019
ms.topic: conceptual
author: dphansen
ms.author: davidph
monikerRange: '>=sql-server-2017||>=sql-server-linux-ver15||=sqlallproducts-allversions'
ms.openlocfilehash: 0b9161d2093c7a32d027da987fdcd3316d1cbbaa
ms.sourcegitcommit: 321497065ecd7ecde9bff378464db8da426e9e14
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/01/2019
ms.locfileid: "68715218"
---
# <a name="install-sql-server-machine-learning-services-on-windows"></a>Установка Службы машинного обучения SQL Server в Windows

[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md-winonly](../../includes/appliesto-ss-xxxx-xxxx-xxx-md-winonly.md)]

В этой статье объясняется, как установить компонент машинного обучения, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] запустив мастер установки и следуя инструкциям на экране.

## <a name="bkmk_prereqs"></a> Контрольный список перед установкой

+ Если требуется установить Службы машинного обучения с поддержкой языка R или Python, требуется установка SQL Server 2017 (или более поздней версии). Если вместо этого у вас есть установочный носитель SQL Server 2016, можно установить [SQL Server R Services (в базе данных)](sql-r-services-windows-install.md) , чтобы получить поддержку языка R.

+ Требуется экземпляр ядра СУБД. Вы не можете установить только функции R или Python, хотя их можно добавить в существующий экземпляр постепенно.

+ Для обеспечения непрерывности бизнес-процессов [Always on группы доступности](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server) поддерживаются для службы машинного обучения. Необходимо установить Службы машинного обучения и настроить пакеты на каждом узле.

+ Установка Службы машинного обучения *не поддерживается* в отказоустойчивом кластере в SQL Server 2017. Однако он *поддерживается* в SQL Server 2019. 
 
+ Не устанавливайте Службы машинного обучения на контроллере домена. Службы машинного обучения часть программы установки завершится ошибкой.

+ Не устанавливайте **Общие компоненты** > **Machine Learning Server (автономные)** на том же компьютере, на котором выполняется экземпляр в базе данных. Изолированный сервер будет конкурировать за одни и те же ресурсы, и производительность обеих установок может быть снижена.

+ Параллельная установка с другими версиями R и Python поддерживается, но не рекомендуется. Он поддерживается, поскольку SQL Server экземпляр использует собственные копии дистрибутивов R и Anaconda с открытым исходным кодом. Но не рекомендуется, так как выполнение кода, использующего R и Python на SQL Server компьютере за пределами SQL Server может привести к различным проблемам:
    
  + Вы используете другую библиотеку и другой исполняемый файл и получаете разные результаты, чем при работе в SQL Server.
  + В скрипты R и Python, выполняемые во внешних библиотеках, нельзя управлять с помощью SQL Server, что приведет к состязанию за ресурсы.
  
> [!IMPORTANT]
> После завершения установки обязательно выполните действия, описанные в этой статье, после настройки. Эти шаги включают в себя включение SQL Server использования внешних скриптов и добавление учетных записей, необходимых для SQL Server запуска заданий R и Python от вашего имени. Изменения конфигурации обычно потребовали перезапуска экземпляра или перезапуска службы панели элементов.

## <a name="get-the-installation-media"></a>Получение установочного носителя

[!INCLUDE[GetInstallationMedia](../../includes/getssmedia.md)]

## <a name="run-setup"></a>Запуск программы установки

Для локальных установок необходимо запускать программу установки с правами администратора. При установке [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] из удаленной общей папки необходимо использовать учетную запись домена с разрешениями на чтение и выполнение для удаленной общей папки.

1. Запустите мастер установки для SQL Server 2017. 
  
2. На вкладке **Установка** выберите пункт **создать SQL Server изолированную установку или добавить компоненты к существующей установке**.

   ![Новая SQL Server автономная установка](media/2017setup-installation-page-mlsvcs.PNG)
   
3. На странице **Выбор компонентов** выберите следующие компоненты:
  
    -   **Службы ядра СУБД**
  
         Чтобы использовать R и Python с SQL Server, необходимо установить экземпляр ядра СУБД. Можно использовать либо именованный экземпляр, либо по умолчанию.
  
    -   **Службы машинного обучения (в базе данных)**
  
         Этот параметр устанавливает службы баз данных, поддерживающие выполнение скриптов R и Python.

    -   **R**

        Установите этот флажок, чтобы добавить пакеты Microsoft R, интерпретатор и R с открытым кодом. 

    -   **Python**

        Установите этот флажок, чтобы добавить пакеты Microsoft Python, исполняемый файл Python 3,5 и выбрать библиотеки из дистрибутива Anaconda.
        
        ![Возможности для R и Python](media/2017setup-features-page-mls-rpy.png "Параметры установки для Python")

        > [!NOTE]
        > 
        > Не выбирайте параметр для **Machine Learning Server (автономный)** . Возможность установки Machine Learning Server в разделе **Общие компоненты** предназначена для использования на отдельном компьютере.

4. На странице **согласие на установку R** выберите **принять**. Это лицензионное соглашение охватывает Microsoft R Open, включающее в себя распространение базовых пакетов и средств R с открытым исходным кодом, а также расширенные пакеты R и поставщики услуг подключения от команды разработчиков Майкрософт.

5. На странице **согласие на установку Python** выберите **принять**. Соглашение о лицензировании с открытым исходным кодом Python также охватывает Anaconda и связанные средства, а также некоторые новые библиотеки Python от команды разработчиков Майкрософт.
     
     ![Соглашение с лицензией на Python](media/2017setup-python-license.png "Лицензионное соглашение для Python")
  
    > [!NOTE]
    >  Если компьютер, к которому вы используете, не имеет доступа к Интернету, можно приостановить установку на этом этапе, чтобы скачать установщики отдельно. Дополнительные сведения см. в [статье Установка компонентов машинного обучения без доступа к Интернету](../install/sql-ml-component-install-without-internet-access.md).
  
     Выберите **принять**, дождитесь, пока кнопка **Далее** станет активной, а затем нажмите кнопку **Далее**.
  
6. На странице **все готово для установки** убедитесь, что выбраны выбранные параметры, и нажмите кнопку **установить**.
  
    + Службы ядра СУБД
    + Служба машинного обучения (в базе данных)
    + R, Python или оба

    Обратите внимание на расположение папки в пути `..\Setup Bootstrap\Log` , где хранятся файлы конфигурации. После завершения установки можно ознакомиться с установленными компонентами в файле сводки.

7. После завершения установки, если вы хотите перезапустить компьютер, сделайте это сейчас. После завершения установки важно прочитать сообщение мастера установки. Дополнительные сведения см. в разделе [View and Read SQL Server Setup Log Files](https://docs.microsoft.com/sql/database-engine/install-windows/view-and-read-sql-server-setup-log-files).

## <a name="set-environment-variables"></a>Задание переменных среды

Для интеграции функций R необходимо задать переменную среды **MKL_CBWR** , чтобы [обеспечить последовательный вывод данных](https://software.intel.com/articles/introduction-to-the-conditional-numerical-reproducibility-cnr) из вычислений Intel Math Kernel Library (MKL).

1. На панели управления щелкните **система и система безопасности** >  > **Дополнительные** > **переменные среды**системы.

2. Создайте новую пользовательскую или системную переменную. 

  + Задайте для переменной имя`MKL_CBWR`
  + Присвойте переменной значение`AUTO`

Для этого шага требуется перезагрузка сервера. Если вы собираетесь включить выполнение скрипта, можно удерживать его при перезапуске до тех пор, пока не будет выполнена вся настройка.

<a name="bkmk_enableFeature"></a>

## <a name="enable-script-execution"></a>Включить выполнение скрипта

1. Откройте [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]. 

    > [!TIP]
    > Вы можете скачать и установить соответствующую версию с этой страницы: [Скачайте SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).
    > 
    > Можно также использовать [Azure Data Studio](../../azure-data-studio/what-is.md), который поддерживает административные задачи и запросы к SQL Server.
  
2. Подключитесь к экземпляру, где установлен Службы машинного обучения, щелкните **создать запрос** , чтобы открыть окно запроса, и выполните следующую команду:

    ```sql
    sp_configure
    ```

    На данном этапе значение для свойства `external scripts enabled` должно быть **0**. Это связано с тем, что функция по умолчанию отключена. Перед запуском скриптов R или Python компонент должен быть явно включен администратором.
    
3.  Чтобы включить функцию внешних скриптов, выполните следующую инструкцию:
    
    ```sql
    EXEC sp_configure  'external scripts enabled', 1
    RECONFIGURE WITH OVERRIDE
    ```
    
    Если вы уже включили функцию для языка R, не запускайте повторную настройку для Python еще раз. Базовая платформа расширяемости поддерживает оба языка.

## <a name="restart-the-service"></a>Перезапустите службу.

После завершения установки перезапустите ядро СУБД, прежде чем перейти к следующему шагу, включив выполнение скрипта.

Перезапуск службы также автоматически перезапускает связанную [!INCLUDE[rsql_launchpad](../../includes/rsql-launchpad-md.md)] службу.

Службу можно перезапустить, щелкнув правой кнопкой мыши команду **перезапуска** для экземпляра в SSMS или воспользовавшись панелью **служб** на панели управления или [Диспетчер конфигурации SQL Server](../../relational-databases/sql-server-configuration-manager.md).

## <a name="verify-installation"></a>Проверка установки

Проверьте состояние установки экземпляра в [пользовательских отчетах](../r/monitor-r-services-using-custom-reports-in-management-studio.md) или журналах установки.

Выполните следующие действия, чтобы убедиться, что все компоненты, используемые для запуска внешнего скрипта, запущены.

1. В SQL Server Management Studio откройте новое окно запроса и выполните следующую команду:
    
    ```sql
    EXEC sp_configure  'external scripts enabled'
    ```

    Задайте для **run_value** значение 1.
    
2. Откройте панель **служб** или диспетчер конфигурации SQL Server и убедитесь, что **Служба панель запуска SQL Server** запущена. У вас должна быть одна служба для каждого экземпляра ядра СУБД, на котором установлен R или Python. Дополнительные сведения о службе см. в разделе [инфраструктура расширяемости](../concepts/extensibility-framework.md). 
   
3. Если запущена панель запуска, вы сможете выполнять простые сценарии R и Python, чтобы убедиться, что внешние среды выполнения скриптов могут взаимодействовать с SQL Server.

   Откройте новое окно **запроса** в [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]и выполните следующий сценарий:
    
    + Для R
    
    ```sql
    EXEC sp_execute_external_script  @language =N'R',
    @script=N'
    OutputDataSet <- InputDataSet;
    ',
    @input_data_1 =N'SELECT 1 AS hello'
    WITH RESULT SETS (([hello] int not null));
    GO
    ```

    + Для Python
    
    ```sql
    EXEC sp_execute_external_script  @language =N'Python',
    @script=N'
    OutputDataSet = InputDataSet;
    ',
    @input_data_1 =N'SELECT 1 AS hello'
    WITH RESULT SETS (([hello] int not null));
    GO
    ```

    **Результаты**

    Выполнение сценария может занять некоторое время, когда среда выполнения внешнего скрипта будет загружена в первый раз. Результаты должны быть примерно такими:

    | hello |
    |----|
    | 1|

> [!NOTE]
> Столбцы или заголовки, используемые в скрипте Python, не возвращаются при проектировании. Чтобы добавить имена столбцов для вывода, необходимо указать схему для набора возвращаемых данных. Для этого используйте параметр WITH RESULTs хранимой процедуры, наберите имена столбцов и укажите тип данных SQL.
> 
> Например, можно добавить следующую строку для создания произвольного имени столбца:`WITH RESULT SETS ((Col1 AS int))`

<a name="apply-cu"></a>

## <a name="apply-updates"></a>Применить обновления

Мы рекомендуем применить Последнее накопительное обновление к компонентам ядра СУБД и машинного обучения.

На устройствах, подключенных к Интернету, накопительные обновления обычно применяются с помощью Центр обновления Windows, но вы также можете использовать приведенные ниже шаги для управления контролируемыми обновлениями. При применении обновления для ядра СУБД программа установки извлекает накопительные обновления для всех компонентов R или Python, установленных в том же экземпляре. 

На отключенных серверах требуются дополнительные действия. Дополнительные сведения см. [в разделе Установка на компьютерах без доступа к интернету > применить накопительные пакеты обновления](sql-ml-component-install-without-internet-access.md#apply-cu).

1. Начало работы с уже установленным базовым экземпляром: Начальный выпуск SQL Server 2017

2. Перейдите к списку накопительных обновлений: [Обновления SQL Server 2017](https://sqlserverupdates.com/sql-server-2017-updates/)

3. Выберите Последнее накопительное обновление. Исполняемый файл скачивается и извлекается автоматически.

4. Запустите программу установки. Примите условия лицензионного соглашения и на странице Выбор компонентов проверьте компоненты, для которых применяются накопительные пакеты обновления. Вы должны увидеть все компоненты, установленные для текущего экземпляра, включая функции машинного обучения. Программа установки загрузит CAB-файлы, необходимые для обновления всех компонентов.

  ![Сводка установленных компонентов](media/cumulative-update-feature-selection.png)

5. Продолжайте работу с мастером, принимая условия лицензионного соглашения для дистрибутивов R и Python. 

## <a name="additional-configuration"></a>Дополнительная настройка

Если шаг проверки внешнего скрипта был успешным, можно выполнить команды R или Python из SQL Server Management Studio, Visual Studio Code или любого другого клиента, который может отправить инструкции T-SQL на сервер.

Если при выполнении команды возникла ошибка, ознакомьтесь с дополнительными шагами настройки в этом разделе. Может потребоваться внести дополнительные необходимые настройки в службу или базу данных.

На уровне экземпляра дополнительная конфигурация может включать:

* [Настройка брандмауэра для SQL Server Службы машинного обучения](../../advanced-analytics/security/firewall-configuration.md)
* [Включить дополнительные сетевые протоколы](../../database-engine/configure-windows/enable-or-disable-a-server-network-protocol.md)
* [Включить удаленные подключения](../../database-engine/configure-windows/configure-the-remote-access-server-configuration-option.md)
* [Создание имени входа для SQLRUserGroup](../../advanced-analytics/security/create-a-login-for-sqlrusergroup.md)
* [Управление квотами диска](https://docs.microsoft.com/windows/desktop/fileio/managing-disk-quotas) во избежание выполнения внешних скриптов задач, которые исчерпали место на диске

<a name="bkmk_configureAccounts"></a> 
<a name="permissions-external-script"></a> 

В базе данных могут потребоваться следующие обновления конфигурации:

* [Предоставление пользователям разрешения на SQL Server Службы машинного обучения](../../advanced-analytics/security/user-permission.md)

> [!NOTE]
> Необходимость дополнительной настройки зависит от схемы безопасности, в которой установлен SQL Server, и от того, как предполагается, что пользователи подключаются к базе данных и запускают внешние скрипты.

## <a name="suggested-optimizations"></a>Предлагаемые оптимизации

Теперь, когда все работает, также может потребоваться оптимизировать сервер для поддержки машинного обучения или установить предварительно обученные модели.

### <a name="add-more-worker-accounts"></a>Добавить рабочие учетные записи

Если предполагается, что многие пользователи одновременно запускают сценарии, можно увеличить число рабочих учетных записей, назначенных службе панели запуска. Дополнительные сведения см. [в разделе Изменение пула учетных записей пользователей для SQL Server службы машинного обучения](../administration/modify-user-account-pool.md).

### <a name="optimize-the-server-for-script-execution"></a>Оптимизация сервера для выполнения скрипта

Параметры по умолчанию [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] для программы установки предназначены для оптимизации баланса сервера для различных служб, поддерживаемых ядром СУБД, которые могут включать процессы извлечения, преобразования и загрузки (ETL), отчеты, аудит и приложения, использующие [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] данные. Поэтому при использовании параметров по умолчанию может оказаться, что ресурсы для машинного обучения иногда ограничены или регулируется, особенно в операциях, интенсивно использующих память.

Чтобы обеспечить соблюдение приоритета и повторного источника заданий машинного обучения, рекомендуется использовать SQL Server Resource Governor для настройки внешнего пула ресурсов. Также может потребоваться изменить объем памяти, выделенной для [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ядра СУБД, или увеличить число учетных записей, выполняемых [!INCLUDE[rsql_launchpad](../../includes/rsql-launchpad-md.md)] в службе.

- Сведения о настройке пула ресурсов для управления внешними ресурсами см. в статье [Создание внешнего пула ресурсов](../../t-sql/statements/create-external-resource-pool-transact-sql.md).
  
- Сведения об изменении объема памяти, зарезервированной для базы данных, см. в разделе [Параметры конфигурации памяти сервера](../../database-engine/configure-windows/server-memory-server-configuration-options.md).
  
- Сведения об изменении числа учетных записей R, которые могут быть [!INCLUDE[rsql_launchpad](../../includes/rsql-launchpad-md.md)]запущены, см. в разделе [Изменение пула учетных записей пользователей для машинного обучения](../administration/modify-user-account-pool.md).

Если вы используете выпуск Standard Edition и не имеете Resource Governor, то для управления ресурсами сервера можно использовать динамические административные представления (DMV) и расширенные события, а также мониторинг событий Windows. Дополнительные сведения см. в разделе [мониторинг служб R и управление ими](../r/managing-and-monitoring-r-solutions.md) , а [затем наблюдение за службами Python и управление ими](../python/managing-and-monitoring-python-solutions.md).

### <a name="install-additional-r-packages"></a>Установка дополнительных пакетов R

Решения R, создаваемые для SQL Server, могут вызывать базовые функции R, функции из собственных пакетов, установленных с SQL Server, а также сторонние пакеты R, совместимые с версией R с открытым исходным кодом, установленной SQL Server.

Пакеты, которыми вы хотите пользоваться из SQL Server, должны быть установлены в библиотеке по умолчанию, используемой экземпляром. Если на компьютере установлена отдельная установка R или если вы установили пакеты в пользовательские библиотеки, вы не сможете использовать эти пакеты из T-SQL.

Для установки пакетов R и управления ими можно настроить группы пользователей для совместного использования пакетов на уровне базы данных или настроить роли базы данных, чтобы пользователи могли устанавливать свои пакеты. Дополнительные сведения см. [в разделе Установка новых пакетов R в SQL Server](../r/install-additional-r-packages-on-sql-server.md).

## <a name="next-steps"></a>Следующие шаги

Разработчики r могут приступить к работе с некоторыми простыми примерами и ознакомиться с основами работы R с SQL Server. Следующий шаг см. по следующим ссылкам:

+ [Учебник. Запуск R в T-SQL](../tutorials/rtsql-using-r-code-in-transact-sql-quickstart.md)
+ [Учебник. Аналитика в базе данных для разработчиков R](../tutorials/sqldev-in-database-r-for-sql-developers.md)

Разработчики Python могут узнать, как использовать Python с SQL Server, следуя этим учебникам:

+ [Учебник. Запуск Python в T-SQL](../tutorials/run-python-using-t-sql.md)
+ [Учебник. Аналитика в базе данных для разработчиков Python](../tutorials/sqldev-in-database-python-for-sql-developers.md)

Примеры машинного обучения, основанные на реальных сценариях, см. в разделе [учебники](../tutorials/machine-learning-services-tutorials.md)по машинному обучению.
