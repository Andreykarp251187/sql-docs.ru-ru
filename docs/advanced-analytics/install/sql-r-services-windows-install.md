---
title: Установка служб SQL Server 2016 R Services (в базе данных)
description: Добавление поддержки языка программирования R в ядро СУБД в службах SQL Server 2016 R Services в Windows.
ms.prod: sql
ms.technology: machine-learning
ms.date: 11/06/2019
ms.topic: conceptual
author: dphansen
ms.author: davidph
monikerRange: =sql-server-2016||=sqlallproducts-allversions
ms.openlocfilehash: 6fcb4245d4efff00002dea9b490312792e0d83d6
ms.sourcegitcommit: b4ad3182aa99f9cbfd15f4c3f910317d6128a2e5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/06/2019
ms.locfileid: "73706998"
---
# <a name="install-sql-server-2016-r-services"></a>Установка SQL Server 2016 R Services
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md-winonly](../../includes/appliesto-ss-xxxx-xxxx-xxx-md-winonly.md)]

В этой статье объясняется, как установить и настроить службы **SQL Server 2016 R Services**. Если у вас SQL Server 2016, установите этот компонент, чтобы включить выполнение кода R в SQL Server.

В SQL Server 2017 интеграция R есть в [Службах машинного обучения](../r/r-server-standalone.md) наряду с Python. Если вам нужна интеграция R и у вас есть установочный носитель SQL Server 2017, см. раздел [Установка Служб машинного обучения SQL Server](sql-machine-learning-services-windows-install.md), чтобы добавить эту функцию. 

<a name="bkmk_prereqs"> </a> 

## <a name="pre-install-checklist"></a>Контрольный список перед установкой

+ Необходим экземпляр ядра СУБД. Вы не можете установить только R, хотя его можно добавить в существующий экземпляр постепенно.

+ Для обеспечения непрерывности бизнес-процессов [группы доступности Always On](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server) поддерживаются для служб R Services. Необходимо установить службы R Services и настроить пакеты на каждом узле.

+ Не устанавливайте R Services в отказоустойчивом кластере. Механизм безопасности, используемый для изолирования процессов R, несовместим со средой с отказоустойчивым кластером Windows Server.

+ Не устанавливайте R Services на контроллер домена. Этап установки служб R Services завершится с ошибкой.

+ Не устанавливайте **общие компоненты** > **R Server (автономного)** на том же компьютере, на котором работает экземпляр базы данных. 

  Параллельная установка с другими версиями R и Python возможна, поскольку экземпляр SQL Server использует собственные копии дистрибутивов R и Anaconda с открытым исходным кодом. Однако выполнение кода, использующего R и Python, на компьютере SQL Server за пределами SQL Server может привести к различным проблемам:
    
  + Вы используете другую библиотеку и другой исполняемый файл и получаете результаты, отличающиеся от результатов при работе в SQL Server.
  + Сценариями R и Python, выполняемыми во внешних библиотеках, нельзя управлять с помощью SQL Server, так как это приведет к конфликту ресурсов.
  
Если вы используете более раннюю версию среды разработки Revolution Analytics или пакетов RevoScaleR или любую из предварительных версий SQL Server 2016, вам необходимо их удалить. Запуск старых и более новых версий RevoScaleR и других частных пакетов не поддерживается. Дополнительные сведения об удалении предыдущих версий см. в статье [Часто задаваемые вопросы по обновлению и установке для Служб машинного обучения SQL Server](../r/upgrade-and-installation-faq-sql-server-r-services.md).

> [!IMPORTANT]
> После установки обязательно выполните действия после конфигурации, описанные в этой статье. В их число входят включение SQL Server для использования внешних скриптов и добавление учетных записей, необходимых для того, чтобы SQL Server выполнял задания R от вашего имени. Изменения в конфигурации обычно требуют перезапуска экземпляра или службы панели элементов.

## <a name="get-the-installation-media"></a>Получение установочного носителя

[!INCLUDE[GetInstallationMedia](../../includes/getssmedia.md)]

<a name="bkmk_ga_instalpatch"></a>

 ### <a name="install-patch-requirement"></a>Требование для установки исправления 

Корпорация Майкрософт выявила проблему с определенной версией двоичных файлов среды выполнения Microsoft VC++ 2013, которые SQL Server устанавливает в качестве необходимого компонента. Если это обновление двоичных файлов среды выполнения VC не установлено, в SQL Server могут возникать проблемы с надежностью в определенных сценариях. Перед установкой SQL Server выполните инструкции, приведенные в [заметках о выпуске SQL Server](../../sql-server/sql-server-2016-release-notes.md#bkmk_ga_instalpatch), чтобы узнать, требуется ли на вашем компьютере исправление для двоичных файлов среды выполнения VC.  

<a name="bkmk2016top"></a>

## <a name="run-setup"></a>Запуск программы установки

Для локальных установок необходимо запускать программу установки с правами администратора. При установке [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] из удаленной общей папки необходимо использовать учетную запись домена с разрешениями на чтение и выполнение для удаленной общей папки.

1. Запустите мастер установки SQL Server 2016.

2. На вкладке **Установка** выберите параметр **Новая установка изолированного экземпляра SQL Server или добавление компонентов к существующей установке**.
    
   ![Установка служб R Services (в базе данных)](media/2016-setup-installation-rsvcs.png "Запуск установки ядра СУБД с помощью служб R Services")
   
3. Выберите следующие компоненты на странице **Выбор компонентов**:

   - Выберите **Службы ядра СУБД**. Ядро СУБД требуется в каждом экземпляре, использующем машинное обучение.
   - Выберите **Службы R (в базе данных)** . Устанавливает поддержку использования языка R в базе данных.
    
     ![Выбор компонентов служб R Services](media/2016setup-rsvcs-features.png "Выберите эти компоненты служб R Services в базе данных")

    > [!IMPORTANT]
    > Не устанавливайте R Server и R Services одновременно. Установка изолированного R Server обычно необходима, чтобы создать среду, которую специалист по обработке и анализу данных или разработчик сможет использовать для подключения к SQL Server и развертывания решений R. Поэтому вы можете установить только R Server.

4.  На странице **Согласие на установку Microsoft R Open** нажмите кнопку **Принять**.
  
    Принятие лицензионного соглашения требуется для скачивания Microsoft R Open — дистрибутива, содержащего базовые пакеты и средства R с открытым исходным кодом, а также поставщики услуг подключения и расширенные пакеты R от команды разработки Microsoft R.
  
5. После принятия лицензионного соглашения в процессе подготовки программы установки возникает небольшая пауза. Нажмите кнопку **Далее**, когда она станет доступной.

6. На странице **Все готово для установки** проверьте, включены ли указанные ниже компоненты, и нажмите **Установить**.

   + Службы ядра СУБД
   + Службы R (в базе данных)

    Обратите внимание на расположение папки в каталоге `..\Setup Bootstrap\Log`, где хранятся файлы конфигурации. После завершения установки можно просмотреть установленные компоненты в файле сводки.

7. Если после завершения установки будет предложено перезагрузить компьютер, выполните перезагрузку. После завершения установки важно прочитать сообщение мастера установки. Дополнительные сведения см. в разделе [View and Read SQL Server Setup Log Files](https://docs.microsoft.com/sql/database-engine/install-windows/view-and-read-sql-server-setup-log-files).

## <a name="set-environment-variables"></a>Настройка переменных среды

Только для интеграции с R присвойте переменной среды **MKL_CBWR** значение [ensure consistent output](https://software.intel.com/articles/introduction-to-the-conditional-numerical-reproducibility-cnr) из вычислений Intel Math Kernel Library (MKL).

1. На панели управления щелкните **Система и безопасность** > **Система** > **Расширенные параметры системы** > **Переменные среды**.

2. Создайте новую пользовательскую или системную переменную. 

  + Задайте имя переменной как `MKL_CBWR`.
  + Задайте значение переменной как `AUTO`.

Для этого шага требуется перезагрузка сервера. Если вы собираетесь включить выполнение сценариев, можно удерживать его при перезапуске до тех пор, пока не будет выполнена вся настройка.

<a name="bkmk_enableFeature"></a>

##  <a name="enable-script-execution"></a>Включение выполнения сценария

1. Откройте среду [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]. 

    > [!TIP]
    > Скачать и установить соответствующую версию можно с этой страницы: [Скачайте SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).
    > 
    > Можно также использовать среду [Azure Data Studio](../../azure-data-studio/what-is.md), которая поддерживает административные задачи и запросы к SQL Server.
  
2. Подключитесь к экземпляру, в который вы установили службы машинного обучения, нажмите **Создать запрос**, чтобы открыть окно запроса, и выполните следующую команду:

   ```sql
   sp_configure
   ```
    На данном этапе значение для свойства `external scripts enabled` должно быть **0**. Это связано с тем, что функция по умолчанию отключена. Этот компонент должен быть явно включен администратором, чтобы вы могли выполнять код R или Python.
     
3. Чтобы включить внешний компонент написания сценариев, выполните следующую инструкцию:
  
    ```sql
    EXEC sp_configure  'external scripts enabled', 1
    RECONFIGURE WITH OVERRIDE
    ```
  
## <a name="restart-the-service"></a>Перезапустите службу.

После завершения установки перезапустите ядро СУБД, прежде чем перейти к следующему шагу — включению выполнения скриптов.

При перезапуске службы автоматически перезапускается соответствующая служба [!INCLUDE[rsql_launchpad](../../includes/rsql-launchpad-md.md)].

Службу можно перезапустить, щелкнув ее правой кнопкой мыши и выбрав команду **Перезапустить** для экземпляра SSMS, через раздел **Службы** на панели управления или с помощью [диспетчера конфигурации SQL Server](../../relational-databases/sql-server-configuration-manager.md).

## <a name="verify-installation"></a>Проверка установки

Проверьте состояние установки экземпляра в [настраиваемых отчетах](../r/monitor-r-services-using-custom-reports-in-management-studio.md).

Выполните указанные ниже действия, чтобы убедиться в том, что все компоненты, используемые для запуска внешнего скрипта, запущены.

1. Откройте новое окно запроса в SQL Server Management Studio и выполните приведенную ниже команду.
    
    ```sql
    EXEC sp_configure  'external scripts enabled'
    ```

    Задайте для **run_value** значение 1.

2. Откройте раздел **Службы** или диспетчер конфигурации SQL Server и убедитесь, что служба **Панель запуска SQL Server** запущена. У вас должно быть по одной службе для каждого экземпляра ядра СУБД с установленными R или Python. Дополнительные сведения об этой службе см. в разделе [Платформа расширяемости](../concepts/extensibility-framework.md).

7. Если запущена панель запуска, вы сможете выполнять простые скрипты на R, чтобы убедиться, что внешние среды выполнения скриптов могут взаимодействовать с SQL Server. 

    Откройте новое окно **Запрос** в [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], а затем выполните следующий сценарий:
    
    ```sql
    EXEC sp_execute_external_script  @language =N'R',
    @script=N'
    OutputDataSet <- InputDataSet;
    ',
    @input_data_1 =N'SELECT 1 AS hello'
    WITH RESULT SETS (([hello] int not null));
    GO
    ```

    Выполнение сценария может занять некоторое время при первой загрузке внешней среды выполнения. Результаты должны выглядеть примерно так:

    | hello |
    |----|
    | 1|

<a name="apply-cu"></a>

## <a name="apply-updates"></a>Применение обновлений

Мы рекомендуем применить последнее накопительное обновление к компонентам ядра СУБД и машинного обучения.

На устройствах, подключенных к Интернету, накопительные обновления обычно применяются с помощью Центра обновления Windows, но вы также можете использовать приведенные ниже шаги для управления контролируемыми обновлениями. При применении обновления для ядра СУБД программа установки извлекает накопительные обновления всех библиотек R, установленных в том же экземпляре. 

На отключенных серверах требуются дополнительные действия. Дополнительные сведения см. в разделе [Установка на компьютерах без доступа к Интернету > Применение накопительных обновлений](sql-ml-component-install-without-internet-access.md#apply-cu).

1. Начните с уже установленного базового экземпляра: Начальный выпуск SQL Server 2016, SQL Server 2016 с пакетом обновления 1 (SP1) или SQL Server 2016 с пакетом обновления 2 (SP2).

2. Перейдите к списку накопительных обновлений: [Обновления SQL Server 2016](https://sqlserverupdates.com/sql-server-2016-updates/)

3. Загрузите последнее накопительное обновление. Исполняемый файл скачивается и извлекается автоматически.

4. Запустите программу установки. Примите условия лицензионного соглашения и на странице "Выбор компонентов" проверьте компоненты, для которых применяются накопительные пакеты обновления. Вы должны увидеть все компоненты, установленные для текущего экземпляра, включая службы R Services. Программа установки загрузит CAB-файлы, необходимые для обновления всех компонентов.

5. Продолжайте работу с мастером, принимая условия лицензионного соглашения для дистрибутива R. 

<a name="bkmk_FollowUp"></a> 

## <a name="additional-configuration"></a>Дополнительная настройка

Если проверка внешнего скрипта будет пройдена успешно, вы сможете выполнять команды Python из SQL Server Management Studio, Visual Studio Code или любого другого клиента, который может отправлять инструкции T-SQL на сервер.

Если при выполнении команды возникнет ошибка, обратитесь к дополнительным шагам настройки, указанным в этом разделе. Возможно, потребуется внести какие-то дополнительные настройки в службу или базу данных.

На уровне экземпляра дополнительная конфигурация может включать следующее:

* [Настройка брандмауэра для служб машинного обучения SQL Server](../../advanced-analytics/security/firewall-configuration.md)
* [Включение дополнительных сетевых протоколов](../../database-engine/configure-windows/enable-or-disable-a-server-network-protocol.md)
* [Включение удаленных подключений](../../database-engine/configure-windows/configure-the-remote-access-server-configuration-option.md)
* [Управление квотами на диск](https://docs.microsoft.com/windows/desktop/fileio/managing-disk-quotas) во избежание выполнения внешними сценариями задач, тратящих дисковое пространство

<a name="bkmk_configureAccounts"></a>
<a name="bkmk_AllowLogon"></a>

В базе данных могут потребоваться следующие обновления конфигурации:

* [Предоставление пользователям доступа к службам машинного обучения SQL Server](../../advanced-analytics/security/user-permission.md)
* [Добавление SQLRUserGroup в качестве пользователя базы данных](../../advanced-analytics/security/create-a-login-for-sqlrusergroup.md)

> [!NOTE]
> Не все перечисленные изменения являются обязательными; все они могут оказаться ненужными. Требования зависят от схемы безопасности, в которой установлен ваш SQL Server, и от того, как ваши пользователи должны подключаться к базе данных и запускать внешние скрипты. Дополнительные советы по устранению неполадок см. здесь. [Часто задаваемые вопросы по обновлению и установке](../r/upgrade-and-installation-faq-sql-server-r-services.md)

## <a name="suggested-optimizations"></a>Предлагаемые оптимизации

Теперь, когда все работает, также может потребоваться оптимизировать сервер для поддержки машинного обучения или установки предварительно подготовленных моделей.

### <a name="add-more-worker-accounts"></a>Добавление рабочих учетных записей

Если вы предполагаете, что будете интенсивно использовать среду R или множество пользователей будут одновременно выполнять скрипты, вы можете увеличить количество рабочих учетных записей, назначенных службе панели запуска. Дополнительные сведения см. в разделе [Изменение пула учетных записей пользователей для Служб машинного обучения SQL Server](../administration/modify-user-account-pool.md).

<a name="bkmk_optimize"></a>

### <a name="optimize-the-server-for-external-script-execution"></a>Оптимизация сервера для выполнения внешних скриптов

Параметры по умолчанию для программы установки [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] призваны оптимизировать выполнение на сервере различных служб, поддерживаемых ядром СУБД, включая процессы извлечения, преобразования и загрузки, ведение отчетности, аудит и приложения, использующие данные [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Поэтому при использовании параметров по умолчанию ресурсы для машинного обучения могут быть ограничены или регулироваться, особенно в случае с операциями с интенсивным использованием памяти.

Чтобы задачам машинного обучения назначались соответствующие приоритеты и выделялись необходимые ресурсы, рекомендуем использовать Resource Governor SQL Server для настройки внешнего пула ресурсов. Кроме того, можно изменить размер памяти, выделяемой ядру СУБД [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], или увеличить количество учетных записей в службе [!INCLUDE[rsql_launchpad](../../includes/rsql-launchpad-md.md)].

- Сведения о настройке пула ресурсов для управления внешними ресурсами см. в разделе [Создание внешнего пула ресурсов](../../t-sql/statements/create-external-resource-pool-transact-sql.md).
  
- Сведения об изменении объема памяти, выделяемой для базы данных, см. в разделе [Параметры конфигурации памяти сервера](../../database-engine/configure-windows/server-memory-server-configuration-options.md).
  
- Чтобы изменить число учетных записей R, которые могут быть запущены [!INCLUDE[rsql_launchpad](../../includes/rsql-launchpad-md.md)], см. раздел [Изменение пула учетных записей пользователей для машинного обучения](../administration/modify-user-account-pool.md).

Если у вас выпуск Standard Edition и нет регулятора ресурсов, вы можете использовать динамические административные представления и расширенные события, а также мониторинг событий Windows. Это необходимо для управления ресурсами сервера, которые используются R. Дополнительные сведения см. в статье [Мониторинг решений R и управление ими](../r/managing-and-monitoring-r-solutions.md).

### <a name="install-additional-r-packages"></a>Установка дополнительных пакетов R

Решения на R, создаваемые для SQL Server, могут вызывать базовые функции R, функции из собственных пакетов, установленных с SQL Server, а также сторонних пакетов R, совместимых с версией R с открытым исходным кодом, установленной SQL Server.

Пакеты, которыми вы хотите пользоваться из SQL Server, должны быть установлены в библиотеке по умолчанию, используемой экземпляром. При наличии отдельной установки R на компьютере, а также если вы установили пакеты в библиотеки пользователей, вы не сможете использовать их из T-SQL.

Процесс установки пакетов R и управления ими в SQL Server 2016 и SQL Server 2017 отличается. В SQL Server 2016 администратор базы данных должен установить пакеты R, необходимые пользователям. В SQL Server 2017 можно настроить группы пользователей для совместного использования пакетов на уровне базы данных или настроить роли базы данных, чтобы разрешить пользователям устанавливать собственные пакеты. Дополнительные сведения см. в статье [Установка новых пакетов R](../r/install-additional-r-packages-on-sql-server.md).

## <a name="next-steps"></a>Дальнейшие действия

Разработчики на языке R могут ознакомиться с простыми примерами, а также узнать, как код R работает с SQL Server. Дополнительные сведения см. в следующих статьях.

+ [Учебник. Запуск R в T-SQL](../tutorials/quickstart-r-create-script.md)
+ [Учебник. Аналитические функции в базе данных для разработчиков R](../tutorials/sqldev-in-database-r-for-sql-developers.md)

Примеры машинного обучения, основанные на реальных сценариях, см. в разделе [руководствах по машинному обучению](../tutorials/machine-learning-services-tutorials.md).