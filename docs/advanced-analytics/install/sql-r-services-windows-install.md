---
title: Установка служб SQL Server 2016 R Services (в базе данных)
description: Добавление поддержки языка программирования R в ядро СУБД в службах SQL Server 2016 R в Windows.
ms.prod: sql
ms.technology: machine-learning
ms.date: 05/03/2019
ms.topic: conceptual
author: dphansen
ms.author: davidph
ms.openlocfilehash: 9cc14328e0e43106f9fec0779f073bcd1568e888
ms.sourcegitcommit: c1382268152585aa77688162d2286798fd8a06bb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/19/2019
ms.locfileid: "68345005"
---
# <a name="install-sql-server-2016-r-services"></a>Установка служб R SQL Server 2016
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md-winonly](../../includes/appliesto-ss-xxxx-xxxx-xxx-md-winonly.md)]

В этой статье объясняется, как установить и настроить **службы SQL Server 2016 R Services**. Если у вас SQL Server 2016, установите этот компонент, чтобы включить выполнение кода R в SQL Server.

В SQL Server 2017 интеграция R предлагается в [службы машинного обучения](../r/r-server-standalone.md), что отражает добавление Python. Если требуется интеграция R с установочным носителем SQL Server 2017, см. раздел [Install SQL Server 2017 службы машинного обучения](sql-machine-learning-services-windows-install.md) to Add a Feature. 

<a name="bkmk_prereqs"> </a> 

## <a name="pre-install-checklist"></a>Контрольный список перед установкой

+ Требуется экземпляр ядра СУБД. Нельзя установить только R, хотя его можно добавить в существующий экземпляр постепенно.

+ Для обеспечения непрерывности бизнес-процессов [Always on группы доступности](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server) поддерживаются для служб R. Необходимо установить службы R и настроить пакеты на каждом узле.

+ Не устанавливайте службы R в отказоустойчивом кластере. Механизм безопасности, используемый для изоляции процессов R, несовместим с средой отказоустойчивого кластера Windows Server.

+ Не устанавливайте службы R на контроллере домена. Часть программы установки служб R завершится ошибкой.

+ Не устанавливайте **Общие компоненты** > **R Server (standalone)** на том же компьютере, на котором выполняется экземпляр в базе данных. 

  Параллельная установка с другими версиями R и Python возможна, поскольку экземпляр SQL Server использует собственные копии дистрибутивов R и Anaconda с открытым исходным кодом. Однако выполнение кода, использующего R и Python на SQL Server компьютере за пределами SQL Server может привести к различным проблемам:
    
  + Вы используете другую библиотеку и другой исполняемый файл и получаете разные результаты, чем при работе в SQL Server.
  + В скрипты R и Python, выполняемые во внешних библиотеках, нельзя управлять с помощью SQL Server, что приведет к состязанию за ресурсы.
  
Если вы использовали какие-либо более ранние версии среды разработки для аналитики революции или пакетов RevoScaleR или если вы установили предварительные версии SQL Server 2016, их необходимо удалить. Запуск старых и более новых версий RevoScaleR и других частных пакетов не поддерживается. Справку по удалению предыдущих версий см. в разделе [часто задаваемые вопросы по обновлению и установке для SQL Server службы машинного обучения](../r/upgrade-and-installation-faq-sql-server-r-services.md).

> [!IMPORTANT]
> После завершения установки убедитесь в выполнении дополнительных действий, выполняемых после настройки, описанных в этой статье. Эти шаги включают в себя включение SQL Server использования внешних скриптов и добавление учетных записей, необходимых для SQL Server выполнения заданий R от вашего имени. Изменения конфигурации обычно потребовали перезапуска экземпляра или перезапуска службы панели элементов.

## <a name="get-the-installation-media"></a>Получение установочного носителя

[!INCLUDE[GetInstallationMedia](../../includes/getssmedia.md)]

<a name="bkmk_ga_instalpatch"></a>

 ### <a name="install-patch-requirement"></a>Требование установки исправления 

Корпорация Майкрософт выявила проблему с определенной версией двоичных файлов среды выполнения Microsoft VC++ 2013, которые SQL Server устанавливает в качестве необходимого компонента. Если это обновление двоичных файлов среды выполнения VC не установлено, в SQL Server могут возникать проблемы с надежностью в определенных сценариях. Перед установкой SQL Server выполните инструкции, приведенные в [заметках о выпуске SQL Server](../../sql-server/sql-server-2016-release-notes.md#bkmk_ga_instalpatch), чтобы узнать, требуется ли на вашем компьютере исправление для двоичных файлов среды выполнения VC.  

<a name="bkmk2016top"></a>

## <a name="run-setup"></a>Запуск программы установки

Для локальных установок необходимо запускать программу установки с правами администратора. При установке [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] из удаленной общей папки необходимо использовать учетную запись домена с разрешениями на чтение и выполнение для удаленной общей папки.

1. Запустите мастер установки для SQL Server 2016.

2. На вкладке **Установка** выберите пункт **создать SQL Server изолированную установку или добавить компоненты к существующей установке**.
    
   ![Установка служб R (в базе данных)](media/2016-setup-installation-rsvcs.png "Запуск установки ядра СУБД с помощью служб R")
   
3. На странице **Выбор компонентов** выберите следующие параметры.

   - Выберите **ядро СУБД службы**. Ядро СУБД требуется в каждом экземпляре, использующем машинное обучение.
   - Выберите **службы R (в базе данных)** . Устанавливает поддержку для использования в базе данных языка R.
    
     ![Выбор компонентов служб R](media/2016setup-rsvcs-features.png "Выберите эти функции для служб R в базе данных")

    > [!IMPORTANT]
    > Не устанавливайте R Server и R Services одновременно. Обычно сервер R (изолированный) устанавливается для создания среды, которую анализу данных или разработчик использует для подключения к SQL Server и развертывания решений R. Поэтому вы можете установить только R Server.

4.  На странице **согласие на установку Microsoft R Open** нажмите кнопку **принять**.
  
    Это лицензионное соглашение требуется для загрузки Microsoft R Open, которое включает в себя распространение базовых пакетов и средств R с открытым исходным кодом, а также расширенные пакеты R и поставщики услуг подключения от команды разработчиков Microsoft R.
  
5. После принятия лицензионного соглашения в процессе подготовки программы установки возникает небольшая пауза. Нажмите кнопку **Далее** , когда кнопка станет доступной.

6. На странице **все готово для установки** убедитесь, что включены следующие элементы, а затем нажмите кнопку **установить**.

   + Службы ядра СУБД
   + Службы R (в базе данных)

    Обратите внимание на расположение папки в пути `..\Setup Bootstrap\Log` , где хранятся файлы конфигурации. После завершения установки можно ознакомиться с установленными компонентами в файле сводки.

7. После завершения установки, если вы хотите перезапустить компьютер, сделайте это сейчас. После завершения установки важно прочитать сообщение мастера установки. Дополнительные сведения см. в разделе [View and Read SQL Server Setup Log Files](https://docs.microsoft.com/sql/database-engine/install-windows/view-and-read-sql-server-setup-log-files).

## <a name="set-environment-variables"></a>Задание переменных среды

Для интеграции функций R необходимо задать переменную среды **MKL_CBWR** , чтобы [обеспечить последовательный вывод данных](https://software.intel.com/articles/introduction-to-the-conditional-numerical-reproducibility-cnr) из вычислений Intel Math Kernel Library (MKL).

1. На панели управления щелкните **система и система безопасности** >  > **Дополнительные** > **переменные среды**системы.

2. Создайте новую пользовательскую или системную переменную. 

  + Задайте для переменной имя`MKL_CBWR`
  + Присвойте переменной значение`AUTO`

Для этого шага требуется перезагрузка сервера. Если вы собираетесь включить выполнение скрипта, можно удерживать его при перезапуске до тех пор, пока не будет выполнена вся настройка.

<a name="bkmk_enableFeature"></a>

##  <a name="enable-script-execution"></a>Включить выполнение скрипта

1. Откройте [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]. 

    > [!TIP]
    > Вы можете скачать и установить соответствующую версию с этой страницы: [Скачайте SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).
    > 
    > Вы также можете испытать предварительную версию [Azure Data Studio](../../azure-data-studio/what-is.md), которая поддерживает административные задачи и запросы к SQL Server.
  
2. Подключитесь к экземпляру, где установлен Службы машинного обучения, щелкните **создать запрос** , чтобы открыть окно запроса, и выполните следующую команду:

   ```sql
   sp_configure
   ```
    На данном этапе значение для свойства `external scripts enabled` должно быть **0**. Это связано с тем, что функция по умолчанию отключена. Перед запуском скриптов R или Python компонент должен быть явно включен администратором.
     
3. Чтобы включить функцию внешних скриптов, выполните следующую инструкцию:
  
    ```sql
    EXEC sp_configure  'external scripts enabled', 1
    RECONFIGURE WITH OVERRIDE
    ```
  
## <a name="restart-the-service"></a>Перезапустите службу.

После завершения установки перезапустите ядро СУБД, прежде чем перейти к следующему шагу, включив выполнение скрипта.

Перезапуск службы также автоматически перезапускает связанную [!INCLUDE[rsql_launchpad](../../includes/rsql-launchpad-md.md)] службу.

Службу можно перезапустить, щелкнув правой кнопкой мыши команду **перезапуска** для экземпляра в SSMS или воспользовавшись панелью **служб** на панели управления или [Диспетчер конфигурации SQL Server](../../relational-databases/sql-server-configuration-manager.md).

## <a name="verify-installation"></a>Проверка установки

Проверьте состояние установки экземпляра с помощью [пользовательских отчетов](../r/monitor-r-services-using-custom-reports-in-management-studio.md).

Выполните следующие действия, чтобы убедиться, что все компоненты, используемые для запуска внешнего скрипта, запущены.

1. В SQL Server Management Studio откройте новое окно запроса и выполните следующую команду:
    
    ```sql
    EXEC sp_configure  'external scripts enabled'
    ```

    Задайте для **run_value** значение 1.

2. Откройте панель **служб** или диспетчер конфигурации SQL Server и убедитесь, что **Служба панель запуска SQL Server** запущена. У вас должна быть одна служба для каждого экземпляра ядра СУБД, на котором установлен R или Python. Дополнительные сведения о службе см. в разделе [инфраструктура расширяемости](../concepts/extensibility-framework.md).

7. Если запущена панель запуска, вы сможете запустить простой R, чтобы убедиться, что внешние среды выполнения скриптов могут взаимодействовать с SQL Server. 

    Откройте новое окно **запроса** в [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]и выполните следующий сценарий:
    
    ```sql
    EXEC sp_execute_external_script  @language =N'R',
    @script=N'
    OutputDataSet <- InputDataSet;
    ',
    @input_data_1 =N'SELECT 1 AS hello'
    WITH RESULT SETS (([hello] int not null));
    GO
    ```

    Выполнение сценария может занять некоторое время, когда среда выполнения внешнего скрипта будет загружена в первый раз. Результаты должны быть примерно такими:

    | hello |
    |----|
    | 1|

<a name="apply-cu"></a>

## <a name="apply-updates"></a>Применить обновления

Мы рекомендуем применить Последнее накопительное обновление к компонентам ядра СУБД и машинного обучения.

На устройствах, подключенных к Интернету, накопительные обновления обычно применяются с помощью Центр обновления Windows, но вы также можете использовать приведенные ниже шаги для управления контролируемыми обновлениями. При применении обновления для ядра СУБД программа установки извлекает накопительные обновления для библиотек R, установленных в том же экземпляре. 

На отключенных серверах требуются дополнительные действия. Дополнительные сведения см. [в разделе Установка на компьютерах без доступа к интернету > применить накопительные пакеты обновления](sql-ml-component-install-without-internet-access.md#apply-cu).

1. Начало работы с уже установленным базовым экземпляром: SQL Server 2016 начальный выпуск, SQL Server 2016 SP 1 или SQL Server 2016 SP 2.

2. Перейдите к списку накопительных обновлений: [Обновления SQL Server 2016](https://sqlserverupdates.com/sql-server-2016-updates/)

3. Выберите Последнее накопительное обновление. Исполняемый файл скачивается и извлекается автоматически.

4. Запустите программу установки. Примите условия лицензионного соглашения и на странице Выбор компонентов проверьте компоненты, для которых применяются накопительные пакеты обновления. Вы должны увидеть все компоненты, установленные для текущего экземпляра, включая службы R Services. Программа установки загрузит CAB-файлы, необходимые для обновления всех компонентов.

5. Продолжайте работу с мастером, принимая условия лицензионного соглашения для распределения R. 

<a name="bkmk_FollowUp"></a> 

## <a name="additional-configuration"></a>Дополнительная настройка

Если шаг проверки внешнего скрипта был успешным, можно выполнить команды Python из SQL Server Management Studio, Visual Studio Code или любого другого клиента, который может отправить инструкции T-SQL на сервер.

Если при выполнении команды возникла ошибка, ознакомьтесь с дополнительными шагами настройки в этом разделе. Может потребоваться внести дополнительные необходимые настройки в службу или базу данных.

На уровне экземпляра дополнительная конфигурация может включать:

* [Настройка брандмауэра для SQL Server Службы машинного обучения](../../advanced-analytics/security/firewall-configuration.md)
* [Включить дополнительные сетевые протоколы](../../database-engine/configure-windows/enable-or-disable-a-server-network-protocol.md)
* [Включить удаленные подключения](../../database-engine/configure-windows/configure-the-remote-access-server-configuration-option.md)
* [Управление квотами диска](https://docs.microsoft.com/windows/desktop/fileio/managing-disk-quotas) во избежание выполнения внешних скриптов задач, которые исчерпали место на диске

<a name="bkmk_configureAccounts"></a>
<a name="bkmk_AllowLogon"></a>

В базе данных могут потребоваться следующие обновления конфигурации:

* [Предоставление пользователям разрешения на SQL Server Службы машинного обучения](../../advanced-analytics/security/user-permission.md)
* [Добавление SQLRUserGroup в качестве пользователя базы данных](../../advanced-analytics/security/create-a-login-for-sqlrusergroup.md)

> [!NOTE]
> Не все перечисленные изменения являются обязательными, и ни один из них может не потребоваться. Требования зависят от схемы безопасности, в которой установлен SQL Server, а также от того, как предполагается, что пользователи подключаются к базе данных и запускают внешние скрипты. Дополнительные советы по устранению неполадок можно найти здесь: [Часто задаваемые вопросы по обновлению и установке](../r/upgrade-and-installation-faq-sql-server-r-services.md)

## <a name="suggested-optimizations"></a>Предлагаемые оптимизации

Теперь, когда все работает, также может потребоваться оптимизировать сервер для поддержки машинного обучения или установить предварительно обученные модели.

### <a name="add-more-worker-accounts"></a>Добавить рабочие учетные записи

Если вы считаете, что вы можете использовать R в активном виде или планируете параллельное выполнение скриптов несколькими пользователями, можно увеличить число рабочих учетных записей, назначенных службе панели запуска. Дополнительные сведения см. [в разделе Изменение пула учетных записей пользователей для SQL Server службы машинного обучения](../administration/modify-user-account-pool.md).

<a name="bkmk_optimize"></a>

### <a name="optimize-the-server-for-external-script-execution"></a>Оптимизация сервера для выполнения внешнего скрипта

Параметры по умолчанию [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] для программы установки предназначены для оптимизации баланса сервера для различных служб, поддерживаемых ядром СУБД, которые могут включать процессы извлечения, преобразования и загрузки (ETL), отчеты, аудит и приложения, использующие [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] данные. Поэтому при использовании параметров по умолчанию может оказаться, что ресурсы для машинного обучения иногда ограничены или регулируется, особенно в операциях, интенсивно использующих память.

Чтобы обеспечить соблюдение приоритета и повторного источника заданий машинного обучения, рекомендуется использовать SQL Server Resource Governor для настройки внешнего пула ресурсов. Также может потребоваться изменить объем памяти, выделенной для [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ядра СУБД, или увеличить число учетных записей, выполняемых [!INCLUDE[rsql_launchpad](../../includes/rsql-launchpad-md.md)] в службе.

- Сведения о настройке пула ресурсов для управления внешними ресурсами см. в статье [Создание внешнего пула ресурсов](../../t-sql/statements/create-external-resource-pool-transact-sql.md).
  
- Сведения об изменении объема памяти, зарезервированной для базы данных, см. в разделе [Параметры конфигурации памяти сервера](../../database-engine/configure-windows/server-memory-server-configuration-options.md).
  
- Сведения об изменении числа учетных записей R, которые могут быть [!INCLUDE[rsql_launchpad](../../includes/rsql-launchpad-md.md)]запущены, см. в разделе [Изменение пула учетных записей пользователей для машинного обучения](../administration/modify-user-account-pool.md).

Если используется выпуск Standard и отсутствуют Resource Governor, можно использовать динамические административные представления (DMV) и расширенные события, а также мониторинг событий Windows для управления ресурсами сервера, используемыми R. Дополнительные сведения см. в разделе [мониторинг и управление службами R](../r/managing-and-monitoring-r-solutions.md).

### <a name="install-additional-r-packages"></a>Установка дополнительных пакетов R

Решения R, создаваемые для SQL Server, могут вызывать базовые функции R, функции из собственных пакетов, установленных с SQL Server, а также сторонние пакеты R, совместимые с версией R с открытым исходным кодом, установленной SQL Server.

Пакеты, которыми вы хотите пользоваться из SQL Server, должны быть установлены в библиотеке по умолчанию, используемой экземпляром. Если на компьютере установлена отдельная установка R или если вы установили пакеты в пользовательские библиотеки, вы не сможете использовать эти пакеты из T-SQL.

Процесс установки пакетов R и управления ими отличается в SQL Server 2016 и SQL Server 2017. В SQL Server 2016 администратор базы данных должен установить пакеты R, необходимые пользователям. В SQL Server 2017 можно настроить группы пользователей для совместного использования пакетов на уровне базы данных или настроить роли базы данных, чтобы позволить пользователям устанавливать свои пакеты. Дополнительные сведения см. в разделе [Установка новых пакетов R](../r/install-additional-r-packages-on-sql-server.md).

## <a name="next-steps"></a>Следующие шаги

Разработчики r могут приступить к работе с некоторыми простыми примерами и ознакомиться с основами работы R с SQL Server. Следующий шаг см. по следующим ссылкам:

+ [Учебник. Запуск R в T-SQL](../tutorials/rtsql-using-r-code-in-transact-sql-quickstart.md)
+ [Учебник. Аналитика в базе данных для разработчиков R](../tutorials/sqldev-in-database-r-for-sql-developers.md)

Примеры машинного обучения, основанные на реальных сценариях, см. в разделе [учебники](../tutorials/machine-learning-services-tutorials.md)по машинному обучению.