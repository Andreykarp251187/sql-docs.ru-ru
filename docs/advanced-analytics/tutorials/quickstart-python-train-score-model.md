---
title: Создание и оценка прогнозной модели в Python
titleSuffix: SQL Server Machine Learning Services
description: Создание простой прогнозной модели в Python с помощью SQL Server Службы машинного обучения, а затем прогнозирование результатов с помощью новых данных.
ms.prod: sql
ms.technology: machine-learning
ms.date: 10/14/2019
ms.topic: quickstart
author: garyericson
ms.author: garye
ms.reviewer: davidph
monikerRange: '>=sql-server-2017||>=sql-server-linux-ver15||=sqlallproducts-allversions'
ms.openlocfilehash: cb564d7dc8564b31a90a09f53aedaba953519f76
ms.sourcegitcommit: c7a202af70fd16467a498688d59637d7d0b3d1f3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/15/2019
ms.locfileid: "72313668"
---
# <a name="quickstart-create-and-score-a-predictive-model-in-python-with-sql-server-machine-learning-services"></a>Краткое руководство. Создание и оценка прогнозной модели в Python с помощью SQL Server Службы машинного обучения
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md](../../includes/appliesto-ss-xxxx-xxxx-xxx-md.md)]

В этом кратком руководстве вы создадите и обучите прогнозную модель с помощью Python, сохраните модель в таблицу в экземпляре SQL Server, а затем используйте модель для прогнозирования значений из новых данных с помощью [SQL Server службы машинного обучения](../what-is-sql-server-machine-learning.md).

Вы создадите и выполните две хранимые процедуры, выполняемые в SQL. В первой из них используется набор данных классической модели диафрагмы и создается модель упрощенного алгоритма Байеса для прогнозирования виды Цветова диафрагмы на основе характеристик цветов. Вторая процедура предназначена для оценки — она вызывает модель, созданную в первой процедуре, для вывода набора прогнозов на основе новых данных. Поместив код в хранимую процедуру, операции хранятся, повторно используются и вызываемые другими хранимыми процедурами и клиентскими приложениями.

Выполнив это краткое руководство, вы узнаете:

> [!div class="checklist"]
> - Внедрение кода Python в хранимую процедуру
> - Передача входных данных в код с помощью входных данных хранимой процедуры
> - Использование хранимых процедур для эксплуатацию моделей

## <a name="prerequisites"></a>Предварительные требования

- Для этого краткого руководства требуется доступ к экземпляру SQL Server с [SQL Server службы машинного обучения](../install/sql-machine-learning-services-windows-install.md) с установленным языком Python.

- Вам также понадобится средство для выполнения SQL-запросов, содержащих скрипты Python. Эти сценарии можно выполнять с помощью любого средства управления базами данных или запросов, если они могут подключаться к SQL Server экземпляру и выполнять запрос T-SQL или хранимую процедуру. В этом кратком руководстве используется [SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/sql-server-management-studio-ssms).

- Примерами данных, используемыми в этом упражнении, являются данные выборки IRI. Следуйте инструкциям в [демонстрационных данных IRI](demo-data-iris-in-sql.md) , чтобы создать образец базы данных **ирисскл**.

## <a name="create-a-stored-procedure-that-generates-models"></a>Создание хранимой процедуры, которая создает модели

На этом шаге вы создадите хранимую процедуру, которая создает модель для прогнозирования результатов.

1. Откройте новое окно запроса в SSMS, подключенном к базе данных **ирисскл** . 

    ```sql
    USE irissql
    GO
    ```

1. Скопируйте приведенный ниже код, чтобы создать новую хранимую процедуру.

   При выполнении эта процедура вызывает [sp_execute_external_script](../../relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql.md) для запуска сеанса Python. 
   
   Входные данные, необходимые для кода Python, передаются в качестве входных параметров для этой хранимой процедуры. Выходные данные будут обучены моделью, основанной на библиотеке Python **scikit-** Learning для алгоритма машинного обучения. 

   В этом коде для сериализации модели используется поле [**выбора**](https://docs.python.org/2/library/pickle.html) . Модель будет обучена с использованием данных из столбцов от 0 до 4 из таблицы **iris_data** . 
   
   Параметры, отображаемые во второй части процедуры, приводят к вводу данных и выходным данным модели. Как можно больше, необходимо, чтобы код Python, выполняемый в хранимой процедуре, имел четко определенные входные и выходные данные, сопоставленные с входными и выходными данными хранимой процедуры, передаваемыми во время выполнения.

    ```sql
    CREATE PROCEDURE generate_iris_model (@trained_model VARBINARY(max) OUTPUT)
    AS
    BEGIN
        EXECUTE sp_execute_external_script @language = N'Python'
            , @script = N'
    import pickle
    from sklearn.naive_bayes import GaussianNB
    GNB = GaussianNB()
    trained_model = pickle.dumps(GNB.fit(iris_data[["Sepal.Length", "Sepal.Width", "Petal.Length", "Petal.Width"]], iris_data[["SpeciesId"]].values.ravel()))
    '
            , @input_data_1 = N'select "Sepal.Length", "Sepal.Width", "Petal.Length", "Petal.Width", "SpeciesId" from iris_data'
            , @input_data_1_name = N'iris_data'
            , @params = N'@trained_model varbinary(max) OUTPUT'
            , @trained_model = @trained_model OUTPUT;
    END;
    GO
    ```

1. Убедитесь, что хранимая процедура существует. 

   Если скрипт T-SQL из предыдущего шага выполнялся без ошибок, создается новая хранимая процедура с именем **generate_iris_model** , которая добавляется в базу данных **ирисскл** . Хранимые процедуры можно найти в **обозревателе объектов**SSMS в разделе **программирование**.

## <a name="execute-the-procedure-to-create-and-train-models"></a>Выполнение процедуры для создания и обучения моделей

На этом шаге выполняется процедура запуска внедренного кода с созданием обученной и сериализованной модели в качестве выходных данных. 

Модели, хранимые для повторного использования в SQL Server, сериализуются как поток байтов и хранятся в столбце VARBINARY (MAX) в таблице базы данных. После того как модель создана, обучена, сериализована и сохранена в базе данных, она может быть вызвана другими процедурами или функцией [Predict T-SQL](https://docs.microsoft.com/sql/t-sql/queries/predict-transact-sql) в оценках рабочих нагрузок.

1. Выполните следующий скрипт, чтобы выполнить процедуру. Конкретная инструкция для исполнения хранимой процедуры имеет `EXECUTE` на четвертой строке.

   Этот сценарий удаляет существующую модель с тем же именем ("упрощенное использование алгоритма Байеса"), чтобы освободить место для новых, созданных путем выполнения той же процедуры. Без удаления модели возникает ошибка, сообщающая, что объект уже существует. Модель хранится в таблице с именем **iris_models**, подготовленной при создании базы данных **ирисскл** .

    ```sql
    DECLARE @model varbinary(max);
    DECLARE @new_model_name varchar(50)
    SET @new_model_name = 'Naive Bayes'
    EXECUTE generate_iris_model @model OUTPUT;
    DELETE iris_models WHERE model_name = @new_model_name;
    INSERT INTO iris_models (model_name, model) values(@new_model_name, @model);
    GO
    ```

1. Убедитесь, что модель вставлена.

    ```sql
    SELECT * FROM dbo.iris_models
    ```

    **Результаты**

    | model_name  | model |
    |---|-----------------|
    | упрощенный алгоритм Байеса | 0x800363736B6C6561726E2E6E616976655F62617965730A... | 

## <a name="create-and-execute-a-stored-procedure-for-generating-predictions"></a>Создание и выполнение хранимой процедуры для создания прогнозов

Теперь, когда модель создана, обучена и сохранена, переходите к следующему шагу: создание хранимой процедуры, создающей прогнозы. Это можно сделать, вызвав `sp_execute_external_script` для запуска скрипта Python, который загружает сериализованную модель и предоставляет ей новые входные данные для оценки.

1. Выполните следующий код, чтобы создать хранимую процедуру, которая выполняет оценку. Во время выполнения эта процедура загрузит двоичную модель, будет использовать столбцы `[1,2,3,4]` в качестве входных данных и указать столбцы `[0,5,6]` в качестве выходных данных.

   ```sql
   CREATE PROCEDURE predict_species (@model VARCHAR(100))
   AS
   BEGIN
       DECLARE @nb_model VARBINARY(max) = (
               SELECT model
               FROM iris_models
               WHERE model_name = @model
               );
   
       EXECUTE sp_execute_external_script @language = N'Python'
           , @script = N'
   import pickle
   irismodel = pickle.loads(nb_model)
   species_pred = irismodel.predict(iris_data[["Sepal.Length", "Sepal.Width", "Petal.Length", "Petal.Width"]])
   iris_data["PredictedSpecies"] = species_pred
   OutputDataSet = iris_data[["id","SpeciesId","PredictedSpecies"]] 
   print(OutputDataSet)
   '
           , @input_data_1 = N'select id, "Sepal.Length", "Sepal.Width", "Petal.Length", "Petal.Width", "SpeciesId" from iris_data'
           , @input_data_1_name = N'iris_data'
           , @params = N'@nb_model varbinary(max)'
           , @nb_model = @nb_model
       WITH RESULT SETS((
                   "id" INT
                 , "SpeciesId" INT
                 , "SpeciesId.Predicted" INT
                   ));
   END;
   GO
   ```

2. Выполните хранимую процедуру, указав имя модели "упрощенное алгоритм Байеса", чтобы процедура знала, какая модель будет использоваться.

   ```sql
   EXECUTE predict_species 'Naive Bayes';
   GO
   ```

   При выполнении хранимой процедуры она возвращает Python Data. Frame. Эта строка T-SQL указывает схему для возвращаемых результатов: `WITH RESULT SETS ( ("id" int, "SpeciesId" int, "SpeciesId.Predicted" int));`. Результаты можно вставить в новую таблицу или вернуть в приложение.

   ![Результирующий набор из выполняемой хранимой процедуры](media/train-score-using-python-NB-model-results.png)

   Результаты представляют собой 150 прогнозов о виды цветов с использованием характеристик цветочно-в качестве входных данных. Для большинства наблюдений прогнозируемый виды цветов соответствует реальному виды цветов.

   Этот пример был сделан простым, используя набор данных IRI для Python для обучения и оценки. Более типичный подход заключается в выполнении SQL-запроса для получения новых данных и передаче их в Python как @no__t – 0.

## <a name="conclusion"></a>Заключение

В этом упражнении вы узнали, как создавать хранимые процедуры, предназначенные для различных задач, где каждая хранимая процедура использовала системную хранимую процедуру `sp_execute_external_script` для запуска процесса Python. Входные данные для процесса Python передаются в `sp_execute_external` в качестве параметров. Оба скрипта Python и переменные данных в SQL Server базе данных передаются в качестве входных.

Как правило, следует планировать только использование SSMS с готовым кодом Python или простой код Python, который возвращает выходные данные на основе строк. В качестве средства SSMS поддерживает языки запросов, такие как T-SQL, и возвращает плоские наборы строк. Если код создает визуальные выходные данные, такие как точечная диаграмма или гистограмма, вам потребуется средство или приложение для конечных пользователей, которое может визуализировать изображение.

Для некоторых разработчиков Python, которые использовались для написания всего включающего сценария, обрабатывающего ряд операций, Организация задач в отдельные процедуры может показаться ненужной. Но обучение и оценка имеют разные варианты использования. Разделив их, можно разместить каждую задачу по отдельному расписанию и разрешениям области для каждой операции.

Аналогичным образом можно также использовать функции перебора SQL Server, такие как параллельная обработка, управление ресурсами, или написание сценария для использования алгоритмов в [microsoftml](../python/ref-py-microsoftml.md) , поддерживающих потоковую и параллельную обработку. Разделяя обучение и оценку, можно ориентироваться на оптимизацию для конкретных рабочих нагрузок.

Последнее преимущество заключается в том, что процессы можно изменять с помощью параметров. В этом упражнении код Python, который создал модель (под названием «упрощенный алгоритм Байеса» в этом примере), был передан в качестве входных данных для второй хранимой процедуры, вызывающей модель в процессе оценки. В этом упражнении используется только одна модель, но вы можете представить, как параметризация модели в задаче оценки сделает этот скрипт более полезным.

## <a name="next-steps"></a>Следующие шаги

Дополнительные сведения о SQL Server Службы машинного обучения см. в следующих статьях:

- [Что такое Службы машинного обучения SQL Server (Python и R)?](../what-is-sql-server-machine-learning.md)
