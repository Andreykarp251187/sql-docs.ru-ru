---
title: Создание графиков и графиков с помощью функций SQL и R — SQL Server Машинное обучение
description: Учебник, демонстрирующий создание графиков и графиков с помощью функций языка R для SQL Server.
ms.prod: sql
ms.technology: machine-learning
ms.date: 06/13/2019
ms.topic: tutorial
author: dphansen
ms.author: davidph
ms.openlocfilehash: f14005b8ba9d6f05d2b69deba29d83af5695f657
ms.sourcegitcommit: 9062c5e97c4e4af0bbe5be6637cc3872cd1b2320
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/24/2019
ms.locfileid: "68470503"
---
# <a name="create-graphs-and-plots-using-sql-and-r-walkthrough"></a>Создание графиков и графиков с помощью SQL и R (пошаговое руководство)
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md](../../includes/appliesto-ss-xxxx-xxxx-xxx-md.md)]

В этой части пошагового руководства вы узнаете о методах создания графиков и карт с помощью R с SQL Serverными данными. Вы создадите простую гистограмму, а затем разрабатываете более сложную диаграмму карт.

## <a name="prerequisites"></a>предварительные требования

Этот шаг предполагает выполнение текущего сеанса R на основе предыдущих шагов этого пошагового руководства. В нем используются строки подключения и объекты источников данных, созданные в этих шагах. Для запуска скрипта используются следующие средства и пакеты.

+ RGUI. exe для выполнения команд R
+ Management Studio для выполнения T-SQL
+ googMap
+ пакет ggmap
+ пакет mapproj

## <a name="create-a-histogram"></a>Создание гистограммы

1. Создайте первую диаграмму с помощью функции [rxHistogram](https://docs.microsoft.com/r-server/r-reference/revoscaler/rxdatasource) .  Функция rxHistogram предоставляет функциональные возможности, аналогичные тем, которые находятся в пакетах R с открытым исходным кодом, но могут выполняться в контексте удаленного выполнения.

    ```R
    # Plot fare amount on SQL Server and return the plot
    start.time <- proc.time()
    rxHistogram(~fare_amount, data = inDataSource, title = "Fare Amount Histogram")
    used.time <- proc.time() - start.time
    print(paste("It takes CPU Time=", round(used.time[1]+used.time[2],2), " seconds, Elapsed Time=", round(used.time[3],2), " seconds to generate plot.", sep=""))
    ```

2. Изображение возвращается в графическом устройстве R вашей среды разработки.  Например, в RStudio откройте окно **Plot** (График).  В [!INCLUDE[rsql_rtvs](../../includes/rsql-rtvs-md.md)]открывается отдельное графическое окно.

    ![использование rxHistogram для построения диаграммы сумм оплаты](media/rsql-e2e-rxhistogramresult.png "использование rxHistogram для построения диаграммы сумм оплаты")

    > [!NOTE]
    > Выглядит ли диаграмма в разных масштабах?
    >  
    > Это обусловлено тем, что в _DataSource_ используются только первые 1000 строк. Упорядочивание строк с помощью предложения TOP является недетерминированным при отсутствии предложений ORDER BY, поэтому предполагается, что данные и результирующий граф могут отличаться.
    > Конкретно это изображение было создано с использованием приблизительно 10 000 строк данных. Мы рекомендуем поэкспериментировать с разным числом строк, чтобы получить разные графики, и обратить внимание на то, как долго возвращаются результаты в вашей среде.

## <a name="create-a-map-plot"></a>Создание графика на карте

Как правило, серверы баз данных блокируют доступ к Интернету. Это может оказаться неудобным при использовании пакетов R, которые требуют загрузки карт или других изображений для создания графиков. Однако существует обходной путь, который может оказаться полезным при разработке собственных приложений. По сути, вы создаете представление схемы на клиенте, а затем накладываете на карту точки, которые хранятся в качестве атрибутов в таблице SQL Server.

1. Определите функцию, которая создает объект R Graph. Пользовательская функция *mapPlot* создает точечную диаграмму, которая использует расположения для отправки такси, и отображает число пересылок, запускаемых из каждого расположения. Он использует пакеты **ggplot2** и **ggmap** , которые уже должны быть [установлены и загружены](walkthrough-data-science-end-to-end-walkthrough.md#add-packages).

    ```R
    mapPlot <- function(inDataSource, googMap){
        library(ggmap)
        library(mapproj)
        ds <- rxImport(inDataSource)
        p <- ggmap(googMap)+
        geom_point(aes(x = pickup_longitude, y =pickup_latitude ), data=ds, alpha =.5,
    color="darkred", size = 1.5)
        return(list(myplot=p))
    }
    ```

    + Функция *mapPlot* принимает два аргумента: существующий объект данных, определенный ранее с помощью RxSqlServerData, и представление Map, передаваемое из клиента.
    + В строке, начинающейся с переменной *DS* , rxImport используется для загрузки данных в память из ранее созданного источника данных ( *DataSource*). (Этот источник данных содержит только 1000 строк. Если вы хотите создать карту с большим количеством точек данных, можно заменить другой источник данных.)
    + При использовании функций R с открытым исходным кодом данные должны быть загружены в кадры данных в локальной памяти. Однако, вызвав функцию [rxImport](https://docs.microsoft.com/r-server/r-reference/revoscaler/rximport) , можно выполнить в памяти в удаленном контексте вычислений.

2. Измените контекст вычислений на локальный и загрузите библиотеки, необходимые для создания карт.

    ```R
    rxSetComputeContext("local")
    library(ggmap)
    library(mapproj)
    gc <- geocode("Times Square", source = "google")
    googMap <- get_googlemap(center = as.numeric(gc), zoom = 12, maptype = 'roadmap', color = 'color');
    ```

    + В переменной `gc` хранится набор координат площади Таймс-сквер в Нью-Йорке.

    + Строка, начинающаяся с `googmap` , создает карту с указанными координатами в центре.

3. Переключитесь на SQL Server контекст вычислений и визуализируйте результаты, заключив функцию графика в [rxExec](https://docs.microsoft.com/r-server/r-reference/revoscaler/rxexec) , как показано здесь. Функция rxExec является частью пакета **RevoScaleR** и поддерживает выполнение произвольных функций R в удаленном контексте вычислений.

    ```R
    rxSetComputeContext(sqlcc)
    myplots <- rxExec(mapPlot, inDataSource, googMap, timesToRun = 1)
    plot(myplots[[1]][["myplot"]]);
    ````

    + Данные сопоставлений `googMap` в передаются в качестве аргумента в удаленно выполненную функцию *mapPlot*. Поскольку карты были созданы в локальной среде, они должны быть переданы в функцию, чтобы создать график в контексте SQL Server.

    + При выполнении строки, начинающейся с `plot` , данные, готовые для просмотра, сериализуются в локальную среду r, чтобы их можно было просматривать в клиенте r.

    > [!NOTE]
    > Если вы используете SQL Server на виртуальной машине Azure, на этом этапе может появиться ошибка. Если правило брандмауэра по умолчанию в Azure блокирует доступ к сети по коду R, возникает ошибка. Дополнительные сведения об устранении этой ошибки см. в статье [Установка служб машинное обучение (R) на виртуальной машине Azure](../install/sql-machine-learning-azure-virtual-machine.md).

4. На следующем рисунке показана итоговая диаграмма. Места посадки обозначены на карте красными точками. Образ может выглядеть иначе, в зависимости от того, сколько расположений находится в используемом источнике данных.

    ![отображение диаграммы поездок в такси с помощью пользовательской функции R](media/rsql-e2e-mapplot.png "отображение диаграммы поездок в такси с помощью пользовательской функции R")

## <a name="next-steps"></a>Следующие шаги

> [!div class="nextstepaction"]
> [Создание функций данных с помощью R и SQL](walkthrough-create-data-features.md)
