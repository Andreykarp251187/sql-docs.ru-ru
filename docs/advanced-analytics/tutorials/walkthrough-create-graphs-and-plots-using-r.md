---
title: Создание диаграмм и графиков с помощью SQL и R функции - машинного обучения SQL Server
description: Учебник, в котором показано, как создание диаграмм и графиков с помощью функций языка R на SQL Server.
ms.prod: sql
ms.technology: machine-learning
ms.date: 06/13/2019
ms.topic: tutorial
author: dphansen
ms.author: davidph
ms.openlocfilehash: 542e36e01565ab454cce8beae9a4fa65279d8fa6
ms.sourcegitcommit: b2464064c0566590e486a3aafae6d67ce2645cef
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/15/2019
ms.locfileid: "67961787"
---
# <a name="create-graphs-and-plots-using-sql-and-r-walkthrough"></a>Создание диаграмм и графиков с помощью SQL и R (Пошаговое руководство)
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md-winonly](../../includes/appliesto-ss-xxxx-xxxx-xxx-md-winonly.md)]

В этой части пошагового руководства вы узнаете способы создания графиков и схем с использованием R с данными SQL Server. Создание простой гистограммы и затем разрабатывать более сложную диаграмму-карту.

## <a name="prerequisites"></a>предварительные требования

Этот шаг предполагает выполняющимся R сеансом, в зависимости от предыдущего шага в этом пошаговом руководстве. Он использует соединение строк и данных источника объекты, созданные в этих шагах. Для запуска сценария используются следующие средства и пакеты.

+ RGUI.exe для выполнения команд R
+ Management Studio для выполнения T-SQL
+ googMap
+ пакет ggmap
+ пакет mapproj

## <a name="create-a-histogram"></a>Создание гистограммы

1. Создайте первую диаграмму с помощью функции [rxHistogram](https://docs.microsoft.com/r-server/r-reference/revoscaler/rxdatasource) .  Функция rxHistogram предоставляет функциональность, аналогичную, в пакеты R с открытым исходным, но можно выполнять в контексте удаленного выполнения.

    ```R
    # Plot fare amount on SQL Server and return the plot
    start.time <- proc.time()
    rxHistogram(~fare_amount, data = inDataSource, title = "Fare Amount Histogram")
    used.time <- proc.time() - start.time
    print(paste("It takes CPU Time=", round(used.time[1]+used.time[2],2), " seconds, Elapsed Time=", round(used.time[3],2), " seconds to generate plot.", sep=""))
    ```

2. Изображение возвращается в графическом устройстве R вашей среды разработки.  Например, в RStudio откройте окно **Plot** (График).  В [!INCLUDE[rsql_rtvs](../../includes/rsql-rtvs-md.md)]открывается отдельное графическое окно.

    ![использование rxHistogram для построения диаграммы сумм оплаты](media/rsql-e2e-rxhistogramresult.png "использование rxHistogram для построения диаграммы сумм оплаты")

    > [!NOTE]
    > Графа выглядят иначе?
    >  
    > Это потому, что _inDataSource_ использует только первые 1000 строк. Упорядочение строк с помощью предложения TOP является недетерминированным в отсутствие предложение ORDER BY, поэтому предполагается, что данные и полученный граф могут различаться.
    > Конкретно это изображение было создано с использованием приблизительно 10 000 строк данных. Мы рекомендуем поэкспериментировать с разным числом строк, чтобы получить разные графики, и обратить внимание на то, как долго возвращаются результаты в вашей среде.

## <a name="create-a-map-plot"></a>Создание диаграммы-карты

Как правило серверы баз данных блокируют доступ к Интернету. Это может быть неудобно при использовании пакетов R, загрузить карты или других образов для создания диаграмм. Однако есть обходной путь, который могут оказаться полезными при разработке собственных приложений. По сути вы создадите представление карты на клиентском компьютере и затем наложите на карту точки, которые хранятся в виде атрибутов в таблице SQL Server.

1. Определите функцию, создающую объект диаграммы R. Пользовательская функция *mapPlot* создает точечную диаграмму, места посадки и отображает количество поездок, которые начались из каждого расположения. Она использует **ggplot2** и **ggmap** пакетов, которые должны быть [установленных и загруженных](walkthrough-data-science-end-to-end-walkthrough.md#add-packages).

    ```R
    mapPlot <- function(inDataSource, googMap){
        library(ggmap)
        library(mapproj)
        ds <- rxImport(inDataSource)
        p <- ggmap(googMap)+
        geom_point(aes(x = pickup_longitude, y =pickup_latitude ), data=ds, alpha =.5,
    color="darkred", size = 1.5)
        return(list(myplot=p))
    }
    ```

    + *MapPlot* функция принимает два аргумента: существующий объект данных, который вы определили ранее с помощью функции RxSqlServerData и представление карты, переданное из клиента.
    + В строке, начиная с *доменных служб Active Directory* переменной, функции rxImport используется для загрузки в памяти данные из ранее созданного источника данных, *inDataSource*. (Этот источник данных содержит только 1000 строк, если вы хотите создать карту с большим количеством точек данных, можно заменить другой источник данных.)
    + Каждый раз при использовании функций R открытым исходным кодом, данные должны быть загружены в кадры данных в локальной памяти. Тем не менее, путем вызова [rxImport](https://docs.microsoft.com/r-server/r-reference/revoscaler/rximport) функции, можно выполнить в памяти в контексте удаленных вычислений.

2. Меняет контекст вычисления для локальной и загрузите библиотеки, необходимые для создания карт.

    ```R
    rxSetComputeContext("local")
    library(ggmap)
    library(mapproj)
    gc <- geocode("Times Square", source = "google")
    googMap <- get_googlemap(center = as.numeric(gc), zoom = 12, maptype = 'roadmap', color = 'color');
    ```

    + В переменной `gc` хранится набор координат площади Таймс-сквер в Нью-Йорке.

    + Строка, начинающаяся с `googmap` , создает карту с указанными координатами в центре.

3. Переключитесь в контекст вычислений SQL Server и обрабатывать результаты, заключив функции графиков в [rxExec](https://docs.microsoft.com/r-server/r-reference/revoscaler/rxexec) как показано ниже. Функция rxExec является частью **RevoScaleR** пакета и поддерживает выполнение произвольных функций R в удаленном контексте вычислений.

    ```R
    rxSetComputeContext(sqlcc)
    myplots <- rxExec(mapPlot, inDataSource, googMap, timesToRun = 1)
    plot(myplots[[1]][["myplot"]]);
    ````

    + Данные карты в `googMap` передается в качестве аргумента в функцию *mapPlot*. Поскольку карты были созданы в локальной среде, они должны передаваться в функцию для создания графика в контексте SQL Server.

    + Если строка, начинающаяся с `plot` запусков, готовый для просмотра данных сериализуется в локальную среду R, и вы сможете просматривать в клиентском приложении R.

    > [!NOTE]
    > Если вы используете SQL Server на виртуальной машине Azure, на этом этапе может возникнуть ошибка. Когда правило брандмауэра по умолчанию в Azure блокирует доступ к сети, кодом R, возникает ошибка. Дополнительные сведения о том, как устранить эту ошибку, см. в разделе [установке машинного обучения (R) службы на виртуальной Машине Azure](../install/sql-machine-learning-azure-virtual-machine.md).

4. На следующем рисунке показана итоговая диаграмма. Места посадки обозначены на карте красными точками. Образ может выглядеть иначе, в зависимости от какого количества расположений, в источнике данных, которая использовалась.

    ![отображение диаграммы поездок в такси с помощью пользовательской функции R](media/rsql-e2e-mapplot.png "отображение диаграммы поездок в такси с помощью пользовательской функции R")

## <a name="next-steps"></a>Следующие шаги

> [!div class="nextstepaction"]
> [Создание функций данных с помощью R и SQL.](walkthrough-create-data-features.md)
