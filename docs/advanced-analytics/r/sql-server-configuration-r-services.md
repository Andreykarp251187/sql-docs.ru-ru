---
title: Конфигурация SQL Server (службы R) — SQL Server службы машинного обучения
ms.prod: sql
ms.technology: machine-learning
ms.date: 03/29/2019
ms.topic: conceptual
author: dphansen
ms.author: davidph
manager: cgronlun
ms.openlocfilehash: 9ad4d1a23a05db35e0c4b55473903dbf7e4265da
ms.sourcegitcommit: 3026c22b7fba19059a769ea5f367c4f51efaf286
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/15/2019
ms.locfileid: "62641945"
---
# <a name="sql-server-configuration-for-use-with-r"></a>Конфигурация SQL Server для использования с R
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md-winonly](../../includes/appliesto-ss-xxxx-xxxx-xxx-md-winonly.md)]

В этой статье — вторая в серии, описывает оптимизацию производительности для служб R, в зависимости от двух исследований.  Эта статья содержит рекомендации по аппаратной и сетевой конфигурации компьютера, который используется для запуска служб R SQL Server. Он также содержит сведения о способах настройки экземпляра SQL Server, базы данных или таблицы, используемые в решении. Так как использование NUMA в SQL Server стирает грань между оптимизации оборудования и базы данных, третьем разделе рассматриваются ЦП сопоставить и управление ресурсами подробно.

> [!TIP]
> Если вы не знакомы с SQL Server, мы настоятельно рекомендуем также просмотреть руководство по настройке производительности SQL Server: [Наблюдение и настройка производительности](https://docs.microsoft.com/sql/relational-databases/performance/monitor-and-tune-for-performance).

## <a name="hardware-optimization"></a>Оптимизация оборудования

Оптимизация сервера важно убедиться, что у вас есть ресурсы для выполнения внешних скриптов. Когда ресурсы достаточно ограничены, может появиться симптомы такие:

- Выполнение задания откладывается или отменить, чтобы определять их приоритеты других операций базы данных
- Ошибка «Квота превышена» вызывающие R-скрипте завершить без завершения
- Данные загружаются в память R усечен для неполных результатов

### <a name="memory"></a>Память

Объем доступной памяти может иметь значительное влияние на производительность расширенных аналитических алгоритмов. Недостаточно памяти может повлиять на степень параллелизма при использовании контекста вычислений SQL. Это также может повлиять на размер фрагмента данных (строк на каждую операцию чтения), который можно обработать, и поддерживаемое число одновременных сеансов.

Настоятельно рекомендуется не менее 32 ГБ. Если у вас есть более чем 32 ГБ, можно настроить источник данных SQL, чтобы использовать большее число строк в каждой операции чтения для повышения производительности.

Кроме того, вы можете управлять памяти, используемый экземпляром. По умолчанию SQL Server имеет приоритет перед внешними процессами скриптов при выделении памяти. При установке служб R по умолчанию выделяется только 20% от доступной памяти для R.

Обычно этого достаточно не для выполнения задач обработки и анализа данных, но не хотите препятствовать работе SQL server памяти. Необходимо поэкспериментировать и точной настройки распределение памяти между ядром СУБД, связанные с ней службы и внешних скриптов, с учетом того, что оптимальной конфигурации зависят от случая.

Для модели подбора резюме использования внешних скриптов было активно и были другие базы данных службы ядра СУБД выполняется; Таким образом ресурсы, выделенные для внешних скриптов были увеличено до 70%, который был оптимальные для производительности с использованием сценария.

### <a name="power-options"></a>Параметры управления электропитанием

В операционной системе Windows **высокопроизводительных** должен использоваться параметр питания. Используя другой параметр приводит к снижению или несогласованности производительности при использовании SQL Server.

### <a name="disk-io"></a>Дисковые операции ввода-вывода

Обучение и прогнозирование, что задания с помощью служб R по своей природе являются операции ввода-ВЫВОДА привязан и зависят от скорости дисков, хранящиеся в базе данных. Более быстрые диски, например твердотельных накопителей (SSD) может помочь.

На дисковые операции ввода-вывода также оказывают влияние и другие приложения, у которых есть доступ к диску, например операции чтения базы данных, выполняемые другими клиентами. На производительность дисковых операций ввода-вывода могут влиять параметры текущей файловой системы, например размер блока, используемый этой системой.

Если доступны несколько дисков, баз данных на диске, отличном от SQL Server, который запрашивает для компонента database engine не превышают том же диске хранилище запросов для данных, хранящихся в базе данных.

Дисковые операции ввода-вывода могут оказывать значительное влияние на производительность при выполнении аналитических функций RevoScaleR, использующих несколько итераций во время обучения. Например `rxLogit`, `rxDTree`, `rxDForest`, и `rxBTrees` используют несколько итераций. Если источником данных SQL Server, эти алгоритмы используют временные файлы, которые оптимизированы для сбора данных. Эти файлы автоматически удаляются после завершения сеанса. Диск высокой производительности для операций чтения и записи может значительно повысить общее прошедшее время для этих алгоритмов.

> [!NOTE]
> Ранние версии служб R требуется включена поддержка имени файла 8.3 операционных системах Windows. Это ограничение было снято после пакета обновления 1. Тем не менее можно использовать fsutil.exe определить, поддерживает ли диск имена файлов 8.3, или для включения поддержки, если это не так.

### <a name="paging-file"></a>Файл подкачки

Операционная система Windows использует файл подкачки для управления аварийными дампами и хранения страниц виртуальной памяти. Если обнаружена излишняя подкачка, необходимо увеличить физическую память компьютера. Несмотря на то что больший объем физической памяти не устранит подкачку, это значительно уменьшит потребность в ней.

Скорость диска, на котором хранится файл подкачки, также влияет на производительность. Вы можете улучшить ее, если сохраните файл подкачки на диске SSD или если будете использовать файлы подкачки на нескольких дисках SSD.

Сведения об изменении размера файла подкачки см. в разделе [как определить размер файла подкачки для 64-разрядных версиях Windows](https://support.microsoft.com/kb/2860880).

## <a name="optimizations-at-instance-or-database-level"></a>Оптимизация на уровне экземпляра или базы данных

Оптимизация экземпляра SQL Server является ключом для эффективного выполнения внешних скриптов.

> [!NOTE]
> Оптимальные параметры различаются в зависимости от размера и типа данных, количество столбцов, используемых для оценки и обучения модели.
> 
> Можно просмотреть результаты оптимизировать код в окончательный статье: [Помощник по настройке производительности - пример внедрения результатов](../../advanced-analytics/r/performance-case-study-r-services.md)
> 
> Примеры сценариев, см. в разделе отдельные [репозиторий GitHub](https://github.com/Microsoft/SQL-Server-R-Services-Samples/tree/master/PerfTuning).

### <a name="table-compression"></a>Сжатие таблицы

Часто можно улучшить производительность ввода-ВЫВОДА с помощью сжатия или хранения данных в хранилище. Обычно данные повторяются в нескольких столбцах в таблице, поэтому с помощью кластеризованного индекса columnstore принимает воспользоваться этим при сжатии данных.

Columnstore не может быть эффективен, если существует множество операций вставки в таблицу, но является хорошим выбором, если данные являются статическими или только изменяются редко. Если хранилище столбцов нельзя использовать по каким-либо причинам, чтобы улучшить операции ввода-вывода, можно включить сжатие для основной таблицы строк.

Дополнительные сведения см. в следующих статьях:

+ [Сжатие данных](../../relational-databases/data-compression/data-compression.md)

+ [Включение сжатия таблицы или индекса](../../relational-databases/data-compression/enable-compression-on-a-table-or-index.md)

+ [Руководство по индексам columnstore](../../relational-databases/indexes/columnstore-indexes-overview.md)

### <a name="memory-optimized-tables"></a>Таблицы, оптимизированные для памяти

В настоящее время памяти больше не проблема для современных компьютеров. Как характеристики оборудования смогли улучшить, это относительно легко получить ОЗУ на оптимальных значений. Тем не менее в то же время данных создается быстрее, чем когда-либо, и данные должны обрабатываться с низкой задержкой.

Оптимизированные для памяти таблицы представляют одно из возможных решений, в том, что они используют большим объемом памяти, в дополнительные компьютеры для решения этой проблемы больших данных. Оптимизированные для памяти таблицы находятся в памяти, главным образом, чтобы данные считываются из и записываются в память. Для обеспечения надежности вторую копию таблицы, сохраняется на диске, и данные только считываются с диска во время восстановления базы данных.

Если необходимо выполнить чтение и запись к таблицам, часто, оптимизированные для памяти таблицы может помочь с высокой масштабируемостью и низкой задержкой.  В сценарии подбора резюме использование таблиц, оптимизированных для памяти позволил нам чтение всех функций resume из базы данных и хранить их в оперативной памяти, в соответствии с новой вакансий. Это значительно уменьшается операций ввода-ВЫВОДА.

С помощью оптимизированных для памяти таблицы в процессе написания прогнозов обратно в базу данных из нескольких параллельных пакетов движущееся изображение достигалось повышает производительность. Использование таблиц, оптимизированных для памяти, на сервере SQL Server с поддержкой низкой задержкой в таблице операций чтения и записи.

Процесс был простой также во время разработки. В то же время, который был создан в базе данных были созданы устойчивых таблиц, оптимизированных для памяти. Таким образом разработки использовать тот же рабочий процесс, независимо от хранения данных.

### <a name="processor"></a>Процессор

SQL Server можно выполнять задачи параллельно, используя доступные ядра на компьютере; чем больше ядер, которые доступны, тем выше производительность. При увеличении числа ядер может не помочь для операций ввода-ВЫВОДА привязаны, ЦП привязан алгоритмы преимущество благодаря быстрым ЦП с большим количеством ядер.

Так как сервер обычно используется несколькими пользователями одновременно, администратор базы данных необходимо определить оптимальное количество ядер, которые необходимы для поддержки пиковых вычислений рабочих нагрузок.

### <a name="resource-governance"></a>Управление ресурсами

В выпусках, поддерживающих регулятор ресурсов можно использовать пулы ресурсов для указания, что некоторые рабочие нагрузки выделяются некоторое количество процессоров. Вы также можете управлять объем памяти, выделенной для конкретных рабочих нагрузок.

Управление ресурсами в SQL Server позволяет централизованно отслеживать и контролировать различные ресурсы, используемые SQL Server и R. Например может выделить половину объем доступной памяти для ядра СУБД, чтобы убедиться, что основные службы всегда могут работать несмотря на временные более высокие рабочие нагрузки.

Значение по умолчанию для потребления памяти службами внешних скриптов ограничено 20% от общего объема памяти, доступных для SQL Server. Это ограничение применяется по умолчанию, чтобы убедиться, что все задачи, которые зависят от сервера базы данных, не подвержены важности длительные задания r. Однако администратор базы данных может изменить эти ограничения. Во многих случаях ограничение в 20% не достаточно для поддержки серьезных нагрузок машинного обучения.

Параметры конфигурации, поддерживаемые являются **MAX_CPU_PERCENT**, **MAX_MEMORY_PERCENT**, и **MAX_PROCESSES**. Чтобы просмотреть текущие параметры, используйте эту инструкцию: `SELECT * FROM sys.resource_governor_external_resource_pools`

-  Если сервер в основном используется для служб R, может быть полезным увеличить MAX_CPU_PERCENT до 40 или 60%.

-  Если количество сеансов R необходимо использовать тот же сервер, в то же время, все три параметра должно быть увеличено.

Чтобы изменить значения выделенных ресурсов, используйте инструкции T-SQL.

+ Эта инструкция потребления памяти задается показатель 40%: `ALTER EXTERNAL RESOURCE POOL [default] WITH (MAX_MEMORY_PERCENT = 40)`

+ Эта инструкция задает все три значения можно настроить: `ALTER EXTERNAL RESOURCE POOL [default] WITH (MAX_CPU_PERCENT = 40, MAX_MEMORY_PERCENT = 50, MAX_PROCESSES = 20)`

+ Если изменить память, ЦП или установка max процесса и затем хотите немедленно применить параметры, выполните следующую инструкцию: `ALTER RESOURCE GOVERNOR RECONFIGURE`

## <a name="soft-numa-hardware-numa-and-cpu-affinity"></a>Соответствие программной архитектуры NUMA, оборудованием NUMA и ЦП

При использовании SQL Server в качестве контекста вычисления, иногда можно добиться повышения производительности путем настройки, связанные с NUMA и соответствие процессора. 

Системы с _оборудования NUMA_ имеют несколько системных шин, каждая из которых обслуживает небольшую группу процессоров. Каждый ЦП может иметь доступ к памяти, связанной с другими группами в рамках. Каждая группа называется узлом NUMA. Если имеется оборудование NUMA, оно может быть настроено так, что вместо NUMA используется чередующаяся память. В этом случае Windows и, следовательно, SQL Server не распознает его как NUMA. 

Можно выполнить следующий запрос, чтобы найти количество узлов памяти, доступной для SQL Server:

```sql
SELECT DISTINCT memory_node_id
FROM sys.dm_os_memory_clerks
```

Если запрос возвращает один узел памяти (узел 0), либо у вас нет оборудования NUMA, либо оборудование настроено как с чередованием (не NUMA). SQL Server также игнорирует оборудования NUMA при есть четыре или меньшее число процессоров, или если по крайней мере на одном узле находится только один ЦП.

Если на компьютере установлено несколько процессоров, но не имеет оборудования NUMA, можно также использовать [программной архитектуры NUMA](https://docs.microsoft.com/sql/database-engine/configure-windows/soft-numa-sql-server) для разделения процессоров на более мелкие группы.  В SQL Server 2016 и SQL Server 2017 функцию Soft-NUMA включается автоматически при запуске службы SQL Server.

При программной архитектуры NUMA включен, SQL Server автоматически управляет узлами Тем не менее, чтобы оптимизировать для конкретных рабочих нагрузок, можно отключить _обратимо сходства_ и вручную настроить сходство ЦП для обратимо узлов NUMA. Это можно получить больший контроль, по которому рабочих нагрузок назначены какие узлы, особенно в том случае, если вы используете выпуск SQL Server, который поддерживает управление ресурсами. Задание соответствия Процессоров и выравнивание пулов ресурсов с группами процессоров, можно уменьшить задержку и убедитесь, что связанные процессы выполняются на одном узле NUMA.

Общий процесс для настройки программной архитектуры NUMA, а также соответствие Процессоров для поддержки рабочих нагрузок R выглядит следующим образом:

1. Включить архитектуры soft-NUMA, если он доступен
2. Определить соответствие процессоров
3. Создание пулов ресурсов для внешних процессов, с помощью [регулятора ресурсов](../r/resource-governance-for-r-services.md)
4. Назначить [группы рабочей нагрузки](../../relational-databases/resource-governor/resource-governor-workload-group.md) для конкретного Территориальные группы

Сведения, включая пример кода см. в этом руководстве: [SQL оптимизации советы и рекомендации (Ke Хаун)](https://gallery.cortanaintelligence.com/Tutorial/SQL-Server-Optimization-Tips-and-Tricks-for-Analytics-Services)

**Другие ресурсы:**

+ [Архитектура soft-NUMA, в SQL Server](https://docs.microsoft.com/sql/database-engine/configure-windows/soft-numa-sql-server)
    
    Сопоставление узлов программной архитектуры NUMA ЦП

## <a name="task-specific-optimizations"></a>Оптимизация для конкретных задач

В этом разделе перечислены методы, которые реализуют эти примеры внедрения и другие тесты, для оптимизации конкретных нагрузок машинного обучения. Типичные рабочие нагрузки включают обучения модели, извлечением компонентов и проектирование признаков и различные сценарии для оценки: одной строки, небольшой пакет и большого пакета.

### <a name="feature-engineering"></a>Формирование признаков

Ищут с помощью R — что оно обычно обрабатывается на один ЦП. Это основной ограничивающий фактор производительности для многих задач, особенно проектирование признаков. В решении для подбора резюме только задаче разработки компонента создан 2500 перекрестного произведения функций, было необходимо использовать вместе с исходной 100 функций. Эта задача потребуется значительное количество времени, если все, что было выполнено на один ЦП.

Существует несколько способов для повышения производительности реконструирования. Можно оптимизировать код R и оставить извлечения признаков в процессе моделирования или переместите процессом разработки функции в SQL.

- С помощью языка R. Определить функцию и передайте его в качестве аргумента для [rxTransform](https://docs.microsoft.com/r-server/r-reference/revoscaler/rxtransform) во время обучения. Если модель поддерживает параллельную обработку, задаче разработки компонента могут обрабатываться с помощью нескольких процессоров. При таком подходе команды обработки и анализа данных наблюдается повышение производительности 16% с точки зрения оценки времени. Тем не менее этот подход требует модели, которая поддерживает параллелизации и запрос, который можно выполнить, используя параллельный план.

- Контекст вычислений для использования R с SQL. В многопроцессорной среде с изолированных ресурсов, доступных для выполнения отдельных пакетов можно добиться большей эффективности, изолируя запросов SQL, используемых для каждого пакета для извлечения данных из таблиц и ограничения данных в той же группе рабочей нагрузки. Методы, используемые для изоляции пакетов включать разделы и использование PowerShell для параллельного выполнения отдельных запросов.

- Параллельное выполнение ad-hoc: В контексте вычислений SQL Server можно полагаться на ядро базы данных SQL для обеспечения параллельного выполнения, если это возможно и если найден соответствующий параметр для повышения эффективности.

- Использование T-SQL в процессе, отдельном Добавление признаков. Precomputing данных компонентов, с помощью SQL обычно является быстрее.

### <a name="prediction-scoring-in-parallel"></a>Прогноз (оценки), в параллельном режиме

Одним из преимуществ использования SQL Server является его способность обрабатывать большое количество строк в параллельном режиме. Совсем не это преимущество таким образом помечен как оценки. Обычно модели не требуется доступ ко всем данным для оценки, что позволяет разбивать входные данные, с каждой группой рабочей нагрузки обработки одной задачи.

Вы также можете отправлять входные данные как отдельный запрос, и SQL Server затем анализирует запрос. Если параллельный план запроса может быть создан для входных данных, он автоматически разбивает данные, которые назначены всем узлам и также параллельно выполняет необходимые операции соединения и агрегирования.

Если вы заинтересованы в сведениях о способах определения хранимой процедуры для использования в оценке, см. в разделе примера проекта на [GitHub](https://github.com/Microsoft/SQL-Server-R-Services-Samples/tree/master/SQLOptimizationTips/SQLR) и найдите файл «step5_score_for_matching.sql». Пример скрипта также, отслеживает Начало запроса и времени окончания, а также записывает время на консоль SQL, таким образом, можно оценить производительность.

### <a name="concurrent-scoring-using-resource-groups"></a>Параллельные оценки, с помощью групп ресурсов

Чтобы увеличить масштаб оценки проблему, рекомендуется применять подход MAP-Reduce, в котором миллионы элементов можно разделить на несколько пакетов. Затем одновременно выполняются несколько заданий оценки. В этом варианте, пакетов, обработанных на разных наборах ЦП, и результаты собираются и записываются обратно в базу данных.

Этот подход используется в сценарии подбора резюме; Тем не менее управление ресурсами в SQL Server необходима для реализации этого подхода. Настраивая группы рабочей нагрузки для внешних скриптов заданий, можно направлять R оценки задания для разных процессоров и обеспечить более высокую пропускную способность.

Управление ресурсами также может помочь выделить разделить доступные ресурсы на сервере (ЦП и памяти), для минимизации конкурентной борьбы рабочей нагрузки. Можно настроить функции-классификаторы, чтобы различать разные типы заданий R: например, может решить, что оценки, вызываемой из приложения всегда имеет приоритет, во время повторного обучения задания имеют низкий приоритет. Такая изоляция ресурсов может потенциально сократить время выполнения и обеспечивает более предсказуемую производительность.

### <a name="concurrent-scoring-using-powershell"></a>Параллельные оценки с помощью PowerShell

Если принято решение для секционирования данных самостоятельно, можно использовать скрипты PowerShell для выполнения нескольких одновременных задач оценки. Чтобы сделать это, используйте командлет Invoke-SqlCmd, а инициировать задач оценки в параллельном режиме.

В случае подбора резюме параллелизма была разработана следующим образом:

- 20 процессоров разделить на четыре группы по пять ЦП. Каждая группа процессоров находится на том же узле NUMA.

- Максимальное количество параллельных пакетов был установлен до восьми.

- Каждая группа рабочей нагрузки необходимо выполнять задачи оценки. Сразу же после завершения одной задачи чтения данных и запуска оценки другая задача может начинается чтение данных из базы данных.

Чтобы просмотреть скрипты PowerShell для этого сценария, откройте experiment.ps1 файл в [проекта Github](https://github.com/Microsoft/SQL-Server-R-Services-Samples/tree/master/SQLOptimizationTips).

### <a name="storing-models-for-prediction"></a>Хранение моделей прогнозирования

При обучения и оценки завершения и вы выбрали оптимальную модель, рекомендуется сохранить модель в базе данных, чтобы он был доступен для создания прогнозов. Загрузка предварительно вычисленные модели из базы данных для прогноза эффективен, поскольку машинного обучения SQL Server использует алгоритмы специальные сериализации для хранения и загружать модели, при переходе между R и базы данных.

> [!TIP]
> В SQL Server 2017 можно использовать функцию PREDICT для выполнения оценки, даже если R не установлен на сервере. Поддерживаются только модели типов, из пакета RevoScaleR.

Тем не менее в зависимости от используемого алгоритма, некоторые модели могут быть довольно большими, особенно в том случае, если обученные на основе большого набора данных. Например, алгоритмы, такие как **lm** или **glm** создавать большое число сводных данных, а также правила. Так как существуют ограничения на размер модели, которые могут храниться в столбце varbinary, рекомендуется исключить ненужные артефакты из модели перед сохранением модели в базе данных для рабочей среды.

## <a name="articles-in-this-series"></a>Статьях этой серии

[Производительность Настройка для R — введение](../r/sql-server-r-services-performance-tuning.md)

[Настройка производительности для R — конфигурация SQL Server](../r/sql-server-configuration-r-services.md)

[Настройка производительности для R — R оптимизации кода и данных](../r/r-and-data-optimization-r-services.md)

[Помощник по настройке производительности - пример внедрения результатов](../r/performance-case-study-r-services.md)
