---
title: Общие сведения о безопасности для платформы расширяемости
description: Общие сведения о безопасности для платформы расширяемости в службах машинного обучения SQL Server. Безопасность имен входа и учетных записей пользователей, службы панели запуска SQL Server, рабочих учетных записей, разрешений для файлов и выполнения нескольких скриптов.
ms.prod: sql
ms.technology: machine-learning
ms.date: 10/17/2018
ms.topic: conceptual
author: dphansen
ms.author: davidph
ms.custom: seo-lt-2019
monikerRange: '>=sql-server-2016||>=sql-server-linux-ver15||=sqlallproducts-allversions'
ms.openlocfilehash: f2e2d696a09e5b5bb321da583efd76f580759ce6
ms.sourcegitcommit: 09ccd103bcad7312ef7c2471d50efd85615b59e8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/07/2019
ms.locfileid: "73727664"
---
# <a name="security-overview-for-the-extensibility-framework-in-sql-server-machine-learning-services"></a>Общие сведения о безопасности для платформы расширяемости в службах машинного обучения SQL Server

[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md](../../includes/appliesto-ss-xxxx-xxxx-xxx-md.md)]

В этой статье описывается общая архитектура безопасности, используемая для интеграции ядра СУБД SQL Server и связанных компонентов с платформой расширяемости. Здесь рассматриваются защищаемые объекты, службы, удостоверения процессов и разрешения. Дополнительные сведения о ключевых понятиях и компонентах расширяемости в SQL Server см. в статье [Архитектура расширяемости в службах машинного обучения SQL Server ](extensibility-framework.md).

## <a name="securables-for-external-script"></a>Защищаемые объекты для внешнего скрипта

Внешний скрипт, написанный на языке R или Python, передается в качестве входного параметра в созданную для этой цели [системную хранимую процедуру](../../relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql.md) или помещается в определяемую пользователем хранимую процедуру. Кроме того, можно использовать модели, которые предварительно обучены и сохранены в двоичном формате в таблице базы данных и вызываются с помощью функции T-SQL [PREDICT](../../t-sql/queries/predict-transact-sql.md).

Так как скрипт предоставляется через существующие объекты схемы базы данных, хранимые процедуры и таблицы, в службах машинного обучения SQL Server нет новых [защищаемых объектов](../../relational-databases/security/securables.md).

Объекты базы данных создаются и, возможно, сохраняются независимо от того, как используется скрипт и из каких компонентов он состоит, но для хранения скрипта новый тип объекта не предоставляется. В результате возможность использования, создания и сохранения объектов базы данных в значительной степени зависит от разрешений базы данных, уже определенных для пользователей.

<a name="permissions"></a>

## <a name="permissions"></a>Разрешения

Модель безопасности данных SQL Server для имен входа и ролей базы данных распространяется и на скрипты R и Python. Для запуска внешних скриптов, использующих данные SQL Server или выполняемых в контексте вычисления SQL Server, требуется учетная запись SQL Server или учетная запись пользователя Windows. Пользователи базы данных с разрешениями на выполнение нерегламентированного запроса могут обращаться к одним и тем же данным из скрипта R или Python.

Имя входа или учетная запись пользователя определяет *субъект безопасности*, которому в зависимости от требований внешнего скрипта может потребоваться несколько уровней доступа:

+ разрешение на доступ к базе данных, в которой включены внешние скрипты;
+ разрешения на чтение данных из защищенных объектов, таких как таблицы;
+ возможность записи новых данных в таблицу, такую как модель, или результатов оценки;
+ возможность создания новых объектов, например таблиц, хранимых процедур, использующих внешний скрипт, или пользовательских функций, использующих задания R или Python;
+ право на установку новых пакетов на компьютере SQL Server или использование пакетов, предоставленных группе пользователей.

Каждый пользователь, запускающий внешний скрипт в контексте выполнения SQL Server, должен быть сопоставлен с пользователем в базе данных. Рекомендуется не задавать разрешения каждому пользователю базы данных отдельно, а создавать роли для управления наборами разрешений и назначать их пользователям.

Дополнительные сведения см. в статье [Give users permission to SQL Server Machine Learning Services](../../advanced-analytics/security/user-permission.md) (Предоставление пользователям разрешения в службах машинного обучения SQL Server).

## <a name="permissions-when-using-an-external-client-tool"></a>Разрешения при использовании внешнего клиентского средства

Если пользователям, которые используют R или Python во внешнем клиентском средстве, нужно выполнить внешний скрипт в базе данных или получить доступ к объектам и данным базы данных, их имена входа или учетные записи должны быть сопоставлены с данными пользователей в базе данных. Для отправки внешнего скрипта из удаленного клиента обработки и анализа данных или его выполнения с помощью хранимой процедуры T-SQL требуются одни и те же разрешения.

Например, предположим, что вы создали внешний скрипт, который выполняется на локальном компьютере, и хотите запустить его на SQL Server. Для этого должны быть выполнены приведенные ниже условия.

+ База данных должна разрешать удаленные подключения.
+ Имя входа SQL или учетная запись Windows, используемая для доступа к базе данных, была добавлена в SQL Server на уровне экземпляра.
+ Имени входа SQL или пользователю Windows должно быть предоставлено разрешение на выполнение внешних скриптов. Обычно это разрешение может добавить только администратор базы данных.
+ Имя входа SQL или пользователь Windows должны быть добавлены в качестве пользователя с соответствующими разрешениями в каждую базу данных, где внешний скрипт выполняет одно из следующих действий:
  + извлечение данных;
  + запись или обновление данных;
  + создание новых объектов, например таблиц или хранимых процедур.

После подготовки имени входа или учетной записи пользователя Windows и предоставления необходимых разрешений можно выполнить внешний скрипт на SQL Server с помощью объекта источника данных в R или библиотеки **revoscalepy** в Python либо с помощью вызова хранимой процедуры, содержащей внешний скрипт.

При каждом запуске внешнего скрипта из система безопасности ядра СУБД получает контекст безопасности пользователя, который запустил задание R, а также управляет сопоставлением пользователя или имени входа с защищаемыми объектами.

Таким образом, все внешние скрипты, запущенные из удаленного клиента, должны определять имя входа или сведения о пользователе в качестве компонентов строки подключения.

<a name="launchpad"></a>

## <a name="services-used-in-external-processing-launchpad"></a>Службы, используемые во внешней обработке (панель запуска)

Платформа расширяемости добавляет одну новую службу NT в [список служб](../../database-engine/configure-windows/configure-windows-service-accounts-and-permissions.md#Service_Details) в установке SQL Server: [**Панель запуска SQL Server (MSSSQLSERVER)** ](extensibility-framework.md#launchpad).

Ядро СУБД использует службу панели запуска SQL Server для создания экземпляра сеанса R или Python в виде отдельного процесса. Этот процесс выполняется под учетной записью с минимальными правами доступа отдельно от SQL Server, самой панели запуска и удостоверения пользователя, с которым выполнялась хранимая процедура или запрос узла. Такой подход лежит в основе модели безопасности и изоляции для R и Python на SQL Server.

Кроме запуска внешних процессов, панель запуска также отвечает за отслеживание удостоверения вызывающего пользователя и сопоставление этого удостоверения с учетной записью рабочей роли с минимальными правами доступа, используемой для запуска процесса. В некоторых сценариях, когда скрипт или код осуществляет обратный вызов SQL Server для получения данных и операций, панель запуска обычно легко управляет передачей удостоверений. Если вызывающий пользователь обладает достаточными разрешениями, скрипты, содержащие инструкции SELECT или вызывающие функции и другие программные объекты, выполняются успешно.

> [!NOTE]
> По умолчанию [!INCLUDE[rsql_launchpad_md](../../includes/rsql-launchpad-md.md)] настроена для работы под учетной записью **NT Service\MSSQLLaunchpad**, имеющей все необходимые разрешения на выполнение внешних скриптов. Дополнительные сведения о настраиваемых параметрах см. в статье [SQL Server Launchpad service configuration](../security/sql-server-launchpad-service-account.md) (Конфигурация службы панели запуска SQL Server).

<a name="sqlrusergroup"></a>

## <a name="identities-used-in-processing-sqlrusergroup"></a>Удостоверения, используемые при обработке (SQLRUserGroup)

**SQLRUserGroup** (группа пользователей с ограниченным доступом к SQL) создается с помощью программы установки SQL Server и содержит пул локальных учетных записей пользователей Windows с минимальными правами доступа. Когда требуется внешний процесс, панель запуска выбирает доступную рабочую учетную запись и использует ее для выполнения процесса. В частности, панель запуска активирует доступную рабочую учетную запись, сопоставляет ее с удостоверением вызывающего пользователя и выполняет скрипт под этой учетной записью.

+ Группа **SQLRUserGroup** связана с определенным экземпляром. Для каждого экземпляра, на котором включено машинное обучение, требуется отдельный пул рабочих учетных записей. Учетные записи не могут совместно использоваться разными экземплярами.

+ Размер пула учетных записей пользователей является статическим со значением по умолчанию, равным 20 (поддерживает 20 одновременных сеансов). Число сеансов среды внешней среды выполнения, которые могут запускаться одновременно, ограничено размером пула учетных записей пользователей. 

+ Имена рабочих учетных записей в пуле имеют формат SQLInstanceName*nn*. Например, в экземпляре по умолчанию группа **SQLRUserGroup** содержит учетные записи с именами MSSQLSERVER01, MSSQLSERVER02 и т. д. до MSSQLSERVER20.

Параллельные задачи не используют дополнительные учетные записи. Например, если пользователь выполняет задачу оценки, которая использует параллельную обработку, для всех потоков многократно применяется одна и та же рабочая учетная запись. Если вы планируете активно использовать машинное обучение, можно увеличить число учетных записей, используемых для выполнения внешних скриптов. Дополнительные сведения см. в [этой статье](../../advanced-analytics/administration/modify-user-account-pool.md).

::: moniker range=">=sql-server-ver15||=sqlallproducts-allversions"
### <a name="appcontainer-isolation-in-sql-server-2019"></a>Изоляция AppContainer в SQL Server 2019

В SQL Server 2019 программа установки больше не создает рабочие учетные записи для группы **SQLRUserGroup**. Вместо этого изоляция реализуется с помощью [AppContainers](https://docs.microsoft.com/windows/desktop/secauthz/appcontainer-isolation). Во время выполнения при обнаружении внешнего скрипта в хранимой процедуре или запросе SQL Server вызывает панель запуска с запросом на средство запуска, зависящее от расширения. Панель запуска вызывает соответствующую среду выполнения в процессе со своим удостоверением и создает для нее контейнер AppContainer. Это изменение выгодно, поскольку управлять локальными учетными записями и паролями больше не нужно. Кроме того, в установках, где запрещены учетные записи локальных пользователей, устранение зависимости от учетной записи локального пользователя позволяет использовать эту функцию.

В SQL Server AppContainer является внутренним механизмом. Несмотря на то, что вы не найдете физических следов присутствия AppContainer в мониторе процессов, они отображаются в правилах брандмауэра для исходящих подключений, созданных программой установки, чтобы запретить процессам делать сетевые вызовы. Дополнительные сведения см. в статье [Настройка брандмауэра для служб машинного обучения SQL Server](../../advanced-analytics/security/firewall-configuration.md).

> [!Note]
> В SQL Server 2019 в группе **SQLRUserGroup** теперь содержится только один член, которым является единственная учетная запись службы панели запуска SQL Server, а не несколько рабочих учетных записей.
::: moniker-end

### <a name="permissions-granted-to-sqlrusergroup"></a>Разрешения, предоставляемые группе SQLRUserGroup

По умолчанию члены группы **SQLRUserGroup** имеют разрешения на чтение и выполнение файлов в каталогах SQL Server **Binn**, **R_SERVICES** и **PYTHON_SERVICES** с доступом к исполняемым файлам, библиотекам и встроенным наборам данных в дистрибутивах R и Python, установленных с SQL Server. 

Для защиты важных ресурсов в SQL Server можно определить список управления доступом (ACL), который запрещает доступ группе **SQLRUserGroup**. И наоборот, можно также предоставить разрешения на доступ к локальным ресурсам данных, которые находятся на главном компьютере помимо самого SQL Server. 

Как запланировано при разработке, у группы **SQLRUserGroup** нет имени входа в базу данных или разрешений на доступ к данным. В определенных случаях может потребоваться создать имя входа, чтобы разрешить подключения с замыканием на себя, особенно когда доверенным удостоверением Windows является вызывающий пользователь. Эта возможность называется [*неявной проверкой подлинности*](#implied-authentication). Дополнительные сведения см. в статье [Добавление SQLRUserGroup в качестве пользователя базы данных](../../advanced-analytics/security/create-a-login-for-sqlrusergroup.md).

## <a name="identity-mapping"></a>Сопоставление удостоверений

При запуске сеанса панель запуска сопоставляет удостоверение вызывающего пользователя с рабочей учетной записью. Это сопоставление внешнего пользователя Windows или допустимого имени входа SQL с рабочей учетной записью является действительным только в течение срока действия хранимой процедуры SQL, выполняющей внешний скрипт R. Параллельные запросы, выполняемые с тем же именем входа, сопоставляются с той же рабочей учетной записью пользователя.

Во время выполнения панель запуска создает временные папки для хранения данных сеанса. По завершении сеанса папки удаляются. Для каталогов действует ограниченный доступ. Для R эту задачу выполняет RLauncher. Для Python эту задачу выполняет PythonLauncher. Каждая отдельная рабочая учетная запись ограничена своей папкой и не может обращаться к файлам в папках на уровне выше ее собственного. Однако рабочая учетная запись может считывать, записывать или удалять дочерние элементы в созданной рабочей папке сеанса. Если вы являетесь администратором компьютера, вы можете просмотреть каталоги, созданные для каждого процесса. Каждый каталог определяется собственным идентификатором GUID сеанса.

<a name="implied-authentication"></a>

## <a name="implied-authentication-loop-back-requests"></a>Неявная проверка подлинности (запросы с зацикливанием)

*Неявная проверка подлинности* описывает поведение запроса на подключение, при котором внешние процессы, выполняющиеся в качестве рабочих учетных записей с минимальными правами доступа, представлены в SQL Server в запросах с зацикливанием в виде доверенных удостоверений пользователей. В концептуальном плане неявная проверка подлинности уникальна для проверки подлинности Windows, в строках подключения SQL Server, указывающих доверенное соединение, в запросах, исходящих из внешних процессов, таких как скрипты R или Python. Иногда ее также называют *зацикливанием*.

Доверенные соединения поддерживаются в скриптах R и Python только после дополнительной настройки. В архитектуре расширяемости процессы R и Python выполняются под рабочими учетными записями, наследуя разрешения от родительской группы **SQLRUserGroup**. Если в строке подключения указывается `Trusted_Connection=True`, в запросе на подключение приводится удостоверение рабочей учетной записи, которое по умолчанию неизвестно SQL Server.

Для установки успешных доверенных соединений необходимо создать имя входа базы данных для **SQLRUserGroup**. После этого любое доверенное соединение от любого члена группы **SQLRUserGroup** получит права входа в SQL Server. Пошаговые инструкции см. в статье о [создании учетных данных для SQLRUserGroup](../../advanced-analytics/security/create-a-login-for-sqlrusergroup.md).

Доверенные соединения редко используются в качестве формулировки запроса на подключение. Если в скрипте R или Python задается подключение, чаще всего используется имя входа SQL, а если это подключение к источнику данных ODB, применяется полное имя пользователя и пароль.

### <a name="how-implied-authentication-works-for-r-and-python-sessions"></a>Работа неявной проверки подлинности для сеансов R и Python

На следующей схеме показано взаимодействие компонентов SQL Server со средой выполнения R и реализация неявной проверки подлинности для R.

![Неявная проверка подлинности для R](../security/media/implied-auth-rsql.png)

На следующей схеме показано взаимодействие компонентов SQL Server со средой выполнения R и реализация неявной проверки подлинности для Python.

![Неявная проверка подлинности для Python](../security/media/implied-auth-python2.png)

## <a name="no-support-for-transparent-data-encryption-at-rest"></a>Отсутствие поддержки прозрачного шифрования неактивных данных

[Прозрачное шифрование данных (TDE)](../../relational-databases/security/encryption/transparent-data-encryption.md) не поддерживается для данных, отправленных или полученных из среды выполнения внешнего скрипта. Причина в том, что внешний процесс (R или Python) выполняется вне процесса SQL Server. Таким образом, данные, используемые внешней средой выполнения, не защищаются функциями шифрования ядра СУБД. Это поведение аналогично действию любого другого работающего на компьютере SQL Server клиента, который считывает данные из базы данных и создает копию.

В результате прозрачное шифрование данных **не** применяется к данным, используемым в скриптах R или Python, сохраненным на диске, или к сохраненным промежуточным результатам. Однако по-прежнему действуют другие типы шифрования, такие как шифрование Windows BitLocker или решения шифрования сторонних производителей, применяемые на уровне файла или папки.

При использовании [Always Encrypted](../../relational-databases/security/encryption/overview-of-key-management-for-always-encrypted.md) у внешних сред выполнения отсутствует доступ к ключам шифрования. Поэтому отправить данные в скрипты невозможно.

## <a name="next-steps"></a>Дальнейшие действия

В этой статье вы узнали о компонентах и модели взаимодействия архитектуры безопасности, встроенной в [платформу расширяемости](../../advanced-analytics/concepts/extensibility-framework.md). В этой статье рассматривались такие ключевые аспекты, как назначение панели запуска, SQLRUserGroup и рабочих учетных записей, изоляция процессов R и Python и сопоставление удостоверений пользователей с рабочими учетными записями. 

Далее вы можете ознакомится с инструкциями по [предоставлению разрешений](../../advanced-analytics/security/user-permission.md). Для работы с серверами, использующими проверку подлинности Windows, следует прочесть статью о [создании учетных данных для SQLRUserGroup](../../advanced-analytics/security/create-a-login-for-sqlrusergroup.md), чтобы узнать, когда требуется дополнительная настройка.