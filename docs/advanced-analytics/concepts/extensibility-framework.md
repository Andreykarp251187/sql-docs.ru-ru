---
title: Архитектура расширяемости для языка R и скрипта Python
description: Поддержка внешнего кода для ядра СУБД SQL Server с двойной архитектурой для выполнения скрипта R и Python в реляционных данных.
ms.prod: sql
ms.technology: machine-learning
ms.date: 10/17/2018
ms.topic: conceptual
author: dphansen
ms.author: davidph
ms.openlocfilehash: a5c49172ed23867f95e383878f792092bd762177
ms.sourcegitcommit: 9062c5e97c4e4af0bbe5be6637cc3872cd1b2320
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/24/2019
ms.locfileid: "68470460"
---
# <a name="extensibility-architecture-in-sql-server-machine-learning-services"></a>Архитектура расширяемости в SQL Server Службы машинного обучения 
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md](../../includes/appliesto-ss-xxxx-xxxx-xxx-md.md)]

SQL Server имеет платформу расширяемости для выполнения внешних сценариев, таких как R или Python на сервере. Сценарий выполняется в среде языковой среды в качестве расширения ядра СУБД. 

## <a name="background"></a>Историческая справка

Платформа расширяемости была представлена в SQL Server 2016 для поддержки среды выполнения R. SQL Server 2017 добавлена поддержка Python

Целью платформы расширяемости является предоставление интерфейса между SQL Server и языками обработки и анализа данных, такими как R и Python, что снижает трение при перемещении решений обработки и анализа данных в рабочую среду, а также защиту данных, предоставляемых во время разработки. процесс. Выполняя доверенный язык скриптов в безопасной инфраструктуре, управляемой SQL Server, администраторы баз данных могут поддерживать безопасность, обеспечивая доступ к корпоративным данным.

Следующая диаграмма наглядно описывает возможности и преимущества расширяемой архитектуры.

  ![Цели интеграции с SQL Server](../media/ml-service-value-add.png "Добавление значения службы машинного обучения")

Любой скрипт R или Python можно запустить, вызвав хранимую процедуру, и результаты возвращаются в виде табличных результатов непосредственно в SQL Server, что упрощает создание или использование машинного обучения из любого приложения, которое может отправлять SQL-запрос и обрабатывать результаты.

+ Выполнение внешнего скрипта подчиняется SQL Server безопасности данных, где пользователь, выполняющий внешний скрипт, может получить доступ только к тем данным, которые являются одинаковыми доступными в SQL-запросе. Если запрос завершается ошибкой из-за недостаточных разрешений, сценарий, выполняемый этим же пользователем, также завершится ошибкой по той же причине. SQL Server безопасность применяется на уровне таблицы, базы данных и экземпляра. Администраторы баз данных могут управлять доступом пользователей, ресурсами, используемыми внешними скриптами, а также внешними библиотеками кода, добавленными на сервер.  

+ Возможности масштабирования и оптимизации имеют два варианта: преимущества платформы баз данных (индексы ColumnStore, [Управление ресурсами](../../advanced-analytics/r/resource-governance-for-r-services.md)) и дополнение к конкретным расширениям, если для моделей обработки и анализа данных используются библиотеки Майкрософт для R и Python. В то время как R является однопотоковым, функции RevoScaleR являются многопоточными и способны распределять рабочую нагрузку по нескольким ядрам.

+ Развертывание использует методологии SQL Server: хранимые процедуры, которые заключаются во внешнем скрипте, внедренном SQL или T-SQL, вызывают такие функции, как прогноз, чтобы возвращать результаты из моделей прогнозирования, сохраненных на сервере.

+ Разработчики R и Python с установленными навыками в определенных средствах и IDE могут написать код в этих средствах, а затем перенести код в SQL Server.

## <a name="architecture-diagram"></a>Диаграмма архитектуры

Архитектура разработана таким образом, что внешние скрипты выполняются в отдельном процессе от SQL Server, но с компонентами, которые внутренне управляют цепочкой запросов на данные и операции в SQL Server. В зависимости от версии SQL Server поддерживаемые расширения языка включают R и Python. 

  ![Архитектура компонента](../media/generic-architecture.png "Архитектура компонента")

Компоненты включают в **себя службу панели** запуска, используемую для вызова зависящих от языка (R или Python), логики и конкретной библиотеки для загрузки интерпретаторов и библиотек. Средство запуска загружает время выполнения языка и все собственные модули. Например, если код включает функции RevoScaleR, будет загружен интерпретатор RevoScaleR. **BxlServer** и **вспомогательное взаимодействие SQL** управляют обменом данными и переносом данных с помощью SQL Server.

<a name="launchpad"></a>

## <a name="launchpad"></a>Панель запуска

[!INCLUDE[rsql_launchpad_md](../../includes/rsql-launchpad-md.md)] — Это служба, которая управляет внешними скриптами и выполняет их, аналогично тому, как служба полнотекстового индексирования и запросов запускает отдельный узел для обработки полнотекстовых запросов. Служба панели запуска может запускать только доверенные средства запуска, опубликованные корпорацией Майкрософт или сертифицированные корпорацией Майкрософт в качестве требований к собранию для управления производительностью и ресурсами.

| Доверенные средства запуска | Расширение | Версии SQL Server |
|-------------------|-----------|---------------------|
| RLauncher. dll для языка R | [Расширение R](extension-r.md) | SQL Server 2016, SQL Server 2017 |
| Писонлаунчер. dll для Python 3,5 | [Расширение Python](extension-python.md) | SQL Server 2017 |

Служба [!INCLUDE[rsql_launchpad_md](../../includes/rsql-launchpad-md.md)] выполняется со своей собственной учетной записью пользователя. При изменении учетной записи, запускающей панель запуска, не забудьте сделать это с помощью диспетчер конфигурации SQL Server, чтобы обеспечить запись изменений в связанные файлы.

Для каждого [!INCLUDE[rsql_launchpad_md](../../includes/rsql-launchpad-md.md)] экземпляра ядра СУБД, к которому были добавлены SQL Server службы машинного обучения, создается отдельная служба. Для каждого экземпляра ядра СУБД существует одна служба панели запуска, поэтому при наличии нескольких экземпляров с поддержкой внешних скриптов для каждой из них будет установлена служба панели. Экземпляр ядра СУБД привязан к службе панели запуска, созданной для нее. Все вызовы внешнего скрипта в хранимой процедуре или T-SQL приводят к SQL Server службе, которая вызывает службу панели запуска, созданную для того же экземпляра.

Для выполнения задач на определенном поддерживаемом языке панель запуска получает защищенную рабочую учетную запись из пула и запускает вспомогательный процесс для управления внешней средой выполнения. Каждый вспомогательный процесс наследует учетную запись пользователя панели запуска и использует эту учетную запись в течение времени выполнения скрипта. Если в скрипте используются параллельные процессы, они создаются под одной рабочей учетной записью.

## <a name="bxlserver-and-sql-satellite"></a>BxlServer и вспомогательная лицензия SQL

**BxlServer** — это исполняемый файл, предоставляемый корпорацией Майкрософт, который управляет обменом данными между SQL Server и Python или R. Он создает объекты заданий Windows, которые используются для хранения внешних сеансов скриптов, подготавливает защищенные рабочие папки для каждого задания внешнего скрипта и использует вспомогательную среду SQL для управления обменом данными между внешней средой выполнения и SQL Server. При запуске [Process Explorer](https://technet.microsoft.com/sysinternals/processexplorer.aspx) во время выполнения задания может появиться один или несколько экземпляров BxlServer.

По сути, BxlServer — это вспомогательная среда языкового времени выполнения, которая работает с SQL Server для перемещения данных и управления задачами. БКСЛ означает язык двоичного обмена и относится к формату данных, который позволяет эффективно перемещать данные между SQL Server и внешними процессами. BxlServer также является важной частью связанных продуктов, таких как Microsoft R Client и Microsoft R Server.

**Вспомогательная функция SQL** — это API расширяемости, включенный в ядро СУБД, начиная с SQL Server 2016, который поддерживает внешний код или внешние среды выполнения C++, реализованные с помощью C или.

BxlServer использует вспомогательное соединение SQL для следующих задач:

+ чтение входных данных;
+ запись выходных данных;
+ получение входных аргументов;
+ запись входных аргументов;
+ Обработка ошибок
+ обратная запись StdOut и StdErr в клиент.

Вспомогательная функция SQL использует пользовательский формат данных, оптимизированный для быстрой пересылки данных между SQL Server и языками внешних скриптов. Он выполняет преобразования типов и определяет схемы входных и выходных наборов данных во время обмена данными между SQL Server и средой выполнения внешнего скрипта.

Вспомогательную лицензию SQL можно отслеживать с помощью расширенных событий Windows (xEvents). Дополнительные сведения см. в разделе [Расширенные события для R](../../advanced-analytics/r/extended-events-for-sql-server-r-services.md) и [Расширенные события для Python](../../advanced-analytics/python/extended-events-for-python.md).

## <a name="communication-channels-between-components"></a>Коммуникационные каналы между компонентами

В этом разделе описаны протоколы связи между компонентами и платформами данных.

+ **ПРОТОКОЛ TCP/IP**

  По умолчанию внутренняя связь между SQL Server и вспомогательной службой SQL использует TCP/IP.

+ **Именованные каналы**

  Внутренний транспорт данных между BxlServer и SQL Server с помощью вспомогательной функции SQL использует собственный сжатый формат данных для повышения производительности. Данные передаются между временем языкового запуска и BxlServer в формате БКСЛ с использованием именованных каналов.

+ **интерфейс ODBC**

  При обмене данными между внешними клиентами обработки и анализа данных и удаленным экземпляром SQL Server используется ODBC. Учетная запись, которая отправляет задания скриптов в SQL Server, должна иметь оба разрешения для подключения к экземпляру и выполнения внешних скриптов.

  Кроме того, в зависимости от задачи учетной записи могут потребоваться следующие разрешения:

  + Чтение данных, используемых заданием
  + Запись данных в таблицы: например, при сохранении результатов в таблицу
  + Создание объектов базы данных. Например, при сохранении внешнего скрипта как части новой хранимой процедуры.

  Если в качестве контекста вычислений для скрипта, выполняемого из удаленного клиента, используется SQL Server, а исполняемый файл должен получать данные из внешнего источника, то для обратной записи используется ODBC. SQL Server сопоставляет удостоверение пользователя, выполняющего удаленную команду, с удостоверением пользователя на текущем экземпляре и выполняет команду ODBC, используя учетные данные этого пользователя. Строка подключения, необходимая для выполнения этого вызова ODBC, получается из клиентского кода.

+ **RODBC (только для R)** 

  Дополнительные вызовы ODBC можно вносить в скрипт с помощью **RODBC**. RODBC — это популярный пакет R, используемый для доступа к данным в реляционных базах данных; Однако его производительность обычно снижается, чем сравнимые поставщики, используемые SQL Server. Многие скрипты R используют встроенные вызовы RODBC как способ получения "вторичных" наборов данных для использования при анализе. Например, хранимая процедура, которая обучает модель, может определить SQL-запрос, чтобы получить данные для обучения модели, но использовать встроенный вызов RODBC, чтобы получить дополнительные факторы для выполнения операций поиска или для получения новых данных из внешних источников, таких как текстовые файлы или Excel.

  Следующий код иллюстрирует вызов RODBC, встроенный в скрипт R:

    ```R
    library(RODBC);
    connStr <- paste("Driver=SQL Server;Server=", instance_name, ";Database=", database_name, ";Trusted_Connection=true;", sep="");
    dbhandle <- odbcDriverConnect(connStr)
    OutputDataSet <- sqlQuery(dbhandle, "select * from table_name");
    ```

+ **Другие протоколы**

  Процессы, которые могут потребоваться для работы в блоках или передачи данных обратно удаленному клиенту, также могут использовать [Формат файла Xdf-](https://docs.microsoft.com/machine-learning-server/r/concept-what-is-xdf). Фактический перенос данных осуществляется через закодированные BLOB-объекты.

## <a name="see-also"></a>См. также

+ [Расширение R в SQL Server](extension-r.md)
+ [Расширение Python в SQL Server](extension-python.md)